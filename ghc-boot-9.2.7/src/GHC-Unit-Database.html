<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Unit/Database.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS_GHC -fno-warn-name-shadowing #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-4"></a><span class='hs-comment'>{-# LANGUAGE DataKinds #-}</span>
<a name="line-5"></a><span class='hs-comment'>{-# LANGUAGE DeriveTraversable #-}</span>
<a name="line-6"></a><span class='hs-comment'>{-# LANGUAGE LambdaCase #-}</span>
<a name="line-7"></a><span class='hs-comment'>{-# LANGUAGE GADTs #-}</span>
<a name="line-8"></a><span class='hs-comment'>{-# LANGUAGE KindSignatures #-}</span>
<a name="line-9"></a><span class='hs-comment'>{-# LANGUAGE StandaloneDeriving #-}</span>
<a name="line-10"></a><span class='hs-comment'>{-# LANGUAGE TupleSections #-}</span>
<a name="line-11"></a><span class='hs-comment'>{-# LANGUAGE FlexibleInstances #-}</span>
<a name="line-12"></a><span class='hs-comment'>{-# LANGUAGE TypeSynonymInstances #-}</span>
<a name="line-13"></a><span class='hs-comment'>{-# LANGUAGE ExplicitNamespaces #-}</span>
<a name="line-14"></a><span class='hs-comment'>{-# LANGUAGE RecordWildCards #-}</span>
<a name="line-15"></a><span class='hs-comment'>{-# LANGUAGE OverloadedStrings #-}</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-18"></a><span class='hs-comment'>-- |</span>
<a name="line-19"></a><span class='hs-comment'>-- Module      :  GHC.Unit.Database</span>
<a name="line-20"></a><span class='hs-comment'>-- Copyright   :  (c) The University of Glasgow 2009, Duncan Coutts 2014</span>
<a name="line-21"></a><span class='hs-comment'>--</span>
<a name="line-22"></a><span class='hs-comment'>-- Maintainer  :  ghc-devs@haskell.org</span>
<a name="line-23"></a><span class='hs-comment'>-- Portability :  portable</span>
<a name="line-24"></a><span class='hs-comment'>--</span>
<a name="line-25"></a><span class='hs-comment'>-- This module provides the view of GHC's database of registered packages that</span>
<a name="line-26"></a><span class='hs-comment'>-- is shared between GHC the compiler\/library, and the ghc-pkg program. It</span>
<a name="line-27"></a><span class='hs-comment'>-- defines the database format that is shared between GHC and ghc-pkg.</span>
<a name="line-28"></a><span class='hs-comment'>--</span>
<a name="line-29"></a><span class='hs-comment'>-- The database format, and this library are constructed so that GHC does not</span>
<a name="line-30"></a><span class='hs-comment'>-- have to depend on the Cabal library. The ghc-pkg program acts as the</span>
<a name="line-31"></a><span class='hs-comment'>-- gateway between the external package format (which is defined by Cabal) and</span>
<a name="line-32"></a><span class='hs-comment'>-- the internal package format which is specialised just for GHC.</span>
<a name="line-33"></a><span class='hs-comment'>--</span>
<a name="line-34"></a><span class='hs-comment'>-- GHC the compiler only needs some of the information which is kept about</span>
<a name="line-35"></a><span class='hs-comment'>-- registered packages, such as module names, various paths etc. On the other</span>
<a name="line-36"></a><span class='hs-comment'>-- hand ghc-pkg has to keep all the information from Cabal packages and be able</span>
<a name="line-37"></a><span class='hs-comment'>-- to regurgitate it for users and other tools.</span>
<a name="line-38"></a><span class='hs-comment'>--</span>
<a name="line-39"></a><span class='hs-comment'>-- The first trick is that we duplicate some of the information in the package</span>
<a name="line-40"></a><span class='hs-comment'>-- database. We essentially keep two versions of the database in one file, one</span>
<a name="line-41"></a><span class='hs-comment'>-- version used only by ghc-pkg which keeps the full information (using the</span>
<a name="line-42"></a><span class='hs-comment'>-- serialised form of the 'InstalledPackageInfo' type defined by the Cabal</span>
<a name="line-43"></a><span class='hs-comment'>-- library); and a second version written by ghc-pkg and read by GHC which has</span>
<a name="line-44"></a><span class='hs-comment'>-- just the subset of information that GHC needs.</span>
<a name="line-45"></a><span class='hs-comment'>--</span>
<a name="line-46"></a><span class='hs-comment'>-- The second trick is that this module only defines in detail the format of</span>
<a name="line-47"></a><span class='hs-comment'>-- the second version -- the bit GHC uses -- and the part managed by ghc-pkg</span>
<a name="line-48"></a><span class='hs-comment'>-- is kept in the file but here we treat it as an opaque blob of data. That way</span>
<a name="line-49"></a><span class='hs-comment'>-- this library avoids depending on Cabal.</span>
<a name="line-50"></a><span class='hs-comment'>--</span>
<a name="line-51"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Unit.Database</span>
<a name="line-52"></a>   <span class='hs-layout'>(</span> <span class='hs-conid'>GenericUnitInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-53"></a>   <span class='hs-layout'>,</span> <span class='hs-keyword'>type</span> <span class='hs-conid'>DbUnitInfo</span>
<a name="line-54"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>DbModule</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-55"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>DbInstUnitId</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-56"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mapGenericUnitInfo</span>
<a name="line-57"></a>   <span class='hs-comment'>-- * Read and write</span>
<a name="line-58"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>DbMode</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-59"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>DbOpenMode</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-60"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>isDbOpenReadMode</span>
<a name="line-61"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>readPackageDbForGhc</span>
<a name="line-62"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>readPackageDbForGhcPkg</span>
<a name="line-63"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>writePackageDb</span>
<a name="line-64"></a>   <span class='hs-comment'>-- * Locking</span>
<a name="line-65"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>PackageDbLock</span>
<a name="line-66"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>lockPackageDb</span>
<a name="line-67"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unlockPackageDb</span>
<a name="line-68"></a>   <span class='hs-comment'>-- * Misc</span>
<a name="line-69"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mkMungePathUrl</span>
<a name="line-70"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mungeUnitInfoPaths</span>
<a name="line-71"></a>   <span class='hs-layout'>)</span>
<a name="line-72"></a><span class='hs-keyword'>where</span>
<a name="line-73"></a>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span> <span class='hs-comment'>-- See note [Why do we import Prelude here?]</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Version</span> <span class='hs-layout'>(</span><span class='hs-conid'>Version</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.ByteString</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>BS</span>
<a name="line-77"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.ByteString.Char8</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>BS.Char8</span>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.ByteString.Lazy</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>BS.Lazy</span>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.ByteString.Lazy.Internal</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>BS.Lazy</span> <span class='hs-layout'>(</span><span class='hs-varid'>defaultChunkSize</span><span class='hs-layout'>)</span>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.Foldable</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>F</span>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.Traversable</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>F</span>
<a name="line-82"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Bifunctor</span>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Binary</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Bin</span>
<a name="line-84"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Binary.Put</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Bin</span>
<a name="line-85"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Binary.Get</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Bin</span>
<a name="line-86"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List</span> <span class='hs-layout'>(</span><span class='hs-varid'>intersperse</span><span class='hs-layout'>)</span>
<a name="line-87"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Exception</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Exception</span>
<a name="line-88"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad</span> <span class='hs-layout'>(</span><span class='hs-varid'>when</span><span class='hs-layout'>)</span>
<a name="line-89"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.FilePath</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>FilePath</span>
<a name="line-90"></a><span class='hs-cpp'>#if !defined(mingw32_HOST_OS)</span>
<a name="line-91"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.Posix.Files</span>
<a name="line-92"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IO.Exception</span> <span class='hs-layout'>(</span><span class='hs-varid'>ioe_type</span><span class='hs-layout'>,</span> <span class='hs-conid'>IOErrorType</span><span class='hs-layout'>(</span><span class='hs-conid'>NoSuchThing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-93"></a><span class='hs-cpp'>#endif</span>
<a name="line-94"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.IO</span>
<a name="line-95"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.IO.Error</span>
<a name="line-96"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IO.Exception</span> <span class='hs-layout'>(</span><span class='hs-conid'>IOErrorType</span><span class='hs-layout'>(</span><span class='hs-conid'>InappropriateType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-97"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.Data.ShortText</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>ST</span>
<a name="line-98"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IO.Handle.Lock</span>
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.Directory</span>
<a name="line-100"></a>
<a name="line-101"></a><a name="DbUnitInfo"></a><span class='hs-comment'>-- | @ghc-boot@'s UnitInfo, serialized to the database.</span>
<a name="line-102"></a><a name="DbUnitInfo"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>DbUnitInfo</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GenericUnitInfo</span> <span class='hs-conid'>BS.ByteString</span> <span class='hs-conid'>BS.ByteString</span> <span class='hs-conid'>BS.ByteString</span> <span class='hs-conid'>BS.ByteString</span> <span class='hs-conid'>BS.ByteString</span> <span class='hs-conid'>DbModule</span>
<a name="line-103"></a>
<a name="line-104"></a><a name="GenericUnitInfo"></a><span class='hs-comment'>-- | Information about an unit (a unit is an installed module library).</span>
<a name="line-105"></a><a name="GenericUnitInfo"></a><span class='hs-comment'>--</span>
<a name="line-106"></a><a name="GenericUnitInfo"></a><span class='hs-comment'>-- This is a subset of Cabal's 'InstalledPackageInfo', with just the bits</span>
<a name="line-107"></a><a name="GenericUnitInfo"></a><span class='hs-comment'>-- that GHC is interested in.</span>
<a name="line-108"></a><a name="GenericUnitInfo"></a><span class='hs-comment'>--</span>
<a name="line-109"></a><a name="GenericUnitInfo"></a><span class='hs-comment'>-- Some types are left as parameters to be instantiated differently in ghc-pkg</span>
<a name="line-110"></a><a name="GenericUnitInfo"></a><span class='hs-comment'>-- and in ghc itself.</span>
<a name="line-111"></a><a name="GenericUnitInfo"></a><span class='hs-comment'>--</span>
<a name="line-112"></a><a name="GenericUnitInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>GenericUnitInfo</span> <span class='hs-varid'>compid</span> <span class='hs-varid'>srcpkgid</span> <span class='hs-varid'>srcpkgname</span> <span class='hs-varid'>uid</span> <span class='hs-varid'>modulename</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GenericUnitInfo</span>
<a name="line-113"></a>   <span class='hs-layout'>{</span> <span class='hs-varid'>unitId</span>             <span class='hs-keyglyph'>::</span> <span class='hs-varid'>uid</span>
<a name="line-114"></a>      <span class='hs-comment'>-- ^ Unique unit identifier that is used during compilation (e.g. to</span>
<a name="line-115"></a>      <span class='hs-comment'>-- generate symbols).</span>
<a name="line-116"></a>
<a name="line-117"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitInstanceOf</span>     <span class='hs-keyglyph'>::</span> <span class='hs-varid'>compid</span>
<a name="line-118"></a>      <span class='hs-comment'>-- ^ Identifier of an indefinite unit (i.e. with module holes) that this</span>
<a name="line-119"></a>      <span class='hs-comment'>-- unit is an instance of.</span>
<a name="line-120"></a>
<a name="line-121"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitInstantiations</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>modulename</span><span class='hs-layout'>,</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-122"></a>      <span class='hs-comment'>-- ^ How this unit instantiates some of its module holes. Map hole module</span>
<a name="line-123"></a>      <span class='hs-comment'>-- names to actual module</span>
<a name="line-124"></a>
<a name="line-125"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitPackageId</span>      <span class='hs-keyglyph'>::</span> <span class='hs-varid'>srcpkgid</span>
<a name="line-126"></a>      <span class='hs-comment'>-- ^ Source package identifier.</span>
<a name="line-127"></a>      <span class='hs-comment'>--</span>
<a name="line-128"></a>      <span class='hs-comment'>-- Cabal instantiates this with Distribution.Types.PackageId.PackageId</span>
<a name="line-129"></a>      <span class='hs-comment'>-- type which only contains the source package name and version. Notice</span>
<a name="line-130"></a>      <span class='hs-comment'>-- that it doesn't contain the Hackage revision, nor any kind of hash.</span>
<a name="line-131"></a>
<a name="line-132"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitPackageName</span>    <span class='hs-keyglyph'>::</span> <span class='hs-varid'>srcpkgname</span>
<a name="line-133"></a>      <span class='hs-comment'>-- ^ Source package name</span>
<a name="line-134"></a>
<a name="line-135"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitPackageVersion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Version</span>
<a name="line-136"></a>      <span class='hs-comment'>-- ^ Source package version</span>
<a name="line-137"></a>
<a name="line-138"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitComponentName</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>srcpkgname</span>
<a name="line-139"></a>      <span class='hs-comment'>-- ^ Name of the component.</span>
<a name="line-140"></a>      <span class='hs-comment'>--</span>
<a name="line-141"></a>      <span class='hs-comment'>-- Cabal supports more than one components (libraries, executables,</span>
<a name="line-142"></a>      <span class='hs-comment'>-- testsuites) in the same package. Each component has a name except the</span>
<a name="line-143"></a>      <span class='hs-comment'>-- default one (that can only be a library component) for which we use</span>
<a name="line-144"></a>      <span class='hs-comment'>-- "Nothing".</span>
<a name="line-145"></a>      <span class='hs-comment'>--</span>
<a name="line-146"></a>      <span class='hs-comment'>-- GHC only deals with "library" components as they are the only kind of</span>
<a name="line-147"></a>      <span class='hs-comment'>-- components that can be registered in a database and used by other</span>
<a name="line-148"></a>      <span class='hs-comment'>-- modules.</span>
<a name="line-149"></a>
<a name="line-150"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitAbiHash</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ST.ShortText</span>
<a name="line-151"></a>      <span class='hs-comment'>-- ^ ABI hash used to avoid mixing up units compiled with different</span>
<a name="line-152"></a>      <span class='hs-comment'>-- dependencies, compiler, options, etc.</span>
<a name="line-153"></a>
<a name="line-154"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitDepends</span>        <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>uid</span><span class='hs-keyglyph'>]</span>
<a name="line-155"></a>      <span class='hs-comment'>-- ^ Identifiers of the units this one depends on</span>
<a name="line-156"></a>
<a name="line-157"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitAbiDepends</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>uid</span><span class='hs-layout'>,</span> <span class='hs-conid'>ST.ShortText</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-158"></a>     <span class='hs-comment'>-- ^ Like 'unitDepends', but each dependency is annotated with the ABI hash</span>
<a name="line-159"></a>     <span class='hs-comment'>-- we expect the dependency to respect.</span>
<a name="line-160"></a>
<a name="line-161"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitImportDirs</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePathST</span><span class='hs-keyglyph'>]</span>
<a name="line-162"></a>      <span class='hs-comment'>-- ^ Directories containing module interfaces</span>
<a name="line-163"></a>
<a name="line-164"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitLibraries</span>      <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ST.ShortText</span><span class='hs-keyglyph'>]</span>
<a name="line-165"></a>      <span class='hs-comment'>-- ^ Names of the Haskell libraries provided by this unit</span>
<a name="line-166"></a>
<a name="line-167"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitExtDepLibsSys</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ST.ShortText</span><span class='hs-keyglyph'>]</span>
<a name="line-168"></a>      <span class='hs-comment'>-- ^ Names of the external system libraries that this unit depends on. See</span>
<a name="line-169"></a>      <span class='hs-comment'>-- also `unitExtDepLibsGhc` field.</span>
<a name="line-170"></a>
<a name="line-171"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitExtDepLibsGhc</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ST.ShortText</span><span class='hs-keyglyph'>]</span>
<a name="line-172"></a>      <span class='hs-comment'>-- ^ Because of slight differences between the GHC dynamic linker (in</span>
<a name="line-173"></a>      <span class='hs-comment'>-- GHC.Runtime.Linker) and the</span>
<a name="line-174"></a>      <span class='hs-comment'>-- native system linker, some packages have to link with a different list</span>
<a name="line-175"></a>      <span class='hs-comment'>-- of libraries when using GHC's. Examples include: libs that are actually</span>
<a name="line-176"></a>      <span class='hs-comment'>-- gnu ld scripts, and the possibility that the .a libs do not exactly</span>
<a name="line-177"></a>      <span class='hs-comment'>-- match the .so/.dll equivalents.</span>
<a name="line-178"></a>      <span class='hs-comment'>--</span>
<a name="line-179"></a>      <span class='hs-comment'>-- If this field is set, then we use that instead of the</span>
<a name="line-180"></a>      <span class='hs-comment'>-- `unitExtDepLibsSys` field.</span>
<a name="line-181"></a>
<a name="line-182"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitLibraryDirs</span>    <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePathST</span><span class='hs-keyglyph'>]</span>
<a name="line-183"></a>      <span class='hs-comment'>-- ^ Directories containing libraries provided by this unit. See also</span>
<a name="line-184"></a>      <span class='hs-comment'>-- `unitLibraryDynDirs`.</span>
<a name="line-185"></a>      <span class='hs-comment'>--</span>
<a name="line-186"></a>      <span class='hs-comment'>-- It seems to be used to store paths to external library dependencies</span>
<a name="line-187"></a>      <span class='hs-comment'>-- too.</span>
<a name="line-188"></a>
<a name="line-189"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitLibraryDynDirs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePathST</span><span class='hs-keyglyph'>]</span>
<a name="line-190"></a>      <span class='hs-comment'>-- ^ Directories containing the dynamic libraries provided by this unit.</span>
<a name="line-191"></a>      <span class='hs-comment'>-- See also `unitLibraryDirs`.</span>
<a name="line-192"></a>      <span class='hs-comment'>--</span>
<a name="line-193"></a>      <span class='hs-comment'>-- It seems to be used to store paths to external dynamic library</span>
<a name="line-194"></a>      <span class='hs-comment'>-- dependencies too.</span>
<a name="line-195"></a>
<a name="line-196"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitExtDepFrameworks</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ST.ShortText</span><span class='hs-keyglyph'>]</span>
<a name="line-197"></a>      <span class='hs-comment'>-- ^ Names of the external MacOS frameworks that this unit depends on.</span>
<a name="line-198"></a>
<a name="line-199"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitExtDepFrameworkDirs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePathST</span><span class='hs-keyglyph'>]</span>
<a name="line-200"></a>      <span class='hs-comment'>-- ^ Directories containing MacOS frameworks that this unit depends</span>
<a name="line-201"></a>      <span class='hs-comment'>-- on.</span>
<a name="line-202"></a>
<a name="line-203"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitLinkerOptions</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ST.ShortText</span><span class='hs-keyglyph'>]</span>
<a name="line-204"></a>      <span class='hs-comment'>-- ^ Linker (e.g. ld) command line options</span>
<a name="line-205"></a>
<a name="line-206"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitCcOptions</span>      <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ST.ShortText</span><span class='hs-keyglyph'>]</span>
<a name="line-207"></a>      <span class='hs-comment'>-- ^ C compiler options that needs to be passed to the C compiler when we</span>
<a name="line-208"></a>      <span class='hs-comment'>-- compile some C code against this unit.</span>
<a name="line-209"></a>
<a name="line-210"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitIncludes</span>       <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ST.ShortText</span><span class='hs-keyglyph'>]</span>
<a name="line-211"></a>      <span class='hs-comment'>-- ^ C header files that are required by this unit (provided by this unit</span>
<a name="line-212"></a>      <span class='hs-comment'>-- or external)</span>
<a name="line-213"></a>
<a name="line-214"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitIncludeDirs</span>    <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePathST</span><span class='hs-keyglyph'>]</span>
<a name="line-215"></a>      <span class='hs-comment'>-- ^ Directories containing C header files that this unit depends</span>
<a name="line-216"></a>      <span class='hs-comment'>-- on.</span>
<a name="line-217"></a>
<a name="line-218"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitHaddockInterfaces</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePathST</span><span class='hs-keyglyph'>]</span>
<a name="line-219"></a>      <span class='hs-comment'>-- ^ Paths to Haddock interface files for this unit</span>
<a name="line-220"></a>
<a name="line-221"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitHaddockHTMLs</span>   <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePathST</span><span class='hs-keyglyph'>]</span>
<a name="line-222"></a>      <span class='hs-comment'>-- ^ Paths to Haddock directories containing HTML files</span>
<a name="line-223"></a>
<a name="line-224"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitExposedModules</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>modulename</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-225"></a>      <span class='hs-comment'>-- ^ Modules exposed by the unit.</span>
<a name="line-226"></a>      <span class='hs-comment'>--</span>
<a name="line-227"></a>      <span class='hs-comment'>-- A module can be re-exported from another package. In this case, we</span>
<a name="line-228"></a>      <span class='hs-comment'>-- indicate the module origin in the second parameter.</span>
<a name="line-229"></a>
<a name="line-230"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitHiddenModules</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>modulename</span><span class='hs-keyglyph'>]</span>
<a name="line-231"></a>      <span class='hs-comment'>-- ^ Hidden modules.</span>
<a name="line-232"></a>      <span class='hs-comment'>--</span>
<a name="line-233"></a>      <span class='hs-comment'>-- These are useful for error reporting (e.g. if a hidden module is</span>
<a name="line-234"></a>      <span class='hs-comment'>-- imported)</span>
<a name="line-235"></a>
<a name="line-236"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitIsIndefinite</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-237"></a>      <span class='hs-comment'>-- ^ True if this unit has some module holes that need to be instantiated</span>
<a name="line-238"></a>      <span class='hs-comment'>-- with real modules to make the unit usable (a.k.a. Backpack).</span>
<a name="line-239"></a>
<a name="line-240"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitIsExposed</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-241"></a>      <span class='hs-comment'>-- ^ True if the unit is exposed. A unit could be installed in a database</span>
<a name="line-242"></a>      <span class='hs-comment'>-- by "disabled" by not being exposed.</span>
<a name="line-243"></a>
<a name="line-244"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitIsTrusted</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-245"></a>      <span class='hs-comment'>-- ^ True if the unit is trusted (cf Safe Haskell)</span>
<a name="line-246"></a>
<a name="line-247"></a>   <span class='hs-layout'>}</span>
<a name="line-248"></a>   <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span><span class='hs-layout'>)</span>
<a name="line-249"></a>
<a name="line-250"></a><a name="FilePathST"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FilePathST</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ST.ShortText</span>
<a name="line-251"></a>
<a name="line-252"></a><a name="mapGenericUnitInfo"></a><span class='hs-comment'>-- | Convert between GenericUnitInfo instances</span>
<a name="line-253"></a><span class='hs-definition'>mapGenericUnitInfo</span>
<a name="line-254"></a>   <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>uid1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uid2</span><span class='hs-layout'>)</span>
<a name="line-255"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>cid1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cid2</span><span class='hs-layout'>)</span>
<a name="line-256"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcpkg1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>srcpkg2</span><span class='hs-layout'>)</span>
<a name="line-257"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcpkgname1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>srcpkgname2</span><span class='hs-layout'>)</span>
<a name="line-258"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>modname1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>modname2</span><span class='hs-layout'>)</span>
<a name="line-259"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>mod1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mod2</span><span class='hs-layout'>)</span>
<a name="line-260"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenericUnitInfo</span> <span class='hs-varid'>cid1</span> <span class='hs-varid'>srcpkg1</span> <span class='hs-varid'>srcpkgname1</span> <span class='hs-varid'>uid1</span> <span class='hs-varid'>modname1</span> <span class='hs-varid'>mod1</span>
<a name="line-261"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GenericUnitInfo</span> <span class='hs-varid'>cid2</span> <span class='hs-varid'>srcpkg2</span> <span class='hs-varid'>srcpkgname2</span> <span class='hs-varid'>uid2</span> <span class='hs-varid'>modname2</span> <span class='hs-varid'>mod2</span><span class='hs-layout'>)</span>
<a name="line-262"></a><span class='hs-definition'>mapGenericUnitInfo</span> <span class='hs-varid'>fuid</span> <span class='hs-varid'>fcid</span> <span class='hs-varid'>fsrcpkg</span> <span class='hs-varid'>fsrcpkgname</span> <span class='hs-varid'>fmodname</span> <span class='hs-varid'>fmod</span> <span class='hs-varid'>g</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>GenericUnitInfo</span> <span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-263"></a>   <span class='hs-varid'>g</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unitId</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fuid</span> <span class='hs-varid'>unitId</span>
<a name="line-264"></a>     <span class='hs-layout'>,</span> <span class='hs-varid'>unitInstanceOf</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fcid</span> <span class='hs-varid'>unitInstanceOf</span>
<a name="line-265"></a>     <span class='hs-layout'>,</span> <span class='hs-varid'>unitInstantiations</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>bimap</span> <span class='hs-varid'>fmodname</span> <span class='hs-varid'>fmod</span><span class='hs-layout'>)</span> <span class='hs-varid'>unitInstantiations</span>
<a name="line-266"></a>     <span class='hs-layout'>,</span> <span class='hs-varid'>unitPackageId</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fsrcpkg</span> <span class='hs-varid'>unitPackageId</span>
<a name="line-267"></a>     <span class='hs-layout'>,</span> <span class='hs-varid'>unitPackageName</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fsrcpkgname</span> <span class='hs-varid'>unitPackageName</span>
<a name="line-268"></a>     <span class='hs-layout'>,</span> <span class='hs-varid'>unitComponentName</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>fsrcpkgname</span> <span class='hs-varid'>unitComponentName</span>
<a name="line-269"></a>     <span class='hs-layout'>,</span> <span class='hs-varid'>unitDepends</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>fuid</span> <span class='hs-varid'>unitDepends</span>
<a name="line-270"></a>     <span class='hs-layout'>,</span> <span class='hs-varid'>unitAbiDepends</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>first</span> <span class='hs-varid'>fuid</span><span class='hs-layout'>)</span> <span class='hs-varid'>unitAbiDepends</span>
<a name="line-271"></a>     <span class='hs-layout'>,</span> <span class='hs-varid'>unitExposedModules</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>bimap</span> <span class='hs-varid'>fmodname</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>fmod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>unitExposedModules</span>
<a name="line-272"></a>     <span class='hs-layout'>,</span> <span class='hs-varid'>unitHiddenModules</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>fmodname</span> <span class='hs-varid'>unitHiddenModules</span>
<a name="line-273"></a>     <span class='hs-layout'>}</span>
<a name="line-274"></a>
<a name="line-275"></a><a name="DbModule"></a><span class='hs-comment'>-- | @ghc-boot@'s 'Module', serialized to the database.</span>
<a name="line-276"></a><a name="DbModule"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DbModule</span>
<a name="line-277"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DbModule</span>
<a name="line-278"></a>      <span class='hs-layout'>{</span> <span class='hs-varid'>dbModuleUnitId</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DbInstUnitId</span>
<a name="line-279"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>dbModuleName</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BS.ByteString</span>
<a name="line-280"></a>      <span class='hs-layout'>}</span>
<a name="line-281"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DbModuleVar</span>
<a name="line-282"></a>      <span class='hs-layout'>{</span> <span class='hs-varid'>dbModuleVarName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BS.ByteString</span>
<a name="line-283"></a>      <span class='hs-layout'>}</span>
<a name="line-284"></a>   <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span><span class='hs-layout'>)</span>
<a name="line-285"></a>
<a name="line-286"></a><a name="DbInstUnitId"></a><span class='hs-comment'>-- | @ghc-boot@'s instantiated unit id, serialized to the database.</span>
<a name="line-287"></a><a name="DbInstUnitId"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DbInstUnitId</span>
<a name="line-288"></a>
<a name="line-289"></a>   <span class='hs-comment'>-- | Instantiated unit</span>
<a name="line-290"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DbInstUnitId</span>
<a name="line-291"></a>      <span class='hs-conid'>BS.ByteString</span>               <span class='hs-comment'>-- component id</span>
<a name="line-292"></a>      <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>BS.ByteString</span><span class='hs-layout'>,</span> <span class='hs-conid'>DbModule</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- instantiations: [(modulename,module)]</span>
<a name="line-293"></a>
<a name="line-294"></a>   <span class='hs-comment'>-- | Uninstantiated unit</span>
<a name="line-295"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DbUnitId</span>
<a name="line-296"></a>      <span class='hs-conid'>BS.ByteString</span>               <span class='hs-comment'>-- unit id</span>
<a name="line-297"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span><span class='hs-layout'>)</span>
<a name="line-298"></a>
<a name="line-299"></a><a name="PackageDbLock"></a><span class='hs-comment'>-- | Represents a lock of a package db.</span>
<a name="line-300"></a><a name="PackageDbLock"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>PackageDbLock</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PackageDbLock</span> <span class='hs-conid'>Handle</span>
<a name="line-301"></a>
<a name="line-302"></a><a name="lockPackageDb"></a><span class='hs-comment'>-- | Acquire an exclusive lock related to package DB under given location.</span>
<a name="line-303"></a><span class='hs-definition'>lockPackageDb</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>PackageDbLock</span>
<a name="line-304"></a>
<a name="line-305"></a><a name="unlockPackageDb"></a><span class='hs-comment'>-- | Release the lock related to package DB.</span>
<a name="line-306"></a><span class='hs-definition'>unlockPackageDb</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PackageDbLock</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-307"></a>
<a name="line-308"></a><a name="lockPackageDbWith"></a><span class='hs-comment'>-- | Acquire a lock of given type related to package DB under given location.</span>
<a name="line-309"></a><span class='hs-definition'>lockPackageDbWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LockMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>PackageDbLock</span>
<a name="line-310"></a><span class='hs-definition'>lockPackageDbWith</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>file</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-311"></a>  <span class='hs-comment'>-- We are trying to open the lock file and then lock it. Thus the lock file</span>
<a name="line-312"></a>  <span class='hs-comment'>-- needs to either exist or we need to be able to create it. Ideally we</span>
<a name="line-313"></a>  <span class='hs-comment'>-- would not assume that the lock file always exists in advance. When we are</span>
<a name="line-314"></a>  <span class='hs-comment'>-- dealing with a package DB where we have write access then if the lock</span>
<a name="line-315"></a>  <span class='hs-comment'>-- file does not exist then we can create it by opening the file in</span>
<a name="line-316"></a>  <span class='hs-comment'>-- read/write mode. On the other hand if we are dealing with a package DB</span>
<a name="line-317"></a>  <span class='hs-comment'>-- where we do not have write access (e.g. a global DB) then we can only</span>
<a name="line-318"></a>  <span class='hs-comment'>-- open in read mode, and the lock file had better exist already or we're in</span>
<a name="line-319"></a>  <span class='hs-comment'>-- trouble. So for global read-only DBs on platforms where we must lock the</span>
<a name="line-320"></a>  <span class='hs-comment'>-- DB for reading then we will require that the installer/packaging has</span>
<a name="line-321"></a>  <span class='hs-comment'>-- included the lock file.</span>
<a name="line-322"></a>  <span class='hs-comment'>--</span>
<a name="line-323"></a>  <span class='hs-comment'>-- Thus the logic here is to first try opening in read-write mode</span>
<a name="line-324"></a>  <span class='hs-comment'>-- and if that fails we try read-only (to handle global read-only DBs).</span>
<a name="line-325"></a>  <span class='hs-comment'>-- If either succeed then lock the file. IO exceptions (other than the first</span>
<a name="line-326"></a>  <span class='hs-comment'>-- open attempt failing due to the file not existing) simply propagate.</span>
<a name="line-327"></a>  <span class='hs-comment'>--</span>
<a name="line-328"></a>  <span class='hs-comment'>-- Note that there is a complexity here which was discovered in #13945: some</span>
<a name="line-329"></a>  <span class='hs-comment'>-- filesystems (e.g. NFS) will only allow exclusive locking if the fd was</span>
<a name="line-330"></a>  <span class='hs-comment'>-- opened for write access. We would previously try opening the lockfile for</span>
<a name="line-331"></a>  <span class='hs-comment'>-- read-only access first, however this failed when run on such filesystems.</span>
<a name="line-332"></a>  <span class='hs-comment'>-- Consequently, we now try read-write access first, falling back to read-only</span>
<a name="line-333"></a>  <span class='hs-comment'>-- if we are denied permission (e.g. in the case of a global database).</span>
<a name="line-334"></a>  <span class='hs-varid'>catchJust</span>
<a name="line-335"></a>    <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isPermissionError</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>()</span> <span class='hs-keyword'>else</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-336"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>lockFileOpenIn</span> <span class='hs-conid'>ReadWriteMode</span><span class='hs-layout'>)</span>
<a name="line-337"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lockFileOpenIn</span> <span class='hs-conid'>ReadMode</span><span class='hs-layout'>)</span>
<a name="line-338"></a>  <span class='hs-keyword'>where</span>
<a name="line-339"></a>    <span class='hs-varid'>lock</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>file</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-str'>"lock"</span>
<a name="line-340"></a>
<a name="line-341"></a>    <span class='hs-varid'>lockFileOpenIn</span> <span class='hs-varid'>io_mode</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bracketOnError</span>
<a name="line-342"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>openBinaryFile</span> <span class='hs-varid'>lock</span> <span class='hs-varid'>io_mode</span><span class='hs-layout'>)</span>
<a name="line-343"></a>      <span class='hs-varid'>hClose</span>
<a name="line-344"></a>      <span class='hs-comment'>-- If file locking support is not available, ignore the error and proceed</span>
<a name="line-345"></a>      <span class='hs-comment'>-- normally. Without it the only thing we lose on non-Windows platforms is</span>
<a name="line-346"></a>      <span class='hs-comment'>-- the ability to safely issue concurrent updates to the same package db.</span>
<a name="line-347"></a>      <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hnd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>hLock</span> <span class='hs-varid'>hnd</span> <span class='hs-varid'>mode</span> <span class='hs-varop'>`catch`</span> <span class='hs-keyglyph'>\</span><span class='hs-conid'>FileLockingNotSupported</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-348"></a>                   <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>PackageDbLock</span> <span class='hs-varid'>hnd</span>
<a name="line-349"></a>
<a name="line-350"></a><span class='hs-definition'>lockPackageDb</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lockPackageDbWith</span> <span class='hs-conid'>ExclusiveLock</span>
<a name="line-351"></a><span class='hs-definition'>unlockPackageDb</span> <span class='hs-layout'>(</span><span class='hs-conid'>PackageDbLock</span> <span class='hs-varid'>hnd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-352"></a>    <span class='hs-varid'>hUnlock</span> <span class='hs-varid'>hnd</span>
<a name="line-353"></a>    <span class='hs-varid'>hClose</span> <span class='hs-varid'>hnd</span>
<a name="line-354"></a>
<a name="line-355"></a><a name="DbMode"></a><span class='hs-comment'>-- | Mode to open a package db in.</span>
<a name="line-356"></a><a name="DbMode"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DbMode</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DbReadOnly</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DbReadWrite</span>
<a name="line-357"></a>
<a name="line-358"></a><a name="DbOpenMode"></a><span class='hs-comment'>-- | 'DbOpenMode' holds a value of type @t@ but only in 'DbReadWrite' mode.  So</span>
<a name="line-359"></a><a name="DbOpenMode"></a><span class='hs-comment'>-- it is like 'Maybe' but with a type argument for the mode to enforce that the</span>
<a name="line-360"></a><a name="DbOpenMode"></a><span class='hs-comment'>-- mode is used consistently.</span>
<a name="line-361"></a><a name="DbOpenMode"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DbOpenMode</span> <span class='hs-layout'>(</span><span class='hs-varid'>mode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DbMode</span><span class='hs-layout'>)</span> <span class='hs-varid'>t</span> <span class='hs-keyword'>where</span>
<a name="line-362"></a>  <span class='hs-conid'>DbOpenReadOnly</span>  <span class='hs-keyglyph'>::</span>      <span class='hs-conid'>DbOpenMode</span> <span class='hs-chr'>'</span><span class='hs-conid'>DbReadOnly</span> <span class='hs-varid'>t</span>
<a name="line-363"></a>  <span class='hs-conid'>DbOpenReadWrite</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DbOpenMode</span> <span class='hs-chr'>'</span><span class='hs-conid'>DbReadWrite</span> <span class='hs-varid'>t</span>
<a name="line-364"></a>
<a name="line-365"></a><span class='hs-keyword'>deriving</span> <span class='hs-keyword'>instance</span> <span class='hs-conid'>Functor</span> <span class='hs-layout'>(</span><span class='hs-conid'>DbOpenMode</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span>
<a name="line-366"></a><span class='hs-keyword'>deriving</span> <span class='hs-keyword'>instance</span> <span class='hs-conid'>F.Foldable</span> <span class='hs-layout'>(</span><span class='hs-conid'>DbOpenMode</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span>
<a name="line-367"></a><span class='hs-keyword'>deriving</span> <span class='hs-keyword'>instance</span> <span class='hs-conid'>F.Traversable</span> <span class='hs-layout'>(</span><span class='hs-conid'>DbOpenMode</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span>
<a name="line-368"></a>
<a name="line-369"></a><a name="isDbOpenReadMode"></a><span class='hs-definition'>isDbOpenReadMode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DbOpenMode</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-370"></a><span class='hs-definition'>isDbOpenReadMode</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>case</span>
<a name="line-371"></a>  <span class='hs-conid'>DbOpenReadOnly</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-372"></a>  <span class='hs-conid'>DbOpenReadWrite</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-373"></a>
<a name="line-374"></a><a name="readPackageDbForGhc"></a><span class='hs-comment'>-- | Read the part of the package DB that GHC is interested in.</span>
<a name="line-375"></a><span class='hs-comment'>--</span>
<a name="line-376"></a><span class='hs-definition'>readPackageDbForGhc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DbUnitInfo</span><span class='hs-keyglyph'>]</span>
<a name="line-377"></a><span class='hs-definition'>readPackageDbForGhc</span> <span class='hs-varid'>file</span> <span class='hs-keyglyph'>=</span>
<a name="line-378"></a>  <span class='hs-varid'>decodeFromFile</span> <span class='hs-varid'>file</span> <span class='hs-conid'>DbOpenReadOnly</span> <span class='hs-varid'>getDbForGhc</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>case</span>
<a name="line-379"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>pkgs</span><span class='hs-layout'>,</span> <span class='hs-conid'>DbOpenReadOnly</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>pkgs</span>
<a name="line-380"></a>  <span class='hs-keyword'>where</span>
<a name="line-381"></a>    <span class='hs-varid'>getDbForGhc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-382"></a>      <span class='hs-sel'>_version</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHeader</span>
<a name="line-383"></a>      <span class='hs-sel'>_ghcPartLen</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Get</span> <span class='hs-conid'>Word32</span>
<a name="line-384"></a>      <span class='hs-varid'>ghcPart</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-385"></a>      <span class='hs-comment'>-- the next part is for ghc-pkg, but we stop here.</span>
<a name="line-386"></a>      <span class='hs-varid'>return</span> <span class='hs-varid'>ghcPart</span>
<a name="line-387"></a>
<a name="line-388"></a><a name="readPackageDbForGhcPkg"></a><span class='hs-comment'>-- | Read the part of the package DB that ghc-pkg is interested in</span>
<a name="line-389"></a><span class='hs-comment'>--</span>
<a name="line-390"></a><span class='hs-comment'>-- Note that the Binary instance for ghc-pkg's representation of packages</span>
<a name="line-391"></a><span class='hs-comment'>-- is not defined in this package. This is because ghc-pkg uses Cabal types</span>
<a name="line-392"></a><span class='hs-comment'>-- (and Binary instances for these) which this package does not depend on.</span>
<a name="line-393"></a><span class='hs-comment'>--</span>
<a name="line-394"></a><span class='hs-comment'>-- If we open the package db in read only mode, we get its contents. Otherwise</span>
<a name="line-395"></a><span class='hs-comment'>-- we additionally receive a PackageDbLock that represents a lock on the</span>
<a name="line-396"></a><span class='hs-comment'>-- database, so that we can safely update it later.</span>
<a name="line-397"></a><span class='hs-comment'>--</span>
<a name="line-398"></a><span class='hs-definition'>readPackageDbForGhcPkg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Binary</span> <span class='hs-varid'>pkgs</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DbOpenMode</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-399"></a>                          <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkgs</span><span class='hs-layout'>,</span> <span class='hs-conid'>DbOpenMode</span> <span class='hs-varid'>mode</span> <span class='hs-conid'>PackageDbLock</span><span class='hs-layout'>)</span>
<a name="line-400"></a><span class='hs-definition'>readPackageDbForGhcPkg</span> <span class='hs-varid'>file</span> <span class='hs-varid'>mode</span> <span class='hs-keyglyph'>=</span>
<a name="line-401"></a>    <span class='hs-varid'>decodeFromFile</span> <span class='hs-varid'>file</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>getDbForGhcPkg</span>
<a name="line-402"></a>  <span class='hs-keyword'>where</span>
<a name="line-403"></a>    <span class='hs-varid'>getDbForGhcPkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-404"></a>      <span class='hs-sel'>_version</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHeader</span>
<a name="line-405"></a>      <span class='hs-comment'>-- skip over the ghc part</span>
<a name="line-406"></a>      <span class='hs-varid'>ghcPartLen</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Get</span> <span class='hs-conid'>Word32</span>
<a name="line-407"></a>      <span class='hs-sel'>_ghcPart</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>skip</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>ghcPartLen</span><span class='hs-layout'>)</span>
<a name="line-408"></a>      <span class='hs-comment'>-- the next part is for ghc-pkg</span>
<a name="line-409"></a>      <span class='hs-varid'>ghcPkgPart</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-410"></a>      <span class='hs-varid'>return</span> <span class='hs-varid'>ghcPkgPart</span>
<a name="line-411"></a>
<a name="line-412"></a><a name="writePackageDb"></a><span class='hs-comment'>-- | Write the whole of the package DB, both parts.</span>
<a name="line-413"></a><span class='hs-comment'>--</span>
<a name="line-414"></a><span class='hs-definition'>writePackageDb</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Binary</span> <span class='hs-varid'>pkgs</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DbUnitInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pkgs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-415"></a><span class='hs-definition'>writePackageDb</span> <span class='hs-varid'>file</span> <span class='hs-varid'>ghcPkgs</span> <span class='hs-varid'>ghcPkgPart</span> <span class='hs-keyglyph'>=</span>
<a name="line-416"></a>  <span class='hs-varid'>writeFileAtomic</span> <span class='hs-varid'>file</span> <span class='hs-layout'>(</span><span class='hs-varid'>runPut</span> <span class='hs-varid'>putDbForGhcPkg</span><span class='hs-layout'>)</span>
<a name="line-417"></a>  <span class='hs-keyword'>where</span>
<a name="line-418"></a>    <span class='hs-varid'>putDbForGhcPkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-419"></a>        <span class='hs-varid'>putHeader</span>
<a name="line-420"></a>        <span class='hs-varid'>put</span>               <span class='hs-varid'>ghcPartLen</span>
<a name="line-421"></a>        <span class='hs-varid'>putLazyByteString</span> <span class='hs-varid'>ghcPart</span>
<a name="line-422"></a>        <span class='hs-varid'>put</span>               <span class='hs-varid'>ghcPkgPart</span>
<a name="line-423"></a>      <span class='hs-keyword'>where</span>
<a name="line-424"></a>        <span class='hs-varid'>ghcPartLen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word32</span>
<a name="line-425"></a>        <span class='hs-varid'>ghcPartLen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-conid'>BS.Lazy.length</span> <span class='hs-varid'>ghcPart</span><span class='hs-layout'>)</span>
<a name="line-426"></a>        <span class='hs-varid'>ghcPart</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>encode</span> <span class='hs-varid'>ghcPkgs</span>
<a name="line-427"></a>
<a name="line-428"></a><a name="getHeader"></a><span class='hs-definition'>getHeader</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Get</span> <span class='hs-layout'>(</span><span class='hs-conid'>Word32</span><span class='hs-layout'>,</span> <span class='hs-conid'>Word32</span><span class='hs-layout'>)</span>
<a name="line-429"></a><span class='hs-definition'>getHeader</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-430"></a>    <span class='hs-varid'>magic</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByteString</span> <span class='hs-layout'>(</span><span class='hs-conid'>BS.length</span> <span class='hs-varid'>headerMagic</span><span class='hs-layout'>)</span>
<a name="line-431"></a>    <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>magic</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>headerMagic</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-432"></a>      <span class='hs-varid'>fail</span> <span class='hs-str'>"not a ghc-pkg db file, wrong file magic number"</span>
<a name="line-433"></a>
<a name="line-434"></a>    <span class='hs-varid'>majorVersion</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Get</span> <span class='hs-conid'>Word32</span>
<a name="line-435"></a>    <span class='hs-comment'>-- The major version is for incompatible changes</span>
<a name="line-436"></a>
<a name="line-437"></a>    <span class='hs-varid'>minorVersion</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Get</span> <span class='hs-conid'>Word32</span>
<a name="line-438"></a>    <span class='hs-comment'>-- The minor version is for compatible extensions</span>
<a name="line-439"></a>
<a name="line-440"></a>    <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>majorVersion</span> <span class='hs-varop'>/=</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-441"></a>      <span class='hs-varid'>fail</span> <span class='hs-str'>"unsupported ghc-pkg db format version"</span>
<a name="line-442"></a>    <span class='hs-comment'>-- If we ever support multiple major versions then we'll have to change</span>
<a name="line-443"></a>    <span class='hs-comment'>-- this code</span>
<a name="line-444"></a>
<a name="line-445"></a>    <span class='hs-comment'>-- The header can be extended without incrementing the major version,</span>
<a name="line-446"></a>    <span class='hs-comment'>-- we ignore fields we don't know about (currently all).</span>
<a name="line-447"></a>    <span class='hs-varid'>headerExtraLen</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Get</span> <span class='hs-conid'>Word32</span>
<a name="line-448"></a>    <span class='hs-varid'>skip</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>headerExtraLen</span><span class='hs-layout'>)</span>
<a name="line-449"></a>
<a name="line-450"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>majorVersion</span><span class='hs-layout'>,</span> <span class='hs-varid'>minorVersion</span><span class='hs-layout'>)</span>
<a name="line-451"></a>
<a name="line-452"></a><a name="putHeader"></a><span class='hs-definition'>putHeader</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Put</span>
<a name="line-453"></a><span class='hs-definition'>putHeader</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-454"></a>    <span class='hs-varid'>putByteString</span> <span class='hs-varid'>headerMagic</span>
<a name="line-455"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>majorVersion</span>
<a name="line-456"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>minorVersion</span>
<a name="line-457"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>headerExtraLen</span>
<a name="line-458"></a>  <span class='hs-keyword'>where</span>
<a name="line-459"></a>    <span class='hs-varid'>majorVersion</span>   <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word32</span>
<a name="line-460"></a>    <span class='hs-varid'>minorVersion</span>   <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word32</span>
<a name="line-461"></a>    <span class='hs-varid'>headerExtraLen</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word32</span>
<a name="line-462"></a>
<a name="line-463"></a><a name="headerMagic"></a><span class='hs-definition'>headerMagic</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BS.ByteString</span>
<a name="line-464"></a><span class='hs-definition'>headerMagic</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BS.Char8.pack</span> <span class='hs-str'>"\0ghcpkg\0"</span>
<a name="line-465"></a>
<a name="line-466"></a>
<a name="line-467"></a><span class='hs-comment'>-- TODO: we may be able to replace the following with utils from the binary</span>
<a name="line-468"></a><span class='hs-comment'>-- package in future.</span>
<a name="line-469"></a>
<a name="line-470"></a><a name="decodeFromFile"></a><span class='hs-comment'>-- | Feed a 'Get' decoder with data chunks from a file.</span>
<a name="line-471"></a><span class='hs-comment'>--</span>
<a name="line-472"></a><span class='hs-definition'>decodeFromFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DbOpenMode</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Get</span> <span class='hs-varid'>pkgs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-473"></a>                  <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkgs</span><span class='hs-layout'>,</span> <span class='hs-conid'>DbOpenMode</span> <span class='hs-varid'>mode</span> <span class='hs-conid'>PackageDbLock</span><span class='hs-layout'>)</span>
<a name="line-474"></a><span class='hs-definition'>decodeFromFile</span> <span class='hs-varid'>file</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>decoder</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mode</span> <span class='hs-keyword'>of</span>
<a name="line-475"></a>  <span class='hs-conid'>DbOpenReadOnly</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-476"></a>  <span class='hs-comment'>-- Note [Locking package database on Windows]</span>
<a name="line-477"></a>  <span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-478"></a>  <span class='hs-comment'>-- When we open the package db in read only mode, there is no need to acquire</span>
<a name="line-479"></a>  <span class='hs-comment'>-- shared lock on non-Windows platform because we update the database with an</span>
<a name="line-480"></a>  <span class='hs-comment'>-- atomic rename, so readers will always see the database in a consistent</span>
<a name="line-481"></a>  <span class='hs-comment'>-- state.</span>
<a name="line-482"></a><span class='hs-cpp'>#if defined(mingw32_HOST_OS)</span>
<a name="line-483"></a>    <span class='hs-varid'>bracket</span> <span class='hs-layout'>(</span><span class='hs-varid'>lockPackageDbWith</span> <span class='hs-conid'>SharedLock</span> <span class='hs-varid'>file</span><span class='hs-layout'>)</span> <span class='hs-varid'>unlockPackageDb</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-484"></a><span class='hs-cpp'>#endif</span>
<a name="line-485"></a>      <span class='hs-layout'>(</span><span class='hs-layout'>,</span> <span class='hs-conid'>DbOpenReadOnly</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>decodeFileContents</span>
<a name="line-486"></a>  <span class='hs-conid'>DbOpenReadWrite</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-487"></a>    <span class='hs-comment'>-- When we open the package db in read/write mode, acquire an exclusive lock</span>
<a name="line-488"></a>    <span class='hs-comment'>-- on the database and return it so we can keep it for the duration of the</span>
<a name="line-489"></a>    <span class='hs-comment'>-- update.</span>
<a name="line-490"></a>    <span class='hs-varid'>bracketOnError</span> <span class='hs-layout'>(</span><span class='hs-varid'>lockPackageDb</span> <span class='hs-varid'>file</span><span class='hs-layout'>)</span> <span class='hs-varid'>unlockPackageDb</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>lock</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-491"></a>      <span class='hs-layout'>(</span><span class='hs-layout'>,</span> <span class='hs-conid'>DbOpenReadWrite</span> <span class='hs-varid'>lock</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>decodeFileContents</span>
<a name="line-492"></a>  <span class='hs-keyword'>where</span>
<a name="line-493"></a>    <span class='hs-varid'>decodeFileContents</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withBinaryFile</span> <span class='hs-varid'>file</span> <span class='hs-conid'>ReadMode</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hnd</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-494"></a>      <span class='hs-varid'>feed</span> <span class='hs-varid'>hnd</span> <span class='hs-layout'>(</span><span class='hs-varid'>runGetIncremental</span> <span class='hs-varid'>decoder</span><span class='hs-layout'>)</span>
<a name="line-495"></a>
<a name="line-496"></a>    <span class='hs-varid'>feed</span> <span class='hs-varid'>hnd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Partial</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>chunk</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>BS.hGet</span> <span class='hs-varid'>hnd</span> <span class='hs-conid'>BS.Lazy.defaultChunkSize</span>
<a name="line-497"></a>                               <span class='hs-keyword'>if</span> <span class='hs-conid'>BS.null</span> <span class='hs-varid'>chunk</span>
<a name="line-498"></a>                                 <span class='hs-keyword'>then</span> <span class='hs-varid'>feed</span> <span class='hs-varid'>hnd</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-499"></a>                                 <span class='hs-keyword'>else</span> <span class='hs-varid'>feed</span> <span class='hs-varid'>hnd</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>chunk</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-500"></a>    <span class='hs-varid'>feed</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Done</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span>
<a name="line-501"></a>    <span class='hs-varid'>feed</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fail</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ioError</span> <span class='hs-varid'>err</span>
<a name="line-502"></a>      <span class='hs-keyword'>where</span>
<a name="line-503"></a>        <span class='hs-varid'>err</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkIOError</span> <span class='hs-conid'>InappropriateType</span> <span class='hs-varid'>loc</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>file</span><span class='hs-layout'>)</span>
<a name="line-504"></a>              <span class='hs-varop'>`ioeSetErrorString`</span> <span class='hs-varid'>msg</span>
<a name="line-505"></a>        <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"GHC.Unit.Database.readPackageDb"</span>
<a name="line-506"></a>
<a name="line-507"></a><a name="writeFileAtomic"></a><span class='hs-comment'>-- Copied from Cabal's Distribution.Simple.Utils.</span>
<a name="line-508"></a><span class='hs-definition'>writeFileAtomic</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BS.Lazy.ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-509"></a><span class='hs-definition'>writeFileAtomic</span> <span class='hs-varid'>targetPath</span> <span class='hs-varid'>content</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-510"></a>  <span class='hs-comment'>-- Figure out how to update the file mode after we create the temporary file</span>
<a name="line-511"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>no_update</span> <span class='hs-sel'>_path</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-512"></a><span class='hs-cpp'>#if !defined(mingw32_HOST_OS)</span>
<a name="line-513"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>on_error</span> <span class='hs-varid'>ioe</span> <span class='hs-keyglyph'>=</span>
<a name="line-514"></a>          <span class='hs-comment'>-- If the file doesn't yet exist then just use the default owner and</span>
<a name="line-515"></a>          <span class='hs-comment'>-- mode.</span>
<a name="line-516"></a>          <span class='hs-keyword'>case</span> <span class='hs-varid'>ioe_type</span> <span class='hs-varid'>ioe</span> <span class='hs-keyword'>of</span>
<a name="line-517"></a>            <span class='hs-conid'>NoSuchThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>no_update</span>
<a name="line-518"></a>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ioError</span> <span class='hs-varid'>ioe</span>
<a name="line-519"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>handleIO</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>IOException</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-520"></a>      <span class='hs-varid'>handleIO</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flip</span> <span class='hs-varid'>catch</span>
<a name="line-521"></a>  <span class='hs-varid'>set_metadata</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>handleIO</span> <span class='hs-varid'>on_error</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-522"></a>      <span class='hs-varid'>status</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getFileStatus</span> <span class='hs-varid'>targetPath</span>
<a name="line-523"></a>      <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>path</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-524"></a>        <span class='hs-varid'>setFileMode</span> <span class='hs-varid'>path</span> <span class='hs-layout'>(</span><span class='hs-varid'>fileMode</span> <span class='hs-varid'>status</span><span class='hs-layout'>)</span>
<a name="line-525"></a>        <span class='hs-varid'>setOwnerAndGroup</span> <span class='hs-varid'>path</span> <span class='hs-layout'>(</span><span class='hs-varid'>fileOwner</span> <span class='hs-varid'>status</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fileGroup</span> <span class='hs-varid'>status</span><span class='hs-layout'>)</span>
<a name="line-526"></a><span class='hs-cpp'>#else</span>
<a name="line-527"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>set_metadata</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_update</span>
<a name="line-528"></a><span class='hs-cpp'>#endif</span>
<a name="line-529"></a>
<a name="line-530"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetDir</span><span class='hs-layout'>,</span> <span class='hs-varid'>targetFile</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitFileName</span> <span class='hs-varid'>targetPath</span>
<a name="line-531"></a>  <span class='hs-conid'>Exception.bracketOnError</span>
<a name="line-532"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>openBinaryTempFileWithDefaultPermissions</span> <span class='hs-varid'>targetDir</span> <span class='hs-varop'>$</span> <span class='hs-varid'>targetFile</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-str'>"tmp"</span><span class='hs-layout'>)</span>
<a name="line-533"></a>    <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>tmpPath</span><span class='hs-layout'>,</span> <span class='hs-varid'>handle</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>hClose</span> <span class='hs-varid'>handle</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>removeFile</span> <span class='hs-varid'>tmpPath</span><span class='hs-layout'>)</span>
<a name="line-534"></a>    <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>tmpPath</span><span class='hs-layout'>,</span> <span class='hs-varid'>handle</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-535"></a>        <span class='hs-conid'>BS.Lazy.hPut</span> <span class='hs-varid'>handle</span> <span class='hs-varid'>content</span>
<a name="line-536"></a>        <span class='hs-varid'>hClose</span> <span class='hs-varid'>handle</span>
<a name="line-537"></a>        <span class='hs-varid'>set_metadata</span> <span class='hs-varid'>tmpPath</span>
<a name="line-538"></a>        <span class='hs-varid'>renameFile</span> <span class='hs-varid'>tmpPath</span> <span class='hs-varid'>targetPath</span><span class='hs-layout'>)</span>
<a name="line-539"></a>
<a name="line-540"></a><a name="instance%20Binary%20DbUnitInfo"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>DbUnitInfo</span> <span class='hs-keyword'>where</span>
<a name="line-541"></a>  <span class='hs-varid'>put</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenericUnitInfo</span>
<a name="line-542"></a>         <span class='hs-varid'>unitId</span> <span class='hs-varid'>unitInstanceOf</span> <span class='hs-varid'>unitInstantiations</span>
<a name="line-543"></a>         <span class='hs-varid'>unitPackageId</span>
<a name="line-544"></a>         <span class='hs-varid'>unitPackageName</span> <span class='hs-varid'>unitPackageVersion</span>
<a name="line-545"></a>         <span class='hs-varid'>unitComponentName</span>
<a name="line-546"></a>         <span class='hs-varid'>unitAbiHash</span> <span class='hs-varid'>unitDepends</span> <span class='hs-varid'>unitAbiDepends</span> <span class='hs-varid'>unitImportDirs</span>
<a name="line-547"></a>         <span class='hs-varid'>unitLibraries</span> <span class='hs-varid'>unitExtDepLibsSys</span> <span class='hs-varid'>unitExtDepLibsGhc</span>
<a name="line-548"></a>         <span class='hs-varid'>unitLibraryDirs</span> <span class='hs-varid'>unitLibraryDynDirs</span>
<a name="line-549"></a>         <span class='hs-varid'>unitExtDepFrameworks</span> <span class='hs-varid'>unitExtDepFrameworkDirs</span>
<a name="line-550"></a>         <span class='hs-varid'>unitLinkerOptions</span> <span class='hs-varid'>unitCcOptions</span>
<a name="line-551"></a>         <span class='hs-varid'>unitIncludes</span> <span class='hs-varid'>unitIncludeDirs</span>
<a name="line-552"></a>         <span class='hs-varid'>unitHaddockInterfaces</span> <span class='hs-varid'>unitHaddockHTMLs</span>
<a name="line-553"></a>         <span class='hs-varid'>unitExposedModules</span> <span class='hs-varid'>unitHiddenModules</span>
<a name="line-554"></a>         <span class='hs-varid'>unitIsIndefinite</span> <span class='hs-varid'>unitIsExposed</span> <span class='hs-varid'>unitIsTrusted</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-555"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitPackageId</span>
<a name="line-556"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitPackageName</span>
<a name="line-557"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitPackageVersion</span>
<a name="line-558"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitComponentName</span>
<a name="line-559"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitId</span>
<a name="line-560"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitInstanceOf</span>
<a name="line-561"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitInstantiations</span>
<a name="line-562"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitAbiHash</span>
<a name="line-563"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitDepends</span>
<a name="line-564"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitAbiDepends</span>
<a name="line-565"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitImportDirs</span>
<a name="line-566"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitLibraries</span>
<a name="line-567"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitExtDepLibsSys</span>
<a name="line-568"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitExtDepLibsGhc</span>
<a name="line-569"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitLibraryDirs</span>
<a name="line-570"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitLibraryDynDirs</span>
<a name="line-571"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitExtDepFrameworks</span>
<a name="line-572"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitExtDepFrameworkDirs</span>
<a name="line-573"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitLinkerOptions</span>
<a name="line-574"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitCcOptions</span>
<a name="line-575"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitIncludes</span>
<a name="line-576"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitIncludeDirs</span>
<a name="line-577"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitHaddockInterfaces</span>
<a name="line-578"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitHaddockHTMLs</span>
<a name="line-579"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitExposedModules</span>
<a name="line-580"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitHiddenModules</span>
<a name="line-581"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitIsIndefinite</span>
<a name="line-582"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitIsExposed</span>
<a name="line-583"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>unitIsTrusted</span>
<a name="line-584"></a>
<a name="line-585"></a>  <span class='hs-varid'>get</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-586"></a>    <span class='hs-varid'>unitPackageId</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-587"></a>    <span class='hs-varid'>unitPackageName</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-588"></a>    <span class='hs-varid'>unitPackageVersion</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-589"></a>    <span class='hs-varid'>unitComponentName</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-590"></a>    <span class='hs-varid'>unitId</span>             <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-591"></a>    <span class='hs-varid'>unitInstanceOf</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-592"></a>    <span class='hs-varid'>unitInstantiations</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-593"></a>    <span class='hs-varid'>unitAbiHash</span>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-594"></a>    <span class='hs-varid'>unitDepends</span>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-595"></a>    <span class='hs-varid'>unitAbiDepends</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-596"></a>    <span class='hs-varid'>unitImportDirs</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-597"></a>    <span class='hs-varid'>unitLibraries</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-598"></a>    <span class='hs-varid'>unitExtDepLibsSys</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-599"></a>    <span class='hs-varid'>unitExtDepLibsGhc</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-600"></a>    <span class='hs-varid'>libraryDirs</span>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-601"></a>    <span class='hs-varid'>libraryDynDirs</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-602"></a>    <span class='hs-varid'>frameworks</span>         <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-603"></a>    <span class='hs-varid'>frameworkDirs</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-604"></a>    <span class='hs-varid'>unitLinkerOptions</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-605"></a>    <span class='hs-varid'>unitCcOptions</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-606"></a>    <span class='hs-varid'>unitIncludes</span>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-607"></a>    <span class='hs-varid'>unitIncludeDirs</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-608"></a>    <span class='hs-varid'>unitHaddockInterfaces</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-609"></a>    <span class='hs-varid'>unitHaddockHTMLs</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-610"></a>    <span class='hs-varid'>unitExposedModules</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-611"></a>    <span class='hs-varid'>unitHiddenModules</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-612"></a>    <span class='hs-varid'>unitIsIndefinite</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-613"></a>    <span class='hs-varid'>unitIsExposed</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-614"></a>    <span class='hs-varid'>unitIsTrusted</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-615"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenericUnitInfo</span>
<a name="line-616"></a>              <span class='hs-varid'>unitId</span>
<a name="line-617"></a>              <span class='hs-varid'>unitInstanceOf</span>
<a name="line-618"></a>              <span class='hs-varid'>unitInstantiations</span>
<a name="line-619"></a>              <span class='hs-varid'>unitPackageId</span>
<a name="line-620"></a>              <span class='hs-varid'>unitPackageName</span>
<a name="line-621"></a>              <span class='hs-varid'>unitPackageVersion</span>
<a name="line-622"></a>              <span class='hs-varid'>unitComponentName</span>
<a name="line-623"></a>              <span class='hs-varid'>unitAbiHash</span>
<a name="line-624"></a>              <span class='hs-varid'>unitDepends</span>
<a name="line-625"></a>              <span class='hs-varid'>unitAbiDepends</span>
<a name="line-626"></a>              <span class='hs-varid'>unitImportDirs</span>
<a name="line-627"></a>              <span class='hs-varid'>unitLibraries</span> <span class='hs-varid'>unitExtDepLibsSys</span> <span class='hs-varid'>unitExtDepLibsGhc</span>
<a name="line-628"></a>              <span class='hs-varid'>libraryDirs</span> <span class='hs-varid'>libraryDynDirs</span>
<a name="line-629"></a>              <span class='hs-varid'>frameworks</span> <span class='hs-varid'>frameworkDirs</span>
<a name="line-630"></a>              <span class='hs-varid'>unitLinkerOptions</span> <span class='hs-varid'>unitCcOptions</span>
<a name="line-631"></a>              <span class='hs-varid'>unitIncludes</span> <span class='hs-varid'>unitIncludeDirs</span>
<a name="line-632"></a>              <span class='hs-varid'>unitHaddockInterfaces</span> <span class='hs-varid'>unitHaddockHTMLs</span>
<a name="line-633"></a>              <span class='hs-varid'>unitExposedModules</span>
<a name="line-634"></a>              <span class='hs-varid'>unitHiddenModules</span>
<a name="line-635"></a>              <span class='hs-varid'>unitIsIndefinite</span> <span class='hs-varid'>unitIsExposed</span> <span class='hs-varid'>unitIsTrusted</span><span class='hs-layout'>)</span>
<a name="line-636"></a>
<a name="line-637"></a><a name="instance%20Binary%20DbModule"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>DbModule</span> <span class='hs-keyword'>where</span>
<a name="line-638"></a>  <span class='hs-varid'>put</span> <span class='hs-layout'>(</span><span class='hs-conid'>DbModule</span> <span class='hs-varid'>dbModuleUnitId</span> <span class='hs-varid'>dbModuleName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-639"></a>    <span class='hs-varid'>putWord8</span> <span class='hs-num'>0</span>
<a name="line-640"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>dbModuleUnitId</span>
<a name="line-641"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>dbModuleName</span>
<a name="line-642"></a>  <span class='hs-varid'>put</span> <span class='hs-layout'>(</span><span class='hs-conid'>DbModuleVar</span> <span class='hs-varid'>dbModuleVarName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-643"></a>    <span class='hs-varid'>putWord8</span> <span class='hs-num'>1</span>
<a name="line-644"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>dbModuleVarName</span>
<a name="line-645"></a>  <span class='hs-varid'>get</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-646"></a>    <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getWord8</span>
<a name="line-647"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>of</span>
<a name="line-648"></a>      <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DbModule</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>get</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>get</span>
<a name="line-649"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DbModuleVar</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>get</span>
<a name="line-650"></a>
<a name="line-651"></a><a name="instance%20Binary%20DbInstUnitId"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>DbInstUnitId</span> <span class='hs-keyword'>where</span>
<a name="line-652"></a>  <span class='hs-varid'>put</span> <span class='hs-layout'>(</span><span class='hs-conid'>DbUnitId</span> <span class='hs-varid'>uid</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-653"></a>    <span class='hs-varid'>putWord8</span> <span class='hs-num'>0</span>
<a name="line-654"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>uid</span>
<a name="line-655"></a>  <span class='hs-varid'>put</span> <span class='hs-layout'>(</span><span class='hs-conid'>DbInstUnitId</span> <span class='hs-varid'>dbUnitIdComponentId</span> <span class='hs-varid'>dbUnitIdInsts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-656"></a>    <span class='hs-varid'>putWord8</span> <span class='hs-num'>1</span>
<a name="line-657"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>dbUnitIdComponentId</span>
<a name="line-658"></a>    <span class='hs-varid'>put</span> <span class='hs-varid'>dbUnitIdInsts</span>
<a name="line-659"></a>
<a name="line-660"></a>  <span class='hs-varid'>get</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-661"></a>    <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getWord8</span>
<a name="line-662"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>of</span>
<a name="line-663"></a>      <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DbUnitId</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>get</span>
<a name="line-664"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DbInstUnitId</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>get</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>get</span>
<a name="line-665"></a>
<a name="line-666"></a>
<a name="line-667"></a><a name="mkMungePathUrl"></a><span class='hs-comment'>-- | Return functions to perform path/URL variable substitution as per the Cabal</span>
<a name="line-668"></a><span class='hs-comment'>-- ${pkgroot} spec</span>
<a name="line-669"></a><span class='hs-comment'>-- (<a href="http://www.haskell.org/pipermail/libraries/2009-May/011772.html)">http://www.haskell.org/pipermail/libraries/2009-May/011772.html)</a></span>
<a name="line-670"></a><span class='hs-comment'>--</span>
<a name="line-671"></a><span class='hs-comment'>-- Paths/URLs can be relative to ${pkgroot} or ${pkgrooturl}.</span>
<a name="line-672"></a><span class='hs-comment'>-- The "pkgroot" is the directory containing the package database.</span>
<a name="line-673"></a><span class='hs-comment'>--</span>
<a name="line-674"></a><span class='hs-comment'>-- Also perform a similar substitution for the older GHC-specific</span>
<a name="line-675"></a><span class='hs-comment'>-- "$topdir" variable. The "topdir" is the location of the ghc</span>
<a name="line-676"></a><span class='hs-comment'>-- installation (obtained from the -B option).</span>
<a name="line-677"></a><span class='hs-definition'>mkMungePathUrl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePathST</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePathST</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FilePathST</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePathST</span><span class='hs-layout'>,</span> <span class='hs-conid'>FilePathST</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePathST</span><span class='hs-layout'>)</span>
<a name="line-678"></a><span class='hs-definition'>mkMungePathUrl</span> <span class='hs-varid'>top_dir</span> <span class='hs-varid'>pkgroot</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>munge_path</span><span class='hs-layout'>,</span> <span class='hs-varid'>munge_url</span><span class='hs-layout'>)</span>
<a name="line-679"></a>   <span class='hs-keyword'>where</span>
<a name="line-680"></a>    <span class='hs-varid'>munge_path</span> <span class='hs-varid'>p</span>
<a name="line-681"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>p'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stripVarPrefix</span> <span class='hs-str'>"${pkgroot}"</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mappend</span> <span class='hs-varid'>pkgroot</span> <span class='hs-varid'>p'</span>
<a name="line-682"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>p'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stripVarPrefix</span> <span class='hs-str'>"$topdir"</span>    <span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mappend</span> <span class='hs-varid'>top_dir</span> <span class='hs-varid'>p'</span>
<a name="line-683"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p</span>
<a name="line-684"></a>
<a name="line-685"></a>    <span class='hs-varid'>munge_url</span> <span class='hs-varid'>p</span>
<a name="line-686"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>p'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stripVarPrefix</span> <span class='hs-str'>"${pkgrooturl}"</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toUrlPath</span> <span class='hs-varid'>pkgroot</span> <span class='hs-varid'>p'</span>
<a name="line-687"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>p'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stripVarPrefix</span> <span class='hs-str'>"$httptopdir"</span>   <span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toUrlPath</span> <span class='hs-varid'>top_dir</span> <span class='hs-varid'>p'</span>
<a name="line-688"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p</span>
<a name="line-689"></a>
<a name="line-690"></a>    <span class='hs-varid'>toUrlPath</span> <span class='hs-varid'>r</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mconcat</span> <span class='hs-varop'>$</span> <span class='hs-str'>"file:///"</span> <span class='hs-conop'>:</span> <span class='hs-layout'>(</span><span class='hs-varid'>intersperse</span> <span class='hs-str'>"/"</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span> <span class='hs-conop'>:</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitDirectories</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-691"></a>                                          <span class='hs-comment'>-- URLs always use posix style '/' separators</span>
<a name="line-692"></a>
<a name="line-693"></a>    <span class='hs-comment'>-- We need to drop a leading "/" or "\\" if there is one:</span>
<a name="line-694"></a>    <span class='hs-varid'>splitDirectories</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePathST</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePathST</span><span class='hs-keyglyph'>]</span>
<a name="line-695"></a>    <span class='hs-varid'>splitDirectories</span> <span class='hs-varid'>p</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-conid'>ST.null</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ST.splitFilePath</span> <span class='hs-varid'>p</span>
<a name="line-696"></a>
<a name="line-697"></a>    <span class='hs-comment'>-- We could drop the separator here, and then use &lt;/&gt; above. However,</span>
<a name="line-698"></a>    <span class='hs-comment'>-- by leaving it in and using ++ we keep the same path separator</span>
<a name="line-699"></a>    <span class='hs-comment'>-- rather than letting FilePath change it to use \ as the separator</span>
<a name="line-700"></a>    <span class='hs-varid'>stripVarPrefix</span> <span class='hs-varid'>var</span> <span class='hs-varid'>path</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>ST.stripPrefix</span> <span class='hs-varid'>var</span> <span class='hs-varid'>path</span> <span class='hs-keyword'>of</span>
<a name="line-701"></a>                              <span class='hs-conid'>Just</span> <span class='hs-str'>""</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-str'>""</span>
<a name="line-702"></a>                              <span class='hs-conid'>Just</span> <span class='hs-varid'>cs</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPathSeparator</span> <span class='hs-layout'>(</span><span class='hs-conid'>ST.head</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cs</span>
<a name="line-703"></a>                              <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-704"></a>
<a name="line-705"></a>
<a name="line-706"></a><a name="mungeUnitInfoPaths"></a><span class='hs-comment'>-- | Perform path/URL variable substitution as per the Cabal ${pkgroot} spec</span>
<a name="line-707"></a><span class='hs-comment'>-- (<a href="http://www.haskell.org/pipermail/libraries/2009-May/011772.html)">http://www.haskell.org/pipermail/libraries/2009-May/011772.html)</a></span>
<a name="line-708"></a><span class='hs-comment'>-- Paths/URLs can be relative to ${pkgroot} or ${pkgrooturl}.</span>
<a name="line-709"></a><span class='hs-comment'>-- The "pkgroot" is the directory containing the package database.</span>
<a name="line-710"></a><span class='hs-comment'>--</span>
<a name="line-711"></a><span class='hs-comment'>-- Also perform a similar substitution for the older GHC-specific</span>
<a name="line-712"></a><span class='hs-comment'>-- "$topdir" variable. The "topdir" is the location of the ghc</span>
<a name="line-713"></a><span class='hs-comment'>-- installation (obtained from the -B option).</span>
<a name="line-714"></a><span class='hs-definition'>mungeUnitInfoPaths</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePathST</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePathST</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GenericUnitInfo</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-varid'>d</span> <span class='hs-varid'>e</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GenericUnitInfo</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-varid'>d</span> <span class='hs-varid'>e</span> <span class='hs-varid'>f</span>
<a name="line-715"></a><span class='hs-definition'>mungeUnitInfoPaths</span> <span class='hs-varid'>top_dir</span> <span class='hs-varid'>pkgroot</span> <span class='hs-varid'>pkg</span> <span class='hs-keyglyph'>=</span>
<a name="line-716"></a>   <span class='hs-comment'>-- TODO: similar code is duplicated in utils/ghc-pkg/Main.hs</span>
<a name="line-717"></a>    <span class='hs-varid'>pkg</span>
<a name="line-718"></a>      <span class='hs-layout'>{</span> <span class='hs-varid'>unitImportDirs</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>munge_paths</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitImportDirs</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span>
<a name="line-719"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>unitIncludeDirs</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>munge_paths</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitIncludeDirs</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span>
<a name="line-720"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>unitLibraryDirs</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>munge_paths</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitLibraryDirs</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span>
<a name="line-721"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>unitLibraryDynDirs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>munge_paths</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitLibraryDynDirs</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span>
<a name="line-722"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>unitExtDepFrameworkDirs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>munge_paths</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitExtDepFrameworkDirs</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span>
<a name="line-723"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>unitHaddockInterfaces</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>munge_paths</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitHaddockInterfaces</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span>
<a name="line-724"></a>        <span class='hs-comment'>-- haddock-html is allowed to be either a URL or a file</span>
<a name="line-725"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>unitHaddockHTMLs</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>munge_paths</span> <span class='hs-layout'>(</span><span class='hs-varid'>munge_urls</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitHaddockHTMLs</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-726"></a>      <span class='hs-layout'>}</span>
<a name="line-727"></a>   <span class='hs-keyword'>where</span>
<a name="line-728"></a>      <span class='hs-varid'>munge_paths</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>munge_path</span>
<a name="line-729"></a>      <span class='hs-varid'>munge_urls</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>munge_url</span>
<a name="line-730"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>munge_path</span><span class='hs-layout'>,</span><span class='hs-varid'>munge_url</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkMungePathUrl</span> <span class='hs-varid'>top_dir</span> <span class='hs-varid'>pkgroot</span>
</pre></body>
</html>
