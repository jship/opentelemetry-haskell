<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | This module documents tools and utilities for running SQL migrations.</span><span>
</span><span id="line-2"></span><span class="hs-comment">--</span><span>
</span><span id="line-3"></span><span class="hs-comment">-- A 'Migration' is (currently) an alias for a 'WriterT' of</span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Database.Persist.Sql.Migration</span><span>
</span><span id="line-5"></span><span>  </span><span class="hs-special">(</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Types</span></span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Migration"><span class="hs-identifier">Migration</span></a></span><span>
</span><span id="line-8"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#CautiousMigration"><span class="hs-identifier">CautiousMigration</span></a></span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Sql"><span class="hs-identifier">Sql</span></a></span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Using a 'Migration'</span></span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#showMigration"><span class="hs-identifier">showMigration</span></a></span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#parseMigration"><span class="hs-identifier">parseMigration</span></a></span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#parseMigration%27"><span class="hs-identifier">parseMigration'</span></a></span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#printMigration"><span class="hs-identifier">printMigration</span></a></span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#getMigration"><span class="hs-identifier">getMigration</span></a></span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#runMigration"><span class="hs-identifier">runMigration</span></a></span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#runMigrationQuiet"><span class="hs-identifier">runMigrationQuiet</span></a></span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#runMigrationSilent"><span class="hs-identifier">runMigrationSilent</span></a></span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#runMigrationUnsafe"><span class="hs-identifier">runMigrationUnsafe</span></a></span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#runMigrationUnsafeQuiet"><span class="hs-identifier">runMigrationUnsafeQuiet</span></a></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#migrate"><span class="hs-identifier">migrate</span></a></span><span>
</span><span id="line-22"></span><span>  </span><span class="annot"><span class="hs-comment">-- * Utilities for constructing migrations</span></span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-comment">-- | While 'migrate' is capable of creating a 'Migration' for you, it's not</span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-comment">-- the only way you can write migrations. You can use these utilities to write</span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-comment">-- extra steps in your migrations.</span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-comment">-- As an example, let's say we want to enable the @citext@ extension on</span><span>
</span><span id="line-28"></span><span>  </span><span class="hs-comment">-- @postgres@ as part of our migrations.</span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-comment">-- @</span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-comment">-- 'Database.Persist.TH.share' ['Database.Persist.TH.mkPersist' sqlSettings, 'Database.Persist.TH.mkMigration' &quot;migrateAll&quot;] ...</span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-comment">-- migration :: 'Migration'</span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-comment">-- migration = do</span><span>
</span><span id="line-35"></span><span>  </span><span class="hs-comment">--     'runSqlCommand' $</span><span>
</span><span id="line-36"></span><span>  </span><span class="hs-comment">--         'rawExecute_' &quot;CREATE EXTENSION IF NOT EXISTS \&quot;citext\&quot;;&quot;</span><span>
</span><span id="line-37"></span><span>  </span><span class="hs-comment">--     migrateAll</span><span>
</span><span id="line-38"></span><span>  </span><span class="hs-comment">-- @</span><span>
</span><span id="line-39"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-40"></span><span>  </span><span class="hs-comment">-- For raw commands, you can also just write 'addMigration':</span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-comment">-- @</span><span>
</span><span id="line-43"></span><span>  </span><span class="hs-comment">-- migration :: 'Migration'</span><span>
</span><span id="line-44"></span><span>  </span><span class="hs-comment">-- migration = do</span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-comment">--     'addMigration' &quot;CREATE EXTENSION IF NOT EXISTS \&quot;citext\&quot;;&quot;</span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-comment">--     migrateAll</span><span>
</span><span id="line-47"></span><span>  </span><span class="hs-comment">-- @</span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#reportErrors"><span class="hs-identifier">reportErrors</span></a></span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#reportError"><span class="hs-identifier">reportError</span></a></span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#addMigrations"><span class="hs-identifier">addMigrations</span></a></span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#addMigration"><span class="hs-identifier">addMigration</span></a></span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#runSqlCommand"><span class="hs-identifier">runSqlCommand</span></a></span><span>
</span><span id="line-53"></span><span>  </span><span class="annot"><span class="hs-comment">-- * If something goes wrong...</span></span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#PersistUnsafeMigrationException"><span class="hs-identifier">PersistUnsafeMigrationException</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">throwIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">liftM</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unless</span></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.IO.Unlift</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadTrans</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Reader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ReaderT</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ask</span></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Writer</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Text</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">isPrefixOf</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">pack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">snoc</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unpack</span></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.IO</span></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Stack</span></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.IO</span></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.IO.Silently</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">hSilence</span></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Orphan.PersistStore.html"><span class="hs-identifier">Database.Persist.Sql.Orphan.PersistStore</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Raw.html"><span class="hs-identifier">Database.Persist.Sql.Raw</span></a></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Types.html"><span class="hs-identifier">Database.Persist.Sql.Types</span></a></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Types.Internal.html"><span class="hs-identifier">Database.Persist.Sql.Types.Internal</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Database.Persist.Types.html"><span class="hs-identifier">Database.Persist.Types</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Exception</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="hs-keyword">type</span><span> </span><span id="Sql"><span class="annot"><a href="Database.Persist.Sql.Migration.html#Sql"><span class="hs-identifier hs-var">Sql</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span class="hs-comment">-- | A list of SQL operations, marked with a safety flag. If the 'Bool' is</span><span>
</span><span id="line-80"></span><span class="hs-comment">-- 'True', then the operation is *unsafe* - it might be destructive, or</span><span>
</span><span id="line-81"></span><span class="hs-comment">-- otherwise not idempotent. If the 'Bool' is 'False', then the operation</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- is *safe*, and can be run repeatedly without issues.</span><span>
</span><span id="line-83"></span><span class="hs-keyword">type</span><span> </span><span id="CautiousMigration"><span class="annot"><a href="Database.Persist.Sql.Migration.html#CautiousMigration"><span class="hs-identifier hs-var">CautiousMigration</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Sql"><span class="hs-identifier hs-type">Sql</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span class="hs-comment">-- | A 'Migration' is a four level monad stack consisting of:</span><span>
</span><span id="line-86"></span><span class="hs-comment">--</span><span>
</span><span id="line-87"></span><span class="hs-comment">-- * @'WriterT' ['Text']@ representing a log of errors in the migrations.</span><span>
</span><span id="line-88"></span><span class="hs-comment">-- * @'WriterT' 'CautiousMigration'@ representing a list of migrations to</span><span>
</span><span id="line-89"></span><span class="hs-comment">--   run, along with whether or not they are safe.</span><span>
</span><span id="line-90"></span><span class="hs-comment">-- * @'ReaderT' 'SqlBackend'@, aka the 'SqlPersistT' transformer for</span><span>
</span><span id="line-91"></span><span class="hs-comment">--   database interop.</span><span>
</span><span id="line-92"></span><span class="hs-comment">-- * @'IO'@ for arbitrary IO.</span><span>
</span><span id="line-93"></span><span class="hs-keyword">type</span><span> </span><span id="Migration"><span class="annot"><a href="Database.Persist.Sql.Migration.html#Migration"><span class="hs-identifier hs-var">Migration</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WriterT</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WriterT</span></span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#CautiousMigration"><span class="hs-identifier hs-type">CautiousMigration</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Database.Persist.SqlBackend.Internal.html#SqlBackend"><span class="hs-identifier hs-type">SqlBackend</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span class="annot"><a href="Database.Persist.Sql.Migration.html#allSql"><span class="hs-identifier hs-type">allSql</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#CautiousMigration"><span class="hs-identifier hs-type">CautiousMigration</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Sql"><span class="hs-identifier hs-type">Sql</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-96"></span><span id="allSql"><span class="annot"><span class="annottext">allSql :: CautiousMigration -&gt; [Text]
</span><a href="Database.Persist.Sql.Migration.html#allSql"><span class="hs-identifier hs-var hs-var">allSql</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span class="annot"><a href="Database.Persist.Sql.Migration.html#safeSql"><span class="hs-identifier hs-type">safeSql</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#CautiousMigration"><span class="hs-identifier hs-type">CautiousMigration</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Sql"><span class="hs-identifier hs-type">Sql</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-99"></span><span id="safeSql"><span class="annot"><span class="annottext">safeSql :: CautiousMigration -&gt; [Text]
</span><a href="Database.Persist.Sql.Migration.html#safeSql"><span class="hs-identifier hs-var hs-var">safeSql</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CautiousMigration -&gt; [Text]
</span><a href="Database.Persist.Sql.Migration.html#allSql"><span class="hs-identifier hs-var">allSql</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span class="hs-comment">-- | Given a 'Migration', this parses it and returns either a list of</span><span>
</span><span id="line-102"></span><span class="hs-comment">-- errors associated with the migration or a list of migrations to do.</span><span>
</span><span id="line-103"></span><span id="local-6989586621679961842"><span class="annot"><a href="Database.Persist.Sql.Migration.html#parseMigration"><span class="hs-identifier hs-type">parseMigration</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679961842"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Migration"><span class="hs-identifier hs-type">Migration</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Database.Persist.SqlBackend.Internal.html#SqlBackend"><span class="hs-identifier hs-type">SqlBackend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679961842"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#CautiousMigration"><span class="hs-identifier hs-type">CautiousMigration</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-104"></span><span id="parseMigration"><span class="annot"><span class="annottext">parseMigration :: forall (m :: * -&gt; *).
(HasCallStack, MonadIO m) =&gt;
Migration -&gt; ReaderT SqlBackend m (Either [Text] CautiousMigration)
</span><a href="Database.Persist.Sql.Migration.html#parseMigration"><span class="hs-identifier hs-var hs-var">parseMigration</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {r} {a}.
MonadIO m =&gt;
ReaderT r IO a -&gt; ReaderT r m a
</span><a href="#local-6989586621679961652"><span class="hs-identifier hs-var">liftIOReader</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a1 r. Monad m =&gt; (a1 -&gt; r) -&gt; m a1 -&gt; m r
</span><span class="hs-identifier hs-var">liftM</span></span><span> </span><span class="annot"><span class="annottext">forall {a} {b}. ([a], b) -&gt; Either [a] b
</span><a href="#local-6989586621679961651"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall w (m :: * -&gt; *) a. WriterT w m a -&gt; m (a, w)
</span><span class="hs-identifier hs-var">runWriterT</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) w a. Monad m =&gt; WriterT w m a -&gt; m w
</span><span class="hs-identifier hs-var">execWriterT</span></span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-107"></span><span>    </span><span id="local-6989586621679961651"><span class="annot"><span class="annottext">go :: ([a], b) -&gt; Either [a] b
</span><a href="#local-6989586621679961651"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679961648"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679961648"><span class="hs-identifier hs-var">sql</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679961648"><span class="hs-identifier hs-var">sql</span></a></span><span>
</span><span id="line-108"></span><span>    </span><span class="annot"><a href="#local-6989586621679961651"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679961647"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679961647"><span class="hs-identifier hs-var">errs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679961647"><span class="hs-identifier hs-var">errs</span></a></span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span>    </span><span id="local-6989586621679961652"><span class="annot"><span class="annottext">liftIOReader :: ReaderT r IO a -&gt; ReaderT r m a
</span><a href="#local-6989586621679961652"><span class="hs-identifier hs-var hs-var">liftIOReader</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span id="local-6989586621679961643"><span class="annot"><span class="annottext">r -&gt; IO a
</span><a href="#local-6989586621679961643"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall r (m :: * -&gt; *) a. (r -&gt; m a) -&gt; ReaderT r m a
</span><span class="hs-identifier hs-var">ReaderT</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">r -&gt; IO a
</span><a href="#local-6989586621679961643"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span class="hs-comment">-- | Like 'parseMigration', but instead of returning the value in an</span><span>
</span><span id="line-113"></span><span class="hs-comment">-- 'Either' value, it calls 'error' on the error values.</span><span>
</span><span id="line-114"></span><span id="local-6989586621679961815"><span class="annot"><a href="Database.Persist.Sql.Migration.html#parseMigration%27"><span class="hs-identifier hs-type">parseMigration'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679961815"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Migration"><span class="hs-identifier hs-type">Migration</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Database.Persist.SqlBackend.Internal.html#SqlBackend"><span class="hs-identifier hs-type">SqlBackend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679961815"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#CautiousMigration"><span class="hs-identifier hs-type">CautiousMigration</span></a></span></span><span>
</span><span id="line-115"></span><span id="parseMigration%27"><span class="annot"><span class="annottext">parseMigration' :: forall (m :: * -&gt; *).
(HasCallStack, MonadIO m) =&gt;
Migration -&gt; ReaderT SqlBackend m CautiousMigration
</span><a href="Database.Persist.Sql.Migration.html#parseMigration%27"><span class="hs-identifier hs-var hs-var">parseMigration'</span></a></span></span><span> </span><span id="local-6989586621679961630"><span class="annot"><span class="annottext">Migration
</span><a href="#local-6989586621679961630"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-116"></span><span>  </span><span id="local-6989586621679961629"><span class="annot"><span class="annottext">Either [Text] CautiousMigration
</span><a href="#local-6989586621679961629"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(HasCallStack, MonadIO m) =&gt;
Migration -&gt; ReaderT SqlBackend m (Either [Text] CautiousMigration)
</span><a href="Database.Persist.Sql.Migration.html#parseMigration"><span class="hs-identifier hs-var">parseMigration</span></a></span><span> </span><span class="annot"><span class="annottext">Migration
</span><a href="#local-6989586621679961630"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-117"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either [Text] CautiousMigration
</span><a href="#local-6989586621679961629"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-118"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679961628"><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621679961628"><span class="hs-identifier hs-var">errs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[[Char]] -&gt; [Char]
</span><span class="hs-identifier hs-var">unlines</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; [Char]
</span><span class="hs-identifier hs-var">unpack</span></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621679961628"><span class="hs-identifier hs-var">errs</span></a></span><span>
</span><span id="line-119"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679961625"><span class="annot"><span class="annottext">CautiousMigration
</span><a href="#local-6989586621679961625"><span class="hs-identifier hs-var">sql</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">CautiousMigration
</span><a href="#local-6989586621679961625"><span class="hs-identifier hs-var">sql</span></a></span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="hs-comment">-- | Prints a migration.</span><span>
</span><span id="line-122"></span><span id="local-6989586621679961809"><span class="annot"><a href="Database.Persist.Sql.Migration.html#printMigration"><span class="hs-identifier hs-type">printMigration</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679961809"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Migration"><span class="hs-identifier hs-type">Migration</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Database.Persist.SqlBackend.Internal.html#SqlBackend"><span class="hs-identifier hs-type">SqlBackend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679961809"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-123"></span><span id="printMigration"><span class="annot"><span class="annottext">printMigration :: forall (m :: * -&gt; *).
(HasCallStack, MonadIO m) =&gt;
Migration -&gt; ReaderT SqlBackend m ()
</span><a href="Database.Persist.Sql.Migration.html#printMigration"><span class="hs-identifier hs-var hs-var">printMigration</span></a></span></span><span> </span><span id="local-6989586621679961613"><span class="annot"><span class="annottext">Migration
</span><a href="#local-6989586621679961613"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(HasCallStack, MonadIO m) =&gt;
Migration -&gt; ReaderT SqlBackend m [Text]
</span><a href="Database.Persist.Sql.Migration.html#showMigration"><span class="hs-identifier hs-var">showMigration</span></a></span><span> </span><span class="annot"><span class="annottext">Migration
</span><a href="#local-6989586621679961613"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-124"></span><span>               </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; IO ()
</span><span class="hs-identifier hs-var">Data.Text.IO.putStrLn</span></span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span class="hs-comment">-- | Convert a 'Migration' to a list of 'Text' values corresponding to their</span><span>
</span><span id="line-127"></span><span class="hs-comment">-- 'Sql' statements.</span><span>
</span><span id="line-128"></span><span id="local-6989586621679961807"><span class="annot"><a href="Database.Persist.Sql.Migration.html#showMigration"><span class="hs-identifier hs-type">showMigration</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679961807"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Migration"><span class="hs-identifier hs-type">Migration</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Database.Persist.SqlBackend.Internal.html#SqlBackend"><span class="hs-identifier hs-type">SqlBackend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679961807"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-129"></span><span id="showMigration"><span class="annot"><span class="annottext">showMigration :: forall (m :: * -&gt; *).
(HasCallStack, MonadIO m) =&gt;
Migration -&gt; ReaderT SqlBackend m [Text]
</span><a href="Database.Persist.Sql.Migration.html#showMigration"><span class="hs-identifier hs-var hs-var">showMigration</span></a></span></span><span> </span><span id="local-6989586621679961603"><span class="annot"><span class="annottext">Migration
</span><a href="#local-6989586621679961603"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Char -&gt; Text
</span><span class="hs-identifier hs-var">snoc</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">';'</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a1 r. Monad m =&gt; (a1 -&gt; r) -&gt; m a1 -&gt; m r
</span><span class="hs-operator hs-var">`liftM`</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(MonadIO m, HasCallStack) =&gt;
Migration -&gt; ReaderT SqlBackend m [Text]
</span><a href="Database.Persist.Sql.Migration.html#getMigration"><span class="hs-identifier hs-var">getMigration</span></a></span><span> </span><span class="annot"><span class="annottext">Migration
</span><a href="#local-6989586621679961603"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span class="hs-comment">-- | Return all of the 'Sql' values associated with the given migration.</span><span>
</span><span id="line-132"></span><span class="hs-comment">-- Calls 'error' if there's a parse error on any migration.</span><span>
</span><span id="line-133"></span><span id="local-6989586621679961796"><span class="annot"><a href="Database.Persist.Sql.Migration.html#getMigration"><span class="hs-identifier hs-type">getMigration</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679961796"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Migration"><span class="hs-identifier hs-type">Migration</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Database.Persist.SqlBackend.Internal.html#SqlBackend"><span class="hs-identifier hs-type">SqlBackend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679961796"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Sql"><span class="hs-identifier hs-type">Sql</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-134"></span><span id="getMigration"><span class="annot"><span class="annottext">getMigration :: forall (m :: * -&gt; *).
(MonadIO m, HasCallStack) =&gt;
Migration -&gt; ReaderT SqlBackend m [Text]
</span><a href="Database.Persist.Sql.Migration.html#getMigration"><span class="hs-identifier hs-var hs-var">getMigration</span></a></span></span><span> </span><span id="local-6989586621679961593"><span class="annot"><span class="annottext">Migration
</span><a href="#local-6989586621679961593"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-135"></span><span>  </span><span id="local-6989586621679961592"><span class="annot"><span class="annottext">CautiousMigration
</span><a href="#local-6989586621679961592"><span class="hs-identifier hs-var">mig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(HasCallStack, MonadIO m) =&gt;
Migration -&gt; ReaderT SqlBackend m CautiousMigration
</span><a href="Database.Persist.Sql.Migration.html#parseMigration%27"><span class="hs-identifier hs-var">parseMigration'</span></a></span><span> </span><span class="annot"><span class="annottext">Migration
</span><a href="#local-6989586621679961593"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-136"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CautiousMigration -&gt; [Text]
</span><a href="Database.Persist.Sql.Migration.html#allSql"><span class="hs-identifier hs-var">allSql</span></a></span><span> </span><span class="annot"><span class="annottext">CautiousMigration
</span><a href="#local-6989586621679961592"><span class="hs-identifier hs-var">mig</span></a></span><span>
</span><span id="line-137"></span><span>
</span><span id="line-138"></span><span class="hs-comment">-- | Runs a migration. If the migration fails to parse or if any of the</span><span>
</span><span id="line-139"></span><span class="hs-comment">-- migrations are unsafe, then this throws a 'PersistUnsafeMigrationException'.</span><span>
</span><span id="line-140"></span><span id="local-6989586621679961794"><span class="annot"><a href="Database.Persist.Sql.Migration.html#runMigration"><span class="hs-identifier hs-type">runMigration</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679961794"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-141"></span><span>             </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Migration"><span class="hs-identifier hs-type">Migration</span></a></span><span>
</span><span id="line-142"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Database.Persist.SqlBackend.Internal.html#SqlBackend"><span class="hs-identifier hs-type">SqlBackend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679961794"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-143"></span><span id="runMigration"><span class="annot"><span class="annottext">runMigration :: forall (m :: * -&gt; *).
MonadIO m =&gt;
Migration -&gt; ReaderT SqlBackend m ()
</span><a href="Database.Persist.Sql.Migration.html#runMigration"><span class="hs-identifier hs-var hs-var">runMigration</span></a></span></span><span> </span><span id="local-6989586621679961584"><span class="annot"><span class="annottext">Migration
</span><a href="#local-6989586621679961584"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(HasCallStack, MonadIO m) =&gt;
Migration -&gt; Bool -&gt; ReaderT SqlBackend m [Text]
</span><a href="Database.Persist.Sql.Migration.html#runMigration%27"><span class="hs-identifier hs-var">runMigration'</span></a></span><span> </span><span class="annot"><span class="annottext">Migration
</span><a href="#local-6989586621679961584"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span class="hs-comment">-- | Same as 'runMigration', but does not report the individual migrations on</span><span>
</span><span id="line-146"></span><span class="hs-comment">-- stderr. Instead it returns a list of the executed SQL commands.</span><span>
</span><span id="line-147"></span><span class="hs-comment">--</span><span>
</span><span id="line-148"></span><span class="hs-comment">-- This is a safer/more robust alternative to 'runMigrationSilent', but may be</span><span>
</span><span id="line-149"></span><span class="hs-comment">-- less silent for some persistent implementations, most notably</span><span>
</span><span id="line-150"></span><span class="hs-comment">-- persistent-postgresql</span><span>
</span><span id="line-151"></span><span class="hs-comment">--</span><span>
</span><span id="line-152"></span><span class="hs-comment">-- @since 2.10.2</span><span>
</span><span id="line-153"></span><span id="local-6989586621679961789"><span class="annot"><a href="Database.Persist.Sql.Migration.html#runMigrationQuiet"><span class="hs-identifier hs-type">runMigrationQuiet</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679961789"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-154"></span><span>                  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Migration"><span class="hs-identifier hs-type">Migration</span></a></span><span>
</span><span id="line-155"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Database.Persist.SqlBackend.Internal.html#SqlBackend"><span class="hs-identifier hs-type">SqlBackend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679961789"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-156"></span><span id="runMigrationQuiet"><span class="annot"><span class="annottext">runMigrationQuiet :: forall (m :: * -&gt; *).
MonadIO m =&gt;
Migration -&gt; ReaderT SqlBackend m [Text]
</span><a href="Database.Persist.Sql.Migration.html#runMigrationQuiet"><span class="hs-identifier hs-var hs-var">runMigrationQuiet</span></a></span></span><span> </span><span id="local-6989586621679961578"><span class="annot"><span class="annottext">Migration
</span><a href="#local-6989586621679961578"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(HasCallStack, MonadIO m) =&gt;
Migration -&gt; Bool -&gt; ReaderT SqlBackend m [Text]
</span><a href="Database.Persist.Sql.Migration.html#runMigration%27"><span class="hs-identifier hs-var">runMigration'</span></a></span><span> </span><span class="annot"><span class="annottext">Migration
</span><a href="#local-6989586621679961578"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-157"></span><span>
</span><span id="line-158"></span><span class="hs-comment">-- | Same as 'runMigration', but returns a list of the SQL commands executed</span><span>
</span><span id="line-159"></span><span class="hs-comment">-- instead of printing them to stderr.</span><span>
</span><span id="line-160"></span><span class="hs-comment">--</span><span>
</span><span id="line-161"></span><span class="hs-comment">-- This function silences the migration by remapping 'stderr'. As a result, it</span><span>
</span><span id="line-162"></span><span class="hs-comment">-- is not thread-safe and can clobber output from other parts of the program.</span><span>
</span><span id="line-163"></span><span class="hs-comment">-- This implementation method was chosen to also silence postgresql migration</span><span>
</span><span id="line-164"></span><span class="hs-comment">-- output on stderr, but is not recommended!</span><span>
</span><span id="line-165"></span><span id="local-6989586621679961787"><span class="annot"><a href="Database.Persist.Sql.Migration.html#runMigrationSilent"><span class="hs-identifier hs-type">runMigrationSilent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadUnliftIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679961787"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-166"></span><span>                   </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Migration"><span class="hs-identifier hs-type">Migration</span></a></span><span>
</span><span id="line-167"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Database.Persist.SqlBackend.Internal.html#SqlBackend"><span class="hs-identifier hs-type">SqlBackend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679961787"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-168"></span><span id="runMigrationSilent"><span class="annot"><span class="annottext">runMigrationSilent :: forall (m :: * -&gt; *).
MonadUnliftIO m =&gt;
Migration -&gt; ReaderT SqlBackend m [Text]
</span><a href="Database.Persist.Sql.Migration.html#runMigrationSilent"><span class="hs-identifier hs-var hs-var">runMigrationSilent</span></a></span></span><span> </span><span id="local-6989586621679961569"><span class="annot"><span class="annottext">Migration
</span><a href="#local-6989586621679961569"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b.
MonadUnliftIO m =&gt;
((forall a. m a -&gt; IO a) -&gt; IO b) -&gt; m b
</span><span class="hs-identifier hs-var">withRunInIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679961567"><span class="annot"><span class="annottext">forall a. ReaderT SqlBackend m a -&gt; IO a
</span><a href="#local-6989586621679961567"><span class="hs-identifier hs-var">run</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-169"></span><span>  </span><span class="annot"><span class="annottext">forall a. [Handle] -&gt; IO a -&gt; IO a
</span><span class="hs-identifier hs-var">hSilence</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Handle
</span><span class="hs-identifier hs-var">stderr</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. ReaderT SqlBackend m a -&gt; IO a
</span><a href="#local-6989586621679961567"><span class="hs-identifier hs-var">run</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(HasCallStack, MonadIO m) =&gt;
Migration -&gt; Bool -&gt; ReaderT SqlBackend m [Text]
</span><a href="Database.Persist.Sql.Migration.html#runMigration%27"><span class="hs-identifier hs-var">runMigration'</span></a></span><span> </span><span class="annot"><span class="annottext">Migration
</span><a href="#local-6989586621679961569"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span class="hs-comment">-- | Run the given migration against the database. If the migration fails</span><span>
</span><span id="line-172"></span><span class="hs-comment">-- to parse, or there are any unsafe migrations, then this will error at</span><span>
</span><span id="line-173"></span><span class="hs-comment">-- runtime. This returns a list of the migrations that were executed.</span><span>
</span><span id="line-174"></span><span id="local-6989586621679961792"><span class="annot"><a href="Database.Persist.Sql.Migration.html#runMigration%27"><span class="hs-identifier hs-type">runMigration'</span></a></span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679961792"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Migration"><span class="hs-identifier hs-type">Migration</span></a></span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-comment">-- ^ is silent?</span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Database.Persist.SqlBackend.Internal.html#SqlBackend"><span class="hs-identifier hs-type">SqlBackend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679961792"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-179"></span><span id="runMigration%27"><span class="annot"><span class="annottext">runMigration' :: forall (m :: * -&gt; *).
(HasCallStack, MonadIO m) =&gt;
Migration -&gt; Bool -&gt; ReaderT SqlBackend m [Text]
</span><a href="Database.Persist.Sql.Migration.html#runMigration%27"><span class="hs-identifier hs-var hs-var">runMigration'</span></a></span></span><span> </span><span id="local-6989586621679961551"><span class="annot"><span class="annottext">Migration
</span><a href="#local-6989586621679961551"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621679961550"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679961550"><span class="hs-identifier hs-var">silent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-180"></span><span>    </span><span id="local-6989586621679961549"><span class="annot"><span class="annottext">CautiousMigration
</span><a href="#local-6989586621679961549"><span class="hs-identifier hs-var">mig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(HasCallStack, MonadIO m) =&gt;
Migration -&gt; ReaderT SqlBackend m CautiousMigration
</span><a href="Database.Persist.Sql.Migration.html#parseMigration%27"><span class="hs-identifier hs-var">parseMigration'</span></a></span><span> </span><span class="annot"><span class="annottext">Migration
</span><a href="#local-6989586621679961551"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-181"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">CautiousMigration
</span><a href="#local-6989586621679961549"><span class="hs-identifier hs-var">mig</span></a></span><span>
</span><span id="line-182"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CautiousMigration -&gt; PersistUnsafeMigrationException
</span><a href="Database.Persist.Sql.Migration.html#PersistUnsafeMigrationException"><span class="hs-identifier hs-var">PersistUnsafeMigrationException</span></a></span><span> </span><span class="annot"><span class="annottext">CautiousMigration
</span><a href="#local-6989586621679961549"><span class="hs-identifier hs-var">mig</span></a></span><span>
</span><span id="line-183"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
Bool -&gt; Text -&gt; ReaderT SqlBackend m Text
</span><a href="Database.Persist.Sql.Migration.html#executeMigrate"><span class="hs-identifier hs-var">executeMigrate</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679961550"><span class="hs-identifier hs-var">silent</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; [Text]
</span><a href="Database.Persist.Sql.Migration.html#sortMigrations"><span class="hs-identifier hs-var">sortMigrations</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CautiousMigration -&gt; [Text]
</span><a href="Database.Persist.Sql.Migration.html#safeSql"><span class="hs-identifier hs-var">safeSql</span></a></span><span> </span><span class="annot"><span class="annottext">CautiousMigration
</span><a href="#local-6989586621679961549"><span class="hs-identifier hs-var">mig</span></a></span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span class="hs-comment">-- | Like 'runMigration', but this will perform the unsafe database</span><span>
</span><span id="line-186"></span><span class="hs-comment">-- migrations instead of erroring out.</span><span>
</span><span id="line-187"></span><span id="local-6989586621679961543"><span class="annot"><a href="Database.Persist.Sql.Migration.html#runMigrationUnsafe"><span class="hs-identifier hs-type">runMigrationUnsafe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679961543"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-188"></span><span>                   </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Migration"><span class="hs-identifier hs-type">Migration</span></a></span><span>
</span><span id="line-189"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Database.Persist.SqlBackend.Internal.html#SqlBackend"><span class="hs-identifier hs-type">SqlBackend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679961543"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-190"></span><span id="runMigrationUnsafe"><span class="annot"><span class="annottext">runMigrationUnsafe :: forall (m :: * -&gt; *).
MonadIO m =&gt;
Migration -&gt; ReaderT SqlBackend m ()
</span><a href="Database.Persist.Sql.Migration.html#runMigrationUnsafe"><span class="hs-identifier hs-var hs-var">runMigrationUnsafe</span></a></span></span><span> </span><span id="local-6989586621679961535"><span class="annot"><span class="annottext">Migration
</span><a href="#local-6989586621679961535"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(HasCallStack, MonadIO m) =&gt;
Bool -&gt; Migration -&gt; ReaderT SqlBackend m [Text]
</span><a href="Database.Persist.Sql.Migration.html#runMigrationUnsafe%27"><span class="hs-identifier hs-var">runMigrationUnsafe'</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Migration
</span><a href="#local-6989586621679961535"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>
</span><span id="line-192"></span><span class="hs-comment">-- | Same as 'runMigrationUnsafe', but returns a list of the SQL commands</span><span>
</span><span id="line-193"></span><span class="hs-comment">-- executed instead of printing them to stderr.</span><span>
</span><span id="line-194"></span><span class="hs-comment">--</span><span>
</span><span id="line-195"></span><span class="hs-comment">-- @since 2.10.2</span><span>
</span><span id="line-196"></span><span id="local-6989586621679961533"><span class="annot"><a href="Database.Persist.Sql.Migration.html#runMigrationUnsafeQuiet"><span class="hs-identifier hs-type">runMigrationUnsafeQuiet</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679961533"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-197"></span><span>                        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Migration"><span class="hs-identifier hs-type">Migration</span></a></span><span>
</span><span id="line-198"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Database.Persist.SqlBackend.Internal.html#SqlBackend"><span class="hs-identifier hs-type">SqlBackend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679961533"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-199"></span><span id="runMigrationUnsafeQuiet"><span class="annot"><span class="annottext">runMigrationUnsafeQuiet :: forall (m :: * -&gt; *).
(HasCallStack, MonadIO m) =&gt;
Migration -&gt; ReaderT SqlBackend m [Text]
</span><a href="Database.Persist.Sql.Migration.html#runMigrationUnsafeQuiet"><span class="hs-identifier hs-var hs-var">runMigrationUnsafeQuiet</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(HasCallStack, MonadIO m) =&gt;
Bool -&gt; Migration -&gt; ReaderT SqlBackend m [Text]
</span><a href="Database.Persist.Sql.Migration.html#runMigrationUnsafe%27"><span class="hs-identifier hs-var">runMigrationUnsafe'</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span id="local-6989586621679961766"><span class="annot"><a href="Database.Persist.Sql.Migration.html#runMigrationUnsafe%27"><span class="hs-identifier hs-type">runMigrationUnsafe'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679961766"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>                    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-203"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Migration"><span class="hs-identifier hs-type">Migration</span></a></span><span>
</span><span id="line-204"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Database.Persist.SqlBackend.Internal.html#SqlBackend"><span class="hs-identifier hs-type">SqlBackend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679961766"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-205"></span><span id="runMigrationUnsafe%27"><span class="annot"><span class="annottext">runMigrationUnsafe' :: forall (m :: * -&gt; *).
(HasCallStack, MonadIO m) =&gt;
Bool -&gt; Migration -&gt; ReaderT SqlBackend m [Text]
</span><a href="Database.Persist.Sql.Migration.html#runMigrationUnsafe%27"><span class="hs-identifier hs-var hs-var">runMigrationUnsafe'</span></a></span></span><span> </span><span id="local-6989586621679961517"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679961517"><span class="hs-identifier hs-var">silent</span></a></span></span><span> </span><span id="local-6989586621679961516"><span class="annot"><span class="annottext">Migration
</span><a href="#local-6989586621679961516"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-206"></span><span>    </span><span id="local-6989586621679961515"><span class="annot"><span class="annottext">CautiousMigration
</span><a href="#local-6989586621679961515"><span class="hs-identifier hs-var">mig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(HasCallStack, MonadIO m) =&gt;
Migration -&gt; ReaderT SqlBackend m CautiousMigration
</span><a href="Database.Persist.Sql.Migration.html#parseMigration%27"><span class="hs-identifier hs-var">parseMigration'</span></a></span><span> </span><span class="annot"><span class="annottext">Migration
</span><a href="#local-6989586621679961516"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-207"></span><span>    </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
Bool -&gt; Text -&gt; ReaderT SqlBackend m Text
</span><a href="Database.Persist.Sql.Migration.html#executeMigrate"><span class="hs-identifier hs-var">executeMigrate</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679961517"><span class="hs-identifier hs-var">silent</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; [Text]
</span><a href="Database.Persist.Sql.Migration.html#sortMigrations"><span class="hs-identifier hs-var">sortMigrations</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CautiousMigration -&gt; [Text]
</span><a href="Database.Persist.Sql.Migration.html#allSql"><span class="hs-identifier hs-var">allSql</span></a></span><span> </span><span class="annot"><span class="annottext">CautiousMigration
</span><a href="#local-6989586621679961515"><span class="hs-identifier hs-var">mig</span></a></span><span>
</span><span id="line-208"></span><span>
</span><span id="line-209"></span><span id="local-6989586621679961768"><span class="annot"><a href="Database.Persist.Sql.Migration.html#executeMigrate"><span class="hs-identifier hs-type">executeMigrate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679961768"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Database.Persist.SqlBackend.Internal.html#SqlBackend"><span class="hs-identifier hs-type">SqlBackend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679961768"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span></span><span>
</span><span id="line-210"></span><span id="executeMigrate"><span class="annot"><span class="annottext">executeMigrate :: forall (m :: * -&gt; *).
MonadIO m =&gt;
Bool -&gt; Text -&gt; ReaderT SqlBackend m Text
</span><a href="Database.Persist.Sql.Migration.html#executeMigrate"><span class="hs-identifier hs-var hs-var">executeMigrate</span></a></span></span><span> </span><span id="local-6989586621679961498"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679961498"><span class="hs-identifier hs-var">silent</span></a></span></span><span> </span><span id="local-6989586621679961497"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679961497"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-211"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679961498"><span class="hs-identifier hs-var">silent</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Handle -&gt; [Char] -&gt; IO ()
</span><span class="hs-identifier hs-var">hPutStrLn</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><span class="hs-identifier hs-var">stderr</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Migrating: &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; [Char]
</span><span class="hs-identifier hs-var">unpack</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679961497"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-212"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) backend.
(MonadIO m, BackendCompatible SqlBackend backend) =&gt;
Text -&gt; [PersistValue] -&gt; ReaderT backend m ()
</span><a href="Database.Persist.Sql.Raw.html#rawExecute"><span class="hs-identifier hs-var">rawExecute</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679961497"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-213"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679961497"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span class="hs-comment">-- | Sort the alter DB statements so tables are created before constraints are</span><span>
</span><span id="line-216"></span><span class="hs-comment">-- added.</span><span>
</span><span id="line-217"></span><span class="annot"><a href="Database.Persist.Sql.Migration.html#sortMigrations"><span class="hs-identifier hs-type">sortMigrations</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Sql"><span class="hs-identifier hs-type">Sql</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Sql"><span class="hs-identifier hs-type">Sql</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-218"></span><span id="sortMigrations"><span class="annot"><span class="annottext">sortMigrations :: [Text] -&gt; [Text]
</span><a href="Database.Persist.Sql.Migration.html#sortMigrations"><span class="hs-identifier hs-var hs-var">sortMigrations</span></a></span></span><span> </span><span id="local-6989586621679961494"><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621679961494"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-219"></span><span>    </span><span class="annot"><span class="annottext">forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Bool
</span><a href="#local-6989586621679961493"><span class="hs-identifier hs-var">isCreate</span></a></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621679961494"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Bool
</span><a href="#local-6989586621679961493"><span class="hs-identifier hs-var">isCreate</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621679961494"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-220"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-221"></span><span>    </span><span class="hs-comment">-- Note the use of lower-case e. This (hack) allows backends to explicitly</span><span>
</span><span id="line-222"></span><span>    </span><span class="hs-comment">-- choose to have this special sorting applied.</span><span>
</span><span id="line-223"></span><span>    </span><span id="local-6989586621679961493"><span class="annot"><span class="annottext">isCreate :: Text -&gt; Bool
</span><a href="#local-6989586621679961493"><span class="hs-identifier hs-var hs-var">isCreate</span></a></span></span><span> </span><span id="local-6989586621679961492"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679961492"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Text
</span><span class="hs-identifier hs-var">pack</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;CREATe &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Bool
</span><span class="hs-operator hs-var">`isPrefixOf`</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679961492"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span class="hs-comment">-- |  Given a list of old entity definitions and a new 'EntityDef' in</span><span>
</span><span id="line-226"></span><span class="hs-comment">-- @val@, this creates a 'Migration' to update the old list of definitions</span><span>
</span><span id="line-227"></span><span class="hs-comment">-- with the new one.</span><span>
</span><span id="line-228"></span><span class="annot"><a href="Database.Persist.Sql.Migration.html#migrate"><span class="hs-identifier hs-type">migrate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Database.Persist.Types.Base.html#EntityDef"><span class="hs-identifier hs-type">EntityDef</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-229"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.Persist.Types.Base.html#EntityDef"><span class="hs-identifier hs-type">EntityDef</span></a></span><span>
</span><span id="line-230"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Migration"><span class="hs-identifier hs-type">Migration</span></a></span><span>
</span><span id="line-231"></span><span id="migrate"><span class="annot"><span class="annottext">migrate :: [EntityDef] -&gt; EntityDef -&gt; Migration
</span><a href="Database.Persist.Sql.Migration.html#migrate"><span class="hs-identifier hs-var hs-var">migrate</span></a></span></span><span> </span><span id="local-6989586621679961491"><span class="annot"><span class="annottext">[EntityDef]
</span><a href="#local-6989586621679961491"><span class="hs-identifier hs-var">allDefs</span></a></span></span><span> </span><span id="local-6989586621679961490"><span class="annot"><span class="annottext">EntityDef
</span><a href="#local-6989586621679961490"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-232"></span><span>    </span><span id="local-6989586621679961489"><span class="annot"><span class="annottext">SqlBackend
</span><a href="#local-6989586621679961489"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) r. Monad m =&gt; ReaderT r m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-233"></span><span>    </span><span id="local-6989586621679961487"><span class="annot"><span class="annottext">Either [Text] CautiousMigration
</span><a href="#local-6989586621679961487"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SqlBackend
-&gt; [EntityDef]
-&gt; (Text -&gt; IO Statement)
-&gt; EntityDef
-&gt; IO (Either [Text] CautiousMigration)
</span><a href="Database.Persist.SqlBackend.Internal.html#connMigrateSql"><span class="hs-identifier hs-var">connMigrateSql</span></a></span><span> </span><span class="annot"><span class="annottext">SqlBackend
</span><a href="#local-6989586621679961489"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">[EntityDef]
</span><a href="#local-6989586621679961491"><span class="hs-identifier hs-var">allDefs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SqlBackend -&gt; Text -&gt; IO Statement
</span><a href="Database.Persist.Sql.Raw.html#getStmtConn"><span class="hs-identifier hs-var">getStmtConn</span></a></span><span> </span><span class="annot"><span class="annottext">SqlBackend
</span><a href="#local-6989586621679961489"><span class="hs-identifier hs-var">conn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EntityDef
</span><a href="#local-6989586621679961490"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-234"></span><span>    </span><span class="annot"><span class="annottext">forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Migration
</span><a href="Database.Persist.Sql.Migration.html#reportErrors"><span class="hs-identifier hs-var">reportErrors</span></a></span><span> </span><span class="annot"><span class="annottext">CautiousMigration -&gt; Migration
</span><a href="Database.Persist.Sql.Migration.html#addMigrations"><span class="hs-identifier hs-var">addMigrations</span></a></span><span> </span><span class="annot"><span class="annottext">Either [Text] CautiousMigration
</span><a href="#local-6989586621679961487"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span class="hs-comment">-- | Report a single error in a 'Migration'.</span><span>
</span><span id="line-237"></span><span class="hs-comment">--</span><span>
</span><span id="line-238"></span><span class="hs-comment">-- @since 2.9.2</span><span>
</span><span id="line-239"></span><span class="annot"><a href="Database.Persist.Sql.Migration.html#reportError"><span class="hs-identifier hs-type">reportError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Migration"><span class="hs-identifier hs-type">Migration</span></a></span><span>
</span><span id="line-240"></span><span id="reportError"><span class="annot"><span class="annottext">reportError :: Text -&gt; Migration
</span><a href="Database.Persist.Sql.Migration.html#reportError"><span class="hs-identifier hs-var hs-var">reportError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) w. Monad m =&gt; w -&gt; WriterT w m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span class="hs-comment">-- | Report multiple errors in a 'Migration'.</span><span>
</span><span id="line-243"></span><span class="hs-comment">--</span><span>
</span><span id="line-244"></span><span class="hs-comment">-- @since 2.9.2</span><span>
</span><span id="line-245"></span><span class="annot"><a href="Database.Persist.Sql.Migration.html#reportErrors"><span class="hs-identifier hs-type">reportErrors</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Migration"><span class="hs-identifier hs-type">Migration</span></a></span><span>
</span><span id="line-246"></span><span id="reportErrors"><span class="annot"><span class="annottext">reportErrors :: [Text] -&gt; Migration
</span><a href="Database.Persist.Sql.Migration.html#reportErrors"><span class="hs-identifier hs-var hs-var">reportErrors</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) w. Monad m =&gt; w -&gt; WriterT w m ()
</span><span class="hs-identifier hs-var">tell</span></span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span class="hs-comment">-- | Add a migration to the migration plan.</span><span>
</span><span id="line-249"></span><span class="hs-comment">--</span><span>
</span><span id="line-250"></span><span class="hs-comment">-- @since 2.9.2</span><span>
</span><span id="line-251"></span><span class="annot"><a href="Database.Persist.Sql.Migration.html#addMigration"><span class="hs-identifier hs-type">addMigration</span></a></span><span>
</span><span id="line-252"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-comment">-- ^ Is the migration unsafe to run? (eg a destructive or non-idempotent</span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-comment">-- update on the schema). If 'True', the migration is *unsafe*, and will</span><span>
</span><span id="line-255"></span><span>    </span><span class="hs-comment">-- need to be run manually later. If 'False', the migration is *safe*, and</span><span>
</span><span id="line-256"></span><span>    </span><span class="hs-comment">-- can be run any number of times.</span><span>
</span><span id="line-257"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Sql"><span class="hs-identifier hs-type">Sql</span></a></span><span>
</span><span id="line-258"></span><span>    </span><span class="hs-comment">-- ^ A 'Text' value representing the command to run on the database.</span><span>
</span><span id="line-259"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Migration"><span class="hs-identifier hs-type">Migration</span></a></span><span>
</span><span id="line-260"></span><span id="addMigration"><span class="annot"><span class="annottext">addMigration :: Bool -&gt; Text -&gt; Migration
</span><a href="Database.Persist.Sql.Migration.html#addMigration"><span class="hs-identifier hs-var hs-var">addMigration</span></a></span></span><span> </span><span id="local-6989586621679961482"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679961482"><span class="hs-identifier hs-var">isUnsafe</span></a></span></span><span> </span><span id="local-6989586621679961481"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679961481"><span class="hs-identifier hs-var">sql</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) w. Monad m =&gt; w -&gt; WriterT w m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679961482"><span class="hs-identifier hs-var">isUnsafe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679961481"><span class="hs-identifier hs-var">sql</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span class="hs-comment">-- | Add a 'CautiousMigration' (aka a @[('Bool', 'Text')]@) to the</span><span>
</span><span id="line-263"></span><span class="hs-comment">-- migration plan.</span><span>
</span><span id="line-264"></span><span class="hs-comment">--</span><span>
</span><span id="line-265"></span><span class="hs-comment">-- @since 2.9.2</span><span>
</span><span id="line-266"></span><span class="annot"><a href="Database.Persist.Sql.Migration.html#addMigrations"><span class="hs-identifier hs-type">addMigrations</span></a></span><span>
</span><span id="line-267"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#CautiousMigration"><span class="hs-identifier hs-type">CautiousMigration</span></a></span><span>
</span><span id="line-268"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Migration"><span class="hs-identifier hs-type">Migration</span></a></span><span>
</span><span id="line-269"></span><span id="addMigrations"><span class="annot"><span class="annottext">addMigrations :: CautiousMigration -&gt; Migration
</span><a href="Database.Persist.Sql.Migration.html#addMigrations"><span class="hs-identifier hs-var hs-var">addMigrations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) w. Monad m =&gt; w -&gt; WriterT w m ()
</span><span class="hs-identifier hs-var">tell</span></span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span class="hs-comment">-- | Run an action against the database during a migration. Can be useful for eg</span><span>
</span><span id="line-272"></span><span class="hs-comment">-- creating Postgres extensions:</span><span>
</span><span id="line-273"></span><span class="hs-comment">--</span><span>
</span><span id="line-274"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-275"></span><span class="hs-comment">-- runSqlCommand $ 'rawExecute' &quot;CREATE EXTENSION IF NOT EXISTS \&quot;uuid-ossp\&quot;;&quot; []</span><span>
</span><span id="line-276"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-277"></span><span class="hs-comment">--</span><span>
</span><span id="line-278"></span><span class="hs-comment">-- @since 2.13.0.0</span><span>
</span><span id="line-279"></span><span class="annot"><a href="Database.Persist.Sql.Migration.html#runSqlCommand"><span class="hs-identifier hs-type">runSqlCommand</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Types.html#SqlPersistT"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Migration"><span class="hs-identifier hs-type">Migration</span></a></span><span>
</span><span id="line-280"></span><span id="runSqlCommand"><span class="annot"><span class="annottext">runSqlCommand :: SqlPersistT IO () -&gt; Migration
</span><a href="Database.Persist.Sql.Migration.html#runSqlCommand"><span class="hs-identifier hs-var hs-var">runSqlCommand</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span>
</span><span id="line-281"></span><span>
</span><span id="line-282"></span><span class="hs-comment">-- | An exception indicating that Persistent refused to run some unsafe</span><span>
</span><span id="line-283"></span><span class="hs-comment">-- migrations. Contains a list of pairs where the Bool tracks whether the</span><span>
</span><span id="line-284"></span><span class="hs-comment">-- migration was unsafe (True means unsafe), and the Sql is the sql statement</span><span>
</span><span id="line-285"></span><span class="hs-comment">-- for the migration.</span><span>
</span><span id="line-286"></span><span class="hs-comment">--</span><span>
</span><span id="line-287"></span><span class="hs-comment">-- @since 2.11.1.0</span><span>
</span><span id="line-288"></span><span class="hs-keyword">newtype</span><span> </span><span id="PersistUnsafeMigrationException"><span class="annot"><a href="Database.Persist.Sql.Migration.html#PersistUnsafeMigrationException"><span class="hs-identifier hs-var">PersistUnsafeMigrationException</span></a></span></span><span>
</span><span id="line-289"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="PersistUnsafeMigrationException"><span class="annot"><a href="Database.Persist.Sql.Migration.html#PersistUnsafeMigrationException"><span class="hs-identifier hs-var">PersistUnsafeMigrationException</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Sql"><span class="hs-identifier hs-type">Sql</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span class="hs-comment">-- | This 'Show' instance renders an error message suitable for printing to the</span><span>
</span><span id="line-292"></span><span class="hs-comment">-- console. This is a little dodgy, but since GHC uses Show instances when</span><span>
</span><span id="line-293"></span><span class="hs-comment">-- displaying uncaught exceptions, we have little choice.</span><span>
</span><span id="line-294"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679961476"><span id="local-6989586621679961479"><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#PersistUnsafeMigrationException"><span class="hs-identifier hs-type">PersistUnsafeMigrationException</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-295"></span><span>  </span><span id="local-6989586621679961466"><span class="annot"><span class="annottext">show :: PersistUnsafeMigrationException -&gt; [Char]
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">show</span></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Database.Persist.Sql.Migration.html#PersistUnsafeMigrationException"><span class="hs-identifier hs-type">PersistUnsafeMigrationException</span></a></span><span> </span><span id="local-6989586621679961464"><span class="annot"><span class="annottext">CautiousMigration
</span><a href="#local-6989586621679961464"><span class="hs-identifier hs-var">mig</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-296"></span><span>    </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span>
</span><span id="line-297"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;\n\nDatabase migration: manual intervention required.\n&quot;</span></span><span>
</span><span id="line-298"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;The unsafe actions are prefixed by '***' below:\n\n&quot;</span></span><span>
</span><span id="line-299"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[[Char]] -&gt; [Char]
</span><span class="hs-identifier hs-var">unlines</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Bool, Text) -&gt; [Char]
</span><a href="#local-6989586621679961462"><span class="hs-identifier hs-var">displayMigration</span></a></span><span> </span><span class="annot"><span class="annottext">CautiousMigration
</span><a href="#local-6989586621679961464"><span class="hs-identifier hs-var">mig</span></a></span><span>
</span><span id="line-300"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-301"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-302"></span><span>      </span><span class="annot"><a href="#local-6989586621679961462"><span class="hs-identifier hs-type">displayMigration</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#Sql"><span class="hs-identifier hs-type">Sql</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-303"></span><span>      </span><span id="local-6989586621679961462"><span class="annot"><span class="annottext">displayMigration :: (Bool, Text) -&gt; [Char]
</span><a href="#local-6989586621679961462"><span class="hs-identifier hs-var hs-var">displayMigration</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span>  </span><span id="local-6989586621679961461"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679961461"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;*** &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; [Char]
</span><span class="hs-identifier hs-var">unpack</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679961461"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;;&quot;</span></span><span>
</span><span id="line-304"></span><span>      </span><span class="annot"><a href="#local-6989586621679961462"><span class="hs-identifier hs-var">displayMigration</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679961460"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679961460"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;    &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; [Char]
</span><span class="hs-identifier hs-var">unpack</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679961460"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;;&quot;</span></span><span>
</span><span id="line-305"></span><span>
</span><span id="line-306"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679961450"><span id="local-6989586621679961452"><span id="local-6989586621679961454"><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="Database.Persist.Sql.Migration.html#PersistUnsafeMigrationException"><span class="hs-identifier hs-type">PersistUnsafeMigrationException</span></a></span></span></span></span><span>
</span><span id="line-307"></span></pre></body></html>