<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Driver/Make.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE BangPatterns #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE DeriveTraversable #-}</span>
<a name="line-4"></a><span class='hs-comment'>{-# LANGUAGE NamedFieldPuns #-}</span>
<a name="line-5"></a><span class='hs-comment'>{-# LANGUAGE NondecreasingIndentation #-}</span>
<a name="line-6"></a><span class='hs-comment'>{-# LANGUAGE LambdaCase #-}</span>
<a name="line-7"></a><span class='hs-comment'>{-# LANGUAGE RecordWildCards #-}</span>
<a name="line-8"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables #-}</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-comment'>{-# OPTIONS_GHC -Wno-incomplete-uni-patterns #-}</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-13"></a><span class='hs-comment'>--</span>
<a name="line-14"></a><span class='hs-comment'>-- (c) The University of Glasgow, 2011</span>
<a name="line-15"></a><span class='hs-comment'>--</span>
<a name="line-16"></a><span class='hs-comment'>-- This module implements multi-module compilation, and is used</span>
<a name="line-17"></a><span class='hs-comment'>-- by --make and GHCi.</span>
<a name="line-18"></a><span class='hs-comment'>--</span>
<a name="line-19"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-20"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Driver.Make</span> <span class='hs-layout'>(</span>
<a name="line-21"></a>        <span class='hs-varid'>depanal</span><span class='hs-layout'>,</span> <span class='hs-varid'>depanalE</span><span class='hs-layout'>,</span> <span class='hs-varid'>depanalPartial</span><span class='hs-layout'>,</span>
<a name="line-22"></a>        <span class='hs-varid'>load</span><span class='hs-layout'>,</span> <span class='hs-varid'>load'</span><span class='hs-layout'>,</span> <span class='hs-conid'>LoadHowMuch</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-23"></a>        <span class='hs-varid'>instantiationNodes</span><span class='hs-layout'>,</span>
<a name="line-24"></a>
<a name="line-25"></a>        <span class='hs-varid'>downsweep</span><span class='hs-layout'>,</span>
<a name="line-26"></a>
<a name="line-27"></a>        <span class='hs-varid'>topSortModuleGraph</span><span class='hs-layout'>,</span>
<a name="line-28"></a>
<a name="line-29"></a>        <span class='hs-varid'>ms_home_srcimps</span><span class='hs-layout'>,</span> <span class='hs-varid'>ms_home_imps</span><span class='hs-layout'>,</span>
<a name="line-30"></a>
<a name="line-31"></a>        <span class='hs-varid'>summariseModule</span><span class='hs-layout'>,</span>
<a name="line-32"></a>        <span class='hs-varid'>hscSourceToIsBoot</span><span class='hs-layout'>,</span>
<a name="line-33"></a>        <span class='hs-varid'>findExtraSigImports</span><span class='hs-layout'>,</span>
<a name="line-34"></a>        <span class='hs-varid'>implicitRequirementsShallow</span><span class='hs-layout'>,</span>
<a name="line-35"></a>
<a name="line-36"></a>        <span class='hs-varid'>noModError</span><span class='hs-layout'>,</span> <span class='hs-varid'>cyclicModuleErr</span><span class='hs-layout'>,</span>
<a name="line-37"></a>        <span class='hs-varid'>moduleGraphNodes</span><span class='hs-layout'>,</span> <span class='hs-conid'>SummaryNode</span><span class='hs-layout'>,</span>
<a name="line-38"></a>        <span class='hs-conid'>IsBootInterface</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-39"></a>
<a name="line-40"></a>        <span class='hs-conid'>ModNodeMap</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyModNodeMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>modNodeMapElems</span><span class='hs-layout'>,</span> <span class='hs-varid'>modNodeMapLookup</span><span class='hs-layout'>,</span> <span class='hs-varid'>modNodeMapInsert</span>
<a name="line-41"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-42"></a>
<a name="line-43"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-44"></a>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-46"></a>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Backpack</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Monad</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>initIfaceCheck</span> <span class='hs-layout'>)</span>
<a name="line-49"></a>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Runtime.Interpreter</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.Linker.Loader</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Linker</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Linker.Types</span>
<a name="line-53"></a>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Runtime.Context</span>
<a name="line-55"></a>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Config</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Phases</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Pipeline</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Session</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Backend</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Monad</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Env</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Errors</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Main</span>
<a name="line-65"></a>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Parser.Header</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Parser.Errors.Ppr</span>
<a name="line-68"></a>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Iface.Load</span>      <span class='hs-layout'>(</span> <span class='hs-varid'>cannotFindModule</span> <span class='hs-layout'>)</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IfaceToCore</span>     <span class='hs-layout'>(</span> <span class='hs-varid'>typecheckIface</span> <span class='hs-layout'>)</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Iface.Recomp</span>    <span class='hs-layout'>(</span> <span class='hs-conid'>RecompileRequired</span> <span class='hs-layout'>(</span> <span class='hs-conid'>MustCompile</span> <span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-72"></a>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Bag</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>unitBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>listToBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>unionManyBags</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-layout'>)</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Graph.Directed</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.FastString</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Maybe</span>      <span class='hs-layout'>(</span> <span class='hs-varid'>expectJust</span> <span class='hs-layout'>)</span>
<a name="line-77"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.StringBuffer</span>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.LanguageExtensions</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>LangExt</span>
<a name="line-79"></a>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Exception</span> <span class='hs-layout'>(</span> <span class='hs-varid'>tryIO</span> <span class='hs-layout'>)</span>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Monad</span>     <span class='hs-layout'>(</span> <span class='hs-varid'>allM</span> <span class='hs-layout'>)</span>
<a name="line-82"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-84"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-85"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Error</span>
<a name="line-86"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Logger</span>
<a name="line-87"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.TmpFs</span>
<a name="line-88"></a>
<a name="line-89"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Basic</span>
<a name="line-90"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Target</span>
<a name="line-91"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SourceFile</span>
<a name="line-92"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SourceError</span>
<a name="line-93"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SrcLoc</span>
<a name="line-94"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.DSet</span>
<a name="line-95"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.Set</span>
<a name="line-96"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name</span>
<a name="line-97"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Env</span>
<a name="line-98"></a>
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit</span>
<a name="line-100"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.State</span>
<a name="line-101"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Finder</span>
<a name="line-102"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.ModSummary</span>
<a name="line-103"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.ModIface</span>
<a name="line-104"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.Graph</span>
<a name="line-105"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Home.ModInfo</span>
<a name="line-106"></a>
<a name="line-107"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Either</span> <span class='hs-layout'>(</span> <span class='hs-varid'>rights</span><span class='hs-layout'>,</span> <span class='hs-varid'>partitionEithers</span> <span class='hs-layout'>)</span>
<a name="line-108"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-109"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Map</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-layout'>)</span>
<a name="line-110"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.Set</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Set</span>
<a name="line-111"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.Data.FiniteMap</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span> <span class='hs-layout'>(</span> <span class='hs-varid'>insertListWith</span> <span class='hs-layout'>)</span>
<a name="line-112"></a>
<a name="line-113"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Concurrent</span> <span class='hs-layout'>(</span> <span class='hs-varid'>forkIOWithUnmask</span><span class='hs-layout'>,</span> <span class='hs-varid'>killThread</span> <span class='hs-layout'>)</span>
<a name="line-114"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.Conc</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>CC</span>
<a name="line-115"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Concurrent.MVar</span>
<a name="line-116"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Concurrent.QSem</span>
<a name="line-117"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Exception</span>
<a name="line-118"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad</span>
<a name="line-119"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad.Trans.Except</span> <span class='hs-layout'>(</span> <span class='hs-conid'>ExceptT</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>runExceptT</span><span class='hs-layout'>,</span> <span class='hs-varid'>throwE</span> <span class='hs-layout'>)</span>
<a name="line-120"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Control.Monad.Catch</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>MC</span>
<a name="line-121"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.IORef</span>
<a name="line-122"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List</span> <span class='hs-layout'>(</span><span class='hs-varid'>nub</span><span class='hs-layout'>,</span> <span class='hs-varid'>sortBy</span><span class='hs-layout'>,</span> <span class='hs-varid'>partition</span><span class='hs-layout'>)</span>
<a name="line-123"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.List</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>List</span>
<a name="line-124"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Foldable</span> <span class='hs-layout'>(</span><span class='hs-varid'>toList</span><span class='hs-layout'>)</span>
<a name="line-125"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Maybe</span>
<a name="line-126"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Ord</span> <span class='hs-layout'>(</span> <span class='hs-varid'>comparing</span> <span class='hs-layout'>)</span>
<a name="line-127"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Time</span>
<a name="line-128"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Bifunctor</span> <span class='hs-layout'>(</span><span class='hs-varid'>first</span><span class='hs-layout'>)</span>
<a name="line-129"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.Directory</span>
<a name="line-130"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.FilePath</span>
<a name="line-131"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.IO</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>fixIO</span> <span class='hs-layout'>)</span>
<a name="line-132"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.IO.Error</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>isDoesNotExistError</span> <span class='hs-layout'>)</span>
<a name="line-133"></a>
<a name="line-134"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Conc</span> <span class='hs-layout'>(</span> <span class='hs-varid'>getNumProcessors</span><span class='hs-layout'>,</span> <span class='hs-varid'>getNumCapabilities</span><span class='hs-layout'>,</span> <span class='hs-varid'>setNumCapabilities</span> <span class='hs-layout'>)</span>
<a name="line-135"></a>
<a name="line-136"></a><a name="label_self"></a><span class='hs-definition'>label_self</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-137"></a><span class='hs-definition'>label_self</span> <span class='hs-varid'>thread_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-138"></a>    <span class='hs-varid'>self_tid</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>CC.myThreadId</span>
<a name="line-139"></a>    <span class='hs-conid'>CC.labelThread</span> <span class='hs-varid'>self_tid</span> <span class='hs-varid'>thread_name</span>
<a name="line-140"></a>
<a name="line-141"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-142"></a><span class='hs-comment'>-- Loading the program</span>
<a name="line-143"></a>
<a name="line-144"></a><a name="depanal"></a><span class='hs-comment'>-- | Perform a dependency analysis starting from the current targets</span>
<a name="line-145"></a><span class='hs-comment'>-- and update the session with the new module graph.</span>
<a name="line-146"></a><span class='hs-comment'>--</span>
<a name="line-147"></a><span class='hs-comment'>-- Dependency analysis entails parsing the @import@ directives and may</span>
<a name="line-148"></a><span class='hs-comment'>-- therefore require running certain preprocessors.</span>
<a name="line-149"></a><span class='hs-comment'>--</span>
<a name="line-150"></a><span class='hs-comment'>-- Note that each 'ModSummary' in the module graph caches its 'DynFlags'.</span>
<a name="line-151"></a><span class='hs-comment'>-- These 'DynFlags' are determined by the /current/ session 'DynFlags' and the</span>
<a name="line-152"></a><span class='hs-comment'>-- @OPTIONS@ and @LANGUAGE@ pragmas of the parsed module.  Thus if you want</span>
<a name="line-153"></a><span class='hs-comment'>-- changes to the 'DynFlags' to take effect you need to call this function</span>
<a name="line-154"></a><span class='hs-comment'>-- again.</span>
<a name="line-155"></a><span class='hs-comment'>-- In case of errors, just throw them.</span>
<a name="line-156"></a><span class='hs-comment'>--</span>
<a name="line-157"></a><span class='hs-definition'>depanal</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-158"></a>           <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleName</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- ^ excluded modules</span>
<a name="line-159"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>          <span class='hs-comment'>-- ^ allow duplicate roots</span>
<a name="line-160"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>ModuleGraph</span>
<a name="line-161"></a><span class='hs-definition'>depanal</span> <span class='hs-varid'>excluded_mods</span> <span class='hs-varid'>allow_dup_roots</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-162"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>errs</span><span class='hs-layout'>,</span> <span class='hs-varid'>mod_graph</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>depanalE</span> <span class='hs-varid'>excluded_mods</span> <span class='hs-varid'>allow_dup_roots</span>
<a name="line-163"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>errs</span>
<a name="line-164"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>mod_graph</span>
<a name="line-165"></a>      <span class='hs-keyword'>else</span> <span class='hs-varid'>throwErrors</span> <span class='hs-varid'>errs</span>
<a name="line-166"></a>
<a name="line-167"></a><a name="depanalE"></a><span class='hs-comment'>-- | Perform dependency analysis like in 'depanal'.</span>
<a name="line-168"></a><span class='hs-comment'>-- In case of errors, the errors and an empty module graph are returned.</span>
<a name="line-169"></a><span class='hs-definition'>depanalE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span>     <span class='hs-comment'>-- New for #17459</span>
<a name="line-170"></a>            <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleName</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- ^ excluded modules</span>
<a name="line-171"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>           <span class='hs-comment'>-- ^ allow duplicate roots</span>
<a name="line-172"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>ErrorMessages</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModuleGraph</span><span class='hs-layout'>)</span>
<a name="line-173"></a><span class='hs-definition'>depanalE</span> <span class='hs-varid'>excluded_mods</span> <span class='hs-varid'>allow_dup_roots</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-174"></a>    <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-175"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>errs</span><span class='hs-layout'>,</span> <span class='hs-varid'>mod_graph</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>depanalPartial</span> <span class='hs-varid'>excluded_mods</span> <span class='hs-varid'>allow_dup_roots</span>
<a name="line-176"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>errs</span>
<a name="line-177"></a>      <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-178"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>unused_home_mod_err</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>warnMissingHomeModules</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_graph</span>
<a name="line-179"></a>            <span class='hs-varid'>unused_pkg_err</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>warnUnusedPackages</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_graph</span>
<a name="line-180"></a>            <span class='hs-varid'>warns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unused_home_mod_err</span> <span class='hs-varop'>++</span> <span class='hs-varid'>unused_pkg_err</span>
<a name="line-181"></a>        <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>null</span> <span class='hs-varid'>warns</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-182"></a>          <span class='hs-varid'>logWarnings</span> <span class='hs-layout'>(</span><span class='hs-varid'>listToBag</span> <span class='hs-varid'>warns</span><span class='hs-layout'>)</span>
<a name="line-183"></a>        <span class='hs-varid'>setSession</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_mod_graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod_graph</span> <span class='hs-layout'>}</span>
<a name="line-184"></a>        <span class='hs-varid'>pure</span> <span class='hs-layout'>(</span><span class='hs-varid'>errs</span><span class='hs-layout'>,</span> <span class='hs-varid'>mod_graph</span><span class='hs-layout'>)</span>
<a name="line-185"></a>      <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-186"></a>        <span class='hs-comment'>-- We don't have a complete module dependency graph,</span>
<a name="line-187"></a>        <span class='hs-comment'>-- The graph may be disconnected and is unusable.</span>
<a name="line-188"></a>        <span class='hs-varid'>setSession</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_mod_graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyMG</span> <span class='hs-layout'>}</span>
<a name="line-189"></a>        <span class='hs-varid'>pure</span> <span class='hs-layout'>(</span><span class='hs-varid'>errs</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyMG</span><span class='hs-layout'>)</span>
<a name="line-190"></a>
<a name="line-191"></a>
<a name="line-192"></a><a name="depanalPartial"></a><span class='hs-comment'>-- | Perform dependency analysis like 'depanal' but return a partial module</span>
<a name="line-193"></a><span class='hs-comment'>-- graph even in the face of problems with some modules.</span>
<a name="line-194"></a><span class='hs-comment'>--</span>
<a name="line-195"></a><span class='hs-comment'>-- Modules which have parse errors in the module header, failing</span>
<a name="line-196"></a><span class='hs-comment'>-- preprocessors or other issues preventing them from being summarised will</span>
<a name="line-197"></a><span class='hs-comment'>-- simply be absent from the returned module graph.</span>
<a name="line-198"></a><span class='hs-comment'>--</span>
<a name="line-199"></a><span class='hs-comment'>-- Unlike 'depanal' this function will not update 'hsc_mod_graph' with the</span>
<a name="line-200"></a><span class='hs-comment'>-- new module graph.</span>
<a name="line-201"></a><span class='hs-definition'>depanalPartial</span>
<a name="line-202"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span>
<a name="line-203"></a>    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleName</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- ^ excluded modules</span>
<a name="line-204"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>          <span class='hs-comment'>-- ^ allow duplicate roots</span>
<a name="line-205"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>ErrorMessages</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModuleGraph</span><span class='hs-layout'>)</span>
<a name="line-206"></a>    <span class='hs-comment'>-- ^ possibly empty 'Bag' of errors and a module graph.</span>
<a name="line-207"></a><span class='hs-definition'>depanalPartial</span> <span class='hs-varid'>excluded_mods</span> <span class='hs-varid'>allow_dup_roots</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-208"></a>  <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-209"></a>  <span class='hs-keyword'>let</span>
<a name="line-210"></a>         <span class='hs-varid'>dflags</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-211"></a>         <span class='hs-varid'>targets</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_targets</span> <span class='hs-varid'>hsc_env</span>
<a name="line-212"></a>         <span class='hs-varid'>old_graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_mod_graph</span> <span class='hs-varid'>hsc_env</span>
<a name="line-213"></a>         <span class='hs-varid'>logger</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_logger</span> <span class='hs-varid'>hsc_env</span>
<a name="line-214"></a>
<a name="line-215"></a>  <span class='hs-varid'>withTiming</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Chasing dependencies"</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-216"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>hcat</span> <span class='hs-keyglyph'>[</span>
<a name="line-217"></a>              <span class='hs-varid'>text</span> <span class='hs-str'>"Chasing modules from: "</span><span class='hs-layout'>,</span>
<a name="line-218"></a>              <span class='hs-varid'>hcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>punctuate</span> <span class='hs-varid'>comma</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprTarget</span> <span class='hs-varid'>targets</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-219"></a>
<a name="line-220"></a>    <span class='hs-comment'>-- Home package modules may have been moved or deleted, and new</span>
<a name="line-221"></a>    <span class='hs-comment'>-- source files may have appeared in the home package that shadow</span>
<a name="line-222"></a>    <span class='hs-comment'>-- external package modules, so we have to discard the existing</span>
<a name="line-223"></a>    <span class='hs-comment'>-- cached finder data.</span>
<a name="line-224"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>flushFinderCaches</span> <span class='hs-varid'>hsc_env</span>
<a name="line-225"></a>
<a name="line-226"></a>    <span class='hs-varid'>mod_summariesE</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>downsweep</span>
<a name="line-227"></a>      <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>mgExtendedModSummaries</span> <span class='hs-varid'>old_graph</span><span class='hs-layout'>)</span>
<a name="line-228"></a>      <span class='hs-varid'>excluded_mods</span> <span class='hs-varid'>allow_dup_roots</span>
<a name="line-229"></a>    <span class='hs-keyword'>let</span>
<a name="line-230"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>errs</span><span class='hs-layout'>,</span> <span class='hs-varid'>mod_summaries</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionEithers</span> <span class='hs-varid'>mod_summariesE</span>
<a name="line-231"></a>      <span class='hs-varid'>mod_graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkModuleGraph'</span> <span class='hs-varop'>$</span>
<a name="line-232"></a>        <span class='hs-varid'>fmap</span> <span class='hs-conid'>ModuleNode</span> <span class='hs-varid'>mod_summaries</span> <span class='hs-varop'>++</span> <span class='hs-varid'>instantiationNodes</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_units</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-233"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionManyBags</span> <span class='hs-varid'>errs</span><span class='hs-layout'>,</span> <span class='hs-varid'>mod_graph</span><span class='hs-layout'>)</span>
<a name="line-234"></a>
<a name="line-235"></a><a name="instantiationNodes"></a><span class='hs-comment'>-- | Collect the instantiations of dependencies to create 'InstantiationNode' work graph nodes.</span>
<a name="line-236"></a><span class='hs-comment'>-- These are used to represent the type checking that is done after</span>
<a name="line-237"></a><span class='hs-comment'>-- all the free holes (sigs in current package) relevant to that instantiation</span>
<a name="line-238"></a><span class='hs-comment'>-- are compiled. This is necessary to catch some instantiation errors.</span>
<a name="line-239"></a><span class='hs-comment'>--</span>
<a name="line-240"></a><span class='hs-comment'>-- In the future, perhaps more of the work of instantiation could be moved here,</span>
<a name="line-241"></a><span class='hs-comment'>-- instead of shoved in with the module compilation nodes. That could simplify</span>
<a name="line-242"></a><span class='hs-comment'>-- backpack, and maybe hs-boot too.</span>
<a name="line-243"></a><span class='hs-definition'>instantiationNodes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnitState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleGraphNode</span><span class='hs-keyglyph'>]</span>
<a name="line-244"></a><span class='hs-definition'>instantiationNodes</span> <span class='hs-varid'>unit_state</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InstantiationNode</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>iuids_to_check</span>
<a name="line-245"></a>  <span class='hs-keyword'>where</span>
<a name="line-246"></a>    <span class='hs-varid'>iuids_to_check</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InstantiatedUnit</span><span class='hs-keyglyph'>]</span>
<a name="line-247"></a>    <span class='hs-varid'>iuids_to_check</span> <span class='hs-keyglyph'>=</span>
<a name="line-248"></a>      <span class='hs-varid'>nubSort</span> <span class='hs-varop'>$</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>goUnitId</span> <span class='hs-layout'>(</span><span class='hs-varid'>explicitUnits</span> <span class='hs-varid'>unit_state</span><span class='hs-layout'>)</span>
<a name="line-249"></a>     <span class='hs-keyword'>where</span>
<a name="line-250"></a>      <span class='hs-varid'>goUnitId</span> <span class='hs-varid'>uid</span> <span class='hs-keyglyph'>=</span>
<a name="line-251"></a>        <span class='hs-keyglyph'>[</span> <span class='hs-varid'>recur</span>
<a name="line-252"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>VirtUnit</span> <span class='hs-varid'>indef</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>uid</span><span class='hs-keyglyph'>]</span>
<a name="line-253"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>inst</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instUnitInsts</span> <span class='hs-varid'>indef</span>
<a name="line-254"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>recur</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-layout'>(</span><span class='hs-varid'>indef</span> <span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>goUnitId</span> <span class='hs-varop'>$</span> <span class='hs-varid'>moduleUnit</span> <span class='hs-varop'>$</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>inst</span>
<a name="line-255"></a>        <span class='hs-keyglyph'>]</span>
<a name="line-256"></a>
<a name="line-257"></a><a name="warnMissingHomeModules"></a><span class='hs-comment'>-- Note [Missing home modules]</span>
<a name="line-258"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-259"></a><span class='hs-comment'>-- Sometimes user doesn't want GHC to pick up modules, not explicitly listed</span>
<a name="line-260"></a><span class='hs-comment'>-- in a command line. For example, cabal may want to enable this warning</span>
<a name="line-261"></a><span class='hs-comment'>-- when building a library, so that GHC warns user about modules, not listed</span>
<a name="line-262"></a><span class='hs-comment'>-- neither in `exposed-modules`, nor in `other-modules`.</span>
<a name="line-263"></a><span class='hs-comment'>--</span>
<a name="line-264"></a><span class='hs-comment'>-- Here "home module" means a module, that doesn't come from an other package.</span>
<a name="line-265"></a><span class='hs-comment'>--</span>
<a name="line-266"></a><span class='hs-comment'>-- For example, if GHC is invoked with modules "A" and "B" as targets,</span>
<a name="line-267"></a><span class='hs-comment'>-- but "A" imports some other module "C", then GHC will issue a warning</span>
<a name="line-268"></a><span class='hs-comment'>-- about module "C" not being listed in a command line.</span>
<a name="line-269"></a><span class='hs-comment'>--</span>
<a name="line-270"></a><span class='hs-comment'>-- The warning in enabled by `-Wmissing-home-modules`. See #13129</span>
<a name="line-271"></a><span class='hs-definition'>warnMissingHomeModules</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MsgEnvelope</span> <span class='hs-conid'>DecoratedSDoc</span><span class='hs-keyglyph'>]</span>
<a name="line-272"></a><span class='hs-definition'>warnMissingHomeModules</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_graph</span> <span class='hs-keyglyph'>=</span>
<a name="line-273"></a>    <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>wopt</span> <span class='hs-conid'>Opt_WarnMissingHomeModules</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>missing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-274"></a>    <span class='hs-keyword'>then</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>warn</span><span class='hs-keyglyph'>]</span>
<a name="line-275"></a>    <span class='hs-keyword'>else</span> <span class='hs-conid'>[]</span>
<a name="line-276"></a>  <span class='hs-keyword'>where</span>
<a name="line-277"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-278"></a>    <span class='hs-varid'>targets</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>targetId</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_targets</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-279"></a>
<a name="line-280"></a>    <span class='hs-varid'>is_known_module</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_my_target</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>targets</span>
<a name="line-281"></a>
<a name="line-282"></a>    <span class='hs-comment'>-- We need to be careful to handle the case where (possibly</span>
<a name="line-283"></a>    <span class='hs-comment'>-- path-qualified) filenames (aka 'TargetFile') rather than module</span>
<a name="line-284"></a>    <span class='hs-comment'>-- names are being passed on the GHC command-line.</span>
<a name="line-285"></a>    <span class='hs-comment'>--</span>
<a name="line-286"></a>    <span class='hs-comment'>-- For instance, `ghc --make src-exe/Main.hs` and</span>
<a name="line-287"></a>    <span class='hs-comment'>-- `ghc --make -isrc-exe Main` are supposed to be equivalent.</span>
<a name="line-288"></a>    <span class='hs-comment'>-- Note also that we can't always infer the associated module name</span>
<a name="line-289"></a>    <span class='hs-comment'>-- directly from the filename argument.  See #13727.</span>
<a name="line-290"></a>    <span class='hs-varid'>is_my_target</span> <span class='hs-varid'>mod</span> <span class='hs-layout'>(</span><span class='hs-conid'>TargetModule</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-291"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleName</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_mod</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varop'>==</span> <span class='hs-varid'>name</span>
<a name="line-292"></a>    <span class='hs-varid'>is_my_target</span> <span class='hs-varid'>mod</span> <span class='hs-layout'>(</span><span class='hs-conid'>TargetFile</span> <span class='hs-varid'>target_file</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-293"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>mod_file</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ml_hs_file</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_location</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-294"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>target_file</span> <span class='hs-varop'>==</span> <span class='hs-varid'>mod_file</span> <span class='hs-varop'>||</span>
<a name="line-295"></a>
<a name="line-296"></a>           <span class='hs-comment'>--  Don't warn on B.hs-boot if B.hs is specified (#16551)</span>
<a name="line-297"></a>           <span class='hs-varid'>addBootSuffix</span> <span class='hs-varid'>target_file</span> <span class='hs-varop'>==</span> <span class='hs-varid'>mod_file</span> <span class='hs-varop'>||</span>
<a name="line-298"></a>
<a name="line-299"></a>           <span class='hs-comment'>--  We can get a file target even if a module name was</span>
<a name="line-300"></a>           <span class='hs-comment'>--  originally specified in a command line because it can</span>
<a name="line-301"></a>           <span class='hs-comment'>--  be converted in guessTarget (by appending .hs/.lhs).</span>
<a name="line-302"></a>           <span class='hs-comment'>--  So let's convert it back and compare with module name</span>
<a name="line-303"></a>           <span class='hs-varid'>mkModuleName</span> <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>splitExtension</span> <span class='hs-varid'>target_file</span><span class='hs-layout'>)</span>
<a name="line-304"></a>            <span class='hs-varop'>==</span> <span class='hs-varid'>moduleName</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_mod</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-305"></a>    <span class='hs-varid'>is_my_target</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-306"></a>
<a name="line-307"></a>    <span class='hs-varid'>missing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ms_mod</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-308"></a>      <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>is_known_module</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mgModSummaries</span> <span class='hs-varid'>mod_graph</span><span class='hs-layout'>)</span>
<a name="line-309"></a>
<a name="line-310"></a>    <span class='hs-varid'>msg</span>
<a name="line-311"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_BuildingCabalPackage</span> <span class='hs-varid'>dflags</span>
<a name="line-312"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span>
<a name="line-313"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"These modules are needed for compilation but not listed in your .cabal file's other-modules: "</span><span class='hs-layout'>)</span>
<a name="line-314"></a>          <span class='hs-num'>4</span>
<a name="line-315"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>missing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-316"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-317"></a>      <span class='hs-keyglyph'>=</span>
<a name="line-318"></a>        <span class='hs-varid'>hang</span>
<a name="line-319"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Modules are not listed in command line but needed for compilation: "</span><span class='hs-layout'>)</span>
<a name="line-320"></a>          <span class='hs-num'>4</span>
<a name="line-321"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>missing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-322"></a>    <span class='hs-varid'>warn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>makeIntoWarning</span>
<a name="line-323"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>Reason</span> <span class='hs-conid'>Opt_WarnMissingHomeModules</span><span class='hs-layout'>)</span>
<a name="line-324"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>mkPlainMsgEnvelope</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-325"></a>
<a name="line-326"></a><a name="LoadHowMuch"></a><span class='hs-comment'>-- | Describes which modules of the module graph need to be loaded.</span>
<a name="line-327"></a><a name="LoadHowMuch"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>LoadHowMuch</span>
<a name="line-328"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LoadAllTargets</span>
<a name="line-329"></a>     <span class='hs-comment'>-- ^ Load all targets and its dependencies.</span>
<a name="line-330"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LoadUpTo</span> <span class='hs-conid'>ModuleName</span>
<a name="line-331"></a>     <span class='hs-comment'>-- ^ Load only the given module and its dependencies.</span>
<a name="line-332"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LoadDependenciesOf</span> <span class='hs-conid'>ModuleName</span>
<a name="line-333"></a>     <span class='hs-comment'>-- ^ Load only the dependencies of the given module, but not the module</span>
<a name="line-334"></a>     <span class='hs-comment'>-- itself.</span>
<a name="line-335"></a>
<a name="line-336"></a><a name="load"></a><span class='hs-comment'>-- | Try to load the program.  See 'LoadHowMuch' for the different modes.</span>
<a name="line-337"></a><span class='hs-comment'>--</span>
<a name="line-338"></a><span class='hs-comment'>-- This function implements the core of GHC's @--make@ mode.  It preprocesses,</span>
<a name="line-339"></a><span class='hs-comment'>-- compiles and loads the specified modules, avoiding re-compilation wherever</span>
<a name="line-340"></a><span class='hs-comment'>-- possible.  Depending on the backend (see 'DynFlags.backend' field) compiling</span>
<a name="line-341"></a><span class='hs-comment'>-- and loading may result in files being created on disk.</span>
<a name="line-342"></a><span class='hs-comment'>--</span>
<a name="line-343"></a><span class='hs-comment'>-- Calls the 'defaultWarnErrLogger' after each compiling each module, whether</span>
<a name="line-344"></a><span class='hs-comment'>-- successful or not.</span>
<a name="line-345"></a><span class='hs-comment'>--</span>
<a name="line-346"></a><span class='hs-comment'>-- If errors are encountered during dependency analysis, the module `depanalE`</span>
<a name="line-347"></a><span class='hs-comment'>-- returns together with the errors an empty ModuleGraph.</span>
<a name="line-348"></a><span class='hs-comment'>-- After processing this empty ModuleGraph, the errors of depanalE are thrown.</span>
<a name="line-349"></a><span class='hs-comment'>-- All other errors are reported using the 'defaultWarnErrLogger'.</span>
<a name="line-350"></a><span class='hs-comment'>--</span>
<a name="line-351"></a><span class='hs-definition'>load</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>LoadHowMuch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>SuccessFlag</span>
<a name="line-352"></a><span class='hs-definition'>load</span> <span class='hs-varid'>how_much</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-353"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>errs</span><span class='hs-layout'>,</span> <span class='hs-varid'>mod_graph</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>depanalE</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>False</span>                        <span class='hs-comment'>-- #17459</span>
<a name="line-354"></a>    <span class='hs-varid'>success</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>load'</span> <span class='hs-varid'>how_much</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>batchMsg</span><span class='hs-layout'>)</span> <span class='hs-varid'>mod_graph</span>
<a name="line-355"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>errs</span>
<a name="line-356"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>success</span>
<a name="line-357"></a>      <span class='hs-keyword'>else</span> <span class='hs-varid'>throwErrors</span> <span class='hs-varid'>errs</span>
<a name="line-358"></a>
<a name="line-359"></a><span class='hs-comment'>-- Note [Unused packages]</span>
<a name="line-360"></a><span class='hs-comment'>--</span>
<a name="line-361"></a><span class='hs-comment'>-- Cabal passes `--package-id` flag for each direct dependency. But GHC</span>
<a name="line-362"></a><span class='hs-comment'>-- loads them lazily, so when compilation is done, we have a list of all</span>
<a name="line-363"></a><span class='hs-comment'>-- actually loaded packages. All the packages, specified on command line,</span>
<a name="line-364"></a><span class='hs-comment'>-- but never loaded, are probably unused dependencies.</span>
<a name="line-365"></a>
<a name="line-366"></a><a name="warnUnusedPackages"></a><span class='hs-definition'>warnUnusedPackages</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MsgEnvelope</span> <span class='hs-conid'>DecoratedSDoc</span><span class='hs-keyglyph'>]</span>
<a name="line-367"></a><span class='hs-definition'>warnUnusedPackages</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_graph</span> <span class='hs-keyglyph'>=</span>
<a name="line-368"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-369"></a>        <span class='hs-varid'>state</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_units</span> <span class='hs-varid'>hsc_env</span>
<a name="line-370"></a>
<a name="line-371"></a>    <span class='hs-comment'>-- Only need non-source imports here because SOURCE imports are always HPT</span>
<a name="line-372"></a>        <span class='hs-varid'>loadedPackages</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concat</span> <span class='hs-varop'>$</span>
<a name="line-373"></a>          <span class='hs-varid'>mapMaybe</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>mn</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookupModulePackage</span> <span class='hs-varid'>state</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>mn</span><span class='hs-layout'>)</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span>
<a name="line-374"></a>            <span class='hs-varop'>$</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>ms_imps</span> <span class='hs-layout'>(</span><span class='hs-varid'>mgModSummaries</span> <span class='hs-varid'>mod_graph</span><span class='hs-layout'>)</span>
<a name="line-375"></a>
<a name="line-376"></a>        <span class='hs-varid'>requestedArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapMaybe</span> <span class='hs-varid'>packageArg</span> <span class='hs-layout'>(</span><span class='hs-varid'>packageFlags</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-377"></a>
<a name="line-378"></a>        <span class='hs-varid'>unusedArgs</span>
<a name="line-379"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>arg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>matching</span> <span class='hs-varid'>state</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>loadedPackages</span><span class='hs-layout'>)</span>
<a name="line-380"></a>                   <span class='hs-varid'>requestedArgs</span>
<a name="line-381"></a>
<a name="line-382"></a>        <span class='hs-varid'>warn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>makeIntoWarning</span>
<a name="line-383"></a>          <span class='hs-layout'>(</span><span class='hs-conid'>Reason</span> <span class='hs-conid'>Opt_WarnUnusedPackages</span><span class='hs-layout'>)</span>
<a name="line-384"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>mkPlainMsgEnvelope</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-385"></a>        <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"The following packages were specified"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-386"></a>                     <span class='hs-varid'>text</span> <span class='hs-str'>"via -package or -package-id flags,"</span>
<a name="line-387"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"but were not needed for compilation:"</span>
<a name="line-388"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>withDash</span> <span class='hs-varop'>.</span> <span class='hs-varid'>pprUnusedArg</span><span class='hs-layout'>)</span> <span class='hs-varid'>unusedArgs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-389"></a>
<a name="line-390"></a>    <span class='hs-keyword'>in</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>unusedArgs</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>wopt</span> <span class='hs-conid'>Opt_WarnUnusedPackages</span> <span class='hs-varid'>dflags</span>
<a name="line-391"></a>       <span class='hs-keyword'>then</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>warn</span><span class='hs-keyglyph'>]</span>
<a name="line-392"></a>       <span class='hs-keyword'>else</span> <span class='hs-conid'>[]</span>
<a name="line-393"></a>
<a name="line-394"></a>    <span class='hs-keyword'>where</span>
<a name="line-395"></a>        <span class='hs-varid'>packageArg</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExposePackage</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arg</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>arg</span>
<a name="line-396"></a>        <span class='hs-varid'>packageArg</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-397"></a>
<a name="line-398"></a>        <span class='hs-varid'>pprUnusedArg</span> <span class='hs-layout'>(</span><span class='hs-conid'>PackageArg</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-varid'>str</span>
<a name="line-399"></a>        <span class='hs-varid'>pprUnusedArg</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnitIdArg</span> <span class='hs-varid'>uid</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>uid</span>
<a name="line-400"></a>
<a name="line-401"></a>        <span class='hs-varid'>withDash</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;+&gt;</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"-"</span><span class='hs-layout'>)</span>
<a name="line-402"></a>
<a name="line-403"></a>        <span class='hs-varid'>matchingStr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnitInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-404"></a>        <span class='hs-varid'>matchingStr</span> <span class='hs-varid'>str</span> <span class='hs-varid'>p</span>
<a name="line-405"></a>                <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>str</span> <span class='hs-varop'>==</span> <span class='hs-varid'>unitPackageIdString</span> <span class='hs-varid'>p</span>
<a name="line-406"></a>                <span class='hs-varop'>||</span> <span class='hs-varid'>str</span> <span class='hs-varop'>==</span> <span class='hs-varid'>unitPackageNameString</span> <span class='hs-varid'>p</span>
<a name="line-407"></a>
<a name="line-408"></a>        <span class='hs-varid'>matching</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnitState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PackageArg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnitInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-409"></a>        <span class='hs-varid'>matching</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>PackageArg</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matchingStr</span> <span class='hs-varid'>str</span> <span class='hs-varid'>p</span>
<a name="line-410"></a>        <span class='hs-varid'>matching</span> <span class='hs-varid'>state</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnitIdArg</span> <span class='hs-varid'>uid</span><span class='hs-layout'>)</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uid</span> <span class='hs-varop'>==</span> <span class='hs-varid'>realUnit</span> <span class='hs-varid'>state</span> <span class='hs-varid'>p</span>
<a name="line-411"></a>
<a name="line-412"></a>        <span class='hs-comment'>-- For wired-in packages, we have to unwire their id,</span>
<a name="line-413"></a>        <span class='hs-comment'>-- otherwise they won't match package flags</span>
<a name="line-414"></a>        <span class='hs-varid'>realUnit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnitState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnitInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unit</span>
<a name="line-415"></a>        <span class='hs-varid'>realUnit</span> <span class='hs-varid'>state</span>
<a name="line-416"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unwireUnit</span> <span class='hs-varid'>state</span>
<a name="line-417"></a>          <span class='hs-varop'>.</span> <span class='hs-conid'>RealUnit</span>
<a name="line-418"></a>          <span class='hs-varop'>.</span> <span class='hs-conid'>Definite</span>
<a name="line-419"></a>          <span class='hs-varop'>.</span> <span class='hs-varid'>unitId</span>
<a name="line-420"></a>
<a name="line-421"></a><a name="load'"></a><span class='hs-comment'>-- | Generalized version of 'load' which also supports a custom</span>
<a name="line-422"></a><span class='hs-comment'>-- 'Messager' (for reporting progress) and 'ModuleGraph' (generally</span>
<a name="line-423"></a><span class='hs-comment'>-- produced by calling 'depanal'.</span>
<a name="line-424"></a><span class='hs-definition'>load'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>LoadHowMuch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Messager</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>SuccessFlag</span>
<a name="line-425"></a><span class='hs-definition'>load'</span> <span class='hs-varid'>how_much</span> <span class='hs-varid'>mHscMessage</span> <span class='hs-varid'>mod_graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-426"></a>    <span class='hs-varid'>modifySession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_mod_graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod_graph</span> <span class='hs-layout'>}</span>
<a name="line-427"></a>    <span class='hs-varid'>guessOutputFile</span>
<a name="line-428"></a>    <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-429"></a>
<a name="line-430"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>hpt1</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>hsc_env</span>
<a name="line-431"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-432"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_logger</span> <span class='hs-varid'>hsc_env</span>
<a name="line-433"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>interp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hscInterp</span> <span class='hs-varid'>hsc_env</span>
<a name="line-434"></a>
<a name="line-435"></a>    <span class='hs-comment'>-- The "bad" boot modules are the ones for which we have</span>
<a name="line-436"></a>    <span class='hs-comment'>-- B.hs-boot in the module graph, but no B.hs</span>
<a name="line-437"></a>    <span class='hs-comment'>-- The downsweep should have ensured this does not happen</span>
<a name="line-438"></a>    <span class='hs-comment'>-- (see msDeps)</span>
<a name="line-439"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>all_home_mods</span> <span class='hs-keyglyph'>=</span>
<a name="line-440"></a>          <span class='hs-varid'>mkUniqSet</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ms_mod_name</span> <span class='hs-varid'>s</span>
<a name="line-441"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mgModSummaries</span> <span class='hs-varid'>mod_graph</span><span class='hs-layout'>,</span> <span class='hs-varid'>isBootSummary</span> <span class='hs-varid'>s</span> <span class='hs-varop'>==</span> <span class='hs-conid'>NotBoot</span><span class='hs-keyglyph'>]</span>
<a name="line-442"></a>    <span class='hs-comment'>-- TODO: Figure out what the correct form of this assert is. It's violated</span>
<a name="line-443"></a>    <span class='hs-comment'>-- when you have HsBootMerge nodes in the graph: then you'll have hs-boot</span>
<a name="line-444"></a>    <span class='hs-comment'>-- files without corresponding hs files.</span>
<a name="line-445"></a>    <span class='hs-comment'>--  bad_boot_mods = [s        | s &lt;- mod_graph, isBootSummary s,</span>
<a name="line-446"></a>    <span class='hs-comment'>--                              not (ms_mod_name s `elem` all_home_mods)]</span>
<a name="line-447"></a>    <span class='hs-comment'>-- ASSERT( null bad_boot_mods ) return ()</span>
<a name="line-448"></a>
<a name="line-449"></a>    <span class='hs-comment'>-- check that the module given in HowMuch actually exists, otherwise</span>
<a name="line-450"></a>    <span class='hs-comment'>-- topSortModuleGraph will bomb later.</span>
<a name="line-451"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>checkHowMuch</span> <span class='hs-layout'>(</span><span class='hs-conid'>LoadUpTo</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkMod</span> <span class='hs-varid'>m</span>
<a name="line-452"></a>        <span class='hs-varid'>checkHowMuch</span> <span class='hs-layout'>(</span><span class='hs-conid'>LoadDependenciesOf</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkMod</span> <span class='hs-varid'>m</span>
<a name="line-453"></a>        <span class='hs-varid'>checkHowMuch</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span>
<a name="line-454"></a>
<a name="line-455"></a>        <span class='hs-varid'>checkMod</span> <span class='hs-varid'>m</span> <span class='hs-varid'>and_then</span>
<a name="line-456"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>m</span> <span class='hs-varop'>`elementOfUniqSet`</span> <span class='hs-varid'>all_home_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>and_then</span>
<a name="line-457"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-458"></a>                    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>errorMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span>
<a name="line-459"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"no such module:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-460"></a>                    <span class='hs-varid'>return</span> <span class='hs-conid'>Failed</span>
<a name="line-461"></a>
<a name="line-462"></a>    <span class='hs-varid'>checkHowMuch</span> <span class='hs-varid'>how_much</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-463"></a>
<a name="line-464"></a>    <span class='hs-comment'>-- mg2_with_srcimps drops the hi-boot nodes, returning a</span>
<a name="line-465"></a>    <span class='hs-comment'>-- graph with cycles.  Among other things, it is used for</span>
<a name="line-466"></a>    <span class='hs-comment'>-- backing out partially complete cycles following a failed</span>
<a name="line-467"></a>    <span class='hs-comment'>-- upsweep, and for removing from hpt all the modules</span>
<a name="line-468"></a>    <span class='hs-comment'>-- not in strict downwards closure, during calls to compile.</span>
<a name="line-469"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>mg2_with_srcimps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-conid'>ModSummary</span><span class='hs-keyglyph'>]</span>
<a name="line-470"></a>        <span class='hs-varid'>mg2_with_srcimps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterToposortToModules</span> <span class='hs-varop'>$</span>
<a name="line-471"></a>          <span class='hs-varid'>topSortModuleGraph</span> <span class='hs-conid'>True</span> <span class='hs-varid'>mod_graph</span> <span class='hs-conid'>Nothing</span>
<a name="line-472"></a>
<a name="line-473"></a>    <span class='hs-comment'>-- If we can determine that any of the {-# SOURCE #-} imports</span>
<a name="line-474"></a>    <span class='hs-comment'>-- are definitely unnecessary, then emit a warning.</span>
<a name="line-475"></a>    <span class='hs-varid'>warnUnnecessarySourceImports</span> <span class='hs-varid'>mg2_with_srcimps</span>
<a name="line-476"></a>
<a name="line-477"></a>    <span class='hs-keyword'>let</span>
<a name="line-478"></a>        <span class='hs-comment'>-- check the stability property for each module.</span>
<a name="line-479"></a>        <span class='hs-varid'>stable_mods</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>stable_obj</span><span class='hs-layout'>,</span><span class='hs-varid'>stable_bco</span><span class='hs-layout'>)</span>
<a name="line-480"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkStability</span> <span class='hs-varid'>hpt1</span> <span class='hs-varid'>mg2_with_srcimps</span> <span class='hs-varid'>all_home_mods</span>
<a name="line-481"></a>
<a name="line-482"></a>        <span class='hs-varid'>pruned_hpt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hpt1</span>
<a name="line-483"></a>
<a name="line-484"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>evaluate</span> <span class='hs-varid'>pruned_hpt</span>
<a name="line-485"></a>
<a name="line-486"></a>    <span class='hs-comment'>-- before we unload anything, make sure we don't leave an old</span>
<a name="line-487"></a>    <span class='hs-comment'>-- interactive context around pointing to dead bindings.  Also,</span>
<a name="line-488"></a>    <span class='hs-comment'>-- write the pruned HPT to allow the old HPT to be GC'd.</span>
<a name="line-489"></a>    <span class='hs-varid'>setSession</span> <span class='hs-varop'>$</span> <span class='hs-varid'>discardIC</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_HPT</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pruned_hpt</span> <span class='hs-layout'>}</span>
<a name="line-490"></a>
<a name="line-491"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Stable obj:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>stable_obj</span> <span class='hs-varop'>$$</span>
<a name="line-492"></a>                            <span class='hs-varid'>text</span> <span class='hs-str'>"Stable BCO:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>stable_bco</span><span class='hs-layout'>)</span>
<a name="line-493"></a>
<a name="line-494"></a>    <span class='hs-comment'>-- Unload any modules which are going to be re-linked this time around.</span>
<a name="line-495"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>stable_linkables</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>linkable</span>
<a name="line-496"></a>                           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nonDetEltsUniqSet</span> <span class='hs-varid'>stable_obj</span> <span class='hs-varop'>++</span>
<a name="line-497"></a>                                  <span class='hs-varid'>nonDetEltsUniqSet</span> <span class='hs-varid'>stable_bco</span><span class='hs-layout'>,</span>
<a name="line-498"></a>                             <span class='hs-comment'>-- It's OK to use nonDetEltsUniqSet here</span>
<a name="line-499"></a>                             <span class='hs-comment'>-- because it only affects linking. Besides</span>
<a name="line-500"></a>                             <span class='hs-comment'>-- this list only serves as a poor man's set.</span>
<a name="line-501"></a>                             <span class='hs-conid'>Just</span> <span class='hs-varid'>hmi</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>lookupHpt</span> <span class='hs-varid'>pruned_hpt</span> <span class='hs-varid'>m</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-502"></a>                             <span class='hs-conid'>Just</span> <span class='hs-varid'>linkable</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>hm_linkable</span> <span class='hs-varid'>hmi</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-503"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unload</span> <span class='hs-varid'>interp</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>stable_linkables</span>
<a name="line-504"></a>
<a name="line-505"></a>    <span class='hs-comment'>-- We could at this point detect cycles which aren't broken by</span>
<a name="line-506"></a>    <span class='hs-comment'>-- a source-import, and complain immediately, but it seems better</span>
<a name="line-507"></a>    <span class='hs-comment'>-- to let upsweep_mods do this, so at least some useful work gets</span>
<a name="line-508"></a>    <span class='hs-comment'>-- done before the upsweep is abandoned.</span>
<a name="line-509"></a>    <span class='hs-comment'>--hPutStrLn stderr "after tsort:\n"</span>
<a name="line-510"></a>    <span class='hs-comment'>--hPutStrLn stderr (showSDoc (vcat (map ppr mg2)))</span>
<a name="line-511"></a>
<a name="line-512"></a>    <span class='hs-comment'>-- Now do the upsweep, calling compile for each module in</span>
<a name="line-513"></a>    <span class='hs-comment'>-- turn.  Final result is version 3 of everything.</span>
<a name="line-514"></a>
<a name="line-515"></a>    <span class='hs-comment'>-- Topologically sort the module graph, this time including hi-boot</span>
<a name="line-516"></a>    <span class='hs-comment'>-- nodes, and possibly just including the portion of the graph</span>
<a name="line-517"></a>    <span class='hs-comment'>-- reachable from the module specified in the 2nd argument to load.</span>
<a name="line-518"></a>    <span class='hs-comment'>-- This graph should be cycle-free.</span>
<a name="line-519"></a>    <span class='hs-comment'>-- If we're restricting the upsweep to a portion of the graph, we</span>
<a name="line-520"></a>    <span class='hs-comment'>-- also want to retain everything that is still stable.</span>
<a name="line-521"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>full_mg</span><span class='hs-layout'>,</span> <span class='hs-varid'>partial_mg0</span><span class='hs-layout'>,</span> <span class='hs-varid'>partial_mg</span><span class='hs-layout'>,</span> <span class='hs-varid'>unstable_mg</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-conid'>ModuleGraphNode</span><span class='hs-keyglyph'>]</span>
<a name="line-522"></a>        <span class='hs-varid'>stable_mg</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-conid'>ExtendedModSummary</span><span class='hs-keyglyph'>]</span>
<a name="line-523"></a>        <span class='hs-varid'>full_mg</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topSortModuleGraph</span> <span class='hs-conid'>False</span> <span class='hs-varid'>mod_graph</span> <span class='hs-conid'>Nothing</span>
<a name="line-524"></a>
<a name="line-525"></a>        <span class='hs-varid'>maybe_top_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>how_much</span> <span class='hs-keyword'>of</span>
<a name="line-526"></a>                            <span class='hs-conid'>LoadUpTo</span> <span class='hs-varid'>m</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>m</span>
<a name="line-527"></a>                            <span class='hs-conid'>LoadDependenciesOf</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>m</span>
<a name="line-528"></a>                            <span class='hs-keyword'>_</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-529"></a>
<a name="line-530"></a>        <span class='hs-varid'>partial_mg0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topSortModuleGraph</span> <span class='hs-conid'>False</span> <span class='hs-varid'>mod_graph</span> <span class='hs-varid'>maybe_top_mod</span>
<a name="line-531"></a>
<a name="line-532"></a>        <span class='hs-comment'>-- LoadDependenciesOf m: we want the upsweep to stop just</span>
<a name="line-533"></a>        <span class='hs-comment'>-- short of the specified module (unless the specified module</span>
<a name="line-534"></a>        <span class='hs-comment'>-- is stable).</span>
<a name="line-535"></a>        <span class='hs-varid'>partial_mg</span>
<a name="line-536"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LoadDependenciesOf</span> <span class='hs-sel'>_mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>how_much</span>
<a name="line-537"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>last</span> <span class='hs-varid'>partial_mg0</span> <span class='hs-keyword'>of</span>
<a name="line-538"></a>                        <span class='hs-conid'>AcyclicSCC</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModuleNode</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExtendedModSummary</span> <span class='hs-varid'>ms</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ms_mod_name</span> <span class='hs-varid'>ms</span> <span class='hs-varop'>==</span> <span class='hs-sel'>_mod</span><span class='hs-layout'>;</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span> <span class='hs-layout'>)</span>
<a name="line-539"></a>              <span class='hs-conid'>List.init</span> <span class='hs-varid'>partial_mg0</span>
<a name="line-540"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-541"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partial_mg0</span>
<a name="line-542"></a>
<a name="line-543"></a>        <span class='hs-varid'>stable_mg</span> <span class='hs-keyglyph'>=</span>
<a name="line-544"></a>            <span class='hs-keyglyph'>[</span> <span class='hs-conid'>AcyclicSCC</span> <span class='hs-varid'>ems</span>
<a name="line-545"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AcyclicSCC</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModuleNode</span> <span class='hs-varid'>ems</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ExtendedModSummary</span> <span class='hs-varid'>ms</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>full_mg</span>
<a name="line-546"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>stable_mod_summary</span> <span class='hs-varid'>ms</span>
<a name="line-547"></a>            <span class='hs-keyglyph'>]</span>
<a name="line-548"></a>
<a name="line-549"></a>        <span class='hs-varid'>stable_mod_summary</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>=</span>
<a name="line-550"></a>          <span class='hs-varid'>ms_mod_name</span> <span class='hs-varid'>ms</span> <span class='hs-varop'>`elementOfUniqSet`</span> <span class='hs-varid'>stable_obj</span> <span class='hs-varop'>||</span>
<a name="line-551"></a>          <span class='hs-varid'>ms_mod_name</span> <span class='hs-varid'>ms</span> <span class='hs-varop'>`elementOfUniqSet`</span> <span class='hs-varid'>stable_bco</span>
<a name="line-552"></a>
<a name="line-553"></a>        <span class='hs-comment'>-- the modules from partial_mg that are not also stable</span>
<a name="line-554"></a>        <span class='hs-comment'>-- NB. also keep cycles, we need to emit an error message later</span>
<a name="line-555"></a>        <span class='hs-varid'>unstable_mg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>not_stable</span> <span class='hs-varid'>partial_mg</span>
<a name="line-556"></a>          <span class='hs-keyword'>where</span> <span class='hs-varid'>not_stable</span> <span class='hs-layout'>(</span><span class='hs-conid'>CyclicSCC</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-557"></a>                <span class='hs-varid'>not_stable</span> <span class='hs-layout'>(</span><span class='hs-conid'>AcyclicSCC</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstantiationNode</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-558"></a>                <span class='hs-varid'>not_stable</span> <span class='hs-layout'>(</span><span class='hs-conid'>AcyclicSCC</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModuleNode</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExtendedModSummary</span> <span class='hs-varid'>ms</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-559"></a>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>stable_mod_summary</span> <span class='hs-varid'>ms</span>
<a name="line-560"></a>
<a name="line-561"></a>        <span class='hs-comment'>-- Load all the stable modules first, before attempting to load</span>
<a name="line-562"></a>        <span class='hs-comment'>-- an unstable module (#7231).</span>
<a name="line-563"></a>        <span class='hs-varid'>mg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-conid'>ModuleNode</span><span class='hs-layout'>)</span> <span class='hs-varid'>stable_mg</span> <span class='hs-varop'>++</span> <span class='hs-varid'>unstable_mg</span>
<a name="line-564"></a>
<a name="line-565"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Ready for upsweep"</span><span class='hs-layout'>)</span>
<a name="line-566"></a>                               <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-567"></a>
<a name="line-568"></a>    <span class='hs-varid'>n_jobs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>parMakeCount</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>of</span>
<a name="line-569"></a>                    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varid'>getNumProcessors</span>
<a name="line-570"></a>                    <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>n</span>
<a name="line-571"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>upsweep_fn</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n_jobs</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parUpsweep</span> <span class='hs-varid'>n_jobs</span>
<a name="line-572"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upsweep</span>
<a name="line-573"></a>
<a name="line-574"></a>    <span class='hs-varid'>setSession</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsc_HPT</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyHomePackageTable</span> <span class='hs-layout'>}</span>
<a name="line-575"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>upsweep_ok</span><span class='hs-layout'>,</span> <span class='hs-varid'>modsUpswept</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>withDeferredDiagnostics</span> <span class='hs-varop'>$</span>
<a name="line-576"></a>      <span class='hs-varid'>upsweep_fn</span> <span class='hs-varid'>mHscMessage</span> <span class='hs-varid'>pruned_hpt</span> <span class='hs-varid'>stable_mods</span> <span class='hs-varid'>mg</span>
<a name="line-577"></a>
<a name="line-578"></a>    <span class='hs-comment'>-- Make modsDone be the summaries for each home module now</span>
<a name="line-579"></a>    <span class='hs-comment'>-- available; this should equal the domain of hpt3.</span>
<a name="line-580"></a>    <span class='hs-comment'>-- Get in in a roughly top .. bottom order (hence reverse).</span>
<a name="line-581"></a>
<a name="line-582"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>nodesDone</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>modsUpswept</span>
<a name="line-583"></a>        <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>modsDone</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionNodes</span> <span class='hs-varid'>nodesDone</span>
<a name="line-584"></a>
<a name="line-585"></a>    <span class='hs-comment'>-- Try and do linking in some form, depending on whether the</span>
<a name="line-586"></a>    <span class='hs-comment'>-- upsweep was completely or only partially successful.</span>
<a name="line-587"></a>
<a name="line-588"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>succeeded</span> <span class='hs-varid'>upsweep_ok</span>
<a name="line-589"></a>
<a name="line-590"></a>     <span class='hs-keyword'>then</span>
<a name="line-591"></a>       <span class='hs-comment'>-- Easy; just relink it all.</span>
<a name="line-592"></a>       <span class='hs-keyword'>do</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Upsweep completely successful."</span><span class='hs-layout'>)</span>
<a name="line-593"></a>
<a name="line-594"></a>          <span class='hs-comment'>-- Clean up after ourselves</span>
<a name="line-595"></a>          <span class='hs-varid'>hsc_env1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-596"></a>          <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cleanCurrentModuleTempFiles</span> <span class='hs-varid'>logger</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_tmpfs</span> <span class='hs-varid'>hsc_env1</span><span class='hs-layout'>)</span> <span class='hs-varid'>dflags</span>
<a name="line-597"></a>
<a name="line-598"></a>          <span class='hs-comment'>-- Issue a warning for the confusing case where the user</span>
<a name="line-599"></a>          <span class='hs-comment'>-- said '-o foo' but we're not going to do any linking.</span>
<a name="line-600"></a>          <span class='hs-comment'>-- We attempt linking if either (a) one of the modules is</span>
<a name="line-601"></a>          <span class='hs-comment'>-- called Main, or (b) the user said -no-hs-main, indicating</span>
<a name="line-602"></a>          <span class='hs-comment'>-- that main() is going to come from somewhere else.</span>
<a name="line-603"></a>          <span class='hs-comment'>--</span>
<a name="line-604"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>ofile</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>outputFile</span> <span class='hs-varid'>dflags</span>
<a name="line-605"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>no_hs_main</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_NoHsMain</span> <span class='hs-varid'>dflags</span>
<a name="line-606"></a>          <span class='hs-keyword'>let</span>
<a name="line-607"></a>            <span class='hs-varid'>main_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mainModIs</span> <span class='hs-varid'>hsc_env</span>
<a name="line-608"></a>            <span class='hs-varid'>a_root_is_Main</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mgElemModule</span> <span class='hs-varid'>mod_graph</span> <span class='hs-varid'>main_mod</span>
<a name="line-609"></a>            <span class='hs-varid'>do_linking</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a_root_is_Main</span> <span class='hs-varop'>||</span> <span class='hs-varid'>no_hs_main</span> <span class='hs-varop'>||</span> <span class='hs-varid'>ghcLink</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>==</span> <span class='hs-conid'>LinkDynLib</span> <span class='hs-varop'>||</span> <span class='hs-varid'>ghcLink</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>==</span> <span class='hs-conid'>LinkStaticLib</span>
<a name="line-610"></a>
<a name="line-611"></a>          <span class='hs-comment'>-- link everything together</span>
<a name="line-612"></a>          <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-613"></a>          <span class='hs-varid'>linkresult</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>link</span> <span class='hs-layout'>(</span><span class='hs-varid'>ghcLink</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-614"></a>                                      <span class='hs-varid'>logger</span>
<a name="line-615"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>hsc_tmpfs</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-616"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>hsc_hooks</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-617"></a>                                      <span class='hs-varid'>dflags</span>
<a name="line-618"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>hsc_unit_env</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-619"></a>                                      <span class='hs-varid'>do_linking</span>
<a name="line-620"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>hsc_env1</span><span class='hs-layout'>)</span>
<a name="line-621"></a>
<a name="line-622"></a>          <span class='hs-keyword'>if</span> <span class='hs-varid'>ghcLink</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>==</span> <span class='hs-conid'>LinkBinary</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isJust</span> <span class='hs-varid'>ofile</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>do_linking</span>
<a name="line-623"></a>             <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-624"></a>                <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>errorMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span>
<a name="line-625"></a>                   <span class='hs-layout'>(</span><span class='hs-str'>"output was redirected with -o, "</span> <span class='hs-varop'>++</span>
<a name="line-626"></a>                    <span class='hs-str'>"but no output will be generated\n"</span> <span class='hs-varop'>++</span>
<a name="line-627"></a>                    <span class='hs-str'>"because there is no "</span> <span class='hs-varop'>++</span>
<a name="line-628"></a>                    <span class='hs-varid'>moduleNameString</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>main_mod</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>" module."</span><span class='hs-layout'>)</span>
<a name="line-629"></a>                <span class='hs-comment'>-- This should be an error, not a warning (#10895).</span>
<a name="line-630"></a>                <span class='hs-varid'>loadFinish</span> <span class='hs-conid'>Failed</span> <span class='hs-varid'>linkresult</span>
<a name="line-631"></a>             <span class='hs-keyword'>else</span>
<a name="line-632"></a>                <span class='hs-varid'>loadFinish</span> <span class='hs-conid'>Succeeded</span> <span class='hs-varid'>linkresult</span>
<a name="line-633"></a>
<a name="line-634"></a>     <span class='hs-keyword'>else</span>
<a name="line-635"></a>       <span class='hs-comment'>-- Tricky.  We need to back out the effects of compiling any</span>
<a name="line-636"></a>       <span class='hs-comment'>-- half-done cycles, both so as to clean up the top level envs</span>
<a name="line-637"></a>       <span class='hs-comment'>-- and to avoid telling the interactive linker to link them.</span>
<a name="line-638"></a>       <span class='hs-keyword'>do</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Upsweep partially successful."</span><span class='hs-layout'>)</span>
<a name="line-639"></a>
<a name="line-640"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>modsDone_names</span>
<a name="line-641"></a>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_mod</span> <span class='hs-varop'>.</span> <span class='hs-varid'>emsModSummary</span><span class='hs-layout'>)</span> <span class='hs-varid'>modsDone</span>
<a name="line-642"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>mods_to_zap_names</span>
<a name="line-643"></a>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findPartiallyCompletedCycles</span> <span class='hs-varid'>modsDone_names</span>
<a name="line-644"></a>                      <span class='hs-varid'>mg2_with_srcimps</span>
<a name="line-645"></a>          <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>mods_to_clean</span><span class='hs-layout'>,</span> <span class='hs-varid'>mods_to_keep</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-646"></a>                <span class='hs-varid'>partition</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>`Set.member`</span> <span class='hs-varid'>mods_to_zap_names</span><span class='hs-layout'>)</span><span class='hs-varop'>.</span><span class='hs-varid'>ms_mod</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-647"></a>                <span class='hs-varid'>emsModSummary</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>modsDone</span>
<a name="line-648"></a>          <span class='hs-varid'>hsc_env1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-649"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>hpt4</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>hsc_env1</span>
<a name="line-650"></a>              <span class='hs-comment'>-- We must change the lifetime to TFL_CurrentModule for any temp</span>
<a name="line-651"></a>              <span class='hs-comment'>-- file created for an element of mod_to_clean during the upsweep.</span>
<a name="line-652"></a>              <span class='hs-comment'>-- These include preprocessed files and object files for loaded</span>
<a name="line-653"></a>              <span class='hs-comment'>-- modules.</span>
<a name="line-654"></a>              <span class='hs-varid'>unneeded_temps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concat</span>
<a name="line-655"></a>                <span class='hs-keyglyph'>[</span><span class='hs-varid'>ms_hspp_file</span> <span class='hs-conop'>:</span> <span class='hs-varid'>object_files</span>
<a name="line-656"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ModSummary</span><span class='hs-layout'>{</span><span class='hs-varid'>ms_mod</span><span class='hs-layout'>,</span> <span class='hs-varid'>ms_hspp_file</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mods_to_clean</span>
<a name="line-657"></a>                <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>object_files</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybe</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>linkableObjs</span> <span class='hs-varop'>$</span>
<a name="line-658"></a>                        <span class='hs-varid'>lookupHpt</span> <span class='hs-varid'>hpt4</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>ms_mod</span><span class='hs-layout'>)</span>
<a name="line-659"></a>                        <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>hm_linkable</span>
<a name="line-660"></a>                <span class='hs-keyglyph'>]</span>
<a name="line-661"></a>          <span class='hs-varid'>tmpfs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hsc_tmpfs</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getSession</span>
<a name="line-662"></a>          <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>changeTempFilesLifetime</span> <span class='hs-varid'>tmpfs</span> <span class='hs-conid'>TFL_CurrentModule</span> <span class='hs-varid'>unneeded_temps</span>
<a name="line-663"></a>          <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cleanCurrentModuleTempFiles</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>tmpfs</span> <span class='hs-varid'>dflags</span>
<a name="line-664"></a>
<a name="line-665"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>hpt5</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>retainInTopLevelEnvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ms_mod_name</span> <span class='hs-varid'>mods_to_keep</span><span class='hs-layout'>)</span>
<a name="line-666"></a>                                          <span class='hs-varid'>hpt4</span>
<a name="line-667"></a>
<a name="line-668"></a>          <span class='hs-comment'>-- Clean up after ourselves</span>
<a name="line-669"></a>
<a name="line-670"></a>          <span class='hs-comment'>-- there should be no Nothings where linkables should be, now</span>
<a name="line-671"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>just_linkables</span> <span class='hs-keyglyph'>=</span>
<a name="line-672"></a>                    <span class='hs-varid'>isNoLink</span> <span class='hs-layout'>(</span><span class='hs-varid'>ghcLink</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-673"></a>                 <span class='hs-varop'>||</span> <span class='hs-varid'>allHpt</span> <span class='hs-layout'>(</span><span class='hs-varid'>isJust</span><span class='hs-varop'>.</span><span class='hs-varid'>hm_linkable</span><span class='hs-layout'>)</span>
<a name="line-674"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>filterHpt</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>==</span> <span class='hs-conid'>HsSrcFile</span><span class='hs-layout'>)</span><span class='hs-varop'>.</span><span class='hs-varid'>mi_hsc_src</span><span class='hs-varop'>.</span><span class='hs-varid'>hm_iface</span><span class='hs-layout'>)</span>
<a name="line-675"></a>                                <span class='hs-varid'>hpt5</span><span class='hs-layout'>)</span>
<a name="line-676"></a>          <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>just_linkables</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>do</span>
<a name="line-677"></a>
<a name="line-678"></a>          <span class='hs-comment'>-- Link everything together</span>
<a name="line-679"></a>          <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-680"></a>          <span class='hs-varid'>linkresult</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>link</span> <span class='hs-layout'>(</span><span class='hs-varid'>ghcLink</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-681"></a>                                      <span class='hs-varid'>logger</span>
<a name="line-682"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>hsc_tmpfs</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-683"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>hsc_hooks</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-684"></a>                                      <span class='hs-varid'>dflags</span>
<a name="line-685"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>hsc_unit_env</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-686"></a>                                      <span class='hs-conid'>False</span>
<a name="line-687"></a>                                      <span class='hs-varid'>hpt5</span>
<a name="line-688"></a>
<a name="line-689"></a>          <span class='hs-varid'>modifySession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsc_HPT</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hpt5</span> <span class='hs-layout'>}</span>
<a name="line-690"></a>          <span class='hs-varid'>loadFinish</span> <span class='hs-conid'>Failed</span> <span class='hs-varid'>linkresult</span>
<a name="line-691"></a>
<a name="line-692"></a><a name="partitionNodes"></a><span class='hs-definition'>partitionNodes</span>
<a name="line-693"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleGraphNode</span><span class='hs-keyglyph'>]</span>
<a name="line-694"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InstantiatedUnit</span><span class='hs-keyglyph'>]</span>
<a name="line-695"></a>     <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ExtendedModSummary</span><span class='hs-keyglyph'>]</span>
<a name="line-696"></a>     <span class='hs-layout'>)</span>
<a name="line-697"></a><span class='hs-definition'>partitionNodes</span> <span class='hs-varid'>ns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionEithers</span> <span class='hs-varop'>$</span> <span class='hs-varid'>flip</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>ns</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>case</span>
<a name="line-698"></a>  <span class='hs-conid'>InstantiationNode</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-varid'>x</span>
<a name="line-699"></a>  <span class='hs-conid'>ModuleNode</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>x</span>
<a name="line-700"></a>
<a name="line-701"></a><a name="loadFinish"></a><span class='hs-comment'>-- | Finish up after a load.</span>
<a name="line-702"></a><span class='hs-definition'>loadFinish</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>SuccessFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SuccessFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>SuccessFlag</span>
<a name="line-703"></a>
<a name="line-704"></a><span class='hs-comment'>-- If the link failed, unload everything and return.</span>
<a name="line-705"></a><span class='hs-definition'>loadFinish</span> <span class='hs-sel'>_all_ok</span> <span class='hs-conid'>Failed</span>
<a name="line-706"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-707"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>interp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hscInterp</span> <span class='hs-varid'>hsc_env</span>
<a name="line-708"></a>       <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unload</span> <span class='hs-varid'>interp</span> <span class='hs-varid'>hsc_env</span> <span class='hs-conid'>[]</span>
<a name="line-709"></a>       <span class='hs-varid'>modifySession</span> <span class='hs-varid'>discardProg</span>
<a name="line-710"></a>       <span class='hs-varid'>return</span> <span class='hs-conid'>Failed</span>
<a name="line-711"></a>
<a name="line-712"></a><span class='hs-comment'>-- Empty the interactive context and set the module context to the topmost</span>
<a name="line-713"></a><span class='hs-comment'>-- newly loaded module, or the Prelude if none were loaded.</span>
<a name="line-714"></a><span class='hs-definition'>loadFinish</span> <span class='hs-varid'>all_ok</span> <span class='hs-conid'>Succeeded</span>
<a name="line-715"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>modifySession</span> <span class='hs-varid'>discardIC</span>
<a name="line-716"></a>       <span class='hs-varid'>return</span> <span class='hs-varid'>all_ok</span>
<a name="line-717"></a>
<a name="line-718"></a>
<a name="line-719"></a><a name="discardProg"></a><span class='hs-comment'>-- | Forget the current program, but retain the persistent info in HscEnv</span>
<a name="line-720"></a><span class='hs-definition'>discardProg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscEnv</span>
<a name="line-721"></a><span class='hs-definition'>discardProg</span> <span class='hs-varid'>hsc_env</span>
<a name="line-722"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>discardIC</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_mod_graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyMG</span>
<a name="line-723"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>hsc_HPT</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyHomePackageTable</span> <span class='hs-layout'>}</span>
<a name="line-724"></a>
<a name="line-725"></a><a name="discardIC"></a><span class='hs-comment'>-- | Discard the contents of the InteractiveContext, but keep the DynFlags and</span>
<a name="line-726"></a><span class='hs-comment'>-- the loaded plugins.  It will also keep ic_int_print and ic_monad if their</span>
<a name="line-727"></a><span class='hs-comment'>-- names are from external packages.</span>
<a name="line-728"></a><span class='hs-definition'>discardIC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscEnv</span>
<a name="line-729"></a><span class='hs-definition'>discardIC</span> <span class='hs-varid'>hsc_env</span>
<a name="line-730"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty_ic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_int_print</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_ic_int_print</span>
<a name="line-731"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>ic_monad</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_ic_monad</span>
<a name="line-732"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>ic_plugins</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_plugins</span>
<a name="line-733"></a>                                <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-734"></a>  <span class='hs-keyword'>where</span>
<a name="line-735"></a>  <span class='hs-comment'>-- Force the new values for ic_int_print and ic_monad to avoid leaking old_ic</span>
<a name="line-736"></a>  <span class='hs-varop'>!</span><span class='hs-varid'>new_ic_int_print</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>keep_external_name</span> <span class='hs-varid'>ic_int_print</span>
<a name="line-737"></a>  <span class='hs-varop'>!</span><span class='hs-varid'>new_ic_monad</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>keep_external_name</span> <span class='hs-varid'>ic_monad</span>
<a name="line-738"></a>  <span class='hs-varop'>!</span><span class='hs-varid'>old_plugins</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_plugins</span> <span class='hs-varid'>old_ic</span>
<a name="line-739"></a>  <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_dflags</span> <span class='hs-varid'>old_ic</span>
<a name="line-740"></a>  <span class='hs-varid'>old_ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span>
<a name="line-741"></a>  <span class='hs-varid'>empty_ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyInteractiveContext</span> <span class='hs-varid'>dflags</span>
<a name="line-742"></a>  <span class='hs-varid'>keep_external_name</span> <span class='hs-varid'>ic_name</span>
<a name="line-743"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>nameIsFromExternalPackage</span> <span class='hs-varid'>home_unit</span> <span class='hs-varid'>old_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_name</span>
<a name="line-744"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_name</span> <span class='hs-varid'>empty_ic</span>
<a name="line-745"></a>    <span class='hs-keyword'>where</span>
<a name="line-746"></a>    <span class='hs-varid'>home_unit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_home_unit</span> <span class='hs-varid'>hsc_env</span>
<a name="line-747"></a>    <span class='hs-varid'>old_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_name</span> <span class='hs-varid'>old_ic</span>
<a name="line-748"></a>
<a name="line-749"></a><a name="guessOutputFile"></a><span class='hs-comment'>-- | If there is no -o option, guess the name of target executable</span>
<a name="line-750"></a><span class='hs-comment'>-- by using top-level source file name as a base.</span>
<a name="line-751"></a><span class='hs-definition'>guessOutputFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-752"></a><span class='hs-definition'>guessOutputFile</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifySession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-753"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>env</span>
<a name="line-754"></a>        <span class='hs-comment'>-- Force mod_graph to avoid leaking env</span>
<a name="line-755"></a>        <span class='hs-varop'>!</span><span class='hs-varid'>mod_graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_mod_graph</span> <span class='hs-varid'>env</span>
<a name="line-756"></a>        <span class='hs-varid'>mainModuleSrcPath</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>String</span>
<a name="line-757"></a>        <span class='hs-varid'>mainModuleSrcPath</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-758"></a>            <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mgLookupModule</span> <span class='hs-varid'>mod_graph</span> <span class='hs-layout'>(</span><span class='hs-varid'>mainModIs</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-759"></a>            <span class='hs-varid'>ml_hs_file</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_location</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span>
<a name="line-760"></a>        <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>dropExtension</span> <span class='hs-varid'>mainModuleSrcPath</span>
<a name="line-761"></a>
<a name="line-762"></a>        <span class='hs-varid'>name_exe</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-763"></a><span class='hs-cpp'>#if defined(mingw32_HOST_OS)</span>
<a name="line-764"></a>          <span class='hs-comment'>-- we must add the .exe extension unconditionally here, otherwise</span>
<a name="line-765"></a>          <span class='hs-comment'>-- when name has an extension of its own, the .exe extension will</span>
<a name="line-766"></a>          <span class='hs-comment'>-- not be added by GHC.Driver.Pipeline.exeFileName.  See #2248</span>
<a name="line-767"></a>          <span class='hs-varid'>name'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;.&gt;</span> <span class='hs-str'>"exe"</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span>
<a name="line-768"></a><span class='hs-cpp'>#else</span>
<a name="line-769"></a>          <span class='hs-varid'>name'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>name</span>
<a name="line-770"></a><span class='hs-cpp'>#endif</span>
<a name="line-771"></a>          <span class='hs-varid'>mainModuleSrcPath'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mainModuleSrcPath</span>
<a name="line-772"></a>          <span class='hs-comment'>-- #9930: don't clobber input files (unless they ask for it)</span>
<a name="line-773"></a>          <span class='hs-keyword'>if</span> <span class='hs-varid'>name'</span> <span class='hs-varop'>==</span> <span class='hs-varid'>mainModuleSrcPath'</span>
<a name="line-774"></a>            <span class='hs-keyword'>then</span> <span class='hs-varid'>throwGhcException</span> <span class='hs-varop'>.</span> <span class='hs-conid'>UsageError</span> <span class='hs-varop'>$</span>
<a name="line-775"></a>                 <span class='hs-str'>"default output name would overwrite the input file; "</span> <span class='hs-varop'>++</span>
<a name="line-776"></a>                 <span class='hs-str'>"must specify -o explicitly"</span>
<a name="line-777"></a>            <span class='hs-keyword'>else</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>name'</span>
<a name="line-778"></a>    <span class='hs-keyword'>in</span>
<a name="line-779"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>outputFile_</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>of</span>
<a name="line-780"></a>        <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>env</span>
<a name="line-781"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>{</span> <span class='hs-varid'>outputFile_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name_exe</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-782"></a>
<a name="line-783"></a><a name="findPartiallyCompletedCycles"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-784"></a><span class='hs-comment'>--</span>
<a name="line-785"></a><span class='hs-comment'>-- | Return (names of) all those in modsDone who are part of a cycle as defined</span>
<a name="line-786"></a><span class='hs-comment'>-- by theGraph.</span>
<a name="line-787"></a><span class='hs-definition'>findPartiallyCompletedCycles</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-conid'>ModSummary</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Set.Set</span> <span class='hs-conid'>Module</span>
<a name="line-788"></a><span class='hs-definition'>findPartiallyCompletedCycles</span> <span class='hs-varid'>modsDone</span> <span class='hs-varid'>theGraph</span>
<a name="line-789"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Set.unions</span>
<a name="line-790"></a>       <span class='hs-keyglyph'>[</span><span class='hs-varid'>mods_in_this_cycle</span>
<a name="line-791"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CyclicSCC</span> <span class='hs-varid'>vs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>theGraph</span>  <span class='hs-comment'>-- Acyclic? Not interesting.</span>
<a name="line-792"></a>       <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>names_in_this_cycle</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Set.fromList</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ms_mod</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span>
<a name="line-793"></a>             <span class='hs-varid'>mods_in_this_cycle</span> <span class='hs-keyglyph'>=</span>
<a name="line-794"></a>                    <span class='hs-conid'>Set.intersection</span> <span class='hs-layout'>(</span><span class='hs-conid'>Set.fromList</span> <span class='hs-varid'>modsDone</span><span class='hs-layout'>)</span> <span class='hs-varid'>names_in_this_cycle</span>
<a name="line-795"></a>         <span class='hs-comment'>-- If size mods_in_this_cycle == size names_in_this_cycle,</span>
<a name="line-796"></a>         <span class='hs-comment'>-- then this cycle has already been completed and we're not</span>
<a name="line-797"></a>         <span class='hs-comment'>-- interested.</span>
<a name="line-798"></a>       <span class='hs-layout'>,</span> <span class='hs-conid'>Set.size</span> <span class='hs-varid'>mods_in_this_cycle</span> <span class='hs-varop'>&lt;</span> <span class='hs-conid'>Set.size</span> <span class='hs-varid'>names_in_this_cycle</span><span class='hs-keyglyph'>]</span>
<a name="line-799"></a>
<a name="line-800"></a>
<a name="line-801"></a><a name="unload"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-802"></a><span class='hs-comment'>--</span>
<a name="line-803"></a><span class='hs-comment'>-- | Unloading</span>
<a name="line-804"></a><span class='hs-definition'>unload</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Interp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Linkable</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-805"></a><span class='hs-definition'>unload</span> <span class='hs-varid'>interp</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>stable_linkables</span> <span class='hs-comment'>-- Unload everything *except* 'stable_linkables'</span>
<a name="line-806"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ghcLink</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-807"></a>        <span class='hs-conid'>LinkInMemory</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Linker.unload</span> <span class='hs-varid'>interp</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>stable_linkables</span>
<a name="line-808"></a>        <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-809"></a>
<a name="line-810"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-811"></a><span class='hs-comment'>{- |
<a name="line-812"></a>
<a name="line-813"></a>  Stability tells us which modules definitely do not need to be recompiled.
<a name="line-814"></a>  There are two main reasons for having stability:
<a name="line-815"></a>
<a name="line-816"></a>   - avoid doing a complete upsweep of the module graph in GHCi when
<a name="line-817"></a>     modules near the bottom of the tree have not changed.
<a name="line-818"></a>
<a name="line-819"></a>   - to tell GHCi when it can load object code: we can only load object code
<a name="line-820"></a>     for a module when we also load object code fo  all of the imports of the
<a name="line-821"></a>     module.  So we need to know that we will definitely not be recompiling
<a name="line-822"></a>     any of these modules, and we can use the object code.
<a name="line-823"></a>
<a name="line-824"></a>  The stability check is as follows.  Both stableObject and
<a name="line-825"></a>  stableBCO are used during the upsweep phase later.
<a name="line-826"></a>
<a name="line-827"></a>@
<a name="line-828"></a>  stable m = stableObject m || stableBCO m
<a name="line-829"></a>
<a name="line-830"></a>  stableObject m =
<a name="line-831"></a>        all stableObject (imports m)
<a name="line-832"></a>        &amp;&amp; old linkable does not exist, or is == on-disk .o
<a name="line-833"></a>        &amp;&amp; date(on-disk .o) &gt; date(.hs)
<a name="line-834"></a>
<a name="line-835"></a>  stableBCO m =
<a name="line-836"></a>        all stable (imports m)
<a name="line-837"></a>        &amp;&amp; date(BCO) &gt; date(.hs)
<a name="line-838"></a>@
<a name="line-839"></a>
<a name="line-840"></a>  These properties embody the following ideas:
<a name="line-841"></a>
<a name="line-842"></a>    - if a module is stable, then:
<a name="line-843"></a>
<a name="line-844"></a>        - if it has been compiled in a previous pass (present in HPT)
<a name="line-845"></a>          then it does not need to be compiled or re-linked.
<a name="line-846"></a>
<a name="line-847"></a>        - if it has not been compiled in a previous pass,
<a name="line-848"></a>          then we only need to read its .hi file from disk and
<a name="line-849"></a>          link it to produce a 'ModDetails'.
<a name="line-850"></a>
<a name="line-851"></a>    - if a modules is not stable, we will definitely be at least
<a name="line-852"></a>      re-linking, and possibly re-compiling it during the 'upsweep'.
<a name="line-853"></a>      All non-stable modules can (and should) therefore be unlinked
<a name="line-854"></a>      before the 'upsweep'.
<a name="line-855"></a>
<a name="line-856"></a>    - Note that objects are only considered stable if they only depend
<a name="line-857"></a>      on other objects.  We can't link object code against byte code.
<a name="line-858"></a>
<a name="line-859"></a>    - Note that even if an object is stable, we may end up recompiling
<a name="line-860"></a>      if the interface is out of date because an *external* interface
<a name="line-861"></a>      has changed.  The current code in GHC.Driver.Make handles this case
<a name="line-862"></a>      fairly poorly, so be careful.
<a name="line-863"></a>-}</span>
<a name="line-864"></a>
<a name="line-865"></a><a name="StableModules"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>StableModules</span> <span class='hs-keyglyph'>=</span>
<a name="line-866"></a>  <span class='hs-layout'>(</span> <span class='hs-conid'>UniqSet</span> <span class='hs-conid'>ModuleName</span>  <span class='hs-comment'>-- stableObject</span>
<a name="line-867"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>UniqSet</span> <span class='hs-conid'>ModuleName</span>  <span class='hs-comment'>-- stableBCO</span>
<a name="line-868"></a>  <span class='hs-layout'>)</span>
<a name="line-869"></a>
<a name="line-870"></a>
<a name="line-871"></a><a name="checkStability"></a><span class='hs-definition'>checkStability</span>
<a name="line-872"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HomePackageTable</span>   <span class='hs-comment'>-- HPT from last compilation</span>
<a name="line-873"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-conid'>ModSummary</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- current module graph (cyclic)</span>
<a name="line-874"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSet</span> <span class='hs-conid'>ModuleName</span> <span class='hs-comment'>-- all home modules</span>
<a name="line-875"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StableModules</span>
<a name="line-876"></a>
<a name="line-877"></a><span class='hs-definition'>checkStability</span> <span class='hs-varid'>hpt</span> <span class='hs-varid'>sccs</span> <span class='hs-varid'>all_home_mods</span> <span class='hs-keyglyph'>=</span>
<a name="line-878"></a>  <span class='hs-varid'>foldl'</span> <span class='hs-varid'>checkSCC</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyUniqSet</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyUniqSet</span><span class='hs-layout'>)</span> <span class='hs-varid'>sccs</span>
<a name="line-879"></a>  <span class='hs-keyword'>where</span>
<a name="line-880"></a>   <span class='hs-varid'>checkSCC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StableModules</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SCC</span> <span class='hs-conid'>ModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StableModules</span>
<a name="line-881"></a>   <span class='hs-varid'>checkSCC</span> <span class='hs-layout'>(</span><span class='hs-varid'>stable_obj</span><span class='hs-layout'>,</span> <span class='hs-varid'>stable_bco</span><span class='hs-layout'>)</span> <span class='hs-varid'>scc0</span>
<a name="line-882"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>stableObjects</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>addListToUniqSet</span> <span class='hs-varid'>stable_obj</span> <span class='hs-varid'>scc_mods</span><span class='hs-layout'>,</span> <span class='hs-varid'>stable_bco</span><span class='hs-layout'>)</span>
<a name="line-883"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>stableBCOs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>stable_obj</span><span class='hs-layout'>,</span> <span class='hs-varid'>addListToUniqSet</span> <span class='hs-varid'>stable_bco</span> <span class='hs-varid'>scc_mods</span><span class='hs-layout'>)</span>
<a name="line-884"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>stable_obj</span><span class='hs-layout'>,</span> <span class='hs-varid'>stable_bco</span><span class='hs-layout'>)</span>
<a name="line-885"></a>     <span class='hs-keyword'>where</span>
<a name="line-886"></a>        <span class='hs-varid'>scc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flattenSCC</span> <span class='hs-varid'>scc0</span>
<a name="line-887"></a>        <span class='hs-varid'>scc_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>ms_mod_name</span> <span class='hs-varid'>scc</span>
<a name="line-888"></a>        <span class='hs-varid'>home_module</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span>
<a name="line-889"></a>          <span class='hs-varid'>m</span> <span class='hs-varop'>`elementOfUniqSet`</span> <span class='hs-varid'>all_home_mods</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>m</span> <span class='hs-varop'>`notElem`</span> <span class='hs-varid'>scc_mods</span>
<a name="line-890"></a>
<a name="line-891"></a>        <span class='hs-varid'>scc_allimps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nub</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-varid'>home_module</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-varid'>ms_home_allimps</span> <span class='hs-varid'>scc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-892"></a>            <span class='hs-comment'>-- all imports outside the current SCC, but in the home pkg</span>
<a name="line-893"></a>
<a name="line-894"></a>        <span class='hs-varid'>stable_obj_imps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elementOfUniqSet`</span> <span class='hs-varid'>stable_obj</span><span class='hs-layout'>)</span> <span class='hs-varid'>scc_allimps</span>
<a name="line-895"></a>        <span class='hs-varid'>stable_bco_imps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elementOfUniqSet`</span> <span class='hs-varid'>stable_bco</span><span class='hs-layout'>)</span> <span class='hs-varid'>scc_allimps</span>
<a name="line-896"></a>
<a name="line-897"></a>        <span class='hs-varid'>stableObjects</span> <span class='hs-keyglyph'>=</span>
<a name="line-898"></a>           <span class='hs-varid'>and</span> <span class='hs-varid'>stable_obj_imps</span>
<a name="line-899"></a>           <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>all</span> <span class='hs-varid'>object_ok</span> <span class='hs-varid'>scc</span>
<a name="line-900"></a>
<a name="line-901"></a>        <span class='hs-varid'>stableBCOs</span> <span class='hs-keyglyph'>=</span>
<a name="line-902"></a>           <span class='hs-varid'>and</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-varop'>||</span><span class='hs-layout'>)</span> <span class='hs-varid'>stable_obj_imps</span> <span class='hs-varid'>stable_bco_imps</span><span class='hs-layout'>)</span>
<a name="line-903"></a>           <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>all</span> <span class='hs-varid'>bco_ok</span> <span class='hs-varid'>scc</span>
<a name="line-904"></a>
<a name="line-905"></a>        <span class='hs-varid'>object_ok</span> <span class='hs-varid'>ms</span>
<a name="line-906"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_ForceRecomp</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_hspp_opts</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-907"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ms_obj_date</span> <span class='hs-varid'>ms</span>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>t</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>ms_hs_date</span> <span class='hs-varid'>ms</span>
<a name="line-908"></a>                                         <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>same_as_prev</span> <span class='hs-varid'>t</span>
<a name="line-909"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-910"></a>          <span class='hs-keyword'>where</span>
<a name="line-911"></a>             <span class='hs-varid'>same_as_prev</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupHpt</span> <span class='hs-varid'>hpt</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_mod_name</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-912"></a>                                <span class='hs-conid'>Just</span> <span class='hs-varid'>hmi</span>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hm_linkable</span> <span class='hs-varid'>hmi</span>
<a name="line-913"></a>                                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isObjectLinkable</span> <span class='hs-varid'>l</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>t</span> <span class='hs-varop'>==</span> <span class='hs-varid'>linkableTime</span> <span class='hs-varid'>l</span>
<a name="line-914"></a>                                <span class='hs-sel'>_other</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-915"></a>                <span class='hs-comment'>-- why '&gt;=' rather than '&gt;' above?  If the filesystem stores</span>
<a name="line-916"></a>                <span class='hs-comment'>-- times to the nearest second, we may occasionally find that</span>
<a name="line-917"></a>                <span class='hs-comment'>-- the object &amp; source have the same modification time,</span>
<a name="line-918"></a>                <span class='hs-comment'>-- especially if the source was automatically generated</span>
<a name="line-919"></a>                <span class='hs-comment'>-- and compiled.  Using &gt;= is slightly unsafe, but it matches</span>
<a name="line-920"></a>                <span class='hs-comment'>-- make's behaviour.</span>
<a name="line-921"></a>                <span class='hs-comment'>--</span>
<a name="line-922"></a>                <span class='hs-comment'>-- But see #5527, where someone ran into this and it caused</span>
<a name="line-923"></a>                <span class='hs-comment'>-- a problem.</span>
<a name="line-924"></a>
<a name="line-925"></a>        <span class='hs-varid'>bco_ok</span> <span class='hs-varid'>ms</span>
<a name="line-926"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_ForceRecomp</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_hspp_opts</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-927"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupHpt</span> <span class='hs-varid'>hpt</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_mod_name</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-928"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>hmi</span>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hm_linkable</span> <span class='hs-varid'>hmi</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-929"></a>                        <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isObjectLinkable</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-930"></a>                        <span class='hs-varid'>linkableTime</span> <span class='hs-varid'>l</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>ms_hs_date</span> <span class='hs-varid'>ms</span>
<a name="line-931"></a>                <span class='hs-sel'>_other</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-932"></a>
<a name="line-933"></a><span class='hs-comment'>{- Parallel Upsweep
<a name="line-934"></a> -
<a name="line-935"></a> - The parallel upsweep attempts to concurrently compile the modules in the
<a name="line-936"></a> - compilation graph using multiple Haskell threads.
<a name="line-937"></a> -
<a name="line-938"></a> - The Algorithm
<a name="line-939"></a> -
<a name="line-940"></a> - A Haskell thread is spawned for each module in the module graph, waiting for
<a name="line-941"></a> - its direct dependencies to finish building before it itself begins to build.
<a name="line-942"></a> -
<a name="line-943"></a> - Each module is associated with an initially empty MVar that stores the
<a name="line-944"></a> - result of that particular module's compile. If the compile succeeded, then
<a name="line-945"></a> - the HscEnv (synchronized by an MVar) is updated with the fresh HMI of that
<a name="line-946"></a> - module, and the module's HMI is deleted from the old HPT (synchronized by an
<a name="line-947"></a> - IORef) to save space.
<a name="line-948"></a> -
<a name="line-949"></a> - Instead of immediately outputting messages to the standard handles, all
<a name="line-950"></a> - compilation output is deferred to a per-module TQueue. A QSem is used to
<a name="line-951"></a> - limit the number of workers that are compiling simultaneously.
<a name="line-952"></a> -
<a name="line-953"></a> - Meanwhile, the main thread sequentially loops over all the modules in the
<a name="line-954"></a> - module graph, outputting the messages stored in each module's TQueue.
<a name="line-955"></a>-}</span>
<a name="line-956"></a>
<a name="line-957"></a><a name="LogQueue"></a><span class='hs-comment'>-- | Each module is given a unique 'LogQueue' to redirect compilation messages</span>
<a name="line-958"></a><a name="LogQueue"></a><span class='hs-comment'>-- to. A 'Nothing' value contains the result of compilation, and denotes the</span>
<a name="line-959"></a><a name="LogQueue"></a><span class='hs-comment'>-- end of the message queue.</span>
<a name="line-960"></a><a name="LogQueue"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>LogQueue</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LogQueue</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>WarnReason</span><span class='hs-layout'>,</span> <span class='hs-conid'>Severity</span><span class='hs-layout'>,</span> <span class='hs-conid'>SrcSpan</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-961"></a>                         <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>MVar</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-962"></a>
<a name="line-963"></a><a name="CompilationGraph"></a><span class='hs-comment'>-- | The graph of modules to compile and their corresponding result 'MVar' and</span>
<a name="line-964"></a><a name="CompilationGraph"></a><span class='hs-comment'>-- 'LogQueue'.</span>
<a name="line-965"></a><a name="CompilationGraph"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CompilationGraph</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>ModuleGraphNode</span><span class='hs-layout'>,</span> <span class='hs-conid'>MVar</span> <span class='hs-conid'>SuccessFlag</span><span class='hs-layout'>,</span> <span class='hs-conid'>LogQueue</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-966"></a>
<a name="line-967"></a><a name="buildCompGraph"></a><span class='hs-comment'>-- | Build a 'CompilationGraph' out of a list of strongly-connected modules,</span>
<a name="line-968"></a><span class='hs-comment'>-- also returning the first, if any, encountered module cycle.</span>
<a name="line-969"></a><span class='hs-definition'>buildCompGraph</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-conid'>ModuleGraphNode</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>CompilationGraph</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleGraphNode</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-970"></a><span class='hs-definition'>buildCompGraph</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-971"></a><span class='hs-definition'>buildCompGraph</span> <span class='hs-layout'>(</span><span class='hs-varid'>scc</span><span class='hs-conop'>:</span><span class='hs-varid'>sccs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>scc</span> <span class='hs-keyword'>of</span>
<a name="line-972"></a>    <span class='hs-conid'>AcyclicSCC</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-973"></a>        <span class='hs-varid'>mvar</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEmptyMVar</span>
<a name="line-974"></a>        <span class='hs-varid'>log_queue</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>do</span>
<a name="line-975"></a>            <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newIORef</span> <span class='hs-conid'>[]</span>
<a name="line-976"></a>            <span class='hs-varid'>sem</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEmptyMVar</span>
<a name="line-977"></a>            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>LogQueue</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>sem</span><span class='hs-layout'>)</span>
<a name="line-978"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>rest</span><span class='hs-layout'>,</span><span class='hs-varid'>cycle</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>buildCompGraph</span> <span class='hs-varid'>sccs</span>
<a name="line-979"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>ms</span><span class='hs-layout'>,</span><span class='hs-varid'>mvar</span><span class='hs-layout'>,</span><span class='hs-varid'>log_queue</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>rest</span><span class='hs-layout'>,</span> <span class='hs-varid'>cycle</span><span class='hs-layout'>)</span>
<a name="line-980"></a>    <span class='hs-conid'>CyclicSCC</span> <span class='hs-varid'>mss</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>mss</span><span class='hs-layout'>)</span>
<a name="line-981"></a>
<a name="line-982"></a><a name="BuildModule"></a><span class='hs-comment'>-- | A Module and whether it is a boot module.</span>
<a name="line-983"></a><a name="BuildModule"></a><span class='hs-comment'>--</span>
<a name="line-984"></a><a name="BuildModule"></a><span class='hs-comment'>-- We need to treat boot modules specially when building compilation graphs,</span>
<a name="line-985"></a><a name="BuildModule"></a><span class='hs-comment'>-- since they break cycles. Regular source files and signature files are treated</span>
<a name="line-986"></a><a name="BuildModule"></a><span class='hs-comment'>-- equivalently.</span>
<a name="line-987"></a><a name="BuildModule"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>BuildModule</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BuildModule_Unit</span> <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>InstantiatedUnit</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BuildModule_Module</span> <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>ModuleWithIsBoot</span>
<a name="line-988"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span><span class='hs-layout'>)</span>
<a name="line-989"></a>
<a name="line-990"></a><a name="hscSourceToIsBoot"></a><span class='hs-comment'>-- | Tests if an 'HscSource' is a boot file, primarily for constructing elements</span>
<a name="line-991"></a><span class='hs-comment'>-- of 'BuildModule'. We conflate signatures and modules because they are bound</span>
<a name="line-992"></a><span class='hs-comment'>-- in the same namespace; only boot interfaces can be disambiguated with</span>
<a name="line-993"></a><span class='hs-comment'>-- `import {-# SOURCE #-}`.</span>
<a name="line-994"></a><span class='hs-definition'>hscSourceToIsBoot</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscSource</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsBootInterface</span>
<a name="line-995"></a><span class='hs-definition'>hscSourceToIsBoot</span> <span class='hs-conid'>HsBootFile</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IsBoot</span>
<a name="line-996"></a><span class='hs-definition'>hscSourceToIsBoot</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NotBoot</span>
<a name="line-997"></a>
<a name="line-998"></a><a name="mkBuildModule"></a><span class='hs-definition'>mkBuildModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleGraphNode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BuildModule</span>
<a name="line-999"></a><span class='hs-definition'>mkBuildModule</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>case</span>
<a name="line-1000"></a>  <span class='hs-conid'>InstantiationNode</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BuildModule_Unit</span> <span class='hs-varid'>x</span>
<a name="line-1001"></a>  <span class='hs-conid'>ModuleNode</span> <span class='hs-varid'>ems</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BuildModule_Module</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkBuildModule0</span> <span class='hs-layout'>(</span><span class='hs-varid'>emsModSummary</span> <span class='hs-varid'>ems</span><span class='hs-layout'>)</span>
<a name="line-1002"></a>
<a name="line-1003"></a><a name="mkHomeBuildModule"></a><span class='hs-definition'>mkHomeBuildModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleGraphNode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NodeKey</span>
<a name="line-1004"></a><span class='hs-definition'>mkHomeBuildModule</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>case</span>
<a name="line-1005"></a>  <span class='hs-conid'>InstantiationNode</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NodeKey_Unit</span> <span class='hs-varid'>x</span>
<a name="line-1006"></a>  <span class='hs-conid'>ModuleNode</span> <span class='hs-varid'>ems</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NodeKey_Module</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHomeBuildModule0</span> <span class='hs-layout'>(</span><span class='hs-varid'>emsModSummary</span> <span class='hs-varid'>ems</span><span class='hs-layout'>)</span>
<a name="line-1007"></a>
<a name="line-1008"></a><a name="mkBuildModule0"></a><span class='hs-definition'>mkBuildModule0</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleWithIsBoot</span>
<a name="line-1009"></a><span class='hs-definition'>mkBuildModule0</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GWIB</span>
<a name="line-1010"></a>  <span class='hs-layout'>{</span> <span class='hs-varid'>gwib_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_mod</span> <span class='hs-varid'>ms</span>
<a name="line-1011"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>gwib_isBoot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isBootSummary</span> <span class='hs-varid'>ms</span>
<a name="line-1012"></a>  <span class='hs-layout'>}</span>
<a name="line-1013"></a>
<a name="line-1014"></a><a name="mkHomeBuildModule0"></a><span class='hs-definition'>mkHomeBuildModule0</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleNameWithIsBoot</span>
<a name="line-1015"></a><span class='hs-definition'>mkHomeBuildModule0</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GWIB</span>
<a name="line-1016"></a>  <span class='hs-layout'>{</span> <span class='hs-varid'>gwib_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ms_mod</span> <span class='hs-varid'>ms</span>
<a name="line-1017"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>gwib_isBoot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isBootSummary</span> <span class='hs-varid'>ms</span>
<a name="line-1018"></a>  <span class='hs-layout'>}</span>
<a name="line-1019"></a>
<a name="line-1020"></a><a name="parUpsweep"></a><span class='hs-comment'>-- | The entry point to the parallel upsweep.</span>
<a name="line-1021"></a><span class='hs-comment'>--</span>
<a name="line-1022"></a><span class='hs-comment'>-- See also the simpler, sequential 'upsweep'.</span>
<a name="line-1023"></a><span class='hs-definition'>parUpsweep</span>
<a name="line-1024"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span>
<a name="line-1025"></a>    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-1026"></a>    <span class='hs-comment'>-- ^ The number of workers we wish to run in parallel</span>
<a name="line-1027"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Messager</span>
<a name="line-1028"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HomePackageTable</span>
<a name="line-1029"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StableModules</span>
<a name="line-1030"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-conid'>ModuleGraphNode</span><span class='hs-keyglyph'>]</span>
<a name="line-1031"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>SuccessFlag</span><span class='hs-layout'>,</span>
<a name="line-1032"></a>          <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleGraphNode</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1033"></a><span class='hs-definition'>parUpsweep</span> <span class='hs-varid'>n_jobs</span> <span class='hs-varid'>mHscMessage</span> <span class='hs-varid'>old_hpt</span> <span class='hs-varid'>stable_mods</span> <span class='hs-varid'>sccs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1034"></a>    <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-1035"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1036"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_logger</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1037"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>tmpfs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_tmpfs</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1038"></a>
<a name="line-1039"></a>    <span class='hs-comment'>-- The bits of shared state we'll be using:</span>
<a name="line-1040"></a>
<a name="line-1041"></a>    <span class='hs-comment'>-- The global HscEnv is updated with the module's HMI when a module</span>
<a name="line-1042"></a>    <span class='hs-comment'>-- successfully compiles.</span>
<a name="line-1043"></a>    <span class='hs-varid'>hsc_env_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>newMVar</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1044"></a>
<a name="line-1045"></a>    <span class='hs-comment'>-- The old HPT is used for recompilation checking in upsweep_mod. When a</span>
<a name="line-1046"></a>    <span class='hs-comment'>-- module successfully gets compiled, its HMI is pruned from the old HPT.</span>
<a name="line-1047"></a>    <span class='hs-varid'>old_hpt_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>newIORef</span> <span class='hs-varid'>old_hpt</span>
<a name="line-1048"></a>
<a name="line-1049"></a>    <span class='hs-comment'>-- What we use to limit parallelism with.</span>
<a name="line-1050"></a>    <span class='hs-varid'>par_sem</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>newQSem</span> <span class='hs-varid'>n_jobs</span>
<a name="line-1051"></a>
<a name="line-1052"></a>
<a name="line-1053"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>updNumCapabilities</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1054"></a>            <span class='hs-varid'>n_capabilities</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getNumCapabilities</span>
<a name="line-1055"></a>            <span class='hs-varid'>n_cpus</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getNumProcessors</span>
<a name="line-1056"></a>            <span class='hs-comment'>-- Setting number of capabilities more than</span>
<a name="line-1057"></a>            <span class='hs-comment'>-- CPU count usually leads to high userspace</span>
<a name="line-1058"></a>            <span class='hs-comment'>-- lock contention. #9221</span>
<a name="line-1059"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>n_caps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>min</span> <span class='hs-varid'>n_jobs</span> <span class='hs-varid'>n_cpus</span>
<a name="line-1060"></a>            <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_capabilities</span> <span class='hs-varop'>/=</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>setNumCapabilities</span> <span class='hs-varid'>n_caps</span>
<a name="line-1061"></a>            <span class='hs-varid'>return</span> <span class='hs-varid'>n_capabilities</span>
<a name="line-1062"></a>    <span class='hs-comment'>-- Reset the number of capabilities once the upsweep ends.</span>
<a name="line-1063"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>resetNumCapabilities</span> <span class='hs-varid'>orig_n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>setNumCapabilities</span> <span class='hs-varid'>orig_n</span>
<a name="line-1064"></a>
<a name="line-1065"></a>    <span class='hs-conid'>MC.bracket</span> <span class='hs-varid'>updNumCapabilities</span> <span class='hs-varid'>resetNumCapabilities</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1066"></a>
<a name="line-1067"></a>    <span class='hs-comment'>-- Sync the global session with the latest HscEnv once the upsweep ends.</span>
<a name="line-1068"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>finallySyncSession</span> <span class='hs-varid'>io</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>io</span> <span class='hs-varop'>`MC.finally`</span> <span class='hs-keyword'>do</span>
<a name="line-1069"></a>            <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>readMVar</span> <span class='hs-varid'>hsc_env_var</span>
<a name="line-1070"></a>            <span class='hs-varid'>setSession</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1071"></a>
<a name="line-1072"></a>    <span class='hs-varid'>finallySyncSession</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1073"></a>
<a name="line-1074"></a>    <span class='hs-comment'>-- Build the compilation graph out of the list of SCCs. Module cycles are</span>
<a name="line-1075"></a>    <span class='hs-comment'>-- handled at the very end, after some useful work gets done. Note that</span>
<a name="line-1076"></a>    <span class='hs-comment'>-- this list is topologically sorted (by virtue of 'sccs' being sorted so).</span>
<a name="line-1077"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>comp_graph</span><span class='hs-layout'>,</span><span class='hs-varid'>cycle</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>buildCompGraph</span> <span class='hs-varid'>sccs</span>
<a name="line-1078"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>comp_graph_w_idx</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zip</span> <span class='hs-varid'>comp_graph</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span>
<a name="line-1079"></a>
<a name="line-1080"></a>    <span class='hs-comment'>-- The list of all loops in the compilation graph.</span>
<a name="line-1081"></a>    <span class='hs-comment'>-- NB: For convenience, the last module of each loop (aka the module that</span>
<a name="line-1082"></a>    <span class='hs-comment'>-- finishes the loop) is prepended to the beginning of the loop.</span>
<a name="line-1083"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fstOf3</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>comp_graph</span><span class='hs-layout'>)</span>
<a name="line-1084"></a>        <span class='hs-varid'>boot_modules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkModuleSet</span>
<a name="line-1085"></a>          <span class='hs-keyglyph'>[</span><span class='hs-varid'>ms_mod</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ModuleNode</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExtendedModSummary</span> <span class='hs-varid'>ms</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>graph</span><span class='hs-layout'>,</span> <span class='hs-varid'>isBootSummary</span> <span class='hs-varid'>ms</span> <span class='hs-varop'>==</span> <span class='hs-conid'>IsBoot</span><span class='hs-keyglyph'>]</span>
<a name="line-1086"></a>        <span class='hs-varid'>comp_graph_loops</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>graph</span> <span class='hs-varid'>boot_modules</span>
<a name="line-1087"></a>          <span class='hs-keyword'>where</span>
<a name="line-1088"></a>            <span class='hs-varid'>remove</span> <span class='hs-varid'>ms</span> <span class='hs-varid'>bm</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>isBootSummary</span> <span class='hs-varid'>ms</span> <span class='hs-keyword'>of</span>
<a name="line-1089"></a>              <span class='hs-conid'>IsBoot</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>delModuleSet</span> <span class='hs-varid'>bm</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_mod</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span>
<a name="line-1090"></a>              <span class='hs-conid'>NotBoot</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bm</span>
<a name="line-1091"></a>            <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-1092"></a>            <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstantiationNode</span> <span class='hs-keyword'>_</span> <span class='hs-conop'>:</span> <span class='hs-varid'>mss</span><span class='hs-layout'>)</span> <span class='hs-varid'>boot_modules</span>
<a name="line-1093"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>mss</span> <span class='hs-varid'>boot_modules</span>
<a name="line-1094"></a>            <span class='hs-varid'>go</span> <span class='hs-varid'>mg</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>mnode</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ModuleNode</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExtendedModSummary</span> <span class='hs-varid'>ms</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>mss</span><span class='hs-layout'>)</span> <span class='hs-varid'>boot_modules</span>
<a name="line-1095"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>loop</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModLoop</span> <span class='hs-varid'>ms</span> <span class='hs-varid'>mg</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemModuleSet`</span> <span class='hs-varid'>boot_modules</span><span class='hs-layout'>)</span>
<a name="line-1096"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>mkBuildModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>mnode</span> <span class='hs-conop'>:</span> <span class='hs-varid'>loop</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>go</span> <span class='hs-varid'>mss</span> <span class='hs-layout'>(</span><span class='hs-varid'>remove</span> <span class='hs-varid'>ms</span> <span class='hs-varid'>boot_modules</span><span class='hs-layout'>)</span>
<a name="line-1097"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1098"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>mss</span> <span class='hs-layout'>(</span><span class='hs-varid'>remove</span> <span class='hs-varid'>ms</span> <span class='hs-varid'>boot_modules</span><span class='hs-layout'>)</span>
<a name="line-1099"></a>
<a name="line-1100"></a>    <span class='hs-comment'>-- Build a Map out of the compilation graph with which we can efficiently</span>
<a name="line-1101"></a>    <span class='hs-comment'>-- look up the result MVar associated with a particular home module.</span>
<a name="line-1102"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>home_mod_map</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>BuildModule</span> <span class='hs-layout'>(</span><span class='hs-conid'>MVar</span> <span class='hs-conid'>SuccessFlag</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-1103"></a>        <span class='hs-varid'>home_mod_map</span> <span class='hs-keyglyph'>=</span>
<a name="line-1104"></a>            <span class='hs-conid'>Map.fromList</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkBuildModule</span> <span class='hs-varid'>ms</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>mvar</span><span class='hs-layout'>,</span> <span class='hs-varid'>idx</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1105"></a>                         <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>ms</span><span class='hs-layout'>,</span><span class='hs-varid'>mvar</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>idx</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>comp_graph_w_idx</span> <span class='hs-keyglyph'>]</span>
<a name="line-1106"></a>
<a name="line-1107"></a>
<a name="line-1108"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>label_self</span> <span class='hs-str'>"main --make thread"</span>
<a name="line-1109"></a>
<a name="line-1110"></a>    <span class='hs-comment'>-- Make the logger thread_safe: we only make the "log" action thread-safe in</span>
<a name="line-1111"></a>    <span class='hs-comment'>-- each worker by setting a LogAction hook, so we need to make the logger</span>
<a name="line-1112"></a>    <span class='hs-comment'>-- thread-safe for other actions (DumpAction, TraceAction).</span>
<a name="line-1113"></a>    <span class='hs-varid'>thread_safe_logger</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>makeThreadSafe</span> <span class='hs-varid'>logger</span>
<a name="line-1114"></a>
<a name="line-1115"></a>    <span class='hs-comment'>-- For each module in the module graph, spawn a worker thread that will</span>
<a name="line-1116"></a>    <span class='hs-comment'>-- compile this module.</span>
<a name="line-1117"></a>    <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>spawnWorkers</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>forM</span> <span class='hs-varid'>comp_graph_w_idx</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>mod</span><span class='hs-layout'>,</span><span class='hs-varop'>!</span><span class='hs-varid'>mvar</span><span class='hs-layout'>,</span><span class='hs-varop'>!</span><span class='hs-varid'>log_queue</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varop'>!</span><span class='hs-varid'>mod_idx</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1118"></a>            <span class='hs-varid'>forkIOWithUnmask</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>unmask</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1119"></a>                <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>label_self</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unwords</span> <span class='hs-varop'>$</span> <span class='hs-varid'>concat</span>
<a name="line-1120"></a>                    <span class='hs-keyglyph'>[</span> <span class='hs-keyglyph'>[</span> <span class='hs-str'>"worker --make thread"</span> <span class='hs-keyglyph'>]</span>
<a name="line-1121"></a>                    <span class='hs-layout'>,</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mod</span> <span class='hs-keyword'>of</span>
<a name="line-1122"></a>                        <span class='hs-conid'>InstantiationNode</span> <span class='hs-varid'>iuid</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1123"></a>                          <span class='hs-keyglyph'>[</span> <span class='hs-str'>"for instantiation of unit"</span>
<a name="line-1124"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>show</span> <span class='hs-varop'>$</span> <span class='hs-conid'>VirtUnit</span> <span class='hs-varid'>iuid</span>
<a name="line-1125"></a>                          <span class='hs-keyglyph'>]</span>
<a name="line-1126"></a>                        <span class='hs-conid'>ModuleNode</span> <span class='hs-varid'>ems</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1127"></a>                          <span class='hs-keyglyph'>[</span> <span class='hs-str'>"for module"</span>
<a name="line-1128"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleNameString</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_mod_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>emsModSummary</span> <span class='hs-varid'>ems</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1129"></a>                          <span class='hs-keyglyph'>]</span>
<a name="line-1130"></a>                    <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"number"</span>
<a name="line-1131"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>show</span> <span class='hs-varid'>mod_idx</span>
<a name="line-1132"></a>                      <span class='hs-keyglyph'>]</span>
<a name="line-1133"></a>                    <span class='hs-keyglyph'>]</span>
<a name="line-1134"></a>                <span class='hs-comment'>-- Replace the default log_action with one that writes each</span>
<a name="line-1135"></a>                <span class='hs-comment'>-- message to the module's log_queue. The main thread will</span>
<a name="line-1136"></a>                <span class='hs-comment'>-- deal with synchronously printing these messages.</span>
<a name="line-1137"></a>                <span class='hs-keyword'>let</span> <span class='hs-varid'>lcl_logger</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pushLogHook</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-layout'>(</span><span class='hs-varid'>parLogAction</span> <span class='hs-varid'>log_queue</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>thread_safe_logger</span>
<a name="line-1138"></a>
<a name="line-1139"></a>                <span class='hs-comment'>-- Use a local TmpFs so that we can clean up intermediate files</span>
<a name="line-1140"></a>                <span class='hs-comment'>-- in a timely fashion (as soon as compilation for that module</span>
<a name="line-1141"></a>                <span class='hs-comment'>-- is finished) without having to worry about accidentally</span>
<a name="line-1142"></a>                <span class='hs-comment'>-- deleting a simultaneous compile's important files.</span>
<a name="line-1143"></a>                <span class='hs-varid'>lcl_tmpfs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forkTmpFsFrom</span> <span class='hs-varid'>tmpfs</span>
<a name="line-1144"></a>
<a name="line-1145"></a>                <span class='hs-comment'>-- Unmask asynchronous exceptions and perform the thread-local</span>
<a name="line-1146"></a>                <span class='hs-comment'>-- work to compile the module (see parUpsweep_one).</span>
<a name="line-1147"></a>                <span class='hs-varid'>m_res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>MC.try</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unmask</span> <span class='hs-varop'>$</span> <span class='hs-varid'>prettyPrintGhcErrors</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span>
<a name="line-1148"></a>                  <span class='hs-keyword'>case</span> <span class='hs-varid'>mod</span> <span class='hs-keyword'>of</span>
<a name="line-1149"></a>                    <span class='hs-conid'>InstantiationNode</span> <span class='hs-varid'>iuid</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1150"></a>                      <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMVar</span> <span class='hs-varid'>hsc_env_var</span>
<a name="line-1151"></a>                      <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>upsweep_inst</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mHscMessage</span> <span class='hs-varid'>mod_idx</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>sccs</span><span class='hs-layout'>)</span> <span class='hs-varid'>iuid</span>
<a name="line-1152"></a>                      <span class='hs-varid'>pure</span> <span class='hs-conid'>Succeeded</span>
<a name="line-1153"></a>                    <span class='hs-conid'>ModuleNode</span> <span class='hs-varid'>ems</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1154"></a>                      <span class='hs-varid'>parUpsweep_one</span> <span class='hs-layout'>(</span><span class='hs-varid'>emsModSummary</span> <span class='hs-varid'>ems</span><span class='hs-layout'>)</span> <span class='hs-varid'>home_mod_map</span> <span class='hs-varid'>comp_graph_loops</span>
<a name="line-1155"></a>                                     <span class='hs-varid'>lcl_logger</span> <span class='hs-varid'>lcl_tmpfs</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_home_unit</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-1156"></a>                                     <span class='hs-varid'>mHscMessage</span>
<a name="line-1157"></a>                                     <span class='hs-varid'>par_sem</span> <span class='hs-varid'>hsc_env_var</span> <span class='hs-varid'>old_hpt_var</span>
<a name="line-1158"></a>                                     <span class='hs-varid'>stable_mods</span> <span class='hs-varid'>mod_idx</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>sccs</span><span class='hs-layout'>)</span>
<a name="line-1159"></a>
<a name="line-1160"></a>                <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>m_res</span> <span class='hs-keyword'>of</span>
<a name="line-1161"></a>                    <span class='hs-conid'>Right</span> <span class='hs-varid'>flag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>flag</span>
<a name="line-1162"></a>                    <span class='hs-conid'>Left</span> <span class='hs-varid'>exc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1163"></a>                        <span class='hs-comment'>-- Don't print ThreadKilled exceptions: they are used</span>
<a name="line-1164"></a>                        <span class='hs-comment'>-- to kill the worker thread in the event of a user</span>
<a name="line-1165"></a>                        <span class='hs-comment'>-- interrupt, and the user doesn't have to be informed</span>
<a name="line-1166"></a>                        <span class='hs-comment'>-- about that.</span>
<a name="line-1167"></a>                        <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromException</span> <span class='hs-varid'>exc</span> <span class='hs-varop'>/=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>ThreadKilled</span><span class='hs-layout'>)</span>
<a name="line-1168"></a>                             <span class='hs-layout'>(</span><span class='hs-varid'>errorMsg</span> <span class='hs-varid'>lcl_logger</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>exc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1169"></a>                        <span class='hs-varid'>return</span> <span class='hs-conid'>Failed</span>
<a name="line-1170"></a>
<a name="line-1171"></a>                <span class='hs-comment'>-- Populate the result MVar.</span>
<a name="line-1172"></a>                <span class='hs-varid'>putMVar</span> <span class='hs-varid'>mvar</span> <span class='hs-varid'>res</span>
<a name="line-1173"></a>
<a name="line-1174"></a>                <span class='hs-comment'>-- Write the end marker to the message queue, telling the main</span>
<a name="line-1175"></a>                <span class='hs-comment'>-- thread that it can stop waiting for messages from this</span>
<a name="line-1176"></a>                <span class='hs-comment'>-- particular compile.</span>
<a name="line-1177"></a>                <span class='hs-varid'>writeLogQueue</span> <span class='hs-varid'>log_queue</span> <span class='hs-conid'>Nothing</span>
<a name="line-1178"></a>
<a name="line-1179"></a>                <span class='hs-comment'>-- Add the remaining files that weren't cleaned up to the</span>
<a name="line-1180"></a>                <span class='hs-comment'>-- global TmpFs, for cleanup later.</span>
<a name="line-1181"></a>                <span class='hs-varid'>mergeTmpFsInto</span> <span class='hs-varid'>lcl_tmpfs</span> <span class='hs-varid'>tmpfs</span>
<a name="line-1182"></a>
<a name="line-1183"></a>        <span class='hs-comment'>-- Kill all the workers, masking interrupts (since killThread is</span>
<a name="line-1184"></a>        <span class='hs-comment'>-- interruptible). XXX: This is not ideal.</span>
<a name="line-1185"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>killWorkers</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MC.uninterruptibleMask_</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>killThread</span> <span class='hs-layout'>}</span>
<a name="line-1186"></a>
<a name="line-1187"></a>
<a name="line-1188"></a>    <span class='hs-comment'>-- Spawn the workers, making sure to kill them later. Collect the results</span>
<a name="line-1189"></a>    <span class='hs-comment'>-- of each compile.</span>
<a name="line-1190"></a>    <span class='hs-varid'>results</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>MC.bracket</span> <span class='hs-varid'>spawnWorkers</span> <span class='hs-varid'>killWorkers</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1191"></a>        <span class='hs-comment'>-- Loop over each module in the compilation graph in order, printing</span>
<a name="line-1192"></a>        <span class='hs-comment'>-- each message from its log_queue.</span>
<a name="line-1193"></a>        <span class='hs-varid'>forM</span> <span class='hs-varid'>comp_graph</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>mod</span><span class='hs-layout'>,</span><span class='hs-varid'>mvar</span><span class='hs-layout'>,</span><span class='hs-varid'>log_queue</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1194"></a>            <span class='hs-varid'>printLogs</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>log_queue</span>
<a name="line-1195"></a>            <span class='hs-varid'>result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMVar</span> <span class='hs-varid'>mvar</span>
<a name="line-1196"></a>            <span class='hs-keyword'>if</span> <span class='hs-varid'>succeeded</span> <span class='hs-varid'>result</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-1197"></a>
<a name="line-1198"></a>
<a name="line-1199"></a>    <span class='hs-comment'>-- Collect and return the ModSummaries of all the successful compiles.</span>
<a name="line-1200"></a>    <span class='hs-comment'>-- NB: Reverse this list to maintain output parity with the sequential upsweep.</span>
<a name="line-1201"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>ok_results</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverse</span> <span class='hs-layout'>(</span><span class='hs-varid'>catMaybes</span> <span class='hs-varid'>results</span><span class='hs-layout'>)</span>
<a name="line-1202"></a>
<a name="line-1203"></a>    <span class='hs-comment'>-- Handle any cycle in the original compilation graph and return the result</span>
<a name="line-1204"></a>    <span class='hs-comment'>-- of the upsweep.</span>
<a name="line-1205"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>cycle</span> <span class='hs-keyword'>of</span>
<a name="line-1206"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>mss</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1207"></a>            <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fatalErrorMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>cyclicModuleErr</span> <span class='hs-varid'>mss</span><span class='hs-layout'>)</span>
<a name="line-1208"></a>            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Failed</span><span class='hs-layout'>,</span><span class='hs-varid'>ok_results</span><span class='hs-layout'>)</span>
<a name="line-1209"></a>        <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1210"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>success_flag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>successIf</span> <span class='hs-layout'>(</span><span class='hs-varid'>all</span> <span class='hs-varid'>isJust</span> <span class='hs-varid'>results</span><span class='hs-layout'>)</span>
<a name="line-1211"></a>            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>success_flag</span><span class='hs-layout'>,</span><span class='hs-varid'>ok_results</span><span class='hs-layout'>)</span>
<a name="line-1212"></a>
<a name="line-1213"></a>  <span class='hs-keyword'>where</span>
<a name="line-1214"></a>    <span class='hs-varid'>writeLogQueue</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LogQueue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>WarnReason</span><span class='hs-layout'>,</span><span class='hs-conid'>Severity</span><span class='hs-layout'>,</span><span class='hs-conid'>SrcSpan</span><span class='hs-layout'>,</span><span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1215"></a>    <span class='hs-varid'>writeLogQueue</span> <span class='hs-layout'>(</span><span class='hs-conid'>LogQueue</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>sem</span><span class='hs-layout'>)</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1216"></a>        <span class='hs-varid'>atomicModifyIORef'</span> <span class='hs-varid'>ref</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>msgs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>msg</span><span class='hs-conop'>:</span><span class='hs-varid'>msgs</span><span class='hs-layout'>,</span><span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-1217"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tryPutMVar</span> <span class='hs-varid'>sem</span> <span class='hs-conid'>()</span>
<a name="line-1218"></a>        <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1219"></a>
<a name="line-1220"></a>    <span class='hs-comment'>-- The log_action callback that is used to synchronize messages from a</span>
<a name="line-1221"></a>    <span class='hs-comment'>-- worker thread.</span>
<a name="line-1222"></a>    <span class='hs-varid'>parLogAction</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LogQueue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LogAction</span>
<a name="line-1223"></a>    <span class='hs-varid'>parLogAction</span> <span class='hs-varid'>log_queue</span> <span class='hs-sel'>_dflags</span> <span class='hs-varop'>!</span><span class='hs-varid'>reason</span> <span class='hs-varop'>!</span><span class='hs-varid'>severity</span> <span class='hs-varop'>!</span><span class='hs-varid'>srcSpan</span> <span class='hs-varop'>!</span><span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span>
<a name="line-1224"></a>        <span class='hs-varid'>writeLogQueue</span> <span class='hs-varid'>log_queue</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>reason</span><span class='hs-layout'>,</span><span class='hs-varid'>severity</span><span class='hs-layout'>,</span><span class='hs-varid'>srcSpan</span><span class='hs-layout'>,</span><span class='hs-varid'>msg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1225"></a>
<a name="line-1226"></a>    <span class='hs-comment'>-- Print each message from the log_queue using the log_action from the</span>
<a name="line-1227"></a>    <span class='hs-comment'>-- session's DynFlags.</span>
<a name="line-1228"></a>    <span class='hs-varid'>printLogs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Logger</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LogQueue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1229"></a>    <span class='hs-varid'>printLogs</span> <span class='hs-varop'>!</span><span class='hs-varid'>logger</span> <span class='hs-varop'>!</span><span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>LogQueue</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>sem</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>read_msgs</span>
<a name="line-1230"></a>      <span class='hs-keyword'>where</span> <span class='hs-varid'>read_msgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1231"></a>                <span class='hs-varid'>takeMVar</span> <span class='hs-varid'>sem</span>
<a name="line-1232"></a>                <span class='hs-varid'>msgs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>atomicModifyIORef'</span> <span class='hs-varid'>ref</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>xs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span>
<a name="line-1233"></a>                <span class='hs-varid'>print_loop</span> <span class='hs-varid'>msgs</span>
<a name="line-1234"></a>
<a name="line-1235"></a>            <span class='hs-varid'>print_loop</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>read_msgs</span>
<a name="line-1236"></a>            <span class='hs-varid'>print_loop</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>x</span> <span class='hs-keyword'>of</span>
<a name="line-1237"></a>                <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>reason</span><span class='hs-layout'>,</span><span class='hs-varid'>severity</span><span class='hs-layout'>,</span><span class='hs-varid'>srcSpan</span><span class='hs-layout'>,</span><span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1238"></a>                    <span class='hs-varid'>putLogMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>reason</span> <span class='hs-varid'>severity</span> <span class='hs-varid'>srcSpan</span> <span class='hs-varid'>msg</span>
<a name="line-1239"></a>                    <span class='hs-varid'>print_loop</span> <span class='hs-varid'>xs</span>
<a name="line-1240"></a>                <span class='hs-comment'>-- Exit the loop once we encounter the end marker.</span>
<a name="line-1241"></a>                <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1242"></a>
<a name="line-1243"></a><a name="parUpsweep_one"></a><span class='hs-comment'>-- The interruptible subset of the worker threads' work.</span>
<a name="line-1244"></a><span class='hs-definition'>parUpsweep_one</span>
<a name="line-1245"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModSummary</span>
<a name="line-1246"></a>    <span class='hs-comment'>-- ^ The module we wish to compile</span>
<a name="line-1247"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>BuildModule</span> <span class='hs-layout'>(</span><span class='hs-conid'>MVar</span> <span class='hs-conid'>SuccessFlag</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-1248"></a>    <span class='hs-comment'>-- ^ The map of home modules and their result MVar</span>
<a name="line-1249"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>BuildModule</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-1250"></a>    <span class='hs-comment'>-- ^ The list of all module loops within the compilation graph.</span>
<a name="line-1251"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Logger</span>
<a name="line-1252"></a>    <span class='hs-comment'>-- ^ The thread-local Logger</span>
<a name="line-1253"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TmpFs</span>
<a name="line-1254"></a>    <span class='hs-comment'>-- ^ The thread-local TmpFs</span>
<a name="line-1255"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span>
<a name="line-1256"></a>    <span class='hs-comment'>-- ^ The thread-local DynFlags</span>
<a name="line-1257"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HomeUnit</span>
<a name="line-1258"></a>    <span class='hs-comment'>-- ^ The home-unit</span>
<a name="line-1259"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Messager</span>
<a name="line-1260"></a>    <span class='hs-comment'>-- ^ The messager</span>
<a name="line-1261"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QSem</span>
<a name="line-1262"></a>    <span class='hs-comment'>-- ^ The semaphore for limiting the number of simultaneous compiles</span>
<a name="line-1263"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MVar</span> <span class='hs-conid'>HscEnv</span>
<a name="line-1264"></a>    <span class='hs-comment'>-- ^ The MVar that synchronizes updates to the global HscEnv</span>
<a name="line-1265"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>HomePackageTable</span>
<a name="line-1266"></a>    <span class='hs-comment'>-- ^ The old HPT</span>
<a name="line-1267"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StableModules</span>
<a name="line-1268"></a>    <span class='hs-comment'>-- ^ Sets of stable objects and BCOs</span>
<a name="line-1269"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-1270"></a>    <span class='hs-comment'>-- ^ The index of this module</span>
<a name="line-1271"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-1272"></a>    <span class='hs-comment'>-- ^ The total number of modules</span>
<a name="line-1273"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>SuccessFlag</span>
<a name="line-1274"></a>    <span class='hs-comment'>-- ^ The result of this compile</span>
<a name="line-1275"></a><span class='hs-definition'>parUpsweep_one</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>home_mod_map</span> <span class='hs-varid'>comp_graph_loops</span> <span class='hs-varid'>lcl_logger</span> <span class='hs-varid'>lcl_tmpfs</span> <span class='hs-varid'>lcl_dflags</span> <span class='hs-varid'>home_unit</span> <span class='hs-varid'>mHscMessage</span> <span class='hs-varid'>par_sem</span>
<a name="line-1276"></a>               <span class='hs-varid'>hsc_env_var</span> <span class='hs-varid'>old_hpt_var</span> <span class='hs-varid'>stable_mods</span> <span class='hs-varid'>mod_index</span> <span class='hs-varid'>num_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1277"></a>
<a name="line-1278"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>this_build_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkBuildModule0</span> <span class='hs-varid'>mod</span>
<a name="line-1279"></a>
<a name="line-1280"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>home_imps</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>unLoc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ms_home_imps</span> <span class='hs-varid'>mod</span>
<a name="line-1281"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>home_src_imps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>unLoc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ms_home_srcimps</span> <span class='hs-varid'>mod</span>
<a name="line-1282"></a>
<a name="line-1283"></a>    <span class='hs-comment'>-- All the textual imports of this module.</span>
<a name="line-1284"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>textual_deps</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Set.fromList</span> <span class='hs-varop'>$</span>
<a name="line-1285"></a>            <span class='hs-varid'>zipWith</span> <span class='hs-varid'>f</span> <span class='hs-varid'>home_imps</span>     <span class='hs-layout'>(</span><span class='hs-varid'>repeat</span> <span class='hs-conid'>NotBoot</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span>
<a name="line-1286"></a>            <span class='hs-varid'>zipWith</span> <span class='hs-varid'>f</span> <span class='hs-varid'>home_src_imps</span> <span class='hs-layout'>(</span><span class='hs-varid'>repeat</span> <span class='hs-conid'>IsBoot</span><span class='hs-layout'>)</span>
<a name="line-1287"></a>          <span class='hs-keyword'>where</span> <span class='hs-varid'>f</span> <span class='hs-varid'>mn</span> <span class='hs-varid'>isBoot</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BuildModule_Module</span> <span class='hs-varop'>$</span> <span class='hs-conid'>GWIB</span>
<a name="line-1288"></a>                  <span class='hs-layout'>{</span> <span class='hs-varid'>gwib_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHomeModule</span> <span class='hs-varid'>home_unit</span> <span class='hs-varid'>mn</span>
<a name="line-1289"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>gwib_isBoot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isBoot</span>
<a name="line-1290"></a>                  <span class='hs-layout'>}</span>
<a name="line-1291"></a>
<a name="line-1292"></a>    <span class='hs-comment'>-- Dealing with module loops</span>
<a name="line-1293"></a>    <span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-1294"></a>    <span class='hs-comment'>--</span>
<a name="line-1295"></a>    <span class='hs-comment'>-- Not only do we have to deal with explicit textual dependencies, we also</span>
<a name="line-1296"></a>    <span class='hs-comment'>-- have to deal with implicit dependencies introduced by import cycles that</span>
<a name="line-1297"></a>    <span class='hs-comment'>-- are broken by an hs-boot file. We have to ensure that:</span>
<a name="line-1298"></a>    <span class='hs-comment'>--</span>
<a name="line-1299"></a>    <span class='hs-comment'>-- 1. A module that breaks a loop must depend on all the modules in the</span>
<a name="line-1300"></a>    <span class='hs-comment'>--    loop (transitively or otherwise). This is normally always fulfilled</span>
<a name="line-1301"></a>    <span class='hs-comment'>--    by the module's textual dependencies except in degenerate loops,</span>
<a name="line-1302"></a>    <span class='hs-comment'>--    e.g.:</span>
<a name="line-1303"></a>    <span class='hs-comment'>--</span>
<a name="line-1304"></a>    <span class='hs-comment'>--    A.hs imports B.hs-boot</span>
<a name="line-1305"></a>    <span class='hs-comment'>--    B.hs doesn't import A.hs</span>
<a name="line-1306"></a>    <span class='hs-comment'>--    C.hs imports A.hs, B.hs</span>
<a name="line-1307"></a>    <span class='hs-comment'>--</span>
<a name="line-1308"></a>    <span class='hs-comment'>--    In this scenario, getModLoop will detect the module loop [A,B] but</span>
<a name="line-1309"></a>    <span class='hs-comment'>--    the loop finisher B doesn't depend on A. So we have to explicitly add</span>
<a name="line-1310"></a>    <span class='hs-comment'>--    A in as a dependency of B when we are compiling B.</span>
<a name="line-1311"></a>    <span class='hs-comment'>--</span>
<a name="line-1312"></a>    <span class='hs-comment'>-- 2. A module that depends on a module in an external loop can't proceed</span>
<a name="line-1313"></a>    <span class='hs-comment'>--    until the entire loop is re-typechecked.</span>
<a name="line-1314"></a>    <span class='hs-comment'>--</span>
<a name="line-1315"></a>    <span class='hs-comment'>-- These two invariants have to be maintained to correctly build a</span>
<a name="line-1316"></a>    <span class='hs-comment'>-- compilation graph with one or more loops.</span>
<a name="line-1317"></a>
<a name="line-1318"></a>
<a name="line-1319"></a>    <span class='hs-comment'>-- The loop that this module will finish. After this module successfully</span>
<a name="line-1320"></a>    <span class='hs-comment'>-- compiles, this loop is going to get re-typechecked.</span>
<a name="line-1321"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>finish_loop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleWithIsBoot</span><span class='hs-keyglyph'>]</span>
<a name="line-1322"></a>        <span class='hs-varid'>finish_loop</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>listToMaybe</span>
<a name="line-1323"></a>          <span class='hs-keyglyph'>[</span> <span class='hs-varid'>flip</span> <span class='hs-varid'>mapMaybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>tail</span> <span class='hs-varid'>loop</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>case</span>
<a name="line-1324"></a>              <span class='hs-conid'>BuildModule_Unit</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1325"></a>              <span class='hs-conid'>BuildModule_Module</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ms</span>
<a name="line-1326"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>loop</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>comp_graph_loops</span>
<a name="line-1327"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>head</span> <span class='hs-varid'>loop</span> <span class='hs-varop'>==</span> <span class='hs-conid'>BuildModule_Module</span> <span class='hs-varid'>this_build_mod</span>
<a name="line-1328"></a>          <span class='hs-keyglyph'>]</span>
<a name="line-1329"></a>
<a name="line-1330"></a>    <span class='hs-comment'>-- If this module finishes a loop then it must depend on all the other</span>
<a name="line-1331"></a>    <span class='hs-comment'>-- modules in that loop because the entire module loop is going to be</span>
<a name="line-1332"></a>    <span class='hs-comment'>-- re-typechecked once this module gets compiled. These extra dependencies</span>
<a name="line-1333"></a>    <span class='hs-comment'>-- are this module's "internal" loop dependencies, because this module is</span>
<a name="line-1334"></a>    <span class='hs-comment'>-- inside the loop in question.</span>
<a name="line-1335"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>int_loop_deps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Set.Set</span> <span class='hs-conid'>BuildModule</span>
<a name="line-1336"></a>        <span class='hs-varid'>int_loop_deps</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Set.fromList</span> <span class='hs-varop'>$</span>
<a name="line-1337"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>finish_loop</span> <span class='hs-keyword'>of</span>
<a name="line-1338"></a>                <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-1339"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>loop</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BuildModule_Module</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>/=</span> <span class='hs-varid'>this_build_mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>loop</span>
<a name="line-1340"></a>
<a name="line-1341"></a>    <span class='hs-comment'>-- If this module depends on a module within a loop then it must wait for</span>
<a name="line-1342"></a>    <span class='hs-comment'>-- that loop to get re-typechecked, i.e. it must wait on the module that</span>
<a name="line-1343"></a>    <span class='hs-comment'>-- finishes that loop. These extra dependencies are this module's</span>
<a name="line-1344"></a>    <span class='hs-comment'>-- "external" loop dependencies, because this module is outside of the</span>
<a name="line-1345"></a>    <span class='hs-comment'>-- loop(s) in question.</span>
<a name="line-1346"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>ext_loop_deps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Set.Set</span> <span class='hs-conid'>BuildModule</span>
<a name="line-1347"></a>        <span class='hs-varid'>ext_loop_deps</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Set.fromList</span>
<a name="line-1348"></a>            <span class='hs-keyglyph'>[</span> <span class='hs-varid'>head</span> <span class='hs-varid'>loop</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>loop</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>comp_graph_loops</span>
<a name="line-1349"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varop'>`Set.member`</span> <span class='hs-varid'>textual_deps</span><span class='hs-layout'>)</span> <span class='hs-varid'>loop</span>
<a name="line-1350"></a>                        <span class='hs-layout'>,</span> <span class='hs-conid'>BuildModule_Module</span> <span class='hs-varid'>this_build_mod</span> <span class='hs-varop'>`notElem`</span> <span class='hs-varid'>loop</span> <span class='hs-keyglyph'>]</span>
<a name="line-1351"></a>
<a name="line-1352"></a>
<a name="line-1353"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>all_deps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl1</span> <span class='hs-conid'>Set.union</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>textual_deps</span><span class='hs-layout'>,</span> <span class='hs-varid'>int_loop_deps</span><span class='hs-layout'>,</span> <span class='hs-varid'>ext_loop_deps</span><span class='hs-keyglyph'>]</span>
<a name="line-1354"></a>
<a name="line-1355"></a>    <span class='hs-comment'>-- All of the module's home-module dependencies.</span>
<a name="line-1356"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>home_deps_with_idx</span> <span class='hs-keyglyph'>=</span>
<a name="line-1357"></a>            <span class='hs-keyglyph'>[</span> <span class='hs-varid'>home_dep</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dep</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Set.toList</span> <span class='hs-varid'>all_deps</span>
<a name="line-1358"></a>                       <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>home_dep</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Map.lookup</span> <span class='hs-varid'>dep</span> <span class='hs-varid'>home_mod_map</span><span class='hs-keyglyph'>]</span>
<a name="line-1359"></a>                       <span class='hs-keyglyph'>]</span>
<a name="line-1360"></a>
<a name="line-1361"></a>    <span class='hs-comment'>-- Sort the list of dependencies in reverse-topological order. This way, by</span>
<a name="line-1362"></a>    <span class='hs-comment'>-- the time we get woken up by the result of an earlier dependency,</span>
<a name="line-1363"></a>    <span class='hs-comment'>-- subsequent dependencies are more likely to have finished. This step</span>
<a name="line-1364"></a>    <span class='hs-comment'>-- effectively reduces the number of MVars that each thread blocks on.</span>
<a name="line-1365"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>home_deps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sortBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-layout'>(</span><span class='hs-varid'>comparing</span> <span class='hs-varid'>snd</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>home_deps_with_idx</span>
<a name="line-1366"></a>
<a name="line-1367"></a>    <span class='hs-comment'>-- Wait for the all the module's dependencies to finish building.</span>
<a name="line-1368"></a>    <span class='hs-varid'>deps_ok</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>allM</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>succeeded</span> <span class='hs-varop'>.</span> <span class='hs-varid'>readMVar</span><span class='hs-layout'>)</span> <span class='hs-varid'>home_deps</span>
<a name="line-1369"></a>
<a name="line-1370"></a>    <span class='hs-comment'>-- We can't build this module if any of its dependencies failed to build.</span>
<a name="line-1371"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-varid'>deps_ok</span>
<a name="line-1372"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Failed</span>
<a name="line-1373"></a>      <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-1374"></a>        <span class='hs-comment'>-- Any hsc_env at this point is OK to use since we only really require</span>
<a name="line-1375"></a>        <span class='hs-comment'>-- that the HPT contains the HMIs of our dependencies.</span>
<a name="line-1376"></a>        <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMVar</span> <span class='hs-varid'>hsc_env_var</span>
<a name="line-1377"></a>        <span class='hs-varid'>old_hpt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>old_hpt_var</span>
<a name="line-1378"></a>
<a name="line-1379"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>logg</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>printBagOfErrors</span> <span class='hs-varid'>lcl_logger</span> <span class='hs-varid'>lcl_dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcErrorMessages</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span>
<a name="line-1380"></a>
<a name="line-1381"></a>        <span class='hs-comment'>-- Limit the number of parallel compiles.</span>
<a name="line-1382"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>withSem</span> <span class='hs-varid'>sem</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MC.bracket_</span> <span class='hs-layout'>(</span><span class='hs-varid'>waitQSem</span> <span class='hs-varid'>sem</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>signalQSem</span> <span class='hs-varid'>sem</span><span class='hs-layout'>)</span>
<a name="line-1383"></a>        <span class='hs-varid'>mb_mod_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>withSem</span> <span class='hs-varid'>par_sem</span> <span class='hs-varop'>$</span>
<a name="line-1384"></a>            <span class='hs-varid'>handleSourceError</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>logg</span> <span class='hs-varid'>err</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1385"></a>                <span class='hs-comment'>-- Have the HscEnv point to our local logger and tmpfs.</span>
<a name="line-1386"></a>                <span class='hs-keyword'>let</span> <span class='hs-varid'>lcl_hsc_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>localize_hsc_env</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1387"></a>
<a name="line-1388"></a>                <span class='hs-comment'>-- Re-typecheck the loop</span>
<a name="line-1389"></a>                <span class='hs-comment'>-- This is necessary to make sure the knot is tied when</span>
<a name="line-1390"></a>                <span class='hs-comment'>-- we close a recursive module loop, see bug #12035.</span>
<a name="line-1391"></a>                <span class='hs-varid'>type_env_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>newIORef</span> <span class='hs-varid'>emptyNameEnv</span>
<a name="line-1392"></a>                <span class='hs-keyword'>let</span> <span class='hs-varid'>lcl_hsc_env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl_hsc_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_type_env_var</span> <span class='hs-keyglyph'>=</span>
<a name="line-1393"></a>                                    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_mod</span> <span class='hs-varid'>mod</span><span class='hs-layout'>,</span> <span class='hs-varid'>type_env_var</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1394"></a>                <span class='hs-varid'>lcl_hsc_env''</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>finish_loop</span> <span class='hs-keyword'>of</span>
<a name="line-1395"></a>                    <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>lcl_hsc_env'</span>
<a name="line-1396"></a>                    <span class='hs-comment'>-- In the non-parallel case, the retypecheck prior to</span>
<a name="line-1397"></a>                    <span class='hs-comment'>-- typechecking the loop closer includes all modules</span>
<a name="line-1398"></a>                    <span class='hs-comment'>-- EXCEPT the loop closer.  However, our precomputed</span>
<a name="line-1399"></a>                    <span class='hs-comment'>-- SCCs include the loop closer, so we have to filter</span>
<a name="line-1400"></a>                    <span class='hs-comment'>-- it out.</span>
<a name="line-1401"></a>                    <span class='hs-conid'>Just</span> <span class='hs-varid'>loop</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>typecheckLoop</span> <span class='hs-varid'>lcl_dflags</span> <span class='hs-varid'>lcl_hsc_env'</span> <span class='hs-varop'>$</span>
<a name="line-1402"></a>                                 <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>/=</span> <span class='hs-varid'>moduleName</span> <span class='hs-layout'>(</span><span class='hs-varid'>gwib_mod</span> <span class='hs-varid'>this_build_mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1403"></a>                                 <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>gwib_mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>loop</span>
<a name="line-1404"></a>
<a name="line-1405"></a>                <span class='hs-comment'>-- Compile the module.</span>
<a name="line-1406"></a>                <span class='hs-varid'>mod_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>upsweep_mod</span> <span class='hs-varid'>lcl_hsc_env''</span> <span class='hs-varid'>mHscMessage</span> <span class='hs-varid'>old_hpt</span> <span class='hs-varid'>stable_mods</span>
<a name="line-1407"></a>                                        <span class='hs-varid'>mod</span> <span class='hs-varid'>mod_index</span> <span class='hs-varid'>num_mods</span>
<a name="line-1408"></a>                <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>mod_info</span><span class='hs-layout'>)</span>
<a name="line-1409"></a>
<a name="line-1410"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_mod_info</span> <span class='hs-keyword'>of</span>
<a name="line-1411"></a>            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Failed</span>
<a name="line-1412"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>mod_info</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1413"></a>                <span class='hs-keyword'>let</span> <span class='hs-varid'>this_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_mod_name</span> <span class='hs-varid'>mod</span>
<a name="line-1414"></a>
<a name="line-1415"></a>                <span class='hs-comment'>-- Prune the old HPT unless this is an hs-boot module.</span>
<a name="line-1416"></a>                <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isBootSummary</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>==</span> <span class='hs-conid'>IsBoot</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1417"></a>                    <span class='hs-varid'>atomicModifyIORef'</span> <span class='hs-varid'>old_hpt_var</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>old_hpt</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1418"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>delFromHpt</span> <span class='hs-varid'>old_hpt</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>,</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-1419"></a>
<a name="line-1420"></a>                <span class='hs-comment'>-- Update and fetch the global HscEnv.</span>
<a name="line-1421"></a>                <span class='hs-varid'>lcl_hsc_env'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>modifyMVar</span> <span class='hs-varid'>hsc_env_var</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1422"></a>                    <span class='hs-keyword'>let</span> <span class='hs-varid'>hsc_env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1423"></a>                                     <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_HPT</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToHpt</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-1424"></a>                                                           <span class='hs-varid'>this_mod</span> <span class='hs-varid'>mod_info</span> <span class='hs-layout'>}</span>
<a name="line-1425"></a>                    <span class='hs-comment'>-- We've finished typechecking the module, now we must</span>
<a name="line-1426"></a>                    <span class='hs-comment'>-- retypecheck the loop AGAIN to ensure unfoldings are</span>
<a name="line-1427"></a>                    <span class='hs-comment'>-- updated.  This time, however, we include the loop</span>
<a name="line-1428"></a>                    <span class='hs-comment'>-- closer!</span>
<a name="line-1429"></a>                    <span class='hs-varid'>hsc_env''</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>finish_loop</span> <span class='hs-keyword'>of</span>
<a name="line-1430"></a>                        <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>hsc_env'</span>
<a name="line-1431"></a>                        <span class='hs-conid'>Just</span> <span class='hs-varid'>loop</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>typecheckLoop</span> <span class='hs-varid'>lcl_dflags</span> <span class='hs-varid'>hsc_env'</span> <span class='hs-varop'>$</span>
<a name="line-1432"></a>                                     <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>gwib_mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>loop</span>
<a name="line-1433"></a>                    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_env''</span><span class='hs-layout'>,</span> <span class='hs-varid'>localize_hsc_env</span> <span class='hs-varid'>hsc_env''</span><span class='hs-layout'>)</span>
<a name="line-1434"></a>
<a name="line-1435"></a>                <span class='hs-comment'>-- Clean up any intermediate files.</span>
<a name="line-1436"></a>                <span class='hs-varid'>cleanCurrentModuleTempFiles</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_logger</span> <span class='hs-varid'>lcl_hsc_env'</span><span class='hs-layout'>)</span>
<a name="line-1437"></a>                                            <span class='hs-layout'>(</span><span class='hs-varid'>hsc_tmpfs</span>  <span class='hs-varid'>lcl_hsc_env'</span><span class='hs-layout'>)</span>
<a name="line-1438"></a>                                            <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>lcl_hsc_env'</span><span class='hs-layout'>)</span>
<a name="line-1439"></a>                <span class='hs-varid'>return</span> <span class='hs-conid'>Succeeded</span>
<a name="line-1440"></a>
<a name="line-1441"></a>  <span class='hs-keyword'>where</span>
<a name="line-1442"></a>    <span class='hs-varid'>localize_hsc_env</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1443"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_logger</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl_logger</span>
<a name="line-1444"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>hsc_tmpfs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl_tmpfs</span>
<a name="line-1445"></a>                  <span class='hs-layout'>}</span>
<a name="line-1446"></a>
<a name="line-1447"></a><a name="upsweep"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-1448"></a><span class='hs-comment'>--</span>
<a name="line-1449"></a><span class='hs-comment'>-- | The upsweep</span>
<a name="line-1450"></a><span class='hs-comment'>--</span>
<a name="line-1451"></a><span class='hs-comment'>-- This is where we compile each module in the module graph, in a pass</span>
<a name="line-1452"></a><span class='hs-comment'>-- from the bottom to the top of the graph.</span>
<a name="line-1453"></a><span class='hs-comment'>--</span>
<a name="line-1454"></a><span class='hs-comment'>-- There better had not be any cyclic groups here -- we check for them.</span>
<a name="line-1455"></a><span class='hs-definition'>upsweep</span>
<a name="line-1456"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>m</span>
<a name="line-1457"></a>    <span class='hs-varop'>.</span>  <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span>
<a name="line-1458"></a>    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Messager</span>
<a name="line-1459"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HomePackageTable</span>            <span class='hs-comment'>-- ^ HPT from last time round (pruned)</span>
<a name="line-1460"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StableModules</span>               <span class='hs-comment'>-- ^ stable modules (see checkStability)</span>
<a name="line-1461"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-conid'>ModuleGraphNode</span><span class='hs-keyglyph'>]</span>       <span class='hs-comment'>-- ^ Mods to do (the worklist)</span>
<a name="line-1462"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>SuccessFlag</span><span class='hs-layout'>,</span>
<a name="line-1463"></a>          <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleGraphNode</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1464"></a>       <span class='hs-comment'>-- ^ Returns:</span>
<a name="line-1465"></a>       <span class='hs-comment'>--</span>
<a name="line-1466"></a>       <span class='hs-comment'>--  1. A flag whether the complete upsweep was successful.</span>
<a name="line-1467"></a>       <span class='hs-comment'>--  2. The 'HscEnv' in the monad has an updated HPT</span>
<a name="line-1468"></a>       <span class='hs-comment'>--  3. A list of modules which succeeded loading.</span>
<a name="line-1469"></a>
<a name="line-1470"></a><span class='hs-definition'>upsweep</span> <span class='hs-varid'>mHscMessage</span> <span class='hs-varid'>old_hpt</span> <span class='hs-varid'>stable_mods</span> <span class='hs-varid'>sccs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1471"></a>   <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>done</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>upsweep'</span> <span class='hs-varid'>old_hpt</span> <span class='hs-varid'>emptyMG</span> <span class='hs-varid'>sccs</span> <span class='hs-num'>1</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>sccs</span><span class='hs-layout'>)</span>
<a name="line-1472"></a>   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>reverse</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mgModSummaries'</span> <span class='hs-varid'>done</span><span class='hs-layout'>)</span>
<a name="line-1473"></a> <span class='hs-keyword'>where</span>
<a name="line-1474"></a>  <span class='hs-varid'>keep_going</span>
<a name="line-1475"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NodeKey</span><span class='hs-keyglyph'>]</span>
<a name="line-1476"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HomePackageTable</span>
<a name="line-1477"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleGraph</span>
<a name="line-1478"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-conid'>ModuleGraphNode</span><span class='hs-keyglyph'>]</span>
<a name="line-1479"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-1480"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-1481"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>SuccessFlag</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModuleGraph</span><span class='hs-layout'>)</span>
<a name="line-1482"></a>  <span class='hs-varid'>keep_going</span> <span class='hs-varid'>this_mods</span> <span class='hs-varid'>old_hpt</span> <span class='hs-varid'>done</span> <span class='hs-varid'>mods</span> <span class='hs-varid'>mod_index</span> <span class='hs-varid'>nmods</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1483"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>sum_deps</span> <span class='hs-varid'>ms</span> <span class='hs-layout'>(</span><span class='hs-conid'>AcyclicSCC</span> <span class='hs-varid'>iuidOrMod</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1484"></a>          <span class='hs-keyword'>if</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-varid'>elem</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unfilteredEdges</span> <span class='hs-conid'>False</span> <span class='hs-varid'>iuidOrMod</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ms</span>
<a name="line-1485"></a>          <span class='hs-keyword'>then</span> <span class='hs-varid'>mkHomeBuildModule</span> <span class='hs-varid'>iuidOrMod</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ms</span>
<a name="line-1486"></a>          <span class='hs-keyword'>else</span> <span class='hs-varid'>ms</span>
<a name="line-1487"></a>        <span class='hs-varid'>sum_deps</span> <span class='hs-varid'>ms</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms</span>
<a name="line-1488"></a>        <span class='hs-varid'>dep_closure</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl'</span> <span class='hs-varid'>sum_deps</span> <span class='hs-varid'>this_mods</span> <span class='hs-varid'>mods</span>
<a name="line-1489"></a>        <span class='hs-varid'>dropped_ms</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>drop</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>this_mods</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>dep_closure</span><span class='hs-layout'>)</span>
<a name="line-1490"></a>        <span class='hs-varid'>prunable</span> <span class='hs-layout'>(</span><span class='hs-conid'>AcyclicSCC</span> <span class='hs-varid'>node</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>elem</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHomeBuildModule</span> <span class='hs-varid'>node</span><span class='hs-layout'>)</span> <span class='hs-varid'>dep_closure</span>
<a name="line-1491"></a>        <span class='hs-varid'>prunable</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1492"></a>        <span class='hs-varid'>mods'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>prunable</span><span class='hs-layout'>)</span> <span class='hs-varid'>mods</span>
<a name="line-1493"></a>        <span class='hs-varid'>nmods'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nmods</span> <span class='hs-comment'>-</span> <span class='hs-varid'>length</span> <span class='hs-varid'>dropped_ms</span>
<a name="line-1494"></a>
<a name="line-1495"></a>    <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>null</span> <span class='hs-varid'>dropped_ms</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1496"></a>        <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSessionDynFlags</span>
<a name="line-1497"></a>        <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLogger</span>
<a name="line-1498"></a>        <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fatalErrorMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>keepGoingPruneErr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dropped_ms</span><span class='hs-layout'>)</span>
<a name="line-1499"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>done'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>upsweep'</span> <span class='hs-varid'>old_hpt</span> <span class='hs-varid'>done</span> <span class='hs-varid'>mods'</span> <span class='hs-layout'>(</span><span class='hs-varid'>mod_index</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>nmods'</span>
<a name="line-1500"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Failed</span><span class='hs-layout'>,</span> <span class='hs-varid'>done'</span><span class='hs-layout'>)</span>
<a name="line-1501"></a>
<a name="line-1502"></a>  <span class='hs-varid'>upsweep'</span>
<a name="line-1503"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HomePackageTable</span>
<a name="line-1504"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleGraph</span>
<a name="line-1505"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-conid'>ModuleGraphNode</span><span class='hs-keyglyph'>]</span>
<a name="line-1506"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-1507"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-1508"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>SuccessFlag</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModuleGraph</span><span class='hs-layout'>)</span>
<a name="line-1509"></a>  <span class='hs-varid'>upsweep'</span> <span class='hs-sel'>_old_hpt</span> <span class='hs-varid'>done</span>
<a name="line-1510"></a>     <span class='hs-conid'>[]</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-1511"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Succeeded</span><span class='hs-layout'>,</span> <span class='hs-varid'>done</span><span class='hs-layout'>)</span>
<a name="line-1512"></a>
<a name="line-1513"></a>  <span class='hs-varid'>upsweep'</span> <span class='hs-sel'>_old_hpt</span> <span class='hs-varid'>done</span>
<a name="line-1514"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>CyclicSCC</span> <span class='hs-varid'>ms</span> <span class='hs-conop'>:</span> <span class='hs-varid'>mods</span><span class='hs-layout'>)</span> <span class='hs-varid'>mod_index</span> <span class='hs-varid'>nmods</span>
<a name="line-1515"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSessionDynFlags</span>
<a name="line-1516"></a>        <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLogger</span>
<a name="line-1517"></a>        <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fatalErrorMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>cyclicModuleErr</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span>
<a name="line-1518"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_KeepGoing</span> <span class='hs-varid'>dflags</span>
<a name="line-1519"></a>          <span class='hs-keyword'>then</span> <span class='hs-varid'>keep_going</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHomeBuildModule</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_hpt</span> <span class='hs-varid'>done</span> <span class='hs-varid'>mods</span> <span class='hs-varid'>mod_index</span> <span class='hs-varid'>nmods</span>
<a name="line-1520"></a>          <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Failed</span><span class='hs-layout'>,</span> <span class='hs-varid'>done</span><span class='hs-layout'>)</span>
<a name="line-1521"></a>
<a name="line-1522"></a>  <span class='hs-varid'>upsweep'</span> <span class='hs-varid'>old_hpt</span> <span class='hs-varid'>done</span>
<a name="line-1523"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>AcyclicSCC</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstantiationNode</span> <span class='hs-varid'>iuid</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>mods</span><span class='hs-layout'>)</span> <span class='hs-varid'>mod_index</span> <span class='hs-varid'>nmods</span>
<a name="line-1524"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-1525"></a>        <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>upsweep_inst</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mHscMessage</span> <span class='hs-varid'>mod_index</span> <span class='hs-varid'>nmods</span> <span class='hs-varid'>iuid</span>
<a name="line-1526"></a>        <span class='hs-varid'>upsweep'</span> <span class='hs-varid'>old_hpt</span> <span class='hs-varid'>done</span> <span class='hs-varid'>mods</span> <span class='hs-layout'>(</span><span class='hs-varid'>mod_index</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>nmods</span>
<a name="line-1527"></a>
<a name="line-1528"></a>  <span class='hs-varid'>upsweep'</span> <span class='hs-varid'>old_hpt</span> <span class='hs-varid'>done</span>
<a name="line-1529"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>AcyclicSCC</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModuleNode</span> <span class='hs-varid'>ems</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ExtendedModSummary</span> <span class='hs-varid'>mod</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>mods</span><span class='hs-layout'>)</span> <span class='hs-varid'>mod_index</span> <span class='hs-varid'>nmods</span>
<a name="line-1530"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-comment'>-- putStrLn ("UPSWEEP_MOD: hpt = " ++</span>
<a name="line-1531"></a>        <span class='hs-comment'>--           show (map (moduleUserString.moduleName.mi_module.hm_iface)</span>
<a name="line-1532"></a>        <span class='hs-comment'>--                     (moduleEnvElts (hsc_HPT hsc_env)))</span>
<a name="line-1533"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>logg</span> <span class='hs-sel'>_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defaultWarnErrLogger</span>
<a name="line-1534"></a>
<a name="line-1535"></a>        <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-1536"></a>
<a name="line-1537"></a>        <span class='hs-comment'>-- Remove unwanted tmp files between compilations</span>
<a name="line-1538"></a>        <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cleanCurrentModuleTempFiles</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_logger</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-1539"></a>                                             <span class='hs-layout'>(</span><span class='hs-varid'>hsc_tmpfs</span>  <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-1540"></a>                                             <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-1541"></a>
<a name="line-1542"></a>        <span class='hs-comment'>-- Get ready to tie the knot</span>
<a name="line-1543"></a>        <span class='hs-varid'>type_env_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>newIORef</span> <span class='hs-varid'>emptyNameEnv</span>
<a name="line-1544"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>hsc_env1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_type_env_var</span> <span class='hs-keyglyph'>=</span>
<a name="line-1545"></a>                                    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_mod</span> <span class='hs-varid'>mod</span><span class='hs-layout'>,</span> <span class='hs-varid'>type_env_var</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1546"></a>        <span class='hs-varid'>setSession</span> <span class='hs-varid'>hsc_env1</span>
<a name="line-1547"></a>
<a name="line-1548"></a>        <span class='hs-comment'>-- Lazily reload the HPT modules participating in the loop.</span>
<a name="line-1549"></a>        <span class='hs-comment'>-- See Note [Tying the knot]--if we don't throw out the old HPT</span>
<a name="line-1550"></a>        <span class='hs-comment'>-- and reinitalize the knot-tying process, anything that was forced</span>
<a name="line-1551"></a>        <span class='hs-comment'>-- while we were previously typechecking won't get updated, this</span>
<a name="line-1552"></a>        <span class='hs-comment'>-- was bug #12035.</span>
<a name="line-1553"></a>        <span class='hs-varid'>hsc_env2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>reTypecheckLoop</span> <span class='hs-varid'>hsc_env1</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>done</span>
<a name="line-1554"></a>        <span class='hs-varid'>setSession</span> <span class='hs-varid'>hsc_env2</span>
<a name="line-1555"></a>
<a name="line-1556"></a>        <span class='hs-varid'>mb_mod_info</span>
<a name="line-1557"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>handleSourceError</span>
<a name="line-1558"></a>                   <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>logg</span> <span class='hs-varid'>mod</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1559"></a>                 <span class='hs-varid'>mod_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>upsweep_mod</span> <span class='hs-varid'>hsc_env2</span> <span class='hs-varid'>mHscMessage</span> <span class='hs-varid'>old_hpt</span> <span class='hs-varid'>stable_mods</span>
<a name="line-1560"></a>                                                  <span class='hs-varid'>mod</span> <span class='hs-varid'>mod_index</span> <span class='hs-varid'>nmods</span>
<a name="line-1561"></a>                 <span class='hs-varid'>logg</span> <span class='hs-varid'>mod</span> <span class='hs-conid'>Nothing</span> <span class='hs-comment'>-- log warnings</span>
<a name="line-1562"></a>                 <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>mod_info</span><span class='hs-layout'>)</span>
<a name="line-1563"></a>
<a name="line-1564"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_mod_info</span> <span class='hs-keyword'>of</span>
<a name="line-1565"></a>          <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1566"></a>                <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSessionDynFlags</span>
<a name="line-1567"></a>                <span class='hs-keyword'>if</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_KeepGoing</span> <span class='hs-varid'>dflags</span>
<a name="line-1568"></a>                  <span class='hs-keyword'>then</span> <span class='hs-varid'>keep_going</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NodeKey_Module</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHomeBuildModule0</span> <span class='hs-varid'>mod</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>old_hpt</span> <span class='hs-varid'>done</span> <span class='hs-varid'>mods</span> <span class='hs-varid'>mod_index</span> <span class='hs-varid'>nmods</span>
<a name="line-1569"></a>                  <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Failed</span><span class='hs-layout'>,</span> <span class='hs-varid'>done</span><span class='hs-layout'>)</span>
<a name="line-1570"></a>          <span class='hs-conid'>Just</span> <span class='hs-varid'>mod_info</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1571"></a>                <span class='hs-keyword'>let</span> <span class='hs-varid'>this_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_mod_name</span> <span class='hs-varid'>mod</span>
<a name="line-1572"></a>
<a name="line-1573"></a>                        <span class='hs-comment'>-- Add new info to hsc_env</span>
<a name="line-1574"></a>                    <span class='hs-varid'>hpt1</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToHpt</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>hsc_env2</span><span class='hs-layout'>)</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>mod_info</span>
<a name="line-1575"></a>                    <span class='hs-varid'>hsc_env3</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_env2</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_HPT</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hpt1</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsc_type_env_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-1576"></a>
<a name="line-1577"></a>                        <span class='hs-comment'>-- Space-saving: delete the old HPT entry</span>
<a name="line-1578"></a>                        <span class='hs-comment'>-- for mod BUT if mod is a hs-boot</span>
<a name="line-1579"></a>                        <span class='hs-comment'>-- node, don't delete it.  For the</span>
<a name="line-1580"></a>                        <span class='hs-comment'>-- interface, the HPT entry is probably for the</span>
<a name="line-1581"></a>                        <span class='hs-comment'>-- main Haskell source file.  Deleting it</span>
<a name="line-1582"></a>                        <span class='hs-comment'>-- would force the real module to be recompiled</span>
<a name="line-1583"></a>                        <span class='hs-comment'>-- every time.</span>
<a name="line-1584"></a>                    <span class='hs-varid'>old_hpt1</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>isBootSummary</span> <span class='hs-varid'>mod</span> <span class='hs-keyword'>of</span>
<a name="line-1585"></a>                      <span class='hs-conid'>IsBoot</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>old_hpt</span>
<a name="line-1586"></a>                      <span class='hs-conid'>NotBoot</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>delFromHpt</span> <span class='hs-varid'>old_hpt</span> <span class='hs-varid'>this_mod</span>
<a name="line-1587"></a>
<a name="line-1588"></a>                    <span class='hs-varid'>done'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendMG</span> <span class='hs-varid'>done</span> <span class='hs-varid'>ems</span>
<a name="line-1589"></a>
<a name="line-1590"></a>                        <span class='hs-comment'>-- fixup our HomePackageTable after we've finished compiling</span>
<a name="line-1591"></a>                        <span class='hs-comment'>-- a mutually-recursive loop.  We have to do this again</span>
<a name="line-1592"></a>                        <span class='hs-comment'>-- to make sure we have the final unfoldings, which may</span>
<a name="line-1593"></a>                        <span class='hs-comment'>-- not have been computed accurately in the previous</span>
<a name="line-1594"></a>                        <span class='hs-comment'>-- retypecheck.</span>
<a name="line-1595"></a>                <span class='hs-varid'>hsc_env4</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>reTypecheckLoop</span> <span class='hs-varid'>hsc_env3</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>done'</span>
<a name="line-1596"></a>                <span class='hs-varid'>setSession</span> <span class='hs-varid'>hsc_env4</span>
<a name="line-1597"></a>
<a name="line-1598"></a>                        <span class='hs-comment'>-- Add any necessary entries to the static pointer</span>
<a name="line-1599"></a>                        <span class='hs-comment'>-- table. See Note [Grand plan for static forms] in</span>
<a name="line-1600"></a>                        <span class='hs-comment'>-- GHC.Iface.Tidy.StaticPtrTable.</span>
<a name="line-1601"></a>                <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>backend</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env4</span><span class='hs-layout'>)</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Interpreter</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1602"></a>                    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscAddSptEntries</span> <span class='hs-varid'>hsc_env4</span>
<a name="line-1603"></a>                                 <span class='hs-keyglyph'>[</span> <span class='hs-varid'>spt</span>
<a name="line-1604"></a>                                 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>linkable</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hm_linkable</span> <span class='hs-varid'>mod_info</span>
<a name="line-1605"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>unlinked</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>linkableUnlinked</span> <span class='hs-varid'>linkable</span>
<a name="line-1606"></a>                                 <span class='hs-layout'>,</span> <span class='hs-conid'>BCOs</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>spts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>unlinked</span>
<a name="line-1607"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>spt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>spts</span>
<a name="line-1608"></a>                                 <span class='hs-keyglyph'>]</span>
<a name="line-1609"></a>
<a name="line-1610"></a>                <span class='hs-varid'>upsweep'</span> <span class='hs-varid'>old_hpt1</span> <span class='hs-varid'>done'</span> <span class='hs-varid'>mods</span> <span class='hs-layout'>(</span><span class='hs-varid'>mod_index</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>nmods</span>
<a name="line-1611"></a>
<a name="line-1612"></a><a name="maybeGetIfaceDate"></a><span class='hs-definition'>maybeGetIfaceDate</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModLocation</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>UTCTime</span><span class='hs-layout'>)</span>
<a name="line-1613"></a><span class='hs-definition'>maybeGetIfaceDate</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>location</span>
<a name="line-1614"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>writeInterfaceOnlyMode</span> <span class='hs-varid'>dflags</span>
<a name="line-1615"></a>    <span class='hs-comment'>-- Minor optimization: it should be harmless to check the hi file location</span>
<a name="line-1616"></a>    <span class='hs-comment'>-- always, but it's better to avoid hitting the filesystem if possible.</span>
<a name="line-1617"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modificationTimeIfExists</span> <span class='hs-layout'>(</span><span class='hs-varid'>ml_hi_file</span> <span class='hs-varid'>location</span><span class='hs-layout'>)</span>
<a name="line-1618"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1619"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-1620"></a>
<a name="line-1621"></a><a name="upsweep_inst"></a><span class='hs-definition'>upsweep_inst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-1622"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Messager</span>
<a name="line-1623"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>  <span class='hs-comment'>-- index of module</span>
<a name="line-1624"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>  <span class='hs-comment'>-- total number of modules</span>
<a name="line-1625"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InstantiatedUnit</span>
<a name="line-1626"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1627"></a><span class='hs-definition'>upsweep_inst</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mHscMessage</span> <span class='hs-varid'>mod_index</span> <span class='hs-varid'>nmods</span> <span class='hs-varid'>iuid</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1628"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>mHscMessage</span> <span class='hs-keyword'>of</span>
<a name="line-1629"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>hscMessage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>hscMessage</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>mod_index</span><span class='hs-layout'>,</span> <span class='hs-varid'>nmods</span><span class='hs-layout'>)</span> <span class='hs-conid'>MustCompile</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstantiationNode</span> <span class='hs-varid'>iuid</span><span class='hs-layout'>)</span>
<a name="line-1630"></a>            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1631"></a>        <span class='hs-varid'>runHsc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ioMsgMaybe</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcRnCheckUnit</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-conid'>VirtUnit</span> <span class='hs-varid'>iuid</span>
<a name="line-1632"></a>        <span class='hs-varid'>pure</span> <span class='hs-conid'>()</span>
<a name="line-1633"></a>
<a name="line-1634"></a><a name="upsweep_mod"></a><span class='hs-comment'>-- | Compile a single module.  Always produce a Linkable for it if</span>
<a name="line-1635"></a><span class='hs-comment'>-- successful.  If no compilation happened, return the old Linkable.</span>
<a name="line-1636"></a><span class='hs-definition'>upsweep_mod</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-1637"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Messager</span>
<a name="line-1638"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HomePackageTable</span>
<a name="line-1639"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StableModules</span>
<a name="line-1640"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModSummary</span>
<a name="line-1641"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>  <span class='hs-comment'>-- index of module</span>
<a name="line-1642"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>  <span class='hs-comment'>-- total number of modules</span>
<a name="line-1643"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>HomeModInfo</span>
<a name="line-1644"></a><span class='hs-definition'>upsweep_mod</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mHscMessage</span> <span class='hs-varid'>old_hpt</span> <span class='hs-layout'>(</span><span class='hs-varid'>stable_obj</span><span class='hs-layout'>,</span> <span class='hs-varid'>stable_bco</span><span class='hs-layout'>)</span> <span class='hs-varid'>summary</span> <span class='hs-varid'>mod_index</span> <span class='hs-varid'>nmods</span>
<a name="line-1645"></a>   <span class='hs-keyglyph'>=</span>    <span class='hs-keyword'>let</span>
<a name="line-1646"></a>            <span class='hs-varid'>this_mod_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_mod_name</span> <span class='hs-varid'>summary</span>
<a name="line-1647"></a>            <span class='hs-varid'>this_mod</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_mod</span> <span class='hs-varid'>summary</span>
<a name="line-1648"></a>            <span class='hs-varid'>mb_obj_date</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_obj_date</span> <span class='hs-varid'>summary</span>
<a name="line-1649"></a>            <span class='hs-varid'>mb_if_date</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_iface_date</span> <span class='hs-varid'>summary</span>
<a name="line-1650"></a>            <span class='hs-varid'>obj_fn</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ml_obj_file</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_location</span> <span class='hs-varid'>summary</span><span class='hs-layout'>)</span>
<a name="line-1651"></a>            <span class='hs-varid'>hs_date</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_hs_date</span> <span class='hs-varid'>summary</span>
<a name="line-1652"></a>
<a name="line-1653"></a>            <span class='hs-varid'>is_stable_obj</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>this_mod_name</span> <span class='hs-varop'>`elementOfUniqSet`</span> <span class='hs-varid'>stable_obj</span>
<a name="line-1654"></a>            <span class='hs-varid'>is_stable_bco</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>this_mod_name</span> <span class='hs-varop'>`elementOfUniqSet`</span> <span class='hs-varid'>stable_bco</span>
<a name="line-1655"></a>
<a name="line-1656"></a>            <span class='hs-varid'>old_hmi</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupHpt</span> <span class='hs-varid'>old_hpt</span> <span class='hs-varid'>this_mod_name</span>
<a name="line-1657"></a>
<a name="line-1658"></a>            <span class='hs-comment'>-- We're using the dflags for this module now, obtained by</span>
<a name="line-1659"></a>            <span class='hs-comment'>-- applying any options in its LANGUAGE &amp; OPTIONS_GHC pragmas.</span>
<a name="line-1660"></a>            <span class='hs-varid'>lcl_dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_hspp_opts</span> <span class='hs-varid'>summary</span>
<a name="line-1661"></a>            <span class='hs-varid'>prevailing_backend</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>backend</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-1662"></a>            <span class='hs-varid'>local_backend</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>backend</span> <span class='hs-varid'>lcl_dflags</span>
<a name="line-1663"></a>
<a name="line-1664"></a>            <span class='hs-comment'>-- If OPTIONS_GHC contains -fasm or -fllvm, be careful that</span>
<a name="line-1665"></a>            <span class='hs-comment'>-- we don't do anything dodgy: these should only work to change</span>
<a name="line-1666"></a>            <span class='hs-comment'>-- from -fllvm to -fasm and vice-versa, or away from -fno-code,</span>
<a name="line-1667"></a>            <span class='hs-comment'>-- otherwise we could end up trying to link object code to byte</span>
<a name="line-1668"></a>            <span class='hs-comment'>-- code.</span>
<a name="line-1669"></a>            <span class='hs-varid'>bcknd</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>prevailing_backend</span><span class='hs-layout'>,</span><span class='hs-varid'>local_backend</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1670"></a>               <span class='hs-layout'>(</span><span class='hs-conid'>LLVM</span><span class='hs-layout'>,</span><span class='hs-conid'>NCG</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NCG</span>
<a name="line-1671"></a>               <span class='hs-layout'>(</span><span class='hs-conid'>NCG</span><span class='hs-layout'>,</span><span class='hs-conid'>LLVM</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LLVM</span>
<a name="line-1672"></a>               <span class='hs-layout'>(</span><span class='hs-conid'>NoBackend</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-1673"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>backendProducesObject</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-1674"></a>               <span class='hs-layout'>(</span><span class='hs-conid'>Interpreter</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-1675"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>backendProducesObject</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-1676"></a>               <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>prevailing_backend</span>
<a name="line-1677"></a>
<a name="line-1678"></a>            <span class='hs-comment'>-- store the corrected backend into the summary</span>
<a name="line-1679"></a>            <span class='hs-varid'>summary'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>summary</span><span class='hs-layout'>{</span> <span class='hs-varid'>ms_hspp_opts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl_dflags</span> <span class='hs-layout'>{</span> <span class='hs-varid'>backend</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bcknd</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1680"></a>
<a name="line-1681"></a>            <span class='hs-comment'>-- The old interface is ok if</span>
<a name="line-1682"></a>            <span class='hs-comment'>--  a) we're compiling a source file, and the old HPT</span>
<a name="line-1683"></a>            <span class='hs-comment'>--     entry is for a source file</span>
<a name="line-1684"></a>            <span class='hs-comment'>--  b) we're compiling a hs-boot file</span>
<a name="line-1685"></a>            <span class='hs-comment'>-- Case (b) allows an hs-boot file to get the interface of its</span>
<a name="line-1686"></a>            <span class='hs-comment'>-- real source file on the second iteration of the compilation</span>
<a name="line-1687"></a>            <span class='hs-comment'>-- manager, but that does no harm.  Otherwise the hs-boot file</span>
<a name="line-1688"></a>            <span class='hs-comment'>-- will always be recompiled</span>
<a name="line-1689"></a>
<a name="line-1690"></a>            <span class='hs-varid'>mb_old_iface</span>
<a name="line-1691"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>old_hmi</span> <span class='hs-keyword'>of</span>
<a name="line-1692"></a>                     <span class='hs-conid'>Nothing</span>                                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1693"></a>                     <span class='hs-conid'>Just</span> <span class='hs-varid'>hm_info</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isBootSummary</span> <span class='hs-varid'>summary</span> <span class='hs-varop'>==</span> <span class='hs-conid'>IsBoot</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>iface</span>
<a name="line-1694"></a>                                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mi_boot</span> <span class='hs-varid'>iface</span> <span class='hs-varop'>==</span> <span class='hs-conid'>NotBoot</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>iface</span>
<a name="line-1695"></a>                                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1696"></a>                                   <span class='hs-keyword'>where</span>
<a name="line-1697"></a>                                     <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hm_iface</span> <span class='hs-varid'>hm_info</span>
<a name="line-1698"></a>
<a name="line-1699"></a>            <span class='hs-varid'>compile_it</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Linkable</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SourceModified</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>HomeModInfo</span>
<a name="line-1700"></a>            <span class='hs-varid'>compile_it</span>  <span class='hs-varid'>mb_linkable</span> <span class='hs-varid'>src_modified</span> <span class='hs-keyglyph'>=</span>
<a name="line-1701"></a>                  <span class='hs-varid'>compileOne'</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>mHscMessage</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>summary'</span> <span class='hs-varid'>mod_index</span> <span class='hs-varid'>nmods</span>
<a name="line-1702"></a>                             <span class='hs-varid'>mb_old_iface</span> <span class='hs-varid'>mb_linkable</span> <span class='hs-varid'>src_modified</span>
<a name="line-1703"></a>
<a name="line-1704"></a>            <span class='hs-varid'>compile_it_discard_iface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Linkable</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SourceModified</span>
<a name="line-1705"></a>                                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>HomeModInfo</span>
<a name="line-1706"></a>            <span class='hs-varid'>compile_it_discard_iface</span> <span class='hs-varid'>mb_linkable</span>  <span class='hs-varid'>src_modified</span> <span class='hs-keyglyph'>=</span>
<a name="line-1707"></a>                  <span class='hs-varid'>compileOne'</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>mHscMessage</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>summary'</span> <span class='hs-varid'>mod_index</span> <span class='hs-varid'>nmods</span>
<a name="line-1708"></a>                             <span class='hs-conid'>Nothing</span> <span class='hs-varid'>mb_linkable</span> <span class='hs-varid'>src_modified</span>
<a name="line-1709"></a>
<a name="line-1710"></a>            <span class='hs-comment'>-- With NoBackend we create empty linkables to avoid recompilation.</span>
<a name="line-1711"></a>            <span class='hs-comment'>-- We have to detect these to recompile anyway if the backend changed</span>
<a name="line-1712"></a>            <span class='hs-comment'>-- since the last compile.</span>
<a name="line-1713"></a>            <span class='hs-varid'>is_fake_linkable</span>
<a name="line-1714"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>hmi</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>old_hmi</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hm_linkable</span> <span class='hs-varid'>hmi</span> <span class='hs-keyglyph'>=</span>
<a name="line-1715"></a>                  <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>linkableUnlinked</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-1716"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span>
<a name="line-1717"></a>                   <span class='hs-comment'>-- we have no linkable, so it cannot be fake</span>
<a name="line-1718"></a>                   <span class='hs-conid'>False</span>
<a name="line-1719"></a>
<a name="line-1720"></a>            <span class='hs-varid'>implies</span> <span class='hs-conid'>False</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1721"></a>            <span class='hs-varid'>implies</span> <span class='hs-conid'>True</span> <span class='hs-varid'>x</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span>
<a name="line-1722"></a>
<a name="line-1723"></a>            <span class='hs-varid'>debug_trace</span> <span class='hs-varid'>n</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>debugTraceMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_logger</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-varid'>t</span>
<a name="line-1724"></a>
<a name="line-1725"></a>        <span class='hs-keyword'>in</span>
<a name="line-1726"></a>        <span class='hs-keyword'>case</span> <span class='hs-conid'>()</span> <span class='hs-keyword'>of</span>
<a name="line-1727"></a>         <span class='hs-keyword'>_</span>
<a name="line-1728"></a>                <span class='hs-comment'>-- Regardless of whether we're generating object code or</span>
<a name="line-1729"></a>                <span class='hs-comment'>-- byte code, we can always use an existing object file</span>
<a name="line-1730"></a>                <span class='hs-comment'>-- if it is *stable* (see checkStability).</span>
<a name="line-1731"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_stable_obj</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>hmi</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>old_hmi</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1732"></a>                <span class='hs-varid'>debug_trace</span> <span class='hs-num'>5</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"skipping stable obj mod:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>this_mod_name</span><span class='hs-layout'>)</span>
<a name="line-1733"></a>                <span class='hs-varid'>return</span> <span class='hs-varid'>hmi</span>
<a name="line-1734"></a>                <span class='hs-comment'>-- object is stable, and we have an entry in the</span>
<a name="line-1735"></a>                <span class='hs-comment'>-- old HPT: nothing to do</span>
<a name="line-1736"></a>
<a name="line-1737"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_stable_obj</span><span class='hs-layout'>,</span> <span class='hs-varid'>isNothing</span> <span class='hs-varid'>old_hmi</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1738"></a>                <span class='hs-varid'>debug_trace</span> <span class='hs-num'>5</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"compiling stable on-disk mod:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>this_mod_name</span><span class='hs-layout'>)</span>
<a name="line-1739"></a>                <span class='hs-varid'>linkable</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>findObjectLinkable</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>obj_fn</span>
<a name="line-1740"></a>                              <span class='hs-layout'>(</span><span class='hs-varid'>expectJust</span> <span class='hs-str'>"upsweep1"</span> <span class='hs-varid'>mb_obj_date</span><span class='hs-layout'>)</span>
<a name="line-1741"></a>                <span class='hs-varid'>compile_it</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>linkable</span><span class='hs-layout'>)</span> <span class='hs-conid'>SourceUnmodifiedAndStable</span>
<a name="line-1742"></a>                <span class='hs-comment'>-- object is stable, but we need to load the interface</span>
<a name="line-1743"></a>                <span class='hs-comment'>-- off disk to make a HMI.</span>
<a name="line-1744"></a>
<a name="line-1745"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>backendProducesObject</span> <span class='hs-varid'>bcknd</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_stable_bco</span><span class='hs-layout'>,</span>
<a name="line-1746"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>bcknd</span> <span class='hs-varop'>/=</span> <span class='hs-conid'>NoBackend</span><span class='hs-layout'>)</span> <span class='hs-varop'>`implies`</span> <span class='hs-varid'>not</span> <span class='hs-varid'>is_fake_linkable</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1747"></a>                <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>isJust</span> <span class='hs-varid'>old_hmi</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- must be in the old_hpt</span>
<a name="line-1748"></a>                <span class='hs-keyword'>let</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>hmi</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_hmi</span> <span class='hs-keyword'>in</span> <span class='hs-keyword'>do</span>
<a name="line-1749"></a>                <span class='hs-varid'>debug_trace</span> <span class='hs-num'>5</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"skipping stable BCO mod:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>this_mod_name</span><span class='hs-layout'>)</span>
<a name="line-1750"></a>                <span class='hs-varid'>return</span> <span class='hs-varid'>hmi</span>
<a name="line-1751"></a>                <span class='hs-comment'>-- BCO is stable: nothing to do</span>
<a name="line-1752"></a>
<a name="line-1753"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>backendProducesObject</span> <span class='hs-varid'>bcknd</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-1754"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>hmi</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>old_hmi</span><span class='hs-layout'>,</span>
<a name="line-1755"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hm_linkable</span> <span class='hs-varid'>hmi</span><span class='hs-layout'>,</span>
<a name="line-1756"></a>            <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isObjectLinkable</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-1757"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>bcknd</span> <span class='hs-varop'>/=</span> <span class='hs-conid'>NoBackend</span><span class='hs-layout'>)</span> <span class='hs-varop'>`implies`</span> <span class='hs-varid'>not</span> <span class='hs-varid'>is_fake_linkable</span><span class='hs-layout'>,</span>
<a name="line-1758"></a>            <span class='hs-varid'>linkableTime</span> <span class='hs-varid'>l</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>ms_hs_date</span> <span class='hs-varid'>summary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1759"></a>                <span class='hs-varid'>debug_trace</span> <span class='hs-num'>5</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"compiling non-stable BCO mod:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>this_mod_name</span><span class='hs-layout'>)</span>
<a name="line-1760"></a>                <span class='hs-varid'>compile_it</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-conid'>SourceUnmodified</span>
<a name="line-1761"></a>                <span class='hs-comment'>-- we have an old BCO that is up to date with respect</span>
<a name="line-1762"></a>                <span class='hs-comment'>-- to the source: do a recompilation check as normal.</span>
<a name="line-1763"></a>
<a name="line-1764"></a>          <span class='hs-comment'>-- When generating object code, if there's an up-to-date</span>
<a name="line-1765"></a>          <span class='hs-comment'>-- object file on the disk, then we can use it.</span>
<a name="line-1766"></a>          <span class='hs-comment'>-- However, if the object file is new (compared to any</span>
<a name="line-1767"></a>          <span class='hs-comment'>-- linkable we had from a previous compilation), then we</span>
<a name="line-1768"></a>          <span class='hs-comment'>-- must discard any in-memory interface, because this</span>
<a name="line-1769"></a>          <span class='hs-comment'>-- means the user has compiled the source file</span>
<a name="line-1770"></a>          <span class='hs-comment'>-- separately and generated a new interface, that we must</span>
<a name="line-1771"></a>          <span class='hs-comment'>-- read from the disk.</span>
<a name="line-1772"></a>          <span class='hs-comment'>--</span>
<a name="line-1773"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>backendProducesObject</span> <span class='hs-varid'>bcknd</span><span class='hs-layout'>,</span>
<a name="line-1774"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>obj_date</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mb_obj_date</span><span class='hs-layout'>,</span>
<a name="line-1775"></a>            <span class='hs-varid'>obj_date</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>hs_date</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1776"></a>                <span class='hs-keyword'>case</span> <span class='hs-varid'>old_hmi</span> <span class='hs-keyword'>of</span>
<a name="line-1777"></a>                  <span class='hs-conid'>Just</span> <span class='hs-varid'>hmi</span>
<a name="line-1778"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hm_linkable</span> <span class='hs-varid'>hmi</span><span class='hs-layout'>,</span>
<a name="line-1779"></a>                      <span class='hs-varid'>isObjectLinkable</span> <span class='hs-varid'>l</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>linkableTime</span> <span class='hs-varid'>l</span> <span class='hs-varop'>==</span> <span class='hs-varid'>obj_date</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1780"></a>                          <span class='hs-varid'>debug_trace</span> <span class='hs-num'>5</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"compiling mod with new on-disk obj:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>this_mod_name</span><span class='hs-layout'>)</span>
<a name="line-1781"></a>                          <span class='hs-varid'>compile_it</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-conid'>SourceUnmodified</span>
<a name="line-1782"></a>                  <span class='hs-sel'>_otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1783"></a>                          <span class='hs-varid'>debug_trace</span> <span class='hs-num'>5</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"compiling mod with new on-disk obj2:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>this_mod_name</span><span class='hs-layout'>)</span>
<a name="line-1784"></a>                          <span class='hs-varid'>linkable</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>findObjectLinkable</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>obj_fn</span> <span class='hs-varid'>obj_date</span>
<a name="line-1785"></a>                          <span class='hs-varid'>compile_it_discard_iface</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>linkable</span><span class='hs-layout'>)</span> <span class='hs-conid'>SourceUnmodified</span>
<a name="line-1786"></a>
<a name="line-1787"></a>          <span class='hs-comment'>-- See Note [Recompilation checking in -fno-code mode]</span>
<a name="line-1788"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>writeInterfaceOnlyMode</span> <span class='hs-varid'>lcl_dflags</span><span class='hs-layout'>,</span>
<a name="line-1789"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>if_date</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mb_if_date</span><span class='hs-layout'>,</span>
<a name="line-1790"></a>            <span class='hs-varid'>if_date</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>hs_date</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1791"></a>                <span class='hs-varid'>debug_trace</span> <span class='hs-num'>5</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"skipping tc'd mod:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>this_mod_name</span><span class='hs-layout'>)</span>
<a name="line-1792"></a>                <span class='hs-varid'>compile_it</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>SourceUnmodified</span>
<a name="line-1793"></a>
<a name="line-1794"></a>         <span class='hs-sel'>_otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1795"></a>                <span class='hs-varid'>debug_trace</span> <span class='hs-num'>5</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"compiling mod:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>this_mod_name</span><span class='hs-layout'>)</span>
<a name="line-1796"></a>                <span class='hs-varid'>compile_it</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>SourceModified</span>
<a name="line-1797"></a>
<a name="line-1798"></a>
<a name="line-1799"></a><span class='hs-comment'>{- Note [-fno-code mode]
<a name="line-1800"></a>~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1801"></a>GHC offers the flag -fno-code for the purpose of parsing and typechecking a
<a name="line-1802"></a>program without generating object files. This is intended to be used by tooling
<a name="line-1803"></a>and IDEs to provide quick feedback on any parser or type errors as cheaply as
<a name="line-1804"></a>possible.
<a name="line-1805"></a>
<a name="line-1806"></a>When GHC is invoked with -fno-code no object files or linked output will be
<a name="line-1807"></a>generated. As many errors and warnings as possible will be generated, as if
<a name="line-1808"></a>-fno-code had not been passed. The session DynFlags will have
<a name="line-1809"></a>backend == NoBackend.
<a name="line-1810"></a>
<a name="line-1811"></a>-fwrite-interface
<a name="line-1812"></a>~~~~~~~~~~~~~~~~
<a name="line-1813"></a>Whether interface files are generated in -fno-code mode is controlled by the
<a name="line-1814"></a>-fwrite-interface flag. The -fwrite-interface flag is a no-op if -fno-code is
<a name="line-1815"></a>not also passed. Recompilation avoidance requires interface files, so passing
<a name="line-1816"></a>-fno-code without -fwrite-interface should be avoided. If -fno-code were
<a name="line-1817"></a>re-implemented today, -fwrite-interface would be discarded and it would be
<a name="line-1818"></a>considered always on; this behaviour is as it is for backwards compatibility.
<a name="line-1819"></a>
<a name="line-1820"></a>================================================================
<a name="line-1821"></a>IN SUMMARY: ALWAYS PASS -fno-code AND -fwrite-interface TOGETHER
<a name="line-1822"></a>================================================================
<a name="line-1823"></a>
<a name="line-1824"></a>Template Haskell
<a name="line-1825"></a>~~~~~~~~~~~~~~~~
<a name="line-1826"></a>A module using template haskell may invoke an imported function from inside a
<a name="line-1827"></a>splice. This will cause the type-checker to attempt to execute that code, which
<a name="line-1828"></a>would fail if no object files had been generated. See #8025. To rectify this,
<a name="line-1829"></a>during the downsweep we patch the DynFlags in the ModSummary of any home module
<a name="line-1830"></a>that is imported by a module that uses template haskell, to generate object
<a name="line-1831"></a>code.
<a name="line-1832"></a>
<a name="line-1833"></a>The flavour of generated object code is chosen by defaultObjectTarget for the
<a name="line-1834"></a>target platform. It would likely be faster to generate bytecode, but this is not
<a name="line-1835"></a>supported on all platforms(?Please Confirm?), and does not support the entirety
<a name="line-1836"></a>of GHC haskell. See #1257.
<a name="line-1837"></a>
<a name="line-1838"></a>The object files (and interface files if -fwrite-interface is disabled) produced
<a name="line-1839"></a>for template haskell are written to temporary files.
<a name="line-1840"></a>
<a name="line-1841"></a>Note that since template haskell can run arbitrary IO actions, -fno-code mode
<a name="line-1842"></a>is no more secure than running without it.
<a name="line-1843"></a>
<a name="line-1844"></a>Potential TODOS:
<a name="line-1845"></a>~~~~~
<a name="line-1846"></a>* Remove -fwrite-interface and have interface files always written in -fno-code
<a name="line-1847"></a>  mode
<a name="line-1848"></a>* Both .o and .dyn_o files are generated for template haskell, but we only need
<a name="line-1849"></a>  .dyn_o. Fix it.
<a name="line-1850"></a>* In make mode, a message like
<a name="line-1851"></a>  Compiling A (A.hs, /tmp/ghc_123.o)
<a name="line-1852"></a>  is shown if downsweep enabled object code generation for A. Perhaps we should
<a name="line-1853"></a>  show "nothing" or "temporary object file" instead. Note that one
<a name="line-1854"></a>  can currently use -keep-tmp-files and inspect the generated file with the
<a name="line-1855"></a>  current behaviour.
<a name="line-1856"></a>* Offer a -no-codedir command line option, and write what were temporary
<a name="line-1857"></a>  object files there. This would speed up recompilation.
<a name="line-1858"></a>* Use existing object files (if they are up to date) instead of always
<a name="line-1859"></a>  generating temporary ones.
<a name="line-1860"></a>-}</span>
<a name="line-1861"></a>
<a name="line-1862"></a><span class='hs-comment'>-- Note [Recompilation checking in -fno-code mode]</span>
<a name="line-1863"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-1864"></a><span class='hs-comment'>-- If we are compiling with -fno-code -fwrite-interface, there won't</span>
<a name="line-1865"></a><span class='hs-comment'>-- be any object code that we can compare against, nor should there</span>
<a name="line-1866"></a><span class='hs-comment'>-- be: we're *just* generating interface files.  In this case, we</span>
<a name="line-1867"></a><span class='hs-comment'>-- want to check if the interface file is new, in lieu of the object</span>
<a name="line-1868"></a><span class='hs-comment'>-- file.  See also #9243.</span>
<a name="line-1869"></a>
<a name="line-1870"></a><a name="retainInTopLevelEnvs"></a><span class='hs-comment'>-- Filter modules in the HPT</span>
<a name="line-1871"></a><span class='hs-definition'>retainInTopLevelEnvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HomePackageTable</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HomePackageTable</span>
<a name="line-1872"></a><span class='hs-definition'>retainInTopLevelEnvs</span> <span class='hs-varid'>keep_these</span> <span class='hs-varid'>hpt</span>
<a name="line-1873"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>listToHpt</span>   <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>mod</span><span class='hs-layout'>,</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"retain"</span> <span class='hs-varid'>mb_mod_info</span><span class='hs-layout'>)</span>
<a name="line-1874"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>keep_these</span>
<a name="line-1875"></a>                 <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mb_mod_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupHpt</span> <span class='hs-varid'>hpt</span> <span class='hs-varid'>mod</span>
<a name="line-1876"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>isJust</span> <span class='hs-varid'>mb_mod_info</span> <span class='hs-keyglyph'>]</span>
<a name="line-1877"></a>
<a name="line-1878"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-1879"></a><span class='hs-comment'>-- Typecheck module loops</span>
<a name="line-1880"></a><span class='hs-comment'>{-
<a name="line-1881"></a>See bug #930.  This code fixes a long-standing bug in --make.  The
<a name="line-1882"></a>problem is that when compiling the modules *inside* a loop, a data
<a name="line-1883"></a>type that is only defined at the top of the loop looks opaque; but
<a name="line-1884"></a>after the loop is done, the structure of the data type becomes
<a name="line-1885"></a>apparent.
<a name="line-1886"></a>
<a name="line-1887"></a>The difficulty is then that two different bits of code have
<a name="line-1888"></a>different notions of what the data type looks like.
<a name="line-1889"></a>
<a name="line-1890"></a>The idea is that after we compile a module which also has an .hs-boot
<a name="line-1891"></a>file, we re-generate the ModDetails for each of the modules that
<a name="line-1892"></a>depends on the .hs-boot file, so that everyone points to the proper
<a name="line-1893"></a>TyCons, Ids etc. defined by the real module, not the boot module.
<a name="line-1894"></a>Fortunately re-generating a ModDetails from a ModIface is easy: the
<a name="line-1895"></a>function GHC.IfaceToCore.typecheckIface does exactly that.
<a name="line-1896"></a>
<a name="line-1897"></a>Picking the modules to re-typecheck is slightly tricky.  Starting from
<a name="line-1898"></a>the module graph consisting of the modules that have already been
<a name="line-1899"></a>compiled, we reverse the edges (so they point from the imported module
<a name="line-1900"></a>to the importing module), and depth-first-search from the .hs-boot
<a name="line-1901"></a>node.  This gives us all the modules that depend transitively on the
<a name="line-1902"></a>.hs-boot module, and those are exactly the modules that we need to
<a name="line-1903"></a>re-typecheck.
<a name="line-1904"></a>
<a name="line-1905"></a>Following this fix, GHC can compile itself with --make -O2.
<a name="line-1906"></a>-}</span>
<a name="line-1907"></a>
<a name="line-1908"></a><a name="reTypecheckLoop"></a><span class='hs-definition'>reTypecheckLoop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>HscEnv</span>
<a name="line-1909"></a><span class='hs-definition'>reTypecheckLoop</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>ms</span> <span class='hs-varid'>graph</span>
<a name="line-1910"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>loop</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModLoop</span> <span class='hs-varid'>ms</span> <span class='hs-varid'>mss</span> <span class='hs-varid'>appearsAsBoot</span>
<a name="line-1911"></a>  <span class='hs-comment'>-- SOME hs-boot files should still</span>
<a name="line-1912"></a>  <span class='hs-comment'>-- get used, just not the loop-closer.</span>
<a name="line-1913"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>non_boot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flip</span> <span class='hs-varid'>mapMaybe</span> <span class='hs-varid'>loop</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>case</span>
<a name="line-1914"></a>          <span class='hs-conid'>InstantiationNode</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1915"></a>          <span class='hs-conid'>ModuleNode</span> <span class='hs-varid'>ems</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1916"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emsModSummary</span> <span class='hs-varid'>ems</span>
<a name="line-1917"></a>            <span class='hs-varid'>guard</span> <span class='hs-varop'>$</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>isBootSummary</span> <span class='hs-varid'>l</span> <span class='hs-varop'>==</span> <span class='hs-conid'>IsBoot</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>ms_mod</span> <span class='hs-varid'>l</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ms_mod</span> <span class='hs-varid'>ms</span>
<a name="line-1918"></a>            <span class='hs-varid'>pure</span> <span class='hs-varid'>l</span>
<a name="line-1919"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typecheckLoop</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ms_mod_name</span> <span class='hs-varid'>non_boot</span><span class='hs-layout'>)</span>
<a name="line-1920"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1921"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1922"></a>  <span class='hs-keyword'>where</span>
<a name="line-1923"></a>  <span class='hs-varid'>mss</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mgModSummaries'</span> <span class='hs-varid'>graph</span>
<a name="line-1924"></a>  <span class='hs-varid'>appearsAsBoot</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemModuleSet`</span> <span class='hs-varid'>mgBootModules</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span>
<a name="line-1925"></a>
<a name="line-1926"></a><a name="getModLoop"></a><span class='hs-comment'>-- | Given a non-boot ModSummary @ms@ of a module, for which there exists a</span>
<a name="line-1927"></a><span class='hs-comment'>-- corresponding boot file in @graph@, return the set of modules which</span>
<a name="line-1928"></a><span class='hs-comment'>-- transitively depend on this boot file.  This function is slightly misnamed,</span>
<a name="line-1929"></a><span class='hs-comment'>-- but its name "getModLoop" alludes to the fact that, when getModLoop is called</span>
<a name="line-1930"></a><span class='hs-comment'>-- with a graph that does not contain @ms@ (non-parallel case) or is an</span>
<a name="line-1931"></a><span class='hs-comment'>-- SCC with hs-boot nodes dropped (parallel-case), the modules which</span>
<a name="line-1932"></a><span class='hs-comment'>-- depend on the hs-boot file are typically (but not always) the</span>
<a name="line-1933"></a><span class='hs-comment'>-- modules participating in the recursive module loop.  The returned</span>
<a name="line-1934"></a><span class='hs-comment'>-- list includes the hs-boot file.</span>
<a name="line-1935"></a><span class='hs-comment'>--</span>
<a name="line-1936"></a><span class='hs-comment'>-- Example:</span>
<a name="line-1937"></a><span class='hs-comment'>--      let g represent the module graph:</span>
<a name="line-1938"></a><span class='hs-comment'>--          C.hs</span>
<a name="line-1939"></a><span class='hs-comment'>--          A.hs-boot imports C.hs</span>
<a name="line-1940"></a><span class='hs-comment'>--          B.hs imports A.hs-boot</span>
<a name="line-1941"></a><span class='hs-comment'>--          A.hs imports B.hs</span>
<a name="line-1942"></a><span class='hs-comment'>--      genModLoop A.hs g == Just [A.hs-boot, B.hs, A.hs]</span>
<a name="line-1943"></a><span class='hs-comment'>--</span>
<a name="line-1944"></a><span class='hs-comment'>--      It would also be permissible to omit A.hs from the graph,</span>
<a name="line-1945"></a><span class='hs-comment'>--      in which case the result is [A.hs-boot, B.hs]</span>
<a name="line-1946"></a><span class='hs-comment'>--</span>
<a name="line-1947"></a><span class='hs-comment'>-- Example:</span>
<a name="line-1948"></a><span class='hs-comment'>--      A counter-example to the claim that modules returned</span>
<a name="line-1949"></a><span class='hs-comment'>--      by this function participate in the loop occurs here:</span>
<a name="line-1950"></a><span class='hs-comment'>--</span>
<a name="line-1951"></a><span class='hs-comment'>--      let g represent the module graph:</span>
<a name="line-1952"></a><span class='hs-comment'>--          C.hs</span>
<a name="line-1953"></a><span class='hs-comment'>--          A.hs-boot imports C.hs</span>
<a name="line-1954"></a><span class='hs-comment'>--          B.hs imports A.hs-boot</span>
<a name="line-1955"></a><span class='hs-comment'>--          A.hs imports B.hs</span>
<a name="line-1956"></a><span class='hs-comment'>--          D.hs imports A.hs-boot</span>
<a name="line-1957"></a><span class='hs-comment'>--      genModLoop A.hs g == Just [A.hs-boot, B.hs, A.hs, D.hs]</span>
<a name="line-1958"></a><span class='hs-comment'>--</span>
<a name="line-1959"></a><span class='hs-comment'>--      Arguably, D.hs should import A.hs, not A.hs-boot, but</span>
<a name="line-1960"></a><span class='hs-comment'>--      a dependency on the boot file is not illegal.</span>
<a name="line-1961"></a><span class='hs-comment'>--</span>
<a name="line-1962"></a><span class='hs-definition'>getModLoop</span>
<a name="line-1963"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModSummary</span>
<a name="line-1964"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleGraphNode</span><span class='hs-keyglyph'>]</span>
<a name="line-1965"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- check if a module appears as a boot module in 'graph'</span>
<a name="line-1966"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleGraphNode</span><span class='hs-keyglyph'>]</span>
<a name="line-1967"></a><span class='hs-definition'>getModLoop</span> <span class='hs-varid'>ms</span> <span class='hs-varid'>graph</span> <span class='hs-varid'>appearsAsBoot</span>
<a name="line-1968"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isBootSummary</span> <span class='hs-varid'>ms</span> <span class='hs-varop'>==</span> <span class='hs-conid'>NotBoot</span>
<a name="line-1969"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>appearsAsBoot</span> <span class='hs-varid'>this_mod</span>
<a name="line-1970"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mss</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reachableBackwards</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_mod_name</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span> <span class='hs-varid'>graph</span>
<a name="line-1971"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>mss</span>
<a name="line-1972"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1973"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1974"></a> <span class='hs-keyword'>where</span>
<a name="line-1975"></a>  <span class='hs-varid'>this_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_mod</span> <span class='hs-varid'>ms</span>
<a name="line-1976"></a>
<a name="line-1977"></a><a name="typecheckLoop"></a><span class='hs-comment'>-- NB: sometimes mods has duplicates; this is harmless because</span>
<a name="line-1978"></a><span class='hs-comment'>-- any duplicates get clobbered in addListToHpt and never get forced.</span>
<a name="line-1979"></a><span class='hs-definition'>typecheckLoop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>HscEnv</span>
<a name="line-1980"></a><span class='hs-definition'>typecheckLoop</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1981"></a>  <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span>
<a name="line-1982"></a>     <span class='hs-varid'>text</span> <span class='hs-str'>"Re-typechecking loop: "</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mods</span>
<a name="line-1983"></a>  <span class='hs-varid'>new_hpt</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-1984"></a>    <span class='hs-varid'>fixIO</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>new_hpt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1985"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>new_hsc_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsc_HPT</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_hpt</span> <span class='hs-layout'>}</span>
<a name="line-1986"></a>      <span class='hs-varid'>mds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initIfaceCheck</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"typecheckLoop"</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_hsc_env</span> <span class='hs-varop'>$</span>
<a name="line-1987"></a>                <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>typecheckIface</span> <span class='hs-varop'>.</span> <span class='hs-varid'>hm_iface</span><span class='hs-layout'>)</span> <span class='hs-varid'>hmis</span>
<a name="line-1988"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>new_hpt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addListToHpt</span> <span class='hs-varid'>old_hpt</span>
<a name="line-1989"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-varid'>mods</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hmi</span><span class='hs-layout'>{</span> <span class='hs-varid'>hm_details</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>details</span> <span class='hs-layout'>}</span>
<a name="line-1990"></a>                                  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>hmi</span><span class='hs-layout'>,</span><span class='hs-varid'>details</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zip</span> <span class='hs-varid'>hmis</span> <span class='hs-varid'>mds</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1991"></a>      <span class='hs-varid'>return</span> <span class='hs-varid'>new_hpt</span>
<a name="line-1992"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsc_HPT</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_hpt</span> <span class='hs-layout'>}</span>
<a name="line-1993"></a>  <span class='hs-keyword'>where</span>
<a name="line-1994"></a>    <span class='hs-varid'>logger</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_logger</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1995"></a>    <span class='hs-varid'>old_hpt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1996"></a>    <span class='hs-varid'>hmis</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>expectJust</span> <span class='hs-str'>"typecheckLoop"</span> <span class='hs-varop'>.</span> <span class='hs-varid'>lookupHpt</span> <span class='hs-varid'>old_hpt</span><span class='hs-layout'>)</span> <span class='hs-varid'>mods</span>
<a name="line-1997"></a>
<a name="line-1998"></a><a name="reachableBackwards"></a><span class='hs-definition'>reachableBackwards</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleGraphNode</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleGraphNode</span><span class='hs-keyglyph'>]</span>
<a name="line-1999"></a><span class='hs-definition'>reachableBackwards</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>summaries</span>
<a name="line-2000"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>node_payload</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reachableG</span> <span class='hs-layout'>(</span><span class='hs-varid'>transposeG</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span> <span class='hs-varid'>root</span> <span class='hs-keyglyph'>]</span>
<a name="line-2001"></a>  <span class='hs-keyword'>where</span> <span class='hs-comment'>-- the rest just sets up the graph:</span>
<a name="line-2002"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>graph</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookup_node</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleGraphNodes</span> <span class='hs-conid'>False</span> <span class='hs-varid'>summaries</span>
<a name="line-2003"></a>        <span class='hs-varid'>root</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"reachableBackwards"</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookup_node</span> <span class='hs-varop'>$</span> <span class='hs-conid'>NodeKey_Module</span> <span class='hs-varop'>$</span> <span class='hs-conid'>GWIB</span> <span class='hs-varid'>mod</span> <span class='hs-conid'>IsBoot</span><span class='hs-layout'>)</span>
<a name="line-2004"></a>
<a name="line-2005"></a><a name="topSortModuleGraph"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-2006"></a><span class='hs-comment'>--</span>
<a name="line-2007"></a><span class='hs-comment'>-- | Topological sort of the module graph</span>
<a name="line-2008"></a><span class='hs-definition'>topSortModuleGraph</span>
<a name="line-2009"></a>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-2010"></a>          <span class='hs-comment'>-- ^ Drop hi-boot nodes? (see below)</span>
<a name="line-2011"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleGraph</span>
<a name="line-2012"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ModuleName</span>
<a name="line-2013"></a>             <span class='hs-comment'>-- ^ Root module name.  If @Nothing@, use the full graph.</span>
<a name="line-2014"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-conid'>ModuleGraphNode</span><span class='hs-keyglyph'>]</span>
<a name="line-2015"></a><span class='hs-comment'>-- ^ Calculate SCCs of the module graph, possibly dropping the hi-boot nodes</span>
<a name="line-2016"></a><span class='hs-comment'>-- The resulting list of strongly-connected-components is in topologically</span>
<a name="line-2017"></a><span class='hs-comment'>-- sorted order, starting with the module(s) at the bottom of the</span>
<a name="line-2018"></a><span class='hs-comment'>-- dependency graph (ie compile them first) and ending with the ones at</span>
<a name="line-2019"></a><span class='hs-comment'>-- the top.</span>
<a name="line-2020"></a><span class='hs-comment'>--</span>
<a name="line-2021"></a><span class='hs-comment'>-- Drop hi-boot nodes (first boolean arg)?</span>
<a name="line-2022"></a><span class='hs-comment'>--</span>
<a name="line-2023"></a><span class='hs-comment'>-- - @False@:   treat the hi-boot summaries as nodes of the graph,</span>
<a name="line-2024"></a><span class='hs-comment'>--              so the graph must be acyclic</span>
<a name="line-2025"></a><span class='hs-comment'>--</span>
<a name="line-2026"></a><span class='hs-comment'>-- - @True@:    eliminate the hi-boot nodes, and instead pretend</span>
<a name="line-2027"></a><span class='hs-comment'>--              the a source-import of Foo is an import of Foo</span>
<a name="line-2028"></a><span class='hs-comment'>--              The resulting graph has no hi-boot nodes, but can be cyclic</span>
<a name="line-2029"></a>
<a name="line-2030"></a><span class='hs-definition'>topSortModuleGraph</span> <span class='hs-varid'>drop_hs_boot_nodes</span> <span class='hs-varid'>module_graph</span> <span class='hs-varid'>mb_root_mod</span>
<a name="line-2031"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>summaryNodeSummary</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>stronglyConnCompG</span> <span class='hs-varid'>initial_graph</span>
<a name="line-2032"></a>  <span class='hs-keyword'>where</span>
<a name="line-2033"></a>    <span class='hs-varid'>summaries</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mgModSummaries'</span> <span class='hs-varid'>module_graph</span>
<a name="line-2034"></a>    <span class='hs-comment'>-- stronglyConnCompG flips the original order, so if we reverse</span>
<a name="line-2035"></a>    <span class='hs-comment'>-- the summaries we get a stable topological sort.</span>
<a name="line-2036"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>graph</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookup_node</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-2037"></a>      <span class='hs-varid'>moduleGraphNodes</span> <span class='hs-varid'>drop_hs_boot_nodes</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>summaries</span><span class='hs-layout'>)</span>
<a name="line-2038"></a>
<a name="line-2039"></a>    <span class='hs-varid'>initial_graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_root_mod</span> <span class='hs-keyword'>of</span>
<a name="line-2040"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>graph</span>
<a name="line-2041"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>root_mod</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2042"></a>            <span class='hs-comment'>-- restrict the graph to just those modules reachable from</span>
<a name="line-2043"></a>            <span class='hs-comment'>-- the specified module.  We do this by building a graph with</span>
<a name="line-2044"></a>            <span class='hs-comment'>-- the full set of nodes, and determining the reachable set from</span>
<a name="line-2045"></a>            <span class='hs-comment'>-- the specified node.</span>
<a name="line-2046"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>root</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookup_node</span> <span class='hs-varop'>$</span> <span class='hs-conid'>NodeKey_Module</span> <span class='hs-varop'>$</span> <span class='hs-conid'>GWIB</span> <span class='hs-varid'>root_mod</span> <span class='hs-conid'>NotBoot</span>
<a name="line-2047"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>graph</span> <span class='hs-varop'>`hasVertexG`</span> <span class='hs-varid'>node</span>
<a name="line-2048"></a>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>node</span>
<a name="line-2049"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2050"></a>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>throwGhcException</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProgramError</span> <span class='hs-str'>"module does not exist"</span><span class='hs-layout'>)</span>
<a name="line-2051"></a>            <span class='hs-keyword'>in</span> <span class='hs-varid'>graphFromEdgedVerticesUniq</span> <span class='hs-layout'>(</span><span class='hs-varid'>seq</span> <span class='hs-varid'>root</span> <span class='hs-layout'>(</span><span class='hs-varid'>reachableG</span> <span class='hs-varid'>graph</span> <span class='hs-varid'>root</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2052"></a>
<a name="line-2053"></a><a name="SummaryNode"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>SummaryNode</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Node</span> <span class='hs-conid'>Int</span> <span class='hs-conid'>ModuleGraphNode</span>
<a name="line-2054"></a>
<a name="line-2055"></a><a name="summaryNodeKey"></a><span class='hs-definition'>summaryNodeKey</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SummaryNode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-2056"></a><span class='hs-definition'>summaryNodeKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>node_key</span>
<a name="line-2057"></a>
<a name="line-2058"></a><a name="summaryNodeSummary"></a><span class='hs-definition'>summaryNodeSummary</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SummaryNode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleGraphNode</span>
<a name="line-2059"></a><span class='hs-definition'>summaryNodeSummary</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>node_payload</span>
<a name="line-2060"></a>
<a name="line-2061"></a><a name="unfilteredEdges"></a><span class='hs-comment'>-- | Collect the immediate dependencies of a ModuleGraphNode,</span>
<a name="line-2062"></a><span class='hs-comment'>-- optionally avoiding hs-boot dependencies.</span>
<a name="line-2063"></a><span class='hs-comment'>-- If the drop_hs_boot_nodes flag is False, and if this is a .hs and there is</span>
<a name="line-2064"></a><span class='hs-comment'>-- an equivalent .hs-boot, add a link from the former to the latter.  This</span>
<a name="line-2065"></a><span class='hs-comment'>-- has the effect of detecting bogus cases where the .hs-boot depends on the</span>
<a name="line-2066"></a><span class='hs-comment'>-- .hs, by introducing a cycle.  Additionally, it ensures that we will always</span>
<a name="line-2067"></a><span class='hs-comment'>-- process the .hs-boot before the .hs, and so the HomePackageTable will always</span>
<a name="line-2068"></a><span class='hs-comment'>-- have the most up to date information.</span>
<a name="line-2069"></a><span class='hs-definition'>unfilteredEdges</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleGraphNode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NodeKey</span><span class='hs-keyglyph'>]</span>
<a name="line-2070"></a><span class='hs-definition'>unfilteredEdges</span> <span class='hs-varid'>drop_hs_boot_nodes</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>case</span>
<a name="line-2071"></a>    <span class='hs-conid'>InstantiationNode</span> <span class='hs-varid'>iuid</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2072"></a>      <span class='hs-conid'>NodeKey_Module</span> <span class='hs-varop'>.</span> <span class='hs-varid'>flip</span> <span class='hs-conid'>GWIB</span> <span class='hs-conid'>NotBoot</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>uniqDSetToList</span> <span class='hs-layout'>(</span><span class='hs-varid'>instUnitHoles</span> <span class='hs-varid'>iuid</span><span class='hs-layout'>)</span>
<a name="line-2073"></a>    <span class='hs-conid'>ModuleNode</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExtendedModSummary</span> <span class='hs-varid'>ms</span> <span class='hs-varid'>bds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2074"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>NodeKey_Module</span> <span class='hs-varop'>.</span> <span class='hs-varid'>flip</span> <span class='hs-conid'>GWIB</span> <span class='hs-varid'>hs_boot_key</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>ms_home_srcimps</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span>
<a name="line-2075"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>NodeKey_Module</span> <span class='hs-varop'>.</span> <span class='hs-varid'>flip</span> <span class='hs-conid'>GWIB</span> <span class='hs-conid'>NotBoot</span>     <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>ms_home_imps</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span>
<a name="line-2076"></a>      <span class='hs-keyglyph'>[</span> <span class='hs-conid'>NodeKey_Module</span> <span class='hs-varop'>$</span> <span class='hs-conid'>GWIB</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_mod_name</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span> <span class='hs-conid'>IsBoot</span>
<a name="line-2077"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>drop_hs_boot_nodes</span> <span class='hs-varop'>||</span> <span class='hs-varid'>ms_hsc_src</span> <span class='hs-varid'>ms</span> <span class='hs-varop'>==</span> <span class='hs-conid'>HsBootFile</span>
<a name="line-2078"></a>      <span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span>
<a name="line-2079"></a>      <span class='hs-keyglyph'>[</span> <span class='hs-conid'>NodeKey_Unit</span> <span class='hs-varid'>inst_unit</span>
<a name="line-2080"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>inst_unit</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bds</span>
<a name="line-2081"></a>      <span class='hs-keyglyph'>]</span>
<a name="line-2082"></a>  <span class='hs-keyword'>where</span>
<a name="line-2083"></a>    <span class='hs-comment'>-- Drop hs-boot nodes by using HsSrcFile as the key</span>
<a name="line-2084"></a>    <span class='hs-varid'>hs_boot_key</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>drop_hs_boot_nodes</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NotBoot</span> <span class='hs-comment'>-- is regular mod or signature</span>
<a name="line-2085"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IsBoot</span>
<a name="line-2086"></a>
<a name="line-2087"></a><a name="moduleGraphNodes"></a><span class='hs-definition'>moduleGraphNodes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleGraphNode</span><span class='hs-keyglyph'>]</span>
<a name="line-2088"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Graph</span> <span class='hs-conid'>SummaryNode</span><span class='hs-layout'>,</span> <span class='hs-conid'>NodeKey</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SummaryNode</span><span class='hs-layout'>)</span>
<a name="line-2089"></a><span class='hs-definition'>moduleGraphNodes</span> <span class='hs-varid'>drop_hs_boot_nodes</span> <span class='hs-varid'>summaries</span> <span class='hs-keyglyph'>=</span>
<a name="line-2090"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>graphFromEdgedVerticesUniq</span> <span class='hs-varid'>nodes</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookup_node</span><span class='hs-layout'>)</span>
<a name="line-2091"></a>  <span class='hs-keyword'>where</span>
<a name="line-2092"></a>    <span class='hs-varid'>numbered_summaries</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zip</span> <span class='hs-varid'>summaries</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span>
<a name="line-2093"></a>
<a name="line-2094"></a>    <span class='hs-varid'>lookup_node</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NodeKey</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SummaryNode</span>
<a name="line-2095"></a>    <span class='hs-varid'>lookup_node</span> <span class='hs-varid'>key</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map.lookup</span> <span class='hs-varid'>key</span> <span class='hs-layout'>(</span><span class='hs-varid'>unNodeMap</span> <span class='hs-varid'>node_map</span><span class='hs-layout'>)</span>
<a name="line-2096"></a>
<a name="line-2097"></a>    <span class='hs-varid'>lookup_key</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NodeKey</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Int</span>
<a name="line-2098"></a>    <span class='hs-varid'>lookup_key</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>summaryNodeKey</span> <span class='hs-varop'>.</span> <span class='hs-varid'>lookup_node</span>
<a name="line-2099"></a>
<a name="line-2100"></a>    <span class='hs-varid'>node_map</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NodeMap</span> <span class='hs-conid'>SummaryNode</span>
<a name="line-2101"></a>    <span class='hs-varid'>node_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NodeMap</span> <span class='hs-varop'>$</span>
<a name="line-2102"></a>      <span class='hs-conid'>Map.fromList</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHomeBuildModule</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>node</span><span class='hs-layout'>)</span>
<a name="line-2103"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nodes</span>
<a name="line-2104"></a>                   <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>summaryNodeSummary</span> <span class='hs-varid'>node</span>
<a name="line-2105"></a>                   <span class='hs-keyglyph'>]</span>
<a name="line-2106"></a>
<a name="line-2107"></a>    <span class='hs-comment'>-- We use integers as the keys for the SCC algorithm</span>
<a name="line-2108"></a>    <span class='hs-varid'>nodes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SummaryNode</span><span class='hs-keyglyph'>]</span>
<a name="line-2109"></a>    <span class='hs-varid'>nodes</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>DigraphNode</span> <span class='hs-varid'>s</span> <span class='hs-varid'>key</span> <span class='hs-varop'>$</span> <span class='hs-varid'>out_edge_keys</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unfilteredEdges</span> <span class='hs-varid'>drop_hs_boot_nodes</span> <span class='hs-varid'>s</span>
<a name="line-2110"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>key</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>numbered_summaries</span>
<a name="line-2111"></a>             <span class='hs-comment'>-- Drop the hi-boot ones if told to do so</span>
<a name="line-2112"></a>            <span class='hs-layout'>,</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>of</span>
<a name="line-2113"></a>                <span class='hs-conid'>InstantiationNode</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-2114"></a>                <span class='hs-conid'>ModuleNode</span> <span class='hs-varid'>ems</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>isBootSummary</span> <span class='hs-layout'>(</span><span class='hs-varid'>emsModSummary</span> <span class='hs-varid'>ems</span><span class='hs-layout'>)</span> <span class='hs-varop'>==</span> <span class='hs-conid'>IsBoot</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>drop_hs_boot_nodes</span>
<a name="line-2115"></a>            <span class='hs-keyglyph'>]</span>
<a name="line-2116"></a>
<a name="line-2117"></a>    <span class='hs-varid'>out_edge_keys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NodeKey</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Int</span><span class='hs-keyglyph'>]</span>
<a name="line-2118"></a>    <span class='hs-varid'>out_edge_keys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapMaybe</span> <span class='hs-varid'>lookup_key</span>
<a name="line-2119"></a>        <span class='hs-comment'>-- If we want keep_hi_boot_nodes, then we do lookup_key with</span>
<a name="line-2120"></a>        <span class='hs-comment'>-- IsBoot; else False</span>
<a name="line-2121"></a>
<a name="line-2122"></a><a name="ModNodeKey"></a><span class='hs-comment'>-- The nodes of the graph are keyed by (mod, is boot?) pairs for the current</span>
<a name="line-2123"></a><a name="ModNodeKey"></a><span class='hs-comment'>-- modules, and indefinite unit IDs for dependencies which are instantiated with</span>
<a name="line-2124"></a><a name="ModNodeKey"></a><span class='hs-comment'>-- our holes.</span>
<a name="line-2125"></a><a name="ModNodeKey"></a><span class='hs-comment'>--</span>
<a name="line-2126"></a><a name="ModNodeKey"></a><span class='hs-comment'>-- NB: hsig files show up as *normal* nodes (not boot!), since they don't</span>
<a name="line-2127"></a><a name="ModNodeKey"></a><span class='hs-comment'>-- participate in cycles (for now)</span>
<a name="line-2128"></a><a name="ModNodeKey"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ModNodeKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModuleNameWithIsBoot</span>
<a name="line-2129"></a><a name="ModNodeMap"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>ModNodeMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModNodeMap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unModNodeMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Map.Map</span> <span class='hs-conid'>ModNodeKey</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span>
<a name="line-2130"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Functor</span><span class='hs-layout'>,</span> <span class='hs-conid'>Traversable</span><span class='hs-layout'>,</span> <span class='hs-conid'>Foldable</span><span class='hs-layout'>)</span>
<a name="line-2131"></a>
<a name="line-2132"></a><a name="emptyModNodeMap"></a><span class='hs-definition'>emptyModNodeMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModNodeMap</span> <span class='hs-varid'>a</span>
<a name="line-2133"></a><span class='hs-definition'>emptyModNodeMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModNodeMap</span> <span class='hs-conid'>Map.empty</span>
<a name="line-2134"></a>
<a name="line-2135"></a><a name="modNodeMapInsert"></a><span class='hs-definition'>modNodeMapInsert</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModNodeKey</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModNodeMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModNodeMap</span> <span class='hs-varid'>a</span>
<a name="line-2136"></a><span class='hs-definition'>modNodeMapInsert</span> <span class='hs-varid'>k</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModNodeMap</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModNodeMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map.insert</span> <span class='hs-varid'>k</span> <span class='hs-varid'>v</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-2137"></a>
<a name="line-2138"></a><a name="modNodeMapElems"></a><span class='hs-definition'>modNodeMapElems</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModNodeMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-2139"></a><span class='hs-definition'>modNodeMapElems</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModNodeMap</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map.elems</span> <span class='hs-varid'>m</span>
<a name="line-2140"></a>
<a name="line-2141"></a><a name="modNodeMapLookup"></a><span class='hs-definition'>modNodeMapLookup</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModNodeKey</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModNodeMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>
<a name="line-2142"></a><span class='hs-definition'>modNodeMapLookup</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModNodeMap</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map.lookup</span> <span class='hs-varid'>k</span> <span class='hs-varid'>m</span>
<a name="line-2143"></a>
<a name="line-2144"></a><a name="NodeKey"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>NodeKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NodeKey_Unit</span> <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>InstantiatedUnit</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NodeKey_Module</span> <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>ModNodeKey</span>
<a name="line-2145"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span><span class='hs-layout'>)</span>
<a name="line-2146"></a>
<a name="line-2147"></a><a name="NodeMap"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>NodeMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NodeMap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unNodeMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Map.Map</span> <span class='hs-conid'>NodeKey</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span>
<a name="line-2148"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Functor</span><span class='hs-layout'>,</span> <span class='hs-conid'>Traversable</span><span class='hs-layout'>,</span> <span class='hs-conid'>Foldable</span><span class='hs-layout'>)</span>
<a name="line-2149"></a>
<a name="line-2150"></a><a name="msKey"></a><span class='hs-definition'>msKey</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModNodeKey</span>
<a name="line-2151"></a><span class='hs-definition'>msKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHomeBuildModule0</span>
<a name="line-2152"></a>
<a name="line-2153"></a><a name="mkNodeKey"></a><span class='hs-definition'>mkNodeKey</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleGraphNode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NodeKey</span>
<a name="line-2154"></a><span class='hs-definition'>mkNodeKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>case</span>
<a name="line-2155"></a>  <span class='hs-conid'>InstantiationNode</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NodeKey_Unit</span> <span class='hs-varid'>x</span>
<a name="line-2156"></a>  <span class='hs-conid'>ModuleNode</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NodeKey_Module</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHomeBuildModule0</span> <span class='hs-layout'>(</span><span class='hs-varid'>emsModSummary</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-2157"></a>
<a name="line-2158"></a><a name="pprNodeKey"></a><span class='hs-definition'>pprNodeKey</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NodeKey</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2159"></a><span class='hs-definition'>pprNodeKey</span> <span class='hs-layout'>(</span><span class='hs-conid'>NodeKey_Unit</span> <span class='hs-varid'>iu</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>iu</span>
<a name="line-2160"></a><span class='hs-definition'>pprNodeKey</span> <span class='hs-layout'>(</span><span class='hs-conid'>NodeKey_Module</span> <span class='hs-varid'>mk</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mk</span>
<a name="line-2161"></a>
<a name="line-2162"></a><a name="mkNodeMap"></a><span class='hs-definition'>mkNodeMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ExtendedModSummary</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModNodeMap</span> <span class='hs-conid'>ExtendedModSummary</span>
<a name="line-2163"></a><span class='hs-definition'>mkNodeMap</span> <span class='hs-varid'>summaries</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModNodeMap</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Map.fromList</span>
<a name="line-2164"></a>  <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>msKey</span> <span class='hs-varop'>$</span> <span class='hs-varid'>emsModSummary</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>summaries</span><span class='hs-keyglyph'>]</span>
<a name="line-2165"></a>
<a name="line-2166"></a><a name="warnUnnecessarySourceImports"></a><span class='hs-comment'>-- | If there are {-# SOURCE #-} imports between strongly connected</span>
<a name="line-2167"></a><span class='hs-comment'>-- components in the topological sort, then those imports can</span>
<a name="line-2168"></a><span class='hs-comment'>-- definitely be replaced by ordinary non-SOURCE imports: if SOURCE</span>
<a name="line-2169"></a><span class='hs-comment'>-- were necessary, then the edge would be part of a cycle.</span>
<a name="line-2170"></a><span class='hs-definition'>warnUnnecessarySourceImports</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-conid'>ModSummary</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-2171"></a><span class='hs-definition'>warnUnnecessarySourceImports</span> <span class='hs-varid'>sccs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2172"></a>  <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-2173"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>wopt</span> <span class='hs-conid'>Opt_WarnUnusedImports</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-2174"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>logWarnings</span> <span class='hs-layout'>(</span><span class='hs-varid'>listToBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>check</span> <span class='hs-varop'>.</span> <span class='hs-varid'>flattenSCC</span><span class='hs-layout'>)</span> <span class='hs-varid'>sccs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2175"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>check</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>=</span>
<a name="line-2176"></a>           <span class='hs-keyword'>let</span> <span class='hs-varid'>mods_in_this_cycle</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>ms_mod_name</span> <span class='hs-varid'>ms</span> <span class='hs-keyword'>in</span>
<a name="line-2177"></a>           <span class='hs-keyglyph'>[</span> <span class='hs-varid'>warn</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ms</span><span class='hs-layout'>,</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ms_home_srcimps</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span>
<a name="line-2178"></a>                      <span class='hs-varid'>unLoc</span> <span class='hs-varid'>i</span> <span class='hs-varop'>`notElem`</span>  <span class='hs-varid'>mods_in_this_cycle</span> <span class='hs-keyglyph'>]</span>
<a name="line-2179"></a>
<a name="line-2180"></a>        <span class='hs-varid'>warn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WarnMsg</span>
<a name="line-2181"></a>        <span class='hs-varid'>warn</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-2182"></a>           <span class='hs-varid'>mkPlainMsgEnvelope</span> <span class='hs-varid'>loc</span>
<a name="line-2183"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Warning: {-# SOURCE #-} unnecessary in import of "</span>
<a name="line-2184"></a>                 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2185"></a>
<a name="line-2186"></a>
<a name="line-2187"></a><a name="downsweep"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-2188"></a><span class='hs-comment'>--</span>
<a name="line-2189"></a><span class='hs-comment'>-- | Downsweep (dependency analysis)</span>
<a name="line-2190"></a><span class='hs-comment'>--</span>
<a name="line-2191"></a><span class='hs-comment'>-- Chase downwards from the specified root set, returning summaries</span>
<a name="line-2192"></a><span class='hs-comment'>-- for all home modules encountered.  Only follow source-import</span>
<a name="line-2193"></a><span class='hs-comment'>-- links.</span>
<a name="line-2194"></a><span class='hs-comment'>--</span>
<a name="line-2195"></a><span class='hs-comment'>-- We pass in the previous collection of summaries, which is used as a</span>
<a name="line-2196"></a><span class='hs-comment'>-- cache to avoid recalculating a module summary if the source is</span>
<a name="line-2197"></a><span class='hs-comment'>-- unchanged.</span>
<a name="line-2198"></a><span class='hs-comment'>--</span>
<a name="line-2199"></a><span class='hs-comment'>-- The returned list of [ModSummary] nodes has one node for each home-package</span>
<a name="line-2200"></a><span class='hs-comment'>-- module, plus one for any hs-boot files.  The imports of these nodes</span>
<a name="line-2201"></a><span class='hs-comment'>-- are all there, including the imports of non-home-package modules.</span>
<a name="line-2202"></a><span class='hs-definition'>downsweep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-2203"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ExtendedModSummary</span><span class='hs-keyglyph'>]</span>
<a name="line-2204"></a>          <span class='hs-comment'>-- ^ Old summaries</span>
<a name="line-2205"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleName</span><span class='hs-keyglyph'>]</span>       <span class='hs-comment'>-- Ignore dependencies on these; treat</span>
<a name="line-2206"></a>                                <span class='hs-comment'>-- them as if they were package modules</span>
<a name="line-2207"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>               <span class='hs-comment'>-- True &lt;=&gt; allow multiple targets to have</span>
<a name="line-2208"></a>                                <span class='hs-comment'>--          the same module name; this is</span>
<a name="line-2209"></a>                                <span class='hs-comment'>--          very useful for ghc -M</span>
<a name="line-2210"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Either</span> <span class='hs-conid'>ErrorMessages</span> <span class='hs-conid'>ExtendedModSummary</span><span class='hs-keyglyph'>]</span>
<a name="line-2211"></a>                <span class='hs-comment'>-- The non-error elements of the returned list all have distinct</span>
<a name="line-2212"></a>                <span class='hs-comment'>-- (Modules, IsBoot) identifiers, unless the Bool is true in</span>
<a name="line-2213"></a>                <span class='hs-comment'>-- which case there can be repeats</span>
<a name="line-2214"></a><span class='hs-definition'>downsweep</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>old_summaries</span> <span class='hs-varid'>excl_mods</span> <span class='hs-varid'>allow_dup_roots</span>
<a name="line-2215"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2216"></a>       <span class='hs-varid'>rootSummaries</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>getRootSummary</span> <span class='hs-varid'>roots</span>
<a name="line-2217"></a>       <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>errs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rootSummariesOk</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionEithers</span> <span class='hs-varid'>rootSummaries</span> <span class='hs-comment'>-- #17549</span>
<a name="line-2218"></a>           <span class='hs-varid'>root_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRootMap</span> <span class='hs-varid'>rootSummariesOk</span>
<a name="line-2219"></a>       <span class='hs-varid'>checkDuplicates</span> <span class='hs-varid'>root_map</span>
<a name="line-2220"></a>       <span class='hs-varid'>map0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loop</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-varid'>calcDeps</span> <span class='hs-varid'>rootSummariesOk</span><span class='hs-layout'>)</span> <span class='hs-varid'>root_map</span>
<a name="line-2221"></a>       <span class='hs-comment'>-- if we have been passed -fno-code, we enable code generation</span>
<a name="line-2222"></a>       <span class='hs-comment'>-- for dependencies of modules that have -XTemplateHaskell,</span>
<a name="line-2223"></a>       <span class='hs-comment'>-- otherwise those modules will fail to compile.</span>
<a name="line-2224"></a>       <span class='hs-comment'>-- See Note [-fno-code mode] #8025</span>
<a name="line-2225"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>default_backend</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>platformDefaultBackend</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-2226"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>home_unit</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_home_unit</span> <span class='hs-varid'>hsc_env</span>
<a name="line-2227"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>tmpfs</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_tmpfs</span>     <span class='hs-varid'>hsc_env</span>
<a name="line-2228"></a>       <span class='hs-varid'>map1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>backend</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>of</span>
<a name="line-2229"></a>         <span class='hs-conid'>NoBackend</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>enableCodeGenForTH</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>tmpfs</span> <span class='hs-varid'>home_unit</span> <span class='hs-varid'>default_backend</span> <span class='hs-varid'>map0</span>
<a name="line-2230"></a>         <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>map0</span>
<a name="line-2231"></a>       <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>errs</span>
<a name="line-2232"></a>         <span class='hs-keyword'>then</span> <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-varid'>concat</span> <span class='hs-varop'>$</span> <span class='hs-varid'>modNodeMapElems</span> <span class='hs-varid'>map1</span>
<a name="line-2233"></a>         <span class='hs-keyword'>else</span> <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Left</span> <span class='hs-varid'>errs</span>
<a name="line-2234"></a>     <span class='hs-keyword'>where</span>
<a name="line-2235"></a>        <span class='hs-comment'>-- TODO(@Ericson2314): Probably want to include backpack instantiations</span>
<a name="line-2236"></a>        <span class='hs-comment'>-- in the map eventually for uniformity</span>
<a name="line-2237"></a>        <span class='hs-varid'>calcDeps</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExtendedModSummary</span> <span class='hs-varid'>ms</span> <span class='hs-sel'>_bkp_deps</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>msDeps</span> <span class='hs-varid'>ms</span>
<a name="line-2238"></a>
<a name="line-2239"></a>        <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-2240"></a>        <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_logger</span> <span class='hs-varid'>hsc_env</span>
<a name="line-2241"></a>        <span class='hs-varid'>roots</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_targets</span> <span class='hs-varid'>hsc_env</span>
<a name="line-2242"></a>
<a name="line-2243"></a>        <span class='hs-varid'>old_summary_map</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModNodeMap</span> <span class='hs-conid'>ExtendedModSummary</span>
<a name="line-2244"></a>        <span class='hs-varid'>old_summary_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNodeMap</span> <span class='hs-varid'>old_summaries</span>
<a name="line-2245"></a>
<a name="line-2246"></a>        <span class='hs-varid'>getRootSummary</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Target</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-conid'>ErrorMessages</span> <span class='hs-conid'>ExtendedModSummary</span><span class='hs-layout'>)</span>
<a name="line-2247"></a>        <span class='hs-varid'>getRootSummary</span> <span class='hs-layout'>(</span><span class='hs-conid'>Target</span> <span class='hs-layout'>(</span><span class='hs-conid'>TargetFile</span> <span class='hs-varid'>file</span> <span class='hs-varid'>mb_phase</span><span class='hs-layout'>)</span> <span class='hs-varid'>obj_allowed</span> <span class='hs-varid'>maybe_buf</span><span class='hs-layout'>)</span>
<a name="line-2248"></a>           <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>exists</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>doesFileExist</span> <span class='hs-varid'>file</span>
<a name="line-2249"></a>                <span class='hs-keyword'>if</span> <span class='hs-varid'>exists</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isJust</span> <span class='hs-varid'>maybe_buf</span>
<a name="line-2250"></a>                    <span class='hs-keyword'>then</span> <span class='hs-varid'>summariseFile</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>old_summaries</span> <span class='hs-varid'>file</span> <span class='hs-varid'>mb_phase</span>
<a name="line-2251"></a>                                       <span class='hs-varid'>obj_allowed</span> <span class='hs-varid'>maybe_buf</span>
<a name="line-2252"></a>                    <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Left</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unitBag</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkPlainMsgEnvelope</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-varop'>$</span>
<a name="line-2253"></a>                           <span class='hs-varid'>text</span> <span class='hs-str'>"can't find file:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>file</span>
<a name="line-2254"></a>        <span class='hs-varid'>getRootSummary</span> <span class='hs-layout'>(</span><span class='hs-conid'>Target</span> <span class='hs-layout'>(</span><span class='hs-conid'>TargetModule</span> <span class='hs-varid'>modl</span><span class='hs-layout'>)</span> <span class='hs-varid'>obj_allowed</span> <span class='hs-varid'>maybe_buf</span><span class='hs-layout'>)</span>
<a name="line-2255"></a>           <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>maybe_summary</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>summariseModule</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>old_summary_map</span> <span class='hs-conid'>NotBoot</span>
<a name="line-2256"></a>                                           <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>rootLoc</span> <span class='hs-varid'>modl</span><span class='hs-layout'>)</span> <span class='hs-varid'>obj_allowed</span>
<a name="line-2257"></a>                                           <span class='hs-varid'>maybe_buf</span> <span class='hs-varid'>excl_mods</span>
<a name="line-2258"></a>                <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_summary</span> <span class='hs-keyword'>of</span>
<a name="line-2259"></a>                   <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Left</span> <span class='hs-varop'>$</span> <span class='hs-varid'>moduleNotFoundErr</span> <span class='hs-varid'>modl</span>
<a name="line-2260"></a>                   <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>s</span>
<a name="line-2261"></a>
<a name="line-2262"></a>        <span class='hs-varid'>rootLoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkGeneralSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"&lt;command line&gt;"</span><span class='hs-layout'>)</span>
<a name="line-2263"></a>
<a name="line-2264"></a>        <span class='hs-comment'>-- In a root module, the filename is allowed to diverge from the module</span>
<a name="line-2265"></a>        <span class='hs-comment'>-- name, so we have to check that there aren't multiple root files</span>
<a name="line-2266"></a>        <span class='hs-comment'>-- defining the same module (otherwise the duplicates will be silently</span>
<a name="line-2267"></a>        <span class='hs-comment'>-- ignored, leading to confusing behaviour).</span>
<a name="line-2268"></a>        <span class='hs-varid'>checkDuplicates</span>
<a name="line-2269"></a>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModNodeMap</span>
<a name="line-2270"></a>               <span class='hs-keyglyph'>[</span><span class='hs-conid'>Either</span> <span class='hs-conid'>ErrorMessages</span>
<a name="line-2271"></a>                       <span class='hs-conid'>ExtendedModSummary</span><span class='hs-keyglyph'>]</span>
<a name="line-2272"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-2273"></a>        <span class='hs-varid'>checkDuplicates</span> <span class='hs-varid'>root_map</span>
<a name="line-2274"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>allow_dup_roots</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-2275"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>dup_roots</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-2276"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>multiRootsErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>emsModSummary</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>head</span> <span class='hs-varid'>dup_roots</span><span class='hs-layout'>)</span>
<a name="line-2277"></a>           <span class='hs-keyword'>where</span>
<a name="line-2278"></a>             <span class='hs-varid'>dup_roots</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>ExtendedModSummary</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- Each at least of length 2</span>
<a name="line-2279"></a>             <span class='hs-varid'>dup_roots</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOut</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>rights</span> <span class='hs-varop'>$</span> <span class='hs-varid'>modNodeMapElems</span> <span class='hs-varid'>root_map</span>
<a name="line-2280"></a>
<a name="line-2281"></a>        <span class='hs-varid'>loop</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GenWithIsBoot</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-conid'>ModuleName</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-2282"></a>                        <span class='hs-comment'>-- Work list: process these modules</span>
<a name="line-2283"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModNodeMap</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Either</span> <span class='hs-conid'>ErrorMessages</span> <span class='hs-conid'>ExtendedModSummary</span><span class='hs-keyglyph'>]</span>
<a name="line-2284"></a>                        <span class='hs-comment'>-- Visited set; the range is a list because</span>
<a name="line-2285"></a>                        <span class='hs-comment'>-- the roots can have the same module names</span>
<a name="line-2286"></a>                        <span class='hs-comment'>-- if allow_dup_roots is True</span>
<a name="line-2287"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModNodeMap</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Either</span> <span class='hs-conid'>ErrorMessages</span> <span class='hs-conid'>ExtendedModSummary</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2288"></a>                        <span class='hs-comment'>-- The result is the completed NodeMap</span>
<a name="line-2289"></a>        <span class='hs-varid'>loop</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>done</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>done</span>
<a name="line-2290"></a>        <span class='hs-varid'>loop</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-varid'>done</span>
<a name="line-2291"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>summs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>modNodeMapLookup</span> <span class='hs-varid'>key</span> <span class='hs-varid'>done</span>
<a name="line-2292"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>summs</span> <span class='hs-keyword'>then</span>
<a name="line-2293"></a>                <span class='hs-varid'>loop</span> <span class='hs-varid'>ss</span> <span class='hs-varid'>done</span>
<a name="line-2294"></a>            <span class='hs-keyword'>else</span>
<a name="line-2295"></a>                <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>multiRootsErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>emsModSummary</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>rights</span> <span class='hs-varid'>summs</span><span class='hs-layout'>)</span>
<a name="line-2296"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModNodeMap</span> <span class='hs-conid'>Map.empty</span><span class='hs-layout'>)</span>
<a name="line-2297"></a>                   <span class='hs-layout'>}</span>
<a name="line-2298"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2299"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>mb_s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>summariseModule</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>old_summary_map</span>
<a name="line-2300"></a>                                       <span class='hs-varid'>is_boot</span> <span class='hs-varid'>wanted_mod</span> <span class='hs-conid'>True</span>
<a name="line-2301"></a>                                       <span class='hs-conid'>Nothing</span> <span class='hs-varid'>excl_mods</span>
<a name="line-2302"></a>               <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_s</span> <span class='hs-keyword'>of</span>
<a name="line-2303"></a>                   <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>loop</span> <span class='hs-varid'>ss</span> <span class='hs-varid'>done</span>
<a name="line-2304"></a>                   <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>loop</span> <span class='hs-varid'>ss</span> <span class='hs-layout'>(</span><span class='hs-varid'>modNodeMapInsert</span> <span class='hs-varid'>key</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Left</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>done</span><span class='hs-layout'>)</span>
<a name="line-2305"></a>                   <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-2306"></a>                     <span class='hs-varid'>new_map</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-2307"></a>                       <span class='hs-varid'>loop</span> <span class='hs-layout'>(</span><span class='hs-varid'>calcDeps</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>modNodeMapInsert</span> <span class='hs-varid'>key</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Right</span> <span class='hs-varid'>s</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>done</span><span class='hs-layout'>)</span>
<a name="line-2308"></a>                     <span class='hs-varid'>loop</span> <span class='hs-varid'>ss</span> <span class='hs-varid'>new_map</span>
<a name="line-2309"></a>          <span class='hs-keyword'>where</span>
<a name="line-2310"></a>            <span class='hs-conid'>GWIB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gwib_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>mod</span><span class='hs-layout'>,</span> <span class='hs-varid'>gwib_isBoot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_boot</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span>
<a name="line-2311"></a>            <span class='hs-varid'>wanted_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>mod</span>
<a name="line-2312"></a>            <span class='hs-varid'>key</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GWIB</span>
<a name="line-2313"></a>                    <span class='hs-layout'>{</span> <span class='hs-varid'>gwib_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>wanted_mod</span>
<a name="line-2314"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>gwib_isBoot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_boot</span>
<a name="line-2315"></a>                    <span class='hs-layout'>}</span>
<a name="line-2316"></a>
<a name="line-2317"></a><a name="enableCodeGenForTH"></a><span class='hs-comment'>-- | Update the every ModSummary that is depended on</span>
<a name="line-2318"></a><span class='hs-comment'>-- by a module that needs template haskell. We enable codegen to</span>
<a name="line-2319"></a><span class='hs-comment'>-- the specified target, disable optimization and change the .hi</span>
<a name="line-2320"></a><span class='hs-comment'>-- and .o file locations to be temporary files.</span>
<a name="line-2321"></a><span class='hs-comment'>-- See Note [-fno-code mode]</span>
<a name="line-2322"></a><span class='hs-definition'>enableCodeGenForTH</span>
<a name="line-2323"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Logger</span>
<a name="line-2324"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TmpFs</span>
<a name="line-2325"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HomeUnit</span>
<a name="line-2326"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Backend</span>
<a name="line-2327"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModNodeMap</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Either</span> <span class='hs-conid'>ErrorMessages</span> <span class='hs-conid'>ExtendedModSummary</span><span class='hs-keyglyph'>]</span>
<a name="line-2328"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModNodeMap</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Either</span> <span class='hs-conid'>ErrorMessages</span> <span class='hs-conid'>ExtendedModSummary</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2329"></a><span class='hs-definition'>enableCodeGenForTH</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>tmpfs</span> <span class='hs-varid'>home_unit</span> <span class='hs-keyglyph'>=</span>
<a name="line-2330"></a>  <span class='hs-varid'>enableCodeGenWhen</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>tmpfs</span> <span class='hs-varid'>condition</span> <span class='hs-varid'>should_modify</span> <span class='hs-conid'>TFL_CurrentModule</span> <span class='hs-conid'>TFL_GhcSession</span>
<a name="line-2331"></a>  <span class='hs-keyword'>where</span>
<a name="line-2332"></a>    <span class='hs-varid'>condition</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTemplateHaskellOrQQNonBoot</span>
<a name="line-2333"></a>    <span class='hs-varid'>should_modify</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModSummary</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ms_hspp_opts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-2334"></a>      <span class='hs-varid'>backend</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>==</span> <span class='hs-conid'>NoBackend</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-2335"></a>      <span class='hs-comment'>-- Don't enable codegen for TH on indefinite packages; we</span>
<a name="line-2336"></a>      <span class='hs-comment'>-- can't compile anything anyway! See #16219.</span>
<a name="line-2337"></a>      <span class='hs-varid'>isHomeUnitDefinite</span> <span class='hs-varid'>home_unit</span>
<a name="line-2338"></a>
<a name="line-2339"></a><a name="enableCodeGenWhen"></a><span class='hs-comment'>-- | Helper used to implement 'enableCodeGenForTH'.</span>
<a name="line-2340"></a><span class='hs-comment'>-- In particular, this enables</span>
<a name="line-2341"></a><span class='hs-comment'>-- unoptimized code generation for all modules that meet some</span>
<a name="line-2342"></a><span class='hs-comment'>-- condition (first parameter), or are dependencies of those</span>
<a name="line-2343"></a><span class='hs-comment'>-- modules. The second parameter is a condition to check before</span>
<a name="line-2344"></a><span class='hs-comment'>-- marking modules for code generation.</span>
<a name="line-2345"></a><span class='hs-definition'>enableCodeGenWhen</span>
<a name="line-2346"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Logger</span>
<a name="line-2347"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TmpFs</span>
<a name="line-2348"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>
<a name="line-2349"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>
<a name="line-2350"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TempFileLifetime</span>
<a name="line-2351"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TempFileLifetime</span>
<a name="line-2352"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Backend</span>
<a name="line-2353"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModNodeMap</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Either</span> <span class='hs-conid'>ErrorMessages</span> <span class='hs-conid'>ExtendedModSummary</span><span class='hs-keyglyph'>]</span>
<a name="line-2354"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModNodeMap</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Either</span> <span class='hs-conid'>ErrorMessages</span> <span class='hs-conid'>ExtendedModSummary</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2355"></a><span class='hs-definition'>enableCodeGenWhen</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>tmpfs</span> <span class='hs-varid'>condition</span> <span class='hs-varid'>should_modify</span> <span class='hs-varid'>staticLife</span> <span class='hs-varid'>dynLife</span> <span class='hs-varid'>bcknd</span> <span class='hs-varid'>nodemap</span> <span class='hs-keyglyph'>=</span>
<a name="line-2356"></a>  <span class='hs-varid'>traverse</span> <span class='hs-layout'>(</span><span class='hs-varid'>traverse</span> <span class='hs-layout'>(</span><span class='hs-varid'>traverse</span> <span class='hs-varid'>enable_code_gen</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>nodemap</span>
<a name="line-2357"></a>  <span class='hs-keyword'>where</span>
<a name="line-2358"></a>    <span class='hs-varid'>enable_code_gen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExtendedModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ExtendedModSummary</span>
<a name="line-2359"></a>    <span class='hs-varid'>enable_code_gen</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExtendedModSummary</span> <span class='hs-varid'>ms</span> <span class='hs-varid'>bkp_deps</span><span class='hs-layout'>)</span>
<a name="line-2360"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ModSummary</span>
<a name="line-2361"></a>        <span class='hs-layout'>{</span> <span class='hs-varid'>ms_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_mod</span>
<a name="line-2362"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ms_location</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_location</span>
<a name="line-2363"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ms_hsc_src</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsSrcFile</span>
<a name="line-2364"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ms_hspp_opts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dflags</span>
<a name="line-2365"></a>        <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ms</span>
<a name="line-2366"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>should_modify</span> <span class='hs-varid'>ms</span>
<a name="line-2367"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ms_mod</span> <span class='hs-varop'>`Set.member`</span> <span class='hs-varid'>needs_codegen_set</span>
<a name="line-2368"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2369"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>new_temp_file</span> <span class='hs-varid'>suf</span> <span class='hs-varid'>dynsuf</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2370"></a>              <span class='hs-varid'>tn</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTempName</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>tmpfs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>staticLife</span> <span class='hs-varid'>suf</span>
<a name="line-2371"></a>              <span class='hs-keyword'>let</span> <span class='hs-varid'>dyn_tn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tn</span> <span class='hs-varop'>-&lt;.&gt;</span> <span class='hs-varid'>dynsuf</span>
<a name="line-2372"></a>              <span class='hs-varid'>addFilesToClean</span> <span class='hs-varid'>tmpfs</span> <span class='hs-varid'>dynLife</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dyn_tn</span><span class='hs-keyglyph'>]</span>
<a name="line-2373"></a>              <span class='hs-varid'>return</span> <span class='hs-varid'>tn</span>
<a name="line-2374"></a>          <span class='hs-comment'>-- We don't want to create .o or .hi files unless we have been asked</span>
<a name="line-2375"></a>          <span class='hs-comment'>-- to by the user. But we need them, so we patch their locations in</span>
<a name="line-2376"></a>          <span class='hs-comment'>-- the ModSummary with temporary files.</span>
<a name="line-2377"></a>          <span class='hs-comment'>--</span>
<a name="line-2378"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>hi_file</span><span class='hs-layout'>,</span> <span class='hs-varid'>o_file</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-2379"></a>          <span class='hs-comment'>-- If ``-fwrite-interface` is specified, then the .o and .hi files</span>
<a name="line-2380"></a>          <span class='hs-comment'>-- are written into `-odir` and `-hidir` respectively.  #16670</span>
<a name="line-2381"></a>          <span class='hs-keyword'>if</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_WriteInterface</span> <span class='hs-varid'>dflags</span>
<a name="line-2382"></a>            <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ml_hi_file</span> <span class='hs-varid'>ms_location</span><span class='hs-layout'>,</span> <span class='hs-varid'>ml_obj_file</span> <span class='hs-varid'>ms_location</span><span class='hs-layout'>)</span>
<a name="line-2383"></a>            <span class='hs-keyword'>else</span> <span class='hs-conid'>(,)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_temp_file</span> <span class='hs-layout'>(</span><span class='hs-varid'>hiSuf_</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dynHiSuf_</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2384"></a>                     <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_temp_file</span> <span class='hs-layout'>(</span><span class='hs-varid'>objectSuf_</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dynObjectSuf_</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2385"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>ms'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms</span>
<a name="line-2386"></a>              <span class='hs-layout'>{</span> <span class='hs-varid'>ms_location</span> <span class='hs-keyglyph'>=</span>
<a name="line-2387"></a>                  <span class='hs-varid'>ms_location</span> <span class='hs-layout'>{</span><span class='hs-varid'>ml_hi_file</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hi_file</span><span class='hs-layout'>,</span> <span class='hs-varid'>ml_obj_file</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o_file</span><span class='hs-layout'>}</span>
<a name="line-2388"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ms_hspp_opts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updOptLevel</span> <span class='hs-num'>0</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>{</span><span class='hs-varid'>backend</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bcknd</span><span class='hs-layout'>}</span>
<a name="line-2389"></a>              <span class='hs-layout'>}</span>
<a name="line-2390"></a>        <span class='hs-varid'>pure</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExtendedModSummary</span> <span class='hs-varid'>ms'</span> <span class='hs-varid'>bkp_deps</span><span class='hs-layout'>)</span>
<a name="line-2391"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExtendedModSummary</span> <span class='hs-varid'>ms</span> <span class='hs-varid'>bkp_deps</span><span class='hs-layout'>)</span>
<a name="line-2392"></a>
<a name="line-2393"></a>    <span class='hs-varid'>needs_codegen_set</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>transitive_deps_set</span>
<a name="line-2394"></a>      <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ms</span>
<a name="line-2395"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mss</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>modNodeMapElems</span> <span class='hs-varid'>nodemap</span>
<a name="line-2396"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExtendedModSummary</span> <span class='hs-layout'>{</span> <span class='hs-varid'>emsModSummary</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mss</span>
<a name="line-2397"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>condition</span> <span class='hs-varid'>ms</span>
<a name="line-2398"></a>      <span class='hs-keyglyph'>]</span>
<a name="line-2399"></a>
<a name="line-2400"></a>    <span class='hs-comment'>-- find the set of all transitive dependencies of a list of modules.</span>
<a name="line-2401"></a>    <span class='hs-varid'>transitive_deps_set</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModSummary</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Set.Set</span> <span class='hs-conid'>Module</span>
<a name="line-2402"></a>    <span class='hs-varid'>transitive_deps_set</span> <span class='hs-varid'>modSums</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl'</span> <span class='hs-varid'>go</span> <span class='hs-conid'>Set.empty</span> <span class='hs-varid'>modSums</span>
<a name="line-2403"></a>      <span class='hs-keyword'>where</span>
<a name="line-2404"></a>        <span class='hs-varid'>go</span> <span class='hs-varid'>marked_mods</span> <span class='hs-varid'>ms</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>ModSummary</span><span class='hs-layout'>{</span><span class='hs-varid'>ms_mod</span><span class='hs-layout'>}</span>
<a name="line-2405"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ms_mod</span> <span class='hs-varop'>`Set.member`</span> <span class='hs-varid'>marked_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>marked_mods</span>
<a name="line-2406"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span>
<a name="line-2407"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>deps</span> <span class='hs-keyglyph'>=</span>
<a name="line-2408"></a>                  <span class='hs-keyglyph'>[</span> <span class='hs-varid'>dep_ms</span>
<a name="line-2409"></a>                  <span class='hs-comment'>-- If a module imports a boot module, msDeps helpfully adds a</span>
<a name="line-2410"></a>                  <span class='hs-comment'>-- dependency to that non-boot module in it's result. This</span>
<a name="line-2411"></a>                  <span class='hs-comment'>-- means we don't have to think about boot modules here.</span>
<a name="line-2412"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dep</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>msDeps</span> <span class='hs-varid'>ms</span>
<a name="line-2413"></a>                  <span class='hs-layout'>,</span> <span class='hs-conid'>NotBoot</span> <span class='hs-varop'>==</span> <span class='hs-varid'>gwib_isBoot</span> <span class='hs-varid'>dep</span>
<a name="line-2414"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>dep_ms_0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>toList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>modNodeMapLookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>dep</span><span class='hs-layout'>)</span> <span class='hs-varid'>nodemap</span>
<a name="line-2415"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>dep_ms_1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>toList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dep_ms_0</span>
<a name="line-2416"></a>                  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExtendedModSummary</span> <span class='hs-layout'>{</span> <span class='hs-varid'>emsModSummary</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dep_ms</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>toList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dep_ms_1</span>
<a name="line-2417"></a>                  <span class='hs-keyglyph'>]</span>
<a name="line-2418"></a>                <span class='hs-varid'>new_marked_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Set.insert</span> <span class='hs-varid'>ms_mod</span> <span class='hs-varid'>marked_mods</span>
<a name="line-2419"></a>            <span class='hs-keyword'>in</span> <span class='hs-varid'>foldl'</span> <span class='hs-varid'>go</span> <span class='hs-varid'>new_marked_mods</span> <span class='hs-varid'>deps</span>
<a name="line-2420"></a>
<a name="line-2421"></a><a name="mkRootMap"></a><span class='hs-definition'>mkRootMap</span>
<a name="line-2422"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ExtendedModSummary</span><span class='hs-keyglyph'>]</span>
<a name="line-2423"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModNodeMap</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Either</span> <span class='hs-conid'>ErrorMessages</span> <span class='hs-conid'>ExtendedModSummary</span><span class='hs-keyglyph'>]</span>
<a name="line-2424"></a><span class='hs-definition'>mkRootMap</span> <span class='hs-varid'>summaries</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModNodeMap</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Map.insertListWith</span>
<a name="line-2425"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-layout'>(</span><span class='hs-varop'>++</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2426"></a>  <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>msKey</span> <span class='hs-varop'>$</span> <span class='hs-varid'>emsModSummary</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Right</span> <span class='hs-varid'>s</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>summaries</span> <span class='hs-keyglyph'>]</span>
<a name="line-2427"></a>  <span class='hs-conid'>Map.empty</span>
<a name="line-2428"></a>
<a name="line-2429"></a><a name="msDeps"></a><span class='hs-comment'>-- | Returns the dependencies of the ModSummary s.</span>
<a name="line-2430"></a><span class='hs-comment'>-- A wrinkle is that for a {-# SOURCE #-} import we return</span>
<a name="line-2431"></a><span class='hs-comment'>--      *both* the hs-boot file</span>
<a name="line-2432"></a><span class='hs-comment'>--      *and* the source file</span>
<a name="line-2433"></a><span class='hs-comment'>-- as "dependencies".  That ensures that the list of all relevant</span>
<a name="line-2434"></a><span class='hs-comment'>-- modules always contains B.hs if it contains B.hs-boot.</span>
<a name="line-2435"></a><span class='hs-comment'>-- Remember, this pass isn't doing the topological sort.  It's</span>
<a name="line-2436"></a><span class='hs-comment'>-- just gathering the list of all relevant ModSummaries</span>
<a name="line-2437"></a><span class='hs-definition'>msDeps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GenWithIsBoot</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-conid'>ModuleName</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-2438"></a><span class='hs-definition'>msDeps</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>d</span>
<a name="line-2439"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ms_home_srcimps</span> <span class='hs-varid'>s</span>
<a name="line-2440"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>GWIB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gwib_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>gwib_isBoot</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IsBoot</span> <span class='hs-layout'>}</span>
<a name="line-2441"></a>                  <span class='hs-layout'>,</span> <span class='hs-conid'>GWIB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gwib_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>gwib_isBoot</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NotBoot</span> <span class='hs-layout'>}</span>
<a name="line-2442"></a>                  <span class='hs-keyglyph'>]</span>
<a name="line-2443"></a>           <span class='hs-keyglyph'>]</span>
<a name="line-2444"></a>        <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>GWIB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gwib_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>gwib_isBoot</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NotBoot</span> <span class='hs-layout'>}</span>
<a name="line-2445"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ms_home_imps</span> <span class='hs-varid'>s</span>
<a name="line-2446"></a>           <span class='hs-keyglyph'>]</span>
<a name="line-2447"></a>
<a name="line-2448"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-2449"></a><span class='hs-comment'>-- Summarising modules</span>
<a name="line-2450"></a>
<a name="line-2451"></a><span class='hs-comment'>-- We have two types of summarisation:</span>
<a name="line-2452"></a><span class='hs-comment'>--</span>
<a name="line-2453"></a><span class='hs-comment'>--    * Summarise a file.  This is used for the root module(s) passed to</span>
<a name="line-2454"></a><span class='hs-comment'>--      cmLoadModules.  The file is read, and used to determine the root</span>
<a name="line-2455"></a><span class='hs-comment'>--      module name.  The module name may differ from the filename.</span>
<a name="line-2456"></a><span class='hs-comment'>--</span>
<a name="line-2457"></a><span class='hs-comment'>--    * Summarise a module.  We are given a module name, and must provide</span>
<a name="line-2458"></a><span class='hs-comment'>--      a summary.  The finder is used to locate the file in which the module</span>
<a name="line-2459"></a><span class='hs-comment'>--      resides.</span>
<a name="line-2460"></a>
<a name="line-2461"></a><a name="summariseFile"></a><span class='hs-definition'>summariseFile</span>
<a name="line-2462"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-2463"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ExtendedModSummary</span><span class='hs-keyglyph'>]</span>         <span class='hs-comment'>-- old summaries</span>
<a name="line-2464"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>                     <span class='hs-comment'>-- source file name</span>
<a name="line-2465"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Phase</span>                  <span class='hs-comment'>-- start phase</span>
<a name="line-2466"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>                         <span class='hs-comment'>-- object code allowed?</span>
<a name="line-2467"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>StringBuffer</span><span class='hs-layout'>,</span><span class='hs-conid'>UTCTime</span><span class='hs-layout'>)</span>
<a name="line-2468"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-conid'>ErrorMessages</span> <span class='hs-conid'>ExtendedModSummary</span><span class='hs-layout'>)</span>
<a name="line-2469"></a>
<a name="line-2470"></a><span class='hs-definition'>summariseFile</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>old_summaries</span> <span class='hs-varid'>src_fn</span> <span class='hs-varid'>mb_phase</span> <span class='hs-varid'>obj_allowed</span> <span class='hs-varid'>maybe_buf</span>
<a name="line-2471"></a>        <span class='hs-comment'>-- we can use a cached summary if one is available and the</span>
<a name="line-2472"></a>        <span class='hs-comment'>-- source file hasn't changed,  But we have to look up the summary</span>
<a name="line-2473"></a>        <span class='hs-comment'>-- by source file, rather than module name as we do in summarise.</span>
<a name="line-2474"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>old_summary</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findSummaryBySourceFile</span> <span class='hs-varid'>old_summaries</span> <span class='hs-varid'>src_fn</span>
<a name="line-2475"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2476"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>location</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_location</span> <span class='hs-varop'>$</span> <span class='hs-varid'>emsModSummary</span> <span class='hs-varid'>old_summary</span>
<a name="line-2477"></a>            <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-2478"></a>
<a name="line-2479"></a>        <span class='hs-varid'>src_timestamp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get_src_timestamp</span>
<a name="line-2480"></a>                <span class='hs-comment'>-- The file exists; we checked in getRootSummary above.</span>
<a name="line-2481"></a>                <span class='hs-comment'>-- If it gets removed subsequently, then this</span>
<a name="line-2482"></a>                <span class='hs-comment'>-- getModificationUTCTime may fail, but that's the right</span>
<a name="line-2483"></a>                <span class='hs-comment'>-- behaviour.</span>
<a name="line-2484"></a>
<a name="line-2485"></a>                <span class='hs-comment'>-- return the cached summary if the source didn't change</span>
<a name="line-2486"></a>        <span class='hs-varid'>checkSummaryTimestamp</span>
<a name="line-2487"></a>            <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>obj_allowed</span> <span class='hs-conid'>NotBoot</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_summary</span> <span class='hs-varid'>src_fn</span><span class='hs-layout'>)</span>
<a name="line-2488"></a>            <span class='hs-varid'>old_summary</span> <span class='hs-varid'>location</span> <span class='hs-varid'>src_timestamp</span>
<a name="line-2489"></a>
<a name="line-2490"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2491"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>src_timestamp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get_src_timestamp</span>
<a name="line-2492"></a>        <span class='hs-varid'>new_summary</span> <span class='hs-varid'>src_fn</span> <span class='hs-varid'>src_timestamp</span>
<a name="line-2493"></a>  <span class='hs-keyword'>where</span>
<a name="line-2494"></a>    <span class='hs-varid'>get_src_timestamp</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_buf</span> <span class='hs-keyword'>of</span>
<a name="line-2495"></a>                           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>t</span>
<a name="line-2496"></a>                           <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getModificationUTCTime</span> <span class='hs-varid'>src_fn</span>
<a name="line-2497"></a>                        <span class='hs-comment'>-- getModificationUTCTime may fail</span>
<a name="line-2498"></a>
<a name="line-2499"></a>    <span class='hs-varid'>new_summary</span> <span class='hs-varid'>src_fn</span> <span class='hs-varid'>src_timestamp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runExceptT</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-2500"></a>        <span class='hs-varid'>preimps</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>PreprocessedImports</span> <span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span>
<a name="line-2501"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPreprocessedImports</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>src_fn</span> <span class='hs-varid'>mb_phase</span> <span class='hs-varid'>maybe_buf</span>
<a name="line-2502"></a>
<a name="line-2503"></a>
<a name="line-2504"></a>        <span class='hs-comment'>-- Make a ModLocation for this file</span>
<a name="line-2505"></a>        <span class='hs-varid'>location</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHomeModLocation</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>pi_mod_name</span> <span class='hs-varid'>src_fn</span>
<a name="line-2506"></a>
<a name="line-2507"></a>        <span class='hs-comment'>-- Tell the Finder cache where it is, so that subsequent calls</span>
<a name="line-2508"></a>        <span class='hs-comment'>-- to findModule will find it, even if it's not on any search path</span>
<a name="line-2509"></a>        <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addHomeModuleToFinder</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>pi_mod_name</span> <span class='hs-varid'>location</span>
<a name="line-2510"></a>
<a name="line-2511"></a>        <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>makeNewModSummary</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-conid'>MakeNewModSummary</span>
<a name="line-2512"></a>            <span class='hs-layout'>{</span> <span class='hs-varid'>nms_src_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src_fn</span>
<a name="line-2513"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>nms_src_timestamp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src_timestamp</span>
<a name="line-2514"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>nms_is_boot</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NotBoot</span>
<a name="line-2515"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>nms_hsc_src</span> <span class='hs-keyglyph'>=</span>
<a name="line-2516"></a>                <span class='hs-keyword'>if</span> <span class='hs-varid'>isHaskellSigFilename</span> <span class='hs-varid'>src_fn</span>
<a name="line-2517"></a>                   <span class='hs-keyword'>then</span> <span class='hs-conid'>HsigFile</span>
<a name="line-2518"></a>                   <span class='hs-keyword'>else</span> <span class='hs-conid'>HsSrcFile</span>
<a name="line-2519"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>nms_location</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>location</span>
<a name="line-2520"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>nms_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod</span>
<a name="line-2521"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>nms_obj_allowed</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>obj_allowed</span>
<a name="line-2522"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>nms_preimps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>preimps</span>
<a name="line-2523"></a>            <span class='hs-layout'>}</span>
<a name="line-2524"></a>
<a name="line-2525"></a><a name="findSummaryBySourceFile"></a><span class='hs-definition'>findSummaryBySourceFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ExtendedModSummary</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ExtendedModSummary</span>
<a name="line-2526"></a><span class='hs-definition'>findSummaryBySourceFile</span> <span class='hs-varid'>summaries</span> <span class='hs-varid'>file</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span>
<a name="line-2527"></a>    <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ms</span>
<a name="line-2528"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>summaries</span>
<a name="line-2529"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>HsSrcFile</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ms_hsc_src</span> <span class='hs-varop'>$</span> <span class='hs-varid'>emsModSummary</span> <span class='hs-varid'>ms</span><span class='hs-keyglyph'>]</span>
<a name="line-2530"></a>    <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>derived_file</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ml_hs_file</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ms_location</span> <span class='hs-varop'>$</span> <span class='hs-varid'>emsModSummary</span> <span class='hs-varid'>ms</span>
<a name="line-2531"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"findSummaryBySourceFile"</span> <span class='hs-varid'>derived_file</span> <span class='hs-varop'>==</span> <span class='hs-varid'>file</span>
<a name="line-2532"></a>    <span class='hs-keyglyph'>]</span>
<a name="line-2533"></a>  <span class='hs-keyword'>of</span>
<a name="line-2534"></a>    <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-2535"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>x</span>
<a name="line-2536"></a>
<a name="line-2537"></a><a name="checkSummaryTimestamp"></a><span class='hs-definition'>checkSummaryTimestamp</span>
<a name="line-2538"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsBootInterface</span>
<a name="line-2539"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>UTCTime</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-varid'>e</span> <span class='hs-conid'>ExtendedModSummary</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2540"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExtendedModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModLocation</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UTCTime</span>
<a name="line-2541"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-varid'>e</span> <span class='hs-conid'>ExtendedModSummary</span><span class='hs-layout'>)</span>
<a name="line-2542"></a><span class='hs-definition'>checkSummaryTimestamp</span>
<a name="line-2543"></a>  <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>obj_allowed</span> <span class='hs-varid'>is_boot</span> <span class='hs-varid'>new_summary</span>
<a name="line-2544"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>ExtendedModSummary</span> <span class='hs-layout'>{</span> <span class='hs-varid'>emsModSummary</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_summary</span><span class='hs-layout'>,</span> <span class='hs-varid'>emsInstantiatedUnits</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bkp_deps</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2545"></a>  <span class='hs-varid'>location</span> <span class='hs-varid'>src_timestamp</span>
<a name="line-2546"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ms_hs_date</span> <span class='hs-varid'>old_summary</span> <span class='hs-varop'>==</span> <span class='hs-varid'>src_timestamp</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-2547"></a>      <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_ForceRecomp</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2548"></a>           <span class='hs-comment'>-- update the object-file timestamp</span>
<a name="line-2549"></a>           <span class='hs-varid'>obj_timestamp</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-2550"></a>             <span class='hs-keyword'>if</span> <span class='hs-varid'>backendProducesObject</span> <span class='hs-layout'>(</span><span class='hs-varid'>backend</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2551"></a>                 <span class='hs-varop'>||</span> <span class='hs-varid'>obj_allowed</span> <span class='hs-comment'>-- bug #1205</span>
<a name="line-2552"></a>                 <span class='hs-keyword'>then</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getObjTimestamp</span> <span class='hs-varid'>location</span> <span class='hs-varid'>is_boot</span>
<a name="line-2553"></a>                 <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-2554"></a>
<a name="line-2555"></a>           <span class='hs-comment'>-- We have to repopulate the Finder's cache for file targets</span>
<a name="line-2556"></a>           <span class='hs-comment'>-- because the file might not even be on the regular search path</span>
<a name="line-2557"></a>           <span class='hs-comment'>-- and it was likely flushed in depanal. This is not technically</span>
<a name="line-2558"></a>           <span class='hs-comment'>-- needed when we're called from sumariseModule but it shouldn't</span>
<a name="line-2559"></a>           <span class='hs-comment'>-- hurt.</span>
<a name="line-2560"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHomeModuleToFinder</span> <span class='hs-varid'>hsc_env</span>
<a name="line-2561"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_mod</span> <span class='hs-varid'>old_summary</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>location</span>
<a name="line-2562"></a>
<a name="line-2563"></a>           <span class='hs-varid'>hi_timestamp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeGetIfaceDate</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>location</span>
<a name="line-2564"></a>           <span class='hs-varid'>hie_timestamp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>modificationTimeIfExists</span> <span class='hs-layout'>(</span><span class='hs-varid'>ml_hie_file</span> <span class='hs-varid'>location</span><span class='hs-layout'>)</span>
<a name="line-2565"></a>
<a name="line-2566"></a>           <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Right</span>
<a name="line-2567"></a>             <span class='hs-layout'>(</span> <span class='hs-conid'>ExtendedModSummary</span> <span class='hs-layout'>{</span> <span class='hs-varid'>emsModSummary</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_summary</span>
<a name="line-2568"></a>                     <span class='hs-layout'>{</span> <span class='hs-varid'>ms_obj_date</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>obj_timestamp</span>
<a name="line-2569"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>ms_iface_date</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hi_timestamp</span>
<a name="line-2570"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>ms_hie_date</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hie_timestamp</span>
<a name="line-2571"></a>                     <span class='hs-layout'>}</span>
<a name="line-2572"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>emsInstantiatedUnits</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bkp_deps</span>
<a name="line-2573"></a>                   <span class='hs-layout'>}</span>
<a name="line-2574"></a>             <span class='hs-layout'>)</span>
<a name="line-2575"></a>
<a name="line-2576"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span>
<a name="line-2577"></a>           <span class='hs-comment'>-- source changed: re-summarise.</span>
<a name="line-2578"></a>           <span class='hs-varid'>new_summary</span> <span class='hs-varid'>src_timestamp</span>
<a name="line-2579"></a>
<a name="line-2580"></a><a name="summariseModule"></a><span class='hs-comment'>-- Summarise a module, and pick up source and timestamp.</span>
<a name="line-2581"></a><span class='hs-definition'>summariseModule</span>
<a name="line-2582"></a>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-2583"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModNodeMap</span> <span class='hs-conid'>ExtendedModSummary</span>
<a name="line-2584"></a>          <span class='hs-comment'>-- ^ Map of old summaries</span>
<a name="line-2585"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsBootInterface</span>    <span class='hs-comment'>-- True &lt;=&gt; a {-# SOURCE #-} import</span>
<a name="line-2586"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>ModuleName</span> <span class='hs-comment'>-- Imported module to be summarised</span>
<a name="line-2587"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>               <span class='hs-comment'>-- object code allowed?</span>
<a name="line-2588"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>StringBuffer</span><span class='hs-layout'>,</span> <span class='hs-conid'>UTCTime</span><span class='hs-layout'>)</span>
<a name="line-2589"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleName</span><span class='hs-keyglyph'>]</span>               <span class='hs-comment'>-- Modules to exclude</span>
<a name="line-2590"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-conid'>ErrorMessages</span> <span class='hs-conid'>ExtendedModSummary</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>      <span class='hs-comment'>-- Its new summary</span>
<a name="line-2591"></a>
<a name="line-2592"></a><span class='hs-definition'>summariseModule</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>old_summary_map</span> <span class='hs-varid'>is_boot</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>wanted_mod</span><span class='hs-layout'>)</span>
<a name="line-2593"></a>                <span class='hs-varid'>obj_allowed</span> <span class='hs-varid'>maybe_buf</span> <span class='hs-varid'>excl_mods</span>
<a name="line-2594"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>wanted_mod</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>excl_mods</span>
<a name="line-2595"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-2596"></a>
<a name="line-2597"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>old_summary</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>modNodeMapLookup</span>
<a name="line-2598"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>GWIB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gwib_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanted_mod</span><span class='hs-layout'>,</span> <span class='hs-varid'>gwib_isBoot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_boot</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2599"></a>      <span class='hs-varid'>old_summary_map</span>
<a name="line-2600"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>          <span class='hs-comment'>-- Find its new timestamp; all the</span>
<a name="line-2601"></a>                <span class='hs-comment'>-- ModSummaries in the old map have valid ml_hs_files</span>
<a name="line-2602"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>location</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_location</span> <span class='hs-varop'>$</span> <span class='hs-varid'>emsModSummary</span> <span class='hs-varid'>old_summary</span>
<a name="line-2603"></a>            <span class='hs-varid'>src_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"summariseModule"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ml_hs_file</span> <span class='hs-varid'>location</span><span class='hs-layout'>)</span>
<a name="line-2604"></a>
<a name="line-2605"></a>                <span class='hs-comment'>-- check the modification time on the source file, and</span>
<a name="line-2606"></a>                <span class='hs-comment'>-- return the cached summary if it hasn't changed.  If the</span>
<a name="line-2607"></a>                <span class='hs-comment'>-- file has disappeared, we need to call the Finder again.</span>
<a name="line-2608"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_buf</span> <span class='hs-keyword'>of</span>
<a name="line-2609"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2610"></a>               <span class='hs-conid'>Just</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>check_timestamp</span> <span class='hs-varid'>old_summary</span> <span class='hs-varid'>location</span> <span class='hs-varid'>src_fn</span> <span class='hs-varid'>t</span>
<a name="line-2611"></a>           <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-2612"></a>                <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tryIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>getModificationUTCTime</span> <span class='hs-varid'>src_fn</span><span class='hs-layout'>)</span>
<a name="line-2613"></a>                <span class='hs-keyword'>case</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>of</span>
<a name="line-2614"></a>                   <span class='hs-conid'>Right</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2615"></a>                       <span class='hs-conid'>Just</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>check_timestamp</span> <span class='hs-varid'>old_summary</span> <span class='hs-varid'>location</span> <span class='hs-varid'>src_fn</span> <span class='hs-varid'>t</span>
<a name="line-2616"></a>                   <span class='hs-conid'>Left</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDoesNotExistError</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>find_it</span>
<a name="line-2617"></a>                          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ioError</span> <span class='hs-varid'>e</span>
<a name="line-2618"></a>
<a name="line-2619"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>find_it</span>
<a name="line-2620"></a>  <span class='hs-keyword'>where</span>
<a name="line-2621"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-2622"></a>    <span class='hs-varid'>home_unit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_home_unit</span> <span class='hs-varid'>hsc_env</span>
<a name="line-2623"></a>
<a name="line-2624"></a>    <span class='hs-varid'>check_timestamp</span> <span class='hs-varid'>old_summary</span> <span class='hs-varid'>location</span> <span class='hs-varid'>src_fn</span> <span class='hs-keyglyph'>=</span>
<a name="line-2625"></a>        <span class='hs-varid'>checkSummaryTimestamp</span>
<a name="line-2626"></a>          <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>obj_allowed</span> <span class='hs-varid'>is_boot</span>
<a name="line-2627"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>new_summary</span> <span class='hs-varid'>location</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_mod</span> <span class='hs-varop'>$</span> <span class='hs-varid'>emsModSummary</span> <span class='hs-varid'>old_summary</span><span class='hs-layout'>)</span> <span class='hs-varid'>src_fn</span><span class='hs-layout'>)</span>
<a name="line-2628"></a>          <span class='hs-varid'>old_summary</span> <span class='hs-varid'>location</span>
<a name="line-2629"></a>
<a name="line-2630"></a>    <span class='hs-varid'>find_it</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2631"></a>        <span class='hs-varid'>found</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findImportedModule</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>wanted_mod</span> <span class='hs-conid'>Nothing</span>
<a name="line-2632"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>found</span> <span class='hs-keyword'>of</span>
<a name="line-2633"></a>             <span class='hs-conid'>Found</span> <span class='hs-varid'>location</span> <span class='hs-varid'>mod</span>
<a name="line-2634"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>ml_hs_file</span> <span class='hs-varid'>location</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2635"></a>                        <span class='hs-comment'>-- Home package</span>
<a name="line-2636"></a>                         <span class='hs-conid'>Just</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>just_found</span> <span class='hs-varid'>location</span> <span class='hs-varid'>mod</span>
<a name="line-2637"></a>
<a name="line-2638"></a>             <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-2639"></a>                        <span class='hs-comment'>-- Not found</span>
<a name="line-2640"></a>                        <span class='hs-comment'>-- (If it is TRULY not found at all, we'll</span>
<a name="line-2641"></a>                        <span class='hs-comment'>-- error when we actually try to compile)</span>
<a name="line-2642"></a>
<a name="line-2643"></a>    <span class='hs-varid'>just_found</span> <span class='hs-varid'>location</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2644"></a>                <span class='hs-comment'>-- Adjust location to point to the hs-boot source file,</span>
<a name="line-2645"></a>                <span class='hs-comment'>-- hi file, object file, when is_boot says so</span>
<a name="line-2646"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>location'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>is_boot</span> <span class='hs-keyword'>of</span>
<a name="line-2647"></a>              <span class='hs-conid'>IsBoot</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>addBootSuffixLocn</span> <span class='hs-varid'>location</span>
<a name="line-2648"></a>              <span class='hs-conid'>NotBoot</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>location</span>
<a name="line-2649"></a>            <span class='hs-varid'>src_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"summarise2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ml_hs_file</span> <span class='hs-varid'>location'</span><span class='hs-layout'>)</span>
<a name="line-2650"></a>
<a name="line-2651"></a>                <span class='hs-comment'>-- Check that it exists</span>
<a name="line-2652"></a>                <span class='hs-comment'>-- It might have been deleted since the Finder last found it</span>
<a name="line-2653"></a>        <span class='hs-varid'>maybe_t</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>modificationTimeIfExists</span> <span class='hs-varid'>src_fn</span>
<a name="line-2654"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_t</span> <span class='hs-keyword'>of</span>
<a name="line-2655"></a>          <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Left</span> <span class='hs-varop'>$</span> <span class='hs-varid'>noHsFileErr</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>src_fn</span>
<a name="line-2656"></a>          <span class='hs-conid'>Just</span> <span class='hs-varid'>t</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>new_summary</span> <span class='hs-varid'>location'</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>src_fn</span> <span class='hs-varid'>t</span>
<a name="line-2657"></a>
<a name="line-2658"></a>    <span class='hs-varid'>new_summary</span> <span class='hs-varid'>location</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>src_fn</span> <span class='hs-varid'>src_timestamp</span>
<a name="line-2659"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runExceptT</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-2660"></a>        <span class='hs-varid'>preimps</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>PreprocessedImports</span> <span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span>
<a name="line-2661"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPreprocessedImports</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>src_fn</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>maybe_buf</span>
<a name="line-2662"></a>
<a name="line-2663"></a>        <span class='hs-comment'>-- NB: Despite the fact that is_boot is a top-level parameter, we</span>
<a name="line-2664"></a>        <span class='hs-comment'>-- don't actually know coming into this function what the HscSource</span>
<a name="line-2665"></a>        <span class='hs-comment'>-- of the module in question is.  This is because we may be processing</span>
<a name="line-2666"></a>        <span class='hs-comment'>-- this module because another module in the graph imported it: in this</span>
<a name="line-2667"></a>        <span class='hs-comment'>-- case, we know if it's a boot or not because of the {-# SOURCE #-}</span>
<a name="line-2668"></a>        <span class='hs-comment'>-- annotation, but we don't know if it's a signature or a regular</span>
<a name="line-2669"></a>        <span class='hs-comment'>-- module until we actually look it up on the filesystem.</span>
<a name="line-2670"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>hsc_src</span>
<a name="line-2671"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_boot</span> <span class='hs-varop'>==</span> <span class='hs-conid'>IsBoot</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsBootFile</span>
<a name="line-2672"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isHaskellSigFilename</span> <span class='hs-varid'>src_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsigFile</span>
<a name="line-2673"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsSrcFile</span>
<a name="line-2674"></a>
<a name="line-2675"></a>        <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>pi_mod_name</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>wanted_mod</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-2676"></a>                <span class='hs-varid'>throwE</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unitBag</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkPlainMsgEnvelope</span> <span class='hs-varid'>pi_mod_name_loc</span> <span class='hs-varop'>$</span>
<a name="line-2677"></a>                              <span class='hs-varid'>text</span> <span class='hs-str'>"File name does not match module name:"</span>
<a name="line-2678"></a>                              <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Saw:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pi_mod_name</span><span class='hs-layout'>)</span>
<a name="line-2679"></a>                              <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Expected:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>wanted_mod</span><span class='hs-layout'>)</span>
<a name="line-2680"></a>
<a name="line-2681"></a>        <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_src</span> <span class='hs-varop'>==</span> <span class='hs-conid'>HsigFile</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isNothing</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>pi_mod_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>homeUnitInstantiations</span> <span class='hs-varid'>home_unit</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-2682"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>suggested_instantiated_with</span> <span class='hs-keyglyph'>=</span>
<a name="line-2683"></a>                    <span class='hs-varid'>hcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>punctuate</span> <span class='hs-varid'>comma</span> <span class='hs-varop'>$</span>
<a name="line-2684"></a>                        <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"="</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-2685"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>pi_mod_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkHoleModule</span> <span class='hs-varid'>pi_mod_name</span><span class='hs-layout'>)</span>
<a name="line-2686"></a>                                <span class='hs-conop'>:</span> <span class='hs-varid'>homeUnitInstantiations</span> <span class='hs-varid'>home_unit</span><span class='hs-layout'>)</span>
<a name="line-2687"></a>                        <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2688"></a>            <span class='hs-keyword'>in</span> <span class='hs-varid'>throwE</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unitBag</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkPlainMsgEnvelope</span> <span class='hs-varid'>pi_mod_name_loc</span> <span class='hs-varop'>$</span>
<a name="line-2689"></a>                <span class='hs-varid'>text</span> <span class='hs-str'>"Unexpected signature:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pi_mod_name</span><span class='hs-layout'>)</span>
<a name="line-2690"></a>                <span class='hs-varop'>$$</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_BuildingCabalPackage</span> <span class='hs-varid'>dflags</span>
<a name="line-2691"></a>                    <span class='hs-keyword'>then</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Try adding"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pi_mod_name</span><span class='hs-layout'>)</span>
<a name="line-2692"></a>                            <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"to the"</span>
<a name="line-2693"></a>                            <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"signatures"</span><span class='hs-layout'>)</span>
<a name="line-2694"></a>                            <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"field in your Cabal file."</span><span class='hs-layout'>)</span>
<a name="line-2695"></a>                    <span class='hs-keyword'>else</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Try passing -instantiated-with=\""</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-2696"></a>                                 <span class='hs-varid'>suggested_instantiated_with</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"\""</span> <span class='hs-varop'>$$</span>
<a name="line-2697"></a>                                <span class='hs-varid'>text</span> <span class='hs-str'>"replacing &lt;"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>pi_mod_name</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"&gt; as necessary."</span><span class='hs-layout'>)</span>
<a name="line-2698"></a>
<a name="line-2699"></a>        <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>makeNewModSummary</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-conid'>MakeNewModSummary</span>
<a name="line-2700"></a>            <span class='hs-layout'>{</span> <span class='hs-varid'>nms_src_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src_fn</span>
<a name="line-2701"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>nms_src_timestamp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src_timestamp</span>
<a name="line-2702"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>nms_is_boot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_boot</span>
<a name="line-2703"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>nms_hsc_src</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_src</span>
<a name="line-2704"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>nms_location</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>location</span>
<a name="line-2705"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>nms_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod</span>
<a name="line-2706"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>nms_obj_allowed</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>obj_allowed</span>
<a name="line-2707"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>nms_preimps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>preimps</span>
<a name="line-2708"></a>            <span class='hs-layout'>}</span>
<a name="line-2709"></a>
<a name="line-2710"></a><a name="MakeNewModSummary"></a><span class='hs-comment'>-- | Convenience named arguments for 'makeNewModSummary' only used to make</span>
<a name="line-2711"></a><a name="MakeNewModSummary"></a><span class='hs-comment'>-- code more readable, not exported.</span>
<a name="line-2712"></a><a name="MakeNewModSummary"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>MakeNewModSummary</span>
<a name="line-2713"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MakeNewModSummary</span>
<a name="line-2714"></a>      <span class='hs-layout'>{</span> <span class='hs-varid'>nms_src_fn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span>
<a name="line-2715"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>nms_src_timestamp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UTCTime</span>
<a name="line-2716"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>nms_is_boot</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IsBootInterface</span>
<a name="line-2717"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>nms_hsc_src</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscSource</span>
<a name="line-2718"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>nms_location</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModLocation</span>
<a name="line-2719"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>nms_mod</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span>
<a name="line-2720"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>nms_obj_allowed</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-2721"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>nms_preimps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PreprocessedImports</span>
<a name="line-2722"></a>      <span class='hs-layout'>}</span>
<a name="line-2723"></a>
<a name="line-2724"></a><a name="makeNewModSummary"></a><span class='hs-definition'>makeNewModSummary</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MakeNewModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ExtendedModSummary</span>
<a name="line-2725"></a><span class='hs-definition'>makeNewModSummary</span> <span class='hs-varid'>hsc_env</span> <span class='hs-conid'>MakeNewModSummary</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2726"></a>  <span class='hs-keyword'>let</span> <span class='hs-conid'>PreprocessedImports</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nms_preimps</span>
<a name="line-2727"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-2728"></a>
<a name="line-2729"></a>  <span class='hs-comment'>-- when the user asks to load a source file by name, we only</span>
<a name="line-2730"></a>  <span class='hs-comment'>-- use an object file if -fobject-code is on.  See #1205.</span>
<a name="line-2731"></a>  <span class='hs-varid'>obj_timestamp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span>
<a name="line-2732"></a>      <span class='hs-keyword'>if</span> <span class='hs-varid'>backendProducesObject</span> <span class='hs-layout'>(</span><span class='hs-varid'>backend</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-2733"></a>         <span class='hs-varop'>||</span> <span class='hs-varid'>nms_obj_allowed</span> <span class='hs-comment'>-- bug #1205</span>
<a name="line-2734"></a>          <span class='hs-keyword'>then</span> <span class='hs-varid'>getObjTimestamp</span> <span class='hs-varid'>nms_location</span> <span class='hs-varid'>nms_is_boot</span>
<a name="line-2735"></a>          <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-2736"></a>
<a name="line-2737"></a>  <span class='hs-varid'>hi_timestamp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeGetIfaceDate</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>nms_location</span>
<a name="line-2738"></a>  <span class='hs-varid'>hie_timestamp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>modificationTimeIfExists</span> <span class='hs-layout'>(</span><span class='hs-varid'>ml_hie_file</span> <span class='hs-varid'>nms_location</span><span class='hs-layout'>)</span>
<a name="line-2739"></a>
<a name="line-2740"></a>  <span class='hs-varid'>extra_sig_imports</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findExtraSigImports</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>nms_hsc_src</span> <span class='hs-varid'>pi_mod_name</span>
<a name="line-2741"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>implicit_sigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_deps</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>implicitRequirementsShallow</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>pi_theimps</span>
<a name="line-2742"></a>
<a name="line-2743"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ExtendedModSummary</span>
<a name="line-2744"></a>    <span class='hs-layout'>{</span> <span class='hs-varid'>emsModSummary</span> <span class='hs-keyglyph'>=</span>
<a name="line-2745"></a>        <span class='hs-conid'>ModSummary</span>
<a name="line-2746"></a>        <span class='hs-layout'>{</span> <span class='hs-varid'>ms_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nms_mod</span>
<a name="line-2747"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ms_hsc_src</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nms_hsc_src</span>
<a name="line-2748"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ms_location</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nms_location</span>
<a name="line-2749"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ms_hspp_file</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pi_hspp_fn</span>
<a name="line-2750"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ms_hspp_opts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pi_local_dflags</span>
<a name="line-2751"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ms_hspp_buf</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>pi_hspp_buf</span>
<a name="line-2752"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ms_parsed_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-2753"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ms_srcimps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pi_srcimps</span>
<a name="line-2754"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ms_textual_imps</span> <span class='hs-keyglyph'>=</span>
<a name="line-2755"></a>            <span class='hs-varid'>pi_theimps</span> <span class='hs-varop'>++</span>
<a name="line-2756"></a>            <span class='hs-varid'>extra_sig_imports</span> <span class='hs-varop'>++</span>
<a name="line-2757"></a>            <span class='hs-layout'>(</span><span class='hs-conid'>(,)</span> <span class='hs-conid'>Nothing</span> <span class='hs-varop'>.</span> <span class='hs-varid'>noLoc</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>implicit_sigs</span><span class='hs-layout'>)</span>
<a name="line-2758"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ms_hs_date</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nms_src_timestamp</span>
<a name="line-2759"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ms_iface_date</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hi_timestamp</span>
<a name="line-2760"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ms_hie_date</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hie_timestamp</span>
<a name="line-2761"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ms_obj_date</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>obj_timestamp</span>
<a name="line-2762"></a>        <span class='hs-layout'>}</span>
<a name="line-2763"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>emsInstantiatedUnits</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_deps</span>
<a name="line-2764"></a>    <span class='hs-layout'>}</span>
<a name="line-2765"></a>
<a name="line-2766"></a><a name="getObjTimestamp"></a><span class='hs-definition'>getObjTimestamp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModLocation</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsBootInterface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>UTCTime</span><span class='hs-layout'>)</span>
<a name="line-2767"></a><span class='hs-definition'>getObjTimestamp</span> <span class='hs-varid'>location</span> <span class='hs-varid'>is_boot</span>
<a name="line-2768"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>is_boot</span> <span class='hs-keyword'>of</span>
<a name="line-2769"></a>      <span class='hs-conid'>IsBoot</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-2770"></a>      <span class='hs-conid'>NotBoot</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>modificationTimeIfExists</span> <span class='hs-layout'>(</span><span class='hs-varid'>ml_obj_file</span> <span class='hs-varid'>location</span><span class='hs-layout'>)</span>
<a name="line-2771"></a>
<a name="line-2772"></a><a name="PreprocessedImports"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PreprocessedImports</span>
<a name="line-2773"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PreprocessedImports</span>
<a name="line-2774"></a>      <span class='hs-layout'>{</span> <span class='hs-varid'>pi_local_dflags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-2775"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>pi_srcimps</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>FastString</span><span class='hs-layout'>,</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>ModuleName</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-2776"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>pi_theimps</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>FastString</span><span class='hs-layout'>,</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>ModuleName</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-2777"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>pi_hspp_fn</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span>
<a name="line-2778"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>pi_hspp_buf</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StringBuffer</span>
<a name="line-2779"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>pi_mod_name_loc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-2780"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>pi_mod_name</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span>
<a name="line-2781"></a>      <span class='hs-layout'>}</span>
<a name="line-2782"></a>
<a name="line-2783"></a><a name="getPreprocessedImports"></a><span class='hs-comment'>-- Preprocess the source file and get its imports</span>
<a name="line-2784"></a><span class='hs-comment'>-- The pi_local_dflags contains the OPTIONS pragmas</span>
<a name="line-2785"></a><span class='hs-definition'>getPreprocessedImports</span>
<a name="line-2786"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-2787"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-2788"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Phase</span>
<a name="line-2789"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>StringBuffer</span><span class='hs-layout'>,</span> <span class='hs-conid'>UTCTime</span><span class='hs-layout'>)</span>
<a name="line-2790"></a>    <span class='hs-comment'>-- ^ optional source code buffer and modification time</span>
<a name="line-2791"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExceptT</span> <span class='hs-conid'>ErrorMessages</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>PreprocessedImports</span>
<a name="line-2792"></a><span class='hs-definition'>getPreprocessedImports</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>src_fn</span> <span class='hs-varid'>mb_phase</span> <span class='hs-varid'>maybe_buf</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2793"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>pi_local_dflags</span><span class='hs-layout'>,</span> <span class='hs-varid'>pi_hspp_fn</span><span class='hs-layout'>)</span>
<a name="line-2794"></a>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>ExceptT</span> <span class='hs-varop'>$</span> <span class='hs-varid'>preprocess</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>src_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>maybe_buf</span><span class='hs-layout'>)</span> <span class='hs-varid'>mb_phase</span>
<a name="line-2795"></a>  <span class='hs-varid'>pi_hspp_buf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hGetStringBuffer</span> <span class='hs-varid'>pi_hspp_fn</span>
<a name="line-2796"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>pi_srcimps</span><span class='hs-layout'>,</span> <span class='hs-varid'>pi_theimps</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>pi_mod_name_loc</span> <span class='hs-varid'>pi_mod_name</span><span class='hs-layout'>)</span>
<a name="line-2797"></a>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>ExceptT</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-2798"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>imp_prelude</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>LangExt.ImplicitPrelude</span> <span class='hs-varid'>pi_local_dflags</span>
<a name="line-2799"></a>              <span class='hs-varid'>popts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initParserOpts</span> <span class='hs-varid'>pi_local_dflags</span>
<a name="line-2800"></a>          <span class='hs-varid'>mimps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getImports</span> <span class='hs-varid'>popts</span> <span class='hs-varid'>imp_prelude</span> <span class='hs-varid'>pi_hspp_buf</span> <span class='hs-varid'>pi_hspp_fn</span> <span class='hs-varid'>src_fn</span>
<a name="line-2801"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>first</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>pprError</span><span class='hs-layout'>)</span> <span class='hs-varid'>mimps</span><span class='hs-layout'>)</span>
<a name="line-2802"></a>  <span class='hs-varid'>return</span> <span class='hs-conid'>PreprocessedImports</span> <span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span>
<a name="line-2803"></a>
<a name="line-2804"></a>
<a name="line-2805"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-2806"></a><span class='hs-comment'>--                      Error messages</span>
<a name="line-2807"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-2808"></a>
<a name="line-2809"></a><a name="withDeferredDiagnostics"></a><span class='hs-comment'>-- Defer and group warning, error and fatal messages so they will not get lost</span>
<a name="line-2810"></a><span class='hs-comment'>-- in the regular output.</span>
<a name="line-2811"></a><span class='hs-definition'>withDeferredDiagnostics</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-2812"></a><span class='hs-definition'>withDeferredDiagnostics</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2813"></a>  <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-2814"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_DeferDiagnostics</span> <span class='hs-varid'>dflags</span>
<a name="line-2815"></a>  <span class='hs-keyword'>then</span> <span class='hs-varid'>f</span>
<a name="line-2816"></a>  <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-2817"></a>    <span class='hs-varid'>warnings</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>newIORef</span> <span class='hs-conid'>[]</span>
<a name="line-2818"></a>    <span class='hs-varid'>errors</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>newIORef</span> <span class='hs-conid'>[]</span>
<a name="line-2819"></a>    <span class='hs-varid'>fatals</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>newIORef</span> <span class='hs-conid'>[]</span>
<a name="line-2820"></a>    <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLogger</span>
<a name="line-2821"></a>
<a name="line-2822"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>deferDiagnostics</span> <span class='hs-sel'>_dflags</span> <span class='hs-varop'>!</span><span class='hs-varid'>reason</span> <span class='hs-varop'>!</span><span class='hs-varid'>severity</span> <span class='hs-varop'>!</span><span class='hs-varid'>srcSpan</span> <span class='hs-varop'>!</span><span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2823"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>action</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putLogMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>reason</span> <span class='hs-varid'>severity</span> <span class='hs-varid'>srcSpan</span> <span class='hs-varid'>msg</span>
<a name="line-2824"></a>          <span class='hs-keyword'>case</span> <span class='hs-varid'>severity</span> <span class='hs-keyword'>of</span>
<a name="line-2825"></a>            <span class='hs-conid'>SevWarning</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>atomicModifyIORef'</span> <span class='hs-varid'>warnings</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>action</span><span class='hs-conop'>:</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-2826"></a>            <span class='hs-conid'>SevError</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>atomicModifyIORef'</span> <span class='hs-varid'>errors</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>action</span><span class='hs-conop'>:</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-2827"></a>            <span class='hs-conid'>SevFatal</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>atomicModifyIORef'</span> <span class='hs-varid'>fatals</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>action</span><span class='hs-conop'>:</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-2828"></a>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>action</span>
<a name="line-2829"></a>
<a name="line-2830"></a>        <span class='hs-varid'>printDeferredDiagnostics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span>
<a name="line-2831"></a>          <span class='hs-varid'>forM_</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>warnings</span><span class='hs-layout'>,</span> <span class='hs-varid'>errors</span><span class='hs-layout'>,</span> <span class='hs-varid'>fatals</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>ref</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-2832"></a>            <span class='hs-comment'>-- This IORef can leak when the dflags leaks, so let us always</span>
<a name="line-2833"></a>            <span class='hs-comment'>-- reset the content.</span>
<a name="line-2834"></a>            <span class='hs-varid'>actions</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>atomicModifyIORef'</span> <span class='hs-varid'>ref</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-2835"></a>            <span class='hs-varid'>sequence_</span> <span class='hs-varop'>$</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>actions</span>
<a name="line-2836"></a>
<a name="line-2837"></a>    <span class='hs-conid'>MC.bracket</span>
<a name="line-2838"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>pushLogHookM</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>deferDiagnostics</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2839"></a>      <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>popLogHookM</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>printDeferredDiagnostics</span><span class='hs-layout'>)</span>
<a name="line-2840"></a>      <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>
<a name="line-2841"></a>
<a name="line-2842"></a><a name="noModError"></a><span class='hs-definition'>noModError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FindResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgEnvelope</span> <span class='hs-conid'>DecoratedSDoc</span>
<a name="line-2843"></a><span class='hs-comment'>-- ToDo: we don't have a proper line number for this error</span>
<a name="line-2844"></a><span class='hs-definition'>noModError</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>wanted_mod</span> <span class='hs-varid'>err</span>
<a name="line-2845"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPlainMsgEnvelope</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cannotFindModule</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>wanted_mod</span> <span class='hs-varid'>err</span>
<a name="line-2846"></a>
<a name="line-2847"></a><a name="noHsFileErr"></a><span class='hs-definition'>noHsFileErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ErrorMessages</span>
<a name="line-2848"></a><span class='hs-definition'>noHsFileErr</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>path</span>
<a name="line-2849"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitBag</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkPlainMsgEnvelope</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Can't find"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>path</span>
<a name="line-2850"></a>
<a name="line-2851"></a><a name="moduleNotFoundErr"></a><span class='hs-definition'>moduleNotFoundErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ErrorMessages</span>
<a name="line-2852"></a><span class='hs-definition'>moduleNotFoundErr</span> <span class='hs-varid'>mod</span>
<a name="line-2853"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitBag</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkPlainMsgEnvelope</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-varop'>$</span>
<a name="line-2854"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"module"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"cannot be found locally"</span>
<a name="line-2855"></a>
<a name="line-2856"></a><a name="multiRootsErr"></a><span class='hs-definition'>multiRootsErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModSummary</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-2857"></a><span class='hs-definition'>multiRootsErr</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"multiRootsErr"</span>
<a name="line-2858"></a><span class='hs-definition'>multiRootsErr</span> <span class='hs-varid'>summs</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>summ1</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-2859"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>throwOneError</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkPlainMsgEnvelope</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-varop'>$</span>
<a name="line-2860"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"module"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-2861"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"is defined in multiple files:"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-2862"></a>        <span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>text</span> <span class='hs-varid'>files</span><span class='hs-layout'>)</span>
<a name="line-2863"></a>  <span class='hs-keyword'>where</span>
<a name="line-2864"></a>    <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_mod</span> <span class='hs-varid'>summ1</span>
<a name="line-2865"></a>    <span class='hs-varid'>files</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>expectJust</span> <span class='hs-str'>"checkDup"</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ml_hs_file</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ms_location</span><span class='hs-layout'>)</span> <span class='hs-varid'>summs</span>
<a name="line-2866"></a>
<a name="line-2867"></a><a name="keepGoingPruneErr"></a><span class='hs-definition'>keepGoingPruneErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NodeKey</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2868"></a><span class='hs-definition'>keepGoingPruneErr</span> <span class='hs-varid'>ms</span>
<a name="line-2869"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span> <span class='hs-varid'>text</span> <span class='hs-str'>"-fkeep-going in use, removing the following"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-2870"></a>            <span class='hs-varid'>text</span> <span class='hs-str'>"dependencies and continuing:"</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span>
<a name="line-2871"></a>          <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>nest</span> <span class='hs-num'>6</span> <span class='hs-varop'>.</span> <span class='hs-varid'>pprNodeKey</span><span class='hs-layout'>)</span> <span class='hs-varid'>ms</span> <span class='hs-layout'>)</span>
<a name="line-2872"></a>
<a name="line-2873"></a><a name="cyclicModuleErr"></a><span class='hs-definition'>cyclicModuleErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleGraphNode</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2874"></a><span class='hs-comment'>-- From a strongly connected component we find</span>
<a name="line-2875"></a><span class='hs-comment'>-- a single cycle to report</span>
<a name="line-2876"></a><span class='hs-definition'>cyclicModuleErr</span> <span class='hs-varid'>mss</span>
<a name="line-2877"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>mss</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-2878"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>findCycle</span> <span class='hs-varid'>graph</span> <span class='hs-keyword'>of</span>
<a name="line-2879"></a>       <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Unexpected non-cycle"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mss</span>
<a name="line-2880"></a>       <span class='hs-conid'>Just</span> <span class='hs-varid'>path0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>vcat</span>
<a name="line-2881"></a>        <span class='hs-keyglyph'>[</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>partitionNodes</span> <span class='hs-varid'>path0</span> <span class='hs-keyword'>of</span>
<a name="line-2882"></a>            <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Module imports form a cycle:"</span>
<a name="line-2883"></a>            <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Module instantiations form a cycle:"</span>
<a name="line-2884"></a>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Module imports and instantiations form a cycle:"</span>
<a name="line-2885"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>show_path</span> <span class='hs-varid'>path0</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-2886"></a>  <span class='hs-keyword'>where</span>
<a name="line-2887"></a>    <span class='hs-varid'>graph</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Node</span> <span class='hs-conid'>NodeKey</span> <span class='hs-conid'>ModuleGraphNode</span><span class='hs-keyglyph'>]</span>
<a name="line-2888"></a>    <span class='hs-varid'>graph</span> <span class='hs-keyglyph'>=</span>
<a name="line-2889"></a>      <span class='hs-keyglyph'>[</span> <span class='hs-conid'>DigraphNode</span>
<a name="line-2890"></a>        <span class='hs-layout'>{</span> <span class='hs-varid'>node_payload</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms</span>
<a name="line-2891"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>node_key</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNodeKey</span> <span class='hs-varid'>ms</span>
<a name="line-2892"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>node_dependencies</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>get_deps</span> <span class='hs-varid'>ms</span>
<a name="line-2893"></a>        <span class='hs-layout'>}</span>
<a name="line-2894"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mss</span>
<a name="line-2895"></a>      <span class='hs-keyglyph'>]</span>
<a name="line-2896"></a>
<a name="line-2897"></a>    <span class='hs-varid'>get_deps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleGraphNode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NodeKey</span><span class='hs-keyglyph'>]</span>
<a name="line-2898"></a>    <span class='hs-varid'>get_deps</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>case</span>
<a name="line-2899"></a>      <span class='hs-conid'>InstantiationNode</span> <span class='hs-varid'>iuid</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2900"></a>        <span class='hs-keyglyph'>[</span> <span class='hs-conid'>NodeKey_Module</span> <span class='hs-varop'>$</span> <span class='hs-conid'>GWIB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gwib_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hole</span><span class='hs-layout'>,</span> <span class='hs-varid'>gwib_isBoot</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NotBoot</span> <span class='hs-layout'>}</span>
<a name="line-2901"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>hole</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uniqDSetToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>instUnitHoles</span> <span class='hs-varid'>iuid</span>
<a name="line-2902"></a>        <span class='hs-keyglyph'>]</span>
<a name="line-2903"></a>      <span class='hs-conid'>ModuleNode</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExtendedModSummary</span> <span class='hs-varid'>ms</span> <span class='hs-varid'>bds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2904"></a>        <span class='hs-keyglyph'>[</span> <span class='hs-conid'>NodeKey_Module</span> <span class='hs-varop'>$</span> <span class='hs-conid'>GWIB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gwib_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>gwib_isBoot</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IsBoot</span> <span class='hs-layout'>}</span>
<a name="line-2905"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ms_home_srcimps</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span>
<a name="line-2906"></a>        <span class='hs-keyglyph'>[</span> <span class='hs-conid'>NodeKey_Module</span> <span class='hs-varop'>$</span> <span class='hs-conid'>GWIB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gwib_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>gwib_isBoot</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NotBoot</span> <span class='hs-layout'>}</span>
<a name="line-2907"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ms_home_imps</span>    <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span>
<a name="line-2908"></a>        <span class='hs-keyglyph'>[</span> <span class='hs-conid'>NodeKey_Unit</span> <span class='hs-varid'>inst_unit</span>
<a name="line-2909"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>inst_unit</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bds</span>
<a name="line-2910"></a>        <span class='hs-keyglyph'>]</span>
<a name="line-2911"></a>
<a name="line-2912"></a>    <span class='hs-varid'>show_path</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleGraphNode</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2913"></a>    <span class='hs-varid'>show_path</span> <span class='hs-conid'>[]</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"show_path"</span>
<a name="line-2914"></a>    <span class='hs-varid'>show_path</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>m</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_node</span> <span class='hs-varid'>m</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"imports itself"</span>
<a name="line-2915"></a>    <span class='hs-varid'>show_path</span> <span class='hs-layout'>(</span><span class='hs-varid'>m1</span><span class='hs-conop'>:</span><span class='hs-varid'>m2</span><span class='hs-conop'>:</span><span class='hs-varid'>ms</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span> <span class='hs-varid'>nest</span> <span class='hs-num'>6</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_node</span> <span class='hs-varid'>m1</span><span class='hs-layout'>)</span>
<a name="line-2916"></a>                                <span class='hs-conop'>:</span> <span class='hs-varid'>nest</span> <span class='hs-num'>6</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"imports"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_node</span> <span class='hs-varid'>m2</span><span class='hs-layout'>)</span>
<a name="line-2917"></a>                                <span class='hs-conop'>:</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ms</span> <span class='hs-layout'>)</span>
<a name="line-2918"></a>       <span class='hs-keyword'>where</span>
<a name="line-2919"></a>         <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"which imports"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_node</span> <span class='hs-varid'>m1</span><span class='hs-keyglyph'>]</span>
<a name="line-2920"></a>         <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-conop'>:</span><span class='hs-varid'>ms</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"which imports"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_node</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ms</span>
<a name="line-2921"></a>
<a name="line-2922"></a>    <span class='hs-varid'>ppr_node</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleGraphNode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2923"></a>    <span class='hs-varid'>ppr_node</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModuleNode</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"module"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_ms</span> <span class='hs-layout'>(</span><span class='hs-varid'>emsModSummary</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-2924"></a>    <span class='hs-varid'>ppr_node</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstantiationNode</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"instantiated unit"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>u</span>
<a name="line-2925"></a>
<a name="line-2926"></a>    <span class='hs-varid'>ppr_ms</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2927"></a>    <span class='hs-varid'>ppr_ms</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_mod</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-2928"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>msHsFilePath</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre></body>
</html>
