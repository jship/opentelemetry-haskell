<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Tc/Solver/Monad.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP, DeriveFunctor, TypeFamilies, ScopedTypeVariables, TypeApplications,
<a name="line-2"></a>             DerivingStrategies, GeneralizedNewtypeDeriving, ScopedTypeVariables, MultiWayIf, ViewPatterns #-}</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-comment'>{-# OPTIONS_GHC -Wno-incomplete-record-updates -Wno-incomplete-uni-patterns #-}</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-comment'>-- | Type definitions for the constraint solver</span>
<a name="line-7"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Tc.Solver.Monad</span> <span class='hs-layout'>(</span>
<a name="line-8"></a>
<a name="line-9"></a>    <span class='hs-comment'>-- The work list</span>
<a name="line-10"></a>    <span class='hs-conid'>WorkList</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEmptyWorkList</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyWorkList</span><span class='hs-layout'>,</span>
<a name="line-11"></a>    <span class='hs-varid'>extendWorkListNonEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendWorkListCt</span><span class='hs-layout'>,</span>
<a name="line-12"></a>    <span class='hs-varid'>extendWorkListCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendWorkListEq</span><span class='hs-layout'>,</span>
<a name="line-13"></a>    <span class='hs-varid'>appendWorkList</span><span class='hs-layout'>,</span>
<a name="line-14"></a>    <span class='hs-varid'>selectNextWorkItem</span><span class='hs-layout'>,</span>
<a name="line-15"></a>    <span class='hs-varid'>workListSize</span><span class='hs-layout'>,</span>
<a name="line-16"></a>    <span class='hs-varid'>getWorkList</span><span class='hs-layout'>,</span> <span class='hs-varid'>updWorkListTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>pushLevelNoWorkList</span><span class='hs-layout'>,</span>
<a name="line-17"></a>
<a name="line-18"></a>    <span class='hs-comment'>-- The TcS monad</span>
<a name="line-19"></a>    <span class='hs-conid'>TcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>runTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>runTcSDeriveds</span><span class='hs-layout'>,</span> <span class='hs-varid'>runTcSWithEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>runTcSInerts</span><span class='hs-layout'>,</span>
<a name="line-20"></a>    <span class='hs-varid'>failTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>warnTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>addErrTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrapTcS</span><span class='hs-layout'>,</span>
<a name="line-21"></a>    <span class='hs-varid'>runTcSEqualities</span><span class='hs-layout'>,</span>
<a name="line-22"></a>    <span class='hs-varid'>nestTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>nestImplicTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>setEvBindsTcS</span><span class='hs-layout'>,</span>
<a name="line-23"></a>    <span class='hs-varid'>emitImplicationTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitTvImplicationTcS</span><span class='hs-layout'>,</span>
<a name="line-24"></a>
<a name="line-25"></a>    <span class='hs-varid'>runTcPluginTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>addUsedGRE</span><span class='hs-layout'>,</span> <span class='hs-varid'>addUsedGREs</span><span class='hs-layout'>,</span> <span class='hs-varid'>keepAlive</span><span class='hs-layout'>,</span>
<a name="line-26"></a>    <span class='hs-varid'>matchGlobalInst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcM.ClsInstResult</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-27"></a>
<a name="line-28"></a>    <span class='hs-conid'>QCInst</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-29"></a>
<a name="line-30"></a>    <span class='hs-comment'>-- Tracing etc</span>
<a name="line-31"></a>    <span class='hs-varid'>panicTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>traceTcS</span><span class='hs-layout'>,</span>
<a name="line-32"></a>    <span class='hs-varid'>traceFireTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>bumpStepCountTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>csTraceTcS</span><span class='hs-layout'>,</span>
<a name="line-33"></a>    <span class='hs-varid'>wrapErrTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrapWarnTcS</span><span class='hs-layout'>,</span>
<a name="line-34"></a>    <span class='hs-varid'>resetUnificationFlag</span><span class='hs-layout'>,</span> <span class='hs-varid'>setUnificationFlag</span><span class='hs-layout'>,</span>
<a name="line-35"></a>
<a name="line-36"></a>    <span class='hs-comment'>-- Evidence creation and transformation</span>
<a name="line-37"></a>    <span class='hs-conid'>MaybeNew</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>freshGoals</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFresh</span><span class='hs-layout'>,</span> <span class='hs-varid'>getEvExpr</span><span class='hs-layout'>,</span>
<a name="line-38"></a>
<a name="line-39"></a>    <span class='hs-varid'>newTcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>newNoTcEvBinds</span><span class='hs-layout'>,</span>
<a name="line-40"></a>    <span class='hs-varid'>newWantedEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>newWantedEq_SI</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitNewWantedEq</span><span class='hs-layout'>,</span>
<a name="line-41"></a>    <span class='hs-varid'>newWanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>newWanted_SI</span><span class='hs-layout'>,</span> <span class='hs-varid'>newWantedEvVar</span><span class='hs-layout'>,</span>
<a name="line-42"></a>    <span class='hs-varid'>newWantedNC</span><span class='hs-layout'>,</span> <span class='hs-varid'>newWantedEvVarNC</span><span class='hs-layout'>,</span>
<a name="line-43"></a>    <span class='hs-varid'>newDerivedNC</span><span class='hs-layout'>,</span>
<a name="line-44"></a>    <span class='hs-varid'>newBoundEvVarId</span><span class='hs-layout'>,</span>
<a name="line-45"></a>    <span class='hs-varid'>unifyTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>reportUnifications</span><span class='hs-layout'>,</span> <span class='hs-varid'>touchabilityTest</span><span class='hs-layout'>,</span> <span class='hs-conid'>TouchabilityTestResult</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-46"></a>    <span class='hs-varid'>setEvBind</span><span class='hs-layout'>,</span> <span class='hs-varid'>setWantedEq</span><span class='hs-layout'>,</span>
<a name="line-47"></a>    <span class='hs-varid'>setWantedEvTerm</span><span class='hs-layout'>,</span> <span class='hs-varid'>setEvBindIfWanted</span><span class='hs-layout'>,</span>
<a name="line-48"></a>    <span class='hs-varid'>newEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>newGivenEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>newGivenEvVars</span><span class='hs-layout'>,</span>
<a name="line-49"></a>    <span class='hs-varid'>emitNewDeriveds</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitNewDerivedEq</span><span class='hs-layout'>,</span>
<a name="line-50"></a>    <span class='hs-varid'>checkReductionDepth</span><span class='hs-layout'>,</span>
<a name="line-51"></a>    <span class='hs-varid'>getSolvedDicts</span><span class='hs-layout'>,</span> <span class='hs-varid'>setSolvedDicts</span><span class='hs-layout'>,</span>
<a name="line-52"></a>
<a name="line-53"></a>    <span class='hs-varid'>getInstEnvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>getFamInstEnvs</span><span class='hs-layout'>,</span>                <span class='hs-comment'>-- Getting the environments</span>
<a name="line-54"></a>    <span class='hs-varid'>getTopEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>getGblEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>getLclEnv</span><span class='hs-layout'>,</span>
<a name="line-55"></a>    <span class='hs-varid'>getTcEvBindsVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTcLevel</span><span class='hs-layout'>,</span>
<a name="line-56"></a>    <span class='hs-varid'>getTcEvTyCoVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTcEvBindsMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>setTcEvBindsMap</span><span class='hs-layout'>,</span>
<a name="line-57"></a>    <span class='hs-varid'>tcLookupClass</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcLookupId</span><span class='hs-layout'>,</span>
<a name="line-58"></a>
<a name="line-59"></a>    <span class='hs-comment'>-- Inerts</span>
<a name="line-60"></a>    <span class='hs-conid'>InertSet</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>InertCans</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyInert</span><span class='hs-layout'>,</span>
<a name="line-61"></a>    <span class='hs-varid'>updInertTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>updInertCans</span><span class='hs-layout'>,</span> <span class='hs-varid'>updInertDicts</span><span class='hs-layout'>,</span> <span class='hs-varid'>updInertIrreds</span><span class='hs-layout'>,</span>
<a name="line-62"></a>    <span class='hs-varid'>getHasGivenEqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>setInertCans</span><span class='hs-layout'>,</span>
<a name="line-63"></a>    <span class='hs-varid'>getInertEqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>getInertCans</span><span class='hs-layout'>,</span> <span class='hs-varid'>getInertGivens</span><span class='hs-layout'>,</span>
<a name="line-64"></a>    <span class='hs-varid'>getInertInsols</span><span class='hs-layout'>,</span> <span class='hs-varid'>getInnermostGivenEqLevel</span><span class='hs-layout'>,</span>
<a name="line-65"></a>    <span class='hs-varid'>getTcSInerts</span><span class='hs-layout'>,</span> <span class='hs-varid'>setTcSInerts</span><span class='hs-layout'>,</span>
<a name="line-66"></a>    <span class='hs-varid'>matchableGivens</span><span class='hs-layout'>,</span> <span class='hs-varid'>prohibitedSuperClassSolve</span><span class='hs-layout'>,</span> <span class='hs-varid'>mightEqualLater</span><span class='hs-layout'>,</span>
<a name="line-67"></a>    <span class='hs-varid'>getUnsolvedInerts</span><span class='hs-layout'>,</span>
<a name="line-68"></a>    <span class='hs-varid'>removeInertCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>getPendingGivenScs</span><span class='hs-layout'>,</span>
<a name="line-69"></a>    <span class='hs-varid'>addInertCan</span><span class='hs-layout'>,</span> <span class='hs-varid'>insertFunEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>addInertForAll</span><span class='hs-layout'>,</span>
<a name="line-70"></a>    <span class='hs-varid'>emitWorkNC</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitWork</span><span class='hs-layout'>,</span>
<a name="line-71"></a>    <span class='hs-varid'>isImprovable</span><span class='hs-layout'>,</span>
<a name="line-72"></a>
<a name="line-73"></a>    <span class='hs-comment'>-- The Model</span>
<a name="line-74"></a>    <span class='hs-varid'>kickOutAfterUnification</span><span class='hs-layout'>,</span>
<a name="line-75"></a>
<a name="line-76"></a>    <span class='hs-comment'>-- Inert Safe Haskell safe-overlap failures</span>
<a name="line-77"></a>    <span class='hs-varid'>addInertSafehask</span><span class='hs-layout'>,</span> <span class='hs-varid'>insertSafeOverlapFailureTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>updInertSafehask</span><span class='hs-layout'>,</span>
<a name="line-78"></a>    <span class='hs-varid'>getSafeOverlapFailures</span><span class='hs-layout'>,</span>
<a name="line-79"></a>
<a name="line-80"></a>    <span class='hs-comment'>-- Inert CDictCans</span>
<a name="line-81"></a>    <span class='hs-conid'>DictMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyDictMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupInertDict</span><span class='hs-layout'>,</span> <span class='hs-varid'>findDictsByClass</span><span class='hs-layout'>,</span> <span class='hs-varid'>addDict</span><span class='hs-layout'>,</span>
<a name="line-82"></a>    <span class='hs-varid'>addDictsByClass</span><span class='hs-layout'>,</span> <span class='hs-varid'>delDict</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldDicts</span><span class='hs-layout'>,</span> <span class='hs-varid'>filterDicts</span><span class='hs-layout'>,</span> <span class='hs-varid'>findDict</span><span class='hs-layout'>,</span>
<a name="line-83"></a>
<a name="line-84"></a>    <span class='hs-comment'>-- Inert CEqCans</span>
<a name="line-85"></a>    <span class='hs-conid'>EqualCtList</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>findTyEqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldTyEqs</span><span class='hs-layout'>,</span>
<a name="line-86"></a>    <span class='hs-varid'>findEq</span><span class='hs-layout'>,</span>
<a name="line-87"></a>
<a name="line-88"></a>    <span class='hs-comment'>-- Inert solved dictionaries</span>
<a name="line-89"></a>    <span class='hs-varid'>addSolvedDict</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupSolvedDict</span><span class='hs-layout'>,</span>
<a name="line-90"></a>
<a name="line-91"></a>    <span class='hs-comment'>-- Irreds</span>
<a name="line-92"></a>    <span class='hs-varid'>foldIrreds</span><span class='hs-layout'>,</span>
<a name="line-93"></a>
<a name="line-94"></a>    <span class='hs-comment'>-- The family application cache</span>
<a name="line-95"></a>    <span class='hs-varid'>lookupFamAppInert</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupFamAppCache</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendFamAppCache</span><span class='hs-layout'>,</span>
<a name="line-96"></a>    <span class='hs-varid'>pprKicked</span><span class='hs-layout'>,</span>
<a name="line-97"></a>
<a name="line-98"></a>    <span class='hs-comment'>-- Inert function equalities</span>
<a name="line-99"></a>    <span class='hs-varid'>findFunEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>findFunEqsByTyCon</span><span class='hs-layout'>,</span>
<a name="line-100"></a>
<a name="line-101"></a>    <span class='hs-varid'>instDFunType</span><span class='hs-layout'>,</span>                              <span class='hs-comment'>-- Instantiation</span>
<a name="line-102"></a>
<a name="line-103"></a>    <span class='hs-comment'>-- MetaTyVars</span>
<a name="line-104"></a>    <span class='hs-varid'>newFlexiTcSTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>instFlexi</span><span class='hs-layout'>,</span> <span class='hs-varid'>instFlexiX</span><span class='hs-layout'>,</span>
<a name="line-105"></a>    <span class='hs-varid'>cloneMetaTyVar</span><span class='hs-layout'>,</span>
<a name="line-106"></a>    <span class='hs-varid'>tcInstSkolTyVarsX</span><span class='hs-layout'>,</span>
<a name="line-107"></a>
<a name="line-108"></a>    <span class='hs-conid'>TcLevel</span><span class='hs-layout'>,</span>
<a name="line-109"></a>    <span class='hs-varid'>isFilledMetaTyVar_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFilledMetaTyVar</span><span class='hs-layout'>,</span>
<a name="line-110"></a>    <span class='hs-varid'>zonkTyCoVarsAndFV</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTcType</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTcTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTcTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkCo</span><span class='hs-layout'>,</span>
<a name="line-111"></a>    <span class='hs-varid'>zonkTyCoVarsAndFVList</span><span class='hs-layout'>,</span>
<a name="line-112"></a>    <span class='hs-varid'>zonkSimples</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkWC</span><span class='hs-layout'>,</span>
<a name="line-113"></a>    <span class='hs-varid'>zonkTyCoVarKind</span><span class='hs-layout'>,</span>
<a name="line-114"></a>
<a name="line-115"></a>    <span class='hs-comment'>-- References</span>
<a name="line-116"></a>    <span class='hs-varid'>newTcRef</span><span class='hs-layout'>,</span> <span class='hs-varid'>readTcRef</span><span class='hs-layout'>,</span> <span class='hs-varid'>writeTcRef</span><span class='hs-layout'>,</span> <span class='hs-varid'>updTcRef</span><span class='hs-layout'>,</span>
<a name="line-117"></a>
<a name="line-118"></a>    <span class='hs-comment'>-- Misc</span>
<a name="line-119"></a>    <span class='hs-varid'>getDefaultInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>getDynFlags</span><span class='hs-layout'>,</span> <span class='hs-varid'>getGlobalRdrEnvTcS</span><span class='hs-layout'>,</span>
<a name="line-120"></a>    <span class='hs-varid'>matchFam</span><span class='hs-layout'>,</span> <span class='hs-varid'>matchFamTcM</span><span class='hs-layout'>,</span>
<a name="line-121"></a>    <span class='hs-varid'>checkWellStagedDFun</span><span class='hs-layout'>,</span>
<a name="line-122"></a>    <span class='hs-varid'>pprEq</span><span class='hs-layout'>,</span>                                   <span class='hs-comment'>-- Smaller utils, re-exported from TcM</span>
<a name="line-123"></a>                                             <span class='hs-comment'>-- TODO (DV): these are only really used in the</span>
<a name="line-124"></a>                                             <span class='hs-comment'>-- instance matcher in GHC.Tc.Solver. I am wondering</span>
<a name="line-125"></a>                                             <span class='hs-comment'>-- if the whole instance matcher simply belongs</span>
<a name="line-126"></a>                                             <span class='hs-comment'>-- here</span>
<a name="line-127"></a>
<a name="line-128"></a>    <span class='hs-varid'>breakTyEqCycle_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>rewriterView</span>
<a name="line-129"></a><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-130"></a>
<a name="line-131"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-132"></a>
<a name="line-133"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-134"></a>
<a name="line-135"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Env</span>
<a name="line-136"></a>
<a name="line-137"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.Tc.Utils.Instantiate</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-138"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.InstEnv</span>
<a name="line-139"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Instance.Family</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>FamInst</span>
<a name="line-140"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.FamInstEnv</span>
<a name="line-141"></a>
<a name="line-142"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.Tc.Utils.Monad</span>    <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-143"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.Tc.Utils.TcMType</span>  <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-144"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.Tc.Instance.Class</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span><span class='hs-layout'>(</span> <span class='hs-varid'>matchGlobalInst</span><span class='hs-layout'>,</span> <span class='hs-conid'>ClsInstResult</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-145"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.Tc.Utils.Env</span>      <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-146"></a>       <span class='hs-layout'>(</span> <span class='hs-varid'>checkWellStaged</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcGetDefaultTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcLookupClass</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcLookupId</span><span class='hs-layout'>,</span> <span class='hs-varid'>topIdLvl</span> <span class='hs-layout'>)</span>
<a name="line-147"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Instance.Class</span><span class='hs-layout'>(</span> <span class='hs-conid'>InstanceWhat</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>safeOverlap</span><span class='hs-layout'>,</span> <span class='hs-varid'>instanceReturnsDictCon</span> <span class='hs-layout'>)</span>
<a name="line-148"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.TcType</span>
<a name="line-149"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Unify</span> <span class='hs-layout'>(</span> <span class='hs-varid'>canSolveByUnification</span> <span class='hs-layout'>)</span>
<a name="line-150"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Session</span>
<a name="line-151"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Type</span>
<a name="line-152"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.Core.TyCo.Rep</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Rep</span>  <span class='hs-comment'>-- this needs to be used only very locally</span>
<a name="line-153"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Coercion</span>
<a name="line-154"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Unify</span>
<a name="line-155"></a>
<a name="line-156"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Types.Evidence</span>
<a name="line-157"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Class</span>
<a name="line-158"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCon</span>
<a name="line-159"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Errors</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>solverDepthErrorTcS</span> <span class='hs-layout'>)</span>
<a name="line-160"></a>
<a name="line-161"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name</span>
<a name="line-162"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.TyThing</span>
<a name="line-163"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module</span> <span class='hs-layout'>(</span> <span class='hs-conid'>HasModule</span><span class='hs-layout'>,</span> <span class='hs-varid'>getModule</span> <span class='hs-layout'>)</span>
<a name="line-164"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Reader</span> <span class='hs-layout'>(</span> <span class='hs-conid'>GlobalRdrEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-layout'>)</span>
<a name="line-165"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.Rename.Env</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-166"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var</span>
<a name="line-167"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var.Env</span>
<a name="line-168"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var.Set</span>
<a name="line-169"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-170"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-171"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Logger</span>
<a name="line-172"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Bag</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Bag</span>
<a name="line-173"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.Supply</span>
<a name="line-174"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-175"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Types</span>
<a name="line-176"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Types.Origin</span>
<a name="line-177"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Types.Constraint</span>
<a name="line-178"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Predicate</span>
<a name="line-179"></a>
<a name="line-180"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.Set</span>
<a name="line-181"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCon.Env</span>
<a name="line-182"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Maybe</span>
<a name="line-183"></a>
<a name="line-184"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Map.Type</span>
<a name="line-185"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.TrieMap</span>
<a name="line-186"></a>
<a name="line-187"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad</span>
<a name="line-188"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Monad</span>
<a name="line-189"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.IORef</span>
<a name="line-190"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Exts</span> <span class='hs-layout'>(</span><span class='hs-varid'>oneShot</span><span class='hs-layout'>)</span>
<a name="line-191"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List</span> <span class='hs-layout'>(</span> <span class='hs-varid'>partition</span><span class='hs-layout'>,</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-layout'>)</span>
<a name="line-192"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List.NonEmpty</span> <span class='hs-layout'>(</span> <span class='hs-conid'>NonEmpty</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>cons</span><span class='hs-layout'>,</span> <span class='hs-varid'>toList</span><span class='hs-layout'>,</span> <span class='hs-varid'>nonEmpty</span> <span class='hs-layout'>)</span>
<a name="line-193"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.List.NonEmpty</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>NE</span>
<a name="line-194"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Arrow</span> <span class='hs-layout'>(</span> <span class='hs-varid'>first</span> <span class='hs-layout'>)</span>
<a name="line-195"></a>
<a name="line-196"></a><span class='hs-cpp'>#if defined(DEBUG)</span>
<a name="line-197"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Graph.Directed</span>
<a name="line-198"></a><span class='hs-cpp'>#endif</span>
<a name="line-199"></a>
<a name="line-200"></a><span class='hs-comment'>{-
<a name="line-201"></a>************************************************************************
<a name="line-202"></a>*                                                                      *
<a name="line-203"></a>*                            Worklists                                *
<a name="line-204"></a>*  Canonical and non-canonical constraints that the simplifier has to  *
<a name="line-205"></a>*  work on. Including their simplification depths.                     *
<a name="line-206"></a>*                                                                      *
<a name="line-207"></a>*                                                                      *
<a name="line-208"></a>************************************************************************
<a name="line-209"></a>
<a name="line-210"></a>Note [WorkList priorities]
<a name="line-211"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-212"></a>A WorkList contains canonical and non-canonical items (of all flavours).
<a name="line-213"></a>Notice that each Ct now has a simplification depth. We may
<a name="line-214"></a>consider using this depth for prioritization as well in the future.
<a name="line-215"></a>
<a name="line-216"></a>As a simple form of priority queue, our worklist separates out
<a name="line-217"></a>
<a name="line-218"></a>* equalities (wl_eqs); see Note [Prioritise equalities]
<a name="line-219"></a>* all the rest (wl_rest)
<a name="line-220"></a>
<a name="line-221"></a>Note [Prioritise equalities]
<a name="line-222"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-223"></a>It's very important to process equalities /first/:
<a name="line-224"></a>
<a name="line-225"></a>* (Efficiency)  The general reason to do so is that if we process a
<a name="line-226"></a>  class constraint first, we may end up putting it into the inert set
<a name="line-227"></a>  and then kicking it out later.  That's extra work compared to just
<a name="line-228"></a>  doing the equality first.
<a name="line-229"></a>
<a name="line-230"></a>* (Avoiding fundep iteration) As #14723 showed, it's possible to
<a name="line-231"></a>  get non-termination if we
<a name="line-232"></a>      - Emit the Derived fundep equalities for a class constraint,
<a name="line-233"></a>        generating some fresh unification variables.
<a name="line-234"></a>      - That leads to some unification
<a name="line-235"></a>      - Which kicks out the class constraint
<a name="line-236"></a>      - Which isn't solved (because there are still some more Derived
<a name="line-237"></a>        equalities in the work-list), but generates yet more fundeps
<a name="line-238"></a>  Solution: prioritise derived equalities over class constraints
<a name="line-239"></a>
<a name="line-240"></a>* (Class equalities) We need to prioritise equalities even if they
<a name="line-241"></a>  are hidden inside a class constraint;
<a name="line-242"></a>  see Note [Prioritise class equalities]
<a name="line-243"></a>
<a name="line-244"></a>* (Kick-out) We want to apply this priority scheme to kicked-out
<a name="line-245"></a>  constraints too (see the call to extendWorkListCt in kick_out_rewritable
<a name="line-246"></a>  E.g. a CIrredCan can be a hetero-kinded (t1 ~ t2), which may become
<a name="line-247"></a>  homo-kinded when kicked out, and hence we want to prioritise it.
<a name="line-248"></a>
<a name="line-249"></a>* (Derived equalities) Originally we tried to postpone processing
<a name="line-250"></a>  Derived equalities, in the hope that we might never need to deal
<a name="line-251"></a>  with them at all; but in fact we must process Derived equalities
<a name="line-252"></a>  eagerly, partly for the (Efficiency) reason, and more importantly
<a name="line-253"></a>  for (Avoiding fundep iteration).
<a name="line-254"></a>
<a name="line-255"></a>Note [Prioritise class equalities]
<a name="line-256"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-257"></a>We prioritise equalities in the solver (see selectWorkItem). But class
<a name="line-258"></a>constraints like (a ~ b) and (a ~~ b) are actually equalities too;
<a name="line-259"></a>see Note [The equality types story] in GHC.Builtin.Types.Prim.
<a name="line-260"></a>
<a name="line-261"></a>Failing to prioritise these is inefficient (more kick-outs etc).
<a name="line-262"></a>But, worse, it can prevent us spotting a "recursive knot" among
<a name="line-263"></a>Wanted constraints.  See comment:10 of #12734 for a worked-out
<a name="line-264"></a>example.
<a name="line-265"></a>
<a name="line-266"></a>So we arrange to put these particular class constraints in the wl_eqs.
<a name="line-267"></a>
<a name="line-268"></a>  NB: since we do not currently apply the substitution to the
<a name="line-269"></a>  inert_solved_dicts, the knot-tying still seems a bit fragile.
<a name="line-270"></a>  But this makes it better.
<a name="line-271"></a>
<a name="line-272"></a>-}</span>
<a name="line-273"></a>
<a name="line-274"></a><a name="WorkList"></a><span class='hs-comment'>-- See Note [WorkList priorities]</span>
<a name="line-275"></a><a name="WorkList"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>WorkList</span>
<a name="line-276"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- CEqCan, CDictCan, CIrredCan</span>
<a name="line-277"></a>                             <span class='hs-comment'>-- Given, Wanted, and Derived</span>
<a name="line-278"></a>                       <span class='hs-comment'>-- Contains both equality constraints and their</span>
<a name="line-279"></a>                       <span class='hs-comment'>-- class-level variants (a~b) and (a~~b);</span>
<a name="line-280"></a>                       <span class='hs-comment'>-- See Note [Prioritise equalities]</span>
<a name="line-281"></a>                       <span class='hs-comment'>-- See Note [Prioritise class equalities]</span>
<a name="line-282"></a>
<a name="line-283"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span>    <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-284"></a>
<a name="line-285"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span>  <span class='hs-comment'>-- See Note [Residual implications]</span>
<a name="line-286"></a>    <span class='hs-layout'>}</span>
<a name="line-287"></a>
<a name="line-288"></a><a name="appendWorkList"></a><span class='hs-definition'>appendWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-289"></a><span class='hs-definition'>appendWorkList</span>
<a name="line-290"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest1</span>
<a name="line-291"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-292"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest2</span>
<a name="line-293"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-294"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs1</span>     <span class='hs-varop'>++</span> <span class='hs-varid'>eqs2</span>
<a name="line-295"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest1</span>    <span class='hs-varop'>++</span> <span class='hs-varid'>rest2</span>
<a name="line-296"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics1</span> <span class='hs-varop'>`unionBags`</span>   <span class='hs-varid'>implics2</span> <span class='hs-layout'>}</span>
<a name="line-297"></a>
<a name="line-298"></a><a name="workListSize"></a><span class='hs-definition'>workListSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-299"></a><span class='hs-definition'>workListSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-300"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>eqs</span> <span class='hs-varop'>+</span> <span class='hs-varid'>length</span> <span class='hs-varid'>rest</span>
<a name="line-301"></a>
<a name="line-302"></a><a name="extendWorkListEq"></a><span class='hs-definition'>extendWorkListEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-303"></a><span class='hs-definition'>extendWorkListEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-304"></a>
<a name="line-305"></a><a name="extendWorkListNonEq"></a><span class='hs-definition'>extendWorkListNonEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-306"></a><span class='hs-comment'>-- Extension by non equality</span>
<a name="line-307"></a><span class='hs-definition'>extendWorkListNonEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>wl_rest</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-308"></a>
<a name="line-309"></a><a name="extendWorkListDeriveds"></a><span class='hs-definition'>extendWorkListDeriveds</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CtEvidence</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-310"></a><span class='hs-definition'>extendWorkListDeriveds</span> <span class='hs-varid'>evs</span> <span class='hs-varid'>wl</span>
<a name="line-311"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendWorkListCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mkNonCanonical</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span> <span class='hs-varid'>wl</span>
<a name="line-312"></a>
<a name="line-313"></a><a name="extendWorkListImplic"></a><span class='hs-definition'>extendWorkListImplic</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Implication</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-314"></a><span class='hs-definition'>extendWorkListImplic</span> <span class='hs-varid'>implic</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implic</span> <span class='hs-varop'>`consBag`</span> <span class='hs-varid'>wl_implics</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-315"></a>
<a name="line-316"></a><a name="extendWorkListCt"></a><span class='hs-definition'>extendWorkListCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-317"></a><span class='hs-comment'>-- Agnostic</span>
<a name="line-318"></a><span class='hs-definition'>extendWorkListCt</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-319"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-320"></a>     <span class='hs-conid'>EqPred</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>
<a name="line-321"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendWorkListEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-322"></a>
<a name="line-323"></a>     <span class='hs-conid'>ClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-keyword'>_</span>  <span class='hs-comment'>-- See Note [Prioritise class equalities]</span>
<a name="line-324"></a>       <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>isEqPredClass</span> <span class='hs-varid'>cls</span>
<a name="line-325"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendWorkListEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-326"></a>
<a name="line-327"></a>     <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendWorkListNonEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-328"></a>
<a name="line-329"></a><a name="extendWorkListCts"></a><span class='hs-definition'>extendWorkListCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-330"></a><span class='hs-comment'>-- Agnostic</span>
<a name="line-331"></a><span class='hs-definition'>extendWorkListCts</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>extendWorkListCt</span> <span class='hs-varid'>wl</span> <span class='hs-varid'>cts</span>
<a name="line-332"></a>
<a name="line-333"></a><a name="isEmptyWorkList"></a><span class='hs-definition'>isEmptyWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-334"></a><span class='hs-definition'>isEmptyWorkList</span> <span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-335"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>null</span> <span class='hs-varid'>eqs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>rest</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>implics</span>
<a name="line-336"></a>
<a name="line-337"></a><a name="emptyWorkList"></a><span class='hs-definition'>emptyWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span>
<a name="line-338"></a><span class='hs-definition'>emptyWorkList</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>}</span>
<a name="line-339"></a>
<a name="line-340"></a><a name="selectWorkItem"></a><span class='hs-definition'>selectWorkItem</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span><span class='hs-layout'>,</span> <span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span>
<a name="line-341"></a><span class='hs-comment'>-- See Note [Prioritise equalities]</span>
<a name="line-342"></a><span class='hs-definition'>selectWorkItem</span> <span class='hs-varid'>wl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-343"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>eqs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-344"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_rest</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-345"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-346"></a>
<a name="line-347"></a><a name="getWorkList"></a><span class='hs-definition'>getWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>WorkList</span>
<a name="line-348"></a><span class='hs-definition'>getWorkList</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSWorkListRef</span>
<a name="line-349"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>wl_var</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-350"></a>
<a name="line-351"></a><a name="selectNextWorkItem"></a><span class='hs-definition'>selectNextWorkItem</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span>
<a name="line-352"></a><span class='hs-comment'>-- Pick which work item to do next</span>
<a name="line-353"></a><span class='hs-comment'>-- See Note [Prioritise equalities]</span>
<a name="line-354"></a><span class='hs-definition'>selectNextWorkItem</span>
<a name="line-355"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSWorkListRef</span>
<a name="line-356"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTcRef</span> <span class='hs-varid'>wl_var</span>
<a name="line-357"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>selectWorkItem</span> <span class='hs-varid'>wl</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-358"></a>           <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>;</span>
<a name="line-359"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_wl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-360"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- checkReductionDepth (ctLoc ct) (ctPred ct)</span>
<a name="line-361"></a>         <span class='hs-comment'>-- This is done by GHC.Tc.Solver.Interact.chooseInstance</span>
<a name="line-362"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>wl_var</span> <span class='hs-varid'>new_wl</span>
<a name="line-363"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-364"></a>
<a name="line-365"></a><a name="instance%20Outputable%20WorkList"></a><span class='hs-comment'>-- Pretty printing</span>
<a name="line-366"></a><a name="instance%20Outputable%20WorkList"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyword'>where</span>
<a name="line-367"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-368"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"WL"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>braces</span> <span class='hs-varop'>$</span>
<a name="line-369"></a>     <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-370"></a>            <span class='hs-varid'>text</span> <span class='hs-str'>"Eqs ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>)</span>
<a name="line-371"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-372"></a>            <span class='hs-varid'>text</span> <span class='hs-str'>"Non-eqs ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span>
<a name="line-373"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>implics</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-374"></a>            <span class='hs-varid'>ifPprDebug</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Implics ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>implics</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-375"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"(Implics omitted)"</span><span class='hs-layout'>)</span>
<a name="line-376"></a>          <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-377"></a>
<a name="line-378"></a>
<a name="line-379"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-380"></a>*                                                                      *
<a name="line-381"></a>                InertSet: the inert set
<a name="line-382"></a>*                                                                      *
<a name="line-383"></a>*                                                                      *
<a name="line-384"></a>********************************************************************* -}</span>
<a name="line-385"></a>
<a name="line-386"></a><a name="CycleBreakerVarStack"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CycleBreakerVarStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NonEmpty</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TcTyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-387"></a>   <span class='hs-comment'>-- ^ a stack of (CycleBreakerTv, original family applications) lists</span>
<a name="line-388"></a>   <span class='hs-comment'>-- first element in the stack corresponds to current implication;</span>
<a name="line-389"></a>   <span class='hs-comment'>--   later elements correspond to outer implications</span>
<a name="line-390"></a>   <span class='hs-comment'>-- used to undo the cycle-breaking needed to handle</span>
<a name="line-391"></a>   <span class='hs-comment'>-- Note [Type equality cycles] in GHC.Tc.Solver.Canonical</span>
<a name="line-392"></a>   <span class='hs-comment'>-- Why store the outer implications? For the use in mightEqualLater (only)</span>
<a name="line-393"></a>
<a name="line-394"></a><a name="InertSet"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>InertSet</span>
<a name="line-395"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span>
<a name="line-396"></a>              <span class='hs-comment'>-- Canonical Given, Wanted, Derived</span>
<a name="line-397"></a>              <span class='hs-comment'>-- Sometimes called "the inert set"</span>
<a name="line-398"></a>
<a name="line-399"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_cycle_breakers</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CycleBreakerVarStack</span>
<a name="line-400"></a>
<a name="line-401"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_famapp_cache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-402"></a>              <span class='hs-comment'>-- Just a hash-cons cache for use when reducing family applications</span>
<a name="line-403"></a>              <span class='hs-comment'>-- only</span>
<a name="line-404"></a>              <span class='hs-comment'>--</span>
<a name="line-405"></a>              <span class='hs-comment'>-- If    F tys :-&gt; (co, rhs, flav),</span>
<a name="line-406"></a>              <span class='hs-comment'>-- then  co :: rhs ~N F tys</span>
<a name="line-407"></a>              <span class='hs-comment'>-- all evidence is from instances or Givens; no coercion holes here</span>
<a name="line-408"></a>              <span class='hs-comment'>-- (We have no way of "kicking out" from the cache, so putting</span>
<a name="line-409"></a>              <span class='hs-comment'>--  wanteds here means we can end up solving a Wanted with itself. Bad)</span>
<a name="line-410"></a>
<a name="line-411"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_solved_dicts</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-412"></a>              <span class='hs-comment'>-- All Wanteds, of form ev :: C t1 .. tn</span>
<a name="line-413"></a>              <span class='hs-comment'>-- See Note [Solved dictionaries]</span>
<a name="line-414"></a>              <span class='hs-comment'>-- and Note [Do not add superclasses of solved dictionaries]</span>
<a name="line-415"></a>       <span class='hs-layout'>}</span>
<a name="line-416"></a>
<a name="line-417"></a><a name="instance%20Outputable%20InertSet"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyword'>where</span>
<a name="line-418"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span>
<a name="line-419"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>solved_dicts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-420"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ics</span>
<a name="line-421"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>dicts</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-422"></a>               <span class='hs-varid'>text</span> <span class='hs-str'>"Solved dicts ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dicts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-423"></a>         <span class='hs-keyword'>where</span>
<a name="line-424"></a>           <span class='hs-varid'>dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bagToList</span> <span class='hs-layout'>(</span><span class='hs-varid'>dictsToBag</span> <span class='hs-varid'>solved_dicts</span><span class='hs-layout'>)</span>
<a name="line-425"></a>
<a name="line-426"></a><a name="emptyInertCans"></a><span class='hs-definition'>emptyInertCans</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span>
<a name="line-427"></a><span class='hs-definition'>emptyInertCans</span>
<a name="line-428"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyDVarEnv</span>
<a name="line-429"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_given_eq_lvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topTcLevel</span>
<a name="line-430"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_given_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-431"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyDicts</span>
<a name="line-432"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_safehask</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyDicts</span>
<a name="line-433"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFunEqs</span>
<a name="line-434"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insts</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-435"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCts</span>
<a name="line-436"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_blocked</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCts</span> <span class='hs-layout'>}</span>
<a name="line-437"></a>
<a name="line-438"></a><a name="emptyInert"></a><span class='hs-definition'>emptyInert</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span>
<a name="line-439"></a><span class='hs-definition'>emptyInert</span>
<a name="line-440"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyInertCans</span>
<a name="line-441"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_cycle_breakers</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span> <span class='hs-conop'>:|</span> <span class='hs-conid'>[]</span>
<a name="line-442"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_famapp_cache</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFunEqs</span>
<a name="line-443"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_solved_dicts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyDictMap</span> <span class='hs-layout'>}</span>
<a name="line-444"></a>
<a name="line-445"></a>
<a name="line-446"></a><span class='hs-comment'>{- Note [Solved dictionaries]
<a name="line-447"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-448"></a>When we apply a top-level instance declaration, we add the "solved"
<a name="line-449"></a>dictionary to the inert_solved_dicts.  In general, we use it to avoid
<a name="line-450"></a>creating a new EvVar when we have a new goal that we have solved in
<a name="line-451"></a>the past.
<a name="line-452"></a>
<a name="line-453"></a>But in particular, we can use it to create *recursive* dictionaries.
<a name="line-454"></a>The simplest, degenerate case is
<a name="line-455"></a>    instance C [a] =&gt; C [a] where ...
<a name="line-456"></a>If we have
<a name="line-457"></a>    [W] d1 :: C [x]
<a name="line-458"></a>then we can apply the instance to get
<a name="line-459"></a>    d1 = $dfCList d
<a name="line-460"></a>    [W] d2 :: C [x]
<a name="line-461"></a>Now 'd1' goes in inert_solved_dicts, and we can solve d2 directly from d1.
<a name="line-462"></a>    d1 = $dfCList d
<a name="line-463"></a>    d2 = d1
<a name="line-464"></a>
<a name="line-465"></a>See Note [Example of recursive dictionaries]
<a name="line-466"></a>
<a name="line-467"></a>VERY IMPORTANT INVARIANT:
<a name="line-468"></a>
<a name="line-469"></a> (Solved Dictionary Invariant)
<a name="line-470"></a>    Every member of the inert_solved_dicts is the result
<a name="line-471"></a>    of applying an instance declaration that "takes a step"
<a name="line-472"></a>
<a name="line-473"></a>    An instance "takes a step" if it has the form
<a name="line-474"></a>        dfunDList d1 d2 = MkD (...) (...) (...)
<a name="line-475"></a>    That is, the dfun is lazy in its arguments, and guarantees to
<a name="line-476"></a>    immediately return a dictionary constructor.  NB: all dictionary
<a name="line-477"></a>    data constructors are lazy in their arguments.
<a name="line-478"></a>
<a name="line-479"></a>    This property is crucial to ensure that all dictionaries are
<a name="line-480"></a>    non-bottom, which in turn ensures that the whole "recursive
<a name="line-481"></a>    dictionary" idea works at all, even if we get something like
<a name="line-482"></a>        rec { d = dfunDList d dx }
<a name="line-483"></a>    See Note [Recursive superclasses] in GHC.Tc.TyCl.Instance.
<a name="line-484"></a>
<a name="line-485"></a> Reason:
<a name="line-486"></a>   - All instances, except two exceptions listed below, "take a step"
<a name="line-487"></a>     in the above sense
<a name="line-488"></a>
<a name="line-489"></a>   - Exception 1: local quantified constraints have no such guarantee;
<a name="line-490"></a>     indeed, adding a "solved dictionary" when appling a quantified
<a name="line-491"></a>     constraint led to the ability to define unsafeCoerce
<a name="line-492"></a>     in #17267.
<a name="line-493"></a>
<a name="line-494"></a>   - Exception 2: the magic built-in instance for (~) has no
<a name="line-495"></a>     such guarantee.  It behaves as if we had
<a name="line-496"></a>         class    (a ~# b) =&gt; (a ~ b) where {}
<a name="line-497"></a>         instance (a ~# b) =&gt; (a ~ b) where {}
<a name="line-498"></a>     The "dfun" for the instance is strict in the coercion.
<a name="line-499"></a>     Anyway there's no point in recording a "solved dict" for
<a name="line-500"></a>     (t1 ~ t2); it's not going to allow a recursive dictionary
<a name="line-501"></a>     to be constructed.  Ditto (~~) and Coercible.
<a name="line-502"></a>
<a name="line-503"></a>THEREFORE we only add a "solved dictionary"
<a name="line-504"></a>  - when applying an instance declaration
<a name="line-505"></a>  - subject to Exceptions 1 and 2 above
<a name="line-506"></a>
<a name="line-507"></a>In implementation terms
<a name="line-508"></a>  - GHC.Tc.Solver.Monad.addSolvedDict adds a new solved dictionary,
<a name="line-509"></a>    conditional on the kind of instance
<a name="line-510"></a>
<a name="line-511"></a>  - It is only called when applying an instance decl,
<a name="line-512"></a>    in GHC.Tc.Solver.Interact.doTopReactDict
<a name="line-513"></a>
<a name="line-514"></a>  - ClsInst.InstanceWhat says what kind of instance was
<a name="line-515"></a>    used to solve the constraint.  In particular
<a name="line-516"></a>      * LocalInstance identifies quantified constraints
<a name="line-517"></a>      * BuiltinEqInstance identifies the strange built-in
<a name="line-518"></a>        instances for equality.
<a name="line-519"></a>
<a name="line-520"></a>  - ClsInst.instanceReturnsDictCon says which kind of
<a name="line-521"></a>    instance guarantees to return a dictionary constructor
<a name="line-522"></a>
<a name="line-523"></a>Other notes about solved dictionaries
<a name="line-524"></a>
<a name="line-525"></a>* See also Note [Do not add superclasses of solved dictionaries]
<a name="line-526"></a>
<a name="line-527"></a>* The inert_solved_dicts field is not rewritten by equalities,
<a name="line-528"></a>  so it may get out of date.
<a name="line-529"></a>
<a name="line-530"></a>* The inert_solved_dicts are all Wanteds, never givens
<a name="line-531"></a>
<a name="line-532"></a>* We only cache dictionaries from top-level instances, not from
<a name="line-533"></a>  local quantified constraints.  Reason: if we cached the latter
<a name="line-534"></a>  we'd need to purge the cache when bringing new quantified
<a name="line-535"></a>  constraints into scope, because quantified constraints "shadow"
<a name="line-536"></a>  top-level instances.
<a name="line-537"></a>
<a name="line-538"></a>Note [Do not add superclasses of solved dictionaries]
<a name="line-539"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-540"></a>Every member of inert_solved_dicts is the result of applying a
<a name="line-541"></a>dictionary function, NOT of applying superclass selection to anything.
<a name="line-542"></a>Consider
<a name="line-543"></a>
<a name="line-544"></a>        class Ord a =&gt; C a where
<a name="line-545"></a>        instance Ord [a] =&gt; C [a] where ...
<a name="line-546"></a>
<a name="line-547"></a>Suppose we are trying to solve
<a name="line-548"></a>  [G] d1 : Ord a
<a name="line-549"></a>  [W] d2 : C [a]
<a name="line-550"></a>
<a name="line-551"></a>Then we'll use the instance decl to give
<a name="line-552"></a>
<a name="line-553"></a>  [G] d1 : Ord a     Solved: d2 : C [a] = $dfCList d3
<a name="line-554"></a>  [W] d3 : Ord [a]
<a name="line-555"></a>
<a name="line-556"></a>We must not add d4 : Ord [a] to the 'solved' set (by taking the
<a name="line-557"></a>superclass of d2), otherwise we'll use it to solve d3, without ever
<a name="line-558"></a>using d1, which would be a catastrophe.
<a name="line-559"></a>
<a name="line-560"></a>Solution: when extending the solved dictionaries, do not add superclasses.
<a name="line-561"></a>That's why each element of the inert_solved_dicts is the result of applying
<a name="line-562"></a>a dictionary function.
<a name="line-563"></a>
<a name="line-564"></a>Note [Example of recursive dictionaries]
<a name="line-565"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-566"></a>--- Example 1
<a name="line-567"></a>
<a name="line-568"></a>    data D r = ZeroD | SuccD (r (D r));
<a name="line-569"></a>
<a name="line-570"></a>    instance (Eq (r (D r))) =&gt; Eq (D r) where
<a name="line-571"></a>        ZeroD     == ZeroD     = True
<a name="line-572"></a>        (SuccD a) == (SuccD b) = a == b
<a name="line-573"></a>        _         == _         = False;
<a name="line-574"></a>
<a name="line-575"></a>    equalDC :: D [] -&gt; D [] -&gt; Bool;
<a name="line-576"></a>    equalDC = (==);
<a name="line-577"></a>
<a name="line-578"></a>We need to prove (Eq (D [])). Here's how we go:
<a name="line-579"></a>
<a name="line-580"></a>   [W] d1 : Eq (D [])
<a name="line-581"></a>By instance decl of Eq (D r):
<a name="line-582"></a>   [W] d2 : Eq [D []]      where   d1 = dfEqD d2
<a name="line-583"></a>By instance decl of Eq [a]:
<a name="line-584"></a>   [W] d3 : Eq (D [])      where   d2 = dfEqList d3
<a name="line-585"></a>                                   d1 = dfEqD d2
<a name="line-586"></a>Now this wanted can interact with our "solved" d1 to get:
<a name="line-587"></a>    d3 = d1
<a name="line-588"></a>
<a name="line-589"></a>-- Example 2:
<a name="line-590"></a>This code arises in the context of "Scrap Your Boilerplate with Class"
<a name="line-591"></a>
<a name="line-592"></a>    class Sat a
<a name="line-593"></a>    class Data ctx a
<a name="line-594"></a>    instance  Sat (ctx Char)             =&gt; Data ctx Char       -- dfunData1
<a name="line-595"></a>    instance (Sat (ctx [a]), Data ctx a) =&gt; Data ctx [a]        -- dfunData2
<a name="line-596"></a>
<a name="line-597"></a>    class Data Maybe a =&gt; Foo a
<a name="line-598"></a>
<a name="line-599"></a>    instance Foo t =&gt; Sat (Maybe t)                             -- dfunSat
<a name="line-600"></a>
<a name="line-601"></a>    instance Data Maybe a =&gt; Foo a                              -- dfunFoo1
<a name="line-602"></a>    instance Foo a        =&gt; Foo [a]                            -- dfunFoo2
<a name="line-603"></a>    instance                 Foo [Char]                         -- dfunFoo3
<a name="line-604"></a>
<a name="line-605"></a>Consider generating the superclasses of the instance declaration
<a name="line-606"></a>         instance Foo a =&gt; Foo [a]
<a name="line-607"></a>
<a name="line-608"></a>So our problem is this
<a name="line-609"></a>    [G] d0 : Foo t
<a name="line-610"></a>    [W] d1 : Data Maybe [t]   -- Desired superclass
<a name="line-611"></a>
<a name="line-612"></a>We may add the given in the inert set, along with its superclasses
<a name="line-613"></a>  Inert:
<a name="line-614"></a>    [G] d0 : Foo t
<a name="line-615"></a>    [G] d01 : Data Maybe t   -- Superclass of d0
<a name="line-616"></a>  WorkList
<a name="line-617"></a>    [W] d1 : Data Maybe [t]
<a name="line-618"></a>
<a name="line-619"></a>Solve d1 using instance dfunData2; d1 := dfunData2 d2 d3
<a name="line-620"></a>  Inert:
<a name="line-621"></a>    [G] d0 : Foo t
<a name="line-622"></a>    [G] d01 : Data Maybe t   -- Superclass of d0
<a name="line-623"></a>  Solved:
<a name="line-624"></a>        d1 : Data Maybe [t]
<a name="line-625"></a>  WorkList:
<a name="line-626"></a>    [W] d2 : Sat (Maybe [t])
<a name="line-627"></a>    [W] d3 : Data Maybe t
<a name="line-628"></a>
<a name="line-629"></a>Now, we may simplify d2 using dfunSat; d2 := dfunSat d4
<a name="line-630"></a>  Inert:
<a name="line-631"></a>    [G] d0 : Foo t
<a name="line-632"></a>    [G] d01 : Data Maybe t   -- Superclass of d0
<a name="line-633"></a>  Solved:
<a name="line-634"></a>        d1 : Data Maybe [t]
<a name="line-635"></a>        d2 : Sat (Maybe [t])
<a name="line-636"></a>  WorkList:
<a name="line-637"></a>    [W] d3 : Data Maybe t
<a name="line-638"></a>    [W] d4 : Foo [t]
<a name="line-639"></a>
<a name="line-640"></a>Now, we can just solve d3 from d01; d3 := d01
<a name="line-641"></a>  Inert
<a name="line-642"></a>    [G] d0 : Foo t
<a name="line-643"></a>    [G] d01 : Data Maybe t   -- Superclass of d0
<a name="line-644"></a>  Solved:
<a name="line-645"></a>        d1 : Data Maybe [t]
<a name="line-646"></a>        d2 : Sat (Maybe [t])
<a name="line-647"></a>  WorkList
<a name="line-648"></a>    [W] d4 : Foo [t]
<a name="line-649"></a>
<a name="line-650"></a>Now, solve d4 using dfunFoo2;  d4 := dfunFoo2 d5
<a name="line-651"></a>  Inert
<a name="line-652"></a>    [G] d0  : Foo t
<a name="line-653"></a>    [G] d01 : Data Maybe t   -- Superclass of d0
<a name="line-654"></a>  Solved:
<a name="line-655"></a>        d1 : Data Maybe [t]
<a name="line-656"></a>        d2 : Sat (Maybe [t])
<a name="line-657"></a>        d4 : Foo [t]
<a name="line-658"></a>  WorkList:
<a name="line-659"></a>    [W] d5 : Foo t
<a name="line-660"></a>
<a name="line-661"></a>Now, d5 can be solved! d5 := d0
<a name="line-662"></a>
<a name="line-663"></a>Result
<a name="line-664"></a>   d1 := dfunData2 d2 d3
<a name="line-665"></a>   d2 := dfunSat d4
<a name="line-666"></a>   d3 := d01
<a name="line-667"></a>   d4 := dfunFoo2 d5
<a name="line-668"></a>   d5 := d0
<a name="line-669"></a>-}</span>
<a name="line-670"></a>
<a name="line-671"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-672"></a>*                                                                      *
<a name="line-673"></a>                InertCans: the canonical inerts
<a name="line-674"></a>*                                                                      *
<a name="line-675"></a>*                                                                      *
<a name="line-676"></a>********************************************************************* -}</span>
<a name="line-677"></a>
<a name="line-678"></a><a name="InertCans"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>InertCans</span>   <span class='hs-comment'>-- See Note [Detailed InertCans Invariants] for more</span>
<a name="line-679"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertEqs</span>
<a name="line-680"></a>              <span class='hs-comment'>-- See Note [inert_eqs: the inert equalities]</span>
<a name="line-681"></a>              <span class='hs-comment'>-- All CEqCans with a TyVarLHS; index is the LHS tyvar</span>
<a name="line-682"></a>              <span class='hs-comment'>-- Domain = skolems and untouchables; a touchable would be unified</span>
<a name="line-683"></a>
<a name="line-684"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>EqualCtList</span>
<a name="line-685"></a>              <span class='hs-comment'>-- All CEqCans with a TyFamLHS; index is the whole family head type.</span>
<a name="line-686"></a>              <span class='hs-comment'>-- LHS is fully rewritten (modulo eqCanRewrite constraints)</span>
<a name="line-687"></a>              <span class='hs-comment'>--     wrt inert_eqs</span>
<a name="line-688"></a>              <span class='hs-comment'>-- Can include all flavours, [G], [W], [WD], [D]</span>
<a name="line-689"></a>
<a name="line-690"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span>
<a name="line-691"></a>              <span class='hs-comment'>-- Dictionaries only</span>
<a name="line-692"></a>              <span class='hs-comment'>-- All fully rewritten (modulo flavour constraints)</span>
<a name="line-693"></a>              <span class='hs-comment'>--     wrt inert_eqs</span>
<a name="line-694"></a>
<a name="line-695"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>QCInst</span><span class='hs-keyglyph'>]</span>
<a name="line-696"></a>
<a name="line-697"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span>
<a name="line-698"></a>              <span class='hs-comment'>-- Failed dictionary resolution due to Safe Haskell overlapping</span>
<a name="line-699"></a>              <span class='hs-comment'>-- instances restriction. We keep this separate from inert_dicts</span>
<a name="line-700"></a>              <span class='hs-comment'>-- as it doesn't cause compilation failure, just safe inference</span>
<a name="line-701"></a>              <span class='hs-comment'>-- failure.</span>
<a name="line-702"></a>              <span class='hs-comment'>--</span>
<a name="line-703"></a>              <span class='hs-comment'>-- ^ See Note [Safe Haskell Overlapping Instances Implementation]</span>
<a name="line-704"></a>              <span class='hs-comment'>-- in "GHC.Tc.Solver"</span>
<a name="line-705"></a>
<a name="line-706"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>
<a name="line-707"></a>              <span class='hs-comment'>-- Irreducible predicates that cannot be made canonical,</span>
<a name="line-708"></a>              <span class='hs-comment'>--     and which don't interact with others (e.g.  (c a))</span>
<a name="line-709"></a>              <span class='hs-comment'>-- and insoluble predicates (e.g.  Int ~ Bool, or a ~ [a])</span>
<a name="line-710"></a>
<a name="line-711"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_blocked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>
<a name="line-712"></a>              <span class='hs-comment'>-- Equality predicates blocked on a coercion hole.</span>
<a name="line-713"></a>              <span class='hs-comment'>-- Each Ct is a CIrredCan with cc_reason = HoleBlockerReason</span>
<a name="line-714"></a>              <span class='hs-comment'>-- See Note [Equalities with incompatible kinds] in GHC.Tc.Solver.Canonical</span>
<a name="line-715"></a>              <span class='hs-comment'>-- wrinkle (2)</span>
<a name="line-716"></a>              <span class='hs-comment'>-- These are stored separately from inert_irreds because</span>
<a name="line-717"></a>              <span class='hs-comment'>-- they get kicked out for different reasons</span>
<a name="line-718"></a>
<a name="line-719"></a>
<a name="line-720"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_given_eq_lvl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span>
<a name="line-721"></a>              <span class='hs-comment'>-- The TcLevel of the innermost implication that has a Given</span>
<a name="line-722"></a>              <span class='hs-comment'>-- equality of the sort that make a unification variable untouchable</span>
<a name="line-723"></a>              <span class='hs-comment'>-- (see Note [Unification preconditions] in GHC.Tc.Utils.Unify).</span>
<a name="line-724"></a>              <span class='hs-comment'>-- See Note [Tracking Given equalities] below</span>
<a name="line-725"></a>
<a name="line-726"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_given_eqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-727"></a>              <span class='hs-comment'>-- True &lt;=&gt; The inert Givens *at this level* (tcl_tclvl)</span>
<a name="line-728"></a>              <span class='hs-comment'>--          could includes at least one equality /other than/ a</span>
<a name="line-729"></a>              <span class='hs-comment'>--          let-bound skolem equality.</span>
<a name="line-730"></a>              <span class='hs-comment'>-- Reason: report these givens when reporting a failed equality</span>
<a name="line-731"></a>              <span class='hs-comment'>-- See Note [Tracking Given equalities]</span>
<a name="line-732"></a>       <span class='hs-layout'>}</span>
<a name="line-733"></a>
<a name="line-734"></a><a name="InertEqs"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>InertEqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DTyVarEnv</span> <span class='hs-conid'>EqualCtList</span>
<a name="line-735"></a>
<a name="line-736"></a><a name="EqualCtList"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonEmpty</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span>
<a name="line-737"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-keyword'>newtype</span> <span class='hs-conid'>Outputable</span>
<a name="line-738"></a>  <span class='hs-comment'>-- See Note [EqualCtList invariants]</span>
<a name="line-739"></a>
<a name="line-740"></a><a name="unitEqualCtList"></a><span class='hs-definition'>unitEqualCtList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqualCtList</span>
<a name="line-741"></a><span class='hs-definition'>unitEqualCtList</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span> <span class='hs-conop'>:|</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-742"></a>
<a name="line-743"></a><a name="addToEqualCtList"></a><span class='hs-definition'>addToEqualCtList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqualCtList</span>
<a name="line-744"></a><span class='hs-comment'>-- NB: This function maintains the "derived-before-wanted" invariant of EqualCtList,</span>
<a name="line-745"></a><span class='hs-comment'>-- but not the others. See Note [EqualCtList invariants]</span>
<a name="line-746"></a><span class='hs-definition'>addToEqualCtList</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqualCtList</span> <span class='hs-varid'>old_eqs</span><span class='hs-layout'>)</span>
<a name="line-747"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isWantedCt</span> <span class='hs-varid'>ct</span>
<a name="line-748"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>eq1</span> <span class='hs-conop'>:|</span> <span class='hs-varid'>eqs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>old_eqs</span>
<a name="line-749"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-layout'>(</span><span class='hs-varid'>eq1</span> <span class='hs-conop'>:|</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>)</span>
<a name="line-750"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-751"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span> <span class='hs-varop'>`cons`</span> <span class='hs-varid'>old_eqs</span><span class='hs-layout'>)</span>
<a name="line-752"></a>
<a name="line-753"></a><a name="filterEqualCtList"></a><span class='hs-definition'>filterEqualCtList</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>EqualCtList</span>
<a name="line-754"></a><span class='hs-definition'>filterEqualCtList</span> <span class='hs-varid'>pred</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqualCtList</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span>
<a name="line-755"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonEmpty</span> <span class='hs-varop'>$</span> <span class='hs-conid'>NE.filter</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span>
<a name="line-756"></a>
<a name="line-757"></a><a name="equalCtListToList"></a><span class='hs-definition'>equalCtListToList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-758"></a><span class='hs-definition'>equalCtListToList</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqualCtList</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toList</span> <span class='hs-varid'>cts</span>
<a name="line-759"></a>
<a name="line-760"></a><a name="listToEqualCtList"></a><span class='hs-definition'>listToEqualCtList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>EqualCtList</span>
<a name="line-761"></a><span class='hs-comment'>-- NB: This does not maintain invariants other than having the EqualCtList be</span>
<a name="line-762"></a><span class='hs-comment'>-- non-empty</span>
<a name="line-763"></a><span class='hs-definition'>listToEqualCtList</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>nonEmpty</span> <span class='hs-varid'>cts</span>
<a name="line-764"></a>
<a name="line-765"></a><span class='hs-comment'>{- Note [Tracking Given equalities]
<a name="line-766"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-767"></a>For reasons described in (UNTOUCHABLE) in GHC.Tc.Utils.Unify
<a name="line-768"></a>Note [Unification preconditions], we can't unify
<a name="line-769"></a>   alpha[2] ~ Int
<a name="line-770"></a>under a level-4 implication if there are any Given equalities
<a name="line-771"></a>bound by the implications at level 3 of 4.  To that end, the
<a name="line-772"></a>InertCans tracks
<a name="line-773"></a>
<a name="line-774"></a>  inert_given_eq_lvl :: TcLevel
<a name="line-775"></a>     -- The TcLevel of the innermost implication that has a Given
<a name="line-776"></a>     -- equality of the sort that make a unification variable untouchable
<a name="line-777"></a>     -- (see Note [Unification preconditions] in GHC.Tc.Utils.Unify).
<a name="line-778"></a>
<a name="line-779"></a>We update inert_given_eq_lvl whenever we add a Given to the
<a name="line-780"></a>inert set, in updateGivenEqs.
<a name="line-781"></a>
<a name="line-782"></a>Then a unification variable alpha[n] is untouchable iff
<a name="line-783"></a>    n &lt; inert_given_eq_lvl
<a name="line-784"></a>that is, if the unification variable was born outside an
<a name="line-785"></a>enclosing Given equality.
<a name="line-786"></a>
<a name="line-787"></a>Exactly which constraints should trigger (UNTOUCHABLE), and hence
<a name="line-788"></a>should update inert_given_eq_lvl?
<a name="line-789"></a>
<a name="line-790"></a>* We do /not/ need to worry about let-bound skolems, such ast
<a name="line-791"></a>     forall[2] a. a ~ [b] =&gt; blah
<a name="line-792"></a>  See Note [Let-bound skolems]
<a name="line-793"></a>
<a name="line-794"></a>* Consider an implication
<a name="line-795"></a>      forall[2]. beta[1] =&gt; alpha[1] ~ Int
<a name="line-796"></a>  where beta is a unification variable that has already been unified
<a name="line-797"></a>  to () in an outer scope.  Then alpha[1] is perfectly touchable and
<a name="line-798"></a>  we can unify alpha := Int. So when deciding whether the givens contain
<a name="line-799"></a>  an equality, we should canonicalise first, rather than just looking at
<a name="line-800"></a>  the /original/ givens (#8644).
<a name="line-801"></a>
<a name="line-802"></a> * However, we must take account of *potential* equalities. Consider the
<a name="line-803"></a>   same example again, but this time we have /not/ yet unified beta:
<a name="line-804"></a>      forall[2] beta[1] =&gt; ...blah...
<a name="line-805"></a>
<a name="line-806"></a>   Because beta might turn into an equality, updateGivenEqs conservatively
<a name="line-807"></a>   treats it as a potential equality, and updates inert_give_eq_lvl
<a name="line-808"></a>
<a name="line-809"></a> * What about something like forall[2] a b. a ~ F b =&gt; [W] alpha[1] ~ X y z?
<a name="line-810"></a>
<a name="line-811"></a>   That Given cannot affect the Wanted, because the Given is entirely
<a name="line-812"></a>   *local*: it mentions only skolems bound in the very same
<a name="line-813"></a>   implication. Such equalities need not make alpha untouchable. (Test
<a name="line-814"></a>   case typecheck/should_compile/LocalGivenEqs has a real-life
<a name="line-815"></a>   motivating example, with some detailed commentary.)
<a name="line-816"></a>   Hence the 'mentionsOuterVar' test in updateGivenEqs.
<a name="line-817"></a>
<a name="line-818"></a>   However, solely to support better error messages
<a name="line-819"></a>   (see Note [HasGivenEqs] in GHC.Tc.Types.Constraint) we also track
<a name="line-820"></a>   these "local" equalities in the boolean inert_given_eqs field.
<a name="line-821"></a>   This field is used only to set the ic_given_eqs field to LocalGivenEqs;
<a name="line-822"></a>   see the function getHasGivenEqs.
<a name="line-823"></a>
<a name="line-824"></a>   Here is a simpler case that triggers this behaviour:
<a name="line-825"></a>
<a name="line-826"></a>     data T where
<a name="line-827"></a>       MkT :: F a ~ G b =&gt; a -&gt; b -&gt; T
<a name="line-828"></a>
<a name="line-829"></a>     f (MkT _ _) = True
<a name="line-830"></a>
<a name="line-831"></a>   Because of this behaviour around local equality givens, we can infer the
<a name="line-832"></a>   type of f. This is typecheck/should_compile/LocalGivenEqs2.
<a name="line-833"></a>
<a name="line-834"></a> * We need not look at the equality relation involved (nominal vs
<a name="line-835"></a>   representational), because representational equalities can still
<a name="line-836"></a>   imply nominal ones. For example, if (G a ~R G b) and G's argument's
<a name="line-837"></a>   role is nominal, then we can deduce a ~N b.
<a name="line-838"></a>
<a name="line-839"></a>Note [Let-bound skolems]
<a name="line-840"></a>~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-841"></a>If   * the inert set contains a canonical Given CEqCan (a ~ ty)
<a name="line-842"></a>and  * 'a' is a skolem bound in this very implication,
<a name="line-843"></a>
<a name="line-844"></a>then:
<a name="line-845"></a>a) The Given is pretty much a let-binding, like
<a name="line-846"></a>      f :: (a ~ b-&gt;c) =&gt; a -&gt; a
<a name="line-847"></a>   Here the equality constraint is like saying
<a name="line-848"></a>      let a = b-&gt;c in ...
<a name="line-849"></a>   It is not adding any new, local equality  information,
<a name="line-850"></a>   and hence can be ignored by has_given_eqs
<a name="line-851"></a>
<a name="line-852"></a>b) 'a' will have been completely substituted out in the inert set,
<a name="line-853"></a>   so we can safely discard it.
<a name="line-854"></a>
<a name="line-855"></a>For an example, see #9211.
<a name="line-856"></a>
<a name="line-857"></a>See also GHC.Tc.Utils.Unify Note [Deeper level on the left] for how we ensure
<a name="line-858"></a>that the right variable is on the left of the equality when both are
<a name="line-859"></a>tyvars.
<a name="line-860"></a>
<a name="line-861"></a>You might wonder whether the skolem really needs to be bound "in the
<a name="line-862"></a>very same implication" as the equuality constraint.
<a name="line-863"></a>Consider this (c.f. #15009):
<a name="line-864"></a>
<a name="line-865"></a>  data S a where
<a name="line-866"></a>    MkS :: (a ~ Int) =&gt; S a
<a name="line-867"></a>
<a name="line-868"></a>  g :: forall a. S a -&gt; a -&gt; blah
<a name="line-869"></a>  g x y = let h = \z. ( z :: Int
<a name="line-870"></a>                      , case x of
<a name="line-871"></a>                           MkS -&gt; [y,z])
<a name="line-872"></a>          in ...
<a name="line-873"></a>
<a name="line-874"></a>From the type signature for `g`, we get `y::a` .  Then when we
<a name="line-875"></a>encounter the `\z`, we'll assign `z :: alpha[1]`, say.  Next, from the
<a name="line-876"></a>body of the lambda we'll get
<a name="line-877"></a>
<a name="line-878"></a>  [W] alpha[1] ~ Int                             -- From z::Int
<a name="line-879"></a>  [W] forall[2]. (a ~ Int) =&gt; [W] alpha[1] ~ a   -- From [y,z]
<a name="line-880"></a>
<a name="line-881"></a>Now, unify alpha := a.  Now we are stuck with an unsolved alpha~Int!
<a name="line-882"></a>So we must treat alpha as untouchable under the forall[2] implication.
<a name="line-883"></a>
<a name="line-884"></a>Note [Detailed InertCans Invariants]
<a name="line-885"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-886"></a>The InertCans represents a collection of constraints with the following properties:
<a name="line-887"></a>
<a name="line-888"></a>  * All canonical
<a name="line-889"></a>
<a name="line-890"></a>  * No two dictionaries with the same head
<a name="line-891"></a>  * No two CIrreds with the same type
<a name="line-892"></a>
<a name="line-893"></a>  * Family equations inert wrt top-level family axioms
<a name="line-894"></a>
<a name="line-895"></a>  * Dictionaries have no matching top-level instance
<a name="line-896"></a>
<a name="line-897"></a>  * Given family or dictionary constraints don't mention touchable
<a name="line-898"></a>    unification variables
<a name="line-899"></a>
<a name="line-900"></a>  * Non-CEqCan constraints are fully rewritten with respect
<a name="line-901"></a>    to the CEqCan equalities (modulo eqCanRewrite of course;
<a name="line-902"></a>    eg a wanted cannot rewrite a given)
<a name="line-903"></a>
<a name="line-904"></a>  * CEqCan equalities: see Note [inert_eqs: the inert equalities]
<a name="line-905"></a>    Also see documentation in Constraint.Ct for a list of invariants
<a name="line-906"></a>
<a name="line-907"></a>Note [EqualCtList invariants]
<a name="line-908"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-909"></a>    * All are equalities
<a name="line-910"></a>    * All these equalities have the same LHS
<a name="line-911"></a>    * The list is never empty
<a name="line-912"></a>    * No element of the list can rewrite any other
<a name="line-913"></a>    * Derived before Wanted
<a name="line-914"></a>
<a name="line-915"></a>From the fourth invariant it follows that the list is
<a name="line-916"></a>   - A single [G], or
<a name="line-917"></a>   - Zero or one [D] or [WD], followed by any number of [W]
<a name="line-918"></a>
<a name="line-919"></a>The Wanteds can't rewrite anything which is why we put them last
<a name="line-920"></a>
<a name="line-921"></a>Note [inert_eqs: the inert equalities]
<a name="line-922"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-923"></a>Definition [Can-rewrite relation]
<a name="line-924"></a>A "can-rewrite" relation between flavours, written f1 &gt;= f2, is a
<a name="line-925"></a>binary relation with the following properties
<a name="line-926"></a>
<a name="line-927"></a>  (R1) &gt;= is transitive
<a name="line-928"></a>  (R2) If f1 &gt;= f, and f2 &gt;= f,
<a name="line-929"></a>       then either f1 &gt;= f2 or f2 &gt;= f1
<a name="line-930"></a>  (See Note [Why R2?].)
<a name="line-931"></a>
<a name="line-932"></a>Lemma (L0). If f1 &gt;= f then f1 &gt;= f1
<a name="line-933"></a>Proof.      By property (R2), with f1=f2
<a name="line-934"></a>
<a name="line-935"></a>Definition [Generalised substitution]
<a name="line-936"></a>A "generalised substitution" S is a set of triples (lhs -f-&gt; t), where
<a name="line-937"></a>  lhs is a type variable or an exactly-saturated type family application
<a name="line-938"></a>    (that is, lhs is a CanEqLHS)
<a name="line-939"></a>  t is a type
<a name="line-940"></a>  f is a flavour
<a name="line-941"></a>such that
<a name="line-942"></a>  (WF1) if (lhs1 -f1-&gt; t1) in S
<a name="line-943"></a>           (lhs2 -f2-&gt; t2) in S
<a name="line-944"></a>        then (f1 &gt;= f2) implies that lhs1 does not appear within lhs2
<a name="line-945"></a>  (WF2) if (lhs -f-&gt; t) is in S, then t /= lhs
<a name="line-946"></a>
<a name="line-947"></a>Definition [Applying a generalised substitution]
<a name="line-948"></a>If S is a generalised substitution
<a name="line-949"></a>   S(f,t0) = t,  if (t0 -fs-&gt; t) in S, and fs &gt;= f
<a name="line-950"></a>           = apply S to components of t0, otherwise
<a name="line-951"></a>See also Note [Flavours with roles].
<a name="line-952"></a>
<a name="line-953"></a>Theorem: S(f,t0) is well defined as a function.
<a name="line-954"></a>Proof: Suppose (lhs -f1-&gt; t1) and (lhs -f2-&gt; t2) are both in S,
<a name="line-955"></a>               and  f1 &gt;= f and f2 &gt;= f
<a name="line-956"></a>       Then by (R2) f1 &gt;= f2 or f2 &gt;= f1, which contradicts (WF1)
<a name="line-957"></a>
<a name="line-958"></a>Notation: repeated application.
<a name="line-959"></a>  S^0(f,t)     = t
<a name="line-960"></a>  S^(n+1)(f,t) = S(f, S^n(t))
<a name="line-961"></a>
<a name="line-962"></a>Definition: terminating generalised substitution
<a name="line-963"></a>A generalised substitution S is *terminating* iff
<a name="line-964"></a>
<a name="line-965"></a>  (IG1) there is an n such that
<a name="line-966"></a>        for every f,t, S^n(f,t) = S^(n+1)(f,t)
<a name="line-967"></a>
<a name="line-968"></a>By (IG1) we define S*(f,t) to be the result of exahaustively
<a name="line-969"></a>applying S(f,_) to t.
<a name="line-970"></a>
<a name="line-971"></a>-----------------------------------------------------------------------------
<a name="line-972"></a>Our main invariant:
<a name="line-973"></a>   the CEqCans in inert_eqs should be a terminating generalised substitution
<a name="line-974"></a>-----------------------------------------------------------------------------
<a name="line-975"></a>
<a name="line-976"></a>Note that termination is not the same as idempotence.  To apply S to a
<a name="line-977"></a>type, you may have to apply it recursively.  But termination does
<a name="line-978"></a>guarantee that this recursive use will terminate.
<a name="line-979"></a>
<a name="line-980"></a>Note [Why R2?]
<a name="line-981"></a>~~~~~~~~~~~~~~
<a name="line-982"></a>R2 states that, if we have f1 &gt;= f and f2 &gt;= f, then either f1 &gt;= f2 or f2 &gt;=
<a name="line-983"></a>f1. If we do not have R2, we will easily fall into a loop.
<a name="line-984"></a>
<a name="line-985"></a>To see why, imagine we have f1 &gt;= f, f2 &gt;= f, and that's it. Then, let our
<a name="line-986"></a>inert set S = {a -f1-&gt; b, b -f2-&gt; a}. Computing S(f,a) does not terminate. And
<a name="line-987"></a>yet, we have a hard time noticing an occurs-check problem when building S, as
<a name="line-988"></a>the two equalities cannot rewrite one another.
<a name="line-989"></a>
<a name="line-990"></a>R2 actually restricts our ability to accept user-written programs. See Note
<a name="line-991"></a>[Deriveds do rewrite Deriveds] in GHC.Tc.Types.Constraint for an example.
<a name="line-992"></a>
<a name="line-993"></a>Note [Rewritable]
<a name="line-994"></a>~~~~~~~~~~~~~~~~~
<a name="line-995"></a>This Note defines what it means for a type variable or type family application
<a name="line-996"></a>(that is, a CanEqLHS) to be rewritable in a type. This definition is used
<a name="line-997"></a>by the anyRewritableXXX family of functions and is meant to model the actual
<a name="line-998"></a>behaviour in GHC.Tc.Solver.Rewrite.
<a name="line-999"></a>
<a name="line-1000"></a>Ignoring roles (for now): A CanEqLHS lhs is *rewritable* in a type t if the
<a name="line-1001"></a>lhs tree appears as a subtree within t without traversing any of the following
<a name="line-1002"></a>components of t:
<a name="line-1003"></a>  * coercions (whether they appear in casts CastTy or as arguments CoercionTy)
<a name="line-1004"></a>  * kinds of variable occurrences
<a name="line-1005"></a>The check for rewritability *does* look in kinds of the bound variable of a
<a name="line-1006"></a>ForAllTy.
<a name="line-1007"></a>
<a name="line-1008"></a>Goal: If lhs is not rewritable in t, then t is a fixpoint of the generalised
<a name="line-1009"></a>substitution containing only {lhs -f*-&gt; t'}, where f* is a flavour such that f* &gt;= f
<a name="line-1010"></a>for all f.
<a name="line-1011"></a>
<a name="line-1012"></a>The reason for this definition is that the rewriter does not rewrite in coercions
<a name="line-1013"></a>or variables' kinds. In turn, the rewriter does not need to rewrite there because
<a name="line-1014"></a>those places are never used for controlling the behaviour of the solver: these
<a name="line-1015"></a>places are not used in matching instances or in decomposing equalities.
<a name="line-1016"></a>
<a name="line-1017"></a>There is one exception to the claim that non-rewritable parts of the tree do
<a name="line-1018"></a>not affect the solver: we sometimes do an occurs-check to decide e.g. how to
<a name="line-1019"></a>orient an equality. (See the comments on
<a name="line-1020"></a>GHC.Tc.Solver.Canonical.canEqTyVarFunEq.) Accordingly, the presence of a
<a name="line-1021"></a>variable in a kind or coercion just might influence the solver. Here is an
<a name="line-1022"></a>example:
<a name="line-1023"></a>
<a name="line-1024"></a>  type family Const x y where
<a name="line-1025"></a>    Const x y = x
<a name="line-1026"></a>
<a name="line-1027"></a>  AxConst :: forall x y. Const x y ~# x
<a name="line-1028"></a>
<a name="line-1029"></a>  alpha :: Const Type Nat
<a name="line-1030"></a>  [W] alpha ~ Int |&gt; (sym (AxConst Type alpha) ;;
<a name="line-1031"></a>                      AxConst Type alpha ;;
<a name="line-1032"></a>                      sym (AxConst Type Nat))
<a name="line-1033"></a>
<a name="line-1034"></a>The cast is clearly ludicrous (it ties together a cast and its symmetric version),
<a name="line-1035"></a>but we can't quite rule it out. (See (EQ1) from
<a name="line-1036"></a>Note [Respecting definitional equality] in GHC.Core.TyCo.Rep to see why we need
<a name="line-1037"></a>the Const Type Nat bit.) And yet this cast will (quite rightly) prevent alpha
<a name="line-1038"></a>from unifying with the RHS. I (Richard E) don't have an example of where this
<a name="line-1039"></a>problem can arise from a Haskell program, but we don't have an air-tight argument
<a name="line-1040"></a>for why the definition of *rewritable* given here is correct.
<a name="line-1041"></a>
<a name="line-1042"></a>Taking roles into account: we must consider a rewrite at a given role. That is,
<a name="line-1043"></a>a rewrite arises from some equality, and that equality has a role associated
<a name="line-1044"></a>with it. As we traverse a type, we track what role we are allowed to rewrite with.
<a name="line-1045"></a>
<a name="line-1046"></a>For example, suppose we have an inert [G] b ~R# Int. Then b is rewritable in
<a name="line-1047"></a>Maybe b but not in F b, where F is a type function. This role-aware logic is
<a name="line-1048"></a>present in both the anyRewritableXXX functions and in the rewriter.
<a name="line-1049"></a>See also Note [anyRewritableTyVar must be role-aware] in GHC.Tc.Utils.TcType.
<a name="line-1050"></a>
<a name="line-1051"></a>Note [Extending the inert equalities]
<a name="line-1052"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1053"></a>Main Theorem [Stability under extension]
<a name="line-1054"></a>   Suppose we have a "work item"
<a name="line-1055"></a>       lhs -fw-&gt; t
<a name="line-1056"></a>   and a terminating generalised substitution S,
<a name="line-1057"></a>   THEN the extended substitution T = S+(lhs -fw-&gt; t)
<a name="line-1058"></a>        is a terminating generalised substitution
<a name="line-1059"></a>   PROVIDED
<a name="line-1060"></a>      (T1) S(fw,lhs) = lhs   -- LHS of work-item is a fixpoint of S(fw,_)
<a name="line-1061"></a>      (T2) S(fw,t)   = t     -- RHS of work-item is a fixpoint of S(fw,_)
<a name="line-1062"></a>      (T3) lhs not in t      -- No occurs check in the work item
<a name="line-1063"></a>          -- If lhs is a type family application, we require only that
<a name="line-1064"></a>          -- lhs is not *rewritable* in t. See Note [Rewritable] and
<a name="line-1065"></a>          -- Note [CEqCan occurs check] in GHC.Tc.Types.Constraint.
<a name="line-1066"></a>
<a name="line-1067"></a>      AND, for every (lhs1 -fs-&gt; s) in S:
<a name="line-1068"></a>           (K0) not (fw &gt;= fs)
<a name="line-1069"></a>                Reason: suppose we kick out (lhs1 -fs-&gt; s),
<a name="line-1070"></a>                        and add (lhs -fw-&gt; t) to the inert set.
<a name="line-1071"></a>                        The latter can't rewrite the former,
<a name="line-1072"></a>                        so the kick-out achieved nothing
<a name="line-1073"></a>
<a name="line-1074"></a>              -- From here, we can assume fw &gt;= fs
<a name="line-1075"></a>           OR (K4) lhs1 is a tyvar AND fs &gt;= fw
<a name="line-1076"></a>
<a name="line-1077"></a>           OR { (K1) lhs is not rewritable in lhs1. See Note [Rewritable].
<a name="line-1078"></a>                     Reason: if fw &gt;= fs, WF1 says we can't have both
<a name="line-1079"></a>                             lhs0 -fw-&gt; t  and  F lhs0 -fs-&gt; s
<a name="line-1080"></a>
<a name="line-1081"></a>                AND (K2): guarantees termination of the new substitution
<a name="line-1082"></a>                    {  (K2a) not (fs &gt;= fs)
<a name="line-1083"></a>                    OR (K2b) lhs not in s }
<a name="line-1084"></a>
<a name="line-1085"></a>                AND (K3) See Note [K3: completeness of solving]
<a name="line-1086"></a>                    { (K3a) If the role of fs is nominal: s /= lhs
<a name="line-1087"></a>                      (K3b) If the role of fs is representational:
<a name="line-1088"></a>                            s is not of form (lhs t1 .. tn) } }
<a name="line-1089"></a>
<a name="line-1090"></a>
<a name="line-1091"></a>Conditions (T1-T3) are established by the canonicaliser
<a name="line-1092"></a>Conditions (K1-K3) are established by GHC.Tc.Solver.Monad.kickOutRewritable
<a name="line-1093"></a>
<a name="line-1094"></a>The idea is that
<a name="line-1095"></a>* T1 and T2 are guaranteed by exhaustively rewriting the work-item
<a name="line-1096"></a>  with S(fw,_).
<a name="line-1097"></a>
<a name="line-1098"></a>* T3 is guaranteed by an occurs-check on the work item.
<a name="line-1099"></a>  This is done during canonicalisation, in checkTypeEq; invariant
<a name="line-1100"></a>  (TyEq:OC) of CEqCan. See also Note [CEqCan occurs check] in GHC.Tc.Types.Constraint.
<a name="line-1101"></a>
<a name="line-1102"></a>* (K1-3) are the "kick-out" criteria.  (As stated, they are really the
<a name="line-1103"></a>  "keep" criteria.) If the current inert S contains a triple that does
<a name="line-1104"></a>  not satisfy (K1-3), then we remove it from S by "kicking it out",
<a name="line-1105"></a>  and re-processing it.
<a name="line-1106"></a>
<a name="line-1107"></a>* Note that kicking out is a Bad Thing, because it means we have to
<a name="line-1108"></a>  re-process a constraint.  The less we kick out, the better.
<a name="line-1109"></a>  TODO: Make sure that kicking out really *is* a Bad Thing. We've assumed
<a name="line-1110"></a>  this but haven't done the empirical study to check.
<a name="line-1111"></a>
<a name="line-1112"></a>* Assume we have  G&gt;=G, G&gt;=W and that's all.  Then, when performing
<a name="line-1113"></a>  a unification we add a new given  a -G-&gt; ty.  But doing so does NOT require
<a name="line-1114"></a>  us to kick out an inert wanted that mentions a, because of (K2a).  This
<a name="line-1115"></a>  is a common case, hence good not to kick out. See also (K2a) below.
<a name="line-1116"></a>
<a name="line-1117"></a>* Lemma (L2): if not (fw &gt;= fw), then K0 holds and we kick out nothing
<a name="line-1118"></a>  Proof: using Definition [Can-rewrite relation], fw can't rewrite anything
<a name="line-1119"></a>         and so K0 holds.  Intuitively, since fw can't rewrite anything (Lemma (L0)),
<a name="line-1120"></a>         adding it cannot cause any loops
<a name="line-1121"></a>  This is a common case, because Wanteds cannot rewrite Wanteds.
<a name="line-1122"></a>  It's used to avoid even looking for constraint to kick out.
<a name="line-1123"></a>
<a name="line-1124"></a>* Lemma (L1): The conditions of the Main Theorem imply that there is no
<a name="line-1125"></a>              (lhs -fs-&gt; t) in S, s.t.  (fs &gt;= fw).
<a name="line-1126"></a>  Proof. Suppose the contrary (fs &gt;= fw).  Then because of (T1),
<a name="line-1127"></a>  S(fw,lhs)=lhs.  But since fs&gt;=fw, S(fw,lhs) = t, hence t=lhs.  But now we
<a name="line-1128"></a>  have (lhs -fs-&gt; lhs) in S, which contradicts (WF2).
<a name="line-1129"></a>
<a name="line-1130"></a>* The extended substitution satisfies (WF1) and (WF2)
<a name="line-1131"></a>  - (K1) plus (L1) guarantee that the extended substitution satisfies (WF1).
<a name="line-1132"></a>  - (T3) guarantees (WF2).
<a name="line-1133"></a>
<a name="line-1134"></a>* (K2) and (K4) are about termination.  Intuitively, any infinite chain S^0(f,t),
<a name="line-1135"></a>  S^1(f,t), S^2(f,t).... must pass through the new work item infinitely
<a name="line-1136"></a>  often, since the substitution without the work item is terminating; and must
<a name="line-1137"></a>  pass through at least one of the triples in S infinitely often.
<a name="line-1138"></a>
<a name="line-1139"></a>  - (K2a): if not(fs&gt;=fs) then there is no f that fs can rewrite (fs&gt;=f)
<a name="line-1140"></a>    (this is Lemma (L0)), and hence this triple never plays a role in application S(f,t).
<a name="line-1141"></a>    It is always safe to extend S with such a triple.
<a name="line-1142"></a>
<a name="line-1143"></a>    (NB: we could strengten K1) in this way too, but see K3.
<a name="line-1144"></a>
<a name="line-1145"></a>  - (K2b): if lhs not in s, we have no further opportunity to apply the
<a name="line-1146"></a>    work item
<a name="line-1147"></a>
<a name="line-1148"></a>  - (K4): See Note [K4]
<a name="line-1149"></a>
<a name="line-1150"></a>* Lemma (L3). Suppose we have f* such that, for all f, f* &gt;= f. Then
<a name="line-1151"></a>  if we are adding lhs -fw-&gt; t (where T1, T2, and T3 hold), we will keep a -f*-&gt; s.
<a name="line-1152"></a>  Proof. K4 holds; thus, we keep.
<a name="line-1153"></a>
<a name="line-1154"></a>Key lemma to make it watertight.
<a name="line-1155"></a>  Under the conditions of the Main Theorem,
<a name="line-1156"></a>  forall f st fw &gt;= f, a is not in S^k(f,t), for any k
<a name="line-1157"></a>
<a name="line-1158"></a>Also, consider roles more carefully. See Note [Flavours with roles]
<a name="line-1159"></a>
<a name="line-1160"></a>Note [K4]
<a name="line-1161"></a>~~~~~~~~~
<a name="line-1162"></a>K4 is a "keep" condition of Note [Extending the inert equalities].
<a name="line-1163"></a>Here is the scenario:
<a name="line-1164"></a>
<a name="line-1165"></a>* We are considering adding (lhs -fw-&gt; t) to the inert set S.
<a name="line-1166"></a>* S already has (lhs1 -fs-&gt; s).
<a name="line-1167"></a>* We know S(fw, lhs) = lhs, S(fw, t) = t, and lhs is not rewritable in t.
<a name="line-1168"></a>  See Note [Rewritable]. These are (T1), (T2), and (T3).
<a name="line-1169"></a>* We further know fw &gt;= fs. (If not, then we short-circuit via (K0).)
<a name="line-1170"></a>
<a name="line-1171"></a>K4 says that we may keep lhs1 -fs-&gt; s in S if:
<a name="line-1172"></a>  lhs1 is a tyvar AND fs &gt;= fw
<a name="line-1173"></a>
<a name="line-1174"></a>Why K4 guarantees termination:
<a name="line-1175"></a>  * If fs &gt;= fw, we know a is not rewritable in t, because of (T2).
<a name="line-1176"></a>  * We further know lhs /= a, because of (T1).
<a name="line-1177"></a>  * Accordingly, a use of the new inert item lhs -fw-&gt; t cannot create the conditions
<a name="line-1178"></a>    for a use of a -fs-&gt; s (precisely because t does not mention a), and hence,
<a name="line-1179"></a>    the extended substitution (with lhs -fw-&gt; t in it) is a terminating
<a name="line-1180"></a>    generalised substitution.
<a name="line-1181"></a>
<a name="line-1182"></a>Recall that the termination generalised substitution includes only mappings that
<a name="line-1183"></a>pass an occurs check. This is (T3). At one point, we worried that the
<a name="line-1184"></a>argument here would fail if s mentioned a, but (T3) rules out this possibility.
<a name="line-1185"></a>Put another way: the terminating generalised substitution considers only the inert_eqs,
<a name="line-1186"></a>not other parts of the inert set (such as the irreds).
<a name="line-1187"></a>
<a name="line-1188"></a>Can we liberalise K4? No.
<a name="line-1189"></a>
<a name="line-1190"></a>Why we cannot drop the (fs &gt;= fw) condition:
<a name="line-1191"></a>  * Suppose not (fs &gt;= fw). It might be the case that t mentions a, and this
<a name="line-1192"></a>    can cause a loop. Example:
<a name="line-1193"></a>
<a name="line-1194"></a>      Work:  [G] b ~ a
<a name="line-1195"></a>      Inert: [D] a ~ b
<a name="line-1196"></a>
<a name="line-1197"></a>    (where G &gt;= G, G &gt;= D, and D &gt;= D)
<a name="line-1198"></a>    If we don't kick out the inert, then we get a loop on e.g. [D] a ~ Int.
<a name="line-1199"></a>
<a name="line-1200"></a>  * Note that the above example is different if the inert is a Given G, because
<a name="line-1201"></a>    (T1) won't hold.
<a name="line-1202"></a>
<a name="line-1203"></a>Why we cannot drop the tyvar condition:
<a name="line-1204"></a>  * Presume fs &gt;= fw. Thus, F tys is not rewritable in t, because of (T2).
<a name="line-1205"></a>  * Can the use of lhs -fw-&gt; t create the conditions for a use of F tys -fs-&gt; s?
<a name="line-1206"></a>    Yes! This can happen if t appears within tys.
<a name="line-1207"></a>
<a name="line-1208"></a>    Here is an example:
<a name="line-1209"></a>
<a name="line-1210"></a>      Work:  [G] a ~ Int
<a name="line-1211"></a>      Inert: [G] F Int ~ F a
<a name="line-1212"></a>
<a name="line-1213"></a>    Now, if we have [W] F a ~ Bool, we will rewrite ad infinitum on the left-hand
<a name="line-1214"></a>    side. The key reason why K2b works in the tyvar case is that tyvars are atomic:
<a name="line-1215"></a>    if the right-hand side of an equality does not mention a variable a, then it
<a name="line-1216"></a>    cannot allow an equality with an LHS of a to fire. This is not the case for
<a name="line-1217"></a>    type family applications.
<a name="line-1218"></a>
<a name="line-1219"></a>Bottom line: K4 can keep only inerts with tyvars on the left. Put differently,
<a name="line-1220"></a>K4 will never prevent an inert with a type family on the left from being kicked
<a name="line-1221"></a>out.
<a name="line-1222"></a>
<a name="line-1223"></a>Consequence: We never kick out a Given/Nominal equality with a tyvar on the left.
<a name="line-1224"></a>This is Lemma (L3) of Note [Extending the inert equalities]. It is good because
<a name="line-1225"></a>it means we can effectively model the mutable filling of metavariables with
<a name="line-1226"></a>Given/Nominal equalities. That is: it should be the case that we could rewrite
<a name="line-1227"></a>our solver never to fill in a metavariable; instead, it would "solve" a wanted
<a name="line-1228"></a>like alpha ~ Int by turning it into a Given, allowing it to be used in rewriting.
<a name="line-1229"></a>We would want the solver to behave the same whether it uses metavariables or
<a name="line-1230"></a>Givens. And (L3) says that no Given/Nominals over tyvars are ever kicked out,
<a name="line-1231"></a>just like we never unfill a metavariable. Nice.
<a name="line-1232"></a>
<a name="line-1233"></a>Getting this wrong (that is, allowing K4 to apply to situations with the type
<a name="line-1234"></a>family on the left) led to #19042. (At that point, K4 was known as K2b.)
<a name="line-1235"></a>
<a name="line-1236"></a>Originally, this condition was part of K2, but #17672 suggests it should be
<a name="line-1237"></a>a top-level K condition.
<a name="line-1238"></a>
<a name="line-1239"></a>Note [K3: completeness of solving]
<a name="line-1240"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1241"></a>(K3) is not necessary for the extended substitution
<a name="line-1242"></a>to be terminating.  In fact K1 could be made stronger by saying
<a name="line-1243"></a>   ... then (not (fw &gt;= fs) or not (fs &gt;= fs))
<a name="line-1244"></a>But it's not enough for S to be terminating; we also want completeness.
<a name="line-1245"></a>That is, we want to be able to solve all soluble wanted equalities.
<a name="line-1246"></a>Suppose we have
<a name="line-1247"></a>
<a name="line-1248"></a>   work-item   b -G-&gt; a
<a name="line-1249"></a>   inert-item  a -W-&gt; b
<a name="line-1250"></a>
<a name="line-1251"></a>Assuming (G &gt;= W) but not (W &gt;= W), this fulfills all the conditions,
<a name="line-1252"></a>so we could extend the inerts, thus:
<a name="line-1253"></a>
<a name="line-1254"></a>   inert-items   b -G-&gt; a
<a name="line-1255"></a>                 a -W-&gt; b
<a name="line-1256"></a>
<a name="line-1257"></a>But if we kicked-out the inert item, we'd get
<a name="line-1258"></a>
<a name="line-1259"></a>   work-item     a -W-&gt; b
<a name="line-1260"></a>   inert-item    b -G-&gt; a
<a name="line-1261"></a>
<a name="line-1262"></a>Then rewrite the work-item gives us (a -W-&gt; a), which is soluble via Refl.
<a name="line-1263"></a>So we add one more clause to the kick-out criteria
<a name="line-1264"></a>
<a name="line-1265"></a>Another way to understand (K3) is that we treat an inert item
<a name="line-1266"></a>        a -f-&gt; b
<a name="line-1267"></a>in the same way as
<a name="line-1268"></a>        b -f-&gt; a
<a name="line-1269"></a>So if we kick out one, we should kick out the other.  The orientation
<a name="line-1270"></a>is somewhat accidental.
<a name="line-1271"></a>
<a name="line-1272"></a>When considering roles, we also need the second clause (K3b). Consider
<a name="line-1273"></a>
<a name="line-1274"></a>  work-item    c -G/N-&gt; a
<a name="line-1275"></a>  inert-item   a -W/R-&gt; b c
<a name="line-1276"></a>
<a name="line-1277"></a>The work-item doesn't get rewritten by the inert, because (&gt;=) doesn't hold.
<a name="line-1278"></a>But we don't kick out the inert item because not (W/R &gt;= W/R).  So we just
<a name="line-1279"></a>add the work item. But then, consider if we hit the following:
<a name="line-1280"></a>
<a name="line-1281"></a>  work-item    b -G/N-&gt; Id
<a name="line-1282"></a>  inert-items  a -W/R-&gt; b c
<a name="line-1283"></a>               c -G/N-&gt; a
<a name="line-1284"></a>where
<a name="line-1285"></a>  newtype Id x = Id x
<a name="line-1286"></a>
<a name="line-1287"></a>For similar reasons, if we only had (K3a), we wouldn't kick the
<a name="line-1288"></a>representational inert out. And then, we'd miss solving the inert, which
<a name="line-1289"></a>now reduced to reflexivity.
<a name="line-1290"></a>
<a name="line-1291"></a>The solution here is to kick out representational inerts whenever the
<a name="line-1292"></a>lhs of a work item is "exposed", where exposed means being at the
<a name="line-1293"></a>head of the top-level application chain (lhs t1 .. tn).  See
<a name="line-1294"></a>is_can_eq_lhs_head. This is encoded in (K3b).
<a name="line-1295"></a>
<a name="line-1296"></a>Beware: if we make this test succeed too often, we kick out too much,
<a name="line-1297"></a>and the solver might loop.  Consider (#14363)
<a name="line-1298"></a>  work item:   [G] a ~R f b
<a name="line-1299"></a>  inert item:  [G] b ~R f a
<a name="line-1300"></a>In GHC 8.2 the completeness tests more aggressive, and kicked out
<a name="line-1301"></a>the inert item; but no rewriting happened and there was an infinite
<a name="line-1302"></a>loop.  All we need is to have the tyvar at the head.
<a name="line-1303"></a>
<a name="line-1304"></a>Note [Flavours with roles]
<a name="line-1305"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1306"></a>The system described in Note [inert_eqs: the inert equalities]
<a name="line-1307"></a>discusses an abstract
<a name="line-1308"></a>set of flavours. In GHC, flavours have two components: the flavour proper,
<a name="line-1309"></a>taken from {Wanted, Derived, Given} and the equality relation (often called
<a name="line-1310"></a>role), taken from {NomEq, ReprEq}.
<a name="line-1311"></a>When substituting w.r.t. the inert set,
<a name="line-1312"></a>as described in Note [inert_eqs: the inert equalities],
<a name="line-1313"></a>we must be careful to respect all components of a flavour.
<a name="line-1314"></a>For example, if we have
<a name="line-1315"></a>
<a name="line-1316"></a>  inert set: a -G/R-&gt; Int
<a name="line-1317"></a>             b -G/R-&gt; Bool
<a name="line-1318"></a>
<a name="line-1319"></a>  type role T nominal representational
<a name="line-1320"></a>
<a name="line-1321"></a>and we wish to compute S(W/R, T a b), the correct answer is T a Bool, NOT
<a name="line-1322"></a>T Int Bool. The reason is that T's first parameter has a nominal role, and
<a name="line-1323"></a>thus rewriting a to Int in T a b is wrong. Indeed, this non-congruence of
<a name="line-1324"></a>substitution means that the proof in Note [The inert equalities] may need
<a name="line-1325"></a>to be revisited, but we don't think that the end conclusion is wrong.
<a name="line-1326"></a>-}</span>
<a name="line-1327"></a>
<a name="line-1328"></a><a name="instance%20Outputable%20InertCans"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyword'>where</span>
<a name="line-1329"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span>
<a name="line-1330"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqs</span>
<a name="line-1331"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dicts</span>
<a name="line-1332"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>safehask</span>
<a name="line-1333"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>irreds</span>
<a name="line-1334"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>inert_blocked</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>blocked</span>
<a name="line-1335"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>inert_given_eq_lvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ge_lvl</span>
<a name="line-1336"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>inert_given_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given_eqs</span>
<a name="line-1337"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1338"></a>
<a name="line-1339"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>braces</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span>
<a name="line-1340"></a>      <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyDVarEnv</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1341"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Equalities:"</span>
<a name="line-1342"></a>          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldDVarEnv</span> <span class='hs-varid'>folder</span> <span class='hs-varid'>emptyCts</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>)</span>
<a name="line-1343"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyTcAppMap</span> <span class='hs-varid'>funeqs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1344"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Type-function equalities ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldFunEqs</span> <span class='hs-varid'>folder</span> <span class='hs-varid'>funeqs</span> <span class='hs-varid'>emptyCts</span><span class='hs-layout'>)</span>
<a name="line-1345"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyTcAppMap</span> <span class='hs-varid'>dicts</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1346"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Dictionaries ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>dictsToBag</span> <span class='hs-varid'>dicts</span><span class='hs-layout'>)</span>
<a name="line-1347"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyTcAppMap</span> <span class='hs-varid'>safehask</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1348"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Safe Haskell unsafe overlap ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>dictsToBag</span> <span class='hs-varid'>safehask</span><span class='hs-layout'>)</span>
<a name="line-1349"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyCts</span> <span class='hs-varid'>irreds</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1350"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Irreds ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCts</span> <span class='hs-varid'>irreds</span>
<a name="line-1351"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyCts</span> <span class='hs-varid'>blocked</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1352"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Blocked ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCts</span> <span class='hs-varid'>blocked</span>
<a name="line-1353"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>insts</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1354"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Given instances ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>insts</span><span class='hs-layout'>)</span>
<a name="line-1355"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Innermost given equalities ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ge_lvl</span>
<a name="line-1356"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Given eqs at this level ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>given_eqs</span>
<a name="line-1357"></a>      <span class='hs-keyglyph'>]</span>
<a name="line-1358"></a>    <span class='hs-keyword'>where</span>
<a name="line-1359"></a>      <span class='hs-varid'>folder</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqualCtList</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>)</span> <span class='hs-varid'>rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nonEmptyToBag</span> <span class='hs-varid'>eqs</span> <span class='hs-varop'>`andCts`</span> <span class='hs-varid'>rest</span>
<a name="line-1360"></a>
<a name="line-1361"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1362"></a>*                                                                      *
<a name="line-1363"></a>             Shadow constraints and improvement
<a name="line-1364"></a>*                                                                      *
<a name="line-1365"></a>************************************************************************
<a name="line-1366"></a>
<a name="line-1367"></a>Note [The improvement story and derived shadows]
<a name="line-1368"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1369"></a>Because Wanteds cannot rewrite Wanteds (see Note [Wanteds do not
<a name="line-1370"></a>rewrite Wanteds] in GHC.Tc.Types.Constraint), we may miss some opportunities for
<a name="line-1371"></a>solving.  Here's a classic example (indexed-types/should_fail/T4093a)
<a name="line-1372"></a>
<a name="line-1373"></a>    Ambiguity check for f: (Foo e ~ Maybe e) =&gt; Foo e
<a name="line-1374"></a>
<a name="line-1375"></a>    We get [G] Foo e ~ Maybe e    (CEqCan)
<a name="line-1376"></a>           [W] Foo ee ~ Foo e     (CEqCan)       -- ee is a unification variable
<a name="line-1377"></a>           [W] Foo ee ~ Maybe ee  (CEqCan)
<a name="line-1378"></a>
<a name="line-1379"></a>    The first Wanted gets rewritten to
<a name="line-1380"></a>
<a name="line-1381"></a>           [W] Foo ee ~ Maybe e
<a name="line-1382"></a>
<a name="line-1383"></a>    But now we appear to be stuck, since we don't rewrite Wanteds with
<a name="line-1384"></a>    Wanteds.  This is silly because we can see that ee := e is the
<a name="line-1385"></a>    only solution.
<a name="line-1386"></a>
<a name="line-1387"></a>The basic plan is
<a name="line-1388"></a>  * generate Derived constraints that shadow Wanted constraints
<a name="line-1389"></a>  * allow Derived to rewrite Derived
<a name="line-1390"></a>  * in order to cause some unifications to take place
<a name="line-1391"></a>  * that in turn solve the original Wanteds
<a name="line-1392"></a>
<a name="line-1393"></a>The ONLY reason for all these Derived equalities is to tell us how to
<a name="line-1394"></a>unify a variable: that is, what Mark Jones calls "improvement".
<a name="line-1395"></a>
<a name="line-1396"></a>The same idea is sometimes also called "saturation"; find all the
<a name="line-1397"></a>equalities that must hold in any solution.
<a name="line-1398"></a>
<a name="line-1399"></a>Or, equivalently, you can think of the derived shadows as implementing
<a name="line-1400"></a>the "model": a non-idempotent but no-occurs-check substitution,
<a name="line-1401"></a>reflecting *all* *Nominal* equalities (a ~N ty) that are not
<a name="line-1402"></a>immediately soluble by unification.
<a name="line-1403"></a>
<a name="line-1404"></a>More specifically, here's how it works (Oct 16):
<a name="line-1405"></a>
<a name="line-1406"></a>* Wanted constraints are born as [WD]; this behaves like a
<a name="line-1407"></a>  [W] and a [D] paired together.
<a name="line-1408"></a>
<a name="line-1409"></a>* When we are about to add a [WD] to the inert set, if it can
<a name="line-1410"></a>  be rewritten by a [D] a ~ ty, then we split it into [W] and [D],
<a name="line-1411"></a>  putting the latter into the work list (see maybeEmitShadow).
<a name="line-1412"></a>
<a name="line-1413"></a>In the example above, we get to the point where we are stuck:
<a name="line-1414"></a>    [WD] Foo ee ~ Foo e
<a name="line-1415"></a>    [WD] Foo ee ~ Maybe ee
<a name="line-1416"></a>
<a name="line-1417"></a>But now when [WD] Foo ee ~ Maybe ee is about to be added, we'll
<a name="line-1418"></a>split it into [W] and [D], since the inert [WD] Foo ee ~ Foo e
<a name="line-1419"></a>can rewrite it.  Then:
<a name="line-1420"></a>    work item: [D] Foo ee ~ Maybe ee
<a name="line-1421"></a>    inert:     [W] Foo ee ~ Maybe ee
<a name="line-1422"></a>               [WD] Foo ee ~ Maybe e
<a name="line-1423"></a>
<a name="line-1424"></a>See Note [Splitting WD constraints].  Now the work item is rewritten
<a name="line-1425"></a>by the [WD] and we soon get ee := e.
<a name="line-1426"></a>
<a name="line-1427"></a>Additional notes:
<a name="line-1428"></a>
<a name="line-1429"></a>  * The derived shadow equalities live in inert_eqs, along with
<a name="line-1430"></a>    the Givens and Wanteds; see Note [EqualCtList invariants].
<a name="line-1431"></a>
<a name="line-1432"></a>  * We make Derived shadows only for Wanteds, not Givens.  So we
<a name="line-1433"></a>    have only [G], not [GD] and [G] plus splitting.  See
<a name="line-1434"></a>    Note [Add derived shadows only for Wanteds]
<a name="line-1435"></a>
<a name="line-1436"></a>  * We also get Derived equalities from functional dependencies
<a name="line-1437"></a>    and type-function injectivity; see calls to unifyDerived.
<a name="line-1438"></a>
<a name="line-1439"></a>  * It's worth having [WD] rather than just [W] and [D] because
<a name="line-1440"></a>    * efficiency: silly to process the same thing twice
<a name="line-1441"></a>    * inert_dicts is a finite map keyed by
<a name="line-1442"></a>      the type; it's inconvenient for it to map to TWO constraints
<a name="line-1443"></a>
<a name="line-1444"></a>Another example requiring Deriveds is in
<a name="line-1445"></a>Note [Put touchable variables on the left] in GHC.Tc.Solver.Canonical.
<a name="line-1446"></a>
<a name="line-1447"></a>Note [Splitting WD constraints]
<a name="line-1448"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1449"></a>We are about to add a [WD] constraint to the inert set; and we
<a name="line-1450"></a>know that the inert set has fully rewritten it.  Should we split
<a name="line-1451"></a>it into [W] and [D], and put the [D] in the work list for further
<a name="line-1452"></a>work?
<a name="line-1453"></a>
<a name="line-1454"></a>* CDictCan (C tys):
<a name="line-1455"></a>  Yes if the inert set could rewrite tys to make the class constraint,
<a name="line-1456"></a>  or type family, fire.  That is, yes if the inert_eqs intersects
<a name="line-1457"></a>  with the free vars of tys.  For this test we use
<a name="line-1458"></a>  (anyRewritableTyVar True) which ignores casts and coercions in tys,
<a name="line-1459"></a>  because rewriting the casts or coercions won't make the thing fire
<a name="line-1460"></a>  more often.
<a name="line-1461"></a>
<a name="line-1462"></a>* CEqCan (lhs ~ ty): Yes if the inert set could rewrite 'lhs' or 'ty'.
<a name="line-1463"></a>  We need to check both 'lhs' and 'ty' against the inert set:
<a name="line-1464"></a>    - Inert set contains  [D] a ~ ty2
<a name="line-1465"></a>      Then we want to put [D] a ~ ty in the worklist, so we'll
<a name="line-1466"></a>      get [D] ty ~ ty2 with consequent good things
<a name="line-1467"></a>
<a name="line-1468"></a>    - Inert set contains [D] b ~ a, where b is in ty.
<a name="line-1469"></a>      We can't just add [WD] a ~ ty[b] to the inert set, because
<a name="line-1470"></a>      that breaks the inert-set invariants.  If we tried to
<a name="line-1471"></a>      canonicalise another [D] constraint mentioning 'a', we'd
<a name="line-1472"></a>      get an infinite loop
<a name="line-1473"></a>
<a name="line-1474"></a>  Moreover we must use (anyRewritableTyVar False) for the RHS,
<a name="line-1475"></a>  because even tyvars in the casts and coercions could give
<a name="line-1476"></a>  an infinite loop if we don't expose it
<a name="line-1477"></a>
<a name="line-1478"></a>* CIrredCan: Yes if the inert set can rewrite the constraint.
<a name="line-1479"></a>  We used to think splitting irreds was unnecessary, but
<a name="line-1480"></a>  see Note [Splitting Irred WD constraints]
<a name="line-1481"></a>
<a name="line-1482"></a>* Others: nothing is gained by splitting.
<a name="line-1483"></a>
<a name="line-1484"></a>Note [Splitting Irred WD constraints]
<a name="line-1485"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1486"></a>Splitting Irred constraints can make a difference. Here is the
<a name="line-1487"></a>scenario:
<a name="line-1488"></a>
<a name="line-1489"></a>  a[sk] :: F v     -- F is a type family
<a name="line-1490"></a>  beta :: alpha
<a name="line-1491"></a>
<a name="line-1492"></a>  work item: [WD] a ~ beta
<a name="line-1493"></a>
<a name="line-1494"></a>This is heterogeneous, so we emit a kind equality and make the work item an
<a name="line-1495"></a>inert Irred.
<a name="line-1496"></a>
<a name="line-1497"></a>  work item: [D] F v ~ alpha
<a name="line-1498"></a>  inert: [WD] (a |&gt; co) ~ beta (CIrredCan)
<a name="line-1499"></a>
<a name="line-1500"></a>Can't make progress on the work item. Add to inert set. This kicks out the
<a name="line-1501"></a>old inert, because a [D] can rewrite a [WD].
<a name="line-1502"></a>
<a name="line-1503"></a>  work item: [WD] (a |&gt; co) ~ beta
<a name="line-1504"></a>  inert: [D] F v ~ alpha (CEqCan)
<a name="line-1505"></a>
<a name="line-1506"></a>Can't make progress on this work item either (although GHC tries by
<a name="line-1507"></a>decomposing the cast and rewriting... but that doesn't make a difference),
<a name="line-1508"></a>which is still hetero. Emit a new kind equality and add to inert set. But,
<a name="line-1509"></a>critically, we split the Irred.
<a name="line-1510"></a>
<a name="line-1511"></a>  work list:
<a name="line-1512"></a>   [D] F v ~ alpha (CEqCan)
<a name="line-1513"></a>   [D] (a |&gt; co) ~ beta (CIrred) -- this one was split off
<a name="line-1514"></a>  inert:
<a name="line-1515"></a>   [W] (a |&gt; co) ~ beta
<a name="line-1516"></a>   [D] F v ~ alpha
<a name="line-1517"></a>
<a name="line-1518"></a>We quickly solve the first work item, as it's the same as an inert.
<a name="line-1519"></a>
<a name="line-1520"></a>  work item: [D] (a |&gt; co) ~ beta
<a name="line-1521"></a>  inert:
<a name="line-1522"></a>   [W] (a |&gt; co) ~ beta
<a name="line-1523"></a>   [D] F v ~ alpha
<a name="line-1524"></a>
<a name="line-1525"></a>We decompose the cast, yielding
<a name="line-1526"></a>
<a name="line-1527"></a>  [D] a ~ beta
<a name="line-1528"></a>
<a name="line-1529"></a>We then rewrite the kinds. The lhs kind is F v, which flattens to alpha.
<a name="line-1530"></a>
<a name="line-1531"></a>  co' :: F v ~ alpha
<a name="line-1532"></a>  [D] (a |&gt; co') ~ beta
<a name="line-1533"></a>
<a name="line-1534"></a>Now this equality is homo-kinded. So we swizzle it around to
<a name="line-1535"></a>
<a name="line-1536"></a>  [D] beta ~ (a |&gt; co')
<a name="line-1537"></a>
<a name="line-1538"></a>and set beta := a |&gt; co', and go home happy.
<a name="line-1539"></a>
<a name="line-1540"></a>If we don't split the Irreds, we loop. This is all dangerously subtle.
<a name="line-1541"></a>
<a name="line-1542"></a>This is triggered by test case typecheck/should_compile/SplitWD.
<a name="line-1543"></a>
<a name="line-1544"></a>Note [Add derived shadows only for Wanteds]
<a name="line-1545"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1546"></a>We only add shadows for Wanted constraints. That is, we have
<a name="line-1547"></a>[WD] but not [GD]; and maybeEmitShaodw looks only at [WD]
<a name="line-1548"></a>constraints.
<a name="line-1549"></a>
<a name="line-1550"></a>It does just possibly make sense ot add a derived shadow for a
<a name="line-1551"></a>Given. If we created a Derived shadow of a Given, it could be
<a name="line-1552"></a>rewritten by other Deriveds, and that could, conceivably, lead to a
<a name="line-1553"></a>useful unification.
<a name="line-1554"></a>
<a name="line-1555"></a>But (a) I have been unable to come up with an example of this
<a name="line-1556"></a>        happening
<a name="line-1557"></a>    (b) see #12660 for how adding the derived shadows
<a name="line-1558"></a>        of a Given led to an infinite loop.
<a name="line-1559"></a>    (c) It's unlikely that rewriting derived Givens will lead
<a name="line-1560"></a>        to a unification because Givens don't mention touchable
<a name="line-1561"></a>        unification variables
<a name="line-1562"></a>
<a name="line-1563"></a>For (b) there may be other ways to solve the loop, but simply
<a name="line-1564"></a>reraining from adding derived shadows of Givens is particularly
<a name="line-1565"></a>simple.  And it's more efficient too!
<a name="line-1566"></a>
<a name="line-1567"></a>Still, here's one possible reason for adding derived shadows
<a name="line-1568"></a>for Givens.  Consider
<a name="line-1569"></a>           work-item [G] a ~ [b], inerts has [D] b ~ a.
<a name="line-1570"></a>If we added the derived shadow (into the work list)
<a name="line-1571"></a>         [D] a ~ [b]
<a name="line-1572"></a>When we process it, we'll rewrite to a ~ [a] and get an
<a name="line-1573"></a>occurs check.  Without it we'll miss the occurs check (reporting
<a name="line-1574"></a>inaccessible code); but that's probably OK.
<a name="line-1575"></a>
<a name="line-1576"></a>Note [Keep CDictCan shadows as CDictCan]
<a name="line-1577"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1578"></a>Suppose we have
<a name="line-1579"></a>  class C a =&gt; D a b
<a name="line-1580"></a>and [G] D a b, [G] C a in the inert set.  Now we insert
<a name="line-1581"></a>[D] b ~ c.  We want to kick out a derived shadow for [D] D a b,
<a name="line-1582"></a>so we can rewrite it with the new constraint, and perhaps get
<a name="line-1583"></a>instance reduction or other consequences.
<a name="line-1584"></a>
<a name="line-1585"></a>BUT we do not want to kick out a *non-canonical* (D a b). If we
<a name="line-1586"></a>did, we would do this:
<a name="line-1587"></a>  - rewrite it to [D] D a c, with pend_sc = True
<a name="line-1588"></a>  - use expandSuperClasses to add C a
<a name="line-1589"></a>  - go round again, which solves C a from the givens
<a name="line-1590"></a>This loop goes on for ever and triggers the simpl_loop limit.
<a name="line-1591"></a>
<a name="line-1592"></a>Solution: kick out the CDictCan which will have pend_sc = False,
<a name="line-1593"></a>because we've already added its superclasses.  So we won't re-add
<a name="line-1594"></a>them.  If we forget the pend_sc flag, our cunning scheme for avoiding
<a name="line-1595"></a>generating superclasses repeatedly will fail.
<a name="line-1596"></a>
<a name="line-1597"></a>See #11379 for a case of this.
<a name="line-1598"></a>
<a name="line-1599"></a>Note [Do not do improvement for WOnly]
<a name="line-1600"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1601"></a>We do improvement between two constraints (e.g. for injectivity
<a name="line-1602"></a>or functional dependencies) only if both are "improvable". And
<a name="line-1603"></a>we improve a constraint wrt the top-level instances only if
<a name="line-1604"></a>it is improvable.
<a name="line-1605"></a>
<a name="line-1606"></a>Improvable:     [G] [WD] [D}
<a name="line-1607"></a>Not improvable: [W]
<a name="line-1608"></a>
<a name="line-1609"></a>Reasons:
<a name="line-1610"></a>
<a name="line-1611"></a>* It's less work: fewer pairs to compare
<a name="line-1612"></a>
<a name="line-1613"></a>* Every [W] has a shadow [D] so nothing is lost
<a name="line-1614"></a>
<a name="line-1615"></a>* Consider [WD] C Int b,  where 'b' is a skolem, and
<a name="line-1616"></a>    class C a b | a -&gt; b
<a name="line-1617"></a>    instance C Int Bool
<a name="line-1618"></a>  We'll do a fundep on it and emit [D] b ~ Bool
<a name="line-1619"></a>  That will kick out constraint [WD] C Int b
<a name="line-1620"></a>  Then we'll split it to [W] C Int b (keep in inert)
<a name="line-1621"></a>                     and [D] C Int b (in work list)
<a name="line-1622"></a>  When processing the latter we'll rewrite it to
<a name="line-1623"></a>        [D] C Int Bool
<a name="line-1624"></a>  At that point it would be /stupid/ to interact it
<a name="line-1625"></a>  with the inert [W] C Int b in the inert set; after all,
<a name="line-1626"></a>  it's the very constraint from which the [D] C Int Bool
<a name="line-1627"></a>  was split!  We can avoid this by not doing improvement
<a name="line-1628"></a>  on [W] constraints. This came up in #12860.
<a name="line-1629"></a>-}</span>
<a name="line-1630"></a>
<a name="line-1631"></a><a name="maybeEmitShadow"></a><span class='hs-definition'>maybeEmitShadow</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Ct</span>
<a name="line-1632"></a><span class='hs-comment'>-- See Note [The improvement story and derived shadows]</span>
<a name="line-1633"></a><span class='hs-definition'>maybeEmitShadow</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>ct</span>
<a name="line-1634"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>ct</span>
<a name="line-1635"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span>
<a name="line-1636"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_nosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WDeriv</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ev</span>
<a name="line-1637"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>shouldSplitWD</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-varid'>ct</span>
<a name="line-1638"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emit derived shadow"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-1639"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>derived_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span>
<a name="line-1640"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span>
<a name="line-1641"></a>             <span class='hs-varid'>shadow_ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>derived_ev</span> <span class='hs-layout'>}</span>
<a name="line-1642"></a>               <span class='hs-comment'>-- Te shadow constraint keeps the canonical shape.</span>
<a name="line-1643"></a>               <span class='hs-comment'>-- This just saves work, but is sometimes important;</span>
<a name="line-1644"></a>               <span class='hs-comment'>-- see Note [Keep CDictCan shadows as CDictCan]</span>
<a name="line-1645"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>emitWork</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>shadow_ct</span><span class='hs-keyglyph'>]</span>
<a name="line-1646"></a>
<a name="line-1647"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ev'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_nosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WOnly</span> <span class='hs-layout'>}</span>
<a name="line-1648"></a>             <span class='hs-varid'>ct'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev'</span> <span class='hs-layout'>}</span>
<a name="line-1649"></a>                 <span class='hs-comment'>-- Record that it now has a shadow</span>
<a name="line-1650"></a>                 <span class='hs-comment'>-- This is /the/ place we set the flag to WOnly</span>
<a name="line-1651"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ct'</span> <span class='hs-layout'>}</span>
<a name="line-1652"></a>
<a name="line-1653"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1654"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ct</span>
<a name="line-1655"></a>
<a name="line-1656"></a><a name="shouldSplitWD"></a><span class='hs-definition'>shouldSplitWD</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertEqs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1657"></a><span class='hs-comment'>-- Precondition: 'ct' is [WD], and is inert</span>
<a name="line-1658"></a><span class='hs-comment'>-- True &lt;=&gt; we should split ct ito [W] and [D] because</span>
<a name="line-1659"></a><span class='hs-comment'>--          the inert_eqs can make progress on the [D]</span>
<a name="line-1660"></a><span class='hs-comment'>-- See Note [Splitting WD constraints]</span>
<a name="line-1661"></a>
<a name="line-1662"></a><span class='hs-definition'>shouldSplitWD</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>fun_eqs</span> <span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1663"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>should_split_match_args</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>fun_eqs</span> <span class='hs-varid'>tys</span>
<a name="line-1664"></a>    <span class='hs-comment'>-- NB True: ignore coercions</span>
<a name="line-1665"></a>    <span class='hs-comment'>-- See Note [Splitting WD constraints]</span>
<a name="line-1666"></a>
<a name="line-1667"></a><span class='hs-definition'>shouldSplitWD</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>fun_eqs</span> <span class='hs-layout'>(</span><span class='hs-conid'>CEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarLHS</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-1668"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>cc_eq_rel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq_rel</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1669"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>tv</span> <span class='hs-varop'>`elemDVarEnv`</span> <span class='hs-varid'>inert_eqs</span>
<a name="line-1670"></a>  <span class='hs-varop'>||</span> <span class='hs-varid'>anyRewritableCanEqLHS</span> <span class='hs-varid'>eq_rel</span> <span class='hs-layout'>(</span><span class='hs-varid'>canRewriteTv</span> <span class='hs-varid'>inert_eqs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>canRewriteTyFam</span> <span class='hs-varid'>fun_eqs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1671"></a>  <span class='hs-comment'>-- NB False: do not ignore casts and coercions</span>
<a name="line-1672"></a>  <span class='hs-comment'>-- See Note [Splitting WD constraints]</span>
<a name="line-1673"></a>
<a name="line-1674"></a><span class='hs-definition'>shouldSplitWD</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>fun_eqs</span> <span class='hs-layout'>(</span><span class='hs-conid'>CEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_eq_rel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq_rel</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1675"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>anyRewritableCanEqLHS</span> <span class='hs-varid'>eq_rel</span> <span class='hs-layout'>(</span><span class='hs-varid'>canRewriteTv</span> <span class='hs-varid'>inert_eqs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>canRewriteTyFam</span> <span class='hs-varid'>fun_eqs</span><span class='hs-layout'>)</span>
<a name="line-1676"></a>                          <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-1677"></a>
<a name="line-1678"></a><span class='hs-definition'>shouldSplitWD</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>fun_eqs</span> <span class='hs-layout'>(</span><span class='hs-conid'>CIrredCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1679"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>anyRewritableCanEqLHS</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvEqRel</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>canRewriteTv</span> <span class='hs-varid'>inert_eqs</span><span class='hs-layout'>)</span>
<a name="line-1680"></a>                          <span class='hs-layout'>(</span><span class='hs-varid'>canRewriteTyFam</span> <span class='hs-varid'>fun_eqs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-1681"></a>
<a name="line-1682"></a><span class='hs-definition'>shouldSplitWD</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>   <span class='hs-comment'>-- No point in splitting otherwise</span>
<a name="line-1683"></a>
<a name="line-1684"></a><a name="should_split_match_args"></a><span class='hs-definition'>should_split_match_args</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertEqs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1685"></a><span class='hs-comment'>-- True if the inert_eqs can rewrite anything in the argument types</span>
<a name="line-1686"></a><span class='hs-definition'>should_split_match_args</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>fun_eqs</span> <span class='hs-varid'>tys</span>
<a name="line-1687"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>anyRewritableCanEqLHS</span> <span class='hs-conid'>NomEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>canRewriteTv</span> <span class='hs-varid'>inert_eqs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>canRewriteTyFam</span> <span class='hs-varid'>fun_eqs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-1688"></a>    <span class='hs-comment'>-- See Note [Splitting WD constraints]</span>
<a name="line-1689"></a>
<a name="line-1690"></a><a name="canRewriteTv"></a><span class='hs-definition'>canRewriteTv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertEqs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqRel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1691"></a><span class='hs-definition'>canRewriteTv</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>eq_rel</span> <span class='hs-varid'>tv</span>
<a name="line-1692"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqualCtList</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span> <span class='hs-conop'>:|</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupDVarEnv</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>tv</span>
<a name="line-1693"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>CEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_eq_rel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq_rel1</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ct</span>
<a name="line-1694"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq_rel1</span> <span class='hs-varop'>`eqCanRewrite`</span> <span class='hs-varid'>eq_rel</span>
<a name="line-1695"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1696"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1697"></a>
<a name="line-1698"></a><a name="canRewriteTyFam"></a><span class='hs-definition'>canRewriteTyFam</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqRel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1699"></a><span class='hs-definition'>canRewriteTyFam</span> <span class='hs-varid'>fun_eqs</span> <span class='hs-varid'>eq_rel</span> <span class='hs-varid'>tf</span> <span class='hs-varid'>args</span>
<a name="line-1700"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqualCtList</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span> <span class='hs-conop'>:|</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findFunEq</span> <span class='hs-varid'>fun_eqs</span> <span class='hs-varid'>tf</span> <span class='hs-varid'>args</span>
<a name="line-1701"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>CEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_eq_rel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq_rel1</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ct</span>
<a name="line-1702"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq_rel1</span> <span class='hs-varop'>`eqCanRewrite`</span> <span class='hs-varid'>eq_rel</span>
<a name="line-1703"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1704"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1705"></a>
<a name="line-1706"></a><a name="isImprovable"></a><span class='hs-definition'>isImprovable</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1707"></a><span class='hs-comment'>-- See Note [Do not do improvement for WOnly]</span>
<a name="line-1708"></a><span class='hs-definition'>isImprovable</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_nosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WOnly</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1709"></a><span class='hs-definition'>isImprovable</span> <span class='hs-keyword'>_</span>                                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1710"></a>
<a name="line-1711"></a>
<a name="line-1712"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1713"></a>*                                                                      *
<a name="line-1714"></a>                   Inert equalities
<a name="line-1715"></a>*                                                                      *
<a name="line-1716"></a>********************************************************************* -}</span>
<a name="line-1717"></a>
<a name="line-1718"></a><a name="addTyEq"></a><span class='hs-definition'>addTyEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertEqs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertEqs</span>
<a name="line-1719"></a><span class='hs-definition'>addTyEq</span> <span class='hs-varid'>old_eqs</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ct</span>
<a name="line-1720"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendDVarEnv_C</span> <span class='hs-varid'>add_eq</span> <span class='hs-varid'>old_eqs</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitEqualCtList</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-1721"></a>  <span class='hs-keyword'>where</span>
<a name="line-1722"></a>    <span class='hs-varid'>add_eq</span> <span class='hs-varid'>old_eqs</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToEqualCtList</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>old_eqs</span>
<a name="line-1723"></a>
<a name="line-1724"></a><a name="addCanFunEq"></a><span class='hs-definition'>addCanFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span>
<a name="line-1725"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>EqualCtList</span>
<a name="line-1726"></a><span class='hs-definition'>addCanFunEq</span> <span class='hs-varid'>old_eqs</span> <span class='hs-varid'>fun_tc</span> <span class='hs-varid'>fun_args</span> <span class='hs-varid'>ct</span>
<a name="line-1727"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alterTcApp</span> <span class='hs-varid'>old_eqs</span> <span class='hs-varid'>fun_tc</span> <span class='hs-varid'>fun_args</span> <span class='hs-varid'>upd</span>
<a name="line-1728"></a>  <span class='hs-keyword'>where</span>
<a name="line-1729"></a>    <span class='hs-varid'>upd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>old_equal_ct_list</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addToEqualCtList</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>old_equal_ct_list</span>
<a name="line-1730"></a>    <span class='hs-varid'>upd</span> <span class='hs-conid'>Nothing</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unitEqualCtList</span> <span class='hs-varid'>ct</span>
<a name="line-1731"></a>
<a name="line-1732"></a><a name="foldTyEqs"></a><span class='hs-definition'>foldTyEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertEqs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-1733"></a><span class='hs-definition'>foldTyEqs</span> <span class='hs-varid'>k</span> <span class='hs-varid'>eqs</span> <span class='hs-varid'>z</span>
<a name="line-1734"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldDVarEnv</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>EqualCtList</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>k</span> <span class='hs-varid'>z</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span> <span class='hs-varid'>z</span> <span class='hs-varid'>eqs</span>
<a name="line-1735"></a>
<a name="line-1736"></a><a name="findTyEqs"></a><span class='hs-definition'>findTyEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-1737"></a><span class='hs-definition'>findTyEqs</span> <span class='hs-varid'>icans</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybe</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-keyglyph'>@</span><span class='hs-conid'>Maybe</span> <span class='hs-varid'>equalCtListToList</span> <span class='hs-varop'>$</span>
<a name="line-1738"></a>                                  <span class='hs-varid'>lookupDVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>icans</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-1739"></a>
<a name="line-1740"></a><a name="delEq"></a><span class='hs-definition'>delEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CanEqLHS</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-1741"></a><span class='hs-definition'>delEq</span> <span class='hs-varid'>ic</span> <span class='hs-varid'>lhs</span> <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lhs</span> <span class='hs-keyword'>of</span>
<a name="line-1742"></a>    <span class='hs-conid'>TyVarLHS</span> <span class='hs-varid'>tv</span>
<a name="line-1743"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alterDVarEnv</span> <span class='hs-varid'>upd</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>ic</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>}</span>
<a name="line-1744"></a>    <span class='hs-conid'>TyFamLHS</span> <span class='hs-varid'>tf</span> <span class='hs-varid'>args</span>
<a name="line-1745"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alterTcApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>ic</span><span class='hs-layout'>)</span> <span class='hs-varid'>tf</span> <span class='hs-varid'>args</span> <span class='hs-varid'>upd</span> <span class='hs-layout'>}</span>
<a name="line-1746"></a>  <span class='hs-keyword'>where</span>
<a name="line-1747"></a>    <span class='hs-varid'>isThisOne</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1748"></a>    <span class='hs-varid'>isThisOne</span> <span class='hs-layout'>(</span><span class='hs-conid'>CEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcEqTypeNoKindCheck</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>t1</span>
<a name="line-1749"></a>    <span class='hs-varid'>isThisOne</span> <span class='hs-varid'>other</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"delEq"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>lhs</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ic</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
<a name="line-1750"></a>
<a name="line-1751"></a>    <span class='hs-varid'>upd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>EqualCtList</span>
<a name="line-1752"></a>    <span class='hs-varid'>upd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>eq_ct_list</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterEqualCtList</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isThisOne</span><span class='hs-layout'>)</span> <span class='hs-varid'>eq_ct_list</span>
<a name="line-1753"></a>    <span class='hs-varid'>upd</span> <span class='hs-conid'>Nothing</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1754"></a>
<a name="line-1755"></a><a name="findEq"></a><span class='hs-definition'>findEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CanEqLHS</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-1756"></a><span class='hs-definition'>findEq</span> <span class='hs-varid'>icans</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarLHS</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findTyEqs</span> <span class='hs-varid'>icans</span> <span class='hs-varid'>tv</span>
<a name="line-1757"></a><span class='hs-definition'>findEq</span> <span class='hs-varid'>icans</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyFamLHS</span> <span class='hs-varid'>fun_tc</span> <span class='hs-varid'>fun_args</span><span class='hs-layout'>)</span>
<a name="line-1758"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybe</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-keyglyph'>@</span><span class='hs-conid'>Maybe</span> <span class='hs-varid'>equalCtListToList</span> <span class='hs-varop'>$</span>
<a name="line-1759"></a>                 <span class='hs-varid'>findFunEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>icans</span><span class='hs-layout'>)</span> <span class='hs-varid'>fun_tc</span> <span class='hs-varid'>fun_args</span><span class='hs-layout'>)</span>
<a name="line-1760"></a>
<a name="line-1761"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1762"></a>*                                                                      *
<a name="line-1763"></a>                   Inert instances: inert_insts
<a name="line-1764"></a>*                                                                      *
<a name="line-1765"></a>********************************************************************* -}</span>
<a name="line-1766"></a>
<a name="line-1767"></a><a name="addInertForAll"></a><span class='hs-definition'>addInertForAll</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>QCInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1768"></a><span class='hs-comment'>-- Add a local Given instance, typically arising from a type signature</span>
<a name="line-1769"></a><span class='hs-definition'>addInertForAll</span> <span class='hs-varid'>new_qci</span>
<a name="line-1770"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ics</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-1771"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ics1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>add_qci</span> <span class='hs-varid'>ics</span>
<a name="line-1772"></a>
<a name="line-1773"></a>       <span class='hs-comment'>-- Update given equalities. C.f updateGivenEqs</span>
<a name="line-1774"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tclvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcLevel</span>
<a name="line-1775"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>pred</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>qci_pred</span> <span class='hs-varid'>new_qci</span>
<a name="line-1776"></a>             <span class='hs-varid'>not_equality</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isClassPred</span> <span class='hs-varid'>pred</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEqPred</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-1777"></a>                  <span class='hs-comment'>-- True &lt;=&gt; definitely not an equality</span>
<a name="line-1778"></a>                  <span class='hs-comment'>-- A qci_pred like (f a) might be an equality</span>
<a name="line-1779"></a>
<a name="line-1780"></a>             <span class='hs-varid'>ics2</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not_equality</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics1</span>
<a name="line-1781"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics1</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_given_eq_lvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tclvl</span>
<a name="line-1782"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>inert_given_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span>
<a name="line-1783"></a>
<a name="line-1784"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setInertCans</span> <span class='hs-varid'>ics2</span> <span class='hs-layout'>}</span>
<a name="line-1785"></a>  <span class='hs-keyword'>where</span>
<a name="line-1786"></a>    <span class='hs-varid'>add_qci</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>InertCans</span>
<a name="line-1787"></a>    <span class='hs-comment'>-- See Note [Do not add duplicate quantified instances]</span>
<a name="line-1788"></a>    <span class='hs-varid'>add_qci</span> <span class='hs-varid'>ics</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>qcis</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1789"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-varid'>same_qci</span> <span class='hs-varid'>qcis</span>
<a name="line-1790"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"skipping duplicate quantified instance"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>new_qci</span><span class='hs-layout'>)</span>
<a name="line-1791"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>}</span>
<a name="line-1792"></a>
<a name="line-1793"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1794"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"adding new inert quantified instance"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>new_qci</span><span class='hs-layout'>)</span>
<a name="line-1795"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_qci</span> <span class='hs-conop'>:</span> <span class='hs-varid'>qcis</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1796"></a>
<a name="line-1797"></a>    <span class='hs-varid'>same_qci</span> <span class='hs-varid'>old_qci</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcEqType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>qci_ev</span> <span class='hs-varid'>old_qci</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1798"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>qci_ev</span> <span class='hs-varid'>new_qci</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1799"></a>
<a name="line-1800"></a><span class='hs-comment'>{- Note [Do not add duplicate quantified instances]
<a name="line-1801"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1802"></a>Consider this (#15244):
<a name="line-1803"></a>
<a name="line-1804"></a>  f :: (C g, D g) =&gt; ....
<a name="line-1805"></a>  class S g =&gt; C g where ...
<a name="line-1806"></a>  class S g =&gt; D g where ...
<a name="line-1807"></a>  class (forall a. Eq a =&gt; Eq (g a)) =&gt; S g where ...
<a name="line-1808"></a>
<a name="line-1809"></a>Then in f's RHS there are two identical quantified constraints
<a name="line-1810"></a>available, one via the superclasses of C and one via the superclasses
<a name="line-1811"></a>of D.  The two are identical, and it seems wrong to reject the program
<a name="line-1812"></a>because of that. But without doing duplicate-elimination we will have
<a name="line-1813"></a>two matching QCInsts when we try to solve constraints arising from f's
<a name="line-1814"></a>RHS.
<a name="line-1815"></a>
<a name="line-1816"></a>The simplest thing is simply to eliminate duplicates, which we do here.
<a name="line-1817"></a>-}</span>
<a name="line-1818"></a>
<a name="line-1819"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1820"></a>*                                                                      *
<a name="line-1821"></a>                  Adding an inert
<a name="line-1822"></a>*                                                                      *
<a name="line-1823"></a>************************************************************************
<a name="line-1824"></a>
<a name="line-1825"></a>Note [Adding an equality to the InertCans]
<a name="line-1826"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1827"></a>When adding an equality to the inerts:
<a name="line-1828"></a>
<a name="line-1829"></a>* Split [WD] into [W] and [D] if the inerts can rewrite the latter;
<a name="line-1830"></a>  done by maybeEmitShadow.
<a name="line-1831"></a>
<a name="line-1832"></a>* Kick out any constraints that can be rewritten by the thing
<a name="line-1833"></a>  we are adding.  Done by kickOutRewritable.
<a name="line-1834"></a>
<a name="line-1835"></a>* Note that unifying a:=ty, is like adding [G] a~ty; just use
<a name="line-1836"></a>  kickOutRewritable with Nominal, Given.  See kickOutAfterUnification.
<a name="line-1837"></a>-}</span>
<a name="line-1838"></a>
<a name="line-1839"></a><a name="addInertCan"></a><span class='hs-definition'>addInertCan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1840"></a><span class='hs-comment'>-- Precondition: item /is/ canonical</span>
<a name="line-1841"></a><span class='hs-comment'>-- See Note [Adding an equality to the InertCans]</span>
<a name="line-1842"></a><span class='hs-definition'>addInertCan</span> <span class='hs-varid'>ct</span>
<a name="line-1843"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"addInertCan {"</span> <span class='hs-varop'>$</span>
<a name="line-1844"></a>         <span class='hs-varid'>text</span> <span class='hs-str'>"Trying to insert new inert item:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span>
<a name="line-1845"></a>
<a name="line-1846"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-1847"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ct</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeEmitShadow</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>ct</span>
<a name="line-1848"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeKickOut</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>ct</span>
<a name="line-1849"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tclvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcLevel</span>
<a name="line-1850"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setInertCans</span> <span class='hs-layout'>(</span><span class='hs-varid'>add_item</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-1851"></a>
<a name="line-1852"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"addInertCan }"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>}</span>
<a name="line-1853"></a>
<a name="line-1854"></a><a name="maybeKickOut"></a><span class='hs-definition'>maybeKickOut</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>InertCans</span>
<a name="line-1855"></a><span class='hs-comment'>-- For a CEqCan, kick out any inert that can be rewritten by the CEqCan</span>
<a name="line-1856"></a><span class='hs-definition'>maybeKickOut</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>ct</span>
<a name="line-1857"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_eq_rel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq_rel</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ct</span>
<a name="line-1858"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ics'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kickOutRewritable</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvFlavour</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>eq_rel</span><span class='hs-layout'>)</span> <span class='hs-varid'>lhs</span> <span class='hs-varid'>ics</span>
<a name="line-1859"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ics'</span> <span class='hs-layout'>}</span>
<a name="line-1860"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1861"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ics</span>
<a name="line-1862"></a>
<a name="line-1863"></a><a name="add_item"></a><span class='hs-definition'>add_item</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-1864"></a><span class='hs-definition'>add_item</span> <span class='hs-varid'>tc_lvl</span>
<a name="line-1865"></a>         <span class='hs-varid'>ics</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1866"></a>         <span class='hs-varid'>item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1867"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updateGivenEqs</span> <span class='hs-varid'>tc_lvl</span> <span class='hs-varid'>item</span> <span class='hs-varop'>$</span>
<a name="line-1868"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>lhs</span> <span class='hs-keyword'>of</span>
<a name="line-1869"></a>       <span class='hs-conid'>TyFamLHS</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addCanFunEq</span> <span class='hs-varid'>funeqs</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span> <span class='hs-layout'>}</span>
<a name="line-1870"></a>       <span class='hs-conid'>TyVarLHS</span> <span class='hs-varid'>tv</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTyEq</span> <span class='hs-varid'>eqs</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>item</span> <span class='hs-layout'>}</span>
<a name="line-1871"></a>
<a name="line-1872"></a><span class='hs-definition'>add_item</span> <span class='hs-varid'>tc_lvl</span> <span class='hs-varid'>ics</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_blocked</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>blocked</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1873"></a>         <span class='hs-varid'>item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CIrredCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_reason</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HoleBlockerReason</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1874"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updateGivenEqs</span> <span class='hs-varid'>tc_lvl</span> <span class='hs-varid'>item</span> <span class='hs-varop'>$</span>  <span class='hs-comment'>-- this item is always an equality</span>
<a name="line-1875"></a>    <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_blocked</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>blocked</span> <span class='hs-varop'>`snocBag`</span> <span class='hs-varid'>item</span> <span class='hs-layout'>}</span>
<a name="line-1876"></a>
<a name="line-1877"></a><span class='hs-definition'>add_item</span> <span class='hs-varid'>tc_lvl</span> <span class='hs-varid'>ics</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>irreds</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CIrredCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1878"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updateGivenEqs</span> <span class='hs-varid'>tc_lvl</span> <span class='hs-varid'>item</span> <span class='hs-varop'>$</span>   <span class='hs-comment'>-- An Irred might turn out to be an</span>
<a name="line-1879"></a>                                 <span class='hs-comment'>-- equality, so we play safe</span>
<a name="line-1880"></a>    <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>irreds</span> <span class='hs-varop'>`Bag.snocBag`</span> <span class='hs-varid'>item</span> <span class='hs-layout'>}</span>
<a name="line-1881"></a>
<a name="line-1882"></a><span class='hs-definition'>add_item</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1883"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addDictCt</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span> <span class='hs-layout'>}</span>
<a name="line-1884"></a>
<a name="line-1885"></a><span class='hs-definition'>add_item</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>item</span>
<a name="line-1886"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"upd_inert set: can't happen! Inserting "</span> <span class='hs-varop'>$</span>
<a name="line-1887"></a>    <span class='hs-varid'>ppr</span> <span class='hs-varid'>item</span>   <span class='hs-comment'>-- Can't be CNonCanonical because they only land in inert_irreds</span>
<a name="line-1888"></a>
<a name="line-1889"></a><a name="updateGivenEqs"></a><span class='hs-definition'>updateGivenEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-1890"></a><span class='hs-comment'>-- Set the inert_given_eq_level to the current level (tclvl)</span>
<a name="line-1891"></a><span class='hs-comment'>-- if the constraint is a given equality that should prevent</span>
<a name="line-1892"></a><span class='hs-comment'>-- filling in an outer unification variable.</span>
<a name="line-1893"></a><span class='hs-comment'>-- See See Note [Tracking Given equalities]</span>
<a name="line-1894"></a><span class='hs-definition'>updateGivenEqs</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>inerts</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_given_eq_lvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ge_lvl</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1895"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isGivenCt</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inerts</span>
<a name="line-1896"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not_equality</span> <span class='hs-varid'>ct</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inerts</span> <span class='hs-comment'>-- See Note [Let-bound skolems]</span>
<a name="line-1897"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inerts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_given_eq_lvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ge_lvl'</span>
<a name="line-1898"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>inert_given_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span>
<a name="line-1899"></a>  <span class='hs-keyword'>where</span>
<a name="line-1900"></a>    <span class='hs-varid'>ge_lvl'</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mentionsOuterVar</span> <span class='hs-varid'>tclvl</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-1901"></a>              <span class='hs-comment'>-- Includes things like (c a), which *might* be an equality</span>
<a name="line-1902"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tclvl</span>
<a name="line-1903"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1904"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ge_lvl</span>
<a name="line-1905"></a>
<a name="line-1906"></a>    <span class='hs-varid'>not_equality</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1907"></a>    <span class='hs-comment'>-- True &lt;=&gt; definitely not an equality of any kind</span>
<a name="line-1908"></a>    <span class='hs-comment'>--          except for a let-bound skolem, which doesn't count</span>
<a name="line-1909"></a>    <span class='hs-comment'>--          See Note [Let-bound skolems]</span>
<a name="line-1910"></a>    <span class='hs-comment'>-- NB: no need to spot the boxed CDictCan (a ~ b) because its</span>
<a name="line-1911"></a>    <span class='hs-comment'>--     superclass (a ~# b) will be a CEqCan</span>
<a name="line-1912"></a>    <span class='hs-varid'>not_equality</span> <span class='hs-layout'>(</span><span class='hs-conid'>CEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarLHS</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isOuterTyVar</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-1913"></a>    <span class='hs-varid'>not_equality</span> <span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1914"></a>    <span class='hs-varid'>not_equality</span> <span class='hs-keyword'>_</span>                                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1915"></a>
<a name="line-1916"></a><a name="kickOutRewritable"></a><span class='hs-comment'>-----------------------------------------</span>
<a name="line-1917"></a><span class='hs-definition'>kickOutRewritable</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavourRole</span>  <span class='hs-comment'>-- Flavour/role of the equality that</span>
<a name="line-1918"></a>                                      <span class='hs-comment'>-- is being added to the inert set</span>
<a name="line-1919"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CanEqLHS</span>        <span class='hs-comment'>-- The new equality is lhs ~ ty</span>
<a name="line-1920"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-1921"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>InertCans</span><span class='hs-layout'>)</span>
<a name="line-1922"></a><span class='hs-definition'>kickOutRewritable</span> <span class='hs-varid'>new_fr</span> <span class='hs-varid'>new_lhs</span> <span class='hs-varid'>ics</span>
<a name="line-1923"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>kicked_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>ics'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kick_out_rewritable</span> <span class='hs-varid'>new_fr</span> <span class='hs-varid'>new_lhs</span> <span class='hs-varid'>ics</span>
<a name="line-1924"></a>             <span class='hs-varid'>n_kicked</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>workListSize</span> <span class='hs-varid'>kicked_out</span>
<a name="line-1925"></a>
<a name="line-1926"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_kicked</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1927"></a>         <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>appendWorkList</span> <span class='hs-varid'>kicked_out</span><span class='hs-layout'>)</span>
<a name="line-1928"></a>
<a name="line-1929"></a>              <span class='hs-comment'>-- The famapp-cache contains Given evidence from the inert set.</span>
<a name="line-1930"></a>              <span class='hs-comment'>-- If we're kicking out Givens, we need to remove this evidence</span>
<a name="line-1931"></a>              <span class='hs-comment'>-- from the cache, too.</span>
<a name="line-1932"></a>            <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>kicked_given_ev_vars</span> <span class='hs-keyglyph'>=</span>
<a name="line-1933"></a>                    <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ev_var</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-varid'>kicked_out</span>
<a name="line-1934"></a>                             <span class='hs-layout'>,</span> <span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_var</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-1935"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_fr</span> <span class='hs-varop'>`eqCanRewriteFR`</span> <span class='hs-layout'>(</span><span class='hs-conid'>Given</span><span class='hs-layout'>,</span> <span class='hs-conid'>NomEq</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-1936"></a>                   <span class='hs-comment'>-- if this isn't true, no use looking through the constraints</span>
<a name="line-1937"></a>                    <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>kicked_given_ev_vars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1938"></a>              <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Given(s) have been kicked out; drop from famapp-cache"</span>
<a name="line-1939"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>kicked_given_ev_vars</span><span class='hs-layout'>)</span>
<a name="line-1940"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>dropFromFamAppCache</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>kicked_given_ev_vars</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1941"></a>
<a name="line-1942"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>csTraceTcS</span> <span class='hs-varop'>$</span>
<a name="line-1943"></a>              <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Kick out, lhs ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>new_lhs</span><span class='hs-layout'>)</span>
<a name="line-1944"></a>                 <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"n-kicked ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n_kicked</span>
<a name="line-1945"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"kicked_out ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kicked_out</span>
<a name="line-1946"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Residual inerts ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ics'</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1947"></a>
<a name="line-1948"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_kicked</span><span class='hs-layout'>,</span> <span class='hs-varid'>ics'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1949"></a>
<a name="line-1950"></a><a name="kick_out_rewritable"></a><span class='hs-definition'>kick_out_rewritable</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavourRole</span>  <span class='hs-comment'>-- Flavour/role of the equality that</span>
<a name="line-1951"></a>                                      <span class='hs-comment'>-- is being added to the inert set</span>
<a name="line-1952"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CanEqLHS</span>       <span class='hs-comment'>-- The new equality is lhs ~ ty</span>
<a name="line-1953"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-1954"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>WorkList</span><span class='hs-layout'>,</span> <span class='hs-conid'>InertCans</span><span class='hs-layout'>)</span>
<a name="line-1955"></a><span class='hs-comment'>-- See Note [kickOutRewritable]</span>
<a name="line-1956"></a><span class='hs-definition'>kick_out_rewritable</span> <span class='hs-varid'>new_fr</span> <span class='hs-varid'>new_lhs</span>
<a name="line-1957"></a>                    <span class='hs-varid'>ics</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_eqs</span>
<a name="line-1958"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dictmap</span>
<a name="line-1959"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqmap</span>
<a name="line-1960"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>irreds</span>
<a name="line-1961"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insts</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_insts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1962"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_fr</span> <span class='hs-varop'>`eqMayRewriteFR`</span> <span class='hs-varid'>new_fr</span><span class='hs-layout'>)</span>
<a name="line-1963"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyWorkList</span><span class='hs-layout'>,</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span>
<a name="line-1964"></a>        <span class='hs-comment'>-- If new_fr can't rewrite itself, it can't rewrite</span>
<a name="line-1965"></a>        <span class='hs-comment'>-- anything else, so no need to kick out anything.</span>
<a name="line-1966"></a>        <span class='hs-comment'>-- (This is a common case: wanteds can't rewrite wanteds)</span>
<a name="line-1967"></a>        <span class='hs-comment'>-- Lemma (L2) in Note [Extending the inert equalities]</span>
<a name="line-1968"></a>
<a name="line-1969"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1970"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>kicked_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_cans_in</span><span class='hs-layout'>)</span>
<a name="line-1971"></a>  <span class='hs-keyword'>where</span>
<a name="line-1972"></a>    <span class='hs-comment'>-- inert_safehask stays unchanged; is that right?</span>
<a name="line-1973"></a>    <span class='hs-varid'>inert_cans_in</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_eqs_in</span>
<a name="line-1974"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dicts_in</span>
<a name="line-1975"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>feqs_in</span>
<a name="line-1976"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>irs_in</span>
<a name="line-1977"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insts</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insts_in</span> <span class='hs-layout'>}</span>
<a name="line-1978"></a>
<a name="line-1979"></a>    <span class='hs-varid'>kicked_out</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span>
<a name="line-1980"></a>    <span class='hs-comment'>-- NB: use extendWorkList to ensure that kicked-out equalities get priority</span>
<a name="line-1981"></a>    <span class='hs-comment'>-- See Note [Prioritise equalities] (Kick-out).</span>
<a name="line-1982"></a>    <span class='hs-comment'>-- The irreds may include non-canonical (hetero-kinded) equality</span>
<a name="line-1983"></a>    <span class='hs-comment'>-- constraints, which perhaps may have become soluble after new_lhs</span>
<a name="line-1984"></a>    <span class='hs-comment'>-- is substituted; ditto the dictionaries, which may include (a~b)</span>
<a name="line-1985"></a>    <span class='hs-comment'>-- or (a~~b) constraints.</span>
<a name="line-1986"></a>    <span class='hs-varid'>kicked_out</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>extendWorkListCt</span>
<a name="line-1987"></a>                          <span class='hs-layout'>(</span><span class='hs-varid'>emptyWorkList</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_eqs_out</span> <span class='hs-varop'>++</span> <span class='hs-varid'>feqs_out</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1988"></a>                          <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>dicts_out</span> <span class='hs-varop'>`andCts`</span> <span class='hs-varid'>irs_out</span><span class='hs-layout'>)</span>
<a name="line-1989"></a>                            <span class='hs-varop'>`extendCtsList`</span> <span class='hs-varid'>insts_out</span><span class='hs-layout'>)</span>
<a name="line-1990"></a>
<a name="line-1991"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tv_eqs_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv_eqs_in</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldDVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>kick_out_eqs</span> <span class='hs-varid'>extend_tv_eqs</span><span class='hs-layout'>)</span>
<a name="line-1992"></a>                                          <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyDVarEnv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv_eqs</span>
<a name="line-1993"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>feqs_out</span><span class='hs-layout'>,</span>   <span class='hs-varid'>feqs_in</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldFunEqs</span>  <span class='hs-layout'>(</span><span class='hs-varid'>kick_out_eqs</span> <span class='hs-varid'>extend_fun_eqs</span><span class='hs-layout'>)</span>
<a name="line-1994"></a>                                          <span class='hs-varid'>funeqmap</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFunEqs</span><span class='hs-layout'>)</span>
<a name="line-1995"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>dicts_out</span><span class='hs-layout'>,</span>  <span class='hs-varid'>dicts_in</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionDicts</span>   <span class='hs-varid'>kick_out_ct</span> <span class='hs-varid'>dictmap</span>
<a name="line-1996"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>irs_out</span><span class='hs-layout'>,</span>    <span class='hs-varid'>irs_in</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionBag</span>     <span class='hs-varid'>kick_out_ct</span> <span class='hs-varid'>irreds</span>
<a name="line-1997"></a>      <span class='hs-comment'>-- Kick out even insolubles: See Note [Rewrite insolubles]</span>
<a name="line-1998"></a>      <span class='hs-comment'>-- Of course we must kick out irreducibles like (c a), in case</span>
<a name="line-1999"></a>      <span class='hs-comment'>-- we can rewrite 'c' to something more useful</span>
<a name="line-2000"></a>
<a name="line-2001"></a>    <span class='hs-comment'>-- Kick-out for inert instances</span>
<a name="line-2002"></a>    <span class='hs-comment'>-- See Note [Quantified constraints] in GHC.Tc.Solver.Canonical</span>
<a name="line-2003"></a>    <span class='hs-varid'>insts_out</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-2004"></a>    <span class='hs-varid'>insts_in</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>QCInst</span><span class='hs-keyglyph'>]</span>
<a name="line-2005"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>insts_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>insts_in</span><span class='hs-layout'>)</span>
<a name="line-2006"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fr_may_rewrite</span> <span class='hs-layout'>(</span><span class='hs-conid'>Given</span><span class='hs-layout'>,</span> <span class='hs-conid'>NomEq</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- All the insts are Givens</span>
<a name="line-2007"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionWith</span> <span class='hs-varid'>kick_out_qci</span> <span class='hs-varid'>old_insts</span>
<a name="line-2008"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2009"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>old_insts</span><span class='hs-layout'>)</span>
<a name="line-2010"></a>    <span class='hs-varid'>kick_out_qci</span> <span class='hs-varid'>qci</span>
<a name="line-2011"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>qci_ev</span> <span class='hs-varid'>qci</span>
<a name="line-2012"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>fr_can_rewrite_ty</span> <span class='hs-conid'>NomEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>qci_ev</span> <span class='hs-varid'>qci</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2013"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNonCanonical</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-2014"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2015"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>qci</span>
<a name="line-2016"></a>
<a name="line-2017"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_role</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_fr</span>
<a name="line-2018"></a>
<a name="line-2019"></a>    <span class='hs-varid'>fr_tv_can_rewrite_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqRel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2020"></a>    <span class='hs-varid'>fr_tv_can_rewrite_ty</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty</span>
<a name="line-2021"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>anyRewritableTyVar</span> <span class='hs-conid'>True</span> <span class='hs-varid'>role</span> <span class='hs-varid'>can_rewrite</span> <span class='hs-varid'>ty</span>
<a name="line-2022"></a>                  <span class='hs-comment'>-- True: ignore casts and coercions</span>
<a name="line-2023"></a>      <span class='hs-keyword'>where</span>
<a name="line-2024"></a>        <span class='hs-varid'>can_rewrite</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqRel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2025"></a>        <span class='hs-varid'>can_rewrite</span> <span class='hs-varid'>old_role</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_role</span> <span class='hs-varop'>`eqCanRewrite`</span> <span class='hs-varid'>old_role</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>==</span> <span class='hs-varid'>new_tv</span>
<a name="line-2026"></a>
<a name="line-2027"></a>    <span class='hs-varid'>fr_tf_can_rewrite_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqRel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2028"></a>    <span class='hs-varid'>fr_tf_can_rewrite_ty</span> <span class='hs-varid'>new_tf</span> <span class='hs-varid'>new_tf_args</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty</span>
<a name="line-2029"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>anyRewritableTyFamApp</span> <span class='hs-varid'>role</span> <span class='hs-varid'>can_rewrite</span> <span class='hs-varid'>ty</span>
<a name="line-2030"></a>      <span class='hs-keyword'>where</span>
<a name="line-2031"></a>        <span class='hs-varid'>can_rewrite</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqRel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2032"></a>        <span class='hs-varid'>can_rewrite</span> <span class='hs-varid'>old_role</span> <span class='hs-varid'>old_tf</span> <span class='hs-varid'>old_tf_args</span>
<a name="line-2033"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_role</span> <span class='hs-varop'>`eqCanRewrite`</span> <span class='hs-varid'>old_role</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-2034"></a>            <span class='hs-varid'>tcEqTyConApps</span> <span class='hs-varid'>new_tf</span> <span class='hs-varid'>new_tf_args</span> <span class='hs-varid'>old_tf</span> <span class='hs-varid'>old_tf_args</span>
<a name="line-2035"></a>              <span class='hs-comment'>-- it's possible for old_tf_args to have too many. This is fine;</span>
<a name="line-2036"></a>              <span class='hs-comment'>-- we'll only check what we need to.</span>
<a name="line-2037"></a>
<a name="line-2038"></a>    <span class='hs-comment'>{-# INLINE fr_can_rewrite_ty #-}</span>   <span class='hs-comment'>-- perform the check here only once</span>
<a name="line-2039"></a>    <span class='hs-varid'>fr_can_rewrite_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqRel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2040"></a>    <span class='hs-varid'>fr_can_rewrite_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>new_lhs</span> <span class='hs-keyword'>of</span>
<a name="line-2041"></a>      <span class='hs-conid'>TyVarLHS</span> <span class='hs-varid'>new_tv</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fr_tv_can_rewrite_ty</span> <span class='hs-varid'>new_tv</span>
<a name="line-2042"></a>      <span class='hs-conid'>TyFamLHS</span> <span class='hs-varid'>new_tf</span> <span class='hs-varid'>new_tf_args</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fr_tf_can_rewrite_ty</span> <span class='hs-varid'>new_tf</span> <span class='hs-varid'>new_tf_args</span>
<a name="line-2043"></a>
<a name="line-2044"></a>    <span class='hs-varid'>fr_may_rewrite</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavourRole</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2045"></a>    <span class='hs-varid'>fr_may_rewrite</span> <span class='hs-varid'>fs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_fr</span> <span class='hs-varop'>`eqMayRewriteFR`</span> <span class='hs-varid'>fs</span>
<a name="line-2046"></a>        <span class='hs-comment'>-- Can the new item rewrite the inert item?</span>
<a name="line-2047"></a>
<a name="line-2048"></a>    <span class='hs-comment'>{-# INLINE kick_out_ct #-}</span>   <span class='hs-comment'>-- perform case on new_lhs here only once</span>
<a name="line-2049"></a>    <span class='hs-varid'>kick_out_ct</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2050"></a>    <span class='hs-comment'>-- Kick it out if the new CEqCan can rewrite the inert one</span>
<a name="line-2051"></a>    <span class='hs-comment'>-- See Note [kickOutRewritable]</span>
<a name="line-2052"></a>    <span class='hs-varid'>kick_out_ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>new_lhs</span> <span class='hs-keyword'>of</span>
<a name="line-2053"></a>      <span class='hs-conid'>TyVarLHS</span> <span class='hs-varid'>new_tv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fs</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>role</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctFlavourRole</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>in</span>
<a name="line-2054"></a>                                <span class='hs-varid'>fr_may_rewrite</span> <span class='hs-varid'>fs</span>
<a name="line-2055"></a>                             <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>fr_tv_can_rewrite_ty</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-2056"></a>      <span class='hs-conid'>TyFamLHS</span> <span class='hs-varid'>new_tf</span> <span class='hs-varid'>new_tf_args</span>
<a name="line-2057"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fs</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>role</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctFlavourRole</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>in</span>
<a name="line-2058"></a>                  <span class='hs-varid'>fr_may_rewrite</span> <span class='hs-varid'>fs</span>
<a name="line-2059"></a>               <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>fr_tf_can_rewrite_ty</span> <span class='hs-varid'>new_tf</span> <span class='hs-varid'>new_tf_args</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-2060"></a>
<a name="line-2061"></a>    <span class='hs-varid'>extend_tv_eqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertEqs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CanEqLHS</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertEqs</span>
<a name="line-2062"></a>    <span class='hs-varid'>extend_tv_eqs</span> <span class='hs-varid'>eqs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarLHS</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendDVarEnv</span> <span class='hs-varid'>eqs</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>cts</span>
<a name="line-2063"></a>    <span class='hs-varid'>extend_tv_eqs</span> <span class='hs-varid'>eqs</span> <span class='hs-varid'>other</span> <span class='hs-sel'>_cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"extend_tv_eqs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>eqs</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
<a name="line-2064"></a>
<a name="line-2065"></a>    <span class='hs-varid'>extend_fun_eqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CanEqLHS</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqualCtList</span>
<a name="line-2066"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>EqualCtList</span>
<a name="line-2067"></a>    <span class='hs-varid'>extend_fun_eqs</span> <span class='hs-varid'>eqs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyFamLHS</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>fam_args</span><span class='hs-layout'>)</span> <span class='hs-varid'>cts</span>
<a name="line-2068"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertTcApp</span> <span class='hs-varid'>eqs</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>fam_args</span> <span class='hs-varid'>cts</span>
<a name="line-2069"></a>    <span class='hs-varid'>extend_fun_eqs</span> <span class='hs-varid'>eqs</span> <span class='hs-varid'>other</span> <span class='hs-sel'>_cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"extend_fun_eqs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>eqs</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
<a name="line-2070"></a>
<a name="line-2071"></a>    <span class='hs-varid'>kick_out_eqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>container</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CanEqLHS</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>container</span><span class='hs-layout'>)</span>
<a name="line-2072"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>container</span><span class='hs-layout'>)</span>
<a name="line-2073"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>container</span><span class='hs-layout'>)</span>
<a name="line-2074"></a>    <span class='hs-varid'>kick_out_eqs</span> <span class='hs-varid'>extend</span> <span class='hs-varid'>eqs</span> <span class='hs-layout'>(</span><span class='hs-varid'>acc_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc_in</span><span class='hs-layout'>)</span>
<a name="line-2075"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqs_out</span> <span class='hs-varop'>`chkAppend`</span> <span class='hs-varid'>acc_out</span><span class='hs-layout'>,</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>listToEqualCtList</span> <span class='hs-varid'>eqs_in</span> <span class='hs-keyword'>of</span>
<a name="line-2076"></a>            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>acc_in</span>
<a name="line-2077"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>eqs_in_ecl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EqualCtList</span> <span class='hs-layout'>(</span><span class='hs-varid'>eq1</span> <span class='hs-conop'>:|</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2078"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extend</span> <span class='hs-varid'>acc_in</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_lhs</span> <span class='hs-varid'>eq1</span><span class='hs-layout'>)</span> <span class='hs-varid'>eqs_in_ecl</span><span class='hs-layout'>)</span>
<a name="line-2079"></a>      <span class='hs-keyword'>where</span>
<a name="line-2080"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>eqs_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqs_in</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>kick_out_eq</span> <span class='hs-layout'>(</span><span class='hs-varid'>equalCtListToList</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>)</span>
<a name="line-2081"></a>
<a name="line-2082"></a>    <span class='hs-comment'>-- Implements criteria K1-K3 in Note [Extending the inert equalities]</span>
<a name="line-2083"></a>    <span class='hs-varid'>kick_out_eq</span> <span class='hs-layout'>(</span><span class='hs-conid'>CEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-2084"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_eq_rel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq_rel</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2085"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>fr_may_rewrite</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span>
<a name="line-2086"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>  <span class='hs-comment'>-- (K0) Keep it in the inert set if the new thing can't rewrite it</span>
<a name="line-2087"></a>
<a name="line-2088"></a>      <span class='hs-comment'>-- Below here (fr_may_rewrite fs) is True</span>
<a name="line-2089"></a>
<a name="line-2090"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyVarLHS</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lhs</span>
<a name="line-2091"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>fs</span> <span class='hs-varop'>`eqMayRewriteFR`</span> <span class='hs-varid'>new_fr</span>
<a name="line-2092"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>  <span class='hs-comment'>-- (K4) Keep it in the inert set if the LHS is a tyvar and</span>
<a name="line-2093"></a>               <span class='hs-comment'>-- it can rewrite the work item. See Note [K4]</span>
<a name="line-2094"></a>
<a name="line-2095"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fr_can_rewrite_ty</span> <span class='hs-varid'>eq_rel</span> <span class='hs-layout'>(</span><span class='hs-varid'>canEqLHSType</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>)</span>
<a name="line-2096"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>   <span class='hs-comment'>-- (K1)</span>
<a name="line-2097"></a>         <span class='hs-comment'>-- The above check redundantly checks the role &amp; flavour,</span>
<a name="line-2098"></a>         <span class='hs-comment'>-- but it's very convenient</span>
<a name="line-2099"></a>
<a name="line-2100"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kick_out_for_inertness</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>   <span class='hs-comment'>-- (K2)</span>
<a name="line-2101"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kick_out_for_completeness</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>   <span class='hs-comment'>-- (K3)</span>
<a name="line-2102"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2103"></a>
<a name="line-2104"></a>      <span class='hs-keyword'>where</span>
<a name="line-2105"></a>        <span class='hs-varid'>fs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvFlavour</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>eq_rel</span><span class='hs-layout'>)</span>
<a name="line-2106"></a>        <span class='hs-varid'>kick_out_for_inertness</span>
<a name="line-2107"></a>          <span class='hs-keyglyph'>=</span>    <span class='hs-layout'>(</span><span class='hs-varid'>fs</span> <span class='hs-varop'>`eqMayRewriteFR`</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span>           <span class='hs-comment'>-- (K2a)</span>
<a name="line-2108"></a>            <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>fr_can_rewrite_ty</span> <span class='hs-varid'>eq_rel</span> <span class='hs-varid'>rhs_ty</span>    <span class='hs-comment'>-- (K2b)</span>
<a name="line-2109"></a>
<a name="line-2110"></a>        <span class='hs-varid'>kick_out_for_completeness</span>  <span class='hs-comment'>-- (K3) and Note [K3: completeness of solving]</span>
<a name="line-2111"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>eq_rel</span> <span class='hs-keyword'>of</span>
<a name="line-2112"></a>              <span class='hs-conid'>NomEq</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rhs_ty</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>canEqLHSType</span> <span class='hs-varid'>new_lhs</span> <span class='hs-comment'>-- (K3a)</span>
<a name="line-2113"></a>              <span class='hs-conid'>ReprEq</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>is_can_eq_lhs_head</span> <span class='hs-varid'>new_lhs</span> <span class='hs-varid'>rhs_ty</span>    <span class='hs-comment'>-- (K3b)</span>
<a name="line-2114"></a>
<a name="line-2115"></a>    <span class='hs-varid'>kick_out_eq</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"keep_eq"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-2116"></a>
<a name="line-2117"></a>    <span class='hs-varid'>is_can_eq_lhs_head</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarLHS</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span>
<a name="line-2118"></a>      <span class='hs-keyword'>where</span>
<a name="line-2119"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rep.TyVarTy</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tv'</span>
<a name="line-2120"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rep.AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>fun</span>
<a name="line-2121"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rep.CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-2122"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rep.TyConApp</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2123"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rep.LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2124"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rep.ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2125"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rep.FunTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2126"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rep.CoercionTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2127"></a>    <span class='hs-varid'>is_can_eq_lhs_head</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyFamLHS</span> <span class='hs-varid'>fun_tc</span> <span class='hs-varid'>fun_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span>
<a name="line-2128"></a>      <span class='hs-keyword'>where</span>
<a name="line-2129"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rep.TyVarTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2130"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rep.AppTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>  <span class='hs-comment'>-- no TyConApp to the left of an AppTy</span>
<a name="line-2131"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rep.CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-2132"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rep.TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcEqTyConApps</span> <span class='hs-varid'>fun_tc</span> <span class='hs-varid'>fun_args</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span>
<a name="line-2133"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rep.LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2134"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rep.ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2135"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rep.FunTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2136"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rep.CoercionTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2137"></a>
<a name="line-2138"></a><a name="kickOutAfterUnification"></a><span class='hs-definition'>kickOutAfterUnification</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Int</span>
<a name="line-2139"></a><span class='hs-definition'>kickOutAfterUnification</span> <span class='hs-varid'>new_tv</span>
<a name="line-2140"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-2141"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_kicked</span><span class='hs-layout'>,</span> <span class='hs-varid'>ics2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kickOutRewritable</span> <span class='hs-layout'>(</span><span class='hs-conid'>Given</span><span class='hs-layout'>,</span><span class='hs-conid'>NomEq</span><span class='hs-layout'>)</span>
<a name="line-2142"></a>                                                 <span class='hs-layout'>(</span><span class='hs-conid'>TyVarLHS</span> <span class='hs-varid'>new_tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ics</span>
<a name="line-2143"></a>                     <span class='hs-comment'>-- Given because the tv := xi is given; NomEq because</span>
<a name="line-2144"></a>                     <span class='hs-comment'>-- only nominal equalities are solved by unification</span>
<a name="line-2145"></a>
<a name="line-2146"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setInertCans</span> <span class='hs-varid'>ics2</span>
<a name="line-2147"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>n_kicked</span> <span class='hs-layout'>}</span>
<a name="line-2148"></a>
<a name="line-2149"></a><a name="kickOutAfterFillingCoercionHole"></a><span class='hs-comment'>-- See Wrinkle (2) in Note [Equalities with incompatible kinds] in GHC.Tc.Solver.Canonical</span>
<a name="line-2150"></a><span class='hs-definition'>kickOutAfterFillingCoercionHole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoercionHole</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2151"></a><span class='hs-definition'>kickOutAfterFillingCoercionHole</span> <span class='hs-varid'>hole</span> <span class='hs-varid'>filled_co</span>
<a name="line-2152"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-2153"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>kicked_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>ics'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kick_out</span> <span class='hs-varid'>ics</span>
<a name="line-2154"></a>             <span class='hs-varid'>n_kicked</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>workListSize</span> <span class='hs-varid'>kicked_out</span>
<a name="line-2155"></a>
<a name="line-2156"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_kicked</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-2157"></a>         <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>appendWorkList</span> <span class='hs-varid'>kicked_out</span><span class='hs-layout'>)</span>
<a name="line-2158"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>csTraceTcS</span> <span class='hs-varop'>$</span>
<a name="line-2159"></a>              <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Kick out, hole ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>hole</span><span class='hs-layout'>)</span>
<a name="line-2160"></a>                 <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"n-kicked ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n_kicked</span>
<a name="line-2161"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"kicked_out ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kicked_out</span>
<a name="line-2162"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Residual inerts ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ics'</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2163"></a>
<a name="line-2164"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setInertCans</span> <span class='hs-varid'>ics'</span> <span class='hs-layout'>}</span>
<a name="line-2165"></a>  <span class='hs-keyword'>where</span>
<a name="line-2166"></a>    <span class='hs-varid'>holes_of_co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionHolesOfCo</span> <span class='hs-varid'>filled_co</span>
<a name="line-2167"></a>
<a name="line-2168"></a>    <span class='hs-varid'>kick_out</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>WorkList</span><span class='hs-layout'>,</span> <span class='hs-conid'>InertCans</span><span class='hs-layout'>)</span>
<a name="line-2169"></a>    <span class='hs-varid'>kick_out</span> <span class='hs-varid'>ics</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_blocked</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>blocked</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2170"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>to_kick</span><span class='hs-layout'>,</span> <span class='hs-varid'>to_keep</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionBagWith</span> <span class='hs-varid'>kick_ct</span> <span class='hs-varid'>blocked</span>
<a name="line-2171"></a>
<a name="line-2172"></a>            <span class='hs-varid'>kicked_out</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendWorkListCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>to_kick</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyWorkList</span>
<a name="line-2173"></a>            <span class='hs-varid'>ics'</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_blocked</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>to_keep</span> <span class='hs-layout'>}</span>
<a name="line-2174"></a>        <span class='hs-keyword'>in</span>
<a name="line-2175"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>kicked_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>ics'</span><span class='hs-layout'>)</span>
<a name="line-2176"></a>
<a name="line-2177"></a>    <span class='hs-varid'>kick_ct</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>Ct</span> <span class='hs-conid'>Ct</span>
<a name="line-2178"></a>         <span class='hs-comment'>-- Left: kick out; Right: keep. But even if we keep, we may need</span>
<a name="line-2179"></a>         <span class='hs-comment'>-- to update the set of blocking holes</span>
<a name="line-2180"></a>    <span class='hs-varid'>kick_ct</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CIrredCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_reason</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HoleBlockerReason</span> <span class='hs-varid'>holes</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2181"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>hole</span> <span class='hs-varop'>`elementOfUniqSet`</span> <span class='hs-varid'>holes</span>
<a name="line-2182"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_holes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>holes</span> <span class='hs-varop'>`delOneFromUniqSet`</span> <span class='hs-varid'>hole</span>
<a name="line-2183"></a>                              <span class='hs-varop'>`unionUniqSets`</span> <span class='hs-varid'>holes_of_co</span>
<a name="line-2184"></a>            <span class='hs-varid'>updated_ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_reason</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HoleBlockerReason</span> <span class='hs-varid'>new_holes</span> <span class='hs-layout'>}</span>
<a name="line-2185"></a>        <span class='hs-keyword'>in</span>
<a name="line-2186"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>isEmptyUniqSet</span> <span class='hs-varid'>new_holes</span>
<a name="line-2187"></a>        <span class='hs-keyword'>then</span> <span class='hs-conid'>Left</span> <span class='hs-varid'>updated_ct</span>
<a name="line-2188"></a>        <span class='hs-keyword'>else</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>updated_ct</span>
<a name="line-2189"></a>
<a name="line-2190"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2191"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>ct</span>
<a name="line-2192"></a>
<a name="line-2193"></a>    <span class='hs-varid'>kick_ct</span> <span class='hs-varid'>other</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"kickOutAfterFillingCoercionHole"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
<a name="line-2194"></a>
<a name="line-2195"></a><span class='hs-comment'>{- Note [kickOutRewritable]
<a name="line-2196"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2197"></a>See also Note [inert_eqs: the inert equalities].
<a name="line-2198"></a>
<a name="line-2199"></a>When we add a new inert equality (lhs ~N ty) to the inert set,
<a name="line-2200"></a>we must kick out any inert items that could be rewritten by the
<a name="line-2201"></a>new equality, to maintain the inert-set invariants.
<a name="line-2202"></a>
<a name="line-2203"></a>  - We want to kick out an existing inert constraint if
<a name="line-2204"></a>    a) the new constraint can rewrite the inert one
<a name="line-2205"></a>    b) 'lhs' is free in the inert constraint (so that it *will*)
<a name="line-2206"></a>       rewrite it if we kick it out.
<a name="line-2207"></a>
<a name="line-2208"></a>    For (b) we use anyRewritableCanLHS, which examines the types /and
<a name="line-2209"></a>    kinds/ that are directly visible in the type. Hence
<a name="line-2210"></a>    we will have exposed all the rewriting we care about to make the
<a name="line-2211"></a>    most precise kinds visible for matching classes etc. No need to
<a name="line-2212"></a>    kick out constraints that mention type variables whose kinds
<a name="line-2213"></a>    contain this LHS!
<a name="line-2214"></a>
<a name="line-2215"></a>  - A Derived equality can kick out [D] constraints in inert_eqs,
<a name="line-2216"></a>    inert_dicts, inert_irreds etc.
<a name="line-2217"></a>
<a name="line-2218"></a>  - We don't kick out constraints from inert_solved_dicts, and
<a name="line-2219"></a>    inert_solved_funeqs optimistically. But when we lookup we have to
<a name="line-2220"></a>    take the substitution into account
<a name="line-2221"></a>
<a name="line-2222"></a>NB: we could in principle avoid kick-out:
<a name="line-2223"></a>  a) When unifying a meta-tyvar from an outer level, because
<a name="line-2224"></a>     then the entire implication will be iterated; see
<a name="line-2225"></a>     Note [The Unification Level Flag]
<a name="line-2226"></a>
<a name="line-2227"></a>  b) For Givens, after a unification.  By (GivenInv) in GHC.Tc.Utils.TcType
<a name="line-2228"></a>     Note [TcLevel invariants], a Given can't include a meta-tyvar from
<a name="line-2229"></a>     its own level, so it falls under (a).  Of course, we must still
<a name="line-2230"></a>     kick out Givens when adding a new non-unification Given.
<a name="line-2231"></a>
<a name="line-2232"></a>But kicking out more vigorously may lead to earlier unification and fewer
<a name="line-2233"></a>iterations, so we don't take advantage of these possibilities.
<a name="line-2234"></a>
<a name="line-2235"></a>Note [Rewrite insolubles]
<a name="line-2236"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2237"></a>Suppose we have an insoluble alpha ~ [alpha], which is insoluble
<a name="line-2238"></a>because an occurs check.  And then we unify alpha := [Int].  Then we
<a name="line-2239"></a>really want to rewrite the insoluble to [Int] ~ [[Int]].  Now it can
<a name="line-2240"></a>be decomposed.  Otherwise we end up with a "Can't match [Int] ~
<a name="line-2241"></a>[[Int]]" which is true, but a bit confusing because the outer type
<a name="line-2242"></a>constructors match.
<a name="line-2243"></a>
<a name="line-2244"></a>Hence:
<a name="line-2245"></a> * In the main simplifier loops in GHC.Tc.Solver (solveWanteds,
<a name="line-2246"></a>   simpl_loop), we feed the insolubles in solveSimpleWanteds,
<a name="line-2247"></a>   so that they get rewritten (albeit not solved).
<a name="line-2248"></a>
<a name="line-2249"></a> * We kick insolubles out of the inert set, if they can be
<a name="line-2250"></a>   rewritten (see GHC.Tc.Solver.Monad.kick_out_rewritable)
<a name="line-2251"></a>
<a name="line-2252"></a> * We rewrite those insolubles in GHC.Tc.Solver.Canonical.
<a name="line-2253"></a>   See Note [Make sure that insolubles are fully rewritten]
<a name="line-2254"></a>-}</span>
<a name="line-2255"></a>
<a name="line-2256"></a>
<a name="line-2257"></a>
<a name="line-2258"></a><a name="addInertSafehask"></a><span class='hs-comment'>--------------</span>
<a name="line-2259"></a><span class='hs-definition'>addInertSafehask</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-2260"></a><span class='hs-definition'>addInertSafehask</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2261"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addDictCt</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span> <span class='hs-layout'>}</span>
<a name="line-2262"></a>
<a name="line-2263"></a><span class='hs-definition'>addInertSafehask</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>item</span>
<a name="line-2264"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"addInertSafehask: can't happen! Inserting "</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>item</span>
<a name="line-2265"></a>
<a name="line-2266"></a><a name="insertSafeOverlapFailureTcS"></a><span class='hs-definition'>insertSafeOverlapFailureTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InstanceWhat</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2267"></a><span class='hs-comment'>-- See Note [Safe Haskell Overlapping Instances Implementation] in GHC.Tc.Solver</span>
<a name="line-2268"></a><span class='hs-definition'>insertSafeOverlapFailureTcS</span> <span class='hs-varid'>what</span> <span class='hs-varid'>item</span>
<a name="line-2269"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>safeOverlap</span> <span class='hs-varid'>what</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-2270"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertCans</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>addInertSafehask</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>item</span><span class='hs-layout'>)</span>
<a name="line-2271"></a>
<a name="line-2272"></a><a name="getSafeOverlapFailures"></a><span class='hs-definition'>getSafeOverlapFailures</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Cts</span>
<a name="line-2273"></a><span class='hs-comment'>-- See Note [Safe Haskell Overlapping Instances Implementation] in GHC.Tc.Solver</span>
<a name="line-2274"></a><span class='hs-definition'>getSafeOverlapFailures</span>
<a name="line-2275"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>safehask</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-2276"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>foldDicts</span> <span class='hs-varid'>consCts</span> <span class='hs-varid'>safehask</span> <span class='hs-varid'>emptyCts</span> <span class='hs-layout'>}</span>
<a name="line-2277"></a>
<a name="line-2278"></a><a name="addSolvedDict"></a><span class='hs-comment'>--------------</span>
<a name="line-2279"></a><span class='hs-definition'>addSolvedDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InstanceWhat</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2280"></a><span class='hs-comment'>-- Conditionally add a new item in the solved set of the monad</span>
<a name="line-2281"></a><span class='hs-comment'>-- See Note [Solved dictionaries]</span>
<a name="line-2282"></a><span class='hs-definition'>addSolvedDict</span> <span class='hs-varid'>what</span> <span class='hs-varid'>item</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-2283"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isWanted</span> <span class='hs-varid'>item</span>
<a name="line-2284"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>instanceReturnsDictCon</span> <span class='hs-varid'>what</span>
<a name="line-2285"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"updSolvedSetTcs:"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>item</span>
<a name="line-2286"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2287"></a>             <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addDict</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_solved_dicts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-2288"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2289"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-2290"></a>
<a name="line-2291"></a><a name="getSolvedDicts"></a><span class='hs-definition'>getSolvedDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>DictMap</span> <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>)</span>
<a name="line-2292"></a><span class='hs-definition'>getSolvedDicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_solved_dicts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2293"></a>
<a name="line-2294"></a><a name="setSolvedDicts"></a><span class='hs-definition'>setSolvedDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2295"></a><span class='hs-definition'>setSolvedDicts</span> <span class='hs-varid'>solved_dicts</span>
<a name="line-2296"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2297"></a>    <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>solved_dicts</span> <span class='hs-layout'>}</span>
<a name="line-2298"></a>
<a name="line-2299"></a>
<a name="line-2300"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-2301"></a>*                                                                      *
<a name="line-2302"></a>                  Other inert-set operations
<a name="line-2303"></a>*                                                                      *
<a name="line-2304"></a>********************************************************************* -}</span>
<a name="line-2305"></a>
<a name="line-2306"></a><a name="updInertTcS"></a><span class='hs-definition'>updInertTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertSet</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2307"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-2308"></a><span class='hs-definition'>updInertTcS</span> <span class='hs-varid'>upd_fn</span>
<a name="line-2309"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInertsRef</span>
<a name="line-2310"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>curr_inert</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>is_var</span>
<a name="line-2311"></a>                     <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.writeTcRef</span> <span class='hs-varid'>is_var</span> <span class='hs-layout'>(</span><span class='hs-varid'>upd_fn</span> <span class='hs-varid'>curr_inert</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2312"></a>
<a name="line-2313"></a><a name="getInertCans"></a><span class='hs-definition'>getInertCans</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>InertCans</span>
<a name="line-2314"></a><span class='hs-definition'>getInertCans</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2315"></a>
<a name="line-2316"></a><a name="setInertCans"></a><span class='hs-definition'>setInertCans</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2317"></a><span class='hs-definition'>setInertCans</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>inerts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>}</span>
<a name="line-2318"></a>
<a name="line-2319"></a><a name="updRetInertCans"></a><span class='hs-definition'>updRetInertCans</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>InertCans</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2320"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-2321"></a><span class='hs-definition'>updRetInertCans</span> <span class='hs-varid'>upd_fn</span>
<a name="line-2322"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInertsRef</span>
<a name="line-2323"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>is_var</span>
<a name="line-2324"></a>                     <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>cans'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span>
<a name="line-2325"></a>                     <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.writeTcRef</span> <span class='hs-varid'>is_var</span> <span class='hs-layout'>(</span><span class='hs-varid'>inerts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cans'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2326"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2327"></a>
<a name="line-2328"></a><a name="updInertCans"></a><span class='hs-definition'>updInertCans</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2329"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-2330"></a><span class='hs-definition'>updInertCans</span> <span class='hs-varid'>upd_fn</span>
<a name="line-2331"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>inerts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2332"></a>
<a name="line-2333"></a><a name="updInertDicts"></a><span class='hs-definition'>updInertDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2334"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-2335"></a><span class='hs-definition'>updInertDicts</span> <span class='hs-varid'>upd_fn</span>
<a name="line-2336"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertCans</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2337"></a>
<a name="line-2338"></a><a name="updInertSafehask"></a><span class='hs-definition'>updInertSafehask</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2339"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-2340"></a><span class='hs-definition'>updInertSafehask</span> <span class='hs-varid'>upd_fn</span>
<a name="line-2341"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertCans</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_safehask</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2342"></a>
<a name="line-2343"></a><a name="updInertIrreds"></a><span class='hs-definition'>updInertIrreds</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2344"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-2345"></a><span class='hs-definition'>updInertIrreds</span> <span class='hs-varid'>upd_fn</span>
<a name="line-2346"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertCans</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2347"></a>
<a name="line-2348"></a><a name="getInertEqs"></a><span class='hs-definition'>getInertEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>DTyVarEnv</span> <span class='hs-conid'>EqualCtList</span><span class='hs-layout'>)</span>
<a name="line-2349"></a><span class='hs-definition'>getInertEqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>inert</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2350"></a>
<a name="line-2351"></a><a name="getInnermostGivenEqLevel"></a><span class='hs-definition'>getInnermostGivenEqLevel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcLevel</span>
<a name="line-2352"></a><span class='hs-definition'>getInnermostGivenEqLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-2353"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_given_eq_lvl</span> <span class='hs-varid'>inert</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2354"></a>
<a name="line-2355"></a><a name="getInertInsols"></a><span class='hs-definition'>getInertInsols</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Cts</span>
<a name="line-2356"></a><span class='hs-comment'>-- Returns insoluble equality constraints</span>
<a name="line-2357"></a><span class='hs-comment'>-- specifically including Givens</span>
<a name="line-2358"></a><span class='hs-definition'>getInertInsols</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-2359"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>filterBag</span> <span class='hs-varid'>insolubleEqCt</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>inert</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2360"></a>
<a name="line-2361"></a><a name="getInertGivens"></a><span class='hs-definition'>getInertGivens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-2362"></a><span class='hs-comment'>-- Returns the Given constraints in the inert set</span>
<a name="line-2363"></a><span class='hs-definition'>getInertGivens</span>
<a name="line-2364"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-2365"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>all_cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldDicts</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span>
<a name="line-2366"></a>                     <span class='hs-varop'>$</span> <span class='hs-varid'>foldFunEqs</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ecl</span> <span class='hs-varid'>out</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>equalCtListToList</span> <span class='hs-varid'>ecl</span> <span class='hs-varop'>++</span> <span class='hs-varid'>out</span><span class='hs-layout'>)</span>
<a name="line-2367"></a>                                  <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span>
<a name="line-2368"></a>                     <span class='hs-varop'>$</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>equalCtListToList</span> <span class='hs-layout'>(</span><span class='hs-varid'>dVarEnvElts</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2369"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-varid'>isGivenCt</span> <span class='hs-varid'>all_cts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2370"></a>
<a name="line-2371"></a><a name="getPendingGivenScs"></a><span class='hs-definition'>getPendingGivenScs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-2372"></a><span class='hs-comment'>-- Find all inert Given dictionaries, or quantified constraints,</span>
<a name="line-2373"></a><span class='hs-comment'>--     whose cc_pend_sc flag is True</span>
<a name="line-2374"></a><span class='hs-comment'>--     and that belong to the current level</span>
<a name="line-2375"></a><span class='hs-comment'>-- Set their cc_pend_sc flag to False in the inert set, and return that Ct</span>
<a name="line-2376"></a><span class='hs-definition'>getPendingGivenScs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcLevel</span>
<a name="line-2377"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>updRetInertCans</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_sc_pending</span> <span class='hs-varid'>lvl</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2378"></a>
<a name="line-2379"></a><a name="get_sc_pending"></a><span class='hs-definition'>get_sc_pending</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>InertCans</span><span class='hs-layout'>)</span>
<a name="line-2380"></a><span class='hs-definition'>get_sc_pending</span> <span class='hs-varid'>this_lvl</span> <span class='hs-varid'>ic</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dicts</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2381"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isGivenCt</span> <span class='hs-varid'>sc_pending</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sc_pending</span> <span class='hs-layout'>)</span>
<a name="line-2382"></a>       <span class='hs-comment'>-- When getPendingScDics is called,</span>
<a name="line-2383"></a>       <span class='hs-comment'>-- there are never any Wanteds in the inert set</span>
<a name="line-2384"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>sc_pending</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dicts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insts'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2385"></a>  <span class='hs-keyword'>where</span>
<a name="line-2386"></a>    <span class='hs-varid'>sc_pending</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sc_pend_insts</span> <span class='hs-varop'>++</span> <span class='hs-varid'>sc_pend_dicts</span>
<a name="line-2387"></a>
<a name="line-2388"></a>    <span class='hs-varid'>sc_pend_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldDicts</span> <span class='hs-varid'>get_pending</span> <span class='hs-varid'>dicts</span> <span class='hs-conid'>[]</span>
<a name="line-2389"></a>    <span class='hs-varid'>dicts'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>add</span> <span class='hs-varid'>dicts</span> <span class='hs-varid'>sc_pend_dicts</span>
<a name="line-2390"></a>
<a name="line-2391"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>sc_pend_insts</span><span class='hs-layout'>,</span> <span class='hs-varid'>insts'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>get_pending_inst</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>insts</span>
<a name="line-2392"></a>
<a name="line-2393"></a>    <span class='hs-varid'>get_pending</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- Get dicts with cc_pend_sc = True</span>
<a name="line-2394"></a>                                       <span class='hs-comment'>-- but flipping the flag</span>
<a name="line-2395"></a>    <span class='hs-varid'>get_pending</span> <span class='hs-varid'>dict</span> <span class='hs-varid'>dicts</span>
<a name="line-2396"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>dict'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isPendingScDict</span> <span class='hs-varid'>dict</span>
<a name="line-2397"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>belongs_to_this_level</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>dict</span><span class='hs-layout'>)</span>
<a name="line-2398"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dict'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>dicts</span>
<a name="line-2399"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2400"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dicts</span>
<a name="line-2401"></a>
<a name="line-2402"></a>    <span class='hs-varid'>add</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span>
<a name="line-2403"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>dicts</span>
<a name="line-2404"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addDictCt</span> <span class='hs-varid'>dicts</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ct</span>
<a name="line-2405"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"getPendingScDicts"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-2406"></a>
<a name="line-2407"></a>    <span class='hs-varid'>get_pending_inst</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QCInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>QCInst</span><span class='hs-layout'>)</span>
<a name="line-2408"></a>    <span class='hs-varid'>get_pending_inst</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>qci</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>QCI</span> <span class='hs-layout'>{</span> <span class='hs-varid'>qci_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2409"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>qci'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isPendingScInst</span> <span class='hs-varid'>qci</span>
<a name="line-2410"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>belongs_to_this_level</span> <span class='hs-varid'>ev</span>
<a name="line-2411"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>CQuantCan</span> <span class='hs-varid'>qci'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>cts</span><span class='hs-layout'>,</span> <span class='hs-varid'>qci'</span><span class='hs-layout'>)</span>
<a name="line-2412"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2413"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span> <span class='hs-varid'>qci</span><span class='hs-layout'>)</span>
<a name="line-2414"></a>
<a name="line-2415"></a>    <span class='hs-varid'>belongs_to_this_level</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctLocLevel</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvLoc</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-varop'>==</span> <span class='hs-varid'>this_lvl</span>
<a name="line-2416"></a>    <span class='hs-comment'>-- We only want Givens from this level; see (3a) in</span>
<a name="line-2417"></a>    <span class='hs-comment'>-- Note [The superclass story] in GHC.Tc.Solver.Canonical</span>
<a name="line-2418"></a>
<a name="line-2419"></a><a name="getUnsolvedInerts"></a><span class='hs-definition'>getUnsolvedInerts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span>
<a name="line-2420"></a>                         <span class='hs-layout'>,</span> <span class='hs-conid'>Cts</span> <span class='hs-layout'>)</span>   <span class='hs-comment'>-- All simple constraints</span>
<a name="line-2421"></a><span class='hs-comment'>-- Return all the unsolved [Wanted] or [Derived] constraints</span>
<a name="line-2422"></a><span class='hs-comment'>--</span>
<a name="line-2423"></a><span class='hs-comment'>-- Post-condition: the returned simple constraints are all fully zonked</span>
<a name="line-2424"></a><span class='hs-comment'>--                     (because they come from the inert set)</span>
<a name="line-2425"></a><span class='hs-comment'>--                 the unsolved implics may not be</span>
<a name="line-2426"></a><span class='hs-definition'>getUnsolvedInerts</span>
<a name="line-2427"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_eqs</span>
<a name="line-2428"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fun_eqs</span>
<a name="line-2429"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>irreds</span>
<a name="line-2430"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>inert_blocked</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>blocked</span>
<a name="line-2431"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idicts</span>
<a name="line-2432"></a>           <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-2433"></a>
<a name="line-2434"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>unsolved_tv_eqs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTyEqs</span> <span class='hs-varid'>add_if_unsolved</span> <span class='hs-varid'>tv_eqs</span> <span class='hs-varid'>emptyCts</span>
<a name="line-2435"></a>            <span class='hs-varid'>unsolved_fun_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldFunEqs</span> <span class='hs-varid'>add_if_unsolveds</span> <span class='hs-varid'>fun_eqs</span> <span class='hs-varid'>emptyCts</span>
<a name="line-2436"></a>            <span class='hs-varid'>unsolved_irreds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bag.filterBag</span> <span class='hs-varid'>is_unsolved</span> <span class='hs-varid'>irreds</span>
<a name="line-2437"></a>            <span class='hs-varid'>unsolved_blocked</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>blocked</span>  <span class='hs-comment'>-- all blocked equalities are W/D</span>
<a name="line-2438"></a>            <span class='hs-varid'>unsolved_dicts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldDicts</span> <span class='hs-varid'>add_if_unsolved</span> <span class='hs-varid'>idicts</span> <span class='hs-varid'>emptyCts</span>
<a name="line-2439"></a>            <span class='hs-varid'>unsolved_others</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionManyBags</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>unsolved_irreds</span>
<a name="line-2440"></a>                                             <span class='hs-layout'>,</span> <span class='hs-varid'>unsolved_dicts</span>
<a name="line-2441"></a>                                             <span class='hs-layout'>,</span> <span class='hs-varid'>unsolved_blocked</span> <span class='hs-keyglyph'>]</span>
<a name="line-2442"></a>
<a name="line-2443"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>implics</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getWorkListImplics</span>
<a name="line-2444"></a>
<a name="line-2445"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"getUnsolvedInerts"</span> <span class='hs-varop'>$</span>
<a name="line-2446"></a>        <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>" tv eqs ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>unsolved_tv_eqs</span>
<a name="line-2447"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"fun eqs ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>unsolved_fun_eqs</span>
<a name="line-2448"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"others ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>unsolved_others</span>
<a name="line-2449"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"implics ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>implics</span> <span class='hs-keyglyph'>]</span>
<a name="line-2450"></a>
<a name="line-2451"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>implics</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsolved_tv_eqs</span> <span class='hs-varop'>`unionBags`</span>
<a name="line-2452"></a>                          <span class='hs-varid'>unsolved_fun_eqs</span> <span class='hs-varop'>`unionBags`</span>
<a name="line-2453"></a>                          <span class='hs-varid'>unsolved_others</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2454"></a>  <span class='hs-keyword'>where</span>
<a name="line-2455"></a>    <span class='hs-varid'>add_if_unsolved</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-2456"></a>    <span class='hs-varid'>add_if_unsolved</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_unsolved</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-varop'>`consCts`</span> <span class='hs-varid'>cts</span>
<a name="line-2457"></a>                           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span>
<a name="line-2458"></a>
<a name="line-2459"></a>    <span class='hs-varid'>add_if_unsolveds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-2460"></a>    <span class='hs-varid'>add_if_unsolveds</span> <span class='hs-varid'>new_cts</span> <span class='hs-varid'>old_cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>add_if_unsolved</span> <span class='hs-varid'>old_cts</span>
<a name="line-2461"></a>                                             <span class='hs-layout'>(</span><span class='hs-varid'>equalCtListToList</span> <span class='hs-varid'>new_cts</span><span class='hs-layout'>)</span>
<a name="line-2462"></a>
<a name="line-2463"></a>    <span class='hs-varid'>is_unsolved</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isGivenCt</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Wanted or Derived</span>
<a name="line-2464"></a>
<a name="line-2465"></a><a name="getHasGivenEqs"></a><span class='hs-definition'>getHasGivenEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span>           <span class='hs-comment'>-- TcLevel of this implication</span>
<a name="line-2466"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span> <span class='hs-conid'>HasGivenEqs</span> <span class='hs-comment'>-- are there Given equalities?</span>
<a name="line-2467"></a>                      <span class='hs-layout'>,</span> <span class='hs-conid'>Cts</span> <span class='hs-layout'>)</span>       <span class='hs-comment'>-- Insoluble equalities arising from givens</span>
<a name="line-2468"></a><span class='hs-comment'>-- See Note [Tracking Given equalities]</span>
<a name="line-2469"></a><span class='hs-definition'>getHasGivenEqs</span> <span class='hs-varid'>tclvl</span>
<a name="line-2470"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_irreds</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>irreds</span>
<a name="line-2471"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>inert_given_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given_eqs</span>
<a name="line-2472"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>inert_given_eq_lvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ge_lvl</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2473"></a>              <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-2474"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>insols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterBag</span> <span class='hs-varid'>insolubleEqCt</span> <span class='hs-varid'>irreds</span>
<a name="line-2475"></a>                      <span class='hs-comment'>-- Specifically includes ones that originated in some</span>
<a name="line-2476"></a>                      <span class='hs-comment'>-- outer context but were refined to an insoluble by</span>
<a name="line-2477"></a>                      <span class='hs-comment'>-- a local equality; so do /not/ add ct_given_here.</span>
<a name="line-2478"></a>
<a name="line-2479"></a>             <span class='hs-comment'>-- See Note [HasGivenEqs] in GHC.Tc.Types.Constraint, and</span>
<a name="line-2480"></a>             <span class='hs-comment'>-- Note [Tracking Given equalities] in this module</span>
<a name="line-2481"></a>             <span class='hs-varid'>has_ge</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ge_lvl</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tclvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MaybeGivenEqs</span>
<a name="line-2482"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>given_eqs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LocalGivenEqs</span>
<a name="line-2483"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoGivenEqs</span>
<a name="line-2484"></a>
<a name="line-2485"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"getHasGivenEqs"</span> <span class='hs-varop'>$</span>
<a name="line-2486"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"given_eqs:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>given_eqs</span>
<a name="line-2487"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ge_lvl:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ge_lvl</span>
<a name="line-2488"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ambient level:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tclvl</span>
<a name="line-2489"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Inerts:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>inerts</span>
<a name="line-2490"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Insols:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>insols</span><span class='hs-keyglyph'>]</span>
<a name="line-2491"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>has_ge</span><span class='hs-layout'>,</span> <span class='hs-varid'>insols</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2492"></a>
<a name="line-2493"></a><a name="mentionsOuterVar"></a><span class='hs-definition'>mentionsOuterVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2494"></a><span class='hs-definition'>mentionsOuterVar</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>ev</span>
<a name="line-2495"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>anyFreeVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>isOuterTyVar</span> <span class='hs-varid'>tclvl</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-2496"></a>    <span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>ev</span>
<a name="line-2497"></a>
<a name="line-2498"></a><a name="isOuterTyVar"></a><span class='hs-definition'>isOuterTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2499"></a><span class='hs-comment'>-- True of a type variable that comes from a</span>
<a name="line-2500"></a><span class='hs-comment'>-- shallower level than the ambient level (tclvl)</span>
<a name="line-2501"></a><span class='hs-definition'>isOuterTyVar</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>tv</span>
<a name="line-2502"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTouchableMetaTyVar</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tclvl</span>  <span class='hs-layout'>)</span>
<a name="line-2503"></a>                 <span class='hs-varid'>tclvl</span> <span class='hs-varop'>`strictlyDeeperThan`</span> <span class='hs-varid'>tcTyVarLevel</span> <span class='hs-varid'>tv</span>
<a name="line-2504"></a>    <span class='hs-comment'>-- ASSERT: we are dealing with Givens here, and invariant (GivenInv) from</span>
<a name="line-2505"></a>    <span class='hs-comment'>-- Note Note [TcLevel invariants] in GHC.Tc.Utils.TcType ensures that there can't</span>
<a name="line-2506"></a>    <span class='hs-comment'>-- be a touchable meta tyvar.   If this wasn't true, you might worry that,</span>
<a name="line-2507"></a>    <span class='hs-comment'>-- at level 3, a meta-tv alpha[3] gets unified with skolem b[2], and thereby</span>
<a name="line-2508"></a>    <span class='hs-comment'>-- becomes "outer" even though its level numbers says it isn't.</span>
<a name="line-2509"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>  <span class='hs-comment'>-- Coercion variables; doesn't much matter</span>
<a name="line-2510"></a>
<a name="line-2511"></a><a name="matchableGivens"></a><span class='hs-comment'>-- | Returns Given constraints that might,</span>
<a name="line-2512"></a><span class='hs-comment'>-- potentially, match the given pred. This is used when checking to see if a</span>
<a name="line-2513"></a><span class='hs-comment'>-- Given might overlap with an instance. See Note [Instance and Given overlap]</span>
<a name="line-2514"></a><span class='hs-comment'>-- in "GHC.Tc.Solver.Interact"</span>
<a name="line-2515"></a><span class='hs-definition'>matchableGivens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-2516"></a><span class='hs-definition'>matchableGivens</span> <span class='hs-varid'>loc_w</span> <span class='hs-varid'>pred_w</span> <span class='hs-varid'>inerts</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_cans</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2517"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterBag</span> <span class='hs-varid'>matchable_given</span> <span class='hs-varid'>all_relevant_givens</span>
<a name="line-2518"></a>  <span class='hs-keyword'>where</span>
<a name="line-2519"></a>    <span class='hs-comment'>-- just look in class constraints and irreds. matchableGivens does get called</span>
<a name="line-2520"></a>    <span class='hs-comment'>-- for ~R constraints, but we don't need to look through equalities, because</span>
<a name="line-2521"></a>    <span class='hs-comment'>-- canonical equalities are used for rewriting. We'll only get caught by</span>
<a name="line-2522"></a>    <span class='hs-comment'>-- non-canonical -- that is, irreducible -- equalities.</span>
<a name="line-2523"></a>    <span class='hs-varid'>all_relevant_givens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>
<a name="line-2524"></a>    <span class='hs-varid'>all_relevant_givens</span>
<a name="line-2525"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>clas</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getClassPredTys_maybe</span> <span class='hs-varid'>pred_w</span>
<a name="line-2526"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findDictsByClass</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>inert_cans</span><span class='hs-layout'>)</span> <span class='hs-varid'>clas</span>
<a name="line-2527"></a>        <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>inert_cans</span>
<a name="line-2528"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2529"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>inert_cans</span>
<a name="line-2530"></a>
<a name="line-2531"></a>    <span class='hs-varid'>matchable_given</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2532"></a>    <span class='hs-varid'>matchable_given</span> <span class='hs-varid'>ct</span>
<a name="line-2533"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc_g</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred_g</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>ct</span>
<a name="line-2534"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mightEqualLater</span> <span class='hs-varid'>inerts</span> <span class='hs-varid'>pred_g</span> <span class='hs-varid'>loc_g</span> <span class='hs-varid'>pred_w</span> <span class='hs-varid'>loc_w</span>
<a name="line-2535"></a>
<a name="line-2536"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2537"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2538"></a>
<a name="line-2539"></a><a name="mightEqualLater"></a><span class='hs-definition'>mightEqualLater</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2540"></a><span class='hs-comment'>-- See Note [What might equal later?]</span>
<a name="line-2541"></a><span class='hs-comment'>-- Used to implement logic in Note [Instance and Given overlap] in GHC.Tc.Solver.Interact</span>
<a name="line-2542"></a><span class='hs-definition'>mightEqualLater</span> <span class='hs-varid'>inert_set</span> <span class='hs-varid'>given_pred</span> <span class='hs-varid'>given_loc</span> <span class='hs-varid'>wanted_pred</span> <span class='hs-varid'>wanted_loc</span>
<a name="line-2543"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>prohibitedSuperClassSolve</span> <span class='hs-varid'>given_loc</span> <span class='hs-varid'>wanted_loc</span>
<a name="line-2544"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2545"></a>
<a name="line-2546"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2547"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcUnifyTysFG</span> <span class='hs-varid'>bind_fun</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>flattened_given</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>flattened_wanted</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>of</span>
<a name="line-2548"></a>      <span class='hs-conid'>SurelyApart</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>  <span class='hs-comment'>-- types that are surely apart do not equal later</span>
<a name="line-2549"></a>      <span class='hs-conid'>MaybeApart</span> <span class='hs-conid'>MARInfinite</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>  <span class='hs-comment'>-- see Example 7 in the Note.</span>
<a name="line-2550"></a>      <span class='hs-keyword'>_</span>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-2551"></a>
<a name="line-2552"></a>  <span class='hs-keyword'>where</span>
<a name="line-2553"></a>    <span class='hs-varid'>in_scope</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>given_pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanted_pred</span><span class='hs-keyglyph'>]</span>
<a name="line-2554"></a>
<a name="line-2555"></a>    <span class='hs-comment'>-- NB: flatten both at the same time, so that we can share mappings</span>
<a name="line-2556"></a>    <span class='hs-comment'>-- from type family applications to variables, and also to guarantee</span>
<a name="line-2557"></a>    <span class='hs-comment'>-- that the fresh variables are really fresh between the given and</span>
<a name="line-2558"></a>    <span class='hs-comment'>-- the wanted. Flattening both at the same time is needed to get</span>
<a name="line-2559"></a>    <span class='hs-comment'>-- Example 10 from the Note.</span>
<a name="line-2560"></a>    <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>flattened_given</span><span class='hs-layout'>,</span> <span class='hs-varid'>flattened_wanted</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_mapping</span><span class='hs-layout'>)</span>
<a name="line-2561"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flattenTysX</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>given_pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanted_pred</span><span class='hs-keyglyph'>]</span>
<a name="line-2562"></a>
<a name="line-2563"></a>    <span class='hs-varid'>bind_fun</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BindFun</span>
<a name="line-2564"></a>    <span class='hs-varid'>bind_fun</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-2565"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-2566"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>can_unify</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>metaTyVarInfo</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-2567"></a>         <span class='hs-comment'>-- this checks for CycleBreakerTvs and TyVarTvs; forgetting</span>
<a name="line-2568"></a>         <span class='hs-comment'>-- the latter was #19106.</span>
<a name="line-2569"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BindMe</span>
<a name="line-2570"></a>
<a name="line-2571"></a>         <span class='hs-comment'>-- See Examples 4, 5, and 6 from the Note</span>
<a name="line-2572"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-sel'>_fam_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>fam_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>var_mapping</span> <span class='hs-varid'>tv</span>
<a name="line-2573"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>anyFreeVarsOfTypes</span> <span class='hs-varid'>mentions_meta_ty_var</span> <span class='hs-varid'>fam_args</span>
<a name="line-2574"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BindMe</span>
<a name="line-2575"></a>
<a name="line-2576"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2577"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Apart</span>
<a name="line-2578"></a>
<a name="line-2579"></a>    <span class='hs-comment'>-- True for TauTv and TyVarTv (and RuntimeUnkTv) meta-tyvars</span>
<a name="line-2580"></a>    <span class='hs-comment'>-- (as they can be unified)</span>
<a name="line-2581"></a>    <span class='hs-comment'>-- and also for CycleBreakerTvs that mentions meta-tyvars</span>
<a name="line-2582"></a>    <span class='hs-varid'>mentions_meta_ty_var</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2583"></a>    <span class='hs-varid'>mentions_meta_ty_var</span> <span class='hs-varid'>tv</span>
<a name="line-2584"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-2585"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>metaTyVarInfo</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-2586"></a>          <span class='hs-comment'>-- See Examples 8 and 9 in the Note</span>
<a name="line-2587"></a>          <span class='hs-conid'>CycleBreakerTv</span>
<a name="line-2588"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>anyFreeVarsOfType</span> <span class='hs-varid'>mentions_meta_ty_var</span>
<a name="line-2589"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>lookupCycleBreakerVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>inert_set</span><span class='hs-layout'>)</span>
<a name="line-2590"></a>          <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-2591"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2592"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2593"></a>
<a name="line-2594"></a>    <span class='hs-comment'>-- like canSolveByUnification, but allows cbv variables to unify</span>
<a name="line-2595"></a>    <span class='hs-varid'>can_unify</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MetaInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2596"></a>    <span class='hs-varid'>can_unify</span> <span class='hs-sel'>_lhs_tv</span> <span class='hs-conid'>TyVarTv</span> <span class='hs-varid'>rhs_ty</span>  <span class='hs-comment'>-- see Example 3 from the Note</span>
<a name="line-2597"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>rhs_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-2598"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>rhs_tv</span> <span class='hs-keyword'>of</span>
<a name="line-2599"></a>          <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarTv</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-2600"></a>          <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>  <span class='hs-comment'>-- could unify with anything</span>
<a name="line-2601"></a>          <span class='hs-conid'>SkolemTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-2602"></a>          <span class='hs-conid'>RuntimeUnk</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-2603"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-comment'>-- not a var on the RHS</span>
<a name="line-2604"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2605"></a>    <span class='hs-varid'>can_unify</span> <span class='hs-varid'>lhs_tv</span> <span class='hs-sel'>_other</span> <span class='hs-sel'>_rhs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mentions_meta_ty_var</span> <span class='hs-varid'>lhs_tv</span>
<a name="line-2606"></a>
<a name="line-2607"></a><a name="prohibitedSuperClassSolve"></a><span class='hs-definition'>prohibitedSuperClassSolve</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2608"></a><span class='hs-comment'>-- See Note [Solving superclass constraints] in GHC.Tc.TyCl.Instance</span>
<a name="line-2609"></a><span class='hs-definition'>prohibitedSuperClassSolve</span> <span class='hs-varid'>from_loc</span> <span class='hs-varid'>solve_loc</span>
<a name="line-2610"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InstSCOrigin</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>given_size</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>from_loc</span>
<a name="line-2611"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>ScOrigin</span> <span class='hs-varid'>wanted_size</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>solve_loc</span>
<a name="line-2612"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given_size</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>wanted_size</span>
<a name="line-2613"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2614"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2615"></a>
<a name="line-2616"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-2617"></a>*                                                                      *
<a name="line-2618"></a>    Cycle breakers
<a name="line-2619"></a>*                                                                      *
<a name="line-2620"></a>********************************************************************* -}</span>
<a name="line-2621"></a>
<a name="line-2622"></a><a name="lookupCycleBreakerVar"></a><span class='hs-comment'>-- | Return the type family application a CycleBreakerTv maps to.</span>
<a name="line-2623"></a><span class='hs-definition'>lookupCycleBreakerVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span>    <span class='hs-comment'>-- ^ cbv, must be a CycleBreakerTv</span>
<a name="line-2624"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertSet</span>
<a name="line-2625"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>     <span class='hs-comment'>-- ^ type family application the cbv maps to</span>
<a name="line-2626"></a><span class='hs-definition'>lookupCycleBreakerVar</span> <span class='hs-varid'>cbv</span> <span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cycle_breakers</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cbvs_stack</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2627"></a><span class='hs-comment'>-- This function looks at every environment in the stack. This is necessary</span>
<a name="line-2628"></a><span class='hs-comment'>-- to avoid #20231. This function (and its one usage site) is the only reason</span>
<a name="line-2629"></a><span class='hs-comment'>-- that we store a stack instead of just the top environment.</span>
<a name="line-2630"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tyfam_app</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-layout'>(</span><span class='hs-varid'>isCycleBreakerTyVar</span> <span class='hs-varid'>cbv</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-2631"></a>                      <span class='hs-varid'>firstJusts</span> <span class='hs-layout'>(</span><span class='hs-conid'>NE.map</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>cbv</span><span class='hs-layout'>)</span> <span class='hs-varid'>cbvs_stack</span><span class='hs-layout'>)</span>
<a name="line-2632"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyfam_app</span>
<a name="line-2633"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2634"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"lookupCycleBreakerVar found an unbound cycle breaker"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cbv</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cbvs_stack</span><span class='hs-layout'>)</span>
<a name="line-2635"></a>
<a name="line-2636"></a><a name="pushCycleBreakerVarStack"></a><span class='hs-comment'>-- | Push a fresh environment onto the cycle-breaker var stack. Useful</span>
<a name="line-2637"></a><span class='hs-comment'>-- when entering a nested implication.</span>
<a name="line-2638"></a><span class='hs-definition'>pushCycleBreakerVarStack</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CycleBreakerVarStack</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CycleBreakerVarStack</span>
<a name="line-2639"></a><span class='hs-definition'>pushCycleBreakerVarStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span> <span class='hs-conid'>NE</span><span class='hs-varop'>.&lt;|</span><span class='hs-layout'>)</span>
<a name="line-2640"></a>
<a name="line-2641"></a><a name="insertCycleBreakerBinding"></a><span class='hs-comment'>-- | Add a new cycle-breaker binding to the top environment on the stack.</span>
<a name="line-2642"></a><span class='hs-definition'>insertCycleBreakerBinding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span>   <span class='hs-comment'>-- ^ cbv, must be a CycleBreakerTv</span>
<a name="line-2643"></a>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>    <span class='hs-comment'>-- ^ cbv's expansion</span>
<a name="line-2644"></a>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CycleBreakerVarStack</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CycleBreakerVarStack</span>
<a name="line-2645"></a><span class='hs-definition'>insertCycleBreakerBinding</span> <span class='hs-varid'>cbv</span> <span class='hs-varid'>expansion</span> <span class='hs-layout'>(</span><span class='hs-varid'>top_env</span> <span class='hs-conop'>:|</span> <span class='hs-varid'>rest_envs</span><span class='hs-layout'>)</span>
<a name="line-2646"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-layout'>(</span><span class='hs-varid'>isCycleBreakerTyVar</span> <span class='hs-varid'>cbv</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-2647"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>cbv</span><span class='hs-layout'>,</span> <span class='hs-varid'>expansion</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>top_env</span><span class='hs-layout'>)</span> <span class='hs-conop'>:|</span> <span class='hs-varid'>rest_envs</span>
<a name="line-2648"></a>
<a name="line-2649"></a><a name="forAllCycleBreakerBindings_"></a><span class='hs-comment'>-- | Perform a monadic operation on all pairs in the top environment</span>
<a name="line-2650"></a><span class='hs-comment'>-- in the stack.</span>
<a name="line-2651"></a><span class='hs-definition'>forAllCycleBreakerBindings_</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span>
<a name="line-2652"></a>                            <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>CycleBreakerVarStack</span>
<a name="line-2653"></a>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-2654"></a><span class='hs-definition'>forAllCycleBreakerBindings_</span> <span class='hs-layout'>(</span><span class='hs-varid'>top_env</span> <span class='hs-conop'>:|</span> <span class='hs-sel'>_rest_envs</span><span class='hs-layout'>)</span> <span class='hs-varid'>action</span>
<a name="line-2655"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>forM_</span> <span class='hs-varid'>top_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-varid'>action</span><span class='hs-layout'>)</span>
<a name="line-2656"></a><span class='hs-comment'>{-# INLINABLE forAllCycleBreakerBindings_ #-}</span>  <span class='hs-comment'>-- to allow SPECIALISE later</span>
<a name="line-2657"></a>
<a name="line-2658"></a>
<a name="line-2659"></a><span class='hs-comment'>{- Note [Unsolved Derived equalities]
<a name="line-2660"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2661"></a>In getUnsolvedInerts, we return a derived equality from the inert_eqs
<a name="line-2662"></a>because it is a candidate for floating out of this implication.  We
<a name="line-2663"></a>only float equalities with a meta-tyvar on the left, so we only pull
<a name="line-2664"></a>those out here.
<a name="line-2665"></a>
<a name="line-2666"></a>Note [What might equal later?]
<a name="line-2667"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2668"></a>We must determine whether a Given might later equal a Wanted. We
<a name="line-2669"></a>definitely need to account for the possibility that any metavariable
<a name="line-2670"></a>might be arbitrarily instantiated. Yet we do *not* want
<a name="line-2671"></a>to allow skolems in to be instantiated, as we've already rewritten
<a name="line-2672"></a>with respect to any Givens. (We're solving a Wanted here, and so
<a name="line-2673"></a>all Givens have already been processed.)
<a name="line-2674"></a>
<a name="line-2675"></a>This is best understood by example.
<a name="line-2676"></a>
<a name="line-2677"></a>1. C alpha  ~?  C Int
<a name="line-2678"></a>
<a name="line-2679"></a>   That given certainly might match later.
<a name="line-2680"></a>
<a name="line-2681"></a>2. C a  ~?  C Int
<a name="line-2682"></a>
<a name="line-2683"></a>   No. No new givens are going to arise that will get the `a` to rewrite
<a name="line-2684"></a>   to Int.
<a name="line-2685"></a>
<a name="line-2686"></a>3. C alpha[tv]   ~?  C Int
<a name="line-2687"></a>
<a name="line-2688"></a>   That alpha[tv] is a TyVarTv, unifiable only with other type variables.
<a name="line-2689"></a>   It cannot equal later.
<a name="line-2690"></a>
<a name="line-2691"></a>4. C (F alpha)   ~?   C Int
<a name="line-2692"></a>
<a name="line-2693"></a>   Sure -- that can equal later, if we learn something useful about alpha.
<a name="line-2694"></a>
<a name="line-2695"></a>5. C (F alpha[tv])  ~?  C Int
<a name="line-2696"></a>
<a name="line-2697"></a>   This, too, might equal later. Perhaps we have [G] F b ~ Int elsewhere.
<a name="line-2698"></a>   Or maybe we have C (F alpha[tv] beta[tv]), these unify with each other,
<a name="line-2699"></a>   and F x x = Int. Remember: returning True doesn't commit ourselves to
<a name="line-2700"></a>   anything.
<a name="line-2701"></a>
<a name="line-2702"></a>6. C (F a)  ~?  C a
<a name="line-2703"></a>
<a name="line-2704"></a>   No, this won't match later. If we could rewrite (F a) or a, we would
<a name="line-2705"></a>   have by now.
<a name="line-2706"></a>
<a name="line-2707"></a>7. C (Maybe alpha)  ~?  C alpha
<a name="line-2708"></a>
<a name="line-2709"></a>   We say this cannot equal later, because it would require
<a name="line-2710"></a>   alpha := Maybe (Maybe (Maybe ...)). While such a type can be contrived,
<a name="line-2711"></a>   we choose not to worry about it. See Note [Infinitary substitution in lookup]
<a name="line-2712"></a>   in GHC.Core.InstEnv. Getting this wrong let to #19107, tested in
<a name="line-2713"></a>   typecheck/should_compile/T19107.
<a name="line-2714"></a>
<a name="line-2715"></a>8. C cbv   ~?  C Int
<a name="line-2716"></a>   where cbv = F a
<a name="line-2717"></a>
<a name="line-2718"></a>   The cbv is a cycle-breaker var which stands for F a. See
<a name="line-2719"></a>   Note [Type equality cycles] in GHC.Tc.Solver.Canonical.
<a name="line-2720"></a>   This is just like case 6, and we say "no". Saying "no" here is
<a name="line-2721"></a>   essential in getting the parser to type-check, with its use of DisambECP.
<a name="line-2722"></a>
<a name="line-2723"></a>9. C cbv   ~?   C Int
<a name="line-2724"></a>   where cbv = F alpha
<a name="line-2725"></a>
<a name="line-2726"></a>   Here, we might indeed equal later. Distinguishing between
<a name="line-2727"></a>   this case and Example 8 is why we need the InertSet in mightEqualLater.
<a name="line-2728"></a>
<a name="line-2729"></a>10. C (F alpha, Int)  ~?  C (Bool, F alpha)
<a name="line-2730"></a>
<a name="line-2731"></a>   This cannot equal later, because F a would have to equal both Bool and
<a name="line-2732"></a>   Int.
<a name="line-2733"></a>
<a name="line-2734"></a>To deal with type family applications, we use the Core flattener. See
<a name="line-2735"></a>Note [Flattening type-family applications when matching instances] in GHC.Core.Unify.
<a name="line-2736"></a>The Core flattener replaces all type family applications with
<a name="line-2737"></a>fresh variables. The next question: should we allow these fresh
<a name="line-2738"></a>variables in the domain of a unifying substitution?
<a name="line-2739"></a>
<a name="line-2740"></a>A type family application that mentions only skolems (example 6) is settled:
<a name="line-2741"></a>any skolems would have been rewritten w.r.t. Givens by now. These type family
<a name="line-2742"></a>applications match only themselves. A type family application that mentions
<a name="line-2743"></a>metavariables, on the other hand, can match anything. So, if the original type
<a name="line-2744"></a>family application contains a metavariable, we use BindMe to tell the unifier
<a name="line-2745"></a>to allow it in the substitution. On the other hand, a type family application
<a name="line-2746"></a>with only skolems is considered rigid.
<a name="line-2747"></a>
<a name="line-2748"></a>This treatment fixes #18910 and is tested in
<a name="line-2749"></a>typecheck/should_compile/InstanceGivenOverlap{,2}
<a name="line-2750"></a>-}</span>
<a name="line-2751"></a>
<a name="line-2752"></a><a name="removeInertCts"></a><span class='hs-definition'>removeInertCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-2753"></a><span class='hs-comment'>-- ^ Remove inert constraints from the 'InertCans', for use when a</span>
<a name="line-2754"></a><span class='hs-comment'>-- typechecker plugin wishes to discard a given.</span>
<a name="line-2755"></a><span class='hs-definition'>removeInertCts</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>icans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl'</span> <span class='hs-varid'>removeInertCt</span> <span class='hs-varid'>icans</span> <span class='hs-varid'>cts</span>
<a name="line-2756"></a>
<a name="line-2757"></a><a name="removeInertCt"></a><span class='hs-definition'>removeInertCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-2758"></a><span class='hs-definition'>removeInertCt</span> <span class='hs-varid'>is</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span>
<a name="line-2759"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>of</span>
<a name="line-2760"></a>
<a name="line-2761"></a>    <span class='hs-conid'>CDictCan</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cl</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2762"></a>      <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delDict</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> <span class='hs-varid'>cl</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span>
<a name="line-2763"></a>
<a name="line-2764"></a>    <span class='hs-conid'>CEqCan</span>    <span class='hs-layout'>{</span> <span class='hs-varid'>cc_lhs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>delEq</span> <span class='hs-varid'>is</span> <span class='hs-varid'>lhs</span> <span class='hs-varid'>rhs</span>
<a name="line-2765"></a>
<a name="line-2766"></a>    <span class='hs-conid'>CQuantCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"removeInertCt: CQuantCan"</span>
<a name="line-2767"></a>    <span class='hs-conid'>CIrredCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"removeInertCt: CIrredEvCan"</span>
<a name="line-2768"></a>    <span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"removeInertCt: CNonCanonical"</span>
<a name="line-2769"></a>
<a name="line-2770"></a><a name="lookupFamAppInert"></a><span class='hs-comment'>-- | Looks up a family application in the inerts; returned coercion</span>
<a name="line-2771"></a><span class='hs-comment'>-- is oriented input ~ output</span>
<a name="line-2772"></a><span class='hs-definition'>lookupFamAppInert</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>CtFlavourRole</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2773"></a><span class='hs-definition'>lookupFamAppInert</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>tys</span>
<a name="line-2774"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span>
<a name="line-2775"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookup_inerts</span> <span class='hs-varid'>inert_funeqs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2776"></a>  <span class='hs-keyword'>where</span>
<a name="line-2777"></a>    <span class='hs-varid'>lookup_inerts</span> <span class='hs-varid'>inert_funeqs</span>
<a name="line-2778"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqualCtList</span> <span class='hs-layout'>(</span><span class='hs-conid'>CEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span> <span class='hs-conop'>:|</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2779"></a>          <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findFunEq</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>tys</span>
<a name="line-2780"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvCoercion</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvFlavourRole</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span>
<a name="line-2781"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-2782"></a>
<a name="line-2783"></a><a name="lookupInInerts"></a><span class='hs-definition'>lookupInInerts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>)</span>
<a name="line-2784"></a><span class='hs-comment'>-- Is this exact predicate type cached in the solved or canonicals of the InertSet?</span>
<a name="line-2785"></a><span class='hs-definition'>lookupInInerts</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-2786"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-varid'>pty</span>
<a name="line-2787"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span>
<a name="line-2788"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupSolvedDict</span> <span class='hs-varid'>inerts</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`mplus`</span>
<a name="line-2789"></a>                 <span class='hs-varid'>fmap</span> <span class='hs-varid'>ctEvidence</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupInertDict</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2790"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-comment'>-- NB: No caching for equalities, IPs, holes, or errors</span>
<a name="line-2791"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-2792"></a>
<a name="line-2793"></a><a name="lookupInertDict"></a><span class='hs-comment'>-- | Look up a dictionary inert.</span>
<a name="line-2794"></a><span class='hs-definition'>lookupInertDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Ct</span>
<a name="line-2795"></a><span class='hs-definition'>lookupInertDict</span> <span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dicts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-2796"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>findDict</span> <span class='hs-varid'>dicts</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyword'>of</span>
<a name="line-2797"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span>
<a name="line-2798"></a>      <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-2799"></a>
<a name="line-2800"></a><a name="lookupSolvedDict"></a><span class='hs-comment'>-- | Look up a solved inert.</span>
<a name="line-2801"></a><span class='hs-definition'>lookupSolvedDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-2802"></a><span class='hs-comment'>-- Returns just if exactly this predicate type exists in the solved.</span>
<a name="line-2803"></a><span class='hs-definition'>lookupSolvedDict</span> <span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>solved</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-2804"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>findDict</span> <span class='hs-varid'>solved</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyword'>of</span>
<a name="line-2805"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ev</span>
<a name="line-2806"></a>      <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-2807"></a>
<a name="line-2808"></a><a name="lookupFamAppCache"></a><span class='hs-comment'>---------------------------</span>
<a name="line-2809"></a><span class='hs-definition'>lookupFamAppCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2810"></a><span class='hs-definition'>lookupFamAppCache</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>tys</span>
<a name="line-2811"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_famapp_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>famapp_cache</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span>
<a name="line-2812"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>findFunEq</span> <span class='hs-varid'>famapp_cache</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyword'>of</span>
<a name="line-2813"></a>           <span class='hs-varid'>result</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2814"></a>             <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"famapp_cache hit"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2815"></a>                                                    <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-2816"></a>                                                    <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2817"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>result</span> <span class='hs-layout'>}</span>
<a name="line-2818"></a>           <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-2819"></a>
<a name="line-2820"></a><a name="extendFamAppCache"></a><span class='hs-definition'>extendFamAppCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2821"></a><span class='hs-comment'>-- NB: co :: rhs ~ F tys, to match expectations of rewriter</span>
<a name="line-2822"></a><span class='hs-definition'>extendFamAppCache</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xi_args</span> <span class='hs-varid'>stuff</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2823"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-2824"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_FamAppCache</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-2825"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"extendFamAppCache"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>xi_args</span>
<a name="line-2826"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2827"></a>            <span class='hs-comment'>-- 'co' can be bottom, in the case of derived items</span>
<a name="line-2828"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>is</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_famapp_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2829"></a>            <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_famapp_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertFunEq</span> <span class='hs-varid'>fc</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xi_args</span> <span class='hs-varid'>stuff</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-2830"></a>
<a name="line-2831"></a><a name="dropFromFamAppCache"></a><span class='hs-comment'>-- Remove entries from the cache whose evidence mentions variables in the</span>
<a name="line-2832"></a><span class='hs-comment'>-- supplied set</span>
<a name="line-2833"></a><span class='hs-definition'>dropFromFamAppCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2834"></a><span class='hs-definition'>dropFromFamAppCache</span> <span class='hs-varid'>varset</span>
<a name="line-2835"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_famapp_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>famapp_cache</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span>
<a name="line-2836"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>filtered</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterTcAppMap</span> <span class='hs-varid'>check</span> <span class='hs-varid'>famapp_cache</span>
<a name="line-2837"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setTcSInerts</span> <span class='hs-varop'>$</span> <span class='hs-varid'>inerts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_famapp_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filtered</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-2838"></a>  <span class='hs-keyword'>where</span>
<a name="line-2839"></a>    <span class='hs-varid'>check</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2840"></a>    <span class='hs-varid'>check</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>anyFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>varset</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2841"></a>
<a name="line-2842"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-2843"></a>*                                                                      *
<a name="line-2844"></a>                   Irreds
<a name="line-2845"></a>*                                                                      *
<a name="line-2846"></a>********************************************************************* -}</span>
<a name="line-2847"></a>
<a name="line-2848"></a><a name="foldIrreds"></a><span class='hs-definition'>foldIrreds</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-2849"></a><span class='hs-definition'>foldIrreds</span> <span class='hs-varid'>k</span> <span class='hs-varid'>irreds</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>k</span> <span class='hs-varid'>z</span> <span class='hs-varid'>irreds</span>
<a name="line-2850"></a>
<a name="line-2851"></a>
<a name="line-2852"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-2853"></a>*                                                                      *
<a name="line-2854"></a>                   TcAppMap
<a name="line-2855"></a>*                                                                      *
<a name="line-2856"></a>************************************************************************
<a name="line-2857"></a>
<a name="line-2858"></a>Note [Use loose types in inert set]
<a name="line-2859"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2860"></a>Whenever we are looking up an inert dictionary (CDictCan) or function
<a name="line-2861"></a>equality (CEqCan), we use a TcAppMap, which uses the Unique of the
<a name="line-2862"></a>class/type family tycon and then a trie which maps the arguments. This
<a name="line-2863"></a>trie does *not* need to match the kinds of the arguments; this Note
<a name="line-2864"></a>explains why.
<a name="line-2865"></a>
<a name="line-2866"></a>Consider the types ty0 = (T ty1 ty2 ty3 ty4) and ty0' = (T ty1' ty2' ty3' ty4'),
<a name="line-2867"></a>where ty4 and ty4' have different kinds. Let's further assume that both types
<a name="line-2868"></a>ty0 and ty0' are well-typed. Because the kind of T is closed, it must be that
<a name="line-2869"></a>one of the ty1..ty3 does not match ty1'..ty3' (and that the kind of the fourth
<a name="line-2870"></a>argument to T is dependent on whichever one changed). Since we are matching
<a name="line-2871"></a>all arguments, during the inert-set lookup, we know that ty1..ty3 do indeed
<a name="line-2872"></a>match ty1'..ty3'. Therefore, the kind of ty4 and ty4' must match, too --
<a name="line-2873"></a>without ever looking at it.
<a name="line-2874"></a>
<a name="line-2875"></a>Accordingly, we use LooseTypeMap, which skips the kind check when looking
<a name="line-2876"></a>up a type. I (Richard E) believe this is just an optimization, and that
<a name="line-2877"></a>looking at kinds would be harmless.
<a name="line-2878"></a>
<a name="line-2879"></a>-}</span>
<a name="line-2880"></a>
<a name="line-2881"></a><a name="TcAppMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DTyConEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListMap</span> <span class='hs-conid'>LooseTypeMap</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-2882"></a>    <span class='hs-comment'>-- Indexed by tycon then the arg types, using "loose" matching, where</span>
<a name="line-2883"></a>    <span class='hs-comment'>-- we don't require kind equality. This allows, for example, (a |&gt; co)</span>
<a name="line-2884"></a>    <span class='hs-comment'>-- to match (a).</span>
<a name="line-2885"></a>    <span class='hs-comment'>-- See Note [Use loose types in inert set]</span>
<a name="line-2886"></a>    <span class='hs-comment'>-- Used for types and classes; hence UniqDFM</span>
<a name="line-2887"></a>    <span class='hs-comment'>-- See Note [foldTM determinism] in GHC.Data.TrieMap for why we use DTyConEnv here</span>
<a name="line-2888"></a>
<a name="line-2889"></a><a name="isEmptyTcAppMap"></a><span class='hs-definition'>isEmptyTcAppMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2890"></a><span class='hs-definition'>isEmptyTcAppMap</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyDTyConEnv</span> <span class='hs-varid'>m</span>
<a name="line-2891"></a>
<a name="line-2892"></a><a name="emptyTcAppMap"></a><span class='hs-definition'>emptyTcAppMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>
<a name="line-2893"></a><span class='hs-definition'>emptyTcAppMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyDTyConEnv</span>
<a name="line-2894"></a>
<a name="line-2895"></a><a name="findTcApp"></a><span class='hs-definition'>findTcApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>
<a name="line-2896"></a><span class='hs-definition'>findTcApp</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tys_map</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupDTyConEnv</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span>
<a name="line-2897"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>lookupTM</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>tys_map</span> <span class='hs-layout'>}</span>
<a name="line-2898"></a>
<a name="line-2899"></a><a name="delTcApp"></a><span class='hs-definition'>delTcApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>
<a name="line-2900"></a><span class='hs-definition'>delTcApp</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>adjustDTyConEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>deleteTM</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span>
<a name="line-2901"></a>
<a name="line-2902"></a><a name="insertTcApp"></a><span class='hs-definition'>insertTcApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>
<a name="line-2903"></a><span class='hs-definition'>insertTcApp</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alterDTyConEnv</span> <span class='hs-varid'>alter_tm</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span>
<a name="line-2904"></a>  <span class='hs-keyword'>where</span>
<a name="line-2905"></a>    <span class='hs-varid'>alter_tm</span> <span class='hs-varid'>mb_tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>insertTM</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>(</span><span class='hs-varid'>mb_tm</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>emptyTM</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2906"></a>
<a name="line-2907"></a><a name="alterTcApp"></a><span class='hs-definition'>alterTcApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span><span class='hs-varop'>.</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>XT</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>
<a name="line-2908"></a><span class='hs-definition'>alterTcApp</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>upd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alterDTyConEnv</span> <span class='hs-varid'>alter_tm</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span>
<a name="line-2909"></a>  <span class='hs-keyword'>where</span>
<a name="line-2910"></a>    <span class='hs-varid'>alter_tm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListMap</span> <span class='hs-conid'>LooseTypeMap</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListMap</span> <span class='hs-conid'>LooseTypeMap</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-2911"></a>    <span class='hs-varid'>alter_tm</span> <span class='hs-varid'>m_elt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>alterTM</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>upd</span> <span class='hs-layout'>(</span><span class='hs-varid'>m_elt</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>emptyTM</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2912"></a>
<a name="line-2913"></a><a name="filterTcAppMap"></a><span class='hs-definition'>filterTcAppMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span><span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>
<a name="line-2914"></a><span class='hs-definition'>filterTcAppMap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapMaybeDTyConEnv</span> <span class='hs-varid'>one_tycon</span> <span class='hs-varid'>m</span>
<a name="line-2915"></a>  <span class='hs-keyword'>where</span>
<a name="line-2916"></a>    <span class='hs-varid'>one_tycon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ListMap</span> <span class='hs-conid'>LooseTypeMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListMap</span> <span class='hs-conid'>LooseTypeMap</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-2917"></a>    <span class='hs-varid'>one_tycon</span> <span class='hs-varid'>tm</span>
<a name="line-2918"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTM</span> <span class='hs-varid'>filtered_tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-2919"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>filtered_tm</span>
<a name="line-2920"></a>      <span class='hs-keyword'>where</span>
<a name="line-2921"></a>        <span class='hs-varid'>filtered_tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterTM</span> <span class='hs-varid'>f</span> <span class='hs-varid'>tm</span>
<a name="line-2922"></a>
<a name="line-2923"></a><a name="tcAppMapToBag"></a><span class='hs-definition'>tcAppMapToBag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>a</span>
<a name="line-2924"></a><span class='hs-definition'>tcAppMapToBag</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTcAppMap</span> <span class='hs-varid'>consBag</span> <span class='hs-varid'>m</span> <span class='hs-varid'>emptyBag</span>
<a name="line-2925"></a>
<a name="line-2926"></a><a name="foldTcAppMap"></a><span class='hs-definition'>foldTcAppMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-2927"></a><span class='hs-definition'>foldTcAppMap</span> <span class='hs-varid'>k</span> <span class='hs-varid'>m</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldDTyConEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldTM</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-varid'>z</span> <span class='hs-varid'>m</span>
<a name="line-2928"></a>
<a name="line-2929"></a>
<a name="line-2930"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-2931"></a>*                                                                      *
<a name="line-2932"></a>                   DictMap
<a name="line-2933"></a>*                                                                      *
<a name="line-2934"></a>********************************************************************* -}</span>
<a name="line-2935"></a>
<a name="line-2936"></a>
<a name="line-2937"></a><span class='hs-comment'>{- Note [Tuples hiding implicit parameters]
<a name="line-2938"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2939"></a>Consider
<a name="line-2940"></a>   f,g :: (?x::Int, C a) =&gt; a -&gt; a
<a name="line-2941"></a>   f v = let ?x = 4 in g v
<a name="line-2942"></a>
<a name="line-2943"></a>The call to 'g' gives rise to a Wanted constraint (?x::Int, C a).
<a name="line-2944"></a>We must /not/ solve this from the Given (?x::Int, C a), because of
<a name="line-2945"></a>the intervening binding for (?x::Int).  #14218.
<a name="line-2946"></a>
<a name="line-2947"></a>We deal with this by arranging that we always fail when looking up a
<a name="line-2948"></a>tuple constraint that hides an implicit parameter. Not that this applies
<a name="line-2949"></a>  * both to the inert_dicts (lookupInertDict)
<a name="line-2950"></a>  * and to the solved_dicts (looukpSolvedDict)
<a name="line-2951"></a>An alternative would be not to extend these sets with such tuple
<a name="line-2952"></a>constraints, but it seemed more direct to deal with the lookup.
<a name="line-2953"></a>
<a name="line-2954"></a>Note [Solving CallStack constraints]
<a name="line-2955"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2956"></a>Suppose f :: HasCallStack =&gt; blah.  Then
<a name="line-2957"></a>
<a name="line-2958"></a>* Each call to 'f' gives rise to
<a name="line-2959"></a>    [W] s1 :: IP "callStack" CallStack    -- CtOrigin = OccurrenceOf f
<a name="line-2960"></a>  with a CtOrigin that says "OccurrenceOf f".
<a name="line-2961"></a>  Remember that HasCallStack is just shorthand for
<a name="line-2962"></a>    IP "callStack CallStack
<a name="line-2963"></a>  See Note [Overview of implicit CallStacks] in GHC.Tc.Types.Evidence
<a name="line-2964"></a>
<a name="line-2965"></a>* We cannonicalise such constraints, in GHC.Tc.Solver.Canonical.canClassNC, by
<a name="line-2966"></a>  pushing the call-site info on the stack, and changing the CtOrigin
<a name="line-2967"></a>  to record that has been done.
<a name="line-2968"></a>   Bind:  s1 = pushCallStack &lt;site-info&gt; s2
<a name="line-2969"></a>   [W] s2 :: IP "callStack" CallStack   -- CtOrigin = IPOccOrigin
<a name="line-2970"></a>
<a name="line-2971"></a>* Then, and only then, we can solve the constraint from an enclosing
<a name="line-2972"></a>  Given.
<a name="line-2973"></a>
<a name="line-2974"></a>So we must be careful /not/ to solve 's1' from the Givens.  Again,
<a name="line-2975"></a>we ensure this by arranging that findDict always misses when looking
<a name="line-2976"></a>up souch constraints.
<a name="line-2977"></a>-}</span>
<a name="line-2978"></a>
<a name="line-2979"></a><a name="DictMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>
<a name="line-2980"></a>
<a name="line-2981"></a><a name="emptyDictMap"></a><span class='hs-definition'>emptyDictMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span>
<a name="line-2982"></a><span class='hs-definition'>emptyDictMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyTcAppMap</span>
<a name="line-2983"></a>
<a name="line-2984"></a><a name="findDict"></a><span class='hs-definition'>findDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>
<a name="line-2985"></a><span class='hs-definition'>findDict</span> <span class='hs-varid'>m</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-2986"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>hasIPSuperClasses</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-comment'>-- See Note [Tuples hiding implicit parameters]</span>
<a name="line-2987"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-2988"></a>
<a name="line-2989"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isCallStackPred</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-2990"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>OccurrenceOf</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>loc</span>
<a name="line-2991"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>             <span class='hs-comment'>-- See Note [Solving CallStack constraints]</span>
<a name="line-2992"></a>
<a name="line-2993"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2994"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-2995"></a>
<a name="line-2996"></a><a name="findDictsByClass"></a><span class='hs-definition'>findDictsByClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>a</span>
<a name="line-2997"></a><span class='hs-definition'>findDictsByClass</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span>
<a name="line-2998"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupDTyConEnv</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTM</span> <span class='hs-varid'>consBag</span> <span class='hs-varid'>tm</span> <span class='hs-varid'>emptyBag</span>
<a name="line-2999"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span>
<a name="line-3000"></a>
<a name="line-3001"></a><a name="delDict"></a><span class='hs-definition'>delDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span>
<a name="line-3002"></a><span class='hs-definition'>delDict</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-3003"></a>
<a name="line-3004"></a><a name="addDict"></a><span class='hs-definition'>addDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span>
<a name="line-3005"></a><span class='hs-definition'>addDict</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span>
<a name="line-3006"></a>
<a name="line-3007"></a><a name="addDictCt"></a><span class='hs-definition'>addDictCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span>
<a name="line-3008"></a><span class='hs-comment'>-- Like addDict, but combines [W] and [D] to [WD]</span>
<a name="line-3009"></a><span class='hs-comment'>-- See Note [KeepBoth] in GHC.Tc.Solver.Interact</span>
<a name="line-3010"></a><span class='hs-definition'>addDictCt</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>new_ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alterTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>xt_ct</span>
<a name="line-3011"></a>  <span class='hs-keyword'>where</span>
<a name="line-3012"></a>    <span class='hs-varid'>new_ct_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>new_ct</span>
<a name="line-3013"></a>
<a name="line-3014"></a>    <span class='hs-varid'>xt_ct</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Ct</span>
<a name="line-3015"></a>    <span class='hs-varid'>xt_ct</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>old_ct</span><span class='hs-layout'>)</span>
<a name="line-3016"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_nosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WOnly</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>old_ct_ev</span>
<a name="line-3017"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>new_ct_ev</span>
<a name="line-3018"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>old_ct</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_ct_ev</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_nosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WDeriv</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3019"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>old_ct_ev</span>
<a name="line-3020"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_nosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WOnly</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>new_ct_ev</span>
<a name="line-3021"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ct</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_ct_ev</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_nosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WDeriv</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3022"></a>      <span class='hs-keyword'>where</span>
<a name="line-3023"></a>        <span class='hs-varid'>old_ct_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>old_ct</span>
<a name="line-3024"></a>
<a name="line-3025"></a>    <span class='hs-varid'>xt_ct</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>new_ct</span>
<a name="line-3026"></a>
<a name="line-3027"></a><a name="addDictsByClass"></a><span class='hs-definition'>addDictsByClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span>
<a name="line-3028"></a><span class='hs-definition'>addDictsByClass</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>items</span>
<a name="line-3029"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendDTyConEnv</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-varid'>add</span> <span class='hs-varid'>emptyTM</span> <span class='hs-varid'>items</span><span class='hs-layout'>)</span>
<a name="line-3030"></a>  <span class='hs-keyword'>where</span>
<a name="line-3031"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertTM</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>tm</span>
<a name="line-3032"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"addDictsByClass"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-3033"></a>
<a name="line-3034"></a><a name="filterDicts"></a><span class='hs-definition'>filterDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span>
<a name="line-3035"></a><span class='hs-definition'>filterDicts</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterTcAppMap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span>
<a name="line-3036"></a>
<a name="line-3037"></a><a name="partitionDicts"></a><span class='hs-definition'>partitionDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>,</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span>
<a name="line-3038"></a><span class='hs-definition'>partitionDicts</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTcAppMap</span> <span class='hs-varid'>k</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyDicts</span><span class='hs-layout'>)</span>
<a name="line-3039"></a>  <span class='hs-keyword'>where</span>
<a name="line-3040"></a>    <span class='hs-varid'>k</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>(</span><span class='hs-varid'>yeses</span><span class='hs-layout'>,</span> <span class='hs-varid'>noes</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ct</span>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span> <span class='hs-varop'>`consBag`</span> <span class='hs-varid'>yeses</span><span class='hs-layout'>,</span> <span class='hs-varid'>noes</span><span class='hs-layout'>)</span>
<a name="line-3041"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>yeses</span><span class='hs-layout'>,</span>              <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>noes</span><span class='hs-layout'>)</span>
<a name="line-3042"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span>
<a name="line-3043"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addDict</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ct</span>
<a name="line-3044"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"partitionDicts"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-3045"></a>
<a name="line-3046"></a><a name="dictsToBag"></a><span class='hs-definition'>dictsToBag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>a</span>
<a name="line-3047"></a><span class='hs-definition'>dictsToBag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcAppMapToBag</span>
<a name="line-3048"></a>
<a name="line-3049"></a><a name="foldDicts"></a><span class='hs-definition'>foldDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-3050"></a><span class='hs-definition'>foldDicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTcAppMap</span>
<a name="line-3051"></a>
<a name="line-3052"></a><a name="emptyDicts"></a><span class='hs-definition'>emptyDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span>
<a name="line-3053"></a><span class='hs-definition'>emptyDicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyTcAppMap</span>
<a name="line-3054"></a>
<a name="line-3055"></a>
<a name="line-3056"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-3057"></a>*                                                                      *
<a name="line-3058"></a>                   FunEqMap
<a name="line-3059"></a>*                                                                      *
<a name="line-3060"></a>********************************************************************* -}</span>
<a name="line-3061"></a>
<a name="line-3062"></a><a name="FunEqMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>  <span class='hs-comment'>-- A map whose key is a (TyCon, [Type]) pair</span>
<a name="line-3063"></a>
<a name="line-3064"></a><a name="emptyFunEqs"></a><span class='hs-definition'>emptyFunEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>
<a name="line-3065"></a><span class='hs-definition'>emptyFunEqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyTcAppMap</span>
<a name="line-3066"></a>
<a name="line-3067"></a><a name="findFunEq"></a><span class='hs-definition'>findFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>
<a name="line-3068"></a><span class='hs-definition'>findFunEq</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findTcApp</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-3069"></a>
<a name="line-3070"></a><a name="findFunEqsByTyCon"></a><span class='hs-definition'>findFunEqsByTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-3071"></a><span class='hs-comment'>-- Get inert function equation constraints that have the given tycon</span>
<a name="line-3072"></a><span class='hs-comment'>-- in their head.  Not that the constraints remain in the inert set.</span>
<a name="line-3073"></a><span class='hs-comment'>-- We use this to check for derived interactions with built-in type-function</span>
<a name="line-3074"></a><span class='hs-comment'>-- constructors.</span>
<a name="line-3075"></a><span class='hs-definition'>findFunEqsByTyCon</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span>
<a name="line-3076"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupDTyConEnv</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTM</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varid'>tm</span> <span class='hs-conid'>[]</span>
<a name="line-3077"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-3078"></a>
<a name="line-3079"></a><a name="foldFunEqs"></a><span class='hs-definition'>foldFunEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-3080"></a><span class='hs-definition'>foldFunEqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTcAppMap</span>
<a name="line-3081"></a>
<a name="line-3082"></a><a name="insertFunEq"></a><span class='hs-definition'>insertFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span>
<a name="line-3083"></a><span class='hs-definition'>insertFunEq</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>val</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertTcApp</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>val</span>
<a name="line-3084"></a>
<a name="line-3085"></a><span class='hs-comment'>{-
<a name="line-3086"></a>************************************************************************
<a name="line-3087"></a>*                                                                      *
<a name="line-3088"></a>*              The TcS solver monad                                    *
<a name="line-3089"></a>*                                                                      *
<a name="line-3090"></a>************************************************************************
<a name="line-3091"></a>
<a name="line-3092"></a>Note [The TcS monad]
<a name="line-3093"></a>~~~~~~~~~~~~~~~~~~~~
<a name="line-3094"></a>The TcS monad is a weak form of the main Tc monad
<a name="line-3095"></a>
<a name="line-3096"></a>All you can do is
<a name="line-3097"></a>    * fail
<a name="line-3098"></a>    * allocate new variables
<a name="line-3099"></a>    * fill in evidence variables
<a name="line-3100"></a>
<a name="line-3101"></a>Filling in a dictionary evidence variable means to create a binding
<a name="line-3102"></a>for it, so TcS carries a mutable location where the binding can be
<a name="line-3103"></a>added.  This is initialised from the innermost implication constraint.
<a name="line-3104"></a>-}</span>
<a name="line-3105"></a>
<a name="line-3106"></a><a name="TcSEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcSEnv</span>
<a name="line-3107"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span>
<a name="line-3108"></a>      <span class='hs-varid'>tcs_ev_binds</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span><span class='hs-layout'>,</span>
<a name="line-3109"></a>
<a name="line-3110"></a>      <span class='hs-varid'>tcs_unified</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span>
<a name="line-3111"></a>         <span class='hs-comment'>-- The number of unification variables we have filled</span>
<a name="line-3112"></a>         <span class='hs-comment'>-- The important thing is whether it is non-zero</span>
<a name="line-3113"></a>
<a name="line-3114"></a>      <span class='hs-varid'>tcs_unif_lvl</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcLevel</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-3115"></a>         <span class='hs-comment'>-- The Unification Level Flag</span>
<a name="line-3116"></a>         <span class='hs-comment'>-- Outermost level at which we have unified a meta tyvar</span>
<a name="line-3117"></a>         <span class='hs-comment'>-- Starts at Nothing, then (Just i), then (Just j) where j&lt;i</span>
<a name="line-3118"></a>         <span class='hs-comment'>-- See Note [The Unification Level Flag]</span>
<a name="line-3119"></a>
<a name="line-3120"></a>      <span class='hs-varid'>tcs_count</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Global step count</span>
<a name="line-3121"></a>
<a name="line-3122"></a>      <span class='hs-varid'>tcs_inerts</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>InertSet</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Current inert set</span>
<a name="line-3123"></a>
<a name="line-3124"></a>      <span class='hs-comment'>-- See Note [WorkList priorities] and</span>
<a name="line-3125"></a>      <span class='hs-varid'>tcs_worklist</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>WorkList</span> <span class='hs-comment'>-- Current worklist</span>
<a name="line-3126"></a>    <span class='hs-layout'>}</span>
<a name="line-3127"></a>
<a name="line-3128"></a><a name="TcS"></a><span class='hs-comment'>---------------</span>
<a name="line-3129"></a><a name="TcS"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span> <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Functor</span><span class='hs-layout'>)</span>
<a name="line-3130"></a>
<a name="line-3131"></a><a name="mkTcS"></a><span class='hs-comment'>-- | Smart constructor for 'TcS', as describe in Note [The one-shot state</span>
<a name="line-3132"></a><span class='hs-comment'>-- monad trick] in "GHC.Utils.Monad".</span>
<a name="line-3133"></a><span class='hs-definition'>mkTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-3134"></a><span class='hs-definition'>mkTcS</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>oneShot</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>
<a name="line-3135"></a>
<a name="line-3136"></a><a name="instance%20Applicative%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Applicative</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-3137"></a>  <span class='hs-varid'>pure</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>x</span>
<a name="line-3138"></a>  <span class='hs-layout'>(</span><span class='hs-varop'>&lt;*&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ap</span>
<a name="line-3139"></a>
<a name="line-3140"></a><a name="instance%20Monad%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monad</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-3141"></a>  <span class='hs-varid'>m</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>k</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>ebs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-3142"></a>    <span class='hs-varid'>unTcS</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ebs</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>r</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>ebs</span><span class='hs-layout'>)</span>
<a name="line-3143"></a>
<a name="line-3144"></a><a name="instance%20MonadFail%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadFail</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-3145"></a>  <span class='hs-varid'>fail</span> <span class='hs-varid'>err</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail</span> <span class='hs-varid'>err</span>
<a name="line-3146"></a>
<a name="line-3147"></a><a name="instance%20MonadUnique%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadUnique</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-3148"></a>   <span class='hs-varid'>getUniqueSupplyM</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varid'>getUniqueSupplyM</span>
<a name="line-3149"></a>
<a name="line-3150"></a><a name="instance%20HasModule%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasModule</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-3151"></a>   <span class='hs-varid'>getModule</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varid'>getModule</span>
<a name="line-3152"></a>
<a name="line-3153"></a><a name="instance%20MonadThings%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadThings</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-3154"></a>   <span class='hs-varid'>lookupThing</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupThing</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-3155"></a>
<a name="line-3156"></a><a name="wrapTcS"></a><span class='hs-comment'>-- Basic functionality</span>
<a name="line-3157"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-3158"></a><span class='hs-definition'>wrapTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-3159"></a><span class='hs-comment'>-- Do not export wrapTcS, because it promotes an arbitrary TcM to TcS,</span>
<a name="line-3160"></a><span class='hs-comment'>-- and TcS is supposed to have limited functionality</span>
<a name="line-3161"></a><span class='hs-definition'>wrapTcS</span> <span class='hs-varid'>action</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-sel'>_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>action</span> <span class='hs-comment'>-- a TcM action will not use the TcEvBinds</span>
<a name="line-3162"></a>
<a name="line-3163"></a><a name="wrapErrTcS"></a><span class='hs-definition'>wrapErrTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-3164"></a><span class='hs-comment'>-- The thing wrapped should just fail</span>
<a name="line-3165"></a><span class='hs-comment'>-- There's no static check; it's up to the user</span>
<a name="line-3166"></a><span class='hs-comment'>-- Having a variant for each error message is too painful</span>
<a name="line-3167"></a><span class='hs-definition'>wrapErrTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span>
<a name="line-3168"></a>
<a name="line-3169"></a><a name="wrapWarnTcS"></a><span class='hs-definition'>wrapWarnTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-3170"></a><span class='hs-comment'>-- The thing wrapped should just add a warning, or no-op</span>
<a name="line-3171"></a><span class='hs-comment'>-- There's no static check; it's up to the user</span>
<a name="line-3172"></a><span class='hs-definition'>wrapWarnTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span>
<a name="line-3173"></a>
<a name="line-3174"></a><a name="failTcS"></a><span class='hs-definition'>failTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>panicTcS</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-3175"></a><a name="warnTcS"></a><span class='hs-definition'>warnTcS</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WarningFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3176"></a><a name="addErrTcS"></a><span class='hs-definition'>addErrTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3177"></a><span class='hs-definition'>failTcS</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-conid'>TcM.failWith</span>
<a name="line-3178"></a><span class='hs-definition'>warnTcS</span> <span class='hs-varid'>flag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-conid'>TcM.addWarn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Reason</span> <span class='hs-varid'>flag</span><span class='hs-layout'>)</span>
<a name="line-3179"></a><span class='hs-definition'>addErrTcS</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-conid'>TcM.addErr</span>
<a name="line-3180"></a><a name="panicTcS"></a><span class='hs-definition'>panicTcS</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"GHC.Tc.Solver.Canonical"</span> <span class='hs-varid'>doc</span>
<a name="line-3181"></a>
<a name="line-3182"></a><a name="traceTcS"></a><span class='hs-definition'>traceTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3183"></a><span class='hs-definition'>traceTcS</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.traceTc</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>
<a name="line-3184"></a><span class='hs-comment'>{-# INLINE traceTcS #-}</span>  <span class='hs-comment'>-- see Note [INLINE conditional tracing utilities]</span>
<a name="line-3185"></a>
<a name="line-3186"></a><a name="runTcPluginTcS"></a><span class='hs-definition'>runTcPluginTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-3187"></a><span class='hs-definition'>runTcPluginTcS</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-varid'>runTcPluginM</span> <span class='hs-varid'>m</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>getTcEvBindsVar</span>
<a name="line-3188"></a>
<a name="line-3189"></a><a name="instance%20HasDynFlags%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasDynFlags</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-3190"></a>    <span class='hs-varid'>getDynFlags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-3191"></a>
<a name="line-3192"></a><a name="getGlobalRdrEnvTcS"></a><span class='hs-definition'>getGlobalRdrEnvTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>GlobalRdrEnv</span>
<a name="line-3193"></a><span class='hs-definition'>getGlobalRdrEnvTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-conid'>TcM.getGlobalRdrEnv</span>
<a name="line-3194"></a>
<a name="line-3195"></a><a name="bumpStepCountTcS"></a><span class='hs-definition'>bumpStepCountTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3196"></a><span class='hs-definition'>bumpStepCountTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-3197"></a>  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcs_count</span> <span class='hs-varid'>env</span>
<a name="line-3198"></a>     <span class='hs-layout'>;</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>ref</span>
<a name="line-3199"></a>     <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.writeTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3200"></a>
<a name="line-3201"></a><a name="csTraceTcS"></a><span class='hs-definition'>csTraceTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3202"></a><span class='hs-definition'>csTraceTcS</span> <span class='hs-varid'>doc</span>
<a name="line-3203"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>csTraceTcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>
<a name="line-3204"></a><span class='hs-comment'>{-# INLINE csTraceTcS #-}</span>  <span class='hs-comment'>-- see Note [INLINE conditional tracing utilities]</span>
<a name="line-3205"></a>
<a name="line-3206"></a><a name="traceFireTcS"></a><span class='hs-definition'>traceFireTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3207"></a><span class='hs-comment'>-- Dump a rule-firing trace</span>
<a name="line-3208"></a><span class='hs-definition'>traceFireTcS</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>doc</span>
<a name="line-3209"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>csTraceTcM</span> <span class='hs-varop'>$</span>
<a name="line-3210"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcs_count</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-3211"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tclvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.getTcLevel</span>
<a name="line-3212"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Step"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n</span>
<a name="line-3213"></a>                       <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"l:"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tclvl</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-3214"></a>                                    <span class='hs-varid'>text</span> <span class='hs-str'>"d:"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocDepth</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvLoc</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3215"></a>                       <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>doc</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span><span class='hs-layout'>)</span>
<a name="line-3216"></a>                     <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3217"></a><span class='hs-comment'>{-# INLINE traceFireTcS #-}</span>  <span class='hs-comment'>-- see Note [INLINE conditional tracing utilities]</span>
<a name="line-3218"></a>
<a name="line-3219"></a><a name="csTraceTcM"></a><span class='hs-definition'>csTraceTcM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-3220"></a><span class='hs-comment'>-- Constraint-solver tracing, -ddump-cs-trace</span>
<a name="line-3221"></a><span class='hs-definition'>csTraceTcM</span> <span class='hs-varid'>mk_doc</span>
<a name="line-3222"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-3223"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span>  <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_cs_trace</span> <span class='hs-varid'>dflags</span>
<a name="line-3224"></a>                  <span class='hs-varop'>||</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_tc_trace</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>)</span>
<a name="line-3225"></a>              <span class='hs-layout'>(</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mk_doc</span>
<a name="line-3226"></a>                   <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.dumpTcRn</span> <span class='hs-conid'>False</span>
<a name="line-3227"></a>                       <span class='hs-conid'>Opt_D_dump_cs_trace</span>
<a name="line-3228"></a>                       <span class='hs-str'>""</span> <span class='hs-conid'>FormatText</span>
<a name="line-3229"></a>                       <span class='hs-varid'>msg</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3230"></a><span class='hs-comment'>{-# INLINE csTraceTcM #-}</span>  <span class='hs-comment'>-- see Note [INLINE conditional tracing utilities]</span>
<a name="line-3231"></a>
<a name="line-3232"></a><a name="runTcS"></a><span class='hs-definition'>runTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>                <span class='hs-comment'>-- What to run</span>
<a name="line-3233"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvBindMap</span><span class='hs-layout'>)</span>
<a name="line-3234"></a><span class='hs-definition'>runTcS</span> <span class='hs-varid'>tcs</span>
<a name="line-3235"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcEvBinds</span>
<a name="line-3236"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runTcSWithEvBinds</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>tcs</span>
<a name="line-3237"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.getTcEvBindsMap</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-3238"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3239"></a><a name="runTcSDeriveds"></a><span class='hs-comment'>-- | This variant of 'runTcS' will keep solving, even when only Deriveds</span>
<a name="line-3240"></a><span class='hs-comment'>-- are left around. It also doesn't return any evidence, as callers won't</span>
<a name="line-3241"></a><span class='hs-comment'>-- need it.</span>
<a name="line-3242"></a><span class='hs-definition'>runTcSDeriveds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-3243"></a><span class='hs-definition'>runTcSDeriveds</span> <span class='hs-varid'>tcs</span>
<a name="line-3244"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcEvBinds</span>
<a name="line-3245"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>runTcSWithEvBinds</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>tcs</span> <span class='hs-layout'>}</span>
<a name="line-3246"></a>
<a name="line-3247"></a><a name="runTcSEqualities"></a><span class='hs-comment'>-- | This can deal only with equality constraints.</span>
<a name="line-3248"></a><span class='hs-definition'>runTcSEqualities</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-3249"></a><span class='hs-definition'>runTcSEqualities</span> <span class='hs-varid'>thing_inside</span>
<a name="line-3250"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newNoTcEvBinds</span>
<a name="line-3251"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>runTcSWithEvBinds</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>}</span>
<a name="line-3252"></a>
<a name="line-3253"></a><a name="runTcSInerts"></a><span class='hs-comment'>-- | A variant of 'runTcS' that takes and returns an 'InertSet' for</span>
<a name="line-3254"></a><span class='hs-comment'>-- later resumption of the 'TcS' session.</span>
<a name="line-3255"></a><span class='hs-definition'>runTcSInerts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>InertSet</span><span class='hs-layout'>)</span>
<a name="line-3256"></a><span class='hs-definition'>runTcSInerts</span> <span class='hs-varid'>inerts</span> <span class='hs-varid'>tcs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-3257"></a>  <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcEvBinds</span>
<a name="line-3258"></a>  <span class='hs-varid'>runTcSWithEvBinds'</span> <span class='hs-conid'>False</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-3259"></a>    <span class='hs-varid'>setTcSInerts</span> <span class='hs-varid'>inerts</span>
<a name="line-3260"></a>    <span class='hs-varid'>a</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcs</span>
<a name="line-3261"></a>    <span class='hs-varid'>new_inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span>
<a name="line-3262"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_inerts</span><span class='hs-layout'>)</span>
<a name="line-3263"></a>
<a name="line-3264"></a><a name="runTcSWithEvBinds"></a><span class='hs-definition'>runTcSWithEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-3265"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-3266"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-3267"></a><span class='hs-definition'>runTcSWithEvBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTcSWithEvBinds'</span> <span class='hs-conid'>True</span>
<a name="line-3268"></a>
<a name="line-3269"></a><a name="runTcSWithEvBinds'"></a><span class='hs-definition'>runTcSWithEvBinds'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-comment'>-- ^ Restore type equality cycles afterwards?</span>
<a name="line-3270"></a>                           <span class='hs-comment'>-- Don't if you want to reuse the InertSet.</span>
<a name="line-3271"></a>                           <span class='hs-comment'>-- See also Note [Type equality cycles]</span>
<a name="line-3272"></a>                           <span class='hs-comment'>-- in GHC.Tc.Solver.Canonical</span>
<a name="line-3273"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-3274"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-3275"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-3276"></a><span class='hs-definition'>runTcSWithEvBinds'</span> <span class='hs-varid'>restore_cycles</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>tcs</span>
<a name="line-3277"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unified_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcRef</span> <span class='hs-num'>0</span>
<a name="line-3278"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>step_count</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcRef</span> <span class='hs-num'>0</span>
<a name="line-3279"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>inert_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcRef</span> <span class='hs-varid'>emptyInert</span>
<a name="line-3280"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcRef</span> <span class='hs-varid'>emptyWorkList</span>
<a name="line-3281"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unif_lvl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcRef</span> <span class='hs-conid'>Nothing</span>
<a name="line-3282"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_ev_binds</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-3283"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_unified</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unified_var</span>
<a name="line-3284"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_unif_lvl</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unif_lvl_var</span>
<a name="line-3285"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_count</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>step_count</span>
<a name="line-3286"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_inerts</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_var</span>
<a name="line-3287"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_worklist</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl_var</span> <span class='hs-layout'>}</span>
<a name="line-3288"></a>
<a name="line-3289"></a>             <span class='hs-comment'>-- Run the computation</span>
<a name="line-3290"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unTcS</span> <span class='hs-varid'>tcs</span> <span class='hs-varid'>env</span>
<a name="line-3291"></a>
<a name="line-3292"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>count</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>step_count</span>
<a name="line-3293"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>count</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-3294"></a>         <span class='hs-varid'>csTraceTcM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Constraint solver steps ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>count</span><span class='hs-layout'>)</span>
<a name="line-3295"></a>
<a name="line-3296"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-varid'>restore_cycles</span> <span class='hs-varop'>$</span>
<a name="line-3297"></a>         <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_set</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>inert_var</span>
<a name="line-3298"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>restoreTyVarCycles</span> <span class='hs-varid'>inert_set</span> <span class='hs-layout'>}</span>
<a name="line-3299"></a>
<a name="line-3300"></a><span class='hs-cpp'>#if defined(DEBUG)</span>
<a name="line-3301"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.getTcEvBindsMap</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-3302"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkForCyclicBinds</span> <span class='hs-varid'>ev_binds</span>
<a name="line-3303"></a><span class='hs-cpp'>#endif</span>
<a name="line-3304"></a>
<a name="line-3305"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-3306"></a>
<a name="line-3307"></a><span class='hs-comment'>----------------------------</span>
<a name="line-3308"></a><span class='hs-cpp'>#if defined(DEBUG)</span>
<a name="line-3309"></a><a name="checkForCyclicBinds"></a><span class='hs-definition'>checkForCyclicBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-3310"></a><span class='hs-definition'>checkForCyclicBinds</span> <span class='hs-varid'>ev_binds_map</span>
<a name="line-3311"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>cycles</span>
<a name="line-3312"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-3313"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>coercion_cycles</span>
<a name="line-3314"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcM.traceTc</span> <span class='hs-str'>"Cycle in evidence binds"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cycles</span>
<a name="line-3315"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3316"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"Cycle in coercion bindings"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>coercion_cycles</span>
<a name="line-3317"></a>  <span class='hs-keyword'>where</span>
<a name="line-3318"></a>    <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evBindMapBinds</span> <span class='hs-varid'>ev_binds_map</span>
<a name="line-3319"></a>
<a name="line-3320"></a>    <span class='hs-varid'>cycles</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>EvBind</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-3321"></a>    <span class='hs-varid'>cycles</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CyclicSCC</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stronglyConnCompFromEdgedVerticesUniq</span> <span class='hs-varid'>edges</span><span class='hs-keyglyph'>]</span>
<a name="line-3322"></a>
<a name="line-3323"></a>    <span class='hs-varid'>coercion_cycles</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cycles</span><span class='hs-layout'>,</span> <span class='hs-varid'>any</span> <span class='hs-varid'>is_co_bind</span> <span class='hs-varid'>c</span><span class='hs-keyglyph'>]</span>
<a name="line-3324"></a>    <span class='hs-varid'>is_co_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eb_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEqPrimPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-3325"></a>
<a name="line-3326"></a>    <span class='hs-varid'>edges</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Node</span> <span class='hs-conid'>EvVar</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>]</span>
<a name="line-3327"></a>    <span class='hs-varid'>edges</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>DigraphNode</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonDetEltsUniqSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3328"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eb_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>eb_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bagToList</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>]</span>
<a name="line-3329"></a>            <span class='hs-comment'>-- It's OK to use nonDetEltsUFM here as</span>
<a name="line-3330"></a>            <span class='hs-comment'>-- stronglyConnCompFromEdgedVertices is still deterministic even</span>
<a name="line-3331"></a>            <span class='hs-comment'>-- if the edges are in nondeterministic order as explained in</span>
<a name="line-3332"></a>            <span class='hs-comment'>-- Note [Deterministic SCC] in GHC.Data.Graph.Directed.</span>
<a name="line-3333"></a><span class='hs-cpp'>#endif</span>
<a name="line-3334"></a>
<a name="line-3335"></a><a name="setEvBindsTcS"></a><span class='hs-comment'>----------------------------</span>
<a name="line-3336"></a><span class='hs-definition'>setEvBindsTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-3337"></a><span class='hs-definition'>setEvBindsTcS</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-3338"></a> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3339"></a>
<a name="line-3340"></a><a name="nestImplicTcS"></a><span class='hs-definition'>nestImplicTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-3341"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-3342"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-3343"></a><span class='hs-definition'>nestImplicTcS</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>inner_tclvl</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-3344"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_unified</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unified_var</span>
<a name="line-3345"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_inerts</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_inert_var</span>
<a name="line-3346"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_count</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count</span>
<a name="line-3347"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_unif_lvl</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unif_lvl</span>
<a name="line-3348"></a>                   <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-3349"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>old_inert_var</span>
<a name="line-3350"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nest_inert</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inerts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cycle_breakers</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pushCycleBreakerVarStack</span>
<a name="line-3351"></a>                                                            <span class='hs-layout'>(</span><span class='hs-varid'>inert_cycle_breakers</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span>
<a name="line-3352"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span>
<a name="line-3353"></a>                                                   <span class='hs-layout'>{</span> <span class='hs-varid'>inert_given_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-3354"></a>                 <span class='hs-comment'>-- All other InertSet fields are inherited</span>
<a name="line-3355"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_inert_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcRef</span> <span class='hs-varid'>nest_inert</span>
<a name="line-3356"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_wl_var</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcRef</span> <span class='hs-varid'>emptyWorkList</span>
<a name="line-3357"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nest_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_count</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count</span>     <span class='hs-comment'>-- Inherited</span>
<a name="line-3358"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_unif_lvl</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unif_lvl</span>  <span class='hs-comment'>-- Inherited</span>
<a name="line-3359"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_ev_binds</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span>
<a name="line-3360"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_unified</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unified_var</span>
<a name="line-3361"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_inerts</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_inert_var</span>
<a name="line-3362"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_worklist</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_wl_var</span> <span class='hs-layout'>}</span>
<a name="line-3363"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.setTcLevel</span> <span class='hs-varid'>inner_tclvl</span> <span class='hs-varop'>$</span>
<a name="line-3364"></a>                <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>nest_env</span>
<a name="line-3365"></a>
<a name="line-3366"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>out_inert_set</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>new_inert_var</span>
<a name="line-3367"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>restoreTyVarCycles</span> <span class='hs-varid'>out_inert_set</span>
<a name="line-3368"></a>
<a name="line-3369"></a><span class='hs-cpp'>#if defined(DEBUG)</span>
<a name="line-3370"></a>       <span class='hs-comment'>-- Perform a check that the thing_inside did not cause cycles</span>
<a name="line-3371"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.getTcEvBindsMap</span> <span class='hs-varid'>ref</span>
<a name="line-3372"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkForCyclicBinds</span> <span class='hs-varid'>ev_binds</span>
<a name="line-3373"></a><span class='hs-cpp'>#endif</span>
<a name="line-3374"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-3375"></a>
<a name="line-3376"></a><a name="nestTcS"></a><span class='hs-definition'>nestTcS</span> <span class='hs-keyglyph'>::</span>  <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-3377"></a><span class='hs-comment'>-- Use the current untouchables, augmenting the current</span>
<a name="line-3378"></a><span class='hs-comment'>-- evidence bindings, and solved dictionaries</span>
<a name="line-3379"></a><span class='hs-comment'>-- But have no effect on the InertCans, or on the inert_famapp_cache</span>
<a name="line-3380"></a><span class='hs-comment'>-- (we want to inherit the latter from processing the Givens)</span>
<a name="line-3381"></a><span class='hs-definition'>nestTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-3382"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_inerts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inerts_var</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-3383"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>inerts_var</span>
<a name="line-3384"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_inert_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcRef</span> <span class='hs-varid'>inerts</span>
<a name="line-3385"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_wl_var</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcRef</span> <span class='hs-varid'>emptyWorkList</span>
<a name="line-3386"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nest_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_inerts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_inert_var</span>
<a name="line-3387"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_worklist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_wl_var</span> <span class='hs-layout'>}</span>
<a name="line-3388"></a>
<a name="line-3389"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>nest_env</span>
<a name="line-3390"></a>
<a name="line-3391"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>new_inert_var</span>
<a name="line-3392"></a>
<a name="line-3393"></a>       <span class='hs-comment'>-- we want to propagate the safe haskell failures</span>
<a name="line-3394"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>old_ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inerts</span>
<a name="line-3395"></a>             <span class='hs-varid'>new_ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_cans</span> <span class='hs-varid'>new_inerts</span>
<a name="line-3396"></a>             <span class='hs-varid'>nxt_ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_ic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-varid'>new_ic</span> <span class='hs-layout'>}</span>
<a name="line-3397"></a>
<a name="line-3398"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.writeTcRef</span> <span class='hs-varid'>inerts_var</span>  <span class='hs-comment'>-- See Note [Propagate the solved dictionaries]</span>
<a name="line-3399"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>inerts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-varid'>new_inerts</span>
<a name="line-3400"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nxt_ic</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3401"></a>
<a name="line-3402"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-3403"></a>
<a name="line-3404"></a><a name="emitImplicationTcS"></a><span class='hs-definition'>emitImplicationTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-3405"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- Skolems</span>
<a name="line-3406"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span>          <span class='hs-comment'>-- Givens</span>
<a name="line-3407"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>              <span class='hs-comment'>-- Wanteds</span>
<a name="line-3408"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcEvBinds</span>
<a name="line-3409"></a><span class='hs-comment'>-- Add an implication to the TcS monad work-list</span>
<a name="line-3410"></a><span class='hs-definition'>emitImplicationTcS</span> <span class='hs-varid'>new_tclvl</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>givens</span> <span class='hs-varid'>wanteds</span>
<a name="line-3411"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>wc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyWC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanteds</span> <span class='hs-layout'>}</span>
<a name="line-3412"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>imp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span>
<a name="line-3413"></a>                <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcEvBinds</span>
<a name="line-3414"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>imp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newImplication</span>
<a name="line-3415"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>imp</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_tclvl</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_tclvl</span>
<a name="line-3416"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ic_skols</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-3417"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>givens</span>
<a name="line-3418"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span>
<a name="line-3419"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ic_binds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-3420"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_info</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3421"></a>
<a name="line-3422"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>emitImplication</span> <span class='hs-varid'>imp</span>
<a name="line-3423"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcEvBinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_binds</span> <span class='hs-varid'>imp</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3424"></a>
<a name="line-3425"></a><a name="emitTvImplicationTcS"></a><span class='hs-definition'>emitTvImplicationTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-3426"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- Skolems</span>
<a name="line-3427"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>              <span class='hs-comment'>-- Wanteds</span>
<a name="line-3428"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3429"></a><span class='hs-comment'>-- Just like emitImplicationTcS but no givens and no bindings</span>
<a name="line-3430"></a><span class='hs-definition'>emitTvImplicationTcS</span> <span class='hs-varid'>new_tclvl</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>wanteds</span>
<a name="line-3431"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>wc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyWC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanteds</span> <span class='hs-layout'>}</span>
<a name="line-3432"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>imp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span>
<a name="line-3433"></a>                <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newNoTcEvBinds</span>
<a name="line-3434"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>imp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newImplication</span>
<a name="line-3435"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>imp</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_tclvl</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_tclvl</span>
<a name="line-3436"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ic_skols</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-3437"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span>
<a name="line-3438"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ic_binds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-3439"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_info</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3440"></a>
<a name="line-3441"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>emitImplication</span> <span class='hs-varid'>imp</span> <span class='hs-layout'>}</span>
<a name="line-3442"></a>
<a name="line-3443"></a>
<a name="line-3444"></a><span class='hs-comment'>{- Note [Propagate the solved dictionaries]
<a name="line-3445"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-3446"></a>It's really quite important that nestTcS does not discard the solved
<a name="line-3447"></a>dictionaries from the thing_inside.
<a name="line-3448"></a>Consider
<a name="line-3449"></a>   Eq [a]
<a name="line-3450"></a>   forall b. empty =&gt;  Eq [a]
<a name="line-3451"></a>We solve the simple (Eq [a]), under nestTcS, and then turn our attention to
<a name="line-3452"></a>the implications.  It's definitely fine to use the solved dictionaries on
<a name="line-3453"></a>the inner implications, and it can make a significant performance difference
<a name="line-3454"></a>if you do so.
<a name="line-3455"></a>-}</span>
<a name="line-3456"></a>
<a name="line-3457"></a><span class='hs-comment'>-- Getters and setters of GHC.Tc.Utils.Env fields</span>
<a name="line-3458"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-3459"></a>
<a name="line-3460"></a><a name="getTcSInertsRef"></a><span class='hs-comment'>-- Getter of inerts and worklist</span>
<a name="line-3461"></a><span class='hs-definition'>getTcSInertsRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>InertSet</span><span class='hs-layout'>)</span>
<a name="line-3462"></a><span class='hs-definition'>getTcSInertsRef</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_inerts</span><span class='hs-layout'>)</span>
<a name="line-3463"></a>
<a name="line-3464"></a><a name="getTcSWorkListRef"></a><span class='hs-definition'>getTcSWorkListRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span>
<a name="line-3465"></a><span class='hs-definition'>getTcSWorkListRef</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_worklist</span><span class='hs-layout'>)</span>
<a name="line-3466"></a>
<a name="line-3467"></a><a name="getTcSInerts"></a><span class='hs-definition'>getTcSInerts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>InertSet</span>
<a name="line-3468"></a><span class='hs-definition'>getTcSInerts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getTcSInertsRef</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>readTcRef</span>
<a name="line-3469"></a>
<a name="line-3470"></a><a name="setTcSInerts"></a><span class='hs-definition'>setTcSInerts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3471"></a><span class='hs-definition'>setTcSInerts</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInertsRef</span><span class='hs-layout'>;</span> <span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>}</span>
<a name="line-3472"></a>
<a name="line-3473"></a><a name="getWorkListImplics"></a><span class='hs-definition'>getWorkListImplics</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span><span class='hs-layout'>)</span>
<a name="line-3474"></a><span class='hs-definition'>getWorkListImplics</span>
<a name="line-3475"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSWorkListRef</span>
<a name="line-3476"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wl_curr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTcRef</span> <span class='hs-varid'>wl_var</span>
<a name="line-3477"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wl_implics</span> <span class='hs-varid'>wl_curr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3478"></a>
<a name="line-3479"></a><a name="pushLevelNoWorkList"></a><span class='hs-definition'>pushLevelNoWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-3480"></a><span class='hs-comment'>-- Push the level and run thing_inside</span>
<a name="line-3481"></a><span class='hs-comment'>-- However, thing_inside should not generate any work items</span>
<a name="line-3482"></a><span class='hs-cpp'>#if defined(DEBUG)</span>
<a name="line-3483"></a><span class='hs-definition'>pushLevelNoWorkList</span> <span class='hs-varid'>err_doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-3484"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM.pushTcLevelM</span> <span class='hs-varop'>$</span>
<a name="line-3485"></a>                 <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_worklist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl_panic</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3486"></a>        <span class='hs-layout'>)</span>
<a name="line-3487"></a>  <span class='hs-keyword'>where</span>
<a name="line-3488"></a>    <span class='hs-varid'>wl_panic</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"GHC.Tc.Solver.Monad.buildImplication"</span> <span class='hs-varid'>err_doc</span>
<a name="line-3489"></a>                         <span class='hs-comment'>-- This panic checks that the thing-inside</span>
<a name="line-3490"></a>                         <span class='hs-comment'>-- does not emit any work-list constraints</span>
<a name="line-3491"></a><span class='hs-cpp'>#else</span>
<a name="line-3492"></a><span class='hs-definition'>pushLevelNoWorkList</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-3493"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM.pushTcLevelM</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing_inside</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Don't check</span>
<a name="line-3494"></a><span class='hs-cpp'>#endif</span>
<a name="line-3495"></a>
<a name="line-3496"></a><a name="updWorkListTcS"></a><span class='hs-definition'>updWorkListTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3497"></a><span class='hs-definition'>updWorkListTcS</span> <span class='hs-varid'>f</span>
<a name="line-3498"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSWorkListRef</span>
<a name="line-3499"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updTcRef</span> <span class='hs-varid'>wl_var</span> <span class='hs-varid'>f</span> <span class='hs-layout'>}</span>
<a name="line-3500"></a>
<a name="line-3501"></a><a name="emitWorkNC"></a><span class='hs-definition'>emitWorkNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CtEvidence</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3502"></a><span class='hs-definition'>emitWorkNC</span> <span class='hs-varid'>evs</span>
<a name="line-3503"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>evs</span>
<a name="line-3504"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-3505"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3506"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emitWork</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mkNonCanonical</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span>
<a name="line-3507"></a>
<a name="line-3508"></a><a name="emitWork"></a><span class='hs-definition'>emitWork</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3509"></a><span class='hs-definition'>emitWork</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>   <span class='hs-comment'>-- avoid printing, among other work</span>
<a name="line-3510"></a><span class='hs-definition'>emitWork</span> <span class='hs-varid'>cts</span>
<a name="line-3511"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emitting fresh work"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3512"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendWorkListCts</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3513"></a>
<a name="line-3514"></a><a name="emitImplication"></a><span class='hs-definition'>emitImplication</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Implication</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3515"></a><span class='hs-definition'>emitImplication</span> <span class='hs-varid'>implic</span>
<a name="line-3516"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendWorkListImplic</span> <span class='hs-varid'>implic</span><span class='hs-layout'>)</span>
<a name="line-3517"></a>
<a name="line-3518"></a><a name="newTcRef"></a><span class='hs-definition'>newTcRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRef</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-3519"></a><span class='hs-definition'>newTcRef</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.newTcRef</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-3520"></a>
<a name="line-3521"></a><a name="readTcRef"></a><span class='hs-definition'>readTcRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-3522"></a><span class='hs-definition'>readTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>ref</span><span class='hs-layout'>)</span>
<a name="line-3523"></a>
<a name="line-3524"></a><a name="writeTcRef"></a><span class='hs-definition'>writeTcRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3525"></a><span class='hs-definition'>writeTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>val</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.writeTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>val</span><span class='hs-layout'>)</span>
<a name="line-3526"></a>
<a name="line-3527"></a><a name="updTcRef"></a><span class='hs-definition'>updTcRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>-&gt;</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3528"></a><span class='hs-definition'>updTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>upd_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.updTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>upd_fn</span><span class='hs-layout'>)</span>
<a name="line-3529"></a>
<a name="line-3530"></a><a name="getTcEvBindsVar"></a><span class='hs-definition'>getTcEvBindsVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-3531"></a><span class='hs-definition'>getTcEvBindsVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_ev_binds</span><span class='hs-layout'>)</span>
<a name="line-3532"></a>
<a name="line-3533"></a><a name="getTcLevel"></a><span class='hs-definition'>getTcLevel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcLevel</span>
<a name="line-3534"></a><span class='hs-definition'>getTcLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-conid'>TcM.getTcLevel</span>
<a name="line-3535"></a>
<a name="line-3536"></a><a name="getTcEvTyCoVars"></a><span class='hs-definition'>getTcEvTyCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-3537"></a><span class='hs-definition'>getTcEvTyCoVars</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-3538"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.getTcEvTyCoVars</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-3539"></a>
<a name="line-3540"></a><a name="getTcEvBindsMap"></a><span class='hs-definition'>getTcEvBindsMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvBindMap</span>
<a name="line-3541"></a><span class='hs-definition'>getTcEvBindsMap</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-3542"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.getTcEvBindsMap</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-3543"></a>
<a name="line-3544"></a><a name="setTcEvBindsMap"></a><span class='hs-definition'>setTcEvBindsMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3545"></a><span class='hs-definition'>setTcEvBindsMap</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>binds</span>
<a name="line-3546"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.setTcEvBindsMap</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>binds</span>
<a name="line-3547"></a>
<a name="line-3548"></a><a name="unifyTyVar"></a><span class='hs-definition'>unifyTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3549"></a><span class='hs-comment'>-- Unify a meta-tyvar with a type</span>
<a name="line-3550"></a><span class='hs-comment'>-- We keep track of how many unifications have happened in tcs_unified,</span>
<a name="line-3551"></a><span class='hs-comment'>--</span>
<a name="line-3552"></a><span class='hs-comment'>-- We should never unify the same variable twice!</span>
<a name="line-3553"></a><span class='hs-definition'>unifyTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-3554"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-3555"></a>    <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-3556"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>TcM.traceTc</span> <span class='hs-str'>"unifyTyVar"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>":="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-3557"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.writeMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-3558"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.updTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcs_unified</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3559"></a>
<a name="line-3560"></a><a name="reportUnifications"></a><span class='hs-definition'>reportUnifications</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-3561"></a><span class='hs-definition'>reportUnifications</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-3562"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-3563"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inner_unified</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcRef</span> <span class='hs-num'>0</span>
<a name="line-3564"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_unified</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inner_unified</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3565"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>n_unifs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>inner_unified</span>
<a name="line-3566"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.updTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcs_unified</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span> <span class='hs-varid'>n_unifs</span><span class='hs-layout'>)</span>
<a name="line-3567"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_unifs</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3568"></a>
<a name="line-3569"></a><a name="TouchabilityTestResult"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TouchabilityTestResult</span>
<a name="line-3570"></a>  <span class='hs-comment'>-- See Note [Solve by unification] in GHC.Tc.Solver.Interact</span>
<a name="line-3571"></a>  <span class='hs-comment'>-- which points out that having TouchableSameLevel is just an optimisation;</span>
<a name="line-3572"></a>  <span class='hs-comment'>-- we could manage with TouchableOuterLevel alone (suitably renamed)</span>
<a name="line-3573"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TouchableSameLevel</span>
<a name="line-3574"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TouchableOuterLevel</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- Promote these</span>
<a name="line-3575"></a>                        <span class='hs-conid'>TcLevel</span>     <span class='hs-comment'>-- ..to this level</span>
<a name="line-3576"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Untouchable</span>
<a name="line-3577"></a>
<a name="line-3578"></a><a name="instance%20Outputable%20TouchabilityTestResult"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TouchabilityTestResult</span> <span class='hs-keyword'>where</span>
<a name="line-3579"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>TouchableSameLevel</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TouchableSameLevel"</span>
<a name="line-3580"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TouchableOuterLevel</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>lvl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TouchableOuterLevel"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>lvl</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-3581"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Untouchable</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Untouchable"</span>
<a name="line-3582"></a>
<a name="line-3583"></a><a name="touchabilityTest"></a><span class='hs-definition'>touchabilityTest</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavour</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TouchabilityTestResult</span>
<a name="line-3584"></a><span class='hs-comment'>-- This is the key test for untouchability:</span>
<a name="line-3585"></a><span class='hs-comment'>-- See Note [Unification preconditions] in GHC.Tc.Utils.Unify</span>
<a name="line-3586"></a><span class='hs-comment'>-- and Note [Solve by unification] in GHC.Tc.Solver.Interact</span>
<a name="line-3587"></a><span class='hs-definition'>touchabilityTest</span> <span class='hs-varid'>flav</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>rhs</span>
<a name="line-3588"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>flav</span> <span class='hs-varop'>/=</span> <span class='hs-conid'>Given</span>  <span class='hs-comment'>-- See Note [Do not unify Givens]</span>
<a name="line-3589"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_tclvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_lvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>mtv_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv1</span>
<a name="line-3590"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>canSolveByUnification</span> <span class='hs-varid'>info</span> <span class='hs-varid'>rhs</span>
<a name="line-3591"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ambient_lvl</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcLevel</span>
<a name="line-3592"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>given_eq_lvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInnermostGivenEqLevel</span>
<a name="line-3593"></a>
<a name="line-3594"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv_lvl</span> <span class='hs-varop'>`sameDepthAs`</span> <span class='hs-varid'>ambient_lvl</span>
<a name="line-3595"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>TouchableSameLevel</span>
<a name="line-3596"></a>
<a name="line-3597"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv_lvl</span> <span class='hs-varop'>`deeperThanOrSame`</span> <span class='hs-varid'>given_eq_lvl</span>   <span class='hs-comment'>-- No intervening given equalities</span>
<a name="line-3598"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>does_not_escape</span> <span class='hs-varid'>tv_lvl</span><span class='hs-layout'>)</span> <span class='hs-varid'>free_skols</span>  <span class='hs-comment'>-- No skolem escapes</span>
<a name="line-3599"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TouchableOuterLevel</span> <span class='hs-varid'>free_metas</span> <span class='hs-varid'>tv_lvl</span><span class='hs-layout'>)</span>
<a name="line-3600"></a>
<a name="line-3601"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3602"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Untouchable</span> <span class='hs-layout'>}</span>
<a name="line-3603"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3604"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Untouchable</span>
<a name="line-3605"></a>  <span class='hs-keyword'>where</span>
<a name="line-3606"></a>     <span class='hs-layout'>(</span><span class='hs-varid'>free_metas</span><span class='hs-layout'>,</span> <span class='hs-varid'>free_skols</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>isPromotableMetaTyVar</span> <span class='hs-varop'>$</span>
<a name="line-3607"></a>                                <span class='hs-varid'>nonDetEltsUniqSet</span>               <span class='hs-varop'>$</span>
<a name="line-3608"></a>                                <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>rhs</span>
<a name="line-3609"></a>
<a name="line-3610"></a>     <span class='hs-varid'>does_not_escape</span> <span class='hs-varid'>tv_lvl</span> <span class='hs-varid'>fv</span>
<a name="line-3611"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>fv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_lvl</span> <span class='hs-varop'>`deeperThanOrSame`</span> <span class='hs-varid'>tcTyVarLevel</span> <span class='hs-varid'>fv</span>
<a name="line-3612"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-3613"></a>       <span class='hs-comment'>-- Coercion variables are not an escape risk</span>
<a name="line-3614"></a>       <span class='hs-comment'>-- If an implication binds a coercion variable, it'll have equalities,</span>
<a name="line-3615"></a>       <span class='hs-comment'>-- so the "intervening given equalities" test above will catch it</span>
<a name="line-3616"></a>       <span class='hs-comment'>-- Coercion holes get filled with coercions, so again no problem.</span>
<a name="line-3617"></a>
<a name="line-3618"></a><span class='hs-comment'>{- Note [Do not unify Givens]
<a name="line-3619"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-3620"></a>Consider this GADT match
<a name="line-3621"></a>   data T a where
<a name="line-3622"></a>      T1 :: T Int
<a name="line-3623"></a>      ...
<a name="line-3624"></a>
<a name="line-3625"></a>   f x = case x of
<a name="line-3626"></a>           T1 -&gt; True
<a name="line-3627"></a>           ...
<a name="line-3628"></a>
<a name="line-3629"></a>So we get f :: T alpha[1] -&gt; beta[1]
<a name="line-3630"></a>          x :: T alpha[1]
<a name="line-3631"></a>and from the T1 branch we get the implication
<a name="line-3632"></a>   forall[2] (alpha[1] ~ Int) =&gt; beta[1] ~ Bool
<a name="line-3633"></a>
<a name="line-3634"></a>Now, clearly we don't want to unify alpha:=Int!  Yet at the moment we
<a name="line-3635"></a>process [G] alpha[1] ~ Int, we don't have any given-equalities in the
<a name="line-3636"></a>inert set, and hence there are no given equalities to make alpha untouchable.
<a name="line-3637"></a>
<a name="line-3638"></a>NB: if it were alpha[2] ~ Int, this argument wouldn't hold.  But that
<a name="line-3639"></a>never happens: invariant (GivenInv) in Note [TcLevel invariants]
<a name="line-3640"></a>in GHC.Tc.Utils.TcType.
<a name="line-3641"></a>
<a name="line-3642"></a>Simple solution: never unify in Givens!
<a name="line-3643"></a>-}</span>
<a name="line-3644"></a>
<a name="line-3645"></a><a name="getDefaultInfo"></a><span class='hs-definition'>getDefaultInfo</span> <span class='hs-keyglyph'>::</span>  <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3646"></a><span class='hs-definition'>getDefaultInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-conid'>TcM.tcGetDefaultTys</span>
<a name="line-3647"></a>
<a name="line-3648"></a><span class='hs-comment'>-- Just get some environments needed for instance looking up and matching</span>
<a name="line-3649"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-3650"></a>
<a name="line-3651"></a><a name="getInstEnvs"></a><span class='hs-definition'>getInstEnvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>InstEnvs</span>
<a name="line-3652"></a><span class='hs-definition'>getInstEnvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.tcGetInstEnvs</span>
<a name="line-3653"></a>
<a name="line-3654"></a><a name="getFamInstEnvs"></a><span class='hs-definition'>getFamInstEnvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>)</span>
<a name="line-3655"></a><span class='hs-definition'>getFamInstEnvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>FamInst.tcGetFamInstEnvs</span>
<a name="line-3656"></a>
<a name="line-3657"></a><a name="getTopEnv"></a><span class='hs-definition'>getTopEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>HscEnv</span>
<a name="line-3658"></a><span class='hs-definition'>getTopEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.getTopEnv</span>
<a name="line-3659"></a>
<a name="line-3660"></a><a name="getGblEnv"></a><span class='hs-definition'>getGblEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-3661"></a><span class='hs-definition'>getGblEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.getGblEnv</span>
<a name="line-3662"></a>
<a name="line-3663"></a><a name="getLclEnv"></a><span class='hs-definition'>getLclEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcLclEnv</span>
<a name="line-3664"></a><span class='hs-definition'>getLclEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.getLclEnv</span>
<a name="line-3665"></a>
<a name="line-3666"></a><a name="tcLookupClass"></a><span class='hs-definition'>tcLookupClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Class</span>
<a name="line-3667"></a><span class='hs-definition'>tcLookupClass</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.tcLookupClass</span> <span class='hs-varid'>c</span>
<a name="line-3668"></a>
<a name="line-3669"></a><a name="tcLookupId"></a><span class='hs-definition'>tcLookupId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Id</span>
<a name="line-3670"></a><span class='hs-definition'>tcLookupId</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.tcLookupId</span> <span class='hs-varid'>n</span>
<a name="line-3671"></a>
<a name="line-3672"></a><a name="addUsedGREs"></a><span class='hs-comment'>-- Setting names as used (used in the deriving of Coercible evidence)</span>
<a name="line-3673"></a><span class='hs-comment'>-- Too hackish to expose it to TcS? In that case somehow extract the used</span>
<a name="line-3674"></a><span class='hs-comment'>-- constructors from the result of solveInteract</span>
<a name="line-3675"></a><span class='hs-definition'>addUsedGREs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3676"></a><span class='hs-definition'>addUsedGREs</span> <span class='hs-varid'>gres</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span>  <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.addUsedGREs</span> <span class='hs-varid'>gres</span>
<a name="line-3677"></a>
<a name="line-3678"></a><a name="addUsedGRE"></a><span class='hs-definition'>addUsedGRE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3679"></a><span class='hs-definition'>addUsedGRE</span> <span class='hs-varid'>warn_if_deprec</span> <span class='hs-varid'>gre</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.addUsedGRE</span> <span class='hs-varid'>warn_if_deprec</span> <span class='hs-varid'>gre</span>
<a name="line-3680"></a>
<a name="line-3681"></a><a name="keepAlive"></a><span class='hs-definition'>keepAlive</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3682"></a><span class='hs-definition'>keepAlive</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-conid'>TcM.keepAlive</span>
<a name="line-3683"></a>
<a name="line-3684"></a><span class='hs-comment'>-- Various smaller utilities [TODO, maybe will be absorbed in the instance matcher]</span>
<a name="line-3685"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-3686"></a>
<a name="line-3687"></a><a name="checkWellStagedDFun"></a><span class='hs-definition'>checkWellStagedDFun</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InstanceWhat</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3688"></a><span class='hs-comment'>-- Check that we do not try to use an instance before it is available.  E.g.</span>
<a name="line-3689"></a><span class='hs-comment'>--    instance Eq T where ...</span>
<a name="line-3690"></a><span class='hs-comment'>--    f x = $( ... (\(p::T) -&gt; p == p)... )</span>
<a name="line-3691"></a><span class='hs-comment'>-- Here we can't use the equality function from the instance in the splice</span>
<a name="line-3692"></a>
<a name="line-3693"></a><span class='hs-definition'>checkWellStagedDFun</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>what</span> <span class='hs-varid'>pred</span>
<a name="line-3694"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TopLevInstance</span> <span class='hs-layout'>{</span> <span class='hs-varid'>iw_dfun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dfun_id</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>what</span>
<a name="line-3695"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bind_lvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcM.topIdLvl</span> <span class='hs-varid'>dfun_id</span>
<a name="line-3696"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>bind_lvl</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>impLevel</span>
<a name="line-3697"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.setCtLocM</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-3698"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>use_stage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.getStage</span>
<a name="line-3699"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.checkWellStaged</span> <span class='hs-varid'>pp_thing</span> <span class='hs-varid'>bind_lvl</span> <span class='hs-layout'>(</span><span class='hs-varid'>thLevel</span> <span class='hs-varid'>use_stage</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3700"></a>
<a name="line-3701"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3702"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>    <span class='hs-comment'>-- Fast path for common case</span>
<a name="line-3703"></a>  <span class='hs-keyword'>where</span>
<a name="line-3704"></a>    <span class='hs-varid'>pp_thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"instance for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-3705"></a>
<a name="line-3706"></a><a name="pprEq"></a><span class='hs-definition'>pprEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3707"></a><span class='hs-definition'>pprEq</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'~'</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>ty2</span>
<a name="line-3708"></a>
<a name="line-3709"></a><a name="isFilledMetaTyVar_maybe"></a><span class='hs-definition'>isFilledMetaTyVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-3710"></a><span class='hs-definition'>isFilledMetaTyVar_maybe</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.isFilledMetaTyVar_maybe</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-3711"></a>
<a name="line-3712"></a><a name="isFilledMetaTyVar"></a><span class='hs-definition'>isFilledMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Bool</span>
<a name="line-3713"></a><span class='hs-definition'>isFilledMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.isFilledMetaTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-3714"></a>
<a name="line-3715"></a><a name="zonkTyCoVarsAndFV"></a><span class='hs-definition'>zonkTyCoVarsAndFV</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcTyCoVarSet</span>
<a name="line-3716"></a><span class='hs-definition'>zonkTyCoVarsAndFV</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.zonkTyCoVarsAndFV</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-3717"></a>
<a name="line-3718"></a><a name="zonkTyCoVarsAndFVList"></a><span class='hs-definition'>zonkTyCoVarsAndFVList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyCoVar</span><span class='hs-keyglyph'>]</span>
<a name="line-3719"></a><span class='hs-definition'>zonkTyCoVarsAndFVList</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.zonkTyCoVarsAndFVList</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-3720"></a>
<a name="line-3721"></a><a name="zonkCo"></a><span class='hs-definition'>zonkCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Coercion</span>
<a name="line-3722"></a><span class='hs-definition'>zonkCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-conid'>TcM.zonkCo</span>
<a name="line-3723"></a>
<a name="line-3724"></a><a name="zonkTcType"></a><span class='hs-definition'>zonkTcType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcType</span>
<a name="line-3725"></a><span class='hs-definition'>zonkTcType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.zonkTcType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-3726"></a>
<a name="line-3727"></a><a name="zonkTcTypes"></a><span class='hs-definition'>zonkTcTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>
<a name="line-3728"></a><span class='hs-definition'>zonkTcTypes</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.zonkTcTypes</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-3729"></a>
<a name="line-3730"></a><a name="zonkTcTyVar"></a><span class='hs-definition'>zonkTcTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcType</span>
<a name="line-3731"></a><span class='hs-definition'>zonkTcTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.zonkTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-3732"></a>
<a name="line-3733"></a><a name="zonkSimples"></a><span class='hs-definition'>zonkSimples</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Cts</span>
<a name="line-3734"></a><span class='hs-definition'>zonkSimples</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.zonkSimples</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span>
<a name="line-3735"></a>
<a name="line-3736"></a><a name="zonkWC"></a><span class='hs-definition'>zonkWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-3737"></a><span class='hs-definition'>zonkWC</span> <span class='hs-varid'>wc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.zonkWC</span> <span class='hs-varid'>wc</span><span class='hs-layout'>)</span>
<a name="line-3738"></a>
<a name="line-3739"></a><a name="zonkTyCoVarKind"></a><span class='hs-definition'>zonkTyCoVarKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcTyCoVar</span>
<a name="line-3740"></a><span class='hs-definition'>zonkTyCoVarKind</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.zonkTyCoVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-3741"></a>
<a name="line-3742"></a><a name="pprKicked"></a><span class='hs-comment'>----------------------------</span>
<a name="line-3743"></a><span class='hs-definition'>pprKicked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3744"></a><span class='hs-definition'>pprKicked</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-3745"></a><span class='hs-definition'>pprKicked</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>int</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"kicked out"</span><span class='hs-layout'>)</span>
<a name="line-3746"></a>
<a name="line-3747"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-3748"></a>*                                                                      *
<a name="line-3749"></a>*              The Unification Level Flag                              *
<a name="line-3750"></a>*                                                                      *
<a name="line-3751"></a>********************************************************************* -}</span>
<a name="line-3752"></a>
<a name="line-3753"></a><span class='hs-comment'>{- Note [The Unification Level Flag]
<a name="line-3754"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-3755"></a>Consider a deep tree of implication constraints
<a name="line-3756"></a>   forall[1] a.                              -- Outer-implic
<a name="line-3757"></a>      C alpha[1]                               -- Simple
<a name="line-3758"></a>      forall[2] c. ....(C alpha[1])....        -- Implic-1
<a name="line-3759"></a>      forall[2] b. ....(alpha[1] ~ Int)....    -- Implic-2
<a name="line-3760"></a>
<a name="line-3761"></a>The (C alpha) is insoluble until we know alpha.  We solve alpha
<a name="line-3762"></a>by unifying alpha:=Int somewhere deep inside Implic-2. But then we
<a name="line-3763"></a>must try to solve the Outer-implic all over again. This time we can
<a name="line-3764"></a>solve (C alpha) both in Outer-implic, and nested inside Implic-1.
<a name="line-3765"></a>
<a name="line-3766"></a>When should we iterate solving a level-n implication?
<a name="line-3767"></a>Answer: if any unification of a tyvar at level n takes place
<a name="line-3768"></a>        in the ic_implics of that implication.
<a name="line-3769"></a>
<a name="line-3770"></a>* What if a unification takes place at level n-1? Then don't iterate
<a name="line-3771"></a>  level n, because we'll iterate level n-1, and that will in turn iterate
<a name="line-3772"></a>  level n.
<a name="line-3773"></a>
<a name="line-3774"></a>* What if a unification takes place at level n, in the ic_simples of
<a name="line-3775"></a>  level n?  No need to track this, because the kick-out mechanism deals
<a name="line-3776"></a>  with it.  (We can't drop kick-out in favour of iteration, because kick-out
<a name="line-3777"></a>  works for skolem-equalities, not just unifications.)
<a name="line-3778"></a>
<a name="line-3779"></a>So the monad-global Unification Level Flag, kept in tcs_unif_lvl keeps
<a name="line-3780"></a>track of
<a name="line-3781"></a>  - Whether any unifications at all have taken place (Nothing =&gt; no unifications)
<a name="line-3782"></a>  - If so, what is the outermost level that has seen a unification (Just lvl)
<a name="line-3783"></a>
<a name="line-3784"></a>The iteration done in the simplify_loop/maybe_simplify_again loop in GHC.Tc.Solver.
<a name="line-3785"></a>
<a name="line-3786"></a>It helpful not to iterate unless there is a chance of progress.  #8474 is
<a name="line-3787"></a>an example:
<a name="line-3788"></a>
<a name="line-3789"></a>  * There's a deeply-nested chain of implication constraints.
<a name="line-3790"></a>       ?x:alpha =&gt; ?y1:beta1 =&gt; ... ?yn:betan =&gt; [W] ?x:Int
<a name="line-3791"></a>
<a name="line-3792"></a>  * From the innermost one we get a [D] alpha[1] ~ Int,
<a name="line-3793"></a>    so we can unify.
<a name="line-3794"></a>
<a name="line-3795"></a>  * It's better not to iterate the inner implications, but go all the
<a name="line-3796"></a>    way out to level 1 before iterating -- because iterating level 1
<a name="line-3797"></a>    will iterate the inner levels anyway.
<a name="line-3798"></a>
<a name="line-3799"></a>(In the olden days when we "floated" thse Derived constraints, this was
<a name="line-3800"></a>much, much more important -- we got exponential behaviour, as each iteration
<a name="line-3801"></a>produced the same Derived constraint.)
<a name="line-3802"></a>-}</span>
<a name="line-3803"></a>
<a name="line-3804"></a>
<a name="line-3805"></a><a name="resetUnificationFlag"></a><span class='hs-definition'>resetUnificationFlag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Bool</span>
<a name="line-3806"></a><span class='hs-comment'>-- We are at ambient level i</span>
<a name="line-3807"></a><span class='hs-comment'>-- If the unification flag = Just i, reset it to Nothing and return True</span>
<a name="line-3808"></a><span class='hs-comment'>-- Otherwise leave it unchanged and return False</span>
<a name="line-3809"></a><span class='hs-definition'>resetUnificationFlag</span>
<a name="line-3810"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-3811"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcs_unif_lvl</span> <span class='hs-varid'>env</span>
<a name="line-3812"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ambient_lvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.getTcLevel</span>
<a name="line-3813"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mb_lvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>ref</span>
<a name="line-3814"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.traceTc</span> <span class='hs-str'>"resetUnificationFlag"</span> <span class='hs-varop'>$</span>
<a name="line-3815"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ambient:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ambient_lvl</span>
<a name="line-3816"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"unif_lvl:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mb_lvl</span> <span class='hs-keyglyph'>]</span>
<a name="line-3817"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_lvl</span> <span class='hs-keyword'>of</span>
<a name="line-3818"></a>           <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-3819"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>unif_lvl</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ambient_lvl</span> <span class='hs-varop'>`strictlyDeeperThan`</span> <span class='hs-varid'>unif_lvl</span>
<a name="line-3820"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-3821"></a>                         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3822"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>TcM.writeTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-conid'>Nothing</span>
<a name="line-3823"></a>                               <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-3824"></a>
<a name="line-3825"></a><a name="setUnificationFlag"></a><span class='hs-definition'>setUnificationFlag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3826"></a><span class='hs-comment'>-- (setUnificationFlag i) sets the unification level to (Just i)</span>
<a name="line-3827"></a><span class='hs-comment'>-- unless it already is (Just j) where j &lt;= i</span>
<a name="line-3828"></a><span class='hs-definition'>setUnificationFlag</span> <span class='hs-varid'>lvl</span>
<a name="line-3829"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-3830"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcs_unif_lvl</span> <span class='hs-varid'>env</span>
<a name="line-3831"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mb_lvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>ref</span>
<a name="line-3832"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_lvl</span> <span class='hs-keyword'>of</span>
<a name="line-3833"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>unif_lvl</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>lvl</span> <span class='hs-varop'>`deeperThanOrSame`</span> <span class='hs-varid'>unif_lvl</span>
<a name="line-3834"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-3835"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM.writeTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>lvl</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3836"></a>
<a name="line-3837"></a>
<a name="line-3838"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-3839"></a>*                                                                      *
<a name="line-3840"></a>*                Instantiation etc.
<a name="line-3841"></a>*                                                                      *
<a name="line-3842"></a>********************************************************************* -}</span>
<a name="line-3843"></a>
<a name="line-3844"></a><span class='hs-comment'>-- Instantiations</span>
<a name="line-3845"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-3846"></a>
<a name="line-3847"></a><a name="instDFunType"></a><span class='hs-definition'>instDFunType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DFunId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DFunInstType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcThetaType</span><span class='hs-layout'>)</span>
<a name="line-3848"></a><span class='hs-definition'>instDFunType</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varid'>inst_tys</span>
<a name="line-3849"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.instDFunType</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varid'>inst_tys</span>
<a name="line-3850"></a>
<a name="line-3851"></a><a name="newFlexiTcSTy"></a><span class='hs-definition'>newFlexiTcSTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcType</span>
<a name="line-3852"></a><span class='hs-definition'>newFlexiTcSTy</span> <span class='hs-varid'>knd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.newFlexiTyVarTy</span> <span class='hs-varid'>knd</span><span class='hs-layout'>)</span>
<a name="line-3853"></a>
<a name="line-3854"></a><a name="cloneMetaTyVar"></a><span class='hs-definition'>cloneMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-3855"></a><span class='hs-definition'>cloneMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.cloneMetaTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-3856"></a>
<a name="line-3857"></a><a name="instFlexi"></a><span class='hs-definition'>instFlexi</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TKVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-3858"></a><span class='hs-definition'>instFlexi</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>instFlexiX</span> <span class='hs-varid'>emptyTCvSubst</span>
<a name="line-3859"></a>
<a name="line-3860"></a><a name="instFlexiX"></a><span class='hs-definition'>instFlexiX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TKVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-3861"></a><span class='hs-definition'>instFlexiX</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span>
<a name="line-3862"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldlM</span> <span class='hs-varid'>instFlexiHelper</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-3863"></a>
<a name="line-3864"></a><a name="instFlexiHelper"></a><span class='hs-definition'>instFlexiHelper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TKVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-3865"></a><span class='hs-definition'>instFlexiHelper</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-3866"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newUnique</span>
<a name="line-3867"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newMetaDetails</span> <span class='hs-conid'>TauTv</span>
<a name="line-3868"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setNameUnique</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>uniq</span>
<a name="line-3869"></a>             <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyUnchecked</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-3870"></a>             <span class='hs-varid'>ty'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span>
<a name="line-3871"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.traceTc</span> <span class='hs-str'>"instFlexi"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>
<a name="line-3872"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3873"></a>
<a name="line-3874"></a><a name="matchGlobalInst"></a><span class='hs-definition'>matchGlobalInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-3875"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>      <span class='hs-comment'>-- True &lt;=&gt; caller is the short-cut solver</span>
<a name="line-3876"></a>                             <span class='hs-comment'>-- See Note [Shortcut solving: overlap]</span>
<a name="line-3877"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcM.ClsInstResult</span>
<a name="line-3878"></a><span class='hs-definition'>matchGlobalInst</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>short_cut</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-3879"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.matchGlobalInst</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>short_cut</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-3880"></a>
<a name="line-3881"></a><a name="tcInstSkolTyVarsX"></a><span class='hs-definition'>tcInstSkolTyVarsX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-3882"></a><span class='hs-definition'>tcInstSkolTyVarsX</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.tcInstSkolTyVarsX</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span>
<a name="line-3883"></a>
<a name="line-3884"></a><span class='hs-comment'>-- Creating and setting evidence variables and CtFlavors</span>
<a name="line-3885"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-3886"></a>
<a name="line-3887"></a><a name="MaybeNew"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>MaybeNew</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Fresh</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Cached</span> <span class='hs-conid'>EvExpr</span>
<a name="line-3888"></a>
<a name="line-3889"></a><a name="isFresh"></a><span class='hs-definition'>isFresh</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeNew</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3890"></a><span class='hs-definition'>isFresh</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fresh</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-3891"></a><span class='hs-definition'>isFresh</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cached</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-3892"></a>
<a name="line-3893"></a><a name="freshGoals"></a><span class='hs-definition'>freshGoals</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeNew</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CtEvidence</span><span class='hs-keyglyph'>]</span>
<a name="line-3894"></a><span class='hs-definition'>freshGoals</span> <span class='hs-varid'>mns</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Fresh</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mns</span> <span class='hs-keyglyph'>]</span>
<a name="line-3895"></a>
<a name="line-3896"></a><a name="getEvExpr"></a><span class='hs-definition'>getEvExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeNew</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvExpr</span>
<a name="line-3897"></a><span class='hs-definition'>getEvExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fresh</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvExpr</span> <span class='hs-varid'>ctev</span>
<a name="line-3898"></a><span class='hs-definition'>getEvExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cached</span> <span class='hs-varid'>evt</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evt</span>
<a name="line-3899"></a>
<a name="line-3900"></a><a name="setEvBind"></a><span class='hs-definition'>setEvBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3901"></a><span class='hs-definition'>setEvBind</span> <span class='hs-varid'>ev_bind</span>
<a name="line-3902"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>evb</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcEvBindsVar</span>
<a name="line-3903"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.addTcEvBind</span> <span class='hs-varid'>evb</span> <span class='hs-varid'>ev_bind</span> <span class='hs-layout'>}</span>
<a name="line-3904"></a>
<a name="line-3905"></a><a name="useVars"></a><span class='hs-comment'>-- | Mark variables as used filling a coercion hole</span>
<a name="line-3906"></a><span class='hs-definition'>useVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3907"></a><span class='hs-definition'>useVars</span> <span class='hs-varid'>co_vars</span>
<a name="line-3908"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcEvBindsVar</span>
<a name="line-3909"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ebv_tcvs</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-3910"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span>
<a name="line-3911"></a>         <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>ref</span>
<a name="line-3912"></a>            <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tcvs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcvs</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>co_vars</span>
<a name="line-3913"></a>            <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.writeTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>tcvs'</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-3914"></a>
<a name="line-3915"></a><a name="setWantedEq"></a><span class='hs-comment'>-- | Equalities only</span>
<a name="line-3916"></a><span class='hs-definition'>setWantedEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcEvDest</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3917"></a><span class='hs-definition'>setWantedEq</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleDest</span> <span class='hs-varid'>hole</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-3918"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>useVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3919"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fillCoercionHole</span> <span class='hs-varid'>hole</span> <span class='hs-varid'>co</span> <span class='hs-layout'>}</span>
<a name="line-3920"></a><span class='hs-definition'>setWantedEq</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvVarDest</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"setWantedEq"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-3921"></a>
<a name="line-3922"></a><a name="setWantedEvTerm"></a><span class='hs-comment'>-- | Good for both equalities and non-equalities</span>
<a name="line-3923"></a><span class='hs-definition'>setWantedEvTerm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcEvDest</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3924"></a><span class='hs-definition'>setWantedEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleDest</span> <span class='hs-varid'>hole</span><span class='hs-layout'>)</span> <span class='hs-varid'>tm</span>
<a name="line-3925"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>evTermCoercion_maybe</span> <span class='hs-varid'>tm</span>
<a name="line-3926"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>useVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3927"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fillCoercionHole</span> <span class='hs-varid'>hole</span> <span class='hs-varid'>co</span> <span class='hs-layout'>}</span>
<a name="line-3928"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3929"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- See Note [Yukky eq_sel for a HoleDest]</span>
<a name="line-3930"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>co_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coHoleCoVar</span> <span class='hs-varid'>hole</span>
<a name="line-3931"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setEvBind</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWantedEvBind</span> <span class='hs-varid'>co_var</span> <span class='hs-varid'>tm</span><span class='hs-layout'>)</span>
<a name="line-3932"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fillCoercionHole</span> <span class='hs-varid'>hole</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>co_var</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3933"></a>
<a name="line-3934"></a><span class='hs-definition'>setWantedEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvVarDest</span> <span class='hs-varid'>ev_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>tm</span>
<a name="line-3935"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setEvBind</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWantedEvBind</span> <span class='hs-varid'>ev_id</span> <span class='hs-varid'>tm</span><span class='hs-layout'>)</span>
<a name="line-3936"></a>
<a name="line-3937"></a><span class='hs-comment'>{- Note [Yukky eq_sel for a HoleDest]
<a name="line-3938"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-3939"></a>How can it be that a Wanted with HoleDest gets evidence that isn't
<a name="line-3940"></a>just a coercion? i.e. evTermCoercion_maybe returns Nothing.
<a name="line-3941"></a>
<a name="line-3942"></a>Consider [G] forall a. blah =&gt; a ~ T
<a name="line-3943"></a>         [W] S ~# T
<a name="line-3944"></a>
<a name="line-3945"></a>Then doTopReactEqPred carefully looks up the (boxed) constraint (S ~
<a name="line-3946"></a>T) in the quantified constraints, and wraps the (boxed) evidence it
<a name="line-3947"></a>gets back in an eq_sel to extract the unboxed (S ~# T).  We can't put
<a name="line-3948"></a>that term into a coercion, so we add a value binding
<a name="line-3949"></a>    h = eq_sel (...)
<a name="line-3950"></a>and the coercion variable h to fill the coercion hole.
<a name="line-3951"></a>We even re-use the CoHole's Id for this binding!
<a name="line-3952"></a>
<a name="line-3953"></a>Yuk!
<a name="line-3954"></a>-}</span>
<a name="line-3955"></a>
<a name="line-3956"></a><a name="fillCoercionHole"></a><span class='hs-definition'>fillCoercionHole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoercionHole</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3957"></a><span class='hs-definition'>fillCoercionHole</span> <span class='hs-varid'>hole</span> <span class='hs-varid'>co</span>
<a name="line-3958"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.fillCoercionHole</span> <span class='hs-varid'>hole</span> <span class='hs-varid'>co</span>
<a name="line-3959"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kickOutAfterFillingCoercionHole</span> <span class='hs-varid'>hole</span> <span class='hs-varid'>co</span> <span class='hs-layout'>}</span>
<a name="line-3960"></a>
<a name="line-3961"></a><a name="setEvBindIfWanted"></a><span class='hs-definition'>setEvBindIfWanted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3962"></a><span class='hs-definition'>setEvBindIfWanted</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>tm</span>
<a name="line-3963"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ev</span> <span class='hs-keyword'>of</span>
<a name="line-3964"></a>      <span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dest</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>setWantedEvTerm</span> <span class='hs-varid'>dest</span> <span class='hs-varid'>tm</span>
<a name="line-3965"></a>      <span class='hs-keyword'>_</span>                             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-3966"></a>
<a name="line-3967"></a><a name="newTcEvBinds"></a><span class='hs-definition'>newTcEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-3968"></a><span class='hs-definition'>newTcEvBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-conid'>TcM.newTcEvBinds</span>
<a name="line-3969"></a>
<a name="line-3970"></a><a name="newNoTcEvBinds"></a><span class='hs-definition'>newNoTcEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-3971"></a><span class='hs-definition'>newNoTcEvBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-conid'>TcM.newNoTcEvBinds</span>
<a name="line-3972"></a>
<a name="line-3973"></a><a name="newEvVar"></a><span class='hs-definition'>newEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvVar</span>
<a name="line-3974"></a><span class='hs-definition'>newEvVar</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.newEvVar</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-3975"></a>
<a name="line-3976"></a><a name="newGivenEvVar"></a><span class='hs-definition'>newGivenEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPredType</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvTerm</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-3977"></a><span class='hs-comment'>-- Make a new variable of the given PredType,</span>
<a name="line-3978"></a><span class='hs-comment'>-- immediately bind it to the given term</span>
<a name="line-3979"></a><span class='hs-comment'>-- and return its CtEvidence</span>
<a name="line-3980"></a><span class='hs-comment'>-- See Note [Bind new Givens immediately] in GHC.Tc.Types.Constraint</span>
<a name="line-3981"></a><span class='hs-definition'>newGivenEvVar</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-3982"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newBoundEvVarId</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>rhs</span>
<a name="line-3983"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3984"></a>
<a name="line-3985"></a><a name="newBoundEvVarId"></a><span class='hs-comment'>-- | Make a new 'Id' of the given type, bound (in the monad's EvBinds) to the</span>
<a name="line-3986"></a><span class='hs-comment'>-- given term</span>
<a name="line-3987"></a><span class='hs-definition'>newBoundEvVarId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvVar</span>
<a name="line-3988"></a><span class='hs-definition'>newBoundEvVarId</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>rhs</span>
<a name="line-3989"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEvVar</span> <span class='hs-varid'>pred</span>
<a name="line-3990"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setEvBind</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkGivenEvBind</span> <span class='hs-varid'>new_ev</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-3991"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>new_ev</span> <span class='hs-layout'>}</span>
<a name="line-3992"></a>
<a name="line-3993"></a><a name="newGivenEvVars"></a><span class='hs-definition'>newGivenEvVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TcPredType</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvTerm</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CtEvidence</span><span class='hs-keyglyph'>]</span>
<a name="line-3994"></a><span class='hs-definition'>newGivenEvVars</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>newGivenEvVar</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>pts</span>
<a name="line-3995"></a>
<a name="line-3996"></a><a name="emitNewWantedEq"></a><span class='hs-definition'>emitNewWantedEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Coercion</span>
<a name="line-3997"></a><span class='hs-comment'>-- | Emit a new Wanted equality into the work-list</span>
<a name="line-3998"></a><span class='hs-definition'>emitNewWantedEq</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-3999"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newWantedEq</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-4000"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendWorkListEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNonCanonical</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-4001"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>co</span> <span class='hs-layout'>}</span>
<a name="line-4002"></a>
<a name="line-4003"></a><a name="newWantedEq"></a><span class='hs-comment'>-- | Make a new equality CtEvidence</span>
<a name="line-4004"></a><span class='hs-definition'>newWantedEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>
<a name="line-4005"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-4006"></a><span class='hs-definition'>newWantedEq</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newWantedEq_SI</span> <span class='hs-conid'>WDeriv</span>
<a name="line-4007"></a>
<a name="line-4008"></a><a name="newWantedEq_SI"></a><span class='hs-definition'>newWantedEq_SI</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ShadowInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-4009"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>
<a name="line-4010"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-4011"></a><span class='hs-definition'>newWantedEq_SI</span> <span class='hs-varid'>si</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-4012"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hole</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.newCoercionHole</span> <span class='hs-varid'>pty</span>
<a name="line-4013"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emitting new coercion hole"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hole</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>pty</span><span class='hs-layout'>)</span>
<a name="line-4014"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HoleDest</span> <span class='hs-varid'>hole</span>
<a name="line-4015"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_nosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>si</span>
<a name="line-4016"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span><span class='hs-layout'>}</span>
<a name="line-4017"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>mkHoleCo</span> <span class='hs-varid'>hole</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-4018"></a>  <span class='hs-keyword'>where</span>
<a name="line-4019"></a>    <span class='hs-varid'>pty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPrimEqPredRole</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-4020"></a>
<a name="line-4021"></a><a name="newWantedEvVarNC"></a><span class='hs-comment'>-- no equalities here. Use newWantedEq instead</span>
<a name="line-4022"></a><span class='hs-definition'>newWantedEvVarNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-4023"></a><span class='hs-definition'>newWantedEvVarNC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newWantedEvVarNC_SI</span> <span class='hs-conid'>WDeriv</span>
<a name="line-4024"></a>
<a name="line-4025"></a><a name="newWantedEvVarNC_SI"></a><span class='hs-definition'>newWantedEvVarNC_SI</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ShadowInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-4026"></a><span class='hs-comment'>-- Don't look up in the solved/inerts; we know it's not there</span>
<a name="line-4027"></a><span class='hs-definition'>newWantedEvVarNC_SI</span> <span class='hs-varid'>si</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-4028"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEvVar</span> <span class='hs-varid'>pty</span>
<a name="line-4029"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emitting new wanted"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>new_ev</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>pty</span> <span class='hs-varop'>$$</span>
<a name="line-4030"></a>                                         <span class='hs-varid'>pprCtLoc</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-4031"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvVarDest</span> <span class='hs-varid'>new_ev</span>
<a name="line-4032"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_nosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>si</span>
<a name="line-4033"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>}</span>
<a name="line-4034"></a>
<a name="line-4035"></a><a name="newWantedEvVar"></a><span class='hs-definition'>newWantedEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>MaybeNew</span>
<a name="line-4036"></a><span class='hs-definition'>newWantedEvVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newWantedEvVar_SI</span> <span class='hs-conid'>WDeriv</span>
<a name="line-4037"></a>
<a name="line-4038"></a><a name="newWantedEvVar_SI"></a><span class='hs-definition'>newWantedEvVar_SI</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ShadowInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>MaybeNew</span>
<a name="line-4039"></a><span class='hs-comment'>-- For anything except ClassPred, this is the same as newWantedEvVarNC</span>
<a name="line-4040"></a><span class='hs-definition'>newWantedEvVar_SI</span> <span class='hs-varid'>si</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-4041"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_ct</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupInInerts</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-4042"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_ct</span> <span class='hs-keyword'>of</span>
<a name="line-4043"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>ctev</span>
<a name="line-4044"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isDerived</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span>
<a name="line-4045"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"newWantedEvVar/cache hit"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ctev</span>
<a name="line-4046"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Cached</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvExpr</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-4047"></a>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newWantedEvVarNC_SI</span> <span class='hs-varid'>si</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-4048"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fresh</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-4049"></a>
<a name="line-4050"></a><a name="newWanted"></a><span class='hs-definition'>newWanted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>MaybeNew</span>
<a name="line-4051"></a><span class='hs-comment'>-- Deals with both equalities and non equalities. Tries to look</span>
<a name="line-4052"></a><span class='hs-comment'>-- up non-equalities in the cache</span>
<a name="line-4053"></a><span class='hs-definition'>newWanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newWanted_SI</span> <span class='hs-conid'>WDeriv</span>
<a name="line-4054"></a>
<a name="line-4055"></a><a name="newWanted_SI"></a><span class='hs-definition'>newWanted_SI</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ShadowInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>MaybeNew</span>
<a name="line-4056"></a><span class='hs-definition'>newWanted_SI</span> <span class='hs-varid'>si</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-4057"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>role</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEqPredTys_maybe</span> <span class='hs-varid'>pty</span>
<a name="line-4058"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Fresh</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>newWantedEq_SI</span> <span class='hs-varid'>si</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-4059"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-4060"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newWantedEvVar_SI</span> <span class='hs-varid'>si</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-4061"></a>
<a name="line-4062"></a><a name="newWantedNC"></a><span class='hs-comment'>-- deals with both equalities and non equalities. Doesn't do any cache lookups.</span>
<a name="line-4063"></a><span class='hs-definition'>newWantedNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-4064"></a><span class='hs-definition'>newWantedNC</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-4065"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>role</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEqPredTys_maybe</span> <span class='hs-varid'>pty</span>
<a name="line-4066"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>newWantedEq</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-4067"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-4068"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newWantedEvVarNC</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-4069"></a>
<a name="line-4070"></a><a name="emitNewDeriveds"></a><span class='hs-definition'>emitNewDeriveds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcPredType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-4071"></a><span class='hs-definition'>emitNewDeriveds</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>preds</span>
<a name="line-4072"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>preds</span>
<a name="line-4073"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-4074"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-4075"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>evs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>newDerivedNC</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>preds</span>
<a name="line-4076"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emitting new deriveds"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span>
<a name="line-4077"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendWorkListDeriveds</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-4078"></a>
<a name="line-4079"></a><a name="emitNewDerivedEq"></a><span class='hs-definition'>emitNewDerivedEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-4080"></a><span class='hs-comment'>-- Create new equality Derived and put it in the work list</span>
<a name="line-4081"></a><span class='hs-comment'>-- There's no caching, no lookupInInerts</span>
<a name="line-4082"></a><span class='hs-definition'>emitNewDerivedEq</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-4083"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newDerivedNC</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPrimEqPredRole</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-4084"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emitting new derived equality"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>pprCtLoc</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-4085"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendWorkListEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNonCanonical</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-4086"></a>         <span class='hs-comment'>-- Very important: put in the wl_eqs</span>
<a name="line-4087"></a>         <span class='hs-comment'>-- See Note [Prioritise equalities] (Avoiding fundep iteration)</span>
<a name="line-4088"></a>
<a name="line-4089"></a><a name="newDerivedNC"></a><span class='hs-definition'>newDerivedNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-4090"></a><span class='hs-definition'>newDerivedNC</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pred</span>
<a name="line-4091"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span>
<a name="line-4092"></a>
<a name="line-4093"></a><a name="checkReductionDepth"></a><span class='hs-comment'>-- --------- Check done in GHC.Tc.Solver.Interact.selectNewWorkItem???? ---------</span>
<a name="line-4094"></a><span class='hs-comment'>-- | Checks if the depth of the given location is too much. Fails if</span>
<a name="line-4095"></a><span class='hs-comment'>-- it's too big, with an appropriate error message.</span>
<a name="line-4096"></a><span class='hs-definition'>checkReductionDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>   <span class='hs-comment'>-- ^ type being reduced</span>
<a name="line-4097"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-4098"></a><span class='hs-definition'>checkReductionDepth</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ty</span>
<a name="line-4099"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-4100"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>subGoalDepthExceeded</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocDepth</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-4101"></a>         <span class='hs-varid'>wrapErrTcS</span> <span class='hs-varop'>$</span>
<a name="line-4102"></a>         <span class='hs-varid'>solverDepthErrorTcS</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-4103"></a>
<a name="line-4104"></a><a name="matchFam"></a><span class='hs-definition'>matchFam</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionN</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-4105"></a><span class='hs-comment'>-- Given (F tys) return (ty, co), where co :: ty ~N F tys</span>
<a name="line-4106"></a><span class='hs-definition'>matchFam</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>first</span> <span class='hs-varid'>mkTcSymCo</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>matchFamTcM</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span>
<a name="line-4107"></a>
<a name="line-4108"></a><a name="matchFamTcM"></a><span class='hs-definition'>matchFamTcM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionN</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-4109"></a><span class='hs-comment'>-- Given (F tys) return (ty, co), where co :: F tys ~N ty</span>
<a name="line-4110"></a><span class='hs-definition'>matchFamTcM</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span>
<a name="line-4111"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fam_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>FamInst.tcGetFamInstEnvs</span>
<a name="line-4112"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>match_fam_result</span>
<a name="line-4113"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reduceTyFamApp_maybe</span> <span class='hs-varid'>fam_envs</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span>
<a name="line-4114"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.traceTc</span> <span class='hs-str'>"matchFamTcM"</span> <span class='hs-varop'>$</span>
<a name="line-4115"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Matching:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-4116"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ppr_res</span> <span class='hs-varid'>match_fam_result</span> <span class='hs-keyglyph'>]</span>
<a name="line-4117"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>match_fam_result</span> <span class='hs-layout'>}</span>
<a name="line-4118"></a>  <span class='hs-keyword'>where</span>
<a name="line-4119"></a>    <span class='hs-varid'>ppr_res</span> <span class='hs-conid'>Nothing</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Match failed"</span>
<a name="line-4120"></a>    <span class='hs-varid'>ppr_res</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Match succeeded:"</span><span class='hs-layout'>)</span>
<a name="line-4121"></a>                                <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Rewrites to:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-4122"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Coercion:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-4123"></a>
<a name="line-4124"></a><span class='hs-comment'>{-
<a name="line-4125"></a>Note [Residual implications]
<a name="line-4126"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-4127"></a>The wl_implics in the WorkList are the residual implication
<a name="line-4128"></a>constraints that are generated while solving or canonicalising the
<a name="line-4129"></a>current worklist.  Specifically, when canonicalising
<a name="line-4130"></a>   (forall a. t1 ~ forall a. t2)
<a name="line-4131"></a>from which we get the implication
<a name="line-4132"></a>   (forall a. t1 ~ t2)
<a name="line-4133"></a>See GHC.Tc.Solver.Monad.deferTcSForAllEq
<a name="line-4134"></a>-}</span>
<a name="line-4135"></a>
<a name="line-4136"></a><span class='hs-comment'>{-
<a name="line-4137"></a>************************************************************************
<a name="line-4138"></a>*                                                                      *
<a name="line-4139"></a>              Breaking type equality cycles
<a name="line-4140"></a>*                                                                      *
<a name="line-4141"></a>************************************************************************
<a name="line-4142"></a>-}</span>
<a name="line-4143"></a>
<a name="line-4144"></a><a name="breakTyEqCycle_maybe"></a><span class='hs-comment'>-- | Conditionally replace all type family applications in the RHS with fresh</span>
<a name="line-4145"></a><span class='hs-comment'>-- variables, emitting givens that relate the type family application to the</span>
<a name="line-4146"></a><span class='hs-comment'>-- variable. See Note [Type equality cycles] in GHC.Tc.Solver.Canonical.</span>
<a name="line-4147"></a><span class='hs-comment'>-- This only works under conditions as described in the Note; otherwise, returns</span>
<a name="line-4148"></a><span class='hs-comment'>-- Nothing.</span>
<a name="line-4149"></a><span class='hs-definition'>breakTyEqCycle_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-4150"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CheckTyEqResult</span>   <span class='hs-comment'>-- result of checkTypeEq</span>
<a name="line-4151"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CanEqLHS</span>
<a name="line-4152"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>     <span class='hs-comment'>-- RHS</span>
<a name="line-4153"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionN</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-4154"></a>                         <span class='hs-comment'>-- new RHS that doesn't have any type families</span>
<a name="line-4155"></a>                         <span class='hs-comment'>-- co :: new type ~N old type</span>
<a name="line-4156"></a>                         <span class='hs-comment'>-- TcTyVar is the LHS tv; convenient for the caller</span>
<a name="line-4157"></a><span class='hs-definition'>breakTyEqCycle_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocOrigin</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ctEvLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CycleBreakerOrigin</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-4158"></a>  <span class='hs-comment'>-- see Detail (7) of Note</span>
<a name="line-4159"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-4160"></a>
<a name="line-4161"></a><span class='hs-definition'>breakTyEqCycle_maybe</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>cte_result</span> <span class='hs-varid'>lhs</span> <span class='hs-varid'>rhs</span>
<a name="line-4162"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NomEq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>eq_rel</span>
<a name="line-4163"></a>
<a name="line-4164"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>cte_result</span> <span class='hs-varop'>`cterHasOnlyProblem`</span> <span class='hs-varid'>cteSolubleOccurs</span>
<a name="line-4165"></a>     <span class='hs-comment'>-- only do this if the only problem is a soluble occurs-check</span>
<a name="line-4166"></a>     <span class='hs-comment'>-- See Detail (8) of the Note.</span>
<a name="line-4167"></a>
<a name="line-4168"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>should_break</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>final_check</span>
<a name="line-4169"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>should_break</span> <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rhs</span>
<a name="line-4170"></a>                                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-4171"></a>                         <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-4172"></a>  <span class='hs-keyword'>where</span>
<a name="line-4173"></a>    <span class='hs-varid'>flavour</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvFlavour</span> <span class='hs-varid'>ev</span>
<a name="line-4174"></a>    <span class='hs-varid'>eq_rel</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvEqRel</span> <span class='hs-varid'>ev</span>
<a name="line-4175"></a>
<a name="line-4176"></a>    <span class='hs-varid'>final_check</span>
<a name="line-4177"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Given</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flavour</span>
<a name="line-4178"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>True</span>
<a name="line-4179"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ctFlavourContainsDerived</span> <span class='hs-varid'>flavour</span>
<a name="line-4180"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>TyVarLHS</span> <span class='hs-varid'>lhs_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lhs</span>
<a name="line-4181"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>touchabilityTest</span> <span class='hs-conid'>Derived</span> <span class='hs-varid'>lhs_tv</span> <span class='hs-varid'>rhs</span>
<a name="line-4182"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>result</span> <span class='hs-keyword'>of</span>
<a name="line-4183"></a>               <span class='hs-conid'>Untouchable</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-4184"></a>               <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span>
<a name="line-4185"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-4186"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-4187"></a>
<a name="line-4188"></a>    <span class='hs-comment'>-- This could be considerably more efficient. See Detail (5) of Note.</span>
<a name="line-4189"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionN</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-4190"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rewriterView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty'</span>
<a name="line-4191"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rep.TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-4192"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTypeFamilyTyCon</span> <span class='hs-varid'>tc</span>  <span class='hs-comment'>-- worried about whether this type family is not actually</span>
<a name="line-4193"></a>                              <span class='hs-comment'>-- causing trouble? See Detail (5) of Note.</span>
<a name="line-4194"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>extra_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-4195"></a>                 <span class='hs-varid'>fun_app</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>fun_args</span>
<a name="line-4196"></a>                 <span class='hs-varid'>fun_app_kind</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTypeKind</span> <span class='hs-varid'>fun_app</span>
<a name="line-4197"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>emit_work</span> <span class='hs-varid'>fun_app_kind</span> <span class='hs-varid'>fun_app</span>
<a name="line-4198"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>extra_args_cos</span><span class='hs-layout'>,</span> <span class='hs-varid'>extra_args'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-varid'>go</span> <span class='hs-varid'>extra_args</span>
<a name="line-4199"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppCos</span> <span class='hs-varid'>co</span> <span class='hs-varid'>extra_args_cos</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppTys</span> <span class='hs-varid'>new_ty</span> <span class='hs-varid'>extra_args'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-4200"></a>              <span class='hs-comment'>-- Worried that this substitution will change kinds?</span>
<a name="line-4201"></a>              <span class='hs-comment'>-- See Detail (3) of Note</span>
<a name="line-4202"></a>
<a name="line-4203"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-4204"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>cos</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tys</span>
<a name="line-4205"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConAppCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-4206"></a>
<a name="line-4207"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rep.AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-4208"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>co1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span>
<a name="line-4209"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>co2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty2</span>
<a name="line-4210"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-4211"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rep.FunTy</span> <span class='hs-varid'>vis</span> <span class='hs-varid'>w</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-4212"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>co_w</span><span class='hs-layout'>,</span> <span class='hs-varid'>w'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>w</span>
<a name="line-4213"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>co_arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span>
<a name="line-4214"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>co_res</span><span class='hs-layout'>,</span> <span class='hs-varid'>res'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>res</span>
<a name="line-4215"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>co_w</span> <span class='hs-varid'>co_arg</span> <span class='hs-varid'>co_res</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>vis</span> <span class='hs-varid'>w'</span> <span class='hs-varid'>arg'</span> <span class='hs-varid'>res'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-4216"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rep.CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>cast_co</span><span class='hs-layout'>)</span>
<a name="line-4217"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-4218"></a>             <span class='hs-comment'>-- co :: ty' ~N ty</span>
<a name="line-4219"></a>             <span class='hs-comment'>-- return_co :: (ty' |&gt; cast_co) ~ (ty |&gt; cast_co)</span>
<a name="line-4220"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>castCoercionKind1</span> <span class='hs-varid'>co</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>cast_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCastTy</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>cast_co</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-4221"></a>
<a name="line-4222"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Rep.TyVarTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skip</span> <span class='hs-varid'>ty</span>
<a name="line-4223"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Rep.LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skip</span> <span class='hs-varid'>ty</span>
<a name="line-4224"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Rep.ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skip</span> <span class='hs-varid'>ty</span>  <span class='hs-comment'>-- See Detail (1) of Note</span>
<a name="line-4225"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Rep.CoercionTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skip</span> <span class='hs-varid'>ty</span>  <span class='hs-comment'>-- See Detail (2) of Note</span>
<a name="line-4226"></a>
<a name="line-4227"></a>    <span class='hs-varid'>skip</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-4228"></a>
<a name="line-4229"></a>    <span class='hs-varid'>emit_work</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcKind</span>                   <span class='hs-comment'>-- of the function application</span>
<a name="line-4230"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>                   <span class='hs-comment'>-- original function application</span>
<a name="line-4231"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionN</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- rewritten type (the fresh tyvar)</span>
<a name="line-4232"></a>    <span class='hs-varid'>emit_work</span> <span class='hs-varid'>fun_app_kind</span> <span class='hs-varid'>fun_app</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>flavour</span> <span class='hs-keyword'>of</span>
<a name="line-4233"></a>      <span class='hs-conid'>Given</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-4234"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.newCycleBreakerTyVar</span> <span class='hs-varid'>fun_app_kind</span><span class='hs-layout'>)</span>
<a name="line-4235"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_ty</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>new_tv</span>
<a name="line-4236"></a>                 <span class='hs-varid'>given_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHeteroPrimEqPred</span> <span class='hs-varid'>fun_app_kind</span> <span class='hs-varid'>fun_app_kind</span>
<a name="line-4237"></a>                                                 <span class='hs-varid'>fun_app</span> <span class='hs-varid'>new_ty</span>
<a name="line-4238"></a>                 <span class='hs-varid'>given_term</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evCoercion</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>new_ty</span>  <span class='hs-comment'>-- See Detail (4) of Note</span>
<a name="line-4239"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>new_given</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newGivenEvVar</span> <span class='hs-varid'>new_loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>given_pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>given_term</span><span class='hs-layout'>)</span>
<a name="line-4240"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"breakTyEqCycle replacing type family in Given"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>new_given</span><span class='hs-layout'>)</span>
<a name="line-4241"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>emitWorkNC</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>new_given</span><span class='hs-keyglyph'>]</span>
<a name="line-4242"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>is</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-4243"></a>               <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cycle_breakers</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertCycleBreakerBinding</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>fun_app</span>
<a name="line-4244"></a>                                             <span class='hs-layout'>(</span><span class='hs-varid'>inert_cycle_breakers</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-4245"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-4246"></a>                <span class='hs-comment'>-- Why reflexive? See Detail (4) of the Note</span>
<a name="line-4247"></a>
<a name="line-4248"></a>      <span class='hs-sel'>_derived_or_wd</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-4249"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.newFlexiTyVar</span> <span class='hs-varid'>fun_app_kind</span><span class='hs-layout'>)</span>
<a name="line-4250"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>new_tv</span>
<a name="line-4251"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>emitNewWantedEq</span> <span class='hs-varid'>new_loc</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>new_ty</span> <span class='hs-varid'>fun_app</span>
<a name="line-4252"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-4253"></a>
<a name="line-4254"></a>      <span class='hs-comment'>-- See Detail (7) of the Note</span>
<a name="line-4255"></a>    <span class='hs-varid'>new_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updateCtLocOrigin</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvLoc</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-conid'>CycleBreakerOrigin</span>
<a name="line-4256"></a>
<a name="line-4257"></a><span class='hs-comment'>-- does not fit scenario from Note</span>
<a name="line-4258"></a><span class='hs-definition'>breakTyEqCycle_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-4259"></a>
<a name="line-4260"></a><a name="restoreTyVarCycles"></a><span class='hs-comment'>-- | Fill in CycleBreakerTvs with the variables they stand for.</span>
<a name="line-4261"></a><span class='hs-comment'>-- See Note [Type equality cycles] in GHC.Tc.Solver.Canonical.</span>
<a name="line-4262"></a><span class='hs-definition'>restoreTyVarCycles</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-4263"></a><span class='hs-definition'>restoreTyVarCycles</span> <span class='hs-varid'>is</span>
<a name="line-4264"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>forAllCycleBreakerBindings_</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_cycle_breakers</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> <span class='hs-conid'>TcM.writeMetaTyVar</span>
<a name="line-4265"></a><span class='hs-comment'>{-# SPECIALISE forAllCycleBreakerBindings_ ::
<a name="line-4266"></a>      CycleBreakerVarStack -&gt; (TcTyVar -&gt; TcType -&gt; TcM ()) -&gt; TcM () #-}</span>
<a name="line-4267"></a>
<a name="line-4268"></a><a name="rewriterView"></a><span class='hs-comment'>-- Unwrap a type synonym only when either:</span>
<a name="line-4269"></a><span class='hs-comment'>--   The type synonym is forgetful, or</span>
<a name="line-4270"></a><span class='hs-comment'>--   the type synonym mentions a type family in its expansion</span>
<a name="line-4271"></a><span class='hs-comment'>-- See Note [Rewriting synonyms] in GHC.Tc.Solver.Rewrite.</span>
<a name="line-4272"></a><span class='hs-definition'>rewriterView</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcType</span>
<a name="line-4273"></a><span class='hs-definition'>rewriterView</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Rep.TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-4274"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isForgetfulSynTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTypeSynonymTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isFamFreeTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-4275"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span>
<a name="line-4276"></a><span class='hs-definition'>rewriterView</span> <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre></body>
</html>
