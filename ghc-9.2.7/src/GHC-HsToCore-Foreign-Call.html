<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/HsToCore/Foreign/Call.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The University of Glasgow 2006
<a name="line-3"></a>(c) The AQUA Project, Glasgow University, 1994-1998
<a name="line-4"></a>
<a name="line-5"></a>
<a name="line-6"></a>Desugaring foreign calls
<a name="line-7"></a>-}</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-comment'>{-# OPTIONS_GHC -Wno-incomplete-uni-patterns #-}</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.HsToCore.Foreign.Call</span>
<a name="line-14"></a>   <span class='hs-layout'>(</span> <span class='hs-varid'>dsCCall</span>
<a name="line-15"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mkFCall</span>
<a name="line-16"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unboxArg</span>
<a name="line-17"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>boxResult</span>
<a name="line-18"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>resultWrapper</span>
<a name="line-19"></a>   <span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-keyword'>where</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.HsToCore.Monad</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Utils</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Make</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SourceText</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Id.Make</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.ForeignCall</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.DataCon</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.HsToCore.Utils</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.TcType</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Type</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Multiplicity</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Coercion</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Types.Prim</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCon</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Types</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Basic</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Literal</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Names</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Session</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-51"></a>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Maybe</span>
<a name="line-53"></a>
<a name="line-54"></a><span class='hs-comment'>{-
<a name="line-55"></a>Desugaring of @ccall@s consists of adding some state manipulation,
<a name="line-56"></a>unboxing any boxed primitive arguments and boxing the result if
<a name="line-57"></a>desired.
<a name="line-58"></a>
<a name="line-59"></a>The state stuff just consists of adding in
<a name="line-60"></a>@PrimIO (\ s -&gt; case s of { State# s# -&gt; ... })@ in an appropriate place.
<a name="line-61"></a>
<a name="line-62"></a>The unboxing is straightforward, as all information needed to unbox is
<a name="line-63"></a>available from the type.  For each boxed-primitive argument, we
<a name="line-64"></a>transform:
<a name="line-65"></a>\begin{verbatim}
<a name="line-66"></a>   _ccall_ foo [ r, t1, ... tm ] e1 ... em
<a name="line-67"></a>   |
<a name="line-68"></a>   |
<a name="line-69"></a>   V
<a name="line-70"></a>   case e1 of { T1# x1# -&gt;
<a name="line-71"></a>   ...
<a name="line-72"></a>   case em of { Tm# xm# -&gt; xm#
<a name="line-73"></a>   ccall# foo [ r, t1#, ... tm# ] x1# ... xm#
<a name="line-74"></a>   } ... }
<a name="line-75"></a>\end{verbatim}
<a name="line-76"></a>
<a name="line-77"></a>The reboxing of a @_ccall_@ result is a bit tricker: the types don't
<a name="line-78"></a>contain information about the state-pairing functions so we have to
<a name="line-79"></a>keep a list of \tr{(type, s-p-function)} pairs.  We transform as
<a name="line-80"></a>follows:
<a name="line-81"></a>\begin{verbatim}
<a name="line-82"></a>   ccall# foo [ r, t1#, ... tm# ] e1# ... em#
<a name="line-83"></a>   |
<a name="line-84"></a>   |
<a name="line-85"></a>   V
<a name="line-86"></a>   \ s# -&gt; case (ccall# foo [ r, t1#, ... tm# ] s# e1# ... em#) of
<a name="line-87"></a>          (StateAnd&lt;r&gt;# result# state#) -&gt; (R# result#, realWorld#)
<a name="line-88"></a>\end{verbatim}
<a name="line-89"></a>-}</span>
<a name="line-90"></a>
<a name="line-91"></a><a name="dsCCall"></a><span class='hs-definition'>dsCCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CLabelString</span> <span class='hs-comment'>-- C routine to invoke</span>
<a name="line-92"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreExpr</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- Arguments (desugared)</span>
<a name="line-93"></a>                        <span class='hs-comment'>-- Precondition: none have levity-polymorphic types</span>
<a name="line-94"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Safety</span>       <span class='hs-comment'>-- Safety of the call</span>
<a name="line-95"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>         <span class='hs-comment'>-- Type of the result: IO t</span>
<a name="line-96"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-comment'>-- Result, of type ???</span>
<a name="line-97"></a>
<a name="line-98"></a><span class='hs-definition'>dsCCall</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>args</span> <span class='hs-varid'>may_gc</span> <span class='hs-varid'>result_ty</span>
<a name="line-99"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>unboxed_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_wrappers</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-varid'>unboxArg</span> <span class='hs-varid'>args</span>
<a name="line-100"></a>       <span class='hs-layout'>(</span><span class='hs-varid'>ccall_result_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_wrapper</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>boxResult</span> <span class='hs-varid'>result_ty</span>
<a name="line-101"></a>       <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-102"></a>       <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-103"></a>       <span class='hs-keyword'>let</span>
<a name="line-104"></a>           <span class='hs-varid'>target</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StaticTarget</span> <span class='hs-conid'>NoSourceText</span> <span class='hs-varid'>lbl</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>True</span>
<a name="line-105"></a>           <span class='hs-varid'>the_fcall</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CCall</span> <span class='hs-layout'>(</span><span class='hs-conid'>CCallSpec</span> <span class='hs-varid'>target</span> <span class='hs-conid'>CCallConv</span> <span class='hs-varid'>may_gc</span><span class='hs-layout'>)</span>
<a name="line-106"></a>           <span class='hs-varid'>the_prim_app</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFCall</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>the_fcall</span> <span class='hs-varid'>unboxed_args</span> <span class='hs-varid'>ccall_result_ty</span>
<a name="line-107"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varop'>$</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>res_wrapper</span> <span class='hs-varid'>the_prim_app</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_wrappers</span><span class='hs-layout'>)</span>
<a name="line-108"></a>
<a name="line-109"></a><a name="mkFCall"></a><span class='hs-definition'>mkFCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ForeignCall</span>
<a name="line-110"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreExpr</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- Args</span>
<a name="line-111"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>           <span class='hs-comment'>-- Result type</span>
<a name="line-112"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-113"></a><span class='hs-comment'>-- Construct the ccall.  The only tricky bit is that the ccall Id should have</span>
<a name="line-114"></a><span class='hs-comment'>-- no free vars, so if any of the arg tys do we must give it a polymorphic type.</span>
<a name="line-115"></a><span class='hs-comment'>--      [I forget *why* it should have no free vars!]</span>
<a name="line-116"></a><span class='hs-comment'>-- For example:</span>
<a name="line-117"></a><span class='hs-comment'>--      mkCCall ... [s::StablePtr (a-&gt;b), x::Addr, c::Char]</span>
<a name="line-118"></a><span class='hs-comment'>--</span>
<a name="line-119"></a><span class='hs-comment'>-- Here we build a ccall thus</span>
<a name="line-120"></a><span class='hs-comment'>--      (ccallid::(forall a b.  StablePtr (a -&gt; b) -&gt; Addr -&gt; Char -&gt; IO Addr))</span>
<a name="line-121"></a><span class='hs-comment'>--                      a b s x c</span>
<a name="line-122"></a><span class='hs-definition'>mkFCall</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>the_fcall</span> <span class='hs-varid'>val_args</span> <span class='hs-varid'>res_ty</span>
<a name="line-123"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tyvars</span> <span class='hs-layout'>)</span>  <span class='hs-comment'>-- this must be true because the type is top-level</span>
<a name="line-124"></a>    <span class='hs-varid'>mkApps</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarApps</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>the_fcall_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>)</span> <span class='hs-varid'>val_args</span>
<a name="line-125"></a>  <span class='hs-keyword'>where</span>
<a name="line-126"></a>    <span class='hs-varid'>arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>exprType</span> <span class='hs-varid'>val_args</span>
<a name="line-127"></a>    <span class='hs-varid'>body_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVisFunTysMany</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-128"></a>    <span class='hs-varid'>tyvars</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfTypeWellScoped</span> <span class='hs-varid'>body_ty</span>
<a name="line-129"></a>    <span class='hs-varid'>ty</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInfForAllTys</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>body_ty</span>
<a name="line-130"></a>    <span class='hs-varid'>the_fcall_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFCallId</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>the_fcall</span> <span class='hs-varid'>ty</span>
<a name="line-131"></a>
<a name="line-132"></a><a name="unboxArg"></a><span class='hs-definition'>unboxArg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span>                    <span class='hs-comment'>-- The supplied argument, not levity-polymorphic</span>
<a name="line-133"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>,</span>              <span class='hs-comment'>-- To pass as the actual argument</span>
<a name="line-134"></a>                 <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>   <span class='hs-comment'>-- Wrapper to unbox the arg</span>
<a name="line-135"></a>                <span class='hs-layout'>)</span>
<a name="line-136"></a><span class='hs-comment'>-- Example: if the arg is e::Int, unboxArg will return</span>
<a name="line-137"></a><span class='hs-comment'>--      (x#::Int#, \W. case x of I# x# -&gt; W)</span>
<a name="line-138"></a><span class='hs-comment'>-- where W is a CoreExpr that probably mentions x#</span>
<a name="line-139"></a>
<a name="line-140"></a><span class='hs-comment'>-- always returns a non-levity-polymorphic expression</span>
<a name="line-141"></a>
<a name="line-142"></a><span class='hs-definition'>unboxArg</span> <span class='hs-varid'>arg</span>
<a name="line-143"></a>  <span class='hs-comment'>-- Primitive types: nothing to unbox</span>
<a name="line-144"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPrimitiveType</span> <span class='hs-varid'>arg_ty</span>
<a name="line-145"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>body</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-146"></a>
<a name="line-147"></a>  <span class='hs-comment'>-- Recursive newtypes</span>
<a name="line-148"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span><span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-sel'>_rep_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>topNormaliseNewType_maybe</span> <span class='hs-varid'>arg_ty</span>
<a name="line-149"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unboxArg</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCastDs</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-150"></a>
<a name="line-151"></a>  <span class='hs-comment'>-- Booleans</span>
<a name="line-152"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>,</span>
<a name="line-153"></a>    <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>boolTyConKey</span>
<a name="line-154"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-155"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-156"></a>       <span class='hs-varid'>prim_arg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalDs</span> <span class='hs-conid'>Many</span> <span class='hs-varid'>intPrimTy</span>
<a name="line-157"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>prim_arg</span><span class='hs-layout'>,</span>
<a name="line-158"></a>              <span class='hs-keyglyph'>\</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Case</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIfThenElse</span> <span class='hs-varid'>arg</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIntLit</span> <span class='hs-varid'>platform</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIntLit</span> <span class='hs-varid'>platform</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-159"></a>                             <span class='hs-varid'>prim_arg</span>
<a name="line-160"></a>                             <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-161"></a>                             <span class='hs-keyglyph'>[</span><span class='hs-conid'>Alt</span> <span class='hs-conid'>DEFAULT</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>body</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-162"></a>
<a name="line-163"></a>  <span class='hs-comment'>-- Data types with a single constructor, which has a single, primitive-typed arg</span>
<a name="line-164"></a>  <span class='hs-comment'>-- This deals with Int, Float etc; also Ptr, ForeignPtr</span>
<a name="line-165"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_product_type</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>data_con_arity</span> <span class='hs-varop'>==</span> <span class='hs-num'>1</span>
<a name="line-166"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span><span class='hs-varid'>isUnliftedType</span> <span class='hs-varid'>data_con_arg_ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprType</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span>
<a name="line-167"></a>                        <span class='hs-comment'>-- Typechecker ensures this</span>
<a name="line-168"></a>    <span class='hs-keyword'>do</span> <span class='hs-varid'>case_bndr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalDs</span> <span class='hs-conid'>Many</span> <span class='hs-varid'>arg_ty</span>
<a name="line-169"></a>       <span class='hs-varid'>prim_arg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalDs</span> <span class='hs-conid'>Many</span> <span class='hs-varid'>data_con_arg_ty1</span>
<a name="line-170"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>prim_arg</span><span class='hs-layout'>,</span>
<a name="line-171"></a>               <span class='hs-keyglyph'>\</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Case</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>case_bndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Alt</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>prim_arg</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>body</span><span class='hs-keyglyph'>]</span>
<a name="line-172"></a>              <span class='hs-layout'>)</span>
<a name="line-173"></a>
<a name="line-174"></a>  <span class='hs-comment'>-- Byte-arrays, both mutable and otherwise; hack warning</span>
<a name="line-175"></a>  <span class='hs-comment'>-- We're looking for values of type ByteArray, MutableByteArray</span>
<a name="line-176"></a>  <span class='hs-comment'>--    data ByteArray          ix = ByteArray        ix ix ByteArray#</span>
<a name="line-177"></a>  <span class='hs-comment'>--    data MutableByteArray s ix = MutableByteArray ix ix (MutableByteArray# s)</span>
<a name="line-178"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_product_type</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-179"></a>    <span class='hs-varid'>data_con_arity</span> <span class='hs-varop'>==</span> <span class='hs-num'>3</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-180"></a>    <span class='hs-varid'>isJust</span> <span class='hs-varid'>maybe_arg3_tycon</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-181"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>arg3_tycon</span> <span class='hs-varop'>==</span>  <span class='hs-varid'>byteArrayPrimTyCon</span> <span class='hs-varop'>||</span>
<a name="line-182"></a>     <span class='hs-varid'>arg3_tycon</span> <span class='hs-varop'>==</span>  <span class='hs-varid'>mutableByteArrayPrimTyCon</span><span class='hs-layout'>)</span>
<a name="line-183"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>case_bndr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalDs</span> <span class='hs-conid'>Many</span> <span class='hs-varid'>arg_ty</span>
<a name="line-184"></a>       <span class='hs-varid'>vars</span><span class='hs-keyglyph'>@</span><span class='hs-keyglyph'>[</span><span class='hs-sel'>_l_var</span><span class='hs-layout'>,</span> <span class='hs-sel'>_r_var</span><span class='hs-layout'>,</span> <span class='hs-varid'>arr_cts_var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalsDs</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>unrestricted</span> <span class='hs-varid'>data_con_arg_tys</span><span class='hs-layout'>)</span>
<a name="line-185"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>arr_cts_var</span><span class='hs-layout'>,</span>
<a name="line-186"></a>               <span class='hs-keyglyph'>\</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Case</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>case_bndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Alt</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span> <span class='hs-varid'>vars</span> <span class='hs-varid'>body</span><span class='hs-keyglyph'>]</span>
<a name="line-187"></a>              <span class='hs-layout'>)</span>
<a name="line-188"></a>
<a name="line-189"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-190"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanDs</span>
<a name="line-191"></a>       <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"unboxArg: "</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>l</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span>
<a name="line-192"></a>  <span class='hs-keyword'>where</span>
<a name="line-193"></a>    <span class='hs-varid'>arg_ty</span>                                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprType</span> <span class='hs-varid'>arg</span>
<a name="line-194"></a>    <span class='hs-varid'>maybe_product_type</span>                          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitDataProductType_maybe</span> <span class='hs-varid'>arg_ty</span>
<a name="line-195"></a>    <span class='hs-varid'>is_product_type</span>                             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJust</span> <span class='hs-varid'>maybe_product_type</span>
<a name="line-196"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>,</span> <span class='hs-varid'>scaled_data_con_arg_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybe_product_type</span>
<a name="line-197"></a>    <span class='hs-varid'>data_con_arg_tys</span>                            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>scaledThing</span> <span class='hs-varid'>scaled_data_con_arg_tys</span>
<a name="line-198"></a>    <span class='hs-varid'>data_con_arity</span>                              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConSourceArity</span> <span class='hs-varid'>data_con</span>
<a name="line-199"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>data_con_arg_ty1</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>data_con_arg_tys</span>
<a name="line-200"></a>
<a name="line-201"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span> <span class='hs-conop'>:</span> <span class='hs-varid'>data_con_arg_ty3</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>data_con_arg_tys</span>
<a name="line-202"></a>    <span class='hs-varid'>maybe_arg3_tycon</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-varid'>data_con_arg_ty3</span>
<a name="line-203"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>arg3_tycon</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybe_arg3_tycon</span>
<a name="line-204"></a>
<a name="line-205"></a><a name="boxResult"></a><span class='hs-definition'>boxResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span>
<a name="line-206"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>
<a name="line-207"></a>
<a name="line-208"></a><span class='hs-comment'>-- Takes the result of the user-level ccall:</span>
<a name="line-209"></a><span class='hs-comment'>--      either (IO t),</span>
<a name="line-210"></a><span class='hs-comment'>--      or maybe just t for a side-effect-free call</span>
<a name="line-211"></a><span class='hs-comment'>-- Returns a wrapper for the primitive ccall itself, along with the</span>
<a name="line-212"></a><span class='hs-comment'>-- type of the result of the primitive ccall.  This result type</span>
<a name="line-213"></a><span class='hs-comment'>-- will be of the form</span>
<a name="line-214"></a><span class='hs-comment'>--      State# RealWorld -&gt; (# State# RealWorld, t' #)</span>
<a name="line-215"></a><span class='hs-comment'>-- where t' is the unwrapped form of t.  If t is simply (), then</span>
<a name="line-216"></a><span class='hs-comment'>-- the result type will be</span>
<a name="line-217"></a><span class='hs-comment'>--      State# RealWorld -&gt; (# State# RealWorld #)</span>
<a name="line-218"></a>
<a name="line-219"></a><span class='hs-definition'>boxResult</span> <span class='hs-varid'>result_ty</span>
<a name="line-220"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>io_tycon</span><span class='hs-layout'>,</span> <span class='hs-varid'>io_res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitIOType_maybe</span> <span class='hs-varid'>result_ty</span>
<a name="line-221"></a>        <span class='hs-comment'>-- isIOType_maybe handles the case where the type is a</span>
<a name="line-222"></a>        <span class='hs-comment'>-- simple wrapping of IO.  E.g.</span>
<a name="line-223"></a>        <span class='hs-comment'>--      newtype Wrap a = W (IO a)</span>
<a name="line-224"></a>        <span class='hs-comment'>-- No coercion necessary because its a non-recursive newtype</span>
<a name="line-225"></a>        <span class='hs-comment'>-- (If we wanted to handle a *recursive* newtype too, we'd need</span>
<a name="line-226"></a>        <span class='hs-comment'>-- another case, and a coercion.)</span>
<a name="line-227"></a>        <span class='hs-comment'>-- The result is IO t, so wrap the result in an IO constructor</span>
<a name="line-228"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>resultWrapper</span> <span class='hs-varid'>io_res_ty</span>
<a name="line-229"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>extra_result_tys</span>
<a name="line-230"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>res</span> <span class='hs-keyword'>of</span>
<a name="line-231"></a>                     <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-232"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnboxedTupleType</span> <span class='hs-varid'>ty</span>
<a name="line-233"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppArgs_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>in</span> <span class='hs-varid'>tail</span> <span class='hs-varid'>ls</span>
<a name="line-234"></a>                     <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-235"></a>
<a name="line-236"></a>              <span class='hs-varid'>return_result</span> <span class='hs-varid'>state</span> <span class='hs-varid'>anss</span>
<a name="line-237"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoreUbxTup</span>
<a name="line-238"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>realWorldStatePrimTy</span> <span class='hs-conop'>:</span> <span class='hs-varid'>io_res_ty</span> <span class='hs-conop'>:</span> <span class='hs-varid'>extra_result_tys</span><span class='hs-layout'>)</span>
<a name="line-239"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>state</span> <span class='hs-conop'>:</span> <span class='hs-varid'>anss</span><span class='hs-layout'>)</span>
<a name="line-240"></a>
<a name="line-241"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ccall_res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>the_alt</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mk_alt</span> <span class='hs-varid'>return_result</span> <span class='hs-varid'>res</span>
<a name="line-242"></a>
<a name="line-243"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>state_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalDs</span> <span class='hs-conid'>Many</span> <span class='hs-varid'>realWorldStatePrimTy</span>
<a name="line-244"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>io_data_con</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>head</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>io_tycon</span><span class='hs-layout'>)</span>
<a name="line-245"></a>              <span class='hs-varid'>toIOCon</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConWrapId</span> <span class='hs-varid'>io_data_con</span>
<a name="line-246"></a>
<a name="line-247"></a>              <span class='hs-varid'>wrap</span> <span class='hs-varid'>the_call</span> <span class='hs-keyglyph'>=</span>
<a name="line-248"></a>                              <span class='hs-varid'>mkApps</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>toIOCon</span><span class='hs-layout'>)</span>
<a name="line-249"></a>                                     <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Type</span> <span class='hs-varid'>io_res_ty</span><span class='hs-layout'>,</span>
<a name="line-250"></a>                                       <span class='hs-conid'>Lam</span> <span class='hs-varid'>state_id</span> <span class='hs-varop'>$</span>
<a name="line-251"></a>                                       <span class='hs-varid'>mkWildCase</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>the_call</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>state_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-252"></a>                                             <span class='hs-layout'>(</span><span class='hs-varid'>unrestricted</span> <span class='hs-varid'>ccall_res_ty</span><span class='hs-layout'>)</span>
<a name="line-253"></a>                                             <span class='hs-layout'>(</span><span class='hs-varid'>coreAltType</span> <span class='hs-varid'>the_alt</span><span class='hs-layout'>)</span>
<a name="line-254"></a>                                             <span class='hs-keyglyph'>[</span><span class='hs-varid'>the_alt</span><span class='hs-keyglyph'>]</span>
<a name="line-255"></a>                                     <span class='hs-keyglyph'>]</span>
<a name="line-256"></a>
<a name="line-257"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>realWorldStatePrimTy</span> <span class='hs-varop'>`mkVisFunTyMany`</span> <span class='hs-varid'>ccall_res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-258"></a>
<a name="line-259"></a><span class='hs-definition'>boxResult</span> <span class='hs-varid'>result_ty</span>
<a name="line-260"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-comment'>-- It isn't IO, so do unsafePerformIO</span>
<a name="line-261"></a>       <span class='hs-comment'>-- It's not conveniently available, so we inline it</span>
<a name="line-262"></a>       <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>resultWrapper</span> <span class='hs-varid'>result_ty</span>
<a name="line-263"></a>       <span class='hs-layout'>(</span><span class='hs-varid'>ccall_res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>the_alt</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mk_alt</span> <span class='hs-varid'>return_result</span> <span class='hs-varid'>res</span>
<a name="line-264"></a>       <span class='hs-keyword'>let</span>
<a name="line-265"></a>           <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>the_call</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkWildCase</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>the_call</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>realWorldPrimId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-266"></a>                                           <span class='hs-layout'>(</span><span class='hs-varid'>unrestricted</span> <span class='hs-varid'>ccall_res_ty</span><span class='hs-layout'>)</span>
<a name="line-267"></a>                                           <span class='hs-layout'>(</span><span class='hs-varid'>coreAltType</span> <span class='hs-varid'>the_alt</span><span class='hs-layout'>)</span>
<a name="line-268"></a>                                           <span class='hs-keyglyph'>[</span><span class='hs-varid'>the_alt</span><span class='hs-keyglyph'>]</span>
<a name="line-269"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>realWorldStatePrimTy</span> <span class='hs-varop'>`mkVisFunTyMany`</span> <span class='hs-varid'>ccall_res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>)</span>
<a name="line-270"></a>  <span class='hs-keyword'>where</span>
<a name="line-271"></a>    <span class='hs-varid'>return_result</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ans</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ans</span>
<a name="line-272"></a>    <span class='hs-varid'>return_result</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"return_result: expected single result"</span>
<a name="line-273"></a>
<a name="line-274"></a>
<a name="line-275"></a><a name="mk_alt"></a><span class='hs-definition'>mk_alt</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Expr</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Expr</span> <span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Expr</span> <span class='hs-conid'>Var</span><span class='hs-layout'>)</span>
<a name="line-276"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Expr</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Expr</span> <span class='hs-conid'>Var</span><span class='hs-layout'>)</span>
<a name="line-277"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreAlt</span><span class='hs-layout'>)</span>
<a name="line-278"></a><span class='hs-definition'>mk_alt</span> <span class='hs-varid'>return_result</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrap_result</span><span class='hs-layout'>)</span>
<a name="line-279"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-comment'>-- The ccall returns ()</span>
<a name="line-280"></a>       <span class='hs-varid'>state_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalDs</span> <span class='hs-conid'>Many</span> <span class='hs-varid'>realWorldStatePrimTy</span>
<a name="line-281"></a>       <span class='hs-keyword'>let</span>
<a name="line-282"></a>             <span class='hs-varid'>the_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return_result</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>state_id</span><span class='hs-layout'>)</span>
<a name="line-283"></a>                                     <span class='hs-keyglyph'>[</span><span class='hs-varid'>wrap_result</span> <span class='hs-layout'>(</span><span class='hs-varid'>panic</span> <span class='hs-str'>"boxResult"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-284"></a>
<a name="line-285"></a>             <span class='hs-varid'>ccall_res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTupleTy</span> <span class='hs-conid'>Unboxed</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>realWorldStatePrimTy</span><span class='hs-keyglyph'>]</span>
<a name="line-286"></a>             <span class='hs-varid'>the_alt</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Alt</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-layout'>(</span><span class='hs-varid'>tupleDataCon</span> <span class='hs-conid'>Unboxed</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>state_id</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>the_rhs</span>
<a name="line-287"></a>
<a name="line-288"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ccall_res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>the_alt</span><span class='hs-layout'>)</span>
<a name="line-289"></a>
<a name="line-290"></a><span class='hs-definition'>mk_alt</span> <span class='hs-varid'>return_result</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>prim_res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrap_result</span><span class='hs-layout'>)</span>
<a name="line-291"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- The ccall returns a non-() value</span>
<a name="line-292"></a>    <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isPrimitiveType</span> <span class='hs-varid'>prim_res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>prim_res_ty</span> <span class='hs-layout'>)</span>
<a name="line-293"></a>             <span class='hs-comment'>-- True because resultWrapper ensures it is so</span>
<a name="line-294"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>result_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalDs</span> <span class='hs-conid'>Many</span> <span class='hs-varid'>prim_res_ty</span>
<a name="line-295"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>state_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalDs</span> <span class='hs-conid'>Many</span> <span class='hs-varid'>realWorldStatePrimTy</span>
<a name="line-296"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>the_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return_result</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>state_id</span><span class='hs-layout'>)</span>
<a name="line-297"></a>                                <span class='hs-keyglyph'>[</span><span class='hs-varid'>wrap_result</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>result_id</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-298"></a>             <span class='hs-varid'>ccall_res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTupleTy</span> <span class='hs-conid'>Unboxed</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>realWorldStatePrimTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>prim_res_ty</span><span class='hs-keyglyph'>]</span>
<a name="line-299"></a>             <span class='hs-varid'>the_alt</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Alt</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-layout'>(</span><span class='hs-varid'>tupleDataCon</span> <span class='hs-conid'>Unboxed</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>state_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>result_id</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>the_rhs</span>
<a name="line-300"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ccall_res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>the_alt</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-301"></a>
<a name="line-302"></a>
<a name="line-303"></a><a name="resultWrapper"></a><span class='hs-definition'>resultWrapper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span>
<a name="line-304"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span>               <span class='hs-comment'>-- Type of the expected result, if any</span>
<a name="line-305"></a>                      <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>     <span class='hs-comment'>-- Wrapper for the result</span>
<a name="line-306"></a><span class='hs-comment'>-- resultWrapper deals with the result *value*</span>
<a name="line-307"></a><span class='hs-comment'>-- E.g. foreign import foo :: Int -&gt; IO T</span>
<a name="line-308"></a><span class='hs-comment'>-- Then resultWrapper deals with marshalling the 'T' part</span>
<a name="line-309"></a><span class='hs-comment'>-- So if    resultWrapper ty = (Just ty_rep, marshal)</span>
<a name="line-310"></a><span class='hs-comment'>--  then      marshal (e :: ty_rep) :: ty</span>
<a name="line-311"></a><span class='hs-comment'>-- That is, 'marshal' wrape the result returned by the foreign call,</span>
<a name="line-312"></a><span class='hs-comment'>-- of type ty_rep, into the value Haskell expected, of type 'ty'</span>
<a name="line-313"></a><span class='hs-comment'>--</span>
<a name="line-314"></a><span class='hs-comment'>-- Invariant: ty_rep is always a primitive type</span>
<a name="line-315"></a><span class='hs-comment'>--            i.e. (isPrimitiveType ty_rep) is True</span>
<a name="line-316"></a>
<a name="line-317"></a><span class='hs-definition'>resultWrapper</span> <span class='hs-varid'>result_ty</span>
<a name="line-318"></a>  <span class='hs-comment'>-- Base case 1: primitive types</span>
<a name="line-319"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPrimitiveType</span> <span class='hs-varid'>result_ty</span>
<a name="line-320"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>result_ty</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-321"></a>
<a name="line-322"></a>  <span class='hs-comment'>-- Base case 2: the unit type ()</span>
<a name="line-323"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybe_tc_app</span>
<a name="line-324"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>unitTyConKey</span>
<a name="line-325"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unitExpr</span><span class='hs-layout'>)</span>
<a name="line-326"></a>
<a name="line-327"></a>  <span class='hs-comment'>-- Base case 3: the boolean type</span>
<a name="line-328"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybe_tc_app</span>
<a name="line-329"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>boolTyConKey</span>
<a name="line-330"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-331"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-332"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>marshal_bool</span> <span class='hs-varid'>e</span>
<a name="line-333"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWildCase</span> <span class='hs-varid'>e</span> <span class='hs-layout'>(</span><span class='hs-varid'>unrestricted</span> <span class='hs-varid'>intPrimTy</span><span class='hs-layout'>)</span> <span class='hs-varid'>boolTy</span>
<a name="line-334"></a>                   <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Alt</span> <span class='hs-conid'>DEFAULT</span>                        <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>trueDataConId</span> <span class='hs-layout'>)</span>
<a name="line-335"></a>                   <span class='hs-layout'>,</span> <span class='hs-conid'>Alt</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitAlt</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLitInt</span> <span class='hs-varid'>platform</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>falseDataConId</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-336"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>intPrimTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>marshal_bool</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-337"></a>
<a name="line-338"></a>  <span class='hs-comment'>-- Newtypes</span>
<a name="line-339"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>topNormaliseNewType_maybe</span> <span class='hs-varid'>result_ty</span>
<a name="line-340"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybe_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrapper</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>resultWrapper</span> <span class='hs-varid'>rep_ty</span>
<a name="line-341"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybe_ty</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkCastDs</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapper</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-342"></a>
<a name="line-343"></a>  <span class='hs-comment'>-- The type might contain foralls (eg. for dummy type arguments,</span>
<a name="line-344"></a>  <span class='hs-comment'>-- referring to 'Ptr a' is legal).</span>
<a name="line-345"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyvar</span><span class='hs-layout'>,</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllTyCoVar_maybe</span> <span class='hs-varid'>result_ty</span>
<a name="line-346"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybe_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrapper</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>resultWrapper</span> <span class='hs-varid'>rest</span>
<a name="line-347"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybe_ty</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Lam</span> <span class='hs-varid'>tyvar</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapper</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-348"></a>
<a name="line-349"></a>  <span class='hs-comment'>-- Data types with a single constructor, which has a single arg</span>
<a name="line-350"></a>  <span class='hs-comment'>-- This includes types like Ptr and ForeignPtr</span>
<a name="line-351"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tycon</span><span class='hs-layout'>,</span> <span class='hs-varid'>tycon_arg_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybe_tc_app</span>
<a name="line-352"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>data_con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConSingleAlgDataCon_maybe</span> <span class='hs-varid'>tycon</span>  <span class='hs-comment'>-- One constructor</span>
<a name="line-353"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConExTyCoVars</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span>                   <span class='hs-comment'>-- no existentials</span>
<a name="line-354"></a>  <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Scaled</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>unwrapped_res_ty</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dataConInstOrigArgTys</span> <span class='hs-varid'>data_con</span> <span class='hs-varid'>tycon_arg_tys</span>  <span class='hs-comment'>-- One argument</span>
<a name="line-355"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybe_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrapper</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>resultWrapper</span> <span class='hs-varid'>unwrapped_res_ty</span>
<a name="line-356"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>marshal_con</span> <span class='hs-varid'>e</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConWrapId</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span>
<a name="line-357"></a>                              <span class='hs-varop'>`mkTyApps`</span> <span class='hs-varid'>tycon_arg_tys</span>
<a name="line-358"></a>                              <span class='hs-varop'>`App`</span> <span class='hs-varid'>wrapper</span> <span class='hs-varid'>e</span>
<a name="line-359"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybe_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>marshal_con</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-360"></a>
<a name="line-361"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-362"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"resultWrapper"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>result_ty</span><span class='hs-layout'>)</span>
<a name="line-363"></a>  <span class='hs-keyword'>where</span>
<a name="line-364"></a>    <span class='hs-varid'>maybe_tc_app</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>result_ty</span>
</pre></body>
</html>
