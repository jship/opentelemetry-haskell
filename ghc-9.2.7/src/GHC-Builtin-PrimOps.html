<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Builtin/PrimOps.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
<a name="line-3"></a>
<a name="line-4"></a>\section[PrimOp]{Primitive operations (machine-level)}
<a name="line-5"></a>-}</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Builtin.PrimOps</span> <span class='hs-layout'>(</span>
<a name="line-10"></a>        <span class='hs-conid'>PrimOp</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>PrimOpVecCat</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>allThePrimOps</span><span class='hs-layout'>,</span>
<a name="line-11"></a>        <span class='hs-varid'>primOpType</span><span class='hs-layout'>,</span> <span class='hs-varid'>primOpSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>primOpResultType</span><span class='hs-layout'>,</span>
<a name="line-12"></a>        <span class='hs-varid'>primOpTag</span><span class='hs-layout'>,</span> <span class='hs-varid'>maxPrimOpTag</span><span class='hs-layout'>,</span> <span class='hs-varid'>primOpOcc</span><span class='hs-layout'>,</span>
<a name="line-13"></a>        <span class='hs-varid'>primOpWrapperId</span><span class='hs-layout'>,</span>
<a name="line-14"></a>
<a name="line-15"></a>        <span class='hs-varid'>tagToEnumKey</span><span class='hs-layout'>,</span>
<a name="line-16"></a>
<a name="line-17"></a>        <span class='hs-varid'>primOpOutOfLine</span><span class='hs-layout'>,</span> <span class='hs-varid'>primOpCodeSize</span><span class='hs-layout'>,</span>
<a name="line-18"></a>        <span class='hs-varid'>primOpOkForSpeculation</span><span class='hs-layout'>,</span> <span class='hs-varid'>primOpOkForSideEffects</span><span class='hs-layout'>,</span>
<a name="line-19"></a>        <span class='hs-varid'>primOpIsCheap</span><span class='hs-layout'>,</span> <span class='hs-varid'>primOpFixity</span><span class='hs-layout'>,</span> <span class='hs-varid'>primOpDocs</span><span class='hs-layout'>,</span>
<a name="line-20"></a>        <span class='hs-varid'>primOpIsDiv</span><span class='hs-layout'>,</span>
<a name="line-21"></a>
<a name="line-22"></a>        <span class='hs-varid'>getPrimOpResultInfo</span><span class='hs-layout'>,</span>  <span class='hs-varid'>isComparisonPrimOp</span><span class='hs-layout'>,</span> <span class='hs-conid'>PrimOpResultInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-23"></a>
<a name="line-24"></a>        <span class='hs-conid'>PrimCall</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-25"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-28"></a>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Types.Prim</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Types</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.Type</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Demand</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Id</span>      <span class='hs-layout'>(</span> <span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkVanillaGlobalWithInfo</span> <span class='hs-layout'>)</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Id.Info</span> <span class='hs-layout'>(</span> <span class='hs-varid'>vanillaIdInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>setCafInfo</span><span class='hs-layout'>,</span> <span class='hs-conid'>CafInfo</span><span class='hs-layout'>(</span><span class='hs-conid'>NoCafRefs</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Names</span> <span class='hs-layout'>(</span> <span class='hs-varid'>gHC_PRIMOPWRAPPERS</span> <span class='hs-layout'>)</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCon</span>    <span class='hs-layout'>(</span> <span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>isPrimTyCon</span><span class='hs-layout'>,</span> <span class='hs-conid'>PrimRep</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Type</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.RepType</span> <span class='hs-layout'>(</span> <span class='hs-varid'>tyConPrimRep1</span> <span class='hs-layout'>)</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Basic</span>   <span class='hs-layout'>(</span> <span class='hs-conid'>Arity</span><span class='hs-layout'>,</span> <span class='hs-conid'>Boxity</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Fixity</span>  <span class='hs-layout'>(</span> <span class='hs-conid'>Fixity</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FixityDirection</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SrcLoc</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>wiredInSrcSpan</span> <span class='hs-layout'>)</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.ForeignCall</span> <span class='hs-layout'>(</span> <span class='hs-conid'>CLabelString</span> <span class='hs-layout'>)</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SourceText</span>  <span class='hs-layout'>(</span> <span class='hs-conid'>SourceText</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique</span>  <span class='hs-layout'>(</span> <span class='hs-conid'>Unique</span><span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Uniques</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPrimOpIdUnique</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkPrimOpWrapperUnique</span> <span class='hs-layout'>)</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Types</span>    <span class='hs-layout'>(</span> <span class='hs-conid'>Unit</span> <span class='hs-layout'>)</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.FastString</span>
<a name="line-53"></a>
<a name="line-54"></a><span class='hs-comment'>{-
<a name="line-55"></a>************************************************************************
<a name="line-56"></a>*                                                                      *
<a name="line-57"></a>\subsection[PrimOp-datatype]{Datatype for @PrimOp@ (an enumeration)}
<a name="line-58"></a>*                                                                      *
<a name="line-59"></a>************************************************************************
<a name="line-60"></a>
<a name="line-61"></a>These are in \tr{state-interface.verb} order.
<a name="line-62"></a>-}</span>
<a name="line-63"></a>
<a name="line-64"></a><span class='hs-comment'>-- supplies:</span>
<a name="line-65"></a><span class='hs-comment'>-- data PrimOp = ...</span>
<a name="line-66"></a><span class='hs-cpp'>#include "primop-data-decl.hs-incl"</span>
<a name="line-67"></a>
<a name="line-68"></a><span class='hs-comment'>-- supplies</span>
<a name="line-69"></a><span class='hs-comment'>-- primOpTag :: PrimOp -&gt; Int</span>
<a name="line-70"></a><span class='hs-cpp'>#include "primop-tag.hs-incl"</span>
<a name="line-71"></a><a name="primOpTag"></a><span class='hs-definition'>primOpTag</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"primOpTag: unknown primop"</span>
<a name="line-72"></a>
<a name="line-73"></a>
<a name="line-74"></a><a name="instance%20Eq%20PrimOp"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyword'>where</span>
<a name="line-75"></a>    <span class='hs-varid'>op1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>op2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>primOpTag</span> <span class='hs-varid'>op1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>primOpTag</span> <span class='hs-varid'>op2</span>
<a name="line-76"></a>
<a name="line-77"></a><a name="instance%20Ord%20PrimOp"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Ord</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyword'>where</span>
<a name="line-78"></a>    <span class='hs-varid'>op1</span> <span class='hs-varop'>&lt;</span>  <span class='hs-varid'>op2</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>primOpTag</span> <span class='hs-varid'>op1</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>primOpTag</span> <span class='hs-varid'>op2</span>
<a name="line-79"></a>    <span class='hs-varid'>op1</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>op2</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>primOpTag</span> <span class='hs-varid'>op1</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>primOpTag</span> <span class='hs-varid'>op2</span>
<a name="line-80"></a>    <span class='hs-varid'>op1</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>op2</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>primOpTag</span> <span class='hs-varid'>op1</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>primOpTag</span> <span class='hs-varid'>op2</span>
<a name="line-81"></a>    <span class='hs-varid'>op1</span> <span class='hs-varop'>&gt;</span>  <span class='hs-varid'>op2</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>primOpTag</span> <span class='hs-varid'>op1</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>primOpTag</span> <span class='hs-varid'>op2</span>
<a name="line-82"></a>    <span class='hs-varid'>op1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>op2</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>op1</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>op2</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LT</span>
<a name="line-83"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>op1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>op2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EQ</span>
<a name="line-84"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-85"></a>
<a name="line-86"></a><a name="instance%20Outputable%20PrimOp"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyword'>where</span>
<a name="line-87"></a>    <span class='hs-varid'>ppr</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrimOp</span> <span class='hs-varid'>op</span>
<a name="line-88"></a>
<a name="line-89"></a><a name="PrimOpVecCat"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PrimOpVecCat</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IntVec</span>
<a name="line-90"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WordVec</span>
<a name="line-91"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FloatVec</span>
<a name="line-92"></a>
<a name="line-93"></a><span class='hs-comment'>-- An @Enum@-derived list would be better; meanwhile... (ToDo)</span>
<a name="line-94"></a>
<a name="line-95"></a><a name="allThePrimOps"></a><span class='hs-definition'>allThePrimOps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PrimOp</span><span class='hs-keyglyph'>]</span>
<a name="line-96"></a><span class='hs-definition'>allThePrimOps</span> <span class='hs-keyglyph'>=</span>
<a name="line-97"></a><span class='hs-cpp'>#include "primop-list.hs-incl"</span>
<a name="line-98"></a>
<a name="line-99"></a><a name="tagToEnumKey"></a><span class='hs-definition'>tagToEnumKey</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span>
<a name="line-100"></a><span class='hs-definition'>tagToEnumKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPrimOpIdUnique</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpTag</span> <span class='hs-conid'>TagToEnumOp</span><span class='hs-layout'>)</span>
<a name="line-101"></a>
<a name="line-102"></a><span class='hs-comment'>{-
<a name="line-103"></a>************************************************************************
<a name="line-104"></a>*                                                                      *
<a name="line-105"></a>\subsection[PrimOp-info]{The essential info about each @PrimOp@}
<a name="line-106"></a>*                                                                      *
<a name="line-107"></a>************************************************************************
<a name="line-108"></a>-}</span>
<a name="line-109"></a>
<a name="line-110"></a><a name="PrimOpInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PrimOpInfo</span>
<a name="line-111"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Compare</span>     <span class='hs-conid'>OccName</span>         <span class='hs-comment'>-- string :: T -&gt; T -&gt; Int#</span>
<a name="line-112"></a>                <span class='hs-conid'>Type</span>
<a name="line-113"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>GenPrimOp</span>   <span class='hs-conid'>OccName</span>         <span class='hs-comment'>-- string :: \/a1..an . T1 -&gt; .. -&gt; Tk -&gt; T</span>
<a name="line-114"></a>                <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-115"></a>                <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-116"></a>                <span class='hs-conid'>Type</span>
<a name="line-117"></a>
<a name="line-118"></a><a name="mkCompare"></a><span class='hs-definition'>mkCompare</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PrimOpInfo</span>
<a name="line-119"></a><span class='hs-definition'>mkCompare</span> <span class='hs-varid'>str</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Compare</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOccFS</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-120"></a>
<a name="line-121"></a><a name="mkGenPrimOp"></a><span class='hs-definition'>mkGenPrimOp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PrimOpInfo</span>
<a name="line-122"></a><span class='hs-definition'>mkGenPrimOp</span> <span class='hs-varid'>str</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GenPrimOp</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOccFS</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ty</span>
<a name="line-123"></a>
<a name="line-124"></a><span class='hs-comment'>{-
<a name="line-125"></a>************************************************************************
<a name="line-126"></a>*                                                                      *
<a name="line-127"></a>\subsubsection{Strictness}
<a name="line-128"></a>*                                                                      *
<a name="line-129"></a>************************************************************************
<a name="line-130"></a>
<a name="line-131"></a>Not all primops are strict!
<a name="line-132"></a>-}</span>
<a name="line-133"></a>
<a name="line-134"></a><a name="primOpStrictness"></a><span class='hs-definition'>primOpStrictness</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span>
<a name="line-135"></a>        <span class='hs-comment'>-- See Demand.StrictnessInfo for discussion of what the results</span>
<a name="line-136"></a>        <span class='hs-comment'>-- The arity should be the arity of the primop; that's why</span>
<a name="line-137"></a>        <span class='hs-comment'>-- this function isn't exported.</span>
<a name="line-138"></a><span class='hs-cpp'>#include "primop-strictness.hs-incl"</span>
<a name="line-139"></a>
<a name="line-140"></a><span class='hs-comment'>{-
<a name="line-141"></a>************************************************************************
<a name="line-142"></a>*                                                                      *
<a name="line-143"></a>\subsubsection{Fixity}
<a name="line-144"></a>*                                                                      *
<a name="line-145"></a>************************************************************************
<a name="line-146"></a>-}</span>
<a name="line-147"></a>
<a name="line-148"></a><a name="primOpFixity"></a><span class='hs-definition'>primOpFixity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Fixity</span>
<a name="line-149"></a><span class='hs-cpp'>#include "primop-fixity.hs-incl"</span>
<a name="line-150"></a>
<a name="line-151"></a><span class='hs-comment'>{-
<a name="line-152"></a>************************************************************************
<a name="line-153"></a>*                                                                      *
<a name="line-154"></a>\subsubsection{Docs}
<a name="line-155"></a>*                                                                      *
<a name="line-156"></a>************************************************************************
<a name="line-157"></a>
<a name="line-158"></a>See Note [GHC.Prim Docs]
<a name="line-159"></a>-}</span>
<a name="line-160"></a>
<a name="line-161"></a><a name="primOpDocs"></a><span class='hs-definition'>primOpDocs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-162"></a><span class='hs-cpp'>#include "primop-docs.hs-incl"</span>
<a name="line-163"></a>
<a name="line-164"></a><span class='hs-comment'>{-
<a name="line-165"></a>************************************************************************
<a name="line-166"></a>*                                                                      *
<a name="line-167"></a>\subsubsection[PrimOp-comparison]{PrimOpInfo basic comparison ops}
<a name="line-168"></a>*                                                                      *
<a name="line-169"></a>************************************************************************
<a name="line-170"></a>
<a name="line-171"></a>@primOpInfo@ gives all essential information (from which everything
<a name="line-172"></a>else, notably a type, can be constructed) for each @PrimOp@.
<a name="line-173"></a>-}</span>
<a name="line-174"></a>
<a name="line-175"></a><a name="primOpInfo"></a><span class='hs-definition'>primOpInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PrimOpInfo</span>
<a name="line-176"></a><span class='hs-cpp'>#include "primop-primop-info.hs-incl"</span>
<a name="line-177"></a><span class='hs-definition'>primOpInfo</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"primOpInfo: unknown primop"</span>
<a name="line-178"></a>
<a name="line-179"></a><span class='hs-comment'>{-
<a name="line-180"></a>Here are a load of comments from the old primOp info:
<a name="line-181"></a>
<a name="line-182"></a>A @Word#@ is an unsigned @Int#@.
<a name="line-183"></a>
<a name="line-184"></a>@decodeFloat#@ is given w/ Integer-stuff (it's similar).
<a name="line-185"></a>
<a name="line-186"></a>@decodeDouble#@ is given w/ Integer-stuff (it's similar).
<a name="line-187"></a>
<a name="line-188"></a>Decoding of floating-point numbers is sorta Integer-related.  Encoding
<a name="line-189"></a>is done with plain ccalls now (see PrelNumExtra.hs).
<a name="line-190"></a>
<a name="line-191"></a>A @Weak@ Pointer is created by the @mkWeak#@ primitive:
<a name="line-192"></a>
<a name="line-193"></a>        mkWeak# :: k -&gt; v -&gt; f -&gt; State# RealWorld
<a name="line-194"></a>                        -&gt; (# State# RealWorld, Weak# v #)
<a name="line-195"></a>
<a name="line-196"></a>In practice, you'll use the higher-level
<a name="line-197"></a>
<a name="line-198"></a>        data Weak v = Weak# v
<a name="line-199"></a>        mkWeak :: k -&gt; v -&gt; IO () -&gt; IO (Weak v)
<a name="line-200"></a>
<a name="line-201"></a>The following operation dereferences a weak pointer.  The weak pointer
<a name="line-202"></a>may have been finalized, so the operation returns a result code which
<a name="line-203"></a>must be inspected before looking at the dereferenced value.
<a name="line-204"></a>
<a name="line-205"></a>        deRefWeak# :: Weak# v -&gt; State# RealWorld -&gt;
<a name="line-206"></a>                        (# State# RealWorld, v, Int# #)
<a name="line-207"></a>
<a name="line-208"></a>Only look at v if the Int# returned is /= 0 !!
<a name="line-209"></a>
<a name="line-210"></a>The higher-level op is
<a name="line-211"></a>
<a name="line-212"></a>        deRefWeak :: Weak v -&gt; IO (Maybe v)
<a name="line-213"></a>
<a name="line-214"></a>Weak pointers can be finalized early by using the finalize# operation:
<a name="line-215"></a>
<a name="line-216"></a>        finalizeWeak# :: Weak# v -&gt; State# RealWorld -&gt;
<a name="line-217"></a>                           (# State# RealWorld, Int#, IO () #)
<a name="line-218"></a>
<a name="line-219"></a>The Int# returned is either
<a name="line-220"></a>
<a name="line-221"></a>        0 if the weak pointer has already been finalized, or it has no
<a name="line-222"></a>          finalizer (the third component is then invalid).
<a name="line-223"></a>
<a name="line-224"></a>        1 if the weak pointer is still alive, with the finalizer returned
<a name="line-225"></a>          as the third component.
<a name="line-226"></a>
<a name="line-227"></a>A {\em stable name/pointer} is an index into a table of stable name
<a name="line-228"></a>entries.  Since the garbage collector is told about stable pointers,
<a name="line-229"></a>it is safe to pass a stable pointer to external systems such as C
<a name="line-230"></a>routines.
<a name="line-231"></a>
<a name="line-232"></a>\begin{verbatim}
<a name="line-233"></a>makeStablePtr#  :: a -&gt; State# RealWorld -&gt; (# State# RealWorld, StablePtr# a #)
<a name="line-234"></a>freeStablePtr   :: StablePtr# a -&gt; State# RealWorld -&gt; State# RealWorld
<a name="line-235"></a>deRefStablePtr# :: StablePtr# a -&gt; State# RealWorld -&gt; (# State# RealWorld, a #)
<a name="line-236"></a>eqStablePtr#    :: StablePtr# a -&gt; StablePtr# a -&gt; Int#
<a name="line-237"></a>\end{verbatim}
<a name="line-238"></a>
<a name="line-239"></a>It may seem a bit surprising that @makeStablePtr#@ is a @IO@
<a name="line-240"></a>operation since it doesn't (directly) involve IO operations.  The
<a name="line-241"></a>reason is that if some optimisation pass decided to duplicate calls to
<a name="line-242"></a>@makeStablePtr#@ and we only pass one of the stable pointers over, a
<a name="line-243"></a>massive space leak can result.  Putting it into the IO monad
<a name="line-244"></a>prevents this.  (Another reason for putting them in a monad is to
<a name="line-245"></a>ensure correct sequencing wrt the side-effecting @freeStablePtr@
<a name="line-246"></a>operation.)
<a name="line-247"></a>
<a name="line-248"></a>An important property of stable pointers is that if you call
<a name="line-249"></a>makeStablePtr# twice on the same object you get the same stable
<a name="line-250"></a>pointer back.
<a name="line-251"></a>
<a name="line-252"></a>Note that we can implement @freeStablePtr#@ using @_ccall_@ (and,
<a name="line-253"></a>besides, it's not likely to be used from Haskell) so it's not a
<a name="line-254"></a>primop.
<a name="line-255"></a>
<a name="line-256"></a>Question: Why @RealWorld@ - won't any instance of @_ST@ do the job? [ADR]
<a name="line-257"></a>
<a name="line-258"></a>Stable Names
<a name="line-259"></a>~~~~~~~~~~~~
<a name="line-260"></a>
<a name="line-261"></a>A stable name is like a stable pointer, but with three important differences:
<a name="line-262"></a>
<a name="line-263"></a>        (a) You can't deRef one to get back to the original object.
<a name="line-264"></a>        (b) You can convert one to an Int.
<a name="line-265"></a>        (c) You don't need to 'freeStableName'
<a name="line-266"></a>
<a name="line-267"></a>The existence of a stable name doesn't guarantee to keep the object it
<a name="line-268"></a>points to alive (unlike a stable pointer), hence (a).
<a name="line-269"></a>
<a name="line-270"></a>Invariants:
<a name="line-271"></a>
<a name="line-272"></a>        (a) makeStableName always returns the same value for a given
<a name="line-273"></a>            object (same as stable pointers).
<a name="line-274"></a>
<a name="line-275"></a>        (b) if two stable names are equal, it implies that the objects
<a name="line-276"></a>            from which they were created were the same.
<a name="line-277"></a>
<a name="line-278"></a>        (c) stableNameToInt always returns the same Int for a given
<a name="line-279"></a>            stable name.
<a name="line-280"></a>
<a name="line-281"></a>
<a name="line-282"></a>These primops are pretty weird.
<a name="line-283"></a>
<a name="line-284"></a>        tagToEnum# :: Int -&gt; a    (result type must be an enumerated type)
<a name="line-285"></a>
<a name="line-286"></a>The constraints aren't currently checked by the front end, but the
<a name="line-287"></a>code generator will fall over if they aren't satisfied.
<a name="line-288"></a>
<a name="line-289"></a>************************************************************************
<a name="line-290"></a>*                                                                      *
<a name="line-291"></a>            Which PrimOps are out-of-line
<a name="line-292"></a>*                                                                      *
<a name="line-293"></a>************************************************************************
<a name="line-294"></a>
<a name="line-295"></a>Some PrimOps need to be called out-of-line because they either need to
<a name="line-296"></a>perform a heap check or they block.
<a name="line-297"></a>-}</span>
<a name="line-298"></a>
<a name="line-299"></a><a name="primOpOutOfLine"></a><span class='hs-definition'>primOpOutOfLine</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-300"></a><span class='hs-cpp'>#include "primop-out-of-line.hs-incl"</span>
<a name="line-301"></a>
<a name="line-302"></a><span class='hs-comment'>{-
<a name="line-303"></a>************************************************************************
<a name="line-304"></a>*                                                                      *
<a name="line-305"></a>            Failure and side effects
<a name="line-306"></a>*                                                                      *
<a name="line-307"></a>************************************************************************
<a name="line-308"></a>
<a name="line-309"></a>Note [Checking versus non-checking primops]
<a name="line-310"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-311"></a>
<a name="line-312"></a>  In GHC primops break down into two classes:
<a name="line-313"></a>
<a name="line-314"></a>   a. Checking primops behave, for instance, like division. In this
<a name="line-315"></a>      case the primop may throw an exception (e.g. division-by-zero)
<a name="line-316"></a>      and is consequently is marked with the can_fail flag described below.
<a name="line-317"></a>      The ability to fail comes at the expense of precluding some optimizations.
<a name="line-318"></a>
<a name="line-319"></a>   b. Non-checking primops behavior, for instance, like addition. While
<a name="line-320"></a>      addition can overflow it does not produce an exception. So can_fail is
<a name="line-321"></a>      set to False, and we get more optimisation opportunities.  But we must
<a name="line-322"></a>      never throw an exception, so we cannot rewrite to a call to error.
<a name="line-323"></a>
<a name="line-324"></a>  It is important that a non-checking primop never be transformed in a way that
<a name="line-325"></a>  would cause it to bottom. Doing so would violate Core's let/app invariant
<a name="line-326"></a>  (see Note [Core let/app invariant] in GHC.Core) which is critical to
<a name="line-327"></a>  the simplifier's ability to float without fear of changing program meaning.
<a name="line-328"></a>
<a name="line-329"></a>
<a name="line-330"></a>Note [PrimOp can_fail and has_side_effects]
<a name="line-331"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-332"></a>Both can_fail and has_side_effects mean that the primop has
<a name="line-333"></a>some effect that is not captured entirely by its result value.
<a name="line-334"></a>
<a name="line-335"></a>----------  has_side_effects ---------------------
<a name="line-336"></a>A primop "has_side_effects" if it has some *write* effect, visible
<a name="line-337"></a>elsewhere
<a name="line-338"></a>    - writing to the world (I/O)
<a name="line-339"></a>    - writing to a mutable data structure (writeIORef)
<a name="line-340"></a>    - throwing a synchronous Haskell exception
<a name="line-341"></a>
<a name="line-342"></a>Often such primops have a type like
<a name="line-343"></a>   State -&gt; input -&gt; (State, output)
<a name="line-344"></a>so the state token guarantees ordering.  In general we rely *only* on
<a name="line-345"></a>data dependencies of the state token to enforce write-effect ordering
<a name="line-346"></a>
<a name="line-347"></a> * NB1: if you inline unsafePerformIO, you may end up with
<a name="line-348"></a>   side-effecting ops whose 'state' output is discarded.
<a name="line-349"></a>   And programmers may do that by hand; see #9390.
<a name="line-350"></a>   That is why we (conservatively) do not discard write-effecting
<a name="line-351"></a>   primops even if both their state and result is discarded.
<a name="line-352"></a>
<a name="line-353"></a> * NB2: We consider primops, such as raiseIO#, that can raise a
<a name="line-354"></a>   (Haskell) synchronous exception to "have_side_effects" but not
<a name="line-355"></a>   "can_fail".  We must be careful about not discarding such things;
<a name="line-356"></a>   see the paper "A semantics for imprecise exceptions".
<a name="line-357"></a>
<a name="line-358"></a> * NB3: *Read* effects (like reading an IORef) don't count here,
<a name="line-359"></a>   because it doesn't matter if we don't do them, or do them more than
<a name="line-360"></a>   once.  *Sequencing* is maintained by the data dependency of the state
<a name="line-361"></a>   token.
<a name="line-362"></a>
<a name="line-363"></a>----------  can_fail ----------------------------
<a name="line-364"></a>A primop "can_fail" if it can fail with an *unchecked* exception on
<a name="line-365"></a>some elements of its input domain. Main examples:
<a name="line-366"></a>   division (fails on zero denominator)
<a name="line-367"></a>   array indexing (fails if the index is out of bounds)
<a name="line-368"></a>
<a name="line-369"></a>An "unchecked exception" is one that is an outright error, (not
<a name="line-370"></a>turned into a Haskell exception,) such as seg-fault or
<a name="line-371"></a>divide-by-zero error.  Such can_fail primops are ALWAYS surrounded
<a name="line-372"></a>with a test that checks for the bad cases, but we need to be
<a name="line-373"></a>very careful about code motion that might move it out of
<a name="line-374"></a>the scope of the test.
<a name="line-375"></a>
<a name="line-376"></a>Note [Transformations affected by can_fail and has_side_effects]
<a name="line-377"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-378"></a>The can_fail and has_side_effects properties have the following effect
<a name="line-379"></a>on program transformations.  Summary table is followed by details.
<a name="line-380"></a>
<a name="line-381"></a>            can_fail     has_side_effects
<a name="line-382"></a>Discard        YES           NO
<a name="line-383"></a>Float in       YES           YES
<a name="line-384"></a>Float out      NO            NO
<a name="line-385"></a>Duplicate      YES           NO
<a name="line-386"></a>
<a name="line-387"></a>* Discarding.   case (a `op` b) of _ -&gt; rhs  ===&gt;   rhs
<a name="line-388"></a>  You should not discard a has_side_effects primop; e.g.
<a name="line-389"></a>     case (writeIntArray# a i v s of (# _, _ #) -&gt; True
<a name="line-390"></a>  Arguably you should be able to discard this, since the
<a name="line-391"></a>  returned stat token is not used, but that relies on NEVER
<a name="line-392"></a>  inlining unsafePerformIO, and programmers sometimes write
<a name="line-393"></a>  this kind of stuff by hand (#9390).  So we (conservatively)
<a name="line-394"></a>  never discard a has_side_effects primop.
<a name="line-395"></a>
<a name="line-396"></a>  However, it's fine to discard a can_fail primop.  For example
<a name="line-397"></a>     case (indexIntArray# a i) of _ -&gt; True
<a name="line-398"></a>  We can discard indexIntArray#; it has can_fail, but not
<a name="line-399"></a>  has_side_effects; see #5658 which was all about this.
<a name="line-400"></a>  Notice that indexIntArray# is (in a more general handling of
<a name="line-401"></a>  effects) read effect, but we don't care about that here, and
<a name="line-402"></a>  treat read effects as *not* has_side_effects.
<a name="line-403"></a>
<a name="line-404"></a>  Similarly (a `/#` b) can be discarded.  It can seg-fault or
<a name="line-405"></a>  cause a hardware exception, but not a synchronous Haskell
<a name="line-406"></a>  exception.
<a name="line-407"></a>
<a name="line-408"></a>
<a name="line-409"></a>
<a name="line-410"></a>  Synchronous Haskell exceptions, e.g. from raiseIO#, are treated
<a name="line-411"></a>  as has_side_effects and hence are not discarded.
<a name="line-412"></a>
<a name="line-413"></a>* Float in.  You can float a can_fail or has_side_effects primop
<a name="line-414"></a>  *inwards*, but not inside a lambda (see Duplication below).
<a name="line-415"></a>
<a name="line-416"></a>* Float out.  You must not float a can_fail primop *outwards* lest
<a name="line-417"></a>  you escape the dynamic scope of the test.  Example:
<a name="line-418"></a>      case d &gt;# 0# of
<a name="line-419"></a>        True  -&gt; case x /# d of r -&gt; r +# 1
<a name="line-420"></a>        False -&gt; 0
<a name="line-421"></a>  Here we must not float the case outwards to give
<a name="line-422"></a>      case x/# d of r -&gt;
<a name="line-423"></a>      case d &gt;# 0# of
<a name="line-424"></a>        True  -&gt; r +# 1
<a name="line-425"></a>        False -&gt; 0
<a name="line-426"></a>
<a name="line-427"></a>  Nor can you float out a has_side_effects primop.  For example:
<a name="line-428"></a>       if blah then case writeMutVar# v True s0 of (# s1 #) -&gt; s1
<a name="line-429"></a>               else s0
<a name="line-430"></a>  Notice that s0 is mentioned in both branches of the 'if', but
<a name="line-431"></a>  only one of these two will actually be consumed.  But if we
<a name="line-432"></a>  float out to
<a name="line-433"></a>      case writeMutVar# v True s0 of (# s1 #) -&gt;
<a name="line-434"></a>      if blah then s1 else s0
<a name="line-435"></a>  the writeMutVar will be performed in both branches, which is
<a name="line-436"></a>  utterly wrong.
<a name="line-437"></a>
<a name="line-438"></a>* Duplication.  You cannot duplicate a has_side_effect primop.  You
<a name="line-439"></a>  might wonder how this can occur given the state token threading, but
<a name="line-440"></a>  just look at Control.Monad.ST.Lazy.Imp.strictToLazy!  We get
<a name="line-441"></a>  something like this
<a name="line-442"></a>        p = case readMutVar# s v of
<a name="line-443"></a>              (# s', r #) -&gt; (State# s', r)
<a name="line-444"></a>        s' = case p of (s', r) -&gt; s'
<a name="line-445"></a>        r  = case p of (s', r) -&gt; r
<a name="line-446"></a>
<a name="line-447"></a>  (All these bindings are boxed.)  If we inline p at its two call
<a name="line-448"></a>  sites, we get a catastrophe: because the read is performed once when
<a name="line-449"></a>  s' is demanded, and once when 'r' is demanded, which may be much
<a name="line-450"></a>  later.  Utterly wrong.  #3207 is real example of this happening.
<a name="line-451"></a>
<a name="line-452"></a>  However, it's fine to duplicate a can_fail primop.  That is really
<a name="line-453"></a>  the only difference between can_fail and has_side_effects.
<a name="line-454"></a>
<a name="line-455"></a>Note [Implementation: how can_fail/has_side_effects affect transformations]
<a name="line-456"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-457"></a>How do we ensure that floating/duplication/discarding are done right
<a name="line-458"></a>in the simplifier?
<a name="line-459"></a>
<a name="line-460"></a>Two main predicates on primpops test these flags:
<a name="line-461"></a>  primOpOkForSideEffects &lt;=&gt; not has_side_effects
<a name="line-462"></a>  primOpOkForSpeculation &lt;=&gt; not (has_side_effects || can_fail)
<a name="line-463"></a>
<a name="line-464"></a>  * The "no-float-out" thing is achieved by ensuring that we never
<a name="line-465"></a>    let-bind a can_fail or has_side_effects primop.  The RHS of a
<a name="line-466"></a>    let-binding (which can float in and out freely) satisfies
<a name="line-467"></a>    exprOkForSpeculation; this is the let/app invariant.  And
<a name="line-468"></a>    exprOkForSpeculation is false of can_fail and has_side_effects.
<a name="line-469"></a>
<a name="line-470"></a>  * So can_fail and has_side_effects primops will appear only as the
<a name="line-471"></a>    scrutinees of cases, and that's why the FloatIn pass is capable
<a name="line-472"></a>    of floating case bindings inwards.
<a name="line-473"></a>
<a name="line-474"></a>  * The no-duplicate thing is done via primOpIsCheap, by making
<a name="line-475"></a>    has_side_effects things (very very very) not-cheap!
<a name="line-476"></a>-}</span>
<a name="line-477"></a>
<a name="line-478"></a><a name="primOpHasSideEffects"></a><span class='hs-definition'>primOpHasSideEffects</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-479"></a><span class='hs-cpp'>#include "primop-has-side-effects.hs-incl"</span>
<a name="line-480"></a>
<a name="line-481"></a><a name="primOpCanFail"></a><span class='hs-definition'>primOpCanFail</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-482"></a><span class='hs-cpp'>#include "primop-can-fail.hs-incl"</span>
<a name="line-483"></a>
<a name="line-484"></a><a name="primOpOkForSpeculation"></a><span class='hs-definition'>primOpOkForSpeculation</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-485"></a>  <span class='hs-comment'>-- See Note [PrimOp can_fail and has_side_effects]</span>
<a name="line-486"></a>  <span class='hs-comment'>-- See comments with GHC.Core.Utils.exprOkForSpeculation</span>
<a name="line-487"></a>  <span class='hs-comment'>-- primOpOkForSpeculation =&gt; primOpOkForSideEffects</span>
<a name="line-488"></a><span class='hs-definition'>primOpOkForSpeculation</span> <span class='hs-varid'>op</span>
<a name="line-489"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>primOpOkForSideEffects</span> <span class='hs-varid'>op</span>
<a name="line-490"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpOutOfLine</span> <span class='hs-varid'>op</span> <span class='hs-varop'>||</span> <span class='hs-varid'>primOpCanFail</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-491"></a>    <span class='hs-comment'>-- I think the "out of line" test is because out of line things can</span>
<a name="line-492"></a>    <span class='hs-comment'>-- be expensive (eg sine, cosine), and so we may not want to speculate them</span>
<a name="line-493"></a>
<a name="line-494"></a><a name="primOpOkForSideEffects"></a><span class='hs-definition'>primOpOkForSideEffects</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-495"></a><span class='hs-definition'>primOpOkForSideEffects</span> <span class='hs-varid'>op</span>
<a name="line-496"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpHasSideEffects</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-497"></a>
<a name="line-498"></a><span class='hs-comment'>{-
<a name="line-499"></a>Note [primOpIsCheap]
<a name="line-500"></a>~~~~~~~~~~~~~~~~~~~~
<a name="line-501"></a>
<a name="line-502"></a>@primOpIsCheap@, as used in GHC.Core.Opt.Simplify.Utils.  For now (HACK
<a name="line-503"></a>WARNING), we just borrow some other predicates for a
<a name="line-504"></a>what-should-be-good-enough test.  "Cheap" means willing to call it more
<a name="line-505"></a>than once, and/or push it inside a lambda.  The latter could change the
<a name="line-506"></a>behaviour of 'seq' for primops that can fail, so we don't treat them as cheap.
<a name="line-507"></a>-}</span>
<a name="line-508"></a>
<a name="line-509"></a><a name="primOpIsCheap"></a><span class='hs-definition'>primOpIsCheap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-510"></a><span class='hs-comment'>-- See Note [PrimOp can_fail and has_side_effects]</span>
<a name="line-511"></a><span class='hs-definition'>primOpIsCheap</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>primOpOkForSpeculation</span> <span class='hs-varid'>op</span>
<a name="line-512"></a><span class='hs-comment'>-- In March 2001, we changed this to</span>
<a name="line-513"></a><span class='hs-comment'>--      primOpIsCheap op = False</span>
<a name="line-514"></a><span class='hs-comment'>-- thereby making *no* primops seem cheap.  But this killed eta</span>
<a name="line-515"></a><span class='hs-comment'>-- expansion on case (x ==# y) of True -&gt; \s -&gt; ...</span>
<a name="line-516"></a><span class='hs-comment'>-- which is bad.  In particular a loop like</span>
<a name="line-517"></a><span class='hs-comment'>--      doLoop n = loop 0</span>
<a name="line-518"></a><span class='hs-comment'>--     where</span>
<a name="line-519"></a><span class='hs-comment'>--         loop i | i == n    = return ()</span>
<a name="line-520"></a><span class='hs-comment'>--                | otherwise = bar i &gt;&gt; loop (i+1)</span>
<a name="line-521"></a><span class='hs-comment'>-- allocated a closure every time round because it doesn't eta expand.</span>
<a name="line-522"></a><span class='hs-comment'>--</span>
<a name="line-523"></a><span class='hs-comment'>-- The problem that originally gave rise to the change was</span>
<a name="line-524"></a><span class='hs-comment'>--      let x = a +# b *# c in x +# x</span>
<a name="line-525"></a><span class='hs-comment'>-- were we don't want to inline x. But primopIsCheap doesn't control</span>
<a name="line-526"></a><span class='hs-comment'>-- that (it's exprIsDupable that does) so the problem doesn't occur</span>
<a name="line-527"></a><span class='hs-comment'>-- even if primOpIsCheap sometimes says 'True'.</span>
<a name="line-528"></a>
<a name="line-529"></a>
<a name="line-530"></a><a name="primOpIsDiv"></a><span class='hs-comment'>-- | True of dyadic operators that can fail only if the second arg is zero!</span>
<a name="line-531"></a><span class='hs-comment'>--</span>
<a name="line-532"></a><span class='hs-comment'>-- This function probably belongs in an automagically generated file.. but it's</span>
<a name="line-533"></a><span class='hs-comment'>-- such a special case I thought I'd leave it here for now.</span>
<a name="line-534"></a><span class='hs-definition'>primOpIsDiv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-535"></a><span class='hs-definition'>primOpIsDiv</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>op</span> <span class='hs-keyword'>of</span>
<a name="line-536"></a>
<a name="line-537"></a>  <span class='hs-comment'>-- TODO: quotRemWord2, Int64, Word64</span>
<a name="line-538"></a>  <span class='hs-conid'>IntQuotOp</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-539"></a>  <span class='hs-conid'>Int8QuotOp</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-540"></a>  <span class='hs-conid'>Int16QuotOp</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-541"></a>  <span class='hs-conid'>Int32QuotOp</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-542"></a>
<a name="line-543"></a>  <span class='hs-conid'>IntRemOp</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-544"></a>  <span class='hs-conid'>Int8RemOp</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-545"></a>  <span class='hs-conid'>Int16RemOp</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-546"></a>  <span class='hs-conid'>Int32RemOp</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-547"></a>
<a name="line-548"></a>  <span class='hs-conid'>IntQuotRemOp</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-549"></a>  <span class='hs-conid'>Int8QuotRemOp</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-550"></a>  <span class='hs-conid'>Int16QuotRemOp</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-551"></a>  <span class='hs-conid'>Int32QuotRemOp</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-552"></a>
<a name="line-553"></a>  <span class='hs-conid'>WordQuotOp</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-554"></a>  <span class='hs-conid'>Word8QuotOp</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-555"></a>  <span class='hs-conid'>Word16QuotOp</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-556"></a>  <span class='hs-conid'>Word32QuotOp</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-557"></a>
<a name="line-558"></a>  <span class='hs-conid'>WordRemOp</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-559"></a>  <span class='hs-conid'>Word8RemOp</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-560"></a>  <span class='hs-conid'>Word16RemOp</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-561"></a>  <span class='hs-conid'>Word32RemOp</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-562"></a>
<a name="line-563"></a>  <span class='hs-conid'>WordQuotRemOp</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-564"></a>  <span class='hs-conid'>Word8QuotRemOp</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-565"></a>  <span class='hs-conid'>Word16QuotRemOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-566"></a>  <span class='hs-conid'>Word32QuotRemOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-567"></a>
<a name="line-568"></a>  <span class='hs-conid'>FloatDivOp</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-569"></a>  <span class='hs-conid'>DoubleDivOp</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-570"></a>  <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-571"></a>
<a name="line-572"></a>
<a name="line-573"></a>
<a name="line-574"></a><span class='hs-comment'>{-
<a name="line-575"></a>************************************************************************
<a name="line-576"></a>*                                                                      *
<a name="line-577"></a>               PrimOp code size
<a name="line-578"></a>*                                                                      *
<a name="line-579"></a>************************************************************************
<a name="line-580"></a>
<a name="line-581"></a>primOpCodeSize
<a name="line-582"></a>~~~~~~~~~~~~~~
<a name="line-583"></a>Gives an indication of the code size of a primop, for the purposes of
<a name="line-584"></a>calculating unfolding sizes; see GHC.Core.Unfold.sizeExpr.
<a name="line-585"></a>-}</span>
<a name="line-586"></a>
<a name="line-587"></a><a name="primOpCodeSize"></a><span class='hs-definition'>primOpCodeSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-588"></a><span class='hs-cpp'>#include "primop-code-size.hs-incl"</span>
<a name="line-589"></a>
<a name="line-590"></a><a name="primOpCodeSizeDefault"></a><span class='hs-definition'>primOpCodeSizeDefault</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-591"></a><span class='hs-definition'>primOpCodeSizeDefault</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-592"></a>  <span class='hs-comment'>-- GHC.Core.Unfold.primOpSize already takes into account primOpOutOfLine</span>
<a name="line-593"></a>  <span class='hs-comment'>-- and adds some further costs for the args in that case.</span>
<a name="line-594"></a>
<a name="line-595"></a><a name="primOpCodeSizeForeignCall"></a><span class='hs-definition'>primOpCodeSizeForeignCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-596"></a><span class='hs-definition'>primOpCodeSizeForeignCall</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>4</span>
<a name="line-597"></a>
<a name="line-598"></a><span class='hs-comment'>{-
<a name="line-599"></a>************************************************************************
<a name="line-600"></a>*                                                                      *
<a name="line-601"></a>               PrimOp types
<a name="line-602"></a>*                                                                      *
<a name="line-603"></a>************************************************************************
<a name="line-604"></a>-}</span>
<a name="line-605"></a>
<a name="line-606"></a><a name="primOpType"></a><span class='hs-definition'>primOpType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>  <span class='hs-comment'>-- you may want to use primOpSig instead</span>
<a name="line-607"></a><span class='hs-definition'>primOpType</span> <span class='hs-varid'>op</span>
<a name="line-608"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>primOpInfo</span> <span class='hs-varid'>op</span> <span class='hs-keyword'>of</span>
<a name="line-609"></a>    <span class='hs-conid'>Compare</span> <span class='hs-sel'>_occ</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>compare_fun_ty</span> <span class='hs-varid'>ty</span>
<a name="line-610"></a>
<a name="line-611"></a>    <span class='hs-conid'>GenPrimOp</span> <span class='hs-sel'>_occ</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-612"></a>        <span class='hs-varid'>mkSpecForAllTys</span> <span class='hs-varid'>tyvars</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVisFunTysMany</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-613"></a>
<a name="line-614"></a><a name="primOpResultType"></a><span class='hs-definition'>primOpResultType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-615"></a><span class='hs-definition'>primOpResultType</span> <span class='hs-varid'>op</span>
<a name="line-616"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>primOpInfo</span> <span class='hs-varid'>op</span> <span class='hs-keyword'>of</span>
<a name="line-617"></a>    <span class='hs-conid'>Compare</span> <span class='hs-sel'>_occ</span> <span class='hs-sel'>_ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>intPrimTy</span>
<a name="line-618"></a>    <span class='hs-conid'>GenPrimOp</span> <span class='hs-sel'>_occ</span> <span class='hs-sel'>_tyvars</span> <span class='hs-sel'>_arg_tys</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>res_ty</span>
<a name="line-619"></a>
<a name="line-620"></a><a name="primOpOcc"></a><span class='hs-definition'>primOpOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span>
<a name="line-621"></a><span class='hs-definition'>primOpOcc</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>primOpInfo</span> <span class='hs-varid'>op</span> <span class='hs-keyword'>of</span>
<a name="line-622"></a>               <span class='hs-conid'>Compare</span>   <span class='hs-varid'>occ</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>occ</span>
<a name="line-623"></a>               <span class='hs-conid'>GenPrimOp</span> <span class='hs-varid'>occ</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>occ</span>
<a name="line-624"></a>
<a name="line-625"></a><span class='hs-comment'>{- Note [Primop wrappers]
<a name="line-626"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-627"></a>
<a name="line-628"></a>To support (limited) use of primops in GHCi genprimopcode generates the
<a name="line-629"></a>GHC.PrimopWrappers module. This module contains a "primop wrapper"
<a name="line-630"></a>binding for each primop. These are standard Haskell functions mirroring the
<a name="line-631"></a>types of the primops they wrap. For instance, in the case of plusInt# we would
<a name="line-632"></a>have:
<a name="line-633"></a>
<a name="line-634"></a>    module GHC.PrimopWrappers where
<a name="line-635"></a>    import GHC.Prim as P
<a name="line-636"></a>
<a name="line-637"></a>    plusInt# :: Int# -&gt; Int# -&gt; Int#
<a name="line-638"></a>    plusInt# a b = P.plusInt# a b
<a name="line-639"></a>
<a name="line-640"></a>The Id for the wrapper of a primop can be found using
<a name="line-641"></a>'GHC.Builtin.PrimOp.primOpWrapperId'. However, GHCi does not use this mechanism
<a name="line-642"></a>to link primops; it rather does a rather hacky symbol lookup (see
<a name="line-643"></a>GHC.ByteCode.Linker.primopToCLabel). TODO: Perhaps this should be changed?
<a name="line-644"></a>
<a name="line-645"></a>Note that these wrappers aren't *quite*
<a name="line-646"></a>as expressive as their unwrapped breathern in that they may exhibit less levity
<a name="line-647"></a>polymorphism. For instance, consider the case of mkWeakNoFinalizer# which has
<a name="line-648"></a>type:
<a name="line-649"></a>
<a name="line-650"></a>    mkWeakNoFinalizer# :: forall (r :: RuntimeRep) (k :: TYPE r) (v :: Type).
<a name="line-651"></a>                          k -&gt; v
<a name="line-652"></a>                       -&gt; State# RealWorld
<a name="line-653"></a>                       -&gt; (# State# RealWorld, Weak# v #)
<a name="line-654"></a>
<a name="line-655"></a>Naively we could generate a wrapper of the form,
<a name="line-656"></a>
<a name="line-657"></a>
<a name="line-658"></a>    mkWeakNoFinalizer# k v s = GHC.Prim.mkWeakNoFinalizer# k v s
<a name="line-659"></a>
<a name="line-660"></a>However, this would require that 'k' bind the levity-polymorphic key,
<a name="line-661"></a>which is disallowed by our levity polymorphism validity checks (see Note
<a name="line-662"></a>[Levity polymorphism invariants] in GHC.Core). Consequently, we give the
<a name="line-663"></a>wrapper the simpler, less polymorphic type
<a name="line-664"></a>
<a name="line-665"></a>    mkWeakNoFinalizer# :: forall (k :: Type) (v :: Type).
<a name="line-666"></a>                          k -&gt; v
<a name="line-667"></a>                       -&gt; State# RealWorld
<a name="line-668"></a>                       -&gt; (# State# RealWorld, Weak# v #)
<a name="line-669"></a>
<a name="line-670"></a>This simplification tends to be good enough for GHCi uses given that there are
<a name="line-671"></a>few levity polymorphic primops and we do little simplification on interpreted
<a name="line-672"></a>code anyways.
<a name="line-673"></a>
<a name="line-674"></a>TODO: This behavior is actually wrong; a program becomes ill-typed upon
<a name="line-675"></a>replacing a real primop occurrence with one of its wrapper due to the fact that
<a name="line-676"></a>the former has an additional type binder. Hmmm....
<a name="line-677"></a>
<a name="line-678"></a>Note [Eta expanding primops]
<a name="line-679"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-680"></a>
<a name="line-681"></a>STG requires that primop applications be saturated. This makes code generation
<a name="line-682"></a>significantly simpler since otherwise we would need to define a calling
<a name="line-683"></a>convention for curried applications that can accommodate levity polymorphism.
<a name="line-684"></a>
<a name="line-685"></a>To ensure saturation, CorePrep eta expands expand all primop applications as
<a name="line-686"></a>described in Note [Eta expansion of hasNoBinding things in CorePrep] in
<a name="line-687"></a>GHC.Core.Prep.
<a name="line-688"></a>
<a name="line-689"></a>Historical Note:
<a name="line-690"></a>
<a name="line-691"></a>For a short period around GHC 8.8 we rewrote unsaturated primop applications to
<a name="line-692"></a>rather use the primop's wrapper (see Note [Primop wrappers] in
<a name="line-693"></a>GHC.Builtin.PrimOps) instead of eta expansion. This was because at the time
<a name="line-694"></a>CoreTidy would try to predict the CAFfyness of bindings that would be produced
<a name="line-695"></a>by CorePrep for inclusion in interface files. Eta expanding during CorePrep
<a name="line-696"></a>proved to be very difficult to predict, leading to nasty inconsistencies in
<a name="line-697"></a>CAFfyness determinations (see #16846).
<a name="line-698"></a>
<a name="line-699"></a>Thankfully, we now no longer try to predict CAFfyness but rather compute it on
<a name="line-700"></a>GHC STG (see Note [SRTs] in GHC.Cmm.Info.Build) and inject it into the interface
<a name="line-701"></a>file after code generation (see TODO: Refer to whatever falls out of #18096).
<a name="line-702"></a>This is much simpler and avoids the potential for inconsistency, allowing us to
<a name="line-703"></a>return to the somewhat simpler eta expansion approach for unsaturated primops.
<a name="line-704"></a>
<a name="line-705"></a>See #18079.
<a name="line-706"></a>-}</span>
<a name="line-707"></a>
<a name="line-708"></a><a name="primOpWrapperId"></a><span class='hs-comment'>-- | Returns the 'Id' of the wrapper associated with the given 'PrimOp'.</span>
<a name="line-709"></a><span class='hs-comment'>-- See Note [Primop wrappers].</span>
<a name="line-710"></a><span class='hs-definition'>primOpWrapperId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-711"></a><span class='hs-definition'>primOpWrapperId</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVanillaGlobalWithInfo</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>info</span>
<a name="line-712"></a>  <span class='hs-keyword'>where</span>
<a name="line-713"></a>    <span class='hs-varid'>info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setCafInfo</span> <span class='hs-varid'>vanillaIdInfo</span> <span class='hs-conid'>NoCafRefs</span>
<a name="line-714"></a>    <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkExternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>gHC_PRIMOPWRAPPERS</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpOcc</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-varid'>wiredInSrcSpan</span>
<a name="line-715"></a>    <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPrimOpWrapperUnique</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpTag</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-716"></a>    <span class='hs-varid'>ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>primOpType</span> <span class='hs-varid'>op</span>
<a name="line-717"></a>
<a name="line-718"></a><a name="isComparisonPrimOp"></a><span class='hs-definition'>isComparisonPrimOp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-719"></a><span class='hs-definition'>isComparisonPrimOp</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>primOpInfo</span> <span class='hs-varid'>op</span> <span class='hs-keyword'>of</span>
<a name="line-720"></a>                          <span class='hs-conid'>Compare</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-721"></a>                          <span class='hs-conid'>GenPrimOp</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-722"></a>
<a name="line-723"></a><span class='hs-comment'>-- primOpSig is like primOpType but gives the result split apart:</span>
<a name="line-724"></a><span class='hs-comment'>-- (type variables, argument types, result type)</span>
<a name="line-725"></a><span class='hs-comment'>-- It also gives arity, strictness info</span>
<a name="line-726"></a>
<a name="line-727"></a><a name="primOpSig"></a><span class='hs-definition'>primOpSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Arity</span><span class='hs-layout'>,</span> <span class='hs-conid'>StrictSig</span><span class='hs-layout'>)</span>
<a name="line-728"></a><span class='hs-definition'>primOpSig</span> <span class='hs-varid'>op</span>
<a name="line-729"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>arity</span><span class='hs-layout'>,</span> <span class='hs-varid'>primOpStrictness</span> <span class='hs-varid'>op</span> <span class='hs-varid'>arity</span><span class='hs-layout'>)</span>
<a name="line-730"></a>  <span class='hs-keyword'>where</span>
<a name="line-731"></a>    <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>arg_tys</span>
<a name="line-732"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-733"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpInfo</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-734"></a>        <span class='hs-conid'>Compare</span>   <span class='hs-sel'>_occ</span> <span class='hs-varid'>ty</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span>     <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>intPrimTy</span><span class='hs-layout'>)</span>
<a name="line-735"></a>        <span class='hs-conid'>GenPrimOp</span> <span class='hs-sel'>_occ</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span>   <span class='hs-layout'>)</span>
<a name="line-736"></a>
<a name="line-737"></a><a name="PrimOpResultInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PrimOpResultInfo</span>
<a name="line-738"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ReturnsPrim</span>     <span class='hs-conid'>PrimRep</span>
<a name="line-739"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ReturnsAlg</span>      <span class='hs-conid'>TyCon</span>
<a name="line-740"></a>
<a name="line-741"></a><span class='hs-comment'>-- Some PrimOps need not return a manifest primitive or algebraic value</span>
<a name="line-742"></a><span class='hs-comment'>-- (i.e. they might return a polymorphic value).  These PrimOps *must*</span>
<a name="line-743"></a><span class='hs-comment'>-- be out of line, or the code generator won't work.</span>
<a name="line-744"></a>
<a name="line-745"></a><a name="getPrimOpResultInfo"></a><span class='hs-definition'>getPrimOpResultInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PrimOpResultInfo</span>
<a name="line-746"></a><span class='hs-definition'>getPrimOpResultInfo</span> <span class='hs-varid'>op</span>
<a name="line-747"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpInfo</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-748"></a>      <span class='hs-conid'>Compare</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ReturnsPrim</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConPrimRep1</span> <span class='hs-varid'>intPrimTyCon</span><span class='hs-layout'>)</span>
<a name="line-749"></a>      <span class='hs-conid'>GenPrimOp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPrimTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ReturnsPrim</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConPrimRep1</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-750"></a>                         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ReturnsAlg</span> <span class='hs-varid'>tc</span>
<a name="line-751"></a>                         <span class='hs-keyword'>where</span>
<a name="line-752"></a>                           <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppTyCon</span> <span class='hs-varid'>ty</span>
<a name="line-753"></a>                        <span class='hs-comment'>-- All primops return a tycon-app result</span>
<a name="line-754"></a>                        <span class='hs-comment'>-- The tycon can be an unboxed tuple or sum, though,</span>
<a name="line-755"></a>                        <span class='hs-comment'>-- which gives rise to a ReturnAlg</span>
<a name="line-756"></a>
<a name="line-757"></a><span class='hs-comment'>{-
<a name="line-758"></a>We do not currently make use of whether primops are commutable.
<a name="line-759"></a>
<a name="line-760"></a>We used to try to move constants to the right hand side for strength
<a name="line-761"></a>reduction.
<a name="line-762"></a>-}</span>
<a name="line-763"></a>
<a name="line-764"></a><span class='hs-comment'>{-
<a name="line-765"></a>commutableOp :: PrimOp -&gt; Bool
<a name="line-766"></a>#include "primop-commutable.hs-incl"
<a name="line-767"></a>-}</span>
<a name="line-768"></a>
<a name="line-769"></a><span class='hs-comment'>-- Utils:</span>
<a name="line-770"></a>
<a name="line-771"></a><a name="compare_fun_ty"></a><span class='hs-definition'>compare_fun_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-772"></a><span class='hs-definition'>compare_fun_ty</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVisFunTysMany</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>intPrimTy</span>
<a name="line-773"></a>
<a name="line-774"></a><span class='hs-comment'>-- Output stuff:</span>
<a name="line-775"></a>
<a name="line-776"></a><a name="pprPrimOp"></a><span class='hs-definition'>pprPrimOp</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-777"></a><span class='hs-definition'>pprPrimOp</span> <span class='hs-varid'>other_op</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprOccName</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpOcc</span> <span class='hs-varid'>other_op</span><span class='hs-layout'>)</span>
<a name="line-778"></a>
<a name="line-779"></a><span class='hs-comment'>{-
<a name="line-780"></a>************************************************************************
<a name="line-781"></a>*                                                                      *
<a name="line-782"></a>\subsubsection[PrimCall]{User-imported primitive calls}
<a name="line-783"></a>*                                                                      *
<a name="line-784"></a>************************************************************************
<a name="line-785"></a>-}</span>
<a name="line-786"></a>
<a name="line-787"></a><a name="PrimCall"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PrimCall</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PrimCall</span> <span class='hs-conid'>CLabelString</span> <span class='hs-conid'>Unit</span>
<a name="line-788"></a>
<a name="line-789"></a><a name="instance%20Outputable%20PrimCall"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>PrimCall</span> <span class='hs-keyword'>where</span>
<a name="line-790"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimCall</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>pkgId</span><span class='hs-layout'>)</span>
<a name="line-791"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"__primcall"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>pkgId</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>lbl</span>
</pre></body>
</html>
