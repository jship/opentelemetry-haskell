<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Core/Opt/Pipeline.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
<a name="line-3"></a>
<a name="line-4"></a>\section[SimplCore]{Driver for simplifying @Core@ programs}
<a name="line-5"></a>-}</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Core.Opt.Pipeline</span> <span class='hs-layout'>(</span> <span class='hs-varid'>core2core</span><span class='hs-layout'>,</span> <span class='hs-varid'>simplifyExpr</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Session</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Ppr</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Plugins</span> <span class='hs-layout'>(</span> <span class='hs-varid'>withPlugins</span><span class='hs-layout'>,</span> <span class='hs-varid'>installCoreToDos</span> <span class='hs-layout'>)</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Env</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Platform.Ways</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>hasWay</span><span class='hs-layout'>,</span> <span class='hs-conid'>Way</span><span class='hs-layout'>(</span><span class='hs-conid'>WayProf</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.CSE</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>cseProgram</span> <span class='hs-layout'>)</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Rules</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>mkRuleBase</span><span class='hs-layout'>,</span> <span class='hs-varid'>unionRuleBase</span><span class='hs-layout'>,</span>
<a name="line-24"></a>                          <span class='hs-varid'>extendRuleBaseList</span><span class='hs-layout'>,</span> <span class='hs-varid'>ruleCheckProgram</span><span class='hs-layout'>,</span> <span class='hs-varid'>addRuleInfo</span><span class='hs-layout'>,</span>
<a name="line-25"></a>                          <span class='hs-varid'>getRules</span><span class='hs-layout'>,</span> <span class='hs-varid'>initRuleOpts</span> <span class='hs-layout'>)</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Ppr</span>     <span class='hs-layout'>(</span> <span class='hs-varid'>pprCoreBindings</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprCoreExpr</span> <span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.OccurAnal</span> <span class='hs-layout'>(</span> <span class='hs-varid'>occurAnalysePgm</span><span class='hs-layout'>,</span> <span class='hs-varid'>occurAnalyseExpr</span> <span class='hs-layout'>)</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Stats</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>coreBindsSize</span><span class='hs-layout'>,</span> <span class='hs-varid'>coreBindsStats</span><span class='hs-layout'>,</span> <span class='hs-varid'>exprSize</span> <span class='hs-layout'>)</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Utils</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>mkTicks</span><span class='hs-layout'>,</span> <span class='hs-varid'>stripTicksTop</span><span class='hs-layout'>,</span> <span class='hs-varid'>dumpIdInfoOfProgram</span> <span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Lint</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>endPass</span><span class='hs-layout'>,</span> <span class='hs-varid'>lintPassResult</span><span class='hs-layout'>,</span> <span class='hs-varid'>dumpPassResult</span><span class='hs-layout'>,</span>
<a name="line-31"></a>                          <span class='hs-varid'>lintAnnots</span> <span class='hs-layout'>)</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.Simplify</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>simplTopBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>simplExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>simplRules</span> <span class='hs-layout'>)</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.Simplify.Utils</span> <span class='hs-layout'>(</span> <span class='hs-varid'>simplEnvForGHCi</span><span class='hs-layout'>,</span> <span class='hs-varid'>activeRule</span><span class='hs-layout'>,</span> <span class='hs-varid'>activeUnfolding</span> <span class='hs-layout'>)</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.Simplify.Env</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.Simplify.Monad</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.Monad</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.FloatIn</span>      <span class='hs-layout'>(</span> <span class='hs-varid'>floatInwards</span> <span class='hs-layout'>)</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.FloatOut</span>     <span class='hs-layout'>(</span> <span class='hs-varid'>floatOutwards</span> <span class='hs-layout'>)</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.LiberateCase</span> <span class='hs-layout'>(</span> <span class='hs-varid'>liberateCase</span> <span class='hs-layout'>)</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.StaticArgs</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>doStaticArgs</span> <span class='hs-layout'>)</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.Specialise</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>specProgram</span><span class='hs-layout'>)</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.SpecConstr</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>specConstrProgram</span><span class='hs-layout'>)</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.DmdAnal</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.CprAnal</span>      <span class='hs-layout'>(</span> <span class='hs-varid'>cprAnalProgram</span> <span class='hs-layout'>)</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.CallArity</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>callArityAnalProgram</span> <span class='hs-layout'>)</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.Exitify</span>      <span class='hs-layout'>(</span> <span class='hs-varid'>exitifyProgram</span> <span class='hs-layout'>)</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.WorkWrap</span>     <span class='hs-layout'>(</span> <span class='hs-varid'>wwTopBinds</span> <span class='hs-layout'>)</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.CallerCC</span>     <span class='hs-layout'>(</span> <span class='hs-varid'>addCallerCostCentres</span> <span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Seq</span> <span class='hs-layout'>(</span><span class='hs-varid'>seqBinds</span><span class='hs-layout'>)</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.FamInstEnv</span>
<a name="line-51"></a>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.Utils.Error</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Err</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Error</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>withTiming</span> <span class='hs-layout'>)</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Logger</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Logger</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-58"></a>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.External</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.Env</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.ModGuts</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.Deps</span>
<a name="line-63"></a>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Runtime.Context</span>
<a name="line-65"></a>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SrcLoc</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Id</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Id.Info</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Basic</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Demand</span> <span class='hs-layout'>(</span> <span class='hs-varid'>zapDmdEnvSig</span> <span class='hs-layout'>)</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var.Set</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var.Env</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Tickish</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.Supply</span> <span class='hs-layout'>(</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-layout'>)</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.FM</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Ppr</span>
<a name="line-77"></a>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad</span>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.LanguageExtensions</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>LangExt</span>
<a name="line-80"></a><span class='hs-comment'>{-
<a name="line-81"></a>************************************************************************
<a name="line-82"></a>*                                                                      *
<a name="line-83"></a>\subsection{The driver for the simplifier}
<a name="line-84"></a>*                                                                      *
<a name="line-85"></a>************************************************************************
<a name="line-86"></a>-}</span>
<a name="line-87"></a>
<a name="line-88"></a><a name="core2core"></a><span class='hs-definition'>core2core</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ModGuts</span>
<a name="line-89"></a><span class='hs-definition'>core2core</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>guts</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ModGuts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_module</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod</span>
<a name="line-90"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>mg_loc</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span>
<a name="line-91"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>mg_deps</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deps</span>
<a name="line-92"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>mg_rdr_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rdr_env</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-93"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>builtin_passes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getCoreToDo</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span>
<a name="line-94"></a>             <span class='hs-varid'>orph_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkModuleSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>mod</span> <span class='hs-conop'>:</span> <span class='hs-varid'>dep_orphs</span> <span class='hs-varid'>deps</span><span class='hs-layout'>)</span>
<a name="line-95"></a>             <span class='hs-varid'>uniq_mask</span> <span class='hs-keyglyph'>=</span> <span class='hs-chr'>'s'</span>
<a name="line-96"></a>       <span class='hs-layout'>;</span>
<a name="line-97"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>guts2</span><span class='hs-layout'>,</span> <span class='hs-varid'>stats</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runCoreM</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>hpt_rule_base</span> <span class='hs-varid'>uniq_mask</span> <span class='hs-varid'>mod</span>
<a name="line-98"></a>                                    <span class='hs-varid'>orph_mods</span> <span class='hs-varid'>print_unqual</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-99"></a>                           <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_env'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-100"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>all_passes</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>withPlugins</span> <span class='hs-varid'>hsc_env'</span>
<a name="line-101"></a>                                                <span class='hs-varid'>installCoreToDos</span>
<a name="line-102"></a>                                                <span class='hs-varid'>builtin_passes</span>
<a name="line-103"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>runCorePasses</span> <span class='hs-varid'>all_passes</span> <span class='hs-varid'>guts</span> <span class='hs-layout'>}</span>
<a name="line-104"></a>
<a name="line-105"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>Logger.dumpIfSet_dyn</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_simpl_stats</span>
<a name="line-106"></a>             <span class='hs-str'>"Grand total simplifier statistics"</span>
<a name="line-107"></a>             <span class='hs-conid'>FormatText</span>
<a name="line-108"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>pprSimplCount</span> <span class='hs-varid'>stats</span><span class='hs-layout'>)</span>
<a name="line-109"></a>
<a name="line-110"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>guts2</span> <span class='hs-layout'>}</span>
<a name="line-111"></a>  <span class='hs-keyword'>where</span>
<a name="line-112"></a>    <span class='hs-varid'>logger</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_logger</span> <span class='hs-varid'>hsc_env</span>
<a name="line-113"></a>    <span class='hs-varid'>dflags</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-114"></a>    <span class='hs-varid'>home_pkg_rules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hptRules</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>dep_mods</span> <span class='hs-varid'>deps</span><span class='hs-layout'>)</span>
<a name="line-115"></a>    <span class='hs-varid'>hpt_rule_base</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRuleBase</span> <span class='hs-varid'>home_pkg_rules</span>
<a name="line-116"></a>    <span class='hs-varid'>print_unqual</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPrintUnqualified</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_unit_env</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>rdr_env</span>
<a name="line-117"></a>    <span class='hs-comment'>-- mod: get the module out of the current HscEnv so we can retrieve it from the monad.</span>
<a name="line-118"></a>    <span class='hs-comment'>-- This is very convienent for the users of the monad (e.g. plugins do not have to</span>
<a name="line-119"></a>    <span class='hs-comment'>-- consume the ModGuts to find the module) but somewhat ugly because mg_module may</span>
<a name="line-120"></a>    <span class='hs-comment'>-- _theoretically_ be changed during the Core pipeline (it's part of ModGuts), which</span>
<a name="line-121"></a>    <span class='hs-comment'>-- would mean our cached value would go out of date.</span>
<a name="line-122"></a>
<a name="line-123"></a><span class='hs-comment'>{-
<a name="line-124"></a>************************************************************************
<a name="line-125"></a>*                                                                      *
<a name="line-126"></a>           Generating the main optimisation pipeline
<a name="line-127"></a>*                                                                      *
<a name="line-128"></a>************************************************************************
<a name="line-129"></a>-}</span>
<a name="line-130"></a>
<a name="line-131"></a><a name="getCoreToDo"></a><span class='hs-definition'>getCoreToDo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Logger</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreToDo</span><span class='hs-keyglyph'>]</span>
<a name="line-132"></a><span class='hs-definition'>getCoreToDo</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span>
<a name="line-133"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flatten_todos</span> <span class='hs-varid'>core_todo</span>
<a name="line-134"></a>  <span class='hs-keyword'>where</span>
<a name="line-135"></a>    <span class='hs-varid'>opt_level</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>optLevel</span>           <span class='hs-varid'>dflags</span>
<a name="line-136"></a>    <span class='hs-varid'>phases</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simplPhases</span>        <span class='hs-varid'>dflags</span>
<a name="line-137"></a>    <span class='hs-varid'>max_iter</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maxSimplIterations</span> <span class='hs-varid'>dflags</span>
<a name="line-138"></a>    <span class='hs-varid'>rule_check</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ruleCheck</span>          <span class='hs-varid'>dflags</span>
<a name="line-139"></a>    <span class='hs-varid'>call_arity</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_CallArity</span>                    <span class='hs-varid'>dflags</span>
<a name="line-140"></a>    <span class='hs-varid'>exitification</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_Exitification</span>                <span class='hs-varid'>dflags</span>
<a name="line-141"></a>    <span class='hs-varid'>strictness</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_Strictness</span>                   <span class='hs-varid'>dflags</span>
<a name="line-142"></a>    <span class='hs-varid'>full_laziness</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_FullLaziness</span>                 <span class='hs-varid'>dflags</span>
<a name="line-143"></a>    <span class='hs-varid'>do_specialise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_Specialise</span>                   <span class='hs-varid'>dflags</span>
<a name="line-144"></a>    <span class='hs-varid'>do_float_in</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_FloatIn</span>                      <span class='hs-varid'>dflags</span>
<a name="line-145"></a>    <span class='hs-varid'>cse</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_CSE</span>                          <span class='hs-varid'>dflags</span>
<a name="line-146"></a>    <span class='hs-varid'>spec_constr</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_SpecConstr</span>                   <span class='hs-varid'>dflags</span>
<a name="line-147"></a>    <span class='hs-varid'>liberate_case</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_LiberateCase</span>                 <span class='hs-varid'>dflags</span>
<a name="line-148"></a>    <span class='hs-varid'>late_dmd_anal</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_LateDmdAnal</span>                  <span class='hs-varid'>dflags</span>
<a name="line-149"></a>    <span class='hs-varid'>late_specialise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_LateSpecialise</span>             <span class='hs-varid'>dflags</span>
<a name="line-150"></a>    <span class='hs-varid'>static_args</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_StaticArgumentTransformation</span> <span class='hs-varid'>dflags</span>
<a name="line-151"></a>    <span class='hs-varid'>rules_on</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_EnableRewriteRules</span>           <span class='hs-varid'>dflags</span>
<a name="line-152"></a>    <span class='hs-varid'>eta_expand_on</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_DoLambdaEtaExpansion</span>         <span class='hs-varid'>dflags</span>
<a name="line-153"></a>    <span class='hs-varid'>pre_inline_on</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_SimplPreInlining</span>             <span class='hs-varid'>dflags</span>
<a name="line-154"></a>    <span class='hs-varid'>ww_on</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_WorkerWrapper</span>                <span class='hs-varid'>dflags</span>
<a name="line-155"></a>    <span class='hs-varid'>static_ptrs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>LangExt.StaticPointers</span>           <span class='hs-varid'>dflags</span>
<a name="line-156"></a>    <span class='hs-varid'>profiling</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ways</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>`hasWay`</span> <span class='hs-conid'>WayProf</span>
<a name="line-157"></a>
<a name="line-158"></a>    <span class='hs-varid'>maybe_rule_check</span> <span class='hs-varid'>phase</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runMaybe</span> <span class='hs-varid'>rule_check</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoRuleCheck</span> <span class='hs-varid'>phase</span><span class='hs-layout'>)</span>
<a name="line-159"></a>
<a name="line-160"></a>    <span class='hs-varid'>maybe_strictness_before</span> <span class='hs-layout'>(</span><span class='hs-conid'>Phase</span> <span class='hs-varid'>phase</span><span class='hs-layout'>)</span>
<a name="line-161"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>phase</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>strictnessBefore</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreDoDemand</span>
<a name="line-162"></a>    <span class='hs-varid'>maybe_strictness_before</span> <span class='hs-keyword'>_</span>
<a name="line-163"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreDoNothing</span>
<a name="line-164"></a>
<a name="line-165"></a>    <span class='hs-varid'>base_mode</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SimplMode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_phase</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"base_mode"</span>
<a name="line-166"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>sm_names</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-167"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>sm_dflags</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dflags</span>
<a name="line-168"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>sm_logger</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>logger</span>
<a name="line-169"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>sm_uf_opts</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unfoldingOpts</span> <span class='hs-varid'>dflags</span>
<a name="line-170"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>sm_rules</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rules_on</span>
<a name="line-171"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>sm_eta_expand</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eta_expand_on</span>
<a name="line-172"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>sm_cast_swizzle</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-173"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>sm_inline</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-174"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>sm_case_case</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-175"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>sm_pre_inline</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pre_inline_on</span>
<a name="line-176"></a>                          <span class='hs-layout'>}</span>
<a name="line-177"></a>
<a name="line-178"></a>    <span class='hs-varid'>simpl_phase</span> <span class='hs-varid'>phase</span> <span class='hs-varid'>name</span> <span class='hs-varid'>iter</span>
<a name="line-179"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreDoPasses</span>
<a name="line-180"></a>      <span class='hs-varop'>$</span>   <span class='hs-keyglyph'>[</span> <span class='hs-varid'>maybe_strictness_before</span> <span class='hs-varid'>phase</span>
<a name="line-181"></a>          <span class='hs-layout'>,</span> <span class='hs-conid'>CoreDoSimplify</span> <span class='hs-varid'>iter</span>
<a name="line-182"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>base_mode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_phase</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>phase</span>
<a name="line-183"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>sm_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>name</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-184"></a>
<a name="line-185"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>maybe_rule_check</span> <span class='hs-varid'>phase</span> <span class='hs-keyglyph'>]</span>
<a name="line-186"></a>
<a name="line-187"></a>    <span class='hs-comment'>-- Run GHC's internal simplification phase, after all rules have run.</span>
<a name="line-188"></a>    <span class='hs-comment'>-- See Note [Compiler phases] in GHC.Types.Basic</span>
<a name="line-189"></a>    <span class='hs-varid'>simplify</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simpl_phase</span> <span class='hs-conid'>FinalPhase</span> <span class='hs-varid'>name</span> <span class='hs-varid'>max_iter</span>
<a name="line-190"></a>
<a name="line-191"></a>    <span class='hs-comment'>-- initial simplify: mk specialiser happy: minimum effort please</span>
<a name="line-192"></a>    <span class='hs-varid'>simpl_gently</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreDoSimplify</span> <span class='hs-varid'>max_iter</span>
<a name="line-193"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>base_mode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_phase</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InitialPhase</span>
<a name="line-194"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>sm_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"Gentle"</span><span class='hs-keyglyph'>]</span>
<a name="line-195"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>sm_rules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rules_on</span>   <span class='hs-comment'>-- Note [RULEs enabled in InitialPhase]</span>
<a name="line-196"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>sm_inline</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-197"></a>                                              <span class='hs-comment'>-- See Note [Inline in InitialPhase]</span>
<a name="line-198"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>sm_case_case</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-199"></a>                          <span class='hs-comment'>-- Don't do case-of-case transformations.</span>
<a name="line-200"></a>                          <span class='hs-comment'>-- This makes full laziness work better</span>
<a name="line-201"></a>
<a name="line-202"></a>    <span class='hs-varid'>dmd_cpr_ww</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>ww_on</span> <span class='hs-keyword'>then</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreDoDemand</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreDoCpr</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreDoWorkerWrapper</span><span class='hs-keyglyph'>]</span>
<a name="line-203"></a>                          <span class='hs-keyword'>else</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreDoDemand</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreDoCpr</span><span class='hs-keyglyph'>]</span>
<a name="line-204"></a>
<a name="line-205"></a>
<a name="line-206"></a>    <span class='hs-varid'>demand_analyser</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoPasses</span> <span class='hs-layout'>(</span>
<a name="line-207"></a>                           <span class='hs-varid'>dmd_cpr_ww</span> <span class='hs-varop'>++</span>
<a name="line-208"></a>                           <span class='hs-keyglyph'>[</span><span class='hs-varid'>simplify</span> <span class='hs-str'>"post-worker-wrapper"</span><span class='hs-keyglyph'>]</span>
<a name="line-209"></a>                           <span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-210"></a>
<a name="line-211"></a>    <span class='hs-comment'>-- Static forms are moved to the top level with the FloatOut pass.</span>
<a name="line-212"></a>    <span class='hs-comment'>-- See Note [Grand plan for static forms] in GHC.Iface.Tidy.StaticPtrTable.</span>
<a name="line-213"></a>    <span class='hs-varid'>static_ptrs_float_outwards</span> <span class='hs-keyglyph'>=</span>
<a name="line-214"></a>      <span class='hs-varid'>runWhen</span> <span class='hs-varid'>static_ptrs</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CoreDoPasses</span>
<a name="line-215"></a>        <span class='hs-keyglyph'>[</span> <span class='hs-varid'>simpl_gently</span> <span class='hs-comment'>-- Float Out can't handle type lets (sometimes created</span>
<a name="line-216"></a>                       <span class='hs-comment'>-- by simpleOptPgm via mkParallelBindings)</span>
<a name="line-217"></a>        <span class='hs-layout'>,</span> <span class='hs-conid'>CoreDoFloatOutwards</span> <span class='hs-conid'>FloatOutSwitches</span>
<a name="line-218"></a>          <span class='hs-layout'>{</span> <span class='hs-varid'>floatOutLambdas</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-num'>0</span>
<a name="line-219"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>floatOutConstants</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-220"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>floatOutOverSatApps</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-221"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>floatToTopLevelOnly</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-222"></a>          <span class='hs-layout'>}</span>
<a name="line-223"></a>        <span class='hs-keyglyph'>]</span>
<a name="line-224"></a>
<a name="line-225"></a>    <span class='hs-varid'>add_caller_ccs</span> <span class='hs-keyglyph'>=</span>
<a name="line-226"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-layout'>(</span><span class='hs-varid'>profiling</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varop'>$</span> <span class='hs-varid'>callerCcFilters</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>CoreAddCallerCcs</span>
<a name="line-227"></a>
<a name="line-228"></a>    <span class='hs-varid'>core_todo</span> <span class='hs-keyglyph'>=</span>
<a name="line-229"></a>     <span class='hs-keyword'>if</span> <span class='hs-varid'>opt_level</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyword'>then</span>
<a name="line-230"></a>       <span class='hs-keyglyph'>[</span> <span class='hs-varid'>static_ptrs_float_outwards</span><span class='hs-layout'>,</span>
<a name="line-231"></a>         <span class='hs-conid'>CoreDoSimplify</span> <span class='hs-varid'>max_iter</span>
<a name="line-232"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>base_mode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_phase</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FinalPhase</span>
<a name="line-233"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>sm_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"Non-opt simplification"</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-234"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>add_caller_ccs</span>
<a name="line-235"></a>       <span class='hs-keyglyph'>]</span>
<a name="line-236"></a>
<a name="line-237"></a>     <span class='hs-keyword'>else</span> <span class='hs-comment'>{- opt_level &gt;= 1 -}</span> <span class='hs-keyglyph'>[</span>
<a name="line-238"></a>
<a name="line-239"></a>    <span class='hs-comment'>-- We want to do the static argument transform before full laziness as it</span>
<a name="line-240"></a>    <span class='hs-comment'>-- may expose extra opportunities to float things outwards. However, to fix</span>
<a name="line-241"></a>    <span class='hs-comment'>-- up the output of the transformation we need at do at least one simplify</span>
<a name="line-242"></a>    <span class='hs-comment'>-- after this before anything else</span>
<a name="line-243"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>static_args</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoPasses</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>simpl_gently</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreDoStaticArgs</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-244"></a>
<a name="line-245"></a>        <span class='hs-comment'>-- initial simplify: mk specialiser happy: minimum effort please</span>
<a name="line-246"></a>        <span class='hs-varid'>simpl_gently</span><span class='hs-layout'>,</span>
<a name="line-247"></a>
<a name="line-248"></a>        <span class='hs-comment'>-- Specialisation is best done before full laziness</span>
<a name="line-249"></a>        <span class='hs-comment'>-- so that overloaded functions have all their dictionary lambdas manifest</span>
<a name="line-250"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>do_specialise</span> <span class='hs-conid'>CoreDoSpecialising</span><span class='hs-layout'>,</span>
<a name="line-251"></a>
<a name="line-252"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>full_laziness</span> <span class='hs-keyword'>then</span>
<a name="line-253"></a>           <span class='hs-conid'>CoreDoFloatOutwards</span> <span class='hs-conid'>FloatOutSwitches</span> <span class='hs-layout'>{</span>
<a name="line-254"></a>                                 <span class='hs-varid'>floatOutLambdas</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-num'>0</span><span class='hs-layout'>,</span>
<a name="line-255"></a>                                 <span class='hs-varid'>floatOutConstants</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span>
<a name="line-256"></a>                                 <span class='hs-varid'>floatOutOverSatApps</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span>
<a name="line-257"></a>                                 <span class='hs-varid'>floatToTopLevelOnly</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span>
<a name="line-258"></a>                <span class='hs-comment'>-- Was: gentleFloatOutSwitches</span>
<a name="line-259"></a>                <span class='hs-comment'>--</span>
<a name="line-260"></a>                <span class='hs-comment'>-- I have no idea why, but not floating constants to</span>
<a name="line-261"></a>                <span class='hs-comment'>-- top level is very bad in some cases.</span>
<a name="line-262"></a>                <span class='hs-comment'>--</span>
<a name="line-263"></a>                <span class='hs-comment'>-- Notably: p_ident in spectral/rewrite</span>
<a name="line-264"></a>                <span class='hs-comment'>--          Changing from "gentle" to "constantsOnly"</span>
<a name="line-265"></a>                <span class='hs-comment'>--          improved rewrite's allocation by 19%, and</span>
<a name="line-266"></a>                <span class='hs-comment'>--          made 0.0% difference to any other nofib</span>
<a name="line-267"></a>                <span class='hs-comment'>--          benchmark</span>
<a name="line-268"></a>                <span class='hs-comment'>--</span>
<a name="line-269"></a>                <span class='hs-comment'>-- Not doing floatOutOverSatApps yet, we'll do</span>
<a name="line-270"></a>                <span class='hs-comment'>-- that later on when we've had a chance to get more</span>
<a name="line-271"></a>                <span class='hs-comment'>-- accurate arity information.  In fact it makes no</span>
<a name="line-272"></a>                <span class='hs-comment'>-- difference at all to performance if we do it here,</span>
<a name="line-273"></a>                <span class='hs-comment'>-- but maybe we save some unnecessary to-and-fro in</span>
<a name="line-274"></a>                <span class='hs-comment'>-- the simplifier.</span>
<a name="line-275"></a>        <span class='hs-keyword'>else</span>
<a name="line-276"></a>           <span class='hs-comment'>-- Even with full laziness turned off, we still need to float static</span>
<a name="line-277"></a>           <span class='hs-comment'>-- forms to the top level. See Note [Grand plan for static forms] in</span>
<a name="line-278"></a>           <span class='hs-comment'>-- GHC.Iface.Tidy.StaticPtrTable.</span>
<a name="line-279"></a>           <span class='hs-varid'>static_ptrs_float_outwards</span><span class='hs-layout'>,</span>
<a name="line-280"></a>
<a name="line-281"></a>        <span class='hs-comment'>-- Run the simplier phases 2,1,0 to allow rewrite rules to fire</span>
<a name="line-282"></a>        <span class='hs-conid'>CoreDoPasses</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>simpl_phase</span> <span class='hs-layout'>(</span><span class='hs-conid'>Phase</span> <span class='hs-varid'>phase</span><span class='hs-layout'>)</span> <span class='hs-str'>"main"</span> <span class='hs-varid'>max_iter</span>
<a name="line-283"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>phase</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>phases</span><span class='hs-layout'>,</span> <span class='hs-varid'>phases</span><span class='hs-comment'>-</span><span class='hs-num'>1</span> <span class='hs-keyglyph'>..</span> <span class='hs-num'>1</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-284"></a>        <span class='hs-varid'>simpl_phase</span> <span class='hs-layout'>(</span><span class='hs-conid'>Phase</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-str'>"main"</span> <span class='hs-layout'>(</span><span class='hs-varid'>max</span> <span class='hs-varid'>max_iter</span> <span class='hs-num'>3</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-285"></a>                <span class='hs-comment'>-- Phase 0: allow all Ids to be inlined now</span>
<a name="line-286"></a>                <span class='hs-comment'>-- This gets foldr inlined before strictness analysis</span>
<a name="line-287"></a>
<a name="line-288"></a>                <span class='hs-comment'>-- At least 3 iterations because otherwise we land up with</span>
<a name="line-289"></a>                <span class='hs-comment'>-- huge dead expressions because of an infelicity in the</span>
<a name="line-290"></a>                <span class='hs-comment'>-- simplifier.</span>
<a name="line-291"></a>                <span class='hs-comment'>--      let k = BIG in foldr k z xs</span>
<a name="line-292"></a>                <span class='hs-comment'>-- ==&gt;  let k = BIG in letrec go = \xs -&gt; ...(k x).... in go xs</span>
<a name="line-293"></a>                <span class='hs-comment'>-- ==&gt;  let k = BIG in letrec go = \xs -&gt; ...(BIG x).... in go xs</span>
<a name="line-294"></a>                <span class='hs-comment'>-- Don't stop now!</span>
<a name="line-295"></a>
<a name="line-296"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>do_float_in</span> <span class='hs-conid'>CoreDoFloatInwards</span><span class='hs-layout'>,</span>
<a name="line-297"></a>            <span class='hs-comment'>-- Run float-inwards immediately before the strictness analyser</span>
<a name="line-298"></a>            <span class='hs-comment'>-- Doing so pushes bindings nearer their use site and hence makes</span>
<a name="line-299"></a>            <span class='hs-comment'>-- them more likely to be strict. These bindings might only show</span>
<a name="line-300"></a>            <span class='hs-comment'>-- up after the inlining from simplification.  Example in fulsom,</span>
<a name="line-301"></a>            <span class='hs-comment'>-- Csg.calc, where an arg of timesDouble thereby becomes strict.</span>
<a name="line-302"></a>
<a name="line-303"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>call_arity</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CoreDoPasses</span>
<a name="line-304"></a>            <span class='hs-keyglyph'>[</span> <span class='hs-conid'>CoreDoCallArity</span>
<a name="line-305"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>simplify</span> <span class='hs-str'>"post-call-arity"</span>
<a name="line-306"></a>            <span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-307"></a>
<a name="line-308"></a>        <span class='hs-comment'>-- Strictness analysis</span>
<a name="line-309"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>strictness</span> <span class='hs-varid'>demand_analyser</span><span class='hs-layout'>,</span>
<a name="line-310"></a>
<a name="line-311"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>exitification</span> <span class='hs-conid'>CoreDoExitify</span><span class='hs-layout'>,</span>
<a name="line-312"></a>            <span class='hs-comment'>-- See note [Placement of the exitification pass]</span>
<a name="line-313"></a>
<a name="line-314"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>full_laziness</span> <span class='hs-varop'>$</span>
<a name="line-315"></a>           <span class='hs-conid'>CoreDoFloatOutwards</span> <span class='hs-conid'>FloatOutSwitches</span> <span class='hs-layout'>{</span>
<a name="line-316"></a>                                 <span class='hs-varid'>floatOutLambdas</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>floatLamArgs</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>,</span>
<a name="line-317"></a>                                 <span class='hs-varid'>floatOutConstants</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span>
<a name="line-318"></a>                                 <span class='hs-varid'>floatOutOverSatApps</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span>
<a name="line-319"></a>                                 <span class='hs-varid'>floatToTopLevelOnly</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span>
<a name="line-320"></a>                <span class='hs-comment'>-- nofib/spectral/hartel/wang doubles in speed if you</span>
<a name="line-321"></a>                <span class='hs-comment'>-- do full laziness late in the day.  It only happens</span>
<a name="line-322"></a>                <span class='hs-comment'>-- after fusion and other stuff, so the early pass doesn't</span>
<a name="line-323"></a>                <span class='hs-comment'>-- catch it.  For the record, the redex is</span>
<a name="line-324"></a>                <span class='hs-comment'>--        f_el22 (f_el21 r_midblock)</span>
<a name="line-325"></a>
<a name="line-326"></a>
<a name="line-327"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>cse</span> <span class='hs-conid'>CoreCSE</span><span class='hs-layout'>,</span>
<a name="line-328"></a>                <span class='hs-comment'>-- We want CSE to follow the final full-laziness pass, because it may</span>
<a name="line-329"></a>                <span class='hs-comment'>-- succeed in commoning up things floated out by full laziness.</span>
<a name="line-330"></a>                <span class='hs-comment'>-- CSE used to rely on the no-shadowing invariant, but it doesn't any more</span>
<a name="line-331"></a>
<a name="line-332"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>do_float_in</span> <span class='hs-conid'>CoreDoFloatInwards</span><span class='hs-layout'>,</span>
<a name="line-333"></a>
<a name="line-334"></a>        <span class='hs-varid'>simplify</span> <span class='hs-str'>"final"</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- Final tidy-up</span>
<a name="line-335"></a>
<a name="line-336"></a>        <span class='hs-varid'>maybe_rule_check</span> <span class='hs-conid'>FinalPhase</span><span class='hs-layout'>,</span>
<a name="line-337"></a>
<a name="line-338"></a>        <span class='hs-comment'>--------  After this we have -O2 passes -----------------</span>
<a name="line-339"></a>        <span class='hs-comment'>-- None of them run with -O</span>
<a name="line-340"></a>
<a name="line-341"></a>                <span class='hs-comment'>-- Case-liberation for -O2.  This should be after</span>
<a name="line-342"></a>                <span class='hs-comment'>-- strictness analysis and the simplification which follows it.</span>
<a name="line-343"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>liberate_case</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CoreDoPasses</span>
<a name="line-344"></a>           <span class='hs-keyglyph'>[</span> <span class='hs-conid'>CoreLiberateCase</span><span class='hs-layout'>,</span> <span class='hs-varid'>simplify</span> <span class='hs-str'>"post-liberate-case"</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-345"></a>           <span class='hs-comment'>-- Run the simplifier after LiberateCase to vastly</span>
<a name="line-346"></a>           <span class='hs-comment'>-- reduce the possibility of shadowing</span>
<a name="line-347"></a>           <span class='hs-comment'>-- Reason: see Note [Shadowing] in GHC.Core.Opt.SpecConstr</span>
<a name="line-348"></a>
<a name="line-349"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>spec_constr</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CoreDoPasses</span>
<a name="line-350"></a>           <span class='hs-keyglyph'>[</span> <span class='hs-conid'>CoreDoSpecConstr</span><span class='hs-layout'>,</span> <span class='hs-varid'>simplify</span> <span class='hs-str'>"post-spec-constr"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-351"></a>           <span class='hs-comment'>-- See Note [Simplify after SpecConstr]</span>
<a name="line-352"></a>
<a name="line-353"></a>        <span class='hs-varid'>maybe_rule_check</span> <span class='hs-conid'>FinalPhase</span><span class='hs-layout'>,</span>
<a name="line-354"></a>
<a name="line-355"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>late_specialise</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CoreDoPasses</span>
<a name="line-356"></a>           <span class='hs-keyglyph'>[</span> <span class='hs-conid'>CoreDoSpecialising</span><span class='hs-layout'>,</span> <span class='hs-varid'>simplify</span> <span class='hs-str'>"post-late-spec"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-357"></a>
<a name="line-358"></a>        <span class='hs-comment'>-- LiberateCase can yield new CSE opportunities because it peels</span>
<a name="line-359"></a>        <span class='hs-comment'>-- off one layer of a recursive function (concretely, I saw this</span>
<a name="line-360"></a>        <span class='hs-comment'>-- in wheel-sieve1), and I'm guessing that SpecConstr can too</span>
<a name="line-361"></a>        <span class='hs-comment'>-- And CSE is a very cheap pass. So it seems worth doing here.</span>
<a name="line-362"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>liberate_case</span> <span class='hs-varop'>||</span> <span class='hs-varid'>spec_constr</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>cse</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CoreDoPasses</span>
<a name="line-363"></a>           <span class='hs-keyglyph'>[</span> <span class='hs-conid'>CoreCSE</span><span class='hs-layout'>,</span> <span class='hs-varid'>simplify</span> <span class='hs-str'>"post-final-cse"</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-364"></a>
<a name="line-365"></a>        <span class='hs-comment'>---------  End of -O2 passes --------------</span>
<a name="line-366"></a>
<a name="line-367"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>late_dmd_anal</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CoreDoPasses</span> <span class='hs-layout'>(</span>
<a name="line-368"></a>            <span class='hs-varid'>dmd_cpr_ww</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>simplify</span> <span class='hs-str'>"post-late-ww"</span><span class='hs-keyglyph'>]</span>
<a name="line-369"></a>          <span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-370"></a>
<a name="line-371"></a>        <span class='hs-comment'>-- Final run of the demand_analyser, ensures that one-shot thunks are</span>
<a name="line-372"></a>        <span class='hs-comment'>-- really really one-shot thunks. Only needed if the demand analyser</span>
<a name="line-373"></a>        <span class='hs-comment'>-- has run at all. See Note [Final Demand Analyser run] in GHC.Core.Opt.DmdAnal</span>
<a name="line-374"></a>        <span class='hs-comment'>-- It is EXTREMELY IMPORTANT to run this pass, otherwise execution</span>
<a name="line-375"></a>        <span class='hs-comment'>-- can become /exponentially/ more expensive. See #11731, #12996.</span>
<a name="line-376"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-layout'>(</span><span class='hs-varid'>strictness</span> <span class='hs-varop'>||</span> <span class='hs-varid'>late_dmd_anal</span><span class='hs-layout'>)</span> <span class='hs-conid'>CoreDoDemand</span><span class='hs-layout'>,</span>
<a name="line-377"></a>
<a name="line-378"></a>        <span class='hs-varid'>maybe_rule_check</span> <span class='hs-conid'>FinalPhase</span><span class='hs-layout'>,</span>
<a name="line-379"></a>
<a name="line-380"></a>        <span class='hs-varid'>add_caller_ccs</span>
<a name="line-381"></a>     <span class='hs-keyglyph'>]</span>
<a name="line-382"></a>
<a name="line-383"></a>    <span class='hs-comment'>-- Remove 'CoreDoNothing' and flatten 'CoreDoPasses' for clarity.</span>
<a name="line-384"></a>    <span class='hs-varid'>flatten_todos</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-385"></a>    <span class='hs-varid'>flatten_todos</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoNothing</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flatten_todos</span> <span class='hs-varid'>rest</span>
<a name="line-386"></a>    <span class='hs-varid'>flatten_todos</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoPasses</span> <span class='hs-varid'>passes</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-387"></a>      <span class='hs-varid'>flatten_todos</span> <span class='hs-varid'>passes</span> <span class='hs-varop'>++</span> <span class='hs-varid'>flatten_todos</span> <span class='hs-varid'>rest</span>
<a name="line-388"></a>    <span class='hs-varid'>flatten_todos</span> <span class='hs-layout'>(</span><span class='hs-varid'>todo</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>todo</span> <span class='hs-conop'>:</span> <span class='hs-varid'>flatten_todos</span> <span class='hs-varid'>rest</span>
<a name="line-389"></a>
<a name="line-390"></a><span class='hs-comment'>{- Note [Inline in InitialPhase]
<a name="line-391"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-392"></a>In GHC 8 and earlier we did not inline anything in the InitialPhase. But that is
<a name="line-393"></a>confusing for users because when they say INLINE they expect the function to inline
<a name="line-394"></a>right away.
<a name="line-395"></a>
<a name="line-396"></a>So now we do inlining immediately, even in the InitialPhase, assuming that the
<a name="line-397"></a>Id's Activation allows it.
<a name="line-398"></a>
<a name="line-399"></a>This is a surprisingly big deal. Compiler performance improved a lot
<a name="line-400"></a>when I made this change:
<a name="line-401"></a>
<a name="line-402"></a>   perf/compiler/T5837.run            T5837 [stat too good] (normal)
<a name="line-403"></a>   perf/compiler/parsing001.run       parsing001 [stat too good] (normal)
<a name="line-404"></a>   perf/compiler/T12234.run           T12234 [stat too good] (optasm)
<a name="line-405"></a>   perf/compiler/T9020.run            T9020 [stat too good] (optasm)
<a name="line-406"></a>   perf/compiler/T3064.run            T3064 [stat too good] (normal)
<a name="line-407"></a>   perf/compiler/T9961.run            T9961 [stat too good] (normal)
<a name="line-408"></a>   perf/compiler/T13056.run           T13056 [stat too good] (optasm)
<a name="line-409"></a>   perf/compiler/T9872d.run           T9872d [stat too good] (normal)
<a name="line-410"></a>   perf/compiler/T783.run             T783 [stat too good] (normal)
<a name="line-411"></a>   perf/compiler/T12227.run           T12227 [stat too good] (normal)
<a name="line-412"></a>   perf/should_run/lazy-bs-alloc.run  lazy-bs-alloc [stat too good] (normal)
<a name="line-413"></a>   perf/compiler/T1969.run            T1969 [stat too good] (normal)
<a name="line-414"></a>   perf/compiler/T9872a.run           T9872a [stat too good] (normal)
<a name="line-415"></a>   perf/compiler/T9872c.run           T9872c [stat too good] (normal)
<a name="line-416"></a>   perf/compiler/T9872b.run           T9872b [stat too good] (normal)
<a name="line-417"></a>   perf/compiler/T9872d.run           T9872d [stat too good] (normal)
<a name="line-418"></a>
<a name="line-419"></a>Note [RULEs enabled in InitialPhase]
<a name="line-420"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-421"></a>RULES are enabled when doing "gentle" simplification in InitialPhase,
<a name="line-422"></a>or with -O0.  Two reasons:
<a name="line-423"></a>
<a name="line-424"></a>  * We really want the class-op cancellation to happen:
<a name="line-425"></a>        op (df d1 d2) --&gt; $cop3 d1 d2
<a name="line-426"></a>    because this breaks the mutual recursion between 'op' and 'df'
<a name="line-427"></a>
<a name="line-428"></a>  * I wanted the RULE
<a name="line-429"></a>        lift String ===&gt; ...
<a name="line-430"></a>    to work in Template Haskell when simplifying
<a name="line-431"></a>    splices, so we get simpler code for literal strings
<a name="line-432"></a>
<a name="line-433"></a>But watch out: list fusion can prevent floating.  So use phase control
<a name="line-434"></a>to switch off those rules until after floating.
<a name="line-435"></a>
<a name="line-436"></a>Note [Simplify after SpecConstr]
<a name="line-437"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-438"></a>We want to run the simplifier after SpecConstr, and before late-Specialise,
<a name="line-439"></a>for two reasons, both shown up in test perf/compiler/T16473,
<a name="line-440"></a>with -O2 -flate-specialise
<a name="line-441"></a>
<a name="line-442"></a>1.  I found that running late-Specialise after SpecConstr, with no
<a name="line-443"></a>    simplification in between meant that the carefullly constructed
<a name="line-444"></a>    SpecConstr rule never got to fire.  (It was something like
<a name="line-445"></a>          lvl = f a   -- Arity 1
<a name="line-446"></a>          ....g lvl....
<a name="line-447"></a>    SpecConstr specialised g for argument lvl; but Specialise then
<a name="line-448"></a>    specialised lvl = f a to lvl = $sf, and inlined. Or something like
<a name="line-449"></a>    that.)
<a name="line-450"></a>
<a name="line-451"></a>2.  Specialise relies on unfoldings being available for top-level dictionary
<a name="line-452"></a>    bindings; but SpecConstr kills them all!  The Simplifer restores them.
<a name="line-453"></a>
<a name="line-454"></a>This extra run of the simplifier has a cost, but this is only with -O2.
<a name="line-455"></a>
<a name="line-456"></a>
<a name="line-457"></a>************************************************************************
<a name="line-458"></a>*                                                                      *
<a name="line-459"></a>                  The CoreToDo interpreter
<a name="line-460"></a>*                                                                      *
<a name="line-461"></a>************************************************************************
<a name="line-462"></a>-}</span>
<a name="line-463"></a>
<a name="line-464"></a><a name="runCorePasses"></a><span class='hs-definition'>runCorePasses</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreToDo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-465"></a><span class='hs-definition'>runCorePasses</span> <span class='hs-varid'>passes</span> <span class='hs-varid'>guts</span>
<a name="line-466"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldM</span> <span class='hs-varid'>do_pass</span> <span class='hs-varid'>guts</span> <span class='hs-varid'>passes</span>
<a name="line-467"></a>  <span class='hs-keyword'>where</span>
<a name="line-468"></a>    <span class='hs-varid'>do_pass</span> <span class='hs-varid'>guts</span> <span class='hs-conid'>CoreDoNothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>guts</span>
<a name="line-469"></a>    <span class='hs-varid'>do_pass</span> <span class='hs-varid'>guts</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoPasses</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runCorePasses</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>guts</span>
<a name="line-470"></a>    <span class='hs-varid'>do_pass</span> <span class='hs-varid'>guts</span> <span class='hs-varid'>pass</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-471"></a>      <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-472"></a>      <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLogger</span>
<a name="line-473"></a>      <span class='hs-varid'>withTiming</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pass</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-474"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-475"></a>            <span class='hs-varid'>guts'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintAnnots</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pass</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>doCorePass</span> <span class='hs-varid'>pass</span><span class='hs-layout'>)</span> <span class='hs-varid'>guts</span>
<a name="line-476"></a>            <span class='hs-varid'>endPass</span> <span class='hs-varid'>pass</span> <span class='hs-layout'>(</span><span class='hs-varid'>mg_binds</span> <span class='hs-varid'>guts'</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mg_rules</span> <span class='hs-varid'>guts'</span><span class='hs-layout'>)</span>
<a name="line-477"></a>            <span class='hs-varid'>return</span> <span class='hs-varid'>guts'</span>
<a name="line-478"></a>
<a name="line-479"></a>    <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mg_module</span> <span class='hs-varid'>guts</span>
<a name="line-480"></a>
<a name="line-481"></a><a name="doCorePass"></a><span class='hs-definition'>doCorePass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreToDo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-482"></a><span class='hs-definition'>doCorePass</span> <span class='hs-varid'>pass</span> <span class='hs-varid'>guts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-483"></a>  <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLogger</span>
<a name="line-484"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>pass</span> <span class='hs-keyword'>of</span>
<a name="line-485"></a>    <span class='hs-conid'>CoreDoSimplify</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>{-# SCC "Simplify" #-}</span>
<a name="line-486"></a>                                 <span class='hs-varid'>simplifyPgm</span> <span class='hs-varid'>pass</span> <span class='hs-varid'>guts</span>
<a name="line-487"></a>
<a name="line-488"></a>    <span class='hs-conid'>CoreCSE</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>{-# SCC "CommonSubExpr" #-}</span>
<a name="line-489"></a>                                 <span class='hs-varid'>doPass</span> <span class='hs-varid'>cseProgram</span> <span class='hs-varid'>guts</span>
<a name="line-490"></a>
<a name="line-491"></a>    <span class='hs-conid'>CoreLiberateCase</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>{-# SCC "LiberateCase" #-}</span>
<a name="line-492"></a>                                 <span class='hs-varid'>doPassD</span> <span class='hs-varid'>liberateCase</span> <span class='hs-varid'>guts</span>
<a name="line-493"></a>
<a name="line-494"></a>    <span class='hs-conid'>CoreDoFloatInwards</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>{-# SCC "FloatInwards" #-}</span>
<a name="line-495"></a>                                 <span class='hs-varid'>floatInwards</span> <span class='hs-varid'>guts</span>
<a name="line-496"></a>
<a name="line-497"></a>    <span class='hs-conid'>CoreDoFloatOutwards</span> <span class='hs-varid'>f</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>{-# SCC "FloatOutwards" #-}</span>
<a name="line-498"></a>                                 <span class='hs-varid'>doPassDUM</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatOutwards</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-varid'>guts</span>
<a name="line-499"></a>
<a name="line-500"></a>    <span class='hs-conid'>CoreDoStaticArgs</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>{-# SCC "StaticArgs" #-}</span>
<a name="line-501"></a>                                 <span class='hs-varid'>doPassU</span> <span class='hs-varid'>doStaticArgs</span> <span class='hs-varid'>guts</span>
<a name="line-502"></a>
<a name="line-503"></a>    <span class='hs-conid'>CoreDoCallArity</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>{-# SCC "CallArity" #-}</span>
<a name="line-504"></a>                                 <span class='hs-varid'>doPassD</span> <span class='hs-varid'>callArityAnalProgram</span> <span class='hs-varid'>guts</span>
<a name="line-505"></a>
<a name="line-506"></a>    <span class='hs-conid'>CoreDoExitify</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>{-# SCC "Exitify" #-}</span>
<a name="line-507"></a>                                 <span class='hs-varid'>doPass</span> <span class='hs-varid'>exitifyProgram</span> <span class='hs-varid'>guts</span>
<a name="line-508"></a>
<a name="line-509"></a>    <span class='hs-conid'>CoreDoDemand</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>{-# SCC "DmdAnal" #-}</span>
<a name="line-510"></a>                                 <span class='hs-varid'>doPassDFRM</span> <span class='hs-layout'>(</span><span class='hs-varid'>dmdAnal</span> <span class='hs-varid'>logger</span><span class='hs-layout'>)</span> <span class='hs-varid'>guts</span>
<a name="line-511"></a>
<a name="line-512"></a>    <span class='hs-conid'>CoreDoCpr</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>{-# SCC "CprAnal" #-}</span>
<a name="line-513"></a>                                 <span class='hs-varid'>doPassDFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>cprAnalProgram</span> <span class='hs-varid'>logger</span><span class='hs-layout'>)</span> <span class='hs-varid'>guts</span>
<a name="line-514"></a>
<a name="line-515"></a>    <span class='hs-conid'>CoreDoWorkerWrapper</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>{-# SCC "WorkWrap" #-}</span>
<a name="line-516"></a>                                 <span class='hs-varid'>doPassDFU</span> <span class='hs-varid'>wwTopBinds</span> <span class='hs-varid'>guts</span>
<a name="line-517"></a>
<a name="line-518"></a>    <span class='hs-conid'>CoreDoSpecialising</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>{-# SCC "Specialise" #-}</span>
<a name="line-519"></a>                                 <span class='hs-varid'>specProgram</span> <span class='hs-varid'>guts</span>
<a name="line-520"></a>
<a name="line-521"></a>    <span class='hs-conid'>CoreDoSpecConstr</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>{-# SCC "SpecConstr" #-}</span>
<a name="line-522"></a>                                 <span class='hs-varid'>specConstrProgram</span> <span class='hs-varid'>guts</span>
<a name="line-523"></a>
<a name="line-524"></a>    <span class='hs-conid'>CoreAddCallerCcs</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>{-# SCC "AddCallerCcs" #-}</span>
<a name="line-525"></a>                                 <span class='hs-varid'>addCallerCostCentres</span> <span class='hs-varid'>guts</span>
<a name="line-526"></a>
<a name="line-527"></a>    <span class='hs-conid'>CoreDoPrintCore</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>observe</span> <span class='hs-layout'>(</span><span class='hs-varid'>printCore</span> <span class='hs-varid'>logger</span><span class='hs-layout'>)</span> <span class='hs-varid'>guts</span>
<a name="line-528"></a>
<a name="line-529"></a>    <span class='hs-conid'>CoreDoRuleCheck</span> <span class='hs-varid'>phase</span> <span class='hs-varid'>pat</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ruleCheckPass</span> <span class='hs-varid'>phase</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>guts</span>
<a name="line-530"></a>    <span class='hs-conid'>CoreDoNothing</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>guts</span>
<a name="line-531"></a>    <span class='hs-conid'>CoreDoPasses</span> <span class='hs-varid'>passes</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>runCorePasses</span> <span class='hs-varid'>passes</span> <span class='hs-varid'>guts</span>
<a name="line-532"></a>
<a name="line-533"></a>    <span class='hs-conid'>CoreDoPluginPass</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>p</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>{-# SCC "Plugin" #-}</span> <span class='hs-varid'>p</span> <span class='hs-varid'>guts</span>
<a name="line-534"></a>
<a name="line-535"></a>    <span class='hs-conid'>CoreDesugar</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"doCorePass"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pass</span><span class='hs-layout'>)</span>
<a name="line-536"></a>    <span class='hs-conid'>CoreDesugarOpt</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"doCorePass"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pass</span><span class='hs-layout'>)</span>
<a name="line-537"></a>    <span class='hs-conid'>CoreTidy</span>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"doCorePass"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pass</span><span class='hs-layout'>)</span>
<a name="line-538"></a>    <span class='hs-conid'>CorePrep</span>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"doCorePass"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pass</span><span class='hs-layout'>)</span>
<a name="line-539"></a>    <span class='hs-conid'>CoreOccurAnal</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"doCorePass"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pass</span><span class='hs-layout'>)</span>
<a name="line-540"></a>
<a name="line-541"></a><span class='hs-comment'>{-
<a name="line-542"></a>************************************************************************
<a name="line-543"></a>*                                                                      *
<a name="line-544"></a>\subsection{Core pass combinators}
<a name="line-545"></a>*                                                                      *
<a name="line-546"></a>************************************************************************
<a name="line-547"></a>-}</span>
<a name="line-548"></a>
<a name="line-549"></a><a name="printCore"></a><span class='hs-definition'>printCore</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Logger</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-550"></a><span class='hs-definition'>printCore</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>binds</span>
<a name="line-551"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Logger.dumpIfSet</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>True</span> <span class='hs-str'>"Print Core"</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprCoreBindings</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-552"></a>
<a name="line-553"></a><a name="ruleCheckPass"></a><span class='hs-definition'>ruleCheckPass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CompilerPhase</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-554"></a><span class='hs-definition'>ruleCheckPass</span> <span class='hs-varid'>current_phase</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>guts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-555"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-556"></a>    <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLogger</span>
<a name="line-557"></a>    <span class='hs-varid'>withTiming</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"RuleCheck"</span><span class='hs-varop'>&lt;+&gt;</span><span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mg_module</span> <span class='hs-varid'>guts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-558"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-559"></a>        <span class='hs-varid'>rb</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getRuleBase</span>
<a name="line-560"></a>        <span class='hs-varid'>vis_orphs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getVisibleOrphanMods</span>
<a name="line-561"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>rule_fn</span> <span class='hs-varid'>fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getRules</span> <span class='hs-layout'>(</span><span class='hs-conid'>RuleEnv</span> <span class='hs-varid'>rb</span> <span class='hs-varid'>vis_orphs</span><span class='hs-layout'>)</span> <span class='hs-varid'>fn</span>
<a name="line-562"></a>                          <span class='hs-varop'>++</span> <span class='hs-layout'>(</span><span class='hs-varid'>mg_rules</span> <span class='hs-varid'>guts</span><span class='hs-layout'>)</span>
<a name="line-563"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>ropts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initRuleOpts</span> <span class='hs-varid'>dflags</span>
<a name="line-564"></a>        <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>putLogMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>NoReason</span> <span class='hs-conid'>Err.SevDump</span> <span class='hs-varid'>noSrcSpan</span>
<a name="line-565"></a>                     <span class='hs-varop'>$</span> <span class='hs-varid'>withPprStyle</span> <span class='hs-varid'>defaultDumpStyle</span>
<a name="line-566"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>ruleCheckProgram</span> <span class='hs-varid'>ropts</span> <span class='hs-varid'>current_phase</span> <span class='hs-varid'>pat</span>
<a name="line-567"></a>                        <span class='hs-varid'>rule_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>mg_binds</span> <span class='hs-varid'>guts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-568"></a>        <span class='hs-varid'>return</span> <span class='hs-varid'>guts</span>
<a name="line-569"></a>
<a name="line-570"></a><a name="doPassDUM"></a><span class='hs-definition'>doPassDUM</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CoreProgram</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-571"></a><span class='hs-definition'>doPassDUM</span> <span class='hs-varid'>do_pass</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>doPassM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>binds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-572"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-573"></a>    <span class='hs-varid'>us</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getUniqueSupplyM</span>
<a name="line-574"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>do_pass</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>us</span> <span class='hs-varid'>binds</span>
<a name="line-575"></a>
<a name="line-576"></a><a name="doPassDM"></a><span class='hs-definition'>doPassDM</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CoreProgram</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-577"></a><span class='hs-definition'>doPassDM</span> <span class='hs-varid'>do_pass</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>doPassDUM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>const</span> <span class='hs-layout'>(</span><span class='hs-varid'>do_pass</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-578"></a>
<a name="line-579"></a><a name="doPassD"></a><span class='hs-definition'>doPassD</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-580"></a><span class='hs-definition'>doPassD</span> <span class='hs-varid'>do_pass</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>doPassDM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>do_pass</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-581"></a>
<a name="line-582"></a><a name="doPassDU"></a><span class='hs-definition'>doPassDU</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-583"></a><span class='hs-definition'>doPassDU</span> <span class='hs-varid'>do_pass</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>doPassDUM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>dflags</span> <span class='hs-varid'>us</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>do_pass</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span>
<a name="line-584"></a>
<a name="line-585"></a><a name="doPassU"></a><span class='hs-definition'>doPassU</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-586"></a><span class='hs-definition'>doPassU</span> <span class='hs-varid'>do_pass</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>doPassDU</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>do_pass</span><span class='hs-layout'>)</span>
<a name="line-587"></a>
<a name="line-588"></a><a name="doPassDFM"></a><span class='hs-definition'>doPassDFM</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInstEnvs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CoreProgram</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-589"></a><span class='hs-definition'>doPassDFM</span> <span class='hs-varid'>do_pass</span> <span class='hs-varid'>guts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-590"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-591"></a>    <span class='hs-varid'>p_fam_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPackageFamInstEnv</span>
<a name="line-592"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>fam_envs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>p_fam_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_fam_inst_env</span> <span class='hs-varid'>guts</span><span class='hs-layout'>)</span>
<a name="line-593"></a>    <span class='hs-varid'>doPassM</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftIO</span> <span class='hs-varop'>.</span> <span class='hs-varid'>do_pass</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>fam_envs</span><span class='hs-layout'>)</span> <span class='hs-varid'>guts</span>
<a name="line-594"></a>
<a name="line-595"></a><a name="doPassDFRM"></a><span class='hs-definition'>doPassDFRM</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInstEnvs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreRule</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CoreProgram</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-596"></a><span class='hs-definition'>doPassDFRM</span> <span class='hs-varid'>do_pass</span> <span class='hs-varid'>guts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-597"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-598"></a>    <span class='hs-varid'>p_fam_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPackageFamInstEnv</span>
<a name="line-599"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>fam_envs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>p_fam_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_fam_inst_env</span> <span class='hs-varid'>guts</span><span class='hs-layout'>)</span>
<a name="line-600"></a>    <span class='hs-varid'>doPassM</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftIO</span> <span class='hs-varop'>.</span> <span class='hs-varid'>do_pass</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>fam_envs</span> <span class='hs-layout'>(</span><span class='hs-varid'>mg_rules</span> <span class='hs-varid'>guts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>guts</span>
<a name="line-601"></a>
<a name="line-602"></a><a name="doPassDFU"></a><span class='hs-definition'>doPassDFU</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInstEnvs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-603"></a><span class='hs-definition'>doPassDFU</span> <span class='hs-varid'>do_pass</span> <span class='hs-varid'>guts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-604"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-605"></a>    <span class='hs-varid'>us</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getUniqueSupplyM</span>
<a name="line-606"></a>    <span class='hs-varid'>p_fam_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPackageFamInstEnv</span>
<a name="line-607"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>fam_envs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>p_fam_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_fam_inst_env</span> <span class='hs-varid'>guts</span><span class='hs-layout'>)</span>
<a name="line-608"></a>    <span class='hs-varid'>doPass</span> <span class='hs-layout'>(</span><span class='hs-varid'>do_pass</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>fam_envs</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span> <span class='hs-varid'>guts</span>
<a name="line-609"></a>
<a name="line-610"></a><a name="doPassM"></a><span class='hs-comment'>-- Most passes return no stats and don't change rules: these combinators</span>
<a name="line-611"></a><span class='hs-comment'>-- let us lift them to the full blown ModGuts+CoreM world</span>
<a name="line-612"></a><span class='hs-definition'>doPassM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>CoreProgram</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>ModGuts</span>
<a name="line-613"></a><span class='hs-definition'>doPassM</span> <span class='hs-varid'>bind_f</span> <span class='hs-varid'>guts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-614"></a>    <span class='hs-varid'>binds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bind_f</span> <span class='hs-layout'>(</span><span class='hs-varid'>mg_binds</span> <span class='hs-varid'>guts</span><span class='hs-layout'>)</span>
<a name="line-615"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>guts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-616"></a>
<a name="line-617"></a><a name="doPass"></a><span class='hs-definition'>doPass</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-618"></a><span class='hs-definition'>doPass</span> <span class='hs-varid'>bind_f</span> <span class='hs-varid'>guts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>guts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bind_f</span> <span class='hs-layout'>(</span><span class='hs-varid'>mg_binds</span> <span class='hs-varid'>guts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-619"></a>
<a name="line-620"></a><a name="observe"></a><span class='hs-comment'>-- Observer passes just peek; don't modify the bindings at all</span>
<a name="line-621"></a><span class='hs-definition'>observe</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-622"></a><span class='hs-definition'>observe</span> <span class='hs-varid'>do_pass</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>doPassM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>binds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-623"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-624"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>do_pass</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>binds</span>
<a name="line-625"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>binds</span>
<a name="line-626"></a>
<a name="line-627"></a><span class='hs-comment'>{-
<a name="line-628"></a>************************************************************************
<a name="line-629"></a>*                                                                      *
<a name="line-630"></a>        Gentle simplification
<a name="line-631"></a>*                                                                      *
<a name="line-632"></a>************************************************************************
<a name="line-633"></a>-}</span>
<a name="line-634"></a>
<a name="line-635"></a><a name="simplifyExpr"></a><span class='hs-definition'>simplifyExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-comment'>-- includes spec of what core-to-core passes to do</span>
<a name="line-636"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-637"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-638"></a><span class='hs-comment'>-- simplifyExpr is called by the driver to simplify an</span>
<a name="line-639"></a><span class='hs-comment'>-- expression typed in at the interactive prompt</span>
<a name="line-640"></a><span class='hs-definition'>simplifyExpr</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>expr</span>
<a name="line-641"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withTiming</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Simplify [expr]"</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-642"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>eps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hscEPS</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>;</span>
<a name="line-643"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rule_env</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRuleEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_rule_base</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span>
<a name="line-644"></a>              <span class='hs-varid'>fi_env</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-varid'>eps_fam_inst_env</span> <span class='hs-varid'>eps</span>
<a name="line-645"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>extendFamInstEnvList</span> <span class='hs-varid'>emptyFamInstEnv</span> <span class='hs-varop'>$</span>
<a name="line-646"></a>                            <span class='hs-varid'>snd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ic_instances</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>)</span>
<a name="line-647"></a>              <span class='hs-varid'>simpl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simplEnvForGHCi</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span>
<a name="line-648"></a>
<a name="line-649"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>sz</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprSize</span> <span class='hs-varid'>expr</span>
<a name="line-650"></a>
<a name="line-651"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>counts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initSmpl</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>rule_env</span> <span class='hs-varid'>fi_env</span> <span class='hs-varid'>sz</span> <span class='hs-varop'>$</span>
<a name="line-652"></a>                             <span class='hs-varid'>simplExprGently</span> <span class='hs-varid'>simpl_env</span> <span class='hs-varid'>expr</span>
<a name="line-653"></a>
<a name="line-654"></a>        <span class='hs-layout'>;</span> <span class='hs-conid'>Logger.dumpIfSet</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_simpl_stats</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-655"></a>                  <span class='hs-str'>"Simplifier statistics"</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprSimplCount</span> <span class='hs-varid'>counts</span><span class='hs-layout'>)</span>
<a name="line-656"></a>
<a name="line-657"></a>        <span class='hs-layout'>;</span> <span class='hs-conid'>Logger.dumpIfSet_dyn</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_simpl</span> <span class='hs-str'>"Simplified expression"</span>
<a name="line-658"></a>                        <span class='hs-conid'>FormatCore</span>
<a name="line-659"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>pprCoreExpr</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span>
<a name="line-660"></a>
<a name="line-661"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>expr'</span>
<a name="line-662"></a>        <span class='hs-layout'>}</span>
<a name="line-663"></a>  <span class='hs-keyword'>where</span>
<a name="line-664"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-665"></a>    <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_logger</span> <span class='hs-varid'>hsc_env</span>
<a name="line-666"></a>
<a name="line-667"></a><a name="simplExprGently"></a><span class='hs-definition'>simplExprGently</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SimplEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SimplM</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-668"></a><span class='hs-comment'>-- Simplifies an expression</span>
<a name="line-669"></a><span class='hs-comment'>--      does occurrence analysis, then simplification</span>
<a name="line-670"></a><span class='hs-comment'>--      and repeats (twice currently) because one pass</span>
<a name="line-671"></a><span class='hs-comment'>--      alone leaves tons of crud.</span>
<a name="line-672"></a><span class='hs-comment'>-- Used (a) for user expressions typed in at the interactive prompt</span>
<a name="line-673"></a><span class='hs-comment'>--      (b) the LHS and RHS of a RULE</span>
<a name="line-674"></a><span class='hs-comment'>--      (c) Template Haskell splices</span>
<a name="line-675"></a><span class='hs-comment'>--</span>
<a name="line-676"></a><span class='hs-comment'>-- The name 'Gently' suggests that the SimplMode is InitialPhase,</span>
<a name="line-677"></a><span class='hs-comment'>-- and in fact that is so.... but the 'Gently' in simplExprGently doesn't</span>
<a name="line-678"></a><span class='hs-comment'>-- enforce that; it just simplifies the expression twice</span>
<a name="line-679"></a>
<a name="line-680"></a><span class='hs-comment'>-- It's important that simplExprGently does eta reduction; see</span>
<a name="line-681"></a><span class='hs-comment'>-- Note [Simplifying the left-hand side of a RULE] above.  The</span>
<a name="line-682"></a><span class='hs-comment'>-- simplifier does indeed do eta reduction (it's in GHC.Core.Opt.Simplify.completeLam)</span>
<a name="line-683"></a><span class='hs-comment'>-- but only if -O is on.</span>
<a name="line-684"></a>
<a name="line-685"></a><span class='hs-definition'>simplExprGently</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-686"></a>    <span class='hs-varid'>expr1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>occurAnalyseExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-687"></a>    <span class='hs-varid'>simplExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>occurAnalyseExpr</span> <span class='hs-varid'>expr1</span><span class='hs-layout'>)</span>
<a name="line-688"></a>
<a name="line-689"></a><span class='hs-comment'>{-
<a name="line-690"></a>************************************************************************
<a name="line-691"></a>*                                                                      *
<a name="line-692"></a>\subsection{The driver for the simplifier}
<a name="line-693"></a>*                                                                      *
<a name="line-694"></a>************************************************************************
<a name="line-695"></a>-}</span>
<a name="line-696"></a>
<a name="line-697"></a><a name="simplifyPgm"></a><span class='hs-definition'>simplifyPgm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreToDo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-698"></a><span class='hs-definition'>simplifyPgm</span> <span class='hs-varid'>pass</span> <span class='hs-varid'>guts</span>
<a name="line-699"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-700"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rb</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getRuleBase</span>
<a name="line-701"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>liftIOWithCount</span> <span class='hs-varop'>$</span>
<a name="line-702"></a>         <span class='hs-varid'>simplifyPgmIO</span> <span class='hs-varid'>pass</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>rb</span> <span class='hs-varid'>guts</span> <span class='hs-layout'>}</span>
<a name="line-703"></a>
<a name="line-704"></a><a name="simplifyPgmIO"></a><span class='hs-definition'>simplifyPgmIO</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreToDo</span>
<a name="line-705"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscEnv</span>
<a name="line-706"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RuleBase</span>
<a name="line-707"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span>
<a name="line-708"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>SimplCount</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModGuts</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- New bindings</span>
<a name="line-709"></a>
<a name="line-710"></a><span class='hs-definition'>simplifyPgmIO</span> <span class='hs-varid'>pass</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoreDoSimplify</span> <span class='hs-varid'>max_iterations</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span>
<a name="line-711"></a>              <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>hpt_rule_base</span>
<a name="line-712"></a>              <span class='hs-varid'>guts</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ModGuts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_module</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>this_mod</span>
<a name="line-713"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>mg_rdr_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rdr_env</span>
<a name="line-714"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>mg_deps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deps</span>
<a name="line-715"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>mg_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_rules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rules</span>
<a name="line-716"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>mg_fam_inst_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam_inst_env</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-717"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>termination_msg</span><span class='hs-layout'>,</span> <span class='hs-varid'>it_count</span><span class='hs-layout'>,</span> <span class='hs-varid'>counts_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>guts'</span><span class='hs-layout'>)</span>
<a name="line-718"></a>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>do_iteration</span> <span class='hs-num'>1</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>rules</span>
<a name="line-719"></a>
<a name="line-720"></a>        <span class='hs-layout'>;</span> <span class='hs-conid'>Logger.dumpIfSet</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_verbose_core2core</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-721"></a>                                <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_simpl_stats</span>  <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-722"></a>                  <span class='hs-str'>"Simplifier statistics for following pass"</span>
<a name="line-723"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-varid'>termination_msg</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"after"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>it_count</span>
<a name="line-724"></a>                                              <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"iterations"</span><span class='hs-layout'>,</span>
<a name="line-725"></a>                         <span class='hs-varid'>blankLine</span><span class='hs-layout'>,</span>
<a name="line-726"></a>                         <span class='hs-varid'>pprSimplCount</span> <span class='hs-varid'>counts_out</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-727"></a>
<a name="line-728"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>counts_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>guts'</span><span class='hs-layout'>)</span>
<a name="line-729"></a>    <span class='hs-layout'>}</span>
<a name="line-730"></a>  <span class='hs-keyword'>where</span>
<a name="line-731"></a>    <span class='hs-varid'>dflags</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-732"></a>    <span class='hs-varid'>logger</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_logger</span> <span class='hs-varid'>hsc_env</span>
<a name="line-733"></a>    <span class='hs-varid'>print_unqual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPrintUnqualified</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_unit_env</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>rdr_env</span>
<a name="line-734"></a>    <span class='hs-varid'>simpl_env</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSimplEnv</span> <span class='hs-varid'>mode</span>
<a name="line-735"></a>    <span class='hs-varid'>active_rule</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>activeRule</span> <span class='hs-varid'>mode</span>
<a name="line-736"></a>    <span class='hs-varid'>active_unf</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>activeUnfolding</span> <span class='hs-varid'>mode</span>
<a name="line-737"></a>
<a name="line-738"></a>    <span class='hs-varid'>do_iteration</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-varop'>--UniqSupply</span>
<a name="line-739"></a>                <span class='hs-comment'>--  -&gt; Int          -- Counts iterations</span>
<a name="line-740"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SimplCount</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- Counts from earlier iterations, reversed</span>
<a name="line-741"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span>  <span class='hs-comment'>-- Bindings in</span>
<a name="line-742"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreRule</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- and orphan rules</span>
<a name="line-743"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>SimplCount</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModGuts</span><span class='hs-layout'>)</span>
<a name="line-744"></a>
<a name="line-745"></a>    <span class='hs-varid'>do_iteration</span> <span class='hs-varid'>iteration_no</span> <span class='hs-varid'>counts_so_far</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>rules</span>
<a name="line-746"></a>        <span class='hs-comment'>-- iteration_no is the number of the iteration we are</span>
<a name="line-747"></a>        <span class='hs-comment'>-- about to begin, with '1' for the first</span>
<a name="line-748"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>iteration_no</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>max_iterations</span>   <span class='hs-comment'>-- Stop if we've run out of iterations</span>
<a name="line-749"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>max_iterations</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-750"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Simplifier bailing out after"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>max_iterations</span>
<a name="line-751"></a>                    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"iterations"</span>
<a name="line-752"></a>                    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>brackets</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hsep</span> <span class='hs-varop'>$</span> <span class='hs-varid'>punctuate</span> <span class='hs-varid'>comma</span> <span class='hs-varop'>$</span>
<a name="line-753"></a>                         <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>int</span> <span class='hs-varop'>.</span> <span class='hs-varid'>simplCountN</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>counts_so_far</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-754"></a>                 <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Size ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>coreBindsStats</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-755"></a>
<a name="line-756"></a>                <span class='hs-comment'>-- Subtract 1 from iteration_no to get the</span>
<a name="line-757"></a>                <span class='hs-comment'>-- number of iterations we actually completed</span>
<a name="line-758"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-str'>"Simplifier baled out"</span><span class='hs-layout'>,</span> <span class='hs-varid'>iteration_no</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span>
<a name="line-759"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>totalise</span> <span class='hs-varid'>counts_so_far</span>
<a name="line-760"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>guts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_rules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rules</span> <span class='hs-layout'>}</span> <span class='hs-layout'>)</span>
<a name="line-761"></a>
<a name="line-762"></a>      <span class='hs-comment'>-- Try and force thunks off the binds; significantly reduces</span>
<a name="line-763"></a>      <span class='hs-comment'>-- space usage, especially with -O.  JRS, 000620.</span>
<a name="line-764"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>sz</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreBindsSize</span> <span class='hs-varid'>binds</span>
<a name="line-765"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sz</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>()</span>     <span class='hs-comment'>-- Force it</span>
<a name="line-766"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-767"></a>                <span class='hs-comment'>-- Occurrence analysis</span>
<a name="line-768"></a>           <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tagged_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "OccAnal" #-}</span>
<a name="line-769"></a>                     <span class='hs-varid'>occurAnalysePgm</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>active_unf</span> <span class='hs-varid'>active_rule</span> <span class='hs-varid'>rules</span>
<a name="line-770"></a>                                     <span class='hs-varid'>binds</span>
<a name="line-771"></a>               <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-772"></a>           <span class='hs-conid'>Logger.dumpIfSet_dyn</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_occur_anal</span> <span class='hs-str'>"Occurrence analysis"</span>
<a name="line-773"></a>                     <span class='hs-conid'>FormatCore</span>
<a name="line-774"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>pprCoreBindings</span> <span class='hs-varid'>tagged_binds</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span>
<a name="line-775"></a>
<a name="line-776"></a>                <span class='hs-comment'>-- Get any new rules, and extend the rule base</span>
<a name="line-777"></a>                <span class='hs-comment'>-- See Note [Overall plumbing for rules] in GHC.Core.Rules</span>
<a name="line-778"></a>                <span class='hs-comment'>-- We need to do this regularly, because simplification can</span>
<a name="line-779"></a>                <span class='hs-comment'>-- poke on IdInfo thunks, which in turn brings in new rules</span>
<a name="line-780"></a>                <span class='hs-comment'>-- behind the scenes.  Otherwise there's a danger we'll simply</span>
<a name="line-781"></a>                <span class='hs-comment'>-- miss the rules for Ids hidden inside imported inlinings</span>
<a name="line-782"></a>           <span class='hs-varid'>eps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hscEPS</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>;</span>
<a name="line-783"></a>           <span class='hs-keyword'>let</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>rule_base1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionRuleBase</span> <span class='hs-varid'>hpt_rule_base</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_rule_base</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span>
<a name="line-784"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>rule_base2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendRuleBaseList</span> <span class='hs-varid'>rule_base1</span> <span class='hs-varid'>rules</span>
<a name="line-785"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>fam_envs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_fam_inst_env</span> <span class='hs-varid'>eps</span><span class='hs-layout'>,</span> <span class='hs-varid'>fam_inst_env</span><span class='hs-layout'>)</span>
<a name="line-786"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>vis_orphs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>this_mod</span> <span class='hs-conop'>:</span> <span class='hs-varid'>dep_orphs</span> <span class='hs-varid'>deps</span> <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-787"></a>
<a name="line-788"></a>                <span class='hs-comment'>-- Simplify the program</span>
<a name="line-789"></a>           <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>binds1</span><span class='hs-layout'>,</span> <span class='hs-varid'>rules1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>counts1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-790"></a>             <span class='hs-varid'>initSmpl</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkRuleEnv</span> <span class='hs-varid'>rule_base2</span> <span class='hs-varid'>vis_orphs</span><span class='hs-layout'>)</span> <span class='hs-varid'>fam_envs</span> <span class='hs-varid'>sz</span> <span class='hs-varop'>$</span>
<a name="line-791"></a>               <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>env1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-comment'>{-# SCC "SimplTopBinds" #-}</span>
<a name="line-792"></a>                                      <span class='hs-varid'>simplTopBinds</span> <span class='hs-varid'>simpl_env</span> <span class='hs-varid'>tagged_binds</span>
<a name="line-793"></a>
<a name="line-794"></a>                      <span class='hs-comment'>-- Apply the substitution to rules defined in this module</span>
<a name="line-795"></a>                      <span class='hs-comment'>-- for imported Ids.  Eg  RULE map my_f = blah</span>
<a name="line-796"></a>                      <span class='hs-comment'>-- If we have a substitution my_f :-&gt; other_f, we'd better</span>
<a name="line-797"></a>                      <span class='hs-comment'>-- apply it to the rule to, or it'll never match</span>
<a name="line-798"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>rules1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplRules</span> <span class='hs-varid'>env1</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>rules</span> <span class='hs-conid'>Nothing</span>
<a name="line-799"></a>
<a name="line-800"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>getTopFloatBinds</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>rules1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-801"></a>
<a name="line-802"></a>                <span class='hs-comment'>-- Stop if nothing happened; don't dump output</span>
<a name="line-803"></a>                <span class='hs-comment'>-- See Note [Which transformations are innocuous] in GHC.Core.Opt.Monad</span>
<a name="line-804"></a>           <span class='hs-keyword'>if</span> <span class='hs-varid'>isZeroSimplCount</span> <span class='hs-varid'>counts1</span> <span class='hs-keyword'>then</span>
<a name="line-805"></a>                <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-str'>"Simplifier reached fixed point"</span><span class='hs-layout'>,</span> <span class='hs-varid'>iteration_no</span>
<a name="line-806"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>totalise</span> <span class='hs-layout'>(</span><span class='hs-varid'>counts1</span> <span class='hs-conop'>:</span> <span class='hs-varid'>counts_so_far</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Include "free" ticks</span>
<a name="line-807"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>guts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds1</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_rules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rules1</span> <span class='hs-layout'>}</span> <span class='hs-layout'>)</span>
<a name="line-808"></a>           <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-809"></a>                <span class='hs-comment'>-- Short out indirections</span>
<a name="line-810"></a>                <span class='hs-comment'>-- We do this *after* at least one run of the simplifier</span>
<a name="line-811"></a>                <span class='hs-comment'>-- because indirection-shorting uses the export flag on *occurrences*</span>
<a name="line-812"></a>                <span class='hs-comment'>-- and that isn't guaranteed to be ok until after the first run propagates</span>
<a name="line-813"></a>                <span class='hs-comment'>-- stuff from the binding site to its occurrences</span>
<a name="line-814"></a>                <span class='hs-comment'>--</span>
<a name="line-815"></a>                <span class='hs-comment'>-- ToDo: alas, this means that indirection-shorting does not happen at all</span>
<a name="line-816"></a>                <span class='hs-comment'>--       if the simplifier does nothing (not common, I know, but unsavoury)</span>
<a name="line-817"></a>           <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>binds2</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "ZapInd" #-}</span> <span class='hs-varid'>shortOutIndirections</span> <span class='hs-varid'>binds1</span> <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-818"></a>
<a name="line-819"></a>                <span class='hs-comment'>-- Dump the result of this iteration</span>
<a name="line-820"></a>           <span class='hs-varid'>dump_end_iteration</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>print_unqual</span> <span class='hs-varid'>iteration_no</span> <span class='hs-varid'>counts1</span> <span class='hs-varid'>binds2</span> <span class='hs-varid'>rules1</span> <span class='hs-layout'>;</span>
<a name="line-821"></a>           <span class='hs-varid'>lintPassResult</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>pass</span> <span class='hs-varid'>binds2</span> <span class='hs-layout'>;</span>
<a name="line-822"></a>
<a name="line-823"></a>                <span class='hs-comment'>-- Loop</span>
<a name="line-824"></a>           <span class='hs-varid'>do_iteration</span> <span class='hs-layout'>(</span><span class='hs-varid'>iteration_no</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>counts1</span><span class='hs-conop'>:</span><span class='hs-varid'>counts_so_far</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds2</span> <span class='hs-varid'>rules1</span>
<a name="line-825"></a>           <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-826"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &lt;= 810</span>
<a name="line-827"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"do_iteration"</span>
<a name="line-828"></a><span class='hs-cpp'>#endif</span>
<a name="line-829"></a>      <span class='hs-keyword'>where</span>
<a name="line-830"></a>        <span class='hs-comment'>-- Remember the counts_so_far are reversed</span>
<a name="line-831"></a>        <span class='hs-varid'>totalise</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SimplCount</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SimplCount</span>
<a name="line-832"></a>        <span class='hs-varid'>totalise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>c</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>acc</span> <span class='hs-varop'>`plusSimplCount`</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-833"></a>                         <span class='hs-layout'>(</span><span class='hs-varid'>zeroSimplCount</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-834"></a>
<a name="line-835"></a><span class='hs-definition'>simplifyPgmIO</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"simplifyPgmIO"</span>
<a name="line-836"></a>
<a name="line-837"></a><a name="dump_end_iteration"></a><span class='hs-comment'>-------------------</span>
<a name="line-838"></a><span class='hs-definition'>dump_end_iteration</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Logger</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PrintUnqualified</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-839"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SimplCount</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreRule</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-840"></a><span class='hs-definition'>dump_end_iteration</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>print_unqual</span> <span class='hs-varid'>iteration_no</span> <span class='hs-varid'>counts</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>rules</span>
<a name="line-841"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dumpPassResult</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>print_unqual</span> <span class='hs-varid'>mb_flag</span> <span class='hs-varid'>hdr</span> <span class='hs-varid'>pp_counts</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>rules</span>
<a name="line-842"></a>  <span class='hs-keyword'>where</span>
<a name="line-843"></a>    <span class='hs-varid'>mb_flag</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_simpl_iterations</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Opt_D_dump_simpl_iterations</span>
<a name="line-844"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-845"></a>            <span class='hs-comment'>-- Show details if Opt_D_dump_simpl_iterations is on</span>
<a name="line-846"></a>
<a name="line-847"></a>    <span class='hs-varid'>hdr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Simplifier iteration="</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>iteration_no</span>
<a name="line-848"></a>    <span class='hs-varid'>pp_counts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"---- Simplifier counts for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>hdr</span>
<a name="line-849"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>pprSimplCount</span> <span class='hs-varid'>counts</span>
<a name="line-850"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"---- End of simplifier counts for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>hdr</span> <span class='hs-keyglyph'>]</span>
<a name="line-851"></a>
<a name="line-852"></a><span class='hs-comment'>{-
<a name="line-853"></a>************************************************************************
<a name="line-854"></a>*                                                                      *
<a name="line-855"></a>                Shorting out indirections
<a name="line-856"></a>*                                                                      *
<a name="line-857"></a>************************************************************************
<a name="line-858"></a>
<a name="line-859"></a>If we have this:
<a name="line-860"></a>
<a name="line-861"></a>        x_local = &lt;expression&gt;
<a name="line-862"></a>        ...bindings...
<a name="line-863"></a>        x_exported = x_local
<a name="line-864"></a>
<a name="line-865"></a>where x_exported is exported, and x_local is not, then we replace it with this:
<a name="line-866"></a>
<a name="line-867"></a>        x_exported = &lt;expression&gt;
<a name="line-868"></a>        x_local = x_exported
<a name="line-869"></a>        ...bindings...
<a name="line-870"></a>
<a name="line-871"></a>Without this we never get rid of the x_exported = x_local thing.  This
<a name="line-872"></a>save a gratuitous jump (from \tr{x_exported} to \tr{x_local}), and
<a name="line-873"></a>makes strictness information propagate better.  This used to happen in
<a name="line-874"></a>the final phase, but it's tidier to do it here.
<a name="line-875"></a>
<a name="line-876"></a>Note [Messing up the exported Id's RULES]
<a name="line-877"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-878"></a>We must be careful about discarding (obviously) or even merging the
<a name="line-879"></a>RULES on the exported Id. The example that went bad on me at one stage
<a name="line-880"></a>was this one:
<a name="line-881"></a>
<a name="line-882"></a>    iterate :: (a -&gt; a) -&gt; a -&gt; [a]
<a name="line-883"></a>        [Exported]
<a name="line-884"></a>    iterate = iterateList
<a name="line-885"></a>
<a name="line-886"></a>    iterateFB c f x = x `c` iterateFB c f (f x)
<a name="line-887"></a>    iterateList f x =  x : iterateList f (f x)
<a name="line-888"></a>        [Not exported]
<a name="line-889"></a>
<a name="line-890"></a>    {-# RULES
<a name="line-891"></a>    "iterate"   forall f x.     iterate f x = build (\c _n -&gt; iterateFB c f x)
<a name="line-892"></a>    "iterateFB"                 iterateFB (:) = iterateList
<a name="line-893"></a>     #-}
<a name="line-894"></a>
<a name="line-895"></a>This got shorted out to:
<a name="line-896"></a>
<a name="line-897"></a>    iterateList :: (a -&gt; a) -&gt; a -&gt; [a]
<a name="line-898"></a>    iterateList = iterate
<a name="line-899"></a>
<a name="line-900"></a>    iterateFB c f x = x `c` iterateFB c f (f x)
<a name="line-901"></a>    iterate f x =  x : iterate f (f x)
<a name="line-902"></a>
<a name="line-903"></a>    {-# RULES
<a name="line-904"></a>    "iterate"   forall f x.     iterate f x = build (\c _n -&gt; iterateFB c f x)
<a name="line-905"></a>    "iterateFB"                 iterateFB (:) = iterate
<a name="line-906"></a>     #-}
<a name="line-907"></a>
<a name="line-908"></a>And now we get an infinite loop in the rule system
<a name="line-909"></a>        iterate f x -&gt; build (\cn -&gt; iterateFB c f x)
<a name="line-910"></a>                    -&gt; iterateFB (:) f x
<a name="line-911"></a>                    -&gt; iterate f x
<a name="line-912"></a>
<a name="line-913"></a>Old "solution":
<a name="line-914"></a>        use rule switching-off pragmas to get rid
<a name="line-915"></a>        of iterateList in the first place
<a name="line-916"></a>
<a name="line-917"></a>But in principle the user *might* want rules that only apply to the Id
<a name="line-918"></a>they say.  And inline pragmas are similar
<a name="line-919"></a>   {-# NOINLINE f #-}
<a name="line-920"></a>   f = local
<a name="line-921"></a>   local = &lt;stuff&gt;
<a name="line-922"></a>Then we do not want to get rid of the NOINLINE.
<a name="line-923"></a>
<a name="line-924"></a>Hence hasShortableIdinfo.
<a name="line-925"></a>
<a name="line-926"></a>
<a name="line-927"></a>Note [Rules and indirection-zapping]
<a name="line-928"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-929"></a>Problem: what if x_exported has a RULE that mentions something in ...bindings...?
<a name="line-930"></a>Then the things mentioned can be out of scope!  Solution
<a name="line-931"></a> a) Make sure that in this pass the usage-info from x_exported is
<a name="line-932"></a>        available for ...bindings...
<a name="line-933"></a> b) If there are any such RULES, rec-ify the entire top-level.
<a name="line-934"></a>    It'll get sorted out next time round
<a name="line-935"></a>
<a name="line-936"></a>Other remarks
<a name="line-937"></a>~~~~~~~~~~~~~
<a name="line-938"></a>If more than one exported thing is equal to a local thing (i.e., the
<a name="line-939"></a>local thing really is shared), then we do one only:
<a name="line-940"></a>\begin{verbatim}
<a name="line-941"></a>        x_local = ....
<a name="line-942"></a>        x_exported1 = x_local
<a name="line-943"></a>        x_exported2 = x_local
<a name="line-944"></a>==&gt;
<a name="line-945"></a>        x_exported1 = ....
<a name="line-946"></a>
<a name="line-947"></a>        x_exported2 = x_exported1
<a name="line-948"></a>\end{verbatim}
<a name="line-949"></a>
<a name="line-950"></a>We rely on prior eta reduction to simplify things like
<a name="line-951"></a>\begin{verbatim}
<a name="line-952"></a>        x_exported = /\ tyvars -&gt; x_local tyvars
<a name="line-953"></a>==&gt;
<a name="line-954"></a>        x_exported = x_local
<a name="line-955"></a>\end{verbatim}
<a name="line-956"></a>Hence,there's a possibility of leaving unchanged something like this:
<a name="line-957"></a>\begin{verbatim}
<a name="line-958"></a>        x_local = ....
<a name="line-959"></a>        x_exported1 = x_local Int
<a name="line-960"></a>\end{verbatim}
<a name="line-961"></a>By the time we've thrown away the types in STG land this
<a name="line-962"></a>could be eliminated.  But I don't think it's very common
<a name="line-963"></a>and it's dangerous to do this fiddling in STG land
<a name="line-964"></a>because we might eliminate a binding that's mentioned in the
<a name="line-965"></a>unfolding for something.
<a name="line-966"></a>
<a name="line-967"></a>Note [Indirection zapping and ticks]
<a name="line-968"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-969"></a>Unfortunately this is another place where we need a special case for
<a name="line-970"></a>ticks. The following happens quite regularly:
<a name="line-971"></a>
<a name="line-972"></a>        x_local = &lt;expression&gt;
<a name="line-973"></a>        x_exported = tick&lt;x&gt; x_local
<a name="line-974"></a>
<a name="line-975"></a>Which we want to become:
<a name="line-976"></a>
<a name="line-977"></a>        x_exported =  tick&lt;x&gt; &lt;expression&gt;
<a name="line-978"></a>
<a name="line-979"></a>As it makes no sense to keep the tick and the expression on separate
<a name="line-980"></a>bindings. Note however that this might increase the ticks scoping
<a name="line-981"></a>over the execution of x_local, so we can only do this for floatable
<a name="line-982"></a>ticks. More often than not, other references will be unfoldings of
<a name="line-983"></a>x_exported, and therefore carry the tick anyway.
<a name="line-984"></a>-}</span>
<a name="line-985"></a>
<a name="line-986"></a><a name="IndEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IndEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IdEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreTickish</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Maps local_id -&gt; exported_id, ticks</span>
<a name="line-987"></a>
<a name="line-988"></a><a name="shortOutIndirections"></a><span class='hs-definition'>shortOutIndirections</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span>
<a name="line-989"></a><span class='hs-definition'>shortOutIndirections</span> <span class='hs-varid'>binds</span>
<a name="line-990"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>ind_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds</span>
<a name="line-991"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_need_to_flatten</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds'</span>                      <span class='hs-comment'>-- See Note [Rules and indirect-zapping]</span>
<a name="line-992"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-varid'>flattenBinds</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- for this no_need_to_flatten stuff</span>
<a name="line-993"></a>  <span class='hs-keyword'>where</span>
<a name="line-994"></a>    <span class='hs-varid'>ind_env</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>makeIndEnv</span> <span class='hs-varid'>binds</span>
<a name="line-995"></a>    <span class='hs-comment'>-- These exported Ids are the subjects  of the indirection-elimination</span>
<a name="line-996"></a>    <span class='hs-varid'>exp_ids</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nonDetEltsUFM</span> <span class='hs-varid'>ind_env</span>
<a name="line-997"></a>      <span class='hs-comment'>-- It's OK to use nonDetEltsUFM here because we forget the ordering</span>
<a name="line-998"></a>      <span class='hs-comment'>-- by immediately converting to a set or check if all the elements</span>
<a name="line-999"></a>      <span class='hs-comment'>-- satisfy a predicate.</span>
<a name="line-1000"></a>    <span class='hs-varid'>exp_id_set</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>exp_ids</span>
<a name="line-1001"></a>    <span class='hs-varid'>no_need_to_flatten</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ruleInfoRules</span> <span class='hs-varop'>.</span> <span class='hs-varid'>idSpecialisation</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_ids</span>
<a name="line-1002"></a>    <span class='hs-varid'>binds'</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>zap</span> <span class='hs-varid'>binds</span>
<a name="line-1003"></a>
<a name="line-1004"></a>    <span class='hs-varid'>zap</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zapPair</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1005"></a>    <span class='hs-varid'>zap</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-varid'>zapPair</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1006"></a>
<a name="line-1007"></a>    <span class='hs-varid'>zapPair</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-1008"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>exp_id_set</span>
<a name="line-1009"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>   <span class='hs-comment'>-- Kill the exported-id binding</span>
<a name="line-1010"></a>
<a name="line-1011"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>exp_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>ticks</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>ind_env</span> <span class='hs-varid'>bndr</span>
<a name="line-1012"></a>        <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>exp_id'</span><span class='hs-layout'>,</span> <span class='hs-varid'>lcl_id'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>transferIdInfo</span> <span class='hs-varid'>exp_id</span> <span class='hs-varid'>bndr</span>
<a name="line-1013"></a>        <span class='hs-keyglyph'>=</span>      <span class='hs-comment'>-- Turn a local-id binding into two bindings</span>
<a name="line-1014"></a>               <span class='hs-comment'>--    exp_id = rhs; lcl_id = exp_id</span>
<a name="line-1015"></a>          <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>exp_id'</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTicks</span> <span class='hs-varid'>ticks</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-1016"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>lcl_id'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>exp_id'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-1017"></a>
<a name="line-1018"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1019"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1020"></a>
<a name="line-1021"></a><a name="makeIndEnv"></a><span class='hs-definition'>makeIndEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBind</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IndEnv</span>
<a name="line-1022"></a><span class='hs-definition'>makeIndEnv</span> <span class='hs-varid'>binds</span>
<a name="line-1023"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl'</span> <span class='hs-varid'>add_bind</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-varid'>binds</span>
<a name="line-1024"></a>  <span class='hs-keyword'>where</span>
<a name="line-1025"></a>    <span class='hs-varid'>add_bind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IndEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IndEnv</span>
<a name="line-1026"></a>    <span class='hs-varid'>add_bind</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>exported_id</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_pair</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>exported_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-1027"></a>    <span class='hs-varid'>add_bind</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl'</span> <span class='hs-varid'>add_pair</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pairs</span>
<a name="line-1028"></a>
<a name="line-1029"></a>    <span class='hs-varid'>add_pair</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IndEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IndEnv</span>
<a name="line-1030"></a>    <span class='hs-varid'>add_pair</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>exported_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>exported</span><span class='hs-layout'>)</span>
<a name="line-1031"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>ticks</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>local_id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stripTicksTop</span> <span class='hs-varid'>tickishFloatable</span> <span class='hs-varid'>exported</span>
<a name="line-1032"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>shortMeOut</span> <span class='hs-varid'>env</span> <span class='hs-varid'>exported_id</span> <span class='hs-varid'>local_id</span>
<a name="line-1033"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>local_id</span> <span class='hs-layout'>(</span><span class='hs-varid'>exported_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>ticks</span><span class='hs-layout'>)</span>
<a name="line-1034"></a>    <span class='hs-varid'>add_pair</span> <span class='hs-varid'>env</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-1035"></a>
<a name="line-1036"></a><a name="shortMeOut"></a><span class='hs-comment'>-----------------</span>
<a name="line-1037"></a><span class='hs-definition'>shortMeOut</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IndEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1038"></a><span class='hs-definition'>shortMeOut</span> <span class='hs-varid'>ind_env</span> <span class='hs-varid'>exported_id</span> <span class='hs-varid'>local_id</span>
<a name="line-1039"></a><span class='hs-comment'>-- The if-then-else stuff is just so I can get a pprTrace to see</span>
<a name="line-1040"></a><span class='hs-comment'>-- how often I don't get shorting out because of IdInfo stuff</span>
<a name="line-1041"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isExportedId</span> <span class='hs-varid'>exported_id</span> <span class='hs-varop'>&amp;&amp;</span>              <span class='hs-comment'>-- Only if this is exported</span>
<a name="line-1042"></a>
<a name="line-1043"></a>       <span class='hs-varid'>isLocalId</span> <span class='hs-varid'>local_id</span> <span class='hs-varop'>&amp;&amp;</span>                    <span class='hs-comment'>-- Only if this one is defined in this</span>
<a name="line-1044"></a>                                                <span class='hs-comment'>--      module, so that we *can* change its</span>
<a name="line-1045"></a>                                                <span class='hs-comment'>--      binding to be the exported thing!</span>
<a name="line-1046"></a>
<a name="line-1047"></a>       <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isExportedId</span> <span class='hs-varid'>local_id</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>           <span class='hs-comment'>-- Only if this one is not itself exported,</span>
<a name="line-1048"></a>                                                <span class='hs-comment'>--      since the transformation will nuke it</span>
<a name="line-1049"></a>
<a name="line-1050"></a>       <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>local_id</span> <span class='hs-varop'>`elemVarEnv`</span> <span class='hs-varid'>ind_env</span><span class='hs-layout'>)</span>      <span class='hs-comment'>-- Only if not already substituted for</span>
<a name="line-1051"></a>    <span class='hs-keyword'>then</span>
<a name="line-1052"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>hasShortableIdInfo</span> <span class='hs-varid'>exported_id</span>
<a name="line-1053"></a>        <span class='hs-keyword'>then</span> <span class='hs-conid'>True</span>       <span class='hs-comment'>-- See Note [Messing up the exported Id's IdInfo]</span>
<a name="line-1054"></a>        <span class='hs-keyword'>else</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Not shorting out:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exported_id</span> <span class='hs-layout'>)</span>
<a name="line-1055"></a>             <span class='hs-conid'>False</span>
<a name="line-1056"></a>    <span class='hs-keyword'>else</span>
<a name="line-1057"></a>        <span class='hs-conid'>False</span>
<a name="line-1058"></a>
<a name="line-1059"></a><a name="hasShortableIdInfo"></a><span class='hs-comment'>-----------------</span>
<a name="line-1060"></a><span class='hs-definition'>hasShortableIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1061"></a><span class='hs-comment'>-- True if there is no user-attached IdInfo on exported_id,</span>
<a name="line-1062"></a><span class='hs-comment'>-- so we can safely discard it</span>
<a name="line-1063"></a><span class='hs-comment'>-- See Note [Messing up the exported Id's IdInfo]</span>
<a name="line-1064"></a><span class='hs-definition'>hasShortableIdInfo</span> <span class='hs-varid'>id</span>
<a name="line-1065"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>isEmptyRuleInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>ruleInfo</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-1066"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isDefaultInlinePragma</span> <span class='hs-layout'>(</span><span class='hs-varid'>inlinePragInfo</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-1067"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isStableUnfolding</span> <span class='hs-layout'>(</span><span class='hs-varid'>unfoldingInfo</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1068"></a>  <span class='hs-keyword'>where</span>
<a name="line-1069"></a>     <span class='hs-varid'>info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span>
<a name="line-1070"></a>
<a name="line-1071"></a><span class='hs-comment'>-----------------</span>
<a name="line-1072"></a><span class='hs-comment'>{- Note [Transferring IdInfo]
<a name="line-1073"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1074"></a>If we have
<a name="line-1075"></a>     lcl_id = e; exp_id = lcl_id
<a name="line-1076"></a>
<a name="line-1077"></a>and lcl_id has useful IdInfo, we don't want to discard it by going
<a name="line-1078"></a>     gbl_id = e; lcl_id = gbl_id
<a name="line-1079"></a>
<a name="line-1080"></a>Instead, transfer IdInfo from lcl_id to exp_id, specifically
<a name="line-1081"></a>* (Stable) unfolding
<a name="line-1082"></a>* Strictness
<a name="line-1083"></a>* Rules
<a name="line-1084"></a>* Inline pragma
<a name="line-1085"></a>
<a name="line-1086"></a>Overwriting, rather than merging, seems to work ok.
<a name="line-1087"></a>
<a name="line-1088"></a>We also zap the InlinePragma on the lcl_id. It might originally
<a name="line-1089"></a>have had a NOINLINE, which we have now transferred; and we really
<a name="line-1090"></a>want the lcl_id to inline now that its RHS is trivial!
<a name="line-1091"></a>-}</span>
<a name="line-1092"></a>
<a name="line-1093"></a><a name="transferIdInfo"></a><span class='hs-definition'>transferIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-1094"></a><span class='hs-comment'>-- See Note [Transferring IdInfo]</span>
<a name="line-1095"></a><span class='hs-definition'>transferIdInfo</span> <span class='hs-varid'>exported_id</span> <span class='hs-varid'>local_id</span>
<a name="line-1096"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-varid'>modifyIdInfo</span> <span class='hs-varid'>transfer</span> <span class='hs-varid'>exported_id</span>
<a name="line-1097"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>local_id</span> <span class='hs-varop'>`setInlinePragma`</span> <span class='hs-varid'>defaultInlinePragma</span> <span class='hs-layout'>)</span>
<a name="line-1098"></a>  <span class='hs-keyword'>where</span>
<a name="line-1099"></a>    <span class='hs-varid'>local_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idInfo</span> <span class='hs-varid'>local_id</span>
<a name="line-1100"></a>    <span class='hs-varid'>transfer</span> <span class='hs-varid'>exp_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp_info</span> <span class='hs-varop'>`setStrictnessInfo`</span>    <span class='hs-varid'>strictnessInfo</span> <span class='hs-varid'>local_info</span>
<a name="line-1101"></a>                                 <span class='hs-varop'>`setCprInfo`</span>           <span class='hs-varid'>cprInfo</span> <span class='hs-varid'>local_info</span>
<a name="line-1102"></a>                                 <span class='hs-varop'>`setUnfoldingInfo`</span>     <span class='hs-varid'>unfoldingInfo</span> <span class='hs-varid'>local_info</span>
<a name="line-1103"></a>                                 <span class='hs-varop'>`setInlinePragInfo`</span>    <span class='hs-varid'>inlinePragInfo</span> <span class='hs-varid'>local_info</span>
<a name="line-1104"></a>                                 <span class='hs-varop'>`setRuleInfo`</span>          <span class='hs-varid'>addRuleInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>ruleInfo</span> <span class='hs-varid'>exp_info</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_info</span>
<a name="line-1105"></a>    <span class='hs-varid'>new_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setRuleInfoHead</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>exported_id</span><span class='hs-layout'>)</span>
<a name="line-1106"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>ruleInfo</span> <span class='hs-varid'>local_info</span><span class='hs-layout'>)</span>
<a name="line-1107"></a>        <span class='hs-comment'>-- Remember to set the function-name field of the</span>
<a name="line-1108"></a>        <span class='hs-comment'>-- rules as we transfer them from one function to another</span>
<a name="line-1109"></a>
<a name="line-1110"></a>
<a name="line-1111"></a>
<a name="line-1112"></a><a name="dmdAnal"></a><span class='hs-definition'>dmdAnal</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Logger</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInstEnvs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreRule</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CoreProgram</span>
<a name="line-1113"></a><span class='hs-definition'>dmdAnal</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>fam_envs</span> <span class='hs-varid'>rules</span> <span class='hs-varid'>binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1114"></a>  <span class='hs-keyword'>let</span> <span class='hs-varop'>!</span><span class='hs-varid'>opts</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdAnalOpts</span>
<a name="line-1115"></a>               <span class='hs-layout'>{</span> <span class='hs-varid'>dmd_strict_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_DictsStrict</span> <span class='hs-varid'>dflags</span>
<a name="line-1116"></a>               <span class='hs-layout'>}</span>
<a name="line-1117"></a>      <span class='hs-varid'>binds_plus_dmds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnalProgram</span> <span class='hs-varid'>opts</span> <span class='hs-varid'>fam_envs</span> <span class='hs-varid'>rules</span> <span class='hs-varid'>binds</span>
<a name="line-1118"></a>  <span class='hs-conid'>Logger.dumpIfSet_dyn</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_str_signatures</span> <span class='hs-str'>"Strictness signatures"</span> <span class='hs-conid'>FormatText</span> <span class='hs-varop'>$</span>
<a name="line-1119"></a>    <span class='hs-varid'>dumpIdInfoOfProgram</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>zapDmdEnvSig</span> <span class='hs-varop'>.</span> <span class='hs-varid'>strictnessInfo</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds_plus_dmds</span>
<a name="line-1120"></a>  <span class='hs-comment'>-- See Note [Stamp out space leaks in demand analysis] in GHC.Core.Opt.DmdAnal</span>
<a name="line-1121"></a>  <span class='hs-varid'>seqBinds</span> <span class='hs-varid'>binds_plus_dmds</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>return</span> <span class='hs-varid'>binds_plus_dmds</span>
</pre></body>
</html>
