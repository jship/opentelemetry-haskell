<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Types/Name/Cache.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE RankNTypes #-}</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-comment'>-- | The Name Cache</span>
<a name="line-5"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Types.Name.Cache</span>
<a name="line-6"></a>    <span class='hs-layout'>(</span> <span class='hs-varid'>lookupOrigNameCache</span>
<a name="line-7"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>extendOrigNameCache</span>
<a name="line-8"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>extendNameCache</span>
<a name="line-9"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>initNameCache</span>
<a name="line-10"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>NameCache</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>OrigNameCache</span>
<a name="line-11"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.Supply</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Types</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Names</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-comment'>{-
<a name="line-28"></a>
<a name="line-29"></a>Note [The Name Cache]
<a name="line-30"></a>~~~~~~~~~~~~~~~~~~~~~
<a name="line-31"></a>The Name Cache makes sure that, during any invocation of GHC, each
<a name="line-32"></a>External Name "M.x" has one, and only one globally-agreed Unique.
<a name="line-33"></a>
<a name="line-34"></a>* The first time we come across M.x we make up a Unique and record that
<a name="line-35"></a>  association in the Name Cache.
<a name="line-36"></a>
<a name="line-37"></a>* When we come across "M.x" again, we look it up in the Name Cache,
<a name="line-38"></a>  and get a hit.
<a name="line-39"></a>
<a name="line-40"></a>The functions newGlobalBinder, allocateGlobalBinder do the main work.
<a name="line-41"></a>When you make an External name, you should probably be calling one
<a name="line-42"></a>of them.
<a name="line-43"></a>
<a name="line-44"></a>
<a name="line-45"></a>Note [Built-in syntax and the OrigNameCache]
<a name="line-46"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-47"></a>
<a name="line-48"></a>Built-in syntax like tuples and unboxed sums are quite ubiquitous. To lower
<a name="line-49"></a>their cost we use two tricks,
<a name="line-50"></a>
<a name="line-51"></a>  a. We specially encode tuple and sum Names in interface files' symbol tables
<a name="line-52"></a>     to avoid having to look up their names while loading interface files.
<a name="line-53"></a>     Namely these names are encoded as by their Uniques. We know how to get from
<a name="line-54"></a>     a Unique back to the Name which it represents via the mapping defined in
<a name="line-55"></a>     the SumTupleUniques module. See Note [Symbol table representation of names]
<a name="line-56"></a>     in GHC.Iface.Binary and for details.
<a name="line-57"></a>
<a name="line-58"></a>  b. We don't include them in the Orig name cache but instead parse their
<a name="line-59"></a>     OccNames (in isBuiltInOcc_maybe) to avoid bloating the name cache with
<a name="line-60"></a>     them.
<a name="line-61"></a>
<a name="line-62"></a>Why is the second measure necessary? Good question; afterall, 1) the parser
<a name="line-63"></a>emits built-in syntax directly as Exact RdrNames, and 2) built-in syntax never
<a name="line-64"></a>needs to looked-up during interface loading due to (a). It turns out that there
<a name="line-65"></a>are two reasons why we might look up an Orig RdrName for built-in syntax,
<a name="line-66"></a>
<a name="line-67"></a>  * If you use setRdrNameSpace on an Exact RdrName it may be
<a name="line-68"></a>    turned into an Orig RdrName.
<a name="line-69"></a>
<a name="line-70"></a>  * Template Haskell turns a BuiltInSyntax Name into a TH.NameG
<a name="line-71"></a>    (GHC.HsToCore.Quote.globalVar), and parses a NameG into an Orig RdrName
<a name="line-72"></a>    (GHC.ThToHs.thRdrName).  So, e.g. $(do { reify '(,); ... }) will
<a name="line-73"></a>    go this route (#8954).
<a name="line-74"></a>
<a name="line-75"></a>-}</span>
<a name="line-76"></a>
<a name="line-77"></a><a name="OrigNameCache"></a><span class='hs-comment'>-- | Per-module cache of original 'OccName's given 'Name's</span>
<a name="line-78"></a><a name="OrigNameCache"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>OrigNameCache</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModuleEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccEnv</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-79"></a>
<a name="line-80"></a><a name="lookupOrigNameCache"></a><span class='hs-definition'>lookupOrigNameCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OrigNameCache</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span>
<a name="line-81"></a><span class='hs-definition'>lookupOrigNameCache</span> <span class='hs-varid'>nc</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span>
<a name="line-82"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>==</span> <span class='hs-varid'>gHC_TYPES</span> <span class='hs-varop'>||</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>==</span> <span class='hs-varid'>gHC_PRIM</span> <span class='hs-varop'>||</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>==</span> <span class='hs-varid'>gHC_TUPLE</span>
<a name="line-83"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isBuiltInOcc_maybe</span> <span class='hs-varid'>occ</span>
<a name="line-84"></a>  <span class='hs-keyglyph'>=</span>     <span class='hs-comment'>-- See Note [Known-key names], 3(c) in GHC.Builtin.Names</span>
<a name="line-85"></a>        <span class='hs-comment'>-- Special case for tuples; there are too many</span>
<a name="line-86"></a>        <span class='hs-comment'>-- of them to pre-populate the original-name cache</span>
<a name="line-87"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>name</span>
<a name="line-88"></a>
<a name="line-89"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-90"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupModuleEnv</span> <span class='hs-varid'>nc</span> <span class='hs-varid'>mod</span> <span class='hs-keyword'>of</span>
<a name="line-91"></a>        <span class='hs-conid'>Nothing</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-92"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>occ_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookupOccEnv</span> <span class='hs-varid'>occ_env</span> <span class='hs-varid'>occ</span>
<a name="line-93"></a>
<a name="line-94"></a><a name="extendOrigNameCache"></a><span class='hs-definition'>extendOrigNameCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OrigNameCache</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OrigNameCache</span>
<a name="line-95"></a><span class='hs-definition'>extendOrigNameCache</span> <span class='hs-varid'>nc</span> <span class='hs-varid'>name</span>
<a name="line-96"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-layout'>)</span>
<a name="line-97"></a>    <span class='hs-varid'>extendNameCache</span> <span class='hs-varid'>nc</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span>
<a name="line-98"></a>
<a name="line-99"></a><a name="extendNameCache"></a><span class='hs-definition'>extendNameCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OrigNameCache</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OrigNameCache</span>
<a name="line-100"></a><span class='hs-definition'>extendNameCache</span> <span class='hs-varid'>nc</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>name</span>
<a name="line-101"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendModuleEnvWith</span> <span class='hs-varid'>combine</span> <span class='hs-varid'>nc</span> <span class='hs-varid'>mod</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitOccEnv</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-102"></a>  <span class='hs-keyword'>where</span>
<a name="line-103"></a>    <span class='hs-varid'>combine</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>occ_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendOccEnv</span> <span class='hs-varid'>occ_env</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>name</span>
<a name="line-104"></a>
<a name="line-105"></a><a name="NameCache"></a><span class='hs-comment'>-- | The NameCache makes sure that there is just one Unique assigned for</span>
<a name="line-106"></a><a name="NameCache"></a><span class='hs-comment'>-- each original name; i.e. (module-name, occ-name) pair and provides</span>
<a name="line-107"></a><a name="NameCache"></a><span class='hs-comment'>-- something of a lookup mechanism for those names.</span>
<a name="line-108"></a><a name="NameCache"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>NameCache</span>
<a name="line-109"></a> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameCache</span> <span class='hs-layout'>{</span>  <span class='hs-varid'>nsUniqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>UniqSupply</span><span class='hs-layout'>,</span>
<a name="line-110"></a>                <span class='hs-comment'>-- ^ Supply of uniques</span>
<a name="line-111"></a>                <span class='hs-varid'>nsNames</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>OrigNameCache</span>
<a name="line-112"></a>                <span class='hs-comment'>-- ^ Ensures that one original name gets one unique</span>
<a name="line-113"></a>   <span class='hs-layout'>}</span>
<a name="line-114"></a>
<a name="line-115"></a><a name="initNameCache"></a><span class='hs-comment'>-- | Return a function to atomically update the name cache.</span>
<a name="line-116"></a><span class='hs-definition'>initNameCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameCache</span>
<a name="line-117"></a><span class='hs-definition'>initNameCache</span> <span class='hs-varid'>us</span> <span class='hs-varid'>names</span>
<a name="line-118"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameCache</span> <span class='hs-layout'>{</span> <span class='hs-varid'>nsUniqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>us</span><span class='hs-layout'>,</span>
<a name="line-119"></a>                <span class='hs-varid'>nsNames</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initOrigNames</span> <span class='hs-varid'>names</span> <span class='hs-layout'>}</span>
<a name="line-120"></a>
<a name="line-121"></a><a name="initOrigNames"></a><span class='hs-definition'>initOrigNames</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OrigNameCache</span>
<a name="line-122"></a><span class='hs-definition'>initOrigNames</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl'</span> <span class='hs-varid'>extendOrigNameCache</span> <span class='hs-varid'>emptyModuleEnv</span> <span class='hs-varid'>names</span>
</pre></body>
</html>
