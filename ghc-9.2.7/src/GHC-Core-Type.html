<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Core/Type.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>-- (c) The University of Glasgow 2006</span>
<a name="line-2"></a><span class='hs-comment'>-- (c) The GRASP/AQUA Project, Glasgow University, 1998</span>
<a name="line-3"></a><span class='hs-comment'>--</span>
<a name="line-4"></a><span class='hs-comment'>-- Type - public interface</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-comment'>{-# LANGUAGE CPP, FlexibleContexts, PatternSynonyms, ViewPatterns, MultiWayIf #-}</span>
<a name="line-7"></a><span class='hs-comment'>{-# OPTIONS_GHC -fno-warn-orphans #-}</span>
<a name="line-8"></a><span class='hs-comment'>{-# OPTIONS_GHC -Wno-incomplete-record-updates #-}</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-comment'>-- | Main functions for manipulating types and type-related things</span>
<a name="line-11"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Core.Type</span> <span class='hs-layout'>(</span>
<a name="line-12"></a>        <span class='hs-comment'>-- Note some of this is just re-exports from TyCon..</span>
<a name="line-13"></a>
<a name="line-14"></a>        <span class='hs-comment'>-- * Main data types representing Types</span>
<a name="line-15"></a>        <span class='hs-comment'>-- $type_classification</span>
<a name="line-16"></a>
<a name="line-17"></a>        <span class='hs-comment'>-- $representation_types</span>
<a name="line-18"></a>        <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>ArgFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>AnonArgFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-19"></a>        <span class='hs-conid'>Specificity</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-20"></a>        <span class='hs-conid'>KindOrType</span><span class='hs-layout'>,</span> <span class='hs-conid'>PredType</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span>
<a name="line-21"></a>        <span class='hs-conid'>Var</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoBinder</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoVarBinder</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVarBinder</span><span class='hs-layout'>,</span>
<a name="line-22"></a>        <span class='hs-conid'>Mult</span><span class='hs-layout'>,</span> <span class='hs-conid'>Scaled</span><span class='hs-layout'>,</span>
<a name="line-23"></a>        <span class='hs-conid'>KnotTied</span><span class='hs-layout'>,</span>
<a name="line-24"></a>
<a name="line-25"></a>        <span class='hs-comment'>-- ** Constructing and deconstructing types</span>
<a name="line-26"></a>        <span class='hs-varid'>mkTyVarTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyVarTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTyVar_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>repGetTyVar_maybe</span><span class='hs-layout'>,</span>
<a name="line-27"></a>        <span class='hs-varid'>getCastedTyVar_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyVarKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>varType</span><span class='hs-layout'>,</span>
<a name="line-28"></a>
<a name="line-29"></a>        <span class='hs-varid'>mkAppTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitAppTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitAppTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>repSplitAppTys</span><span class='hs-layout'>,</span>
<a name="line-30"></a>        <span class='hs-varid'>splitAppTy_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>repSplitAppTy_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcRepSplitAppTy_maybe</span><span class='hs-layout'>,</span>
<a name="line-31"></a>
<a name="line-32"></a>        <span class='hs-varid'>mkFunTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkVisFunTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkInvisFunTy</span><span class='hs-layout'>,</span>
<a name="line-33"></a>        <span class='hs-varid'>mkVisFunTys</span><span class='hs-layout'>,</span>
<a name="line-34"></a>        <span class='hs-varid'>mkVisFunTyMany</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkInvisFunTyMany</span><span class='hs-layout'>,</span>
<a name="line-35"></a>        <span class='hs-varid'>mkVisFunTysMany</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkInvisFunTysMany</span><span class='hs-layout'>,</span>
<a name="line-36"></a>        <span class='hs-varid'>splitFunTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitFunTy_maybe</span><span class='hs-layout'>,</span>
<a name="line-37"></a>        <span class='hs-varid'>splitFunTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>funResultTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>funArgTy</span><span class='hs-layout'>,</span>
<a name="line-38"></a>
<a name="line-39"></a>        <span class='hs-varid'>mkTyConApp</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyConTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>tYPE</span><span class='hs-layout'>,</span>
<a name="line-40"></a>        <span class='hs-varid'>tyConAppTyCon_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConAppTyConPicky_maybe</span><span class='hs-layout'>,</span>
<a name="line-41"></a>        <span class='hs-varid'>tyConAppArgs_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConAppTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConAppArgs</span><span class='hs-layout'>,</span>
<a name="line-42"></a>        <span class='hs-varid'>splitTyConApp_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitTyConApp</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConAppArgN</span><span class='hs-layout'>,</span>
<a name="line-43"></a>        <span class='hs-varid'>tcSplitTyConApp_maybe</span><span class='hs-layout'>,</span>
<a name="line-44"></a>        <span class='hs-varid'>splitListTyConApp_maybe</span><span class='hs-layout'>,</span>
<a name="line-45"></a>        <span class='hs-varid'>repSplitTyConApp_maybe</span><span class='hs-layout'>,</span>
<a name="line-46"></a>        <span class='hs-varid'>tcRepSplitTyConApp_maybe</span><span class='hs-layout'>,</span>
<a name="line-47"></a>
<a name="line-48"></a>        <span class='hs-varid'>mkForAllTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkForAllTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkInvisForAllTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyCoInvForAllTys</span><span class='hs-layout'>,</span>
<a name="line-49"></a>        <span class='hs-varid'>mkSpecForAllTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSpecForAllTys</span><span class='hs-layout'>,</span>
<a name="line-50"></a>        <span class='hs-varid'>mkVisForAllTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyCoInvForAllTy</span><span class='hs-layout'>,</span>
<a name="line-51"></a>        <span class='hs-varid'>mkInfForAllTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkInfForAllTys</span><span class='hs-layout'>,</span>
<a name="line-52"></a>        <span class='hs-varid'>splitForAllTyCoVars</span><span class='hs-layout'>,</span>
<a name="line-53"></a>        <span class='hs-varid'>splitForAllReqTVBinders</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitForAllInvisTVBinders</span><span class='hs-layout'>,</span>
<a name="line-54"></a>        <span class='hs-varid'>splitForAllTyCoVarBinders</span><span class='hs-layout'>,</span>
<a name="line-55"></a>        <span class='hs-varid'>splitForAllTyCoVar_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitForAllTyCoVar</span><span class='hs-layout'>,</span>
<a name="line-56"></a>        <span class='hs-varid'>splitForAllTyVar_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitForAllCoVar_maybe</span><span class='hs-layout'>,</span>
<a name="line-57"></a>        <span class='hs-varid'>splitPiTy_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitPiTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitPiTys</span><span class='hs-layout'>,</span>
<a name="line-58"></a>        <span class='hs-varid'>mkTyConBindersPreferAnon</span><span class='hs-layout'>,</span>
<a name="line-59"></a>        <span class='hs-varid'>mkPiTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkPiTys</span><span class='hs-layout'>,</span>
<a name="line-60"></a>        <span class='hs-varid'>piResultTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>piResultTys</span><span class='hs-layout'>,</span>
<a name="line-61"></a>        <span class='hs-varid'>applyTysX</span><span class='hs-layout'>,</span> <span class='hs-varid'>dropForAlls</span><span class='hs-layout'>,</span>
<a name="line-62"></a>        <span class='hs-varid'>mkFamilyTyConApp</span><span class='hs-layout'>,</span>
<a name="line-63"></a>        <span class='hs-varid'>buildSynTyCon</span><span class='hs-layout'>,</span>
<a name="line-64"></a>
<a name="line-65"></a>        <span class='hs-varid'>mkNumLitTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isNumLitTy</span><span class='hs-layout'>,</span>
<a name="line-66"></a>        <span class='hs-varid'>mkStrLitTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isStrLitTy</span><span class='hs-layout'>,</span>
<a name="line-67"></a>        <span class='hs-varid'>mkCharLitTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCharLitTy</span><span class='hs-layout'>,</span>
<a name="line-68"></a>        <span class='hs-varid'>isLitTy</span><span class='hs-layout'>,</span>
<a name="line-69"></a>
<a name="line-70"></a>        <span class='hs-varid'>isPredTy</span><span class='hs-layout'>,</span>
<a name="line-71"></a>
<a name="line-72"></a>        <span class='hs-varid'>getRuntimeRep_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>kindRep_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>kindRep</span><span class='hs-layout'>,</span>
<a name="line-73"></a>
<a name="line-74"></a>        <span class='hs-varid'>mkCastTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCoercionTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitCastTy_maybe</span><span class='hs-layout'>,</span>
<a name="line-75"></a>
<a name="line-76"></a>        <span class='hs-varid'>userTypeError_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprUserTypeErrorTy</span><span class='hs-layout'>,</span>
<a name="line-77"></a>
<a name="line-78"></a>        <span class='hs-varid'>coAxNthLHS</span><span class='hs-layout'>,</span>
<a name="line-79"></a>        <span class='hs-varid'>stripCoercionTy</span><span class='hs-layout'>,</span>
<a name="line-80"></a>
<a name="line-81"></a>        <span class='hs-varid'>splitInvisPiTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitInvisPiTysN</span><span class='hs-layout'>,</span>
<a name="line-82"></a>        <span class='hs-varid'>invisibleTyBndrCount</span><span class='hs-layout'>,</span>
<a name="line-83"></a>        <span class='hs-varid'>filterOutInvisibleTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>filterOutInferredTypes</span><span class='hs-layout'>,</span>
<a name="line-84"></a>        <span class='hs-varid'>partitionInvisibleTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>partitionInvisibles</span><span class='hs-layout'>,</span>
<a name="line-85"></a>        <span class='hs-varid'>tyConArgFlags</span><span class='hs-layout'>,</span> <span class='hs-varid'>appTyArgFlags</span><span class='hs-layout'>,</span>
<a name="line-86"></a>
<a name="line-87"></a>        <span class='hs-comment'>-- ** Analyzing types</span>
<a name="line-88"></a>        <span class='hs-conid'>TyCoMapper</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>mapTyCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mapTyCoX</span><span class='hs-layout'>,</span>
<a name="line-89"></a>        <span class='hs-conid'>TyCoFolder</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldTyCo</span><span class='hs-layout'>,</span>
<a name="line-90"></a>
<a name="line-91"></a>        <span class='hs-comment'>-- (Newtypes)</span>
<a name="line-92"></a>        <span class='hs-varid'>newTyConInstRhs</span><span class='hs-layout'>,</span>
<a name="line-93"></a>
<a name="line-94"></a>        <span class='hs-comment'>-- ** Binders</span>
<a name="line-95"></a>        <span class='hs-varid'>sameVis</span><span class='hs-layout'>,</span>
<a name="line-96"></a>        <span class='hs-varid'>mkTyCoVarBinder</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyCoVarBinders</span><span class='hs-layout'>,</span>
<a name="line-97"></a>        <span class='hs-varid'>mkTyVarBinder</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyVarBinders</span><span class='hs-layout'>,</span>
<a name="line-98"></a>        <span class='hs-varid'>tyVarSpecToBinders</span><span class='hs-layout'>,</span>
<a name="line-99"></a>        <span class='hs-varid'>mkAnonBinder</span><span class='hs-layout'>,</span>
<a name="line-100"></a>        <span class='hs-varid'>isAnonTyCoBinder</span><span class='hs-layout'>,</span>
<a name="line-101"></a>        <span class='hs-varid'>binderVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>binderVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>binderType</span><span class='hs-layout'>,</span> <span class='hs-varid'>binderArgFlag</span><span class='hs-layout'>,</span>
<a name="line-102"></a>        <span class='hs-varid'>tyCoBinderType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoBinderVar_maybe</span><span class='hs-layout'>,</span>
<a name="line-103"></a>        <span class='hs-varid'>tyBinderType</span><span class='hs-layout'>,</span>
<a name="line-104"></a>        <span class='hs-varid'>binderRelevantType_maybe</span><span class='hs-layout'>,</span>
<a name="line-105"></a>        <span class='hs-varid'>isVisibleArgFlag</span><span class='hs-layout'>,</span> <span class='hs-varid'>isInvisibleArgFlag</span><span class='hs-layout'>,</span> <span class='hs-varid'>isVisibleBinder</span><span class='hs-layout'>,</span>
<a name="line-106"></a>        <span class='hs-varid'>isInvisibleBinder</span><span class='hs-layout'>,</span> <span class='hs-varid'>isNamedBinder</span><span class='hs-layout'>,</span>
<a name="line-107"></a>        <span class='hs-varid'>tyConBindersTyCoBinders</span><span class='hs-layout'>,</span>
<a name="line-108"></a>
<a name="line-109"></a>        <span class='hs-comment'>-- ** Common type constructors</span>
<a name="line-110"></a>        <span class='hs-varid'>funTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>unrestrictedFunTyCon</span><span class='hs-layout'>,</span>
<a name="line-111"></a>
<a name="line-112"></a>        <span class='hs-comment'>-- ** Predicates on types</span>
<a name="line-113"></a>        <span class='hs-varid'>isTyVarTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFunTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCoercionTy</span><span class='hs-layout'>,</span>
<a name="line-114"></a>        <span class='hs-varid'>isCoercionTy_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>isForAllTy</span><span class='hs-layout'>,</span>
<a name="line-115"></a>        <span class='hs-varid'>isForAllTy_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>isForAllTy_co</span><span class='hs-layout'>,</span>
<a name="line-116"></a>        <span class='hs-varid'>isPiTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTauTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFamFreeTy</span><span class='hs-layout'>,</span>
<a name="line-117"></a>        <span class='hs-varid'>isCoVarType</span><span class='hs-layout'>,</span> <span class='hs-varid'>isAtomicTy</span><span class='hs-layout'>,</span>
<a name="line-118"></a>
<a name="line-119"></a>        <span class='hs-varid'>isValidJoinPointType</span><span class='hs-layout'>,</span>
<a name="line-120"></a>        <span class='hs-varid'>tyConAppNeedsKindSig</span><span class='hs-layout'>,</span>
<a name="line-121"></a>
<a name="line-122"></a>        <span class='hs-comment'>-- *** Levity and boxity</span>
<a name="line-123"></a>        <span class='hs-varid'>isLiftedType_maybe</span><span class='hs-layout'>,</span>
<a name="line-124"></a>        <span class='hs-varid'>isLiftedTypeKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>isUnliftedTypeKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>isBoxedTypeKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>pickyIsLiftedTypeKind</span><span class='hs-layout'>,</span>
<a name="line-125"></a>        <span class='hs-varid'>isLiftedRuntimeRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>isUnliftedRuntimeRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>isBoxedRuntimeRep</span><span class='hs-layout'>,</span>
<a name="line-126"></a>        <span class='hs-varid'>isLiftedLevity</span><span class='hs-layout'>,</span> <span class='hs-varid'>isUnliftedLevity</span><span class='hs-layout'>,</span>
<a name="line-127"></a>        <span class='hs-varid'>isUnliftedType</span><span class='hs-layout'>,</span> <span class='hs-varid'>isBoxedType</span><span class='hs-layout'>,</span> <span class='hs-varid'>mightBeUnliftedType</span><span class='hs-layout'>,</span> <span class='hs-varid'>isUnboxedTupleType</span><span class='hs-layout'>,</span> <span class='hs-varid'>isUnboxedSumType</span><span class='hs-layout'>,</span>
<a name="line-128"></a>        <span class='hs-varid'>isAlgType</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDataFamilyAppType</span><span class='hs-layout'>,</span>
<a name="line-129"></a>        <span class='hs-varid'>isPrimitiveType</span><span class='hs-layout'>,</span> <span class='hs-varid'>isStrictType</span><span class='hs-layout'>,</span>
<a name="line-130"></a>        <span class='hs-varid'>isLevityTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isLevityVar</span><span class='hs-layout'>,</span>
<a name="line-131"></a>        <span class='hs-varid'>isRuntimeRepTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isRuntimeRepVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isRuntimeRepKindedTy</span><span class='hs-layout'>,</span>
<a name="line-132"></a>        <span class='hs-varid'>dropRuntimeRepArgs</span><span class='hs-layout'>,</span>
<a name="line-133"></a>        <span class='hs-varid'>getRuntimeRep</span><span class='hs-layout'>,</span>
<a name="line-134"></a>
<a name="line-135"></a>        <span class='hs-comment'>-- * Multiplicity</span>
<a name="line-136"></a>
<a name="line-137"></a>        <span class='hs-varid'>isMultiplicityTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isMultiplicityVar</span><span class='hs-layout'>,</span>
<a name="line-138"></a>        <span class='hs-varid'>unrestricted</span><span class='hs-layout'>,</span> <span class='hs-varid'>linear</span><span class='hs-layout'>,</span> <span class='hs-varid'>tymult</span><span class='hs-layout'>,</span>
<a name="line-139"></a>        <span class='hs-varid'>mkScaled</span><span class='hs-layout'>,</span> <span class='hs-varid'>irrelevantMult</span><span class='hs-layout'>,</span> <span class='hs-varid'>scaledSet</span><span class='hs-layout'>,</span>
<a name="line-140"></a>        <span class='hs-varid'>pattern</span> <span class='hs-conid'>One</span><span class='hs-layout'>,</span> <span class='hs-varid'>pattern</span> <span class='hs-conid'>Many</span><span class='hs-layout'>,</span>
<a name="line-141"></a>        <span class='hs-varid'>isOneDataConTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isManyDataConTy</span><span class='hs-layout'>,</span>
<a name="line-142"></a>        <span class='hs-varid'>isLinearType</span><span class='hs-layout'>,</span>
<a name="line-143"></a>
<a name="line-144"></a>        <span class='hs-comment'>-- * Main data types representing Kinds</span>
<a name="line-145"></a>        <span class='hs-conid'>Kind</span><span class='hs-layout'>,</span>
<a name="line-146"></a>
<a name="line-147"></a>        <span class='hs-comment'>-- ** Finding the kind of a type</span>
<a name="line-148"></a>        <span class='hs-varid'>typeKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcTypeKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTypeLevPoly</span><span class='hs-layout'>,</span> <span class='hs-varid'>resultIsLevPoly</span><span class='hs-layout'>,</span>
<a name="line-149"></a>        <span class='hs-varid'>tcIsLiftedTypeKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcIsConstraintKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcReturnsConstraintKind</span><span class='hs-layout'>,</span>
<a name="line-150"></a>        <span class='hs-varid'>tcIsBoxedTypeKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcIsRuntimeTypeKind</span><span class='hs-layout'>,</span>
<a name="line-151"></a>
<a name="line-152"></a>        <span class='hs-comment'>-- ** Common Kind</span>
<a name="line-153"></a>        <span class='hs-varid'>liftedTypeKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>unliftedTypeKind</span><span class='hs-layout'>,</span>
<a name="line-154"></a>
<a name="line-155"></a>        <span class='hs-comment'>-- * Type free variables</span>
<a name="line-156"></a>        <span class='hs-varid'>tyCoFVsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoFVsBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoFVsVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoFVsVarBndrs</span><span class='hs-layout'>,</span>
<a name="line-157"></a>        <span class='hs-varid'>tyCoVarsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypes</span><span class='hs-layout'>,</span>
<a name="line-158"></a>        <span class='hs-varid'>tyCoVarsOfTypeDSet</span><span class='hs-layout'>,</span>
<a name="line-159"></a>        <span class='hs-varid'>coVarsOfType</span><span class='hs-layout'>,</span>
<a name="line-160"></a>        <span class='hs-varid'>coVarsOfTypes</span><span class='hs-layout'>,</span>
<a name="line-161"></a>
<a name="line-162"></a>        <span class='hs-varid'>anyFreeVarsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>anyFreeVarsOfTypes</span><span class='hs-layout'>,</span>
<a name="line-163"></a>        <span class='hs-varid'>noFreeVarsOfType</span><span class='hs-layout'>,</span>
<a name="line-164"></a>        <span class='hs-varid'>splitVisVarsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitVisVarsOfTypes</span><span class='hs-layout'>,</span>
<a name="line-165"></a>        <span class='hs-varid'>expandTypeSynonyms</span><span class='hs-layout'>,</span>
<a name="line-166"></a>        <span class='hs-varid'>typeSize</span><span class='hs-layout'>,</span> <span class='hs-varid'>occCheckExpand</span><span class='hs-layout'>,</span>
<a name="line-167"></a>
<a name="line-168"></a>        <span class='hs-comment'>-- ** Closing over kinds</span>
<a name="line-169"></a>        <span class='hs-varid'>closeOverKindsDSet</span><span class='hs-layout'>,</span> <span class='hs-varid'>closeOverKindsList</span><span class='hs-layout'>,</span>
<a name="line-170"></a>        <span class='hs-varid'>closeOverKinds</span><span class='hs-layout'>,</span>
<a name="line-171"></a>
<a name="line-172"></a>        <span class='hs-comment'>-- * Well-scoped lists of variables</span>
<a name="line-173"></a>        <span class='hs-varid'>scopedSort</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypeWellScoped</span><span class='hs-layout'>,</span>
<a name="line-174"></a>        <span class='hs-varid'>tyCoVarsOfTypesWellScoped</span><span class='hs-layout'>,</span>
<a name="line-175"></a>
<a name="line-176"></a>        <span class='hs-comment'>-- * Type comparison</span>
<a name="line-177"></a>        <span class='hs-varid'>eqType</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqTypeX</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>nonDetCmpType</span><span class='hs-layout'>,</span> <span class='hs-varid'>nonDetCmpTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>nonDetCmpTypeX</span><span class='hs-layout'>,</span>
<a name="line-178"></a>        <span class='hs-varid'>nonDetCmpTypesX</span><span class='hs-layout'>,</span> <span class='hs-varid'>nonDetCmpTc</span><span class='hs-layout'>,</span>
<a name="line-179"></a>        <span class='hs-varid'>eqVarBndrs</span><span class='hs-layout'>,</span>
<a name="line-180"></a>
<a name="line-181"></a>        <span class='hs-comment'>-- * Forcing evaluation of types</span>
<a name="line-182"></a>        <span class='hs-varid'>seqType</span><span class='hs-layout'>,</span> <span class='hs-varid'>seqTypes</span><span class='hs-layout'>,</span>
<a name="line-183"></a>
<a name="line-184"></a>        <span class='hs-comment'>-- * Other views onto Types</span>
<a name="line-185"></a>        <span class='hs-varid'>coreView</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcView</span><span class='hs-layout'>,</span>
<a name="line-186"></a>
<a name="line-187"></a>        <span class='hs-varid'>tyConsOfType</span><span class='hs-layout'>,</span>
<a name="line-188"></a>
<a name="line-189"></a>        <span class='hs-comment'>-- * Main type substitution data types</span>
<a name="line-190"></a>        <span class='hs-conid'>TvSubstEnv</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Representation widely visible</span>
<a name="line-191"></a>        <span class='hs-conid'>TCvSubst</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- Representation visible to a few friends</span>
<a name="line-192"></a>
<a name="line-193"></a>        <span class='hs-comment'>-- ** Manipulating type substitutions</span>
<a name="line-194"></a>        <span class='hs-varid'>emptyTvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyTCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkEmptyTCvSubst</span><span class='hs-layout'>,</span>
<a name="line-195"></a>
<a name="line-196"></a>        <span class='hs-varid'>mkTCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTvSubstPrs</span><span class='hs-layout'>,</span>
<a name="line-197"></a>        <span class='hs-varid'>zipTCvSubst</span><span class='hs-layout'>,</span>
<a name="line-198"></a>        <span class='hs-varid'>notElemTCvSubst</span><span class='hs-layout'>,</span>
<a name="line-199"></a>        <span class='hs-varid'>getTvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>setTvSubstEnv</span><span class='hs-layout'>,</span>
<a name="line-200"></a>        <span class='hs-varid'>zapTCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTCvInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTCvSubstRangeFVs</span><span class='hs-layout'>,</span>
<a name="line-201"></a>        <span class='hs-varid'>extendTCvInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTCvInScopeList</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTCvInScopeSet</span><span class='hs-layout'>,</span>
<a name="line-202"></a>        <span class='hs-varid'>extendTCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendCvSubst</span><span class='hs-layout'>,</span>
<a name="line-203"></a>        <span class='hs-varid'>extendTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubstBinderAndInScope</span><span class='hs-layout'>,</span>
<a name="line-204"></a>        <span class='hs-varid'>extendTvSubstList</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubstAndInScope</span><span class='hs-layout'>,</span>
<a name="line-205"></a>        <span class='hs-varid'>extendTCvSubstList</span><span class='hs-layout'>,</span>
<a name="line-206"></a>        <span class='hs-varid'>extendTvSubstWithClone</span><span class='hs-layout'>,</span>
<a name="line-207"></a>        <span class='hs-varid'>extendTCvSubstWithClone</span><span class='hs-layout'>,</span>
<a name="line-208"></a>        <span class='hs-varid'>isInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>composeTCvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>composeTCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipTyEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipCoEnv</span><span class='hs-layout'>,</span>
<a name="line-209"></a>        <span class='hs-varid'>isEmptyTCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>unionTCvSubst</span><span class='hs-layout'>,</span>
<a name="line-210"></a>
<a name="line-211"></a>        <span class='hs-comment'>-- ** Performing substitution on types and kinds</span>
<a name="line-212"></a>        <span class='hs-varid'>substTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>substScaledTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>substScaledTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyWith</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTysWith</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTheta</span><span class='hs-layout'>,</span>
<a name="line-213"></a>        <span class='hs-varid'>substTyAddInScope</span><span class='hs-layout'>,</span>
<a name="line-214"></a>        <span class='hs-varid'>substTyUnchecked</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTysUnchecked</span><span class='hs-layout'>,</span> <span class='hs-varid'>substScaledTyUnchecked</span><span class='hs-layout'>,</span> <span class='hs-varid'>substScaledTysUnchecked</span><span class='hs-layout'>,</span>
<a name="line-215"></a>        <span class='hs-varid'>substThetaUnchecked</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyWithUnchecked</span><span class='hs-layout'>,</span>
<a name="line-216"></a>        <span class='hs-varid'>substCoUnchecked</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoWithUnchecked</span><span class='hs-layout'>,</span>
<a name="line-217"></a>        <span class='hs-varid'>substTyVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyVarBndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyVars</span><span class='hs-layout'>,</span>
<a name="line-218"></a>        <span class='hs-varid'>substVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>substVarBndrs</span><span class='hs-layout'>,</span>
<a name="line-219"></a>        <span class='hs-varid'>substTyCoBndr</span><span class='hs-layout'>,</span>
<a name="line-220"></a>        <span class='hs-varid'>cloneTyVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>cloneTyVarBndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupTyVar</span><span class='hs-layout'>,</span>
<a name="line-221"></a>
<a name="line-222"></a>        <span class='hs-comment'>-- * Tidying type related things up for printing</span>
<a name="line-223"></a>        <span class='hs-varid'>tidyType</span><span class='hs-layout'>,</span>      <span class='hs-varid'>tidyTypes</span><span class='hs-layout'>,</span>
<a name="line-224"></a>        <span class='hs-varid'>tidyOpenType</span><span class='hs-layout'>,</span>  <span class='hs-varid'>tidyOpenTypes</span><span class='hs-layout'>,</span>
<a name="line-225"></a>        <span class='hs-varid'>tidyOpenKind</span><span class='hs-layout'>,</span>
<a name="line-226"></a>        <span class='hs-varid'>tidyVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyVarBndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyFreeTyCoVars</span><span class='hs-layout'>,</span>
<a name="line-227"></a>        <span class='hs-varid'>tidyOpenTyCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyOpenTyCoVars</span><span class='hs-layout'>,</span>
<a name="line-228"></a>        <span class='hs-varid'>tidyTyCoVarOcc</span><span class='hs-layout'>,</span>
<a name="line-229"></a>        <span class='hs-varid'>tidyTopType</span><span class='hs-layout'>,</span>
<a name="line-230"></a>        <span class='hs-varid'>tidyKind</span><span class='hs-layout'>,</span>
<a name="line-231"></a>        <span class='hs-varid'>tidyTyCoVarBinder</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyTyCoVarBinders</span><span class='hs-layout'>,</span>
<a name="line-232"></a>
<a name="line-233"></a>        <span class='hs-comment'>-- * Kinds</span>
<a name="line-234"></a>        <span class='hs-varid'>isConstraintKindCon</span><span class='hs-layout'>,</span>
<a name="line-235"></a>        <span class='hs-varid'>classifiesTypeWithValues</span><span class='hs-layout'>,</span>
<a name="line-236"></a>        <span class='hs-varid'>isKindLevPoly</span>
<a name="line-237"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-238"></a>
<a name="line-239"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-240"></a>
<a name="line-241"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-242"></a>
<a name="line-243"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Basic</span>
<a name="line-244"></a>
<a name="line-245"></a><span class='hs-comment'>-- We import the representation and primitive functions from GHC.Core.TyCo.Rep.</span>
<a name="line-246"></a><span class='hs-comment'>-- Many things are reexported, but not the representation!</span>
<a name="line-247"></a>
<a name="line-248"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCo.Rep</span>
<a name="line-249"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCo.Subst</span>
<a name="line-250"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCo.Tidy</span>
<a name="line-251"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCo.FVs</span>
<a name="line-252"></a>
<a name="line-253"></a><span class='hs-comment'>-- friends:</span>
<a name="line-254"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var</span>
<a name="line-255"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var.Env</span>
<a name="line-256"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var.Set</span>
<a name="line-257"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.Set</span>
<a name="line-258"></a>
<a name="line-259"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCon</span>
<a name="line-260"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Types.Prim</span>
<a name="line-261"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>GHC.Builtin.Types</span>
<a name="line-262"></a>                                 <span class='hs-layout'>(</span> <span class='hs-varid'>charTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>naturalTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>listTyCon</span>
<a name="line-263"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>typeSymbolKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftedTypeKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>unliftedTypeKind</span>
<a name="line-264"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>liftedRepTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>unliftedRepTyCon</span>
<a name="line-265"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>constraintKind</span>
<a name="line-266"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>unrestrictedFunTyCon</span>
<a name="line-267"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>manyDataConTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>oneDataConTy</span> <span class='hs-layout'>)</span>
<a name="line-268"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name</span><span class='hs-layout'>(</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>)</span>
<a name="line-269"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Names</span>
<a name="line-270"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Coercion.Axiom</span>
<a name="line-271"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>GHC.Core.Coercion</span>
<a name="line-272"></a>   <span class='hs-layout'>(</span> <span class='hs-varid'>mkNomReflCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkGReflCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkReflCo</span>
<a name="line-273"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mkTyConAppCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCoVarCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAxiomRuleCo</span>
<a name="line-274"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mkForAllCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAxiomInstCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUnivCo</span>
<a name="line-275"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mkSymCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTransCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkNthCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkLRCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkInstCo</span>
<a name="line-276"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mkKindCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSubCo</span>
<a name="line-277"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>decomposePiCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionLKind</span>
<a name="line-278"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>coercionRKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionType</span>
<a name="line-279"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>isReflexiveCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>seqCo</span> <span class='hs-layout'>)</span>
<a name="line-280"></a>
<a name="line-281"></a><span class='hs-comment'>-- others</span>
<a name="line-282"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-283"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.FV</span>
<a name="line-284"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-285"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-286"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.FastString</span>
<a name="line-287"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Pair</span>
<a name="line-288"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.List.SetOps</span>
<a name="line-289"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique</span> <span class='hs-layout'>(</span> <span class='hs-varid'>nonDetCmpUnique</span> <span class='hs-layout'>)</span>
<a name="line-290"></a>
<a name="line-291"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Maybe</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>orElse</span><span class='hs-layout'>,</span> <span class='hs-varid'>expectJust</span> <span class='hs-layout'>)</span>
<a name="line-292"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Maybe</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>)</span>
<a name="line-293"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>guard</span> <span class='hs-layout'>)</span>
<a name="line-294"></a>
<a name="line-295"></a><span class='hs-comment'>-- $type_classification</span>
<a name="line-296"></a><span class='hs-comment'>-- #type_classification#</span>
<a name="line-297"></a><span class='hs-comment'>--</span>
<a name="line-298"></a><span class='hs-comment'>-- Types are any, but at least one, of:</span>
<a name="line-299"></a><span class='hs-comment'>--</span>
<a name="line-300"></a><span class='hs-comment'>-- [Boxed]              Iff its representation is a pointer to an object on the</span>
<a name="line-301"></a><span class='hs-comment'>--                      GC'd heap. Operationally, heap objects can be entered as</span>
<a name="line-302"></a><span class='hs-comment'>--                      a means of evaluation.</span>
<a name="line-303"></a><span class='hs-comment'>--</span>
<a name="line-304"></a><span class='hs-comment'>-- [Lifted]             Iff it has bottom as an element: An instance of a</span>
<a name="line-305"></a><span class='hs-comment'>--                      lifted type might diverge when evaluated.</span>
<a name="line-306"></a><span class='hs-comment'>--                      GHC Haskell's unboxed types are unlifted.</span>
<a name="line-307"></a><span class='hs-comment'>--                      An unboxed, but lifted type is not very useful.</span>
<a name="line-308"></a><span class='hs-comment'>--                      (Example: A byte-represented type, where evaluating 0xff</span>
<a name="line-309"></a><span class='hs-comment'>--                      computes the 12345678th collatz number modulo 0xff.)</span>
<a name="line-310"></a><span class='hs-comment'>--                      Only lifted types may be unified with a type variable.</span>
<a name="line-311"></a><span class='hs-comment'>--</span>
<a name="line-312"></a><span class='hs-comment'>-- [Algebraic]          Iff it is a type with one or more constructors, whether</span>
<a name="line-313"></a><span class='hs-comment'>--                      declared with @data@ or @newtype@.</span>
<a name="line-314"></a><span class='hs-comment'>--                      An algebraic type is one that can be deconstructed</span>
<a name="line-315"></a><span class='hs-comment'>--                      with a case expression. There are algebraic types that</span>
<a name="line-316"></a><span class='hs-comment'>--                      are not lifted types, like unlifted data types or</span>
<a name="line-317"></a><span class='hs-comment'>--                      unboxed tuples.</span>
<a name="line-318"></a><span class='hs-comment'>--</span>
<a name="line-319"></a><span class='hs-comment'>-- [Data]               Iff it is a type declared with @data@, or a boxed tuple.</span>
<a name="line-320"></a><span class='hs-comment'>--                      There are also /unlifted/ data types.</span>
<a name="line-321"></a><span class='hs-comment'>--</span>
<a name="line-322"></a><span class='hs-comment'>-- [Primitive]          Iff it is a built-in type that can't be expressed in Haskell.</span>
<a name="line-323"></a><span class='hs-comment'>--</span>
<a name="line-324"></a><span class='hs-comment'>-- Currently, all primitive types are unlifted, but that's not necessarily</span>
<a name="line-325"></a><span class='hs-comment'>-- the case: for example, @Int@ could be primitive.</span>
<a name="line-326"></a><span class='hs-comment'>--</span>
<a name="line-327"></a><span class='hs-comment'>-- Some primitive types are unboxed, such as @Int#@, whereas some are boxed</span>
<a name="line-328"></a><span class='hs-comment'>-- but unlifted (such as @ByteArray#@).  The only primitive types that we</span>
<a name="line-329"></a><span class='hs-comment'>-- classify as algebraic are the unboxed tuples.</span>
<a name="line-330"></a><span class='hs-comment'>--</span>
<a name="line-331"></a><span class='hs-comment'>-- Some examples of type classifications that may make this a bit clearer are:</span>
<a name="line-332"></a><span class='hs-comment'>--</span>
<a name="line-333"></a><span class='hs-comment'>-- @</span>
<a name="line-334"></a><span class='hs-comment'>-- Type          primitive       boxed           lifted          algebraic</span>
<a name="line-335"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-336"></a><span class='hs-comment'>-- Int#          Yes             No              No              No</span>
<a name="line-337"></a><span class='hs-comment'>-- ByteArray#    Yes             Yes             No              No</span>
<a name="line-338"></a><span class='hs-comment'>-- (\# a, b \#)  Yes             No              No              Yes</span>
<a name="line-339"></a><span class='hs-comment'>-- (\# a | b \#) Yes             No              No              Yes</span>
<a name="line-340"></a><span class='hs-comment'>-- (  a, b  )    No              Yes             Yes             Yes</span>
<a name="line-341"></a><span class='hs-comment'>-- [a]           No              Yes             Yes             Yes</span>
<a name="line-342"></a><span class='hs-comment'>-- @</span>
<a name="line-343"></a>
<a name="line-344"></a><span class='hs-comment'>-- $representation_types</span>
<a name="line-345"></a><span class='hs-comment'>-- A /source type/ is a type that is a separate type as far as the type checker is</span>
<a name="line-346"></a><span class='hs-comment'>-- concerned, but which has a more low-level representation as far as Core-to-Core</span>
<a name="line-347"></a><span class='hs-comment'>-- passes and the rest of the back end is concerned.</span>
<a name="line-348"></a><span class='hs-comment'>--</span>
<a name="line-349"></a><span class='hs-comment'>-- You don't normally have to worry about this, as the utility functions in</span>
<a name="line-350"></a><span class='hs-comment'>-- this module will automatically convert a source into a representation type</span>
<a name="line-351"></a><span class='hs-comment'>-- if they are spotted, to the best of its abilities. If you don't want this</span>
<a name="line-352"></a><span class='hs-comment'>-- to happen, use the equivalent functions from the "TcType" module.</span>
<a name="line-353"></a>
<a name="line-354"></a><span class='hs-comment'>{-
<a name="line-355"></a>************************************************************************
<a name="line-356"></a>*                                                                      *
<a name="line-357"></a>                Type representation
<a name="line-358"></a>*                                                                      *
<a name="line-359"></a>************************************************************************
<a name="line-360"></a>
<a name="line-361"></a>Note [coreView vs tcView]
<a name="line-362"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-363"></a>So far as the typechecker is concerned, 'Constraint' and 'TYPE
<a name="line-364"></a>LiftedRep' are distinct kinds.
<a name="line-365"></a>
<a name="line-366"></a>But in Core these two are treated as identical.
<a name="line-367"></a>
<a name="line-368"></a>We implement this by making 'coreView' convert 'Constraint' to 'TYPE
<a name="line-369"></a>LiftedRep' on the fly.  The function tcView (used in the type checker)
<a name="line-370"></a>does not do this. Accordingly, tcView is used in type-checker-oriented
<a name="line-371"></a>functions (including the pure unifier, used in instance resolution),
<a name="line-372"></a>while coreView is used during e.g. optimisation passes.
<a name="line-373"></a>
<a name="line-374"></a>See also #11715, which tracks removing this inconsistency.
<a name="line-375"></a>
<a name="line-376"></a>The inconsistency actually leads to a potential soundness bug, in that
<a name="line-377"></a>Constraint and Type are considered *apart* by the type family engine.
<a name="line-378"></a>To wit, we can write
<a name="line-379"></a>
<a name="line-380"></a>  type family F a
<a name="line-381"></a>  type instance F Type = Bool
<a name="line-382"></a>  type instance F Constraint = Int
<a name="line-383"></a>
<a name="line-384"></a>and (because Type ~# Constraint in Core), thus build a coercion between
<a name="line-385"></a>Int and Bool. I (Richard E) conjecture that this never happens in practice,
<a name="line-386"></a>but it's very uncomfortable. This, essentially, is the root problem
<a name="line-387"></a>underneath #11715, which is quite resistant to an easy fix. The best
<a name="line-388"></a>idea is to have roles in kind coercions, but that has yet to be implemented.
<a name="line-389"></a>See also "A Role for Dependent Types in Haskell", ICFP 2019, which describes
<a name="line-390"></a>how roles in kinds might work out.
<a name="line-391"></a>
<a name="line-392"></a>-}</span>
<a name="line-393"></a>
<a name="line-394"></a><a name="tcView"></a><span class='hs-comment'>-- | Gives the typechecker view of a type. This unwraps synonyms but</span>
<a name="line-395"></a><span class='hs-comment'>-- leaves 'Constraint' alone. c.f. 'coreView', which turns 'Constraint' into</span>
<a name="line-396"></a><span class='hs-comment'>-- 'Type'. Returns 'Nothing' if no unwrapping happens.</span>
<a name="line-397"></a><span class='hs-comment'>-- See also Note [coreView vs tcView]</span>
<a name="line-398"></a><span class='hs-definition'>tcView</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-399"></a><span class='hs-definition'>tcView</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-400"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>res</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>expandSynTyConApp_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-401"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res</span>
<a name="line-402"></a><span class='hs-definition'>tcView</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-403"></a><span class='hs-comment'>-- See Note [Inlining coreView].</span>
<a name="line-404"></a><span class='hs-comment'>{-# INLINE tcView #-}</span>
<a name="line-405"></a>
<a name="line-406"></a><a name="coreView"></a><span class='hs-definition'>coreView</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-407"></a><span class='hs-comment'>-- ^ This function strips off the /top layer only/ of a type synonym</span>
<a name="line-408"></a><span class='hs-comment'>-- application (if any) its underlying representation type.</span>
<a name="line-409"></a><span class='hs-comment'>-- Returns 'Nothing' if there is nothing to look through.</span>
<a name="line-410"></a><span class='hs-comment'>-- This function considers 'Constraint' to be a synonym of @Type@.</span>
<a name="line-411"></a><span class='hs-comment'>--</span>
<a name="line-412"></a><span class='hs-comment'>-- By being non-recursive and inlined, this case analysis gets efficiently</span>
<a name="line-413"></a><span class='hs-comment'>-- joined onto the case analysis that the caller is already doing</span>
<a name="line-414"></a><span class='hs-definition'>coreView</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-415"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>res</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>expandSynTyConApp_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-416"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res</span>
<a name="line-417"></a>
<a name="line-418"></a>  <span class='hs-comment'>-- At the Core level, Constraint = Type</span>
<a name="line-419"></a>  <span class='hs-comment'>-- See Note [coreView vs tcView]</span>
<a name="line-420"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isConstraintKindCon</span> <span class='hs-varid'>tc</span>
<a name="line-421"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>)</span>
<a name="line-422"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-423"></a>
<a name="line-424"></a><span class='hs-definition'>coreView</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-425"></a><span class='hs-comment'>-- See Note [Inlining coreView].</span>
<a name="line-426"></a><span class='hs-comment'>{-# INLINE coreView #-}</span>
<a name="line-427"></a>
<a name="line-428"></a><span class='hs-comment'>-----------------------------------------------</span>
<a name="line-429"></a>
<a name="line-430"></a><a name="expandSynTyConApp_maybe"></a><span class='hs-comment'>-- | @expandSynTyConApp_maybe tc tys@ expands the RHS of type synonym @tc@</span>
<a name="line-431"></a><span class='hs-comment'>-- instantiated at arguments @tys@, or returns 'Nothing' if @tc@ is not a</span>
<a name="line-432"></a><span class='hs-comment'>-- synonym.</span>
<a name="line-433"></a><span class='hs-definition'>expandSynTyConApp_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-434"></a><span class='hs-definition'>expandSynTyConApp_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-435"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>synTyConDefn_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-436"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`lengthAtLeast`</span> <span class='hs-varid'>arity</span>
<a name="line-437"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>expand_syn</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-438"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-439"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-440"></a>  <span class='hs-keyword'>where</span>
<a name="line-441"></a>    <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span>
<a name="line-442"></a><span class='hs-comment'>-- Without this INLINE the call to expandSynTyConApp_maybe in coreView</span>
<a name="line-443"></a><span class='hs-comment'>-- will result in an avoidable allocation.</span>
<a name="line-444"></a><span class='hs-comment'>{-# INLINE expandSynTyConApp_maybe #-}</span>
<a name="line-445"></a>
<a name="line-446"></a><a name="expand_syn"></a><span class='hs-comment'>-- | A helper for 'expandSynTyConApp_maybe' to avoid inlining this cold path</span>
<a name="line-447"></a><span class='hs-comment'>-- into call-sites.</span>
<a name="line-448"></a><span class='hs-definition'>expand_syn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>      <span class='hs-comment'>-- ^ the arity of the synonym</span>
<a name="line-449"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- ^ the variables bound by the synonym</span>
<a name="line-450"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>     <span class='hs-comment'>-- ^ the RHS of the synonym</span>
<a name="line-451"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- ^ the type arguments the synonym is instantiated at.</span>
<a name="line-452"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-453"></a><span class='hs-definition'>expand_syn</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>tys</span>
<a name="line-454"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`lengthExceeds`</span> <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppTys</span> <span class='hs-varid'>rhs'</span> <span class='hs-layout'>(</span><span class='hs-varid'>drop</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-455"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs'</span>
<a name="line-456"></a>  <span class='hs-keyword'>where</span>
<a name="line-457"></a>    <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTvSubstPrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span>
<a name="line-458"></a>               <span class='hs-comment'>-- The free vars of 'rhs' should all be bound by 'tenv', so it's</span>
<a name="line-459"></a>               <span class='hs-comment'>-- ok to use 'substTy' here (which is what expandSynTyConApp_maybe does).</span>
<a name="line-460"></a>               <span class='hs-comment'>-- See also Note [The substitution invariant] in GHC.Core.TyCo.Subst.</span>
<a name="line-461"></a>               <span class='hs-comment'>-- Its important to use mkAppTys, rather than (foldl AppTy),</span>
<a name="line-462"></a>               <span class='hs-comment'>-- because the function part might well return a</span>
<a name="line-463"></a>               <span class='hs-comment'>-- partially-applied type constructor; indeed, usually will!</span>
<a name="line-464"></a><span class='hs-comment'>-- We never want to inline this cold-path.</span>
<a name="line-465"></a><span class='hs-comment'>{-# INLINE expand_syn #-}</span>
<a name="line-466"></a>
<a name="line-467"></a><a name="coreFullView"></a><span class='hs-definition'>coreFullView</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-468"></a><span class='hs-comment'>-- ^ Iterates 'coreView' until there is no more to synonym to expand.</span>
<a name="line-469"></a><span class='hs-comment'>-- See Note [Inlining coreView].</span>
<a name="line-470"></a><span class='hs-definition'>coreFullView</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-471"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTypeSynonymTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isConstraintKindCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-472"></a>  <span class='hs-keyword'>where</span>
<a name="line-473"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-474"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty'</span>
<a name="line-475"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-476"></a>
<a name="line-477"></a><span class='hs-definition'>coreFullView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-478"></a><span class='hs-comment'>{-# INLINE coreFullView #-}</span>
<a name="line-479"></a>
<a name="line-480"></a><span class='hs-comment'>{- Note [Inlining coreView]
<a name="line-481"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-482"></a>It is very common to have a function
<a name="line-483"></a>
<a name="line-484"></a>  f :: Type -&gt; ...
<a name="line-485"></a>  f ty | Just ty' &lt;- coreView ty = f ty'
<a name="line-486"></a>  f (TyVarTy ...) = ...
<a name="line-487"></a>  f ...           = ...
<a name="line-488"></a>
<a name="line-489"></a>If f is not otherwise recursive, the initial call to coreView
<a name="line-490"></a>causes f to become recursive, which kills the possibility of
<a name="line-491"></a>inlining. Instead, for non-recursive functions, we prefer to
<a name="line-492"></a>use coreFullView, which guarantees to unwrap top-level type
<a name="line-493"></a>synonyms. It can be inlined and is efficient and non-allocating
<a name="line-494"></a>in its fast path. For this to really be fast, all calls made
<a name="line-495"></a>on its fast path must also be inlined, linked back to this Note.
<a name="line-496"></a>-}</span>
<a name="line-497"></a>
<a name="line-498"></a><a name="expandTypeSynonyms"></a><span class='hs-comment'>-----------------------------------------------</span>
<a name="line-499"></a><span class='hs-definition'>expandTypeSynonyms</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-500"></a><span class='hs-comment'>-- ^ Expand out all type synonyms.  Actually, it'd suffice to expand out</span>
<a name="line-501"></a><span class='hs-comment'>-- just the ones that discard type variables (e.g.  type Funny a = Int)</span>
<a name="line-502"></a><span class='hs-comment'>-- But we don't know which those are currently, so we just expand all.</span>
<a name="line-503"></a><span class='hs-comment'>--</span>
<a name="line-504"></a><span class='hs-comment'>-- 'expandTypeSynonyms' only expands out type synonyms mentioned in the type,</span>
<a name="line-505"></a><span class='hs-comment'>-- not in the kinds of any TyCon or TyVar mentioned in the type.</span>
<a name="line-506"></a><span class='hs-comment'>--</span>
<a name="line-507"></a><span class='hs-comment'>-- Keep this synchronized with 'synonymTyConsOfType'</span>
<a name="line-508"></a><span class='hs-definition'>expandTypeSynonyms</span> <span class='hs-varid'>ty</span>
<a name="line-509"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-varid'>in_scope</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-510"></a>  <span class='hs-keyword'>where</span>
<a name="line-511"></a>    <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-512"></a>
<a name="line-513"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-514"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>expandSynTyCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>expanded_tys</span>
<a name="line-515"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarEnv</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span>
<a name="line-516"></a>            <span class='hs-comment'>-- Make a fresh substitution; rhs has nothing to</span>
<a name="line-517"></a>            <span class='hs-comment'>-- do with anything that has happened so far</span>
<a name="line-518"></a>            <span class='hs-comment'>-- NB: if you make changes here, be sure to build an</span>
<a name="line-519"></a>            <span class='hs-comment'>--     /idempotent/ substitution, even in the nested case</span>
<a name="line-520"></a>            <span class='hs-comment'>--        type T a b = a -&gt; b</span>
<a name="line-521"></a>            <span class='hs-comment'>--        type S x y = T y x</span>
<a name="line-522"></a>            <span class='hs-comment'>-- (#11665)</span>
<a name="line-523"></a>        <span class='hs-keyword'>in</span>  <span class='hs-varid'>mkAppTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys'</span>
<a name="line-524"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-525"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>expanded_tys</span>
<a name="line-526"></a>      <span class='hs-keyword'>where</span>
<a name="line-527"></a>        <span class='hs-varid'>expanded_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-528"></a>
<a name="line-529"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>     <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LitTy</span> <span class='hs-varid'>l</span>
<a name="line-530"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-531"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-532"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>mult</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-533"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_mult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>mult</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-534"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-535"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substVarBndrUsing</span> <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>in</span>
<a name="line-536"></a>        <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv'</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-537"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCastTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-538"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoercionTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-539"></a>
<a name="line-540"></a>    <span class='hs-varid'>go_mco</span> <span class='hs-keyword'>_</span>     <span class='hs-conid'>MRefl</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MRefl</span>
<a name="line-541"></a>    <span class='hs-varid'>go_mco</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-542"></a>
<a name="line-543"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-544"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNomReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-545"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>mco</span><span class='hs-layout'>)</span>
<a name="line-546"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkGReflCo</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_mco</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>mco</span><span class='hs-layout'>)</span>
<a name="line-547"></a>       <span class='hs-comment'>-- NB: coercions are always expanded upon creation</span>
<a name="line-548"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-549"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-550"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-551"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-552"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-553"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind_co'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_cobndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-keyword'>in</span>
<a name="line-554"></a>        <span class='hs-varid'>mkForAllCo</span> <span class='hs-varid'>tv'</span> <span class='hs-varid'>kind_co'</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-555"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>w</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-556"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunCo</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-557"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-558"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCoVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cv</span>
<a name="line-559"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-560"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-561"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-varid'>r</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-562"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnivCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_prov</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-563"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-564"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-565"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-566"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTransCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-567"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-568"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-569"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-570"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-571"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-572"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInstCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-573"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-574"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-575"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-576"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSubCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-577"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>
<a name="line-578"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>
<a name="line-579"></a>    <span class='hs-varid'>go_co</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleCo</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>
<a name="line-580"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"expandTypeSynonyms hit a hole"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>
<a name="line-581"></a>
<a name="line-582"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PhantomProv</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-583"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ProofIrrelProv</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-584"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-keyword'>_</span>     <span class='hs-varid'>p</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p</span>
<a name="line-585"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-keyword'>_</span>     <span class='hs-varid'>p</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CorePrepProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p</span>
<a name="line-586"></a>
<a name="line-587"></a>      <span class='hs-comment'>-- the "False" and "const" are to accommodate the type of</span>
<a name="line-588"></a>      <span class='hs-comment'>-- substForAllCoBndrUsing, which is general enough to</span>
<a name="line-589"></a>      <span class='hs-comment'>-- handle coercion optimization (which sometimes swaps the</span>
<a name="line-590"></a>      <span class='hs-comment'>-- order of a coercion)</span>
<a name="line-591"></a>    <span class='hs-varid'>go_cobndr</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substForAllCoBndrUsing</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span>
<a name="line-592"></a>
<a name="line-593"></a><a name="isTyConKeyApp_maybe"></a><span class='hs-comment'>-- | An INLINE helper for function such as 'kindRep_maybe' below.</span>
<a name="line-594"></a><span class='hs-comment'>--</span>
<a name="line-595"></a><span class='hs-comment'>-- @isTyConKeyApp_maybe key ty@ returns @Just tys@ iff</span>
<a name="line-596"></a><span class='hs-comment'>-- the type @ty = T tys@, where T's unique = key</span>
<a name="line-597"></a><span class='hs-definition'>isTyConKeyApp_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-598"></a><span class='hs-definition'>isTyConKeyApp_maybe</span> <span class='hs-varid'>key</span> <span class='hs-varid'>ty</span>
<a name="line-599"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>ty</span>
<a name="line-600"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>key</span>
<a name="line-601"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>args</span>
<a name="line-602"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-603"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-604"></a><span class='hs-comment'>{-# INLINE isTyConKeyApp_maybe #-}</span>
<a name="line-605"></a>
<a name="line-606"></a><a name="kindRep"></a><span class='hs-comment'>-- | Extract the RuntimeRep classifier of a type from its kind. For example,</span>
<a name="line-607"></a><span class='hs-comment'>-- @kindRep * = LiftedRep@; Panics if this is not possible.</span>
<a name="line-608"></a><span class='hs-comment'>-- Treats * and Constraint as the same</span>
<a name="line-609"></a><span class='hs-definition'>kindRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-610"></a><span class='hs-definition'>kindRep</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>kindRep_maybe</span> <span class='hs-varid'>k</span> <span class='hs-keyword'>of</span>
<a name="line-611"></a>              <span class='hs-conid'>Just</span> <span class='hs-varid'>r</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>r</span>
<a name="line-612"></a>              <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"kindRep"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-613"></a>
<a name="line-614"></a><a name="kindRep_maybe"></a><span class='hs-comment'>-- | Given a kind (TYPE rr), extract its RuntimeRep classifier rr.</span>
<a name="line-615"></a><span class='hs-comment'>-- For example, @kindRep_maybe * = Just LiftedRep@</span>
<a name="line-616"></a><span class='hs-comment'>-- Returns 'Nothing' if the kind is not of form (TYPE rr)</span>
<a name="line-617"></a><span class='hs-comment'>-- Treats * and Constraint as the same</span>
<a name="line-618"></a><span class='hs-definition'>kindRep_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-619"></a><span class='hs-definition'>kindRep_maybe</span> <span class='hs-varid'>kind</span>
<a name="line-620"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isTyConKeyApp_maybe</span> <span class='hs-varid'>tYPETyConKey</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>arg</span>
<a name="line-621"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-622"></a>
<a name="line-623"></a><a name="isBoxedTypeKind"></a><span class='hs-comment'>-- | Returns True if the kind classifies types which are allocated on</span>
<a name="line-624"></a><span class='hs-comment'>-- the GC'd heap and False otherwise. Note that this returns False for</span>
<a name="line-625"></a><span class='hs-comment'>-- levity-polymorphic kinds, which may be specialized to a kind that</span>
<a name="line-626"></a><span class='hs-comment'>-- classifies AddrRep or even unboxed kinds.</span>
<a name="line-627"></a><span class='hs-definition'>isBoxedTypeKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-628"></a><span class='hs-definition'>isBoxedTypeKind</span> <span class='hs-varid'>kind</span>
<a name="line-629"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>kindRep_maybe</span> <span class='hs-varid'>kind</span> <span class='hs-keyword'>of</span>
<a name="line-630"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>rep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isBoxedRuntimeRep</span> <span class='hs-varid'>rep</span>
<a name="line-631"></a>      <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-632"></a>
<a name="line-633"></a><a name="isLiftedTypeKind"></a><span class='hs-comment'>-- | This version considers Constraint to be the same as *. Returns True</span>
<a name="line-634"></a><span class='hs-comment'>-- if the argument is equivalent to Type/Constraint and False otherwise.</span>
<a name="line-635"></a><span class='hs-comment'>-- See Note [Kind Constraint and kind Type]</span>
<a name="line-636"></a><span class='hs-definition'>isLiftedTypeKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-637"></a><span class='hs-definition'>isLiftedTypeKind</span> <span class='hs-varid'>kind</span>
<a name="line-638"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>kindRep_maybe</span> <span class='hs-varid'>kind</span> <span class='hs-keyword'>of</span>
<a name="line-639"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>rep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isLiftedRuntimeRep</span> <span class='hs-varid'>rep</span>
<a name="line-640"></a>      <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-641"></a>
<a name="line-642"></a><a name="pickyIsLiftedTypeKind"></a><span class='hs-definition'>pickyIsLiftedTypeKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-643"></a><span class='hs-comment'>-- Checks whether the kind is literally</span>
<a name="line-644"></a><span class='hs-comment'>--      TYPE LiftedRep</span>
<a name="line-645"></a><span class='hs-comment'>-- or   TYPE ('BoxedRep 'Lifted)</span>
<a name="line-646"></a><span class='hs-comment'>-- or   Type</span>
<a name="line-647"></a><span class='hs-comment'>-- without expanding type synonyms or anything</span>
<a name="line-648"></a><span class='hs-comment'>-- Used only when deciding whether to suppress the ":: *" in</span>
<a name="line-649"></a><span class='hs-comment'>-- (a :: *) when printing kinded type variables</span>
<a name="line-650"></a><span class='hs-comment'>-- See Note [Suppressing * kinds] in GHC.Core.TyCo.Ppr</span>
<a name="line-651"></a><span class='hs-definition'>pickyIsLiftedTypeKind</span> <span class='hs-varid'>kind</span>
<a name="line-652"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kind</span>
<a name="line-653"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>tYPETyConKey</span>
<a name="line-654"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>rr_tc</span> <span class='hs-varid'>rr_args</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>rr_args</span> <span class='hs-keyword'>of</span>
<a name="line-655"></a>      <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rr_tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>liftedRepTyConKey</span>
<a name="line-656"></a>      <span class='hs-keyglyph'>[</span><span class='hs-varid'>rr_arg</span><span class='hs-keyglyph'>]</span>
<a name="line-657"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>rr_tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>boxedRepDataConKey</span>
<a name="line-658"></a>        <span class='hs-layout'>,</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>lev</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rr_arg</span>
<a name="line-659"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>lev</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>liftedDataConKey</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-660"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-661"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kind</span>
<a name="line-662"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>liftedTypeKindTyConKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-663"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-664"></a>
<a name="line-665"></a><a name="isUnliftedTypeKind"></a><span class='hs-comment'>-- | Returns True if the kind classifies unlifted types (like 'Int#') and False</span>
<a name="line-666"></a><span class='hs-comment'>-- otherwise. Note that this returns False for levity-polymorphic kinds, which</span>
<a name="line-667"></a><span class='hs-comment'>-- may be specialized to a kind that classifies unlifted types.</span>
<a name="line-668"></a><span class='hs-definition'>isUnliftedTypeKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-669"></a><span class='hs-definition'>isUnliftedTypeKind</span> <span class='hs-varid'>kind</span>
<a name="line-670"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>kindRep_maybe</span> <span class='hs-varid'>kind</span> <span class='hs-keyword'>of</span>
<a name="line-671"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>rep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isUnliftedRuntimeRep</span> <span class='hs-varid'>rep</span>
<a name="line-672"></a>      <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-673"></a>
<a name="line-674"></a><a name="isBoxedRuntimeRep"></a><span class='hs-comment'>-- | See 'isBoxedRuntimeRep_maybe'.</span>
<a name="line-675"></a><span class='hs-definition'>isBoxedRuntimeRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-676"></a><span class='hs-definition'>isBoxedRuntimeRep</span> <span class='hs-varid'>rep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>isBoxedRuntimeRep_maybe</span> <span class='hs-varid'>rep</span><span class='hs-layout'>)</span>
<a name="line-677"></a>
<a name="line-678"></a><a name="isBoxedRuntimeRep_maybe"></a><span class='hs-comment'>-- | `isBoxedRuntimeRep_maybe (rep :: RuntimeRep)` returns `Just lev` if `rep`</span>
<a name="line-679"></a><span class='hs-comment'>-- expands to `Boxed lev` and returns `Nothing` otherwise.</span>
<a name="line-680"></a><span class='hs-comment'>--</span>
<a name="line-681"></a><span class='hs-comment'>-- Types with this runtime rep are represented by pointers on the GC'd heap.</span>
<a name="line-682"></a><span class='hs-definition'>isBoxedRuntimeRep_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-683"></a><span class='hs-definition'>isBoxedRuntimeRep_maybe</span> <span class='hs-varid'>rep</span>
<a name="line-684"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>lev</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isTyConKeyApp_maybe</span> <span class='hs-varid'>boxedRepDataConKey</span> <span class='hs-varid'>rep</span>
<a name="line-685"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>lev</span>
<a name="line-686"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-687"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-688"></a>
<a name="line-689"></a><a name="isLiftedRuntimeRep"></a><span class='hs-definition'>isLiftedRuntimeRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-690"></a><span class='hs-comment'>-- isLiftedRuntimeRep is true of LiftedRep :: RuntimeRep</span>
<a name="line-691"></a><span class='hs-comment'>-- False of type variables (a :: RuntimeRep)</span>
<a name="line-692"></a><span class='hs-comment'>--   and of other reps e.g. (IntRep :: RuntimeRep)</span>
<a name="line-693"></a><span class='hs-definition'>isLiftedRuntimeRep</span> <span class='hs-varid'>rep</span>
<a name="line-694"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>lev</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isTyConKeyApp_maybe</span> <span class='hs-varid'>boxedRepDataConKey</span> <span class='hs-varid'>rep</span>
<a name="line-695"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isLiftedLevity</span> <span class='hs-varid'>lev</span>
<a name="line-696"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-697"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-698"></a>
<a name="line-699"></a><a name="isUnliftedRuntimeRep"></a><span class='hs-definition'>isUnliftedRuntimeRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-700"></a><span class='hs-comment'>-- PRECONDITION: The type has kind RuntimeRep</span>
<a name="line-701"></a><span class='hs-comment'>-- True of definitely-unlifted RuntimeReps</span>
<a name="line-702"></a><span class='hs-comment'>-- False of           (LiftedRep :: RuntimeRep)</span>
<a name="line-703"></a><span class='hs-comment'>--   and of variables (a :: RuntimeRep)</span>
<a name="line-704"></a><span class='hs-definition'>isUnliftedRuntimeRep</span> <span class='hs-varid'>rep</span>
<a name="line-705"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>rr_tc</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>rep</span> <span class='hs-comment'>-- NB: args might be non-empty</span>
<a name="line-706"></a>                                            <span class='hs-comment'>--     e.g. TupleRep [r1, .., rn]</span>
<a name="line-707"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isPromotedDataCon</span> <span class='hs-varid'>rr_tc</span> <span class='hs-keyglyph'>=</span>
<a name="line-708"></a>      <span class='hs-comment'>-- NB: args might be non-empty e.g. TupleRep [r1, .., rn]</span>
<a name="line-709"></a>      <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>rr_tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>boxedRepDataConKey</span><span class='hs-layout'>)</span>
<a name="line-710"></a>        <span class='hs-keyword'>then</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>args</span> <span class='hs-keyword'>of</span>
<a name="line-711"></a>          <span class='hs-keyglyph'>[</span><span class='hs-varid'>lev</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isUnliftedLevity</span> <span class='hs-varid'>lev</span>
<a name="line-712"></a>          <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-713"></a>        <span class='hs-keyword'>else</span> <span class='hs-conid'>True</span>
<a name="line-714"></a>        <span class='hs-comment'>-- Avoid searching all the unlifted RuntimeRep type cons</span>
<a name="line-715"></a>        <span class='hs-comment'>-- In the RuntimeRep data type, only LiftedRep is lifted</span>
<a name="line-716"></a>        <span class='hs-comment'>-- But be careful of type families (F tys) :: RuntimeRep,</span>
<a name="line-717"></a>        <span class='hs-comment'>-- hence the isPromotedDataCon rr_tc</span>
<a name="line-718"></a><span class='hs-definition'>isUnliftedRuntimeRep</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-719"></a>
<a name="line-720"></a><a name="isNullaryTyConKeyApp"></a><span class='hs-comment'>-- | An INLINE helper for function such as 'isLiftedRuntimeRep' below.</span>
<a name="line-721"></a><span class='hs-definition'>isNullaryTyConKeyApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-722"></a><span class='hs-definition'>isNullaryTyConKeyApp</span> <span class='hs-varid'>key</span> <span class='hs-varid'>ty</span>
<a name="line-723"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isTyConKeyApp_maybe</span> <span class='hs-varid'>key</span> <span class='hs-varid'>ty</span>
<a name="line-724"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>args</span> <span class='hs-layout'>)</span> <span class='hs-conid'>True</span>
<a name="line-725"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-726"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-727"></a><span class='hs-comment'>{-# INLINE isNullaryTyConKeyApp #-}</span>
<a name="line-728"></a>
<a name="line-729"></a><a name="isLiftedLevity"></a><span class='hs-definition'>isLiftedLevity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-730"></a><span class='hs-definition'>isLiftedLevity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNullaryTyConKeyApp</span> <span class='hs-varid'>liftedDataConKey</span>
<a name="line-731"></a>
<a name="line-732"></a><a name="isUnliftedLevity"></a><span class='hs-definition'>isUnliftedLevity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-733"></a><span class='hs-definition'>isUnliftedLevity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNullaryTyConKeyApp</span> <span class='hs-varid'>unliftedDataConKey</span>
<a name="line-734"></a>
<a name="line-735"></a><a name="isLevityTy"></a><span class='hs-comment'>-- | Is this the type 'Levity'?</span>
<a name="line-736"></a><span class='hs-definition'>isLevityTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-737"></a><span class='hs-definition'>isLevityTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNullaryTyConKeyApp</span> <span class='hs-varid'>levityTyConKey</span>
<a name="line-738"></a>
<a name="line-739"></a><a name="isRuntimeRepTy"></a><span class='hs-comment'>-- | Is this the type 'RuntimeRep'?</span>
<a name="line-740"></a><span class='hs-definition'>isRuntimeRepTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-741"></a><span class='hs-definition'>isRuntimeRepTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNullaryTyConKeyApp</span> <span class='hs-varid'>runtimeRepTyConKey</span>
<a name="line-742"></a>
<a name="line-743"></a><a name="isRuntimeRepVar"></a><span class='hs-comment'>-- | Is a tyvar of type 'RuntimeRep'?</span>
<a name="line-744"></a><span class='hs-definition'>isRuntimeRepVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-745"></a><span class='hs-definition'>isRuntimeRepVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isRuntimeRepTy</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyVarKind</span>
<a name="line-746"></a>
<a name="line-747"></a><a name="isLevityVar"></a><span class='hs-comment'>-- | Is a tyvar of type 'Levity'?</span>
<a name="line-748"></a><span class='hs-definition'>isLevityVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-749"></a><span class='hs-definition'>isLevityVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isLevityTy</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyVarKind</span>
<a name="line-750"></a>
<a name="line-751"></a><a name="isMultiplicityTy"></a><span class='hs-comment'>-- | Is this the type 'Multiplicity'?</span>
<a name="line-752"></a><span class='hs-definition'>isMultiplicityTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-753"></a><span class='hs-definition'>isMultiplicityTy</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNullaryTyConKeyApp</span> <span class='hs-varid'>multiplicityTyConKey</span>
<a name="line-754"></a>
<a name="line-755"></a><a name="isMultiplicityVar"></a><span class='hs-comment'>-- | Is a tyvar of type 'Multiplicity'?</span>
<a name="line-756"></a><span class='hs-definition'>isMultiplicityVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-757"></a><span class='hs-definition'>isMultiplicityVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isMultiplicityTy</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyVarKind</span>
<a name="line-758"></a>
<a name="line-759"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-760"></a>*                                                                      *
<a name="line-761"></a>               mapType
<a name="line-762"></a>*                                                                      *
<a name="line-763"></a>************************************************************************
<a name="line-764"></a>
<a name="line-765"></a>These functions do a map-like operation over types, performing some operation
<a name="line-766"></a>on all variables and binding sites. Primarily used for zonking.
<a name="line-767"></a>
<a name="line-768"></a>Note [Efficiency for ForAllCo case of mapTyCoX]
<a name="line-769"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-770"></a>As noted in Note [Forall coercions] in GHC.Core.TyCo.Rep, a ForAllCo is a bit redundant.
<a name="line-771"></a>It stores a TyCoVar and a Coercion, where the kind of the TyCoVar always matches
<a name="line-772"></a>the left-hand kind of the coercion. This is convenient lots of the time, but
<a name="line-773"></a>not when mapping a function over a coercion.
<a name="line-774"></a>
<a name="line-775"></a>The problem is that tcm_tybinder will affect the TyCoVar's kind and
<a name="line-776"></a>mapCoercion will affect the Coercion, and we hope that the results will be
<a name="line-777"></a>the same. Even if they are the same (which should generally happen with
<a name="line-778"></a>correct algorithms), then there is an efficiency issue. In particular,
<a name="line-779"></a>this problem seems to make what should be a linear algorithm into a potentially
<a name="line-780"></a>exponential one. But it's only going to be bad in the case where there's
<a name="line-781"></a>lots of foralls in the kinds of other foralls. Like this:
<a name="line-782"></a>
<a name="line-783"></a>  forall a : (forall b : (forall c : ...). ...). ...
<a name="line-784"></a>
<a name="line-785"></a>This construction seems unlikely. So we'll do the inefficient, easy way
<a name="line-786"></a>for now.
<a name="line-787"></a>
<a name="line-788"></a>Note [Specialising mappers]
<a name="line-789"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-790"></a>These INLINE pragmas are indispensable. mapTyCo and mapTyCoX are used
<a name="line-791"></a>to implement zonking, and it's vital that they get specialised to the TcM
<a name="line-792"></a>monad and the particular mapper in use.
<a name="line-793"></a>
<a name="line-794"></a>Even specialising to the monad alone made a 20% allocation difference
<a name="line-795"></a>in perf/compiler/T5030.
<a name="line-796"></a>
<a name="line-797"></a>See Note [Specialising foldType] in "GHC.Core.TyCo.Rep" for more details of this
<a name="line-798"></a>idiom.
<a name="line-799"></a>-}</span>
<a name="line-800"></a>
<a name="line-801"></a><a name="TyCoMapper"></a><span class='hs-comment'>-- | This describes how a "map" operation over a type/coercion should behave</span>
<a name="line-802"></a><a name="TyCoMapper"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TyCoMapper</span> <span class='hs-varid'>env</span> <span class='hs-varid'>m</span>
<a name="line-803"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyCoMapper</span>
<a name="line-804"></a>      <span class='hs-layout'>{</span> <span class='hs-varid'>tcm_tyvar</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Type</span>
<a name="line-805"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>tcm_covar</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Coercion</span>
<a name="line-806"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>tcm_hole</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionHole</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Coercion</span>
<a name="line-807"></a>          <span class='hs-comment'>-- ^ What to do with coercion holes.</span>
<a name="line-808"></a>          <span class='hs-comment'>-- See Note [Coercion holes] in "GHC.Core.TyCo.Rep".</span>
<a name="line-809"></a>
<a name="line-810"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>tcm_tycobinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArgFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoVar</span><span class='hs-layout'>)</span>
<a name="line-811"></a>          <span class='hs-comment'>-- ^ The returned env is used in the extended scope</span>
<a name="line-812"></a>
<a name="line-813"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>tcm_tycon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>TyCon</span>
<a name="line-814"></a>          <span class='hs-comment'>-- ^ This is used only for TcTyCons</span>
<a name="line-815"></a>          <span class='hs-comment'>-- a) To zonk TcTyCons</span>
<a name="line-816"></a>          <span class='hs-comment'>-- b) To turn TcTyCons into TyCons.</span>
<a name="line-817"></a>          <span class='hs-comment'>--    See Note [Type checking recursive type and class declarations]</span>
<a name="line-818"></a>          <span class='hs-comment'>--    in "GHC.Tc.TyCl"</span>
<a name="line-819"></a>      <span class='hs-layout'>}</span>
<a name="line-820"></a>
<a name="line-821"></a><span class='hs-comment'>{-# INLINE mapTyCo #-}</span>  <span class='hs-comment'>-- See Note [Specialising mappers]</span>
<a name="line-822"></a><a name="mapTyCo"></a><span class='hs-definition'>mapTyCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TyCoMapper</span> <span class='hs-conid'>()</span> <span class='hs-varid'>m</span>
<a name="line-823"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Type</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Type</span>
<a name="line-824"></a>            <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-825"></a>            <span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Coercion</span>
<a name="line-826"></a>            <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-827"></a><span class='hs-definition'>mapTyCo</span> <span class='hs-varid'>mapper</span>
<a name="line-828"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mapTyCoX</span> <span class='hs-varid'>mapper</span> <span class='hs-keyword'>of</span>
<a name="line-829"></a>     <span class='hs-layout'>(</span><span class='hs-varid'>go_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>go_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>go_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>go_cos</span><span class='hs-layout'>)</span>
<a name="line-830"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_ty</span> <span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-varid'>go_tys</span> <span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-varid'>go_co</span> <span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-varid'>go_cos</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-831"></a>
<a name="line-832"></a><span class='hs-comment'>{-# INLINE mapTyCoX #-}</span>  <span class='hs-comment'>-- See Note [Specialising mappers]</span>
<a name="line-833"></a><a name="mapTyCoX"></a><span class='hs-definition'>mapTyCoX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TyCoMapper</span> <span class='hs-varid'>env</span> <span class='hs-varid'>m</span>
<a name="line-834"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Type</span>
<a name="line-835"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-836"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Coercion</span>
<a name="line-837"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-838"></a><span class='hs-definition'>mapTyCoX</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCoMapper</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcm_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyvar</span>
<a name="line-839"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>tcm_tycobinder</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tycobinder</span>
<a name="line-840"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>tcm_tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tycon</span>
<a name="line-841"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>tcm_covar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>covar</span>
<a name="line-842"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>tcm_hole</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cohole</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-843"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>go_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>go_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>go_cos</span><span class='hs-layout'>)</span>
<a name="line-844"></a>  <span class='hs-keyword'>where</span>
<a name="line-845"></a>    <span class='hs-varid'>go_tys</span> <span class='hs-keyword'>_</span>   <span class='hs-conid'>[]</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-846"></a>    <span class='hs-varid'>go_tys</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>go_tys</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tys</span>
<a name="line-847"></a>
<a name="line-848"></a>    <span class='hs-varid'>go_ty</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span>
<a name="line-849"></a>    <span class='hs-varid'>go_ty</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t2</span>
<a name="line-850"></a>    <span class='hs-varid'>go_ty</span> <span class='hs-keyword'>_</span>   <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>
<a name="line-851"></a>    <span class='hs-varid'>go_ty</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCastTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span>
<a name="line-852"></a>    <span class='hs-varid'>go_ty</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoercionTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span>
<a name="line-853"></a>
<a name="line-854"></a>    <span class='hs-varid'>go_ty</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-855"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>w'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>env</span> <span class='hs-varid'>w</span><span class='hs-layout'>;</span> <span class='hs-varid'>arg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>env</span> <span class='hs-varid'>arg</span><span class='hs-layout'>;</span> <span class='hs-varid'>res'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>env</span> <span class='hs-varid'>res</span>
<a name="line-856"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_mult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-857"></a>
<a name="line-858"></a>    <span class='hs-varid'>go_ty</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-859"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTcTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-860"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tc'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tc</span>
<a name="line-861"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc'</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_tys</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span>
<a name="line-862"></a>
<a name="line-863"></a>      <span class='hs-comment'>-- Not a TcTyCon</span>
<a name="line-864"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>tys</span>    <span class='hs-comment'>-- Avoid allocation in this very</span>
<a name="line-865"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>   <span class='hs-comment'>-- common case (E.g. Int, LiftedRep etc)</span>
<a name="line-866"></a>
<a name="line-867"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-868"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_tys</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tys</span>
<a name="line-869"></a>
<a name="line-870"></a>    <span class='hs-varid'>go_ty</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-varid'>inner</span><span class='hs-layout'>)</span>
<a name="line-871"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tycobinder</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span>
<a name="line-872"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>inner'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>inner</span>
<a name="line-873"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv'</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-varid'>inner'</span> <span class='hs-layout'>}</span>
<a name="line-874"></a>
<a name="line-875"></a>    <span class='hs-varid'>go_cos</span> <span class='hs-keyword'>_</span>   <span class='hs-conid'>[]</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-876"></a>    <span class='hs-varid'>go_cos</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-conop'>:</span><span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>go_cos</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cos</span>
<a name="line-877"></a>
<a name="line-878"></a>    <span class='hs-varid'>go_mco</span> <span class='hs-keyword'>_</span>   <span class='hs-conid'>MRefl</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>MRefl</span>
<a name="line-879"></a>    <span class='hs-varid'>go_mco</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-880"></a>
<a name="line-881"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-882"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>mco</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkGReflCo</span> <span class='hs-varid'>r</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>go_mco</span> <span class='hs-varid'>env</span> <span class='hs-varid'>mco</span>
<a name="line-883"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>c2</span>
<a name="line-884"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>cw</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunCo</span> <span class='hs-varid'>r</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cw</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>c2</span>
<a name="line-885"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>covar</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cv</span>
<a name="line-886"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleCo</span> <span class='hs-varid'>hole</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cohole</span> <span class='hs-varid'>env</span> <span class='hs-varid'>hole</span>
<a name="line-887"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-varid'>r</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnivCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_prov</span> <span class='hs-varid'>env</span> <span class='hs-varid'>p</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>r</span>
<a name="line-888"></a>                                    <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t2</span>
<a name="line-889"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span>
<a name="line-890"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTransCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>c2</span>
<a name="line-891"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>r</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_cos</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cos</span>
<a name="line-892"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>i</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span>
<a name="line-893"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span>
<a name="line-894"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInstCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>arg</span>
<a name="line-895"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span>
<a name="line-896"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSubCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span>
<a name="line-897"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>i</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_cos</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cos</span>
<a name="line-898"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-899"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTcTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-900"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tc'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tc</span>
<a name="line-901"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc'</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_cos</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cos</span> <span class='hs-layout'>}</span>
<a name="line-902"></a>
<a name="line-903"></a>      <span class='hs-comment'>-- Not a TcTyCon</span>
<a name="line-904"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>cos</span>    <span class='hs-comment'>-- Avoid allocation in this very</span>
<a name="line-905"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>co</span>   <span class='hs-comment'>-- common case (E.g. Int, LiftedRep etc)</span>
<a name="line-906"></a>
<a name="line-907"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-908"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_cos</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cos</span>
<a name="line-909"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-910"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind_co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>kind_co</span>
<a name="line-911"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tycobinder</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span> <span class='hs-conid'>Inferred</span>
<a name="line-912"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>co</span>
<a name="line-913"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkForAllCo</span> <span class='hs-varid'>tv'</span> <span class='hs-varid'>kind_co'</span> <span class='hs-varid'>co'</span> <span class='hs-layout'>}</span>
<a name="line-914"></a>        <span class='hs-comment'>-- See Note [Efficiency for ForAllCo case of mapTyCoX]</span>
<a name="line-915"></a>
<a name="line-916"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PhantomProv</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span>
<a name="line-917"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span>
<a name="line-918"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-keyword'>_</span>   <span class='hs-varid'>p</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>p</span>
<a name="line-919"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-keyword'>_</span>   <span class='hs-varid'>p</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CorePrepProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>p</span>
<a name="line-920"></a>
<a name="line-921"></a>
<a name="line-922"></a><span class='hs-comment'>{-
<a name="line-923"></a>************************************************************************
<a name="line-924"></a>*                                                                      *
<a name="line-925"></a>\subsection{Constructor-specific functions}
<a name="line-926"></a>*                                                                      *
<a name="line-927"></a>************************************************************************
<a name="line-928"></a>
<a name="line-929"></a>
<a name="line-930"></a>---------------------------------------------------------------------
<a name="line-931"></a>                                TyVarTy
<a name="line-932"></a>                                ~~~~~~~
<a name="line-933"></a>-}</span>
<a name="line-934"></a>
<a name="line-935"></a><a name="getTyVar"></a><span class='hs-comment'>-- | Attempts to obtain the type variable underlying a 'Type', and panics with the</span>
<a name="line-936"></a><span class='hs-comment'>-- given message if this is not a type variable type. See also 'getTyVar_maybe'</span>
<a name="line-937"></a><span class='hs-definition'>getTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>
<a name="line-938"></a><span class='hs-definition'>getTyVar</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>getTyVar_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-939"></a>                    <span class='hs-conid'>Just</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tv</span>
<a name="line-940"></a>                    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"getTyVar: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-941"></a>
<a name="line-942"></a><a name="isTyVarTy"></a><span class='hs-definition'>isTyVarTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-943"></a><span class='hs-definition'>isTyVarTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>getTyVar_maybe</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-944"></a>
<a name="line-945"></a><a name="getTyVar_maybe"></a><span class='hs-comment'>-- | Attempts to obtain the type variable underlying a 'Type'</span>
<a name="line-946"></a><span class='hs-definition'>getTyVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TyVar</span>
<a name="line-947"></a><span class='hs-definition'>getTyVar_maybe</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>repGetTyVar_maybe</span> <span class='hs-varop'>.</span> <span class='hs-varid'>coreFullView</span>
<a name="line-948"></a>
<a name="line-949"></a><a name="getCastedTyVar_maybe"></a><span class='hs-comment'>-- | If the type is a tyvar, possibly under a cast, returns it, along</span>
<a name="line-950"></a><span class='hs-comment'>-- with the coercion. Thus, the co is :: kind tv ~N kind ty</span>
<a name="line-951"></a><span class='hs-definition'>getCastedTyVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionN</span><span class='hs-layout'>)</span>
<a name="line-952"></a><span class='hs-definition'>getCastedTyVar_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-953"></a>  <span class='hs-conid'>CastTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-954"></a>  <span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-955"></a>  <span class='hs-keyword'>_</span>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-956"></a>
<a name="line-957"></a><a name="repGetTyVar_maybe"></a><span class='hs-comment'>-- | Attempts to obtain the type variable underlying a 'Type', without</span>
<a name="line-958"></a><span class='hs-comment'>-- any expansion</span>
<a name="line-959"></a><span class='hs-definition'>repGetTyVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TyVar</span>
<a name="line-960"></a><span class='hs-definition'>repGetTyVar_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv</span>
<a name="line-961"></a><span class='hs-definition'>repGetTyVar_maybe</span> <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-962"></a>
<a name="line-963"></a><span class='hs-comment'>{-
<a name="line-964"></a>---------------------------------------------------------------------
<a name="line-965"></a>                                AppTy
<a name="line-966"></a>                                ~~~~~
<a name="line-967"></a>We need to be pretty careful with AppTy to make sure we obey the
<a name="line-968"></a>invariant that a TyConApp is always visibly so.  mkAppTy maintains the
<a name="line-969"></a>invariant: use it.
<a name="line-970"></a>
<a name="line-971"></a>Note [Decomposing fat arrow c=&gt;t]
<a name="line-972"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-973"></a>Can we unify (a b) with (Eq a =&gt; ty)?   If we do so, we end up with
<a name="line-974"></a>a partial application like ((=&gt;) Eq a) which doesn't make sense in
<a name="line-975"></a>source Haskell.  In contrast, we *can* unify (a b) with (t1 -&gt; t2).
<a name="line-976"></a>Here's an example (#9858) of how you might do it:
<a name="line-977"></a>   i :: (Typeable a, Typeable b) =&gt; Proxy (a b) -&gt; TypeRep
<a name="line-978"></a>   i p = typeRep p
<a name="line-979"></a>
<a name="line-980"></a>   j = i (Proxy :: Proxy (Eq Int =&gt; Int))
<a name="line-981"></a>The type (Proxy (Eq Int =&gt; Int)) is only accepted with -XImpredicativeTypes,
<a name="line-982"></a>but suppose we want that.  But then in the call to 'i', we end
<a name="line-983"></a>up decomposing (Eq Int =&gt; Int), and we definitely don't want that.
<a name="line-984"></a>
<a name="line-985"></a>This really only applies to the type checker; in Core, '=&gt;' and '-&gt;'
<a name="line-986"></a>are the same, as are 'Constraint' and '*'.  But for now I've put
<a name="line-987"></a>the test in repSplitAppTy_maybe, which applies throughout, because
<a name="line-988"></a>the other calls to splitAppTy are in GHC.Core.Unify, which is also used by
<a name="line-989"></a>the type checker (e.g. when matching type-function equations).
<a name="line-990"></a>
<a name="line-991"></a>-}</span>
<a name="line-992"></a>
<a name="line-993"></a><a name="mkAppTy"></a><span class='hs-comment'>-- | Applies a type to another, as in e.g. @k a@</span>
<a name="line-994"></a><span class='hs-definition'>mkAppTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-995"></a>  <span class='hs-comment'>-- See Note [Respecting definitional equality], invariant (EQ1).</span>
<a name="line-996"></a><span class='hs-definition'>mkAppTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_ty</span>
<a name="line-997"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>arg_co</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>decomposePiCos</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg_ty</span><span class='hs-keyglyph'>]</span>
<a name="line-998"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun_ty</span> <span class='hs-varop'>`mkAppTy`</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_ty</span> <span class='hs-varop'>`mkCastTy`</span> <span class='hs-varid'>arg_co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>`mkCastTy`</span> <span class='hs-varid'>res_co</span>
<a name="line-999"></a>
<a name="line-1000"></a><span class='hs-definition'>mkAppTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1001"></a><span class='hs-definition'>mkAppTy</span> <span class='hs-varid'>ty1</span>               <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1002"></a>        <span class='hs-comment'>-- Note that the TyConApp could be an</span>
<a name="line-1003"></a>        <span class='hs-comment'>-- under-saturated type synonym.  GHC allows that; e.g.</span>
<a name="line-1004"></a>        <span class='hs-comment'>--      type Foo k = k a -&gt; k a</span>
<a name="line-1005"></a>        <span class='hs-comment'>--      type Id x = x</span>
<a name="line-1006"></a>        <span class='hs-comment'>--      foo :: Foo Id -&gt; Foo Id</span>
<a name="line-1007"></a>        <span class='hs-comment'>--</span>
<a name="line-1008"></a>        <span class='hs-comment'>-- Here Id is partially applied in the type sig for Foo,</span>
<a name="line-1009"></a>        <span class='hs-comment'>-- but once the type synonyms are expanded all is well</span>
<a name="line-1010"></a>        <span class='hs-comment'>--</span>
<a name="line-1011"></a>        <span class='hs-comment'>-- Moreover in GHC.Tc.Types.tcInferTyApps we build up a type</span>
<a name="line-1012"></a>        <span class='hs-comment'>--   (T t1 t2 t3) one argument at a type, thus forming</span>
<a name="line-1013"></a>        <span class='hs-comment'>--   (T t1), (T t1 t2), etc</span>
<a name="line-1014"></a>
<a name="line-1015"></a><a name="mkAppTys"></a><span class='hs-definition'>mkAppTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1016"></a><span class='hs-definition'>mkAppTys</span> <span class='hs-varid'>ty1</span>                <span class='hs-conid'>[]</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty1</span>
<a name="line-1017"></a><span class='hs-definition'>mkAppTys</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys</span>  <span class='hs-comment'>-- much more efficient then nested mkAppTy</span>
<a name="line-1018"></a>                                     <span class='hs-comment'>-- Why do this? See (EQ1) of</span>
<a name="line-1019"></a>                                     <span class='hs-comment'>-- Note [Respecting definitional equality]</span>
<a name="line-1020"></a>                                     <span class='hs-comment'>-- in GHC.Core.TyCo.Rep</span>
<a name="line-1021"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl'</span> <span class='hs-conid'>AppTy</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>mkAppTys</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>casted_arg_tys</span><span class='hs-layout'>)</span> <span class='hs-varop'>`mkCastTy`</span> <span class='hs-varid'>res_co</span><span class='hs-layout'>)</span> <span class='hs-varid'>leftovers</span>
<a name="line-1022"></a>  <span class='hs-keyword'>where</span>
<a name="line-1023"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>arg_cos</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decomposePiCos</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys</span>
<a name="line-1024"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>args_to_cast</span><span class='hs-layout'>,</span> <span class='hs-varid'>leftovers</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAtList</span> <span class='hs-varid'>arg_cos</span> <span class='hs-varid'>arg_tys</span>
<a name="line-1025"></a>    <span class='hs-varid'>casted_arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>mkCastTy</span> <span class='hs-varid'>args_to_cast</span> <span class='hs-varid'>arg_cos</span>
<a name="line-1026"></a><span class='hs-definition'>mkAppTys</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span>
<a name="line-1027"></a><span class='hs-definition'>mkAppTys</span> <span class='hs-varid'>ty1</span>                <span class='hs-varid'>tys2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl'</span> <span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>tys2</span>
<a name="line-1028"></a>
<a name="line-1029"></a><a name="splitAppTy_maybe"></a><span class='hs-comment'>-------------</span>
<a name="line-1030"></a><span class='hs-definition'>splitAppTy_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1031"></a><span class='hs-comment'>-- ^ Attempt to take a type application apart, whether it is a</span>
<a name="line-1032"></a><span class='hs-comment'>-- function, type constructor, or plain type application. Note</span>
<a name="line-1033"></a><span class='hs-comment'>-- that type family applications are NEVER unsaturated by this!</span>
<a name="line-1034"></a><span class='hs-definition'>splitAppTy_maybe</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>repSplitAppTy_maybe</span> <span class='hs-varop'>.</span> <span class='hs-varid'>coreFullView</span>
<a name="line-1035"></a>
<a name="line-1036"></a><a name="repSplitAppTy_maybe"></a><span class='hs-comment'>-------------</span>
<a name="line-1037"></a><span class='hs-definition'>repSplitAppTy_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span><span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1038"></a><span class='hs-comment'>-- ^ Does the AppTy split as in 'splitAppTy_maybe', but assumes that</span>
<a name="line-1039"></a><span class='hs-comment'>-- any Core view stuff is already done</span>
<a name="line-1040"></a><span class='hs-definition'>repSplitAppTy_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-1041"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>funTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep1</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-1042"></a>  <span class='hs-keyword'>where</span>
<a name="line-1043"></a>    <span class='hs-varid'>rep1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getRuntimeRep</span> <span class='hs-varid'>ty1</span>
<a name="line-1044"></a>    <span class='hs-varid'>rep2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getRuntimeRep</span> <span class='hs-varid'>ty2</span>
<a name="line-1045"></a>
<a name="line-1046"></a><span class='hs-definition'>repSplitAppTy_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-1047"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-1048"></a>
<a name="line-1049"></a><span class='hs-definition'>repSplitAppTy_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1050"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>mustBeSaturated</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`lengthExceeds`</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span>
<a name="line-1051"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>snocView</span> <span class='hs-varid'>tys</span>
<a name="line-1052"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- Never create unsaturated type family apps!</span>
<a name="line-1053"></a>
<a name="line-1054"></a><span class='hs-definition'>repSplitAppTy_maybe</span> <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1055"></a>
<a name="line-1056"></a><a name="tcRepSplitAppTy_maybe"></a><span class='hs-comment'>-- This one doesn't break apart (c =&gt; t).</span>
<a name="line-1057"></a><span class='hs-comment'>-- See Note [Decomposing fat arrow c=&gt;t]</span>
<a name="line-1058"></a><span class='hs-comment'>-- Defined here to avoid module loops between Unify and TcType.</span>
<a name="line-1059"></a><span class='hs-definition'>tcRepSplitAppTy_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span><span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1060"></a><span class='hs-comment'>-- ^ Does the AppTy split as in 'tcSplitAppTy_maybe', but assumes that</span>
<a name="line-1061"></a><span class='hs-comment'>-- any coreView stuff is already done. Refuses to look through (c =&gt; t)</span>
<a name="line-1062"></a><span class='hs-definition'>tcRepSplitAppTy_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_af</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>af</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_mult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1063"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>VisArg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>af</span>   <span class='hs-comment'>-- See Note [Decomposing fat arrow c=&gt;t]</span>
<a name="line-1064"></a>
<a name="line-1065"></a>  <span class='hs-comment'>-- See Note [The Purely Kinded Type Invariant (PKTI)] in GHC.Tc.Gen.HsType,</span>
<a name="line-1066"></a>  <span class='hs-comment'>-- Wrinkle around FunTy</span>
<a name="line-1067"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>rep1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getRuntimeRep_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-1068"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>rep2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getRuntimeRep_maybe</span> <span class='hs-varid'>ty2</span>
<a name="line-1069"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>funTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep1</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-1070"></a>
<a name="line-1071"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1072"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1073"></a>
<a name="line-1074"></a><span class='hs-definition'>tcRepSplitAppTy_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-1075"></a><span class='hs-definition'>tcRepSplitAppTy_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1076"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>mustBeSaturated</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`lengthExceeds`</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span>
<a name="line-1077"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>snocView</span> <span class='hs-varid'>tys</span>
<a name="line-1078"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- Never create unsaturated type family apps!</span>
<a name="line-1079"></a><span class='hs-definition'>tcRepSplitAppTy_maybe</span> <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1080"></a>
<a name="line-1081"></a><a name="splitAppTy"></a><span class='hs-comment'>-------------</span>
<a name="line-1082"></a><span class='hs-definition'>splitAppTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1083"></a><span class='hs-comment'>-- ^ Attempts to take a type application apart, as in 'splitAppTy_maybe',</span>
<a name="line-1084"></a><span class='hs-comment'>-- and panics if this is not possible</span>
<a name="line-1085"></a><span class='hs-definition'>splitAppTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitAppTy_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-1086"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>pr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pr</span>
<a name="line-1087"></a>                <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"splitAppTy"</span>
<a name="line-1088"></a>
<a name="line-1089"></a><a name="splitAppTys"></a><span class='hs-comment'>-------------</span>
<a name="line-1090"></a><span class='hs-definition'>splitAppTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1091"></a><span class='hs-comment'>-- ^ Recursively splits a type as far as is possible, leaving a residual</span>
<a name="line-1092"></a><span class='hs-comment'>-- type being applied to and the type arguments applied to it. Never fails,</span>
<a name="line-1093"></a><span class='hs-comment'>-- even if that means returning an empty list of type applications.</span>
<a name="line-1094"></a><span class='hs-definition'>splitAppTys</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span>
<a name="line-1095"></a>  <span class='hs-keyword'>where</span>
<a name="line-1096"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>args</span>
<a name="line-1097"></a>    <span class='hs-varid'>split</span> <span class='hs-keyword'>_</span>       <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>        <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-1098"></a>    <span class='hs-varid'>split</span> <span class='hs-keyword'>_</span>       <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tc_args</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-1099"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-comment'>-- keep type families saturated</span>
<a name="line-1100"></a>            <span class='hs-varid'>n</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mustBeSaturated</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span>
<a name="line-1101"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-1102"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>tc_args1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_args2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-varid'>n</span> <span class='hs-varid'>tc_args</span>
<a name="line-1103"></a>        <span class='hs-keyword'>in</span>
<a name="line-1104"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tc_args1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_args2</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-1105"></a>    <span class='hs-varid'>split</span> <span class='hs-keyword'>_</span>   <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-1106"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>args</span> <span class='hs-layout'>)</span>
<a name="line-1107"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>funTyCon</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep1</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1108"></a>      <span class='hs-keyword'>where</span>
<a name="line-1109"></a>        <span class='hs-varid'>rep1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getRuntimeRep</span> <span class='hs-varid'>ty1</span>
<a name="line-1110"></a>        <span class='hs-varid'>rep2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getRuntimeRep</span> <span class='hs-varid'>ty2</span>
<a name="line-1111"></a>
<a name="line-1112"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-keyword'>_</span>                     <span class='hs-varid'>args</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>orig_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-1113"></a>
<a name="line-1114"></a><a name="repSplitAppTys"></a><span class='hs-comment'>-- | Like 'splitAppTys', but doesn't look through type synonyms</span>
<a name="line-1115"></a><span class='hs-definition'>repSplitAppTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1116"></a><span class='hs-definition'>repSplitAppTys</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span>
<a name="line-1117"></a>  <span class='hs-keyword'>where</span>
<a name="line-1118"></a>    <span class='hs-varid'>split</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-1119"></a>    <span class='hs-varid'>split</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tc_args</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-1120"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mustBeSaturated</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span>
<a name="line-1121"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-1122"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>tc_args1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_args2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-varid'>n</span> <span class='hs-varid'>tc_args</span>
<a name="line-1123"></a>        <span class='hs-keyword'>in</span>
<a name="line-1124"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tc_args1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_args2</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-1125"></a>    <span class='hs-varid'>split</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-1126"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>args</span> <span class='hs-layout'>)</span>
<a name="line-1127"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>funTyCon</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep1</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1128"></a>      <span class='hs-keyword'>where</span>
<a name="line-1129"></a>        <span class='hs-varid'>rep1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getRuntimeRep</span> <span class='hs-varid'>ty1</span>
<a name="line-1130"></a>        <span class='hs-varid'>rep2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getRuntimeRep</span> <span class='hs-varid'>ty2</span>
<a name="line-1131"></a>
<a name="line-1132"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-1133"></a>
<a name="line-1134"></a><span class='hs-comment'>{-
<a name="line-1135"></a>                      LitTy
<a name="line-1136"></a>                      ~~~~~
<a name="line-1137"></a>-}</span>
<a name="line-1138"></a>
<a name="line-1139"></a><a name="mkNumLitTy"></a><span class='hs-definition'>mkNumLitTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Integer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1140"></a><span class='hs-definition'>mkNumLitTy</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LitTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>NumTyLit</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-1141"></a>
<a name="line-1142"></a><a name="isNumLitTy"></a><span class='hs-comment'>-- | Is this a numeric literal. We also look through type synonyms.</span>
<a name="line-1143"></a><span class='hs-definition'>isNumLitTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Integer</span>
<a name="line-1144"></a><span class='hs-definition'>isNumLitTy</span> <span class='hs-varid'>ty</span>
<a name="line-1145"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LitTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>NumTyLit</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span>
<a name="line-1146"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1147"></a>
<a name="line-1148"></a><a name="mkStrLitTy"></a><span class='hs-definition'>mkStrLitTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1149"></a><span class='hs-definition'>mkStrLitTy</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LitTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrTyLit</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-1150"></a>
<a name="line-1151"></a><a name="isStrLitTy"></a><span class='hs-comment'>-- | Is this a symbol literal. We also look through type synonyms.</span>
<a name="line-1152"></a><span class='hs-definition'>isStrLitTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>FastString</span>
<a name="line-1153"></a><span class='hs-definition'>isStrLitTy</span> <span class='hs-varid'>ty</span>
<a name="line-1154"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LitTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrTyLit</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span>
<a name="line-1155"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1156"></a>
<a name="line-1157"></a><a name="mkCharLitTy"></a><span class='hs-definition'>mkCharLitTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Char</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1158"></a><span class='hs-definition'>mkCharLitTy</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LitTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>CharTyLit</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-1159"></a>
<a name="line-1160"></a><a name="isCharLitTy"></a><span class='hs-comment'>-- | Is this a char literal? We also look through type synonyms.</span>
<a name="line-1161"></a><span class='hs-definition'>isCharLitTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Char</span>
<a name="line-1162"></a><span class='hs-definition'>isCharLitTy</span> <span class='hs-varid'>ty</span>
<a name="line-1163"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LitTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>CharTyLit</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span>
<a name="line-1164"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1165"></a>
<a name="line-1166"></a>
<a name="line-1167"></a><a name="isLitTy"></a><span class='hs-comment'>-- | Is this a type literal (symbol, numeric, or char)?</span>
<a name="line-1168"></a><span class='hs-definition'>isLitTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TyLit</span>
<a name="line-1169"></a><span class='hs-definition'>isLitTy</span> <span class='hs-varid'>ty</span>
<a name="line-1170"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LitTy</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>l</span>
<a name="line-1171"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1172"></a>
<a name="line-1173"></a><a name="userTypeError_maybe"></a><span class='hs-comment'>-- | Is this type a custom user error?</span>
<a name="line-1174"></a><span class='hs-comment'>-- If so, give us the kind and the error message.</span>
<a name="line-1175"></a><span class='hs-definition'>userTypeError_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-1176"></a><span class='hs-definition'>userTypeError_maybe</span> <span class='hs-varid'>t</span>
<a name="line-1177"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-sel'>_kind</span> <span class='hs-conop'>:</span> <span class='hs-varid'>msg</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>t</span>
<a name="line-1178"></a>          <span class='hs-comment'>-- There may be more than 2 arguments, if the type error is</span>
<a name="line-1179"></a>          <span class='hs-comment'>-- used as a type constructor (e.g. at kind `Type -&gt; Type`).</span>
<a name="line-1180"></a>
<a name="line-1181"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>guard</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConName</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>errorMessageTypeErrorFamName</span><span class='hs-layout'>)</span>
<a name="line-1182"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>msg</span> <span class='hs-layout'>}</span>
<a name="line-1183"></a>
<a name="line-1184"></a><a name="pprUserTypeErrorTy"></a><span class='hs-comment'>-- | Render a type corresponding to a user type error into a SDoc.</span>
<a name="line-1185"></a><span class='hs-definition'>pprUserTypeErrorTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1186"></a><span class='hs-definition'>pprUserTypeErrorTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span>
<a name="line-1187"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-1188"></a>
<a name="line-1189"></a>    <span class='hs-comment'>-- Text "Something"</span>
<a name="line-1190"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>txt</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1191"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tyConName</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>typeErrorTextDataConName</span>
<a name="line-1192"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isStrLitTy</span> <span class='hs-varid'>txt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ftext</span> <span class='hs-varid'>str</span>
<a name="line-1193"></a>
<a name="line-1194"></a>    <span class='hs-comment'>-- ShowType t</span>
<a name="line-1195"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-sel'>_k</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1196"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tyConName</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>typeErrorShowTypeDataConName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>t</span>
<a name="line-1197"></a>
<a name="line-1198"></a>    <span class='hs-comment'>-- t1 :&lt;&gt;: t2</span>
<a name="line-1199"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span><span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1200"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tyConName</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>typeErrorAppendDataConName</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1201"></a>        <span class='hs-varid'>pprUserTypeErrorTy</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>pprUserTypeErrorTy</span> <span class='hs-varid'>t2</span>
<a name="line-1202"></a>
<a name="line-1203"></a>    <span class='hs-comment'>-- t1 :$$: t2</span>
<a name="line-1204"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span><span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1205"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tyConName</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>typeErrorVAppendDataConName</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1206"></a>        <span class='hs-varid'>pprUserTypeErrorTy</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>pprUserTypeErrorTy</span> <span class='hs-varid'>t2</span>
<a name="line-1207"></a>
<a name="line-1208"></a>    <span class='hs-comment'>-- An unevaluated type function</span>
<a name="line-1209"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-1210"></a>
<a name="line-1211"></a>
<a name="line-1212"></a>
<a name="line-1213"></a>
<a name="line-1214"></a><span class='hs-comment'>{-
<a name="line-1215"></a>---------------------------------------------------------------------
<a name="line-1216"></a>                                FunTy
<a name="line-1217"></a>                                ~~~~~
<a name="line-1218"></a>
<a name="line-1219"></a>Note [Representation of function types]
<a name="line-1220"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1221"></a>
<a name="line-1222"></a>Functions (e.g. Int -&gt; Char) can be thought of as being applications
<a name="line-1223"></a>of funTyCon (known in Haskell surface syntax as (-&gt;)), (note that
<a name="line-1224"></a>`RuntimeRep' quantifiers are left inferred)
<a name="line-1225"></a>
<a name="line-1226"></a>    (-&gt;) :: forall {r1 :: RuntimeRep} {r2 :: RuntimeRep}
<a name="line-1227"></a>                   (a :: TYPE r1) (b :: TYPE r2).
<a name="line-1228"></a>            a -&gt; b -&gt; Type
<a name="line-1229"></a>
<a name="line-1230"></a>However, for efficiency's sake we represent saturated applications of (-&gt;)
<a name="line-1231"></a>with FunTy. For instance, the type,
<a name="line-1232"></a>
<a name="line-1233"></a>    (-&gt;) r1 r2 a b
<a name="line-1234"></a>
<a name="line-1235"></a>is equivalent to,
<a name="line-1236"></a>
<a name="line-1237"></a>    FunTy (Anon a) b
<a name="line-1238"></a>
<a name="line-1239"></a>Note how the RuntimeReps are implied in the FunTy representation. For this
<a name="line-1240"></a>reason we must be careful when reconstructing the TyConApp representation (see,
<a name="line-1241"></a>for instance, splitTyConApp_maybe).
<a name="line-1242"></a>
<a name="line-1243"></a>In the compiler we maintain the invariant that all saturated applications of
<a name="line-1244"></a>(-&gt;) are represented with FunTy.
<a name="line-1245"></a>
<a name="line-1246"></a>See #11714.
<a name="line-1247"></a>-}</span>
<a name="line-1248"></a>
<a name="line-1249"></a><a name="splitFunTy"></a><span class='hs-definition'>splitFunTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Mult</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1250"></a><span class='hs-comment'>-- ^ Attempts to extract the multiplicity, argument and result types from a type,</span>
<a name="line-1251"></a><span class='hs-comment'>-- and panics if that is not possible. See also 'splitFunTy_maybe'</span>
<a name="line-1252"></a><span class='hs-definition'>splitFunTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"splitFunTy"</span> <span class='hs-varop'>.</span> <span class='hs-varid'>splitFunTy_maybe</span>
<a name="line-1253"></a>
<a name="line-1254"></a><a name="splitFunTy_maybe"></a><span class='hs-comment'>{-# INLINE splitFunTy_maybe #-}</span>
<a name="line-1255"></a><span class='hs-definition'>splitFunTy_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Mult</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1256"></a><span class='hs-comment'>-- ^ Attempts to extract the multiplicity, argument and result types from a type</span>
<a name="line-1257"></a><span class='hs-definition'>splitFunTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1258"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-1259"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1260"></a>
<a name="line-1261"></a><a name="splitFunTys"></a><span class='hs-definition'>splitFunTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Scaled</span> <span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1262"></a><span class='hs-definition'>splitFunTys</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span>
<a name="line-1263"></a>  <span class='hs-keyword'>where</span>
<a name="line-1264"></a>      <span class='hs-comment'>-- common case first</span>
<a name="line-1265"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>args</span> <span class='hs-keyword'>_</span>       <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>Scaled</span> <span class='hs-varid'>w</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span> <span class='hs-varid'>res</span>
<a name="line-1266"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>args</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>args</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty'</span>
<a name="line-1267"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>args</span> <span class='hs-varid'>orig_ty</span> <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig_ty</span><span class='hs-layout'>)</span>
<a name="line-1268"></a>
<a name="line-1269"></a><a name="funResultTy"></a><span class='hs-definition'>funResultTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1270"></a><span class='hs-comment'>-- ^ Extract the function result type and panic if that is not possible</span>
<a name="line-1271"></a><span class='hs-definition'>funResultTy</span> <span class='hs-varid'>ty</span>
<a name="line-1272"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res</span>
<a name="line-1273"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"funResultTy"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1274"></a>
<a name="line-1275"></a><a name="funArgTy"></a><span class='hs-definition'>funArgTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1276"></a><span class='hs-comment'>-- ^ Extract the function argument type and panic if that is not possible</span>
<a name="line-1277"></a><span class='hs-definition'>funArgTy</span> <span class='hs-varid'>ty</span>
<a name="line-1278"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg</span>
<a name="line-1279"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"funArgTy"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1280"></a>
<a name="line-1281"></a><a name="piResultTy"></a><span class='hs-comment'>-- ^ Just like 'piResultTys' but for a single argument</span>
<a name="line-1282"></a><span class='hs-comment'>-- Try not to iterate 'piResultTy', because it's inefficient to substitute</span>
<a name="line-1283"></a><span class='hs-comment'>-- one variable at a time; instead use 'piResultTys"</span>
<a name="line-1284"></a><span class='hs-definition'>piResultTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>Type</span>
<a name="line-1285"></a><span class='hs-definition'>piResultTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>piResultTy_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>arg</span> <span class='hs-keyword'>of</span>
<a name="line-1286"></a>                      <span class='hs-conid'>Just</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>res</span>
<a name="line-1287"></a>                      <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"piResultTy"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-1288"></a>
<a name="line-1289"></a><a name="piResultTy_maybe"></a><span class='hs-definition'>piResultTy_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-1290"></a><span class='hs-comment'>-- We don't need a 'tc' version, because</span>
<a name="line-1291"></a><span class='hs-comment'>-- this function behaves the same for Type and Constraint</span>
<a name="line-1292"></a><span class='hs-definition'>piResultTy_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-1293"></a>  <span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>res</span>
<a name="line-1294"></a>
<a name="line-1295"></a>  <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span>
<a name="line-1296"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>empty_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-varop'>$</span>
<a name="line-1297"></a>                         <span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span><span class='hs-varid'>res</span><span class='hs-keyglyph'>]</span>
<a name="line-1298"></a>       <span class='hs-keyword'>in</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTCvSubst</span> <span class='hs-varid'>empty_subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-1299"></a>
<a name="line-1300"></a>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1301"></a>
<a name="line-1302"></a><span class='hs-comment'>-- | (piResultTys f_ty [ty1, .., tyn]) gives the type of (f ty1 .. tyn)</span>
<a name="line-1303"></a><span class='hs-comment'>--   where f :: f_ty</span>
<a name="line-1304"></a><span class='hs-comment'>-- 'piResultTys' is interesting because:</span>
<a name="line-1305"></a><span class='hs-comment'>--      1. 'f_ty' may have more for-alls than there are args</span>
<a name="line-1306"></a><span class='hs-comment'>--      2. Less obviously, it may have fewer for-alls</span>
<a name="line-1307"></a><span class='hs-comment'>-- For case 2. think of:</span>
<a name="line-1308"></a><span class='hs-comment'>--   piResultTys (forall a.a) [forall b.b, Int]</span>
<a name="line-1309"></a><span class='hs-comment'>-- This really can happen, but only (I think) in situations involving</span>
<a name="line-1310"></a><span class='hs-comment'>-- undefined.  For example:</span>
<a name="line-1311"></a><span class='hs-comment'>--       undefined :: forall a. a</span>
<a name="line-1312"></a><span class='hs-comment'>-- Term: undefined @(forall b. b-&gt;b) @Int</span>
<a name="line-1313"></a><span class='hs-comment'>-- This term should have type (Int -&gt; Int), but notice that</span>
<a name="line-1314"></a><span class='hs-comment'>-- there are more type args than foralls in 'undefined's type.</span>
<a name="line-1315"></a>
<a name="line-1316"></a><span class='hs-comment'>-- If you edit this function, you may need to update the GHC formalism</span>
<a name="line-1317"></a><span class='hs-comment'>-- See Note [GHC Formalism] in GHC.Core.Lint</span>
<a name="line-1318"></a>
<a name="line-1319"></a><a name="piResultTys"></a><span class='hs-comment'>-- This is a heavily used function (e.g. from typeKind),</span>
<a name="line-1320"></a><span class='hs-comment'>-- so we pay attention to efficiency, especially in the special case</span>
<a name="line-1321"></a><span class='hs-comment'>-- where there are no for-alls so we are just dropping arrows from</span>
<a name="line-1322"></a><span class='hs-comment'>-- a function type/kind.</span>
<a name="line-1323"></a><span class='hs-definition'>piResultTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1324"></a><span class='hs-definition'>piResultTys</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-1325"></a><span class='hs-definition'>piResultTys</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>orig_args</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-1326"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ty</span>
<a name="line-1327"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>piResultTys</span> <span class='hs-varid'>res</span> <span class='hs-varid'>args</span>
<a name="line-1328"></a>
<a name="line-1329"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ty</span>
<a name="line-1330"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTCvSubst</span> <span class='hs-varid'>init_subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span> <span class='hs-varid'>args</span>
<a name="line-1331"></a>
<a name="line-1332"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span>
<a name="line-1333"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>piResultTys</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>orig_args</span>
<a name="line-1334"></a>
<a name="line-1335"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1336"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"piResultTys1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_args</span><span class='hs-layout'>)</span>
<a name="line-1337"></a>  <span class='hs-keyword'>where</span>
<a name="line-1338"></a>    <span class='hs-varid'>init_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>orig_args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1339"></a>
<a name="line-1340"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1341"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyUnchecked</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-1342"></a>
<a name="line-1343"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>all_args</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-1344"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ty</span>
<a name="line-1345"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>res</span> <span class='hs-varid'>args</span>
<a name="line-1346"></a>
<a name="line-1347"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ty</span>
<a name="line-1348"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span> <span class='hs-varid'>args</span>
<a name="line-1349"></a>
<a name="line-1350"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span>
<a name="line-1351"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>all_args</span>
<a name="line-1352"></a>
<a name="line-1353"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- See Note [Care with kind instantiation]</span>
<a name="line-1354"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>init_subst</span>
<a name="line-1355"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1356"></a>          <span class='hs-varid'>all_args</span>
<a name="line-1357"></a>
<a name="line-1358"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1359"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- We have not run out of arguments, but the function doesn't</span>
<a name="line-1360"></a>        <span class='hs-comment'>-- have the right kind to apply to them; so panic.</span>
<a name="line-1361"></a>        <span class='hs-comment'>-- Without the explicit isEmptyVarEnv test, an ill-kinded type</span>
<a name="line-1362"></a>        <span class='hs-comment'>-- would give an infinite loop, which is very unhelpful</span>
<a name="line-1363"></a>        <span class='hs-comment'>-- c.f. #15473</span>
<a name="line-1364"></a>        <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"piResultTys2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_args</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>all_args</span><span class='hs-layout'>)</span>
<a name="line-1365"></a>
<a name="line-1366"></a><a name="applyTysX"></a><span class='hs-definition'>applyTysX</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1367"></a><span class='hs-comment'>-- applyTyxX beta-reduces (/\tvs. body_ty) arg_tys</span>
<a name="line-1368"></a><span class='hs-comment'>-- Assumes that (/\tvs. body_ty) is closed</span>
<a name="line-1369"></a><span class='hs-definition'>applyTysX</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>body_ty</span> <span class='hs-varid'>arg_tys</span>
<a name="line-1370"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varop'>`lengthAtLeast`</span> <span class='hs-varid'>n_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>pp_stuff</span> <span class='hs-layout'>)</span>
<a name="line-1371"></a>    <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>body_ty</span> <span class='hs-varop'>`subVarSet`</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>pp_stuff</span> <span class='hs-layout'>)</span>
<a name="line-1372"></a>    <span class='hs-varid'>mkAppTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-varid'>n_tvs</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>body_ty</span><span class='hs-layout'>)</span>
<a name="line-1373"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>drop</span> <span class='hs-varid'>n_tvs</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span>
<a name="line-1374"></a>  <span class='hs-keyword'>where</span>
<a name="line-1375"></a>    <span class='hs-varid'>pp_stuff</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>body_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>arg_tys</span><span class='hs-keyglyph'>]</span>
<a name="line-1376"></a>    <span class='hs-varid'>n_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span>
<a name="line-1377"></a>
<a name="line-1378"></a>
<a name="line-1379"></a>
<a name="line-1380"></a><span class='hs-comment'>{- Note [Care with kind instantiation]
<a name="line-1381"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1382"></a>Suppose we have
<a name="line-1383"></a>  T :: forall k. k
<a name="line-1384"></a>and we are finding the kind of
<a name="line-1385"></a>  T (forall b. b -&gt; b) * Int
<a name="line-1386"></a>Then
<a name="line-1387"></a>  T (forall b. b-&gt;b) :: k[ k :-&gt; forall b. b-&gt;b]
<a name="line-1388"></a>                     :: forall b. b -&gt; b
<a name="line-1389"></a>So
<a name="line-1390"></a>  T (forall b. b-&gt;b) * :: (b -&gt; b)[ b :-&gt; *]
<a name="line-1391"></a>                       :: * -&gt; *
<a name="line-1392"></a>
<a name="line-1393"></a>In other words we must instantiate the forall!
<a name="line-1394"></a>
<a name="line-1395"></a>Similarly (#15428)
<a name="line-1396"></a>   S :: forall k f. k -&gt; f k
<a name="line-1397"></a>and we are finding the kind of
<a name="line-1398"></a>   S * (* -&gt;) Int Bool
<a name="line-1399"></a>We have
<a name="line-1400"></a>   S * (* -&gt;) :: (k -&gt; f k)[ k :-&gt; *, f :-&gt; (* -&gt;)]
<a name="line-1401"></a>              :: * -&gt; * -&gt; *
<a name="line-1402"></a>So again we must instantiate.
<a name="line-1403"></a>
<a name="line-1404"></a>The same thing happens in GHC.CoreToIface.toIfaceAppArgsX.
<a name="line-1405"></a>
<a name="line-1406"></a>---------------------------------------------------------------------
<a name="line-1407"></a>                                TyConApp
<a name="line-1408"></a>                                ~~~~~~~~
<a name="line-1409"></a>-}</span>
<a name="line-1410"></a>
<a name="line-1411"></a><span class='hs-comment'>-- splitTyConApp "looks through" synonyms, because they don't</span>
<a name="line-1412"></a><span class='hs-comment'>-- mean a distinct type, but all other type-constructor applications</span>
<a name="line-1413"></a><span class='hs-comment'>-- including functions are returned as Just ..</span>
<a name="line-1414"></a>
<a name="line-1415"></a><a name="tyConAppTyConPicky_maybe"></a><span class='hs-comment'>-- | Retrieve the tycon heading this type, if there is one. Does /not/</span>
<a name="line-1416"></a><span class='hs-comment'>-- look through synonyms.</span>
<a name="line-1417"></a><span class='hs-definition'>tyConAppTyConPicky_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TyCon</span>
<a name="line-1418"></a><span class='hs-definition'>tyConAppTyConPicky_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span>
<a name="line-1419"></a><span class='hs-definition'>tyConAppTyConPicky_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>funTyCon</span>
<a name="line-1420"></a><span class='hs-definition'>tyConAppTyConPicky_maybe</span> <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1421"></a>
<a name="line-1422"></a>
<a name="line-1423"></a><a name="tyConAppTyCon_maybe"></a><span class='hs-comment'>-- | The same as @fst . splitTyConApp@</span>
<a name="line-1424"></a><span class='hs-comment'>{-# INLINE tyConAppTyCon_maybe #-}</span>
<a name="line-1425"></a><span class='hs-definition'>tyConAppTyCon_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TyCon</span>
<a name="line-1426"></a><span class='hs-definition'>tyConAppTyCon_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-1427"></a>  <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span>
<a name="line-1428"></a>  <span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>funTyCon</span>
<a name="line-1429"></a>  <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1430"></a>
<a name="line-1431"></a><a name="tyConAppTyCon"></a><span class='hs-definition'>tyConAppTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span>
<a name="line-1432"></a><span class='hs-definition'>tyConAppTyCon</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tyConAppTyCon"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1433"></a>
<a name="line-1434"></a><a name="tyConAppArgs_maybe"></a><span class='hs-comment'>-- | The same as @snd . splitTyConApp@</span>
<a name="line-1435"></a><span class='hs-definition'>tyConAppArgs_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-1436"></a><span class='hs-definition'>tyConAppArgs_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-1437"></a>  <span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tys</span>
<a name="line-1438"></a>  <span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span>
<a name="line-1439"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>rep1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getRuntimeRep_maybe</span> <span class='hs-varid'>arg</span>
<a name="line-1440"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>rep2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getRuntimeRep_maybe</span> <span class='hs-varid'>res</span>
<a name="line-1441"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep1</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep2</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-keyglyph'>]</span>
<a name="line-1442"></a>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1443"></a>
<a name="line-1444"></a><a name="tyConAppArgs"></a><span class='hs-definition'>tyConAppArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-1445"></a><span class='hs-definition'>tyConAppArgs</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppArgs_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tyConAppArgs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1446"></a>
<a name="line-1447"></a><a name="tyConAppArgN"></a><span class='hs-definition'>tyConAppArgN</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1448"></a><span class='hs-comment'>-- Executing Nth</span>
<a name="line-1449"></a><span class='hs-definition'>tyConAppArgN</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span>
<a name="line-1450"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConAppArgs_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-1451"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`getNth`</span> <span class='hs-varid'>n</span>
<a name="line-1452"></a>      <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tyConAppArgN"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1453"></a>
<a name="line-1454"></a><a name="splitTyConApp"></a><span class='hs-comment'>-- | Attempts to tease a type apart into a type constructor and the application</span>
<a name="line-1455"></a><span class='hs-comment'>-- of a number of arguments to that constructor. Panics if that is not possible.</span>
<a name="line-1456"></a><span class='hs-comment'>-- See also 'splitTyConApp_maybe'</span>
<a name="line-1457"></a><span class='hs-definition'>splitTyConApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1458"></a><span class='hs-definition'>splitTyConApp</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-1459"></a>                   <span class='hs-conid'>Just</span> <span class='hs-varid'>stuff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>stuff</span>
<a name="line-1460"></a>                   <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"splitTyConApp"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1461"></a>
<a name="line-1462"></a><a name="splitTyConApp_maybe"></a><span class='hs-comment'>-- | Attempts to tease a type apart into a type constructor and the application</span>
<a name="line-1463"></a><span class='hs-comment'>-- of a number of arguments to that constructor</span>
<a name="line-1464"></a><span class='hs-definition'>splitTyConApp_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1465"></a><span class='hs-definition'>splitTyConApp_maybe</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>repSplitTyConApp_maybe</span> <span class='hs-varop'>.</span> <span class='hs-varid'>coreFullView</span>
<a name="line-1466"></a>
<a name="line-1467"></a><a name="tcSplitTyConApp_maybe"></a><span class='hs-comment'>-- | Split a type constructor application into its type constructor and</span>
<a name="line-1468"></a><span class='hs-comment'>-- applied types. Note that this may fail in the case of a 'FunTy' with an</span>
<a name="line-1469"></a><span class='hs-comment'>-- argument of unknown kind 'FunTy' (e.g. @FunTy (a :: k) Int@. since the kind</span>
<a name="line-1470"></a><span class='hs-comment'>-- of @a@ isn't of the form @TYPE rep@). Consequently, you may need to zonk your</span>
<a name="line-1471"></a><span class='hs-comment'>-- type before using this function.</span>
<a name="line-1472"></a><span class='hs-comment'>--</span>
<a name="line-1473"></a><span class='hs-comment'>-- This does *not* split types headed with (=&gt;), as that's not a TyCon in the</span>
<a name="line-1474"></a><span class='hs-comment'>-- type-checker.</span>
<a name="line-1475"></a><span class='hs-comment'>--</span>
<a name="line-1476"></a><span class='hs-comment'>-- If you only need the 'TyCon', consider using 'tcTyConAppTyCon_maybe'.</span>
<a name="line-1477"></a><span class='hs-definition'>tcSplitTyConApp_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1478"></a><span class='hs-comment'>-- Defined here to avoid module loops between Unify and TcType.</span>
<a name="line-1479"></a><span class='hs-definition'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty'</span>
<a name="line-1480"></a>                         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcRepSplitTyConApp_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1481"></a>
<a name="line-1482"></a><a name="repSplitTyConApp_maybe"></a><span class='hs-comment'>-------------------</span>
<a name="line-1483"></a><span class='hs-definition'>repSplitTyConApp_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1484"></a><span class='hs-comment'>-- ^ Like 'splitTyConApp_maybe', but doesn't look through synonyms. This</span>
<a name="line-1485"></a><span class='hs-comment'>-- assumes the synonyms have already been dealt with.</span>
<a name="line-1486"></a><span class='hs-definition'>repSplitTyConApp_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1487"></a><span class='hs-definition'>repSplitTyConApp_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-1488"></a>  <span class='hs-comment'>-- NB: we're in Core, so no check for VisArg</span>
<a name="line-1489"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>funTyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_rep</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_rep</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1490"></a>  <span class='hs-keyword'>where</span>
<a name="line-1491"></a>    <span class='hs-varid'>arg_rep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getRuntimeRep</span> <span class='hs-varid'>arg</span>
<a name="line-1492"></a>    <span class='hs-varid'>res_rep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getRuntimeRep</span> <span class='hs-varid'>res</span>
<a name="line-1493"></a><span class='hs-definition'>repSplitTyConApp_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1494"></a>
<a name="line-1495"></a><a name="tcRepSplitTyConApp_maybe"></a><span class='hs-definition'>tcRepSplitTyConApp_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1496"></a><span class='hs-comment'>-- ^ Like 'tcSplitTyConApp_maybe', but doesn't look through synonyms. This</span>
<a name="line-1497"></a><span class='hs-comment'>-- assumes the synonyms have already been dealt with.</span>
<a name="line-1498"></a><span class='hs-comment'>--</span>
<a name="line-1499"></a><span class='hs-comment'>-- Moreover, for a FunTy, it only succeeds if the argument types</span>
<a name="line-1500"></a><span class='hs-comment'>-- have enough info to extract the runtime-rep arguments that</span>
<a name="line-1501"></a><span class='hs-comment'>-- the funTyCon requires.  This will usually be true;</span>
<a name="line-1502"></a><span class='hs-comment'>-- but may be temporarily false during canonicalization:</span>
<a name="line-1503"></a><span class='hs-comment'>--     see Note [Decomposing FunTy] in GHC.Tc.Solver.Canonical</span>
<a name="line-1504"></a><span class='hs-comment'>--     and Note [The Purely Kinded Type Invariant (PKTI)] in GHC.Tc.Gen.HsType,</span>
<a name="line-1505"></a><span class='hs-comment'>--         Wrinkle around FunTy</span>
<a name="line-1506"></a><span class='hs-definition'>tcRepSplitTyConApp_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1507"></a><span class='hs-definition'>tcRepSplitTyConApp_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-conid'>VisArg</span> <span class='hs-varid'>w</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-1508"></a>  <span class='hs-comment'>-- NB: VisArg. See Note [Decomposing fat arrow c=&gt;t]</span>
<a name="line-1509"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>arg_rep</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getRuntimeRep_maybe</span> <span class='hs-varid'>arg</span>
<a name="line-1510"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>res_rep</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getRuntimeRep_maybe</span> <span class='hs-varid'>res</span>
<a name="line-1511"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>funTyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_rep</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_rep</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1512"></a><span class='hs-definition'>tcRepSplitTyConApp_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1513"></a>
<a name="line-1514"></a><a name="splitListTyConApp_maybe"></a><span class='hs-comment'>-------------------</span>
<a name="line-1515"></a><span class='hs-comment'>-- | Attempts to tease a list type apart and gives the type of the elements if</span>
<a name="line-1516"></a><span class='hs-comment'>-- successful (looks through type synonyms)</span>
<a name="line-1517"></a><span class='hs-definition'>splitListTyConApp_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-1518"></a><span class='hs-definition'>splitListTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-1519"></a>  <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>e</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>listTyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>e</span>
<a name="line-1520"></a>  <span class='hs-sel'>_other</span>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1521"></a>
<a name="line-1522"></a><a name="newTyConInstRhs"></a><span class='hs-definition'>newTyConInstRhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1523"></a><span class='hs-comment'>-- ^ Unwrap one 'layer' of newtype on a type constructor and its</span>
<a name="line-1524"></a><span class='hs-comment'>-- arguments, using an eta-reduced version of the @newtype@ if possible.</span>
<a name="line-1525"></a><span class='hs-comment'>-- This requires tys to have at least @newTyConInstArity tycon@ elements.</span>
<a name="line-1526"></a><span class='hs-definition'>newTyConInstRhs</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tys</span>
<a name="line-1527"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`leLength`</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tycon</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>)</span>
<a name="line-1528"></a>      <span class='hs-varid'>applyTysX</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>tys</span>
<a name="line-1529"></a>  <span class='hs-keyword'>where</span>
<a name="line-1530"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newTyConEtadRhs</span> <span class='hs-varid'>tycon</span>
<a name="line-1531"></a>
<a name="line-1532"></a><span class='hs-comment'>{-
<a name="line-1533"></a>---------------------------------------------------------------------
<a name="line-1534"></a>                           CastTy
<a name="line-1535"></a>                           ~~~~~~
<a name="line-1536"></a>A casted type has its *kind* casted into something new.
<a name="line-1537"></a>-}</span>
<a name="line-1538"></a>
<a name="line-1539"></a><a name="splitCastTy_maybe"></a><span class='hs-definition'>splitCastTy_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-1540"></a><span class='hs-definition'>splitCastTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1541"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1542"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1543"></a>
<a name="line-1544"></a><a name="mkCastTy"></a><span class='hs-comment'>-- | Make a 'CastTy'. The Coercion must be nominal. Checks the</span>
<a name="line-1545"></a><span class='hs-comment'>-- Coercion for reflexivity, dropping it if it's reflexive.</span>
<a name="line-1546"></a><span class='hs-comment'>-- See Note [Respecting definitional equality] in "GHC.Core.TyCo.Rep"</span>
<a name="line-1547"></a><span class='hs-definition'>mkCastTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1548"></a><span class='hs-definition'>mkCastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isReflexiveCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>  <span class='hs-comment'>-- (EQ2) from the Note</span>
<a name="line-1549"></a><span class='hs-comment'>-- NB: Do the slow check here. This is important to keep the splitXXX</span>
<a name="line-1550"></a><span class='hs-comment'>-- functions working properly. Otherwise, we may end up with something</span>
<a name="line-1551"></a><span class='hs-comment'>-- like (((-&gt;) |&gt; something_reflexive_but_not_obviously_so) biz baz)</span>
<a name="line-1552"></a><span class='hs-comment'>-- fails under splitFunTy_maybe. This happened with the cheaper check</span>
<a name="line-1553"></a><span class='hs-comment'>-- in test dependent/should_compile/dynamic-paper.</span>
<a name="line-1554"></a>
<a name="line-1555"></a><span class='hs-definition'>mkCastTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varid'>co2</span>
<a name="line-1556"></a>  <span class='hs-comment'>-- (EQ3) from the Note</span>
<a name="line-1557"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCastTy</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>co1</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1558"></a>      <span class='hs-comment'>-- call mkCastTy again for the reflexivity check</span>
<a name="line-1559"></a>
<a name="line-1560"></a><span class='hs-definition'>mkCastTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-varid'>inner_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-1561"></a>  <span class='hs-comment'>-- (EQ4) from the Note</span>
<a name="line-1562"></a>  <span class='hs-comment'>-- See Note [Weird typing rule for ForAllTy] in GHC.Core.TyCo.Rep.</span>
<a name="line-1563"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-1564"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1565"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- have to make sure that pushing the co in doesn't capture the bound var!</span>
<a name="line-1566"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>fvs</span>
<a name="line-1567"></a>    <span class='hs-keyword'>then</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>empty_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
<a name="line-1568"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substVarBndr</span> <span class='hs-varid'>empty_subst</span> <span class='hs-varid'>tv</span>
<a name="line-1569"></a>         <span class='hs-keyword'>in</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv'</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>inner_ty</span> <span class='hs-varop'>`mkCastTy`</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1570"></a>    <span class='hs-keyword'>else</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>inner_ty</span> <span class='hs-varop'>`mkCastTy`</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1571"></a>
<a name="line-1572"></a><span class='hs-definition'>mkCastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span>
<a name="line-1573"></a>
<a name="line-1574"></a><a name="tyConBindersTyCoBinders"></a><span class='hs-definition'>tyConBindersTyCoBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyConBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoBinder</span><span class='hs-keyglyph'>]</span>
<a name="line-1575"></a><span class='hs-comment'>-- Return the tyConBinders in TyCoBinder form</span>
<a name="line-1576"></a><span class='hs-definition'>tyConBindersTyCoBinders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>to_tyb</span>
<a name="line-1577"></a>  <span class='hs-keyword'>where</span>
<a name="line-1578"></a>    <span class='hs-varid'>to_tyb</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>NamedTCB</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span>
<a name="line-1579"></a>    <span class='hs-varid'>to_tyb</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnonTCB</span> <span class='hs-varid'>af</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Anon</span> <span class='hs-varid'>af</span> <span class='hs-layout'>(</span><span class='hs-varid'>tymult</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1580"></a>
<a name="line-1581"></a><a name="mkTyConTy"></a><span class='hs-comment'>-- | Create the plain type constructor type which has been applied to no type arguments at all.</span>
<a name="line-1582"></a><span class='hs-definition'>mkTyConTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1583"></a><span class='hs-definition'>mkTyConTy</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConNullaryTy</span> <span class='hs-varid'>tycon</span>
<a name="line-1584"></a>  <span class='hs-comment'>-- see Note [Sharing nullary TyConApps] in GHC.Core.TyCon</span>
<a name="line-1585"></a>
<a name="line-1586"></a><a name="mkTyConApp"></a><span class='hs-comment'>-- | A key function: builds a 'TyConApp' or 'FunTy' as appropriate to</span>
<a name="line-1587"></a><span class='hs-comment'>-- its arguments.  Applies its arguments to the constructor from left to right.</span>
<a name="line-1588"></a><span class='hs-definition'>mkTyConApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1589"></a><span class='hs-definition'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tys</span>
<a name="line-1590"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>tys</span>
<a name="line-1591"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConTy</span> <span class='hs-varid'>tycon</span>
<a name="line-1592"></a>
<a name="line-1593"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFunTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-1594"></a>  <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-sel'>_rep1</span><span class='hs-layout'>,</span><span class='hs-sel'>_rep2</span><span class='hs-layout'>,</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tys</span>
<a name="line-1595"></a>  <span class='hs-comment'>-- The FunTyCon (-&gt;) is always a visible one</span>
<a name="line-1596"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_af</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VisArg</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_mult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>}</span>
<a name="line-1597"></a>
<a name="line-1598"></a>  <span class='hs-comment'>-- See Note [Prefer Type over TYPE 'LiftedRep].</span>
<a name="line-1599"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tycon</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>tYPETyConKey</span>
<a name="line-1600"></a>  <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>rep</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tys</span>
<a name="line-1601"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tYPE</span> <span class='hs-varid'>rep</span>
<a name="line-1602"></a>  <span class='hs-comment'>-- The catch-all case</span>
<a name="line-1603"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1604"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tys</span>
<a name="line-1605"></a>
<a name="line-1606"></a><span class='hs-comment'>{-
<a name="line-1607"></a>Note [Prefer Type over TYPE 'LiftedRep]
<a name="line-1608"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1609"></a>The Core of nearly any program will have numerous occurrences of
<a name="line-1610"></a>@TYPE 'LiftedRep@ (and, equivalently, 'Type') floating about. Concretely, while
<a name="line-1611"></a>investigating #17292 we found that these constituting a majority of TyConApp
<a name="line-1612"></a>constructors on the heap:
<a name="line-1613"></a>
<a name="line-1614"></a>```
<a name="line-1615"></a>(From a sample of 100000 TyConApp closures)
<a name="line-1616"></a>0x45f3523    - 28732 - `Type`
<a name="line-1617"></a>0x420b840702 - 9629  - generic type constructors
<a name="line-1618"></a>0x42055b7e46 - 9596
<a name="line-1619"></a>0x420559b582 - 9511
<a name="line-1620"></a>0x420bb15a1e - 9509
<a name="line-1621"></a>0x420b86c6ba - 9501
<a name="line-1622"></a>0x42055bac1e - 9496
<a name="line-1623"></a>0x45e68fd    - 538 - `TYPE ...`
<a name="line-1624"></a>```
<a name="line-1625"></a>
<a name="line-1626"></a>Consequently, we try hard to ensure that operations on such types are
<a name="line-1627"></a>efficient. Specifically, we strive to
<a name="line-1628"></a>
<a name="line-1629"></a> a. Avoid heap allocation of such types
<a name="line-1630"></a> b. Use a small (shallow in the tree-depth sense) representation
<a name="line-1631"></a>    for such types
<a name="line-1632"></a>
<a name="line-1633"></a>Goal (b) is particularly useful as it makes traversals (e.g. free variable
<a name="line-1634"></a>traversal, substitution, and comparison) more efficient.
<a name="line-1635"></a>Comparison in particular takes special advantage of nullary type synonym
<a name="line-1636"></a>applications (e.g. things like @TyConApp typeTyCon []@), Note [Comparing
<a name="line-1637"></a>nullary type synonyms] in "GHC.Core.Type".
<a name="line-1638"></a>
<a name="line-1639"></a>To accomplish these we use a number of tricks:
<a name="line-1640"></a>
<a name="line-1641"></a> 1. Instead of representing the lifted kind as
<a name="line-1642"></a>    @TyConApp tYPETyCon [liftedRepDataCon]@ we rather prefer to
<a name="line-1643"></a>    use the 'GHC.Types.Type' type synonym (represented as a nullary TyConApp).
<a name="line-1644"></a>    This serves goal (b) since there are no applied type arguments to traverse,
<a name="line-1645"></a>    e.g., during comparison.
<a name="line-1646"></a>
<a name="line-1647"></a> 2. We have a top-level binding to represent `TyConApp GHC.Types.Type []`
<a name="line-1648"></a>    (namely 'GHC.Builtin.Types.Prim.liftedTypeKind'), ensuring that we
<a name="line-1649"></a>    don't need to allocate such types (goal (a)).
<a name="line-1650"></a>
<a name="line-1651"></a> 3. We use the sharing mechanism described in Note [Sharing nullary TyConApps]
<a name="line-1652"></a>    in GHC.Core.TyCon to ensure that we never need to allocate such
<a name="line-1653"></a>    nullary applications (goal (a)).
<a name="line-1654"></a>
<a name="line-1655"></a>See #17958.
<a name="line-1656"></a>-}</span>
<a name="line-1657"></a>
<a name="line-1658"></a>
<a name="line-1659"></a><a name="tYPE"></a><span class='hs-comment'>-- | Given a @RuntimeRep@, applies @TYPE@ to it.</span>
<a name="line-1660"></a><span class='hs-comment'>-- See Note [TYPE and RuntimeRep] in GHC.Builtin.Types.Prim.</span>
<a name="line-1661"></a><span class='hs-definition'>tYPE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1662"></a><span class='hs-definition'>tYPE</span> <span class='hs-varid'>rr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1663"></a>  <span class='hs-comment'>-- See Note [Prefer Type of TYPE 'LiftedRep]</span>
<a name="line-1664"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>boxedRepDataConKey</span>
<a name="line-1665"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc'</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>arg</span>
<a name="line-1666"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc'</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>liftedDataConKey</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftedTypeKind</span>   <span class='hs-comment'>-- TYPE (BoxedRep 'Lifted)</span>
<a name="line-1667"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc'</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>unliftedDataConKey</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unliftedTypeKind</span> <span class='hs-comment'>-- TYPE (BoxedRep 'Unlifted)</span>
<a name="line-1668"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tYPETyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>rr</span><span class='hs-keyglyph'>]</span>
<a name="line-1669"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>liftedRepTyCon</span>                               <span class='hs-comment'>-- TYPE LiftedRep</span>
<a name="line-1670"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-1671"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>unliftedRepTyCon</span>                             <span class='hs-comment'>-- TYPE UnliftedRep</span>
<a name="line-1672"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unliftedTypeKind</span>
<a name="line-1673"></a><span class='hs-definition'>tYPE</span> <span class='hs-varid'>rr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tYPETyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>rr</span><span class='hs-keyglyph'>]</span>
<a name="line-1674"></a>
<a name="line-1675"></a>
<a name="line-1676"></a><span class='hs-comment'>{-
<a name="line-1677"></a>--------------------------------------------------------------------
<a name="line-1678"></a>                            CoercionTy
<a name="line-1679"></a>                            ~~~~~~~~~~
<a name="line-1680"></a>CoercionTy allows us to inject coercions into types. A CoercionTy
<a name="line-1681"></a>should appear only in the right-hand side of an application.
<a name="line-1682"></a>-}</span>
<a name="line-1683"></a>
<a name="line-1684"></a><a name="mkCoercionTy"></a><span class='hs-definition'>mkCoercionTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1685"></a><span class='hs-definition'>mkCoercionTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoercionTy</span>
<a name="line-1686"></a>
<a name="line-1687"></a><a name="isCoercionTy"></a><span class='hs-definition'>isCoercionTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1688"></a><span class='hs-definition'>isCoercionTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1689"></a><span class='hs-definition'>isCoercionTy</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1690"></a>
<a name="line-1691"></a><a name="isCoercionTy_maybe"></a><span class='hs-definition'>isCoercionTy_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-1692"></a><span class='hs-definition'>isCoercionTy_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span>
<a name="line-1693"></a><span class='hs-definition'>isCoercionTy_maybe</span> <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1694"></a>
<a name="line-1695"></a><a name="stripCoercionTy"></a><span class='hs-definition'>stripCoercionTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1696"></a><span class='hs-definition'>stripCoercionTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-1697"></a><span class='hs-definition'>stripCoercionTy</span> <span class='hs-varid'>ty</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"stripCoercionTy"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1698"></a>
<a name="line-1699"></a><span class='hs-comment'>{-
<a name="line-1700"></a>---------------------------------------------------------------------
<a name="line-1701"></a>                                SynTy
<a name="line-1702"></a>                                ~~~~~
<a name="line-1703"></a>
<a name="line-1704"></a>Notes on type synonyms
<a name="line-1705"></a>~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1706"></a>The various "split" functions (splitFunTy, splitRhoTy, splitForAllTy) try
<a name="line-1707"></a>to return type synonyms wherever possible. Thus
<a name="line-1708"></a>
<a name="line-1709"></a>        type Foo a = a -&gt; a
<a name="line-1710"></a>
<a name="line-1711"></a>we want
<a name="line-1712"></a>        splitFunTys (a -&gt; Foo a) = ([a], Foo a)
<a name="line-1713"></a>not                                ([a], a -&gt; a)
<a name="line-1714"></a>
<a name="line-1715"></a>The reason is that we then get better (shorter) type signatures in
<a name="line-1716"></a>interfaces.  Notably this plays a role in tcTySigs in GHC.Tc.Gen.Bind.
<a name="line-1717"></a>
<a name="line-1718"></a>
<a name="line-1719"></a>---------------------------------------------------------------------
<a name="line-1720"></a>                                ForAllTy
<a name="line-1721"></a>                                ~~~~~~~~
<a name="line-1722"></a>-}</span>
<a name="line-1723"></a>
<a name="line-1724"></a><a name="mkTyCoInvForAllTy"></a><span class='hs-comment'>-- | Make a dependent forall over an 'Inferred' variable</span>
<a name="line-1725"></a><span class='hs-definition'>mkTyCoInvForAllTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1726"></a><span class='hs-definition'>mkTyCoInvForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-1727"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>tv</span>
<a name="line-1728"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1729"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVisFunTyMany</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1730"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1731"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-conid'>Inferred</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1732"></a>
<a name="line-1733"></a><a name="mkInfForAllTy"></a><span class='hs-comment'>-- | Like 'mkTyCoInvForAllTy', but tv should be a tyvar</span>
<a name="line-1734"></a><span class='hs-definition'>mkInfForAllTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1735"></a><span class='hs-definition'>mkInfForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-1736"></a>                      <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-conid'>Inferred</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1737"></a>
<a name="line-1738"></a><a name="mkTyCoInvForAllTys"></a><span class='hs-comment'>-- | Like 'mkForAllTys', but assumes all variables are dependent and</span>
<a name="line-1739"></a><span class='hs-comment'>-- 'Inferred', a common case</span>
<a name="line-1740"></a><span class='hs-definition'>mkTyCoInvForAllTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1741"></a><span class='hs-definition'>mkTyCoInvForAllTys</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>mkTyCoInvForAllTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tvs</span>
<a name="line-1742"></a>
<a name="line-1743"></a><a name="mkInfForAllTys"></a><span class='hs-comment'>-- | Like 'mkTyCoInvForAllTys', but tvs should be a list of tyvar</span>
<a name="line-1744"></a><span class='hs-definition'>mkInfForAllTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1745"></a><span class='hs-definition'>mkInfForAllTys</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>mkInfForAllTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tvs</span>
<a name="line-1746"></a>
<a name="line-1747"></a><a name="mkSpecForAllTy"></a><span class='hs-comment'>-- | Like 'mkForAllTy', but assumes the variable is dependent and 'Specified',</span>
<a name="line-1748"></a><span class='hs-comment'>-- a common case</span>
<a name="line-1749"></a><span class='hs-definition'>mkSpecForAllTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1750"></a><span class='hs-definition'>mkSpecForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-1751"></a>                       <span class='hs-comment'>-- covar is always Inferred, so input should be tyvar</span>
<a name="line-1752"></a>                       <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-conid'>Specified</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1753"></a>
<a name="line-1754"></a><a name="mkSpecForAllTys"></a><span class='hs-comment'>-- | Like 'mkForAllTys', but assumes all variables are dependent and</span>
<a name="line-1755"></a><span class='hs-comment'>-- 'Specified', a common case</span>
<a name="line-1756"></a><span class='hs-definition'>mkSpecForAllTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1757"></a><span class='hs-definition'>mkSpecForAllTys</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>mkSpecForAllTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tvs</span>
<a name="line-1758"></a>
<a name="line-1759"></a><a name="mkVisForAllTys"></a><span class='hs-comment'>-- | Like mkForAllTys, but assumes all variables are dependent and visible</span>
<a name="line-1760"></a><span class='hs-definition'>mkVisForAllTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1761"></a><span class='hs-definition'>mkVisForAllTys</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>)</span>
<a name="line-1762"></a>                     <span class='hs-comment'>-- covar is always Inferred, so all inputs should be tyvar</span>
<a name="line-1763"></a>                     <span class='hs-varid'>mkForAllTys</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-conid'>Required</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>]</span>
<a name="line-1764"></a>
<a name="line-1765"></a><a name="mkTyConBindersPreferAnon"></a><span class='hs-comment'>-- | Given a list of type-level vars and the free vars of a result kind,</span>
<a name="line-1766"></a><span class='hs-comment'>-- makes TyCoBinders, preferring anonymous binders</span>
<a name="line-1767"></a><span class='hs-comment'>-- if the variable is, in fact, not dependent.</span>
<a name="line-1768"></a><span class='hs-comment'>-- e.g.    mkTyConBindersPreferAnon [(k:*),(b:k),(c:k)] (k-&gt;k)</span>
<a name="line-1769"></a><span class='hs-comment'>-- We want (k:*) Named, (b:k) Anon, (c:k) Anon</span>
<a name="line-1770"></a><span class='hs-comment'>--</span>
<a name="line-1771"></a><span class='hs-comment'>-- All non-coercion binders are /visible/.</span>
<a name="line-1772"></a><span class='hs-definition'>mkTyConBindersPreferAnon</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- ^ binders</span>
<a name="line-1773"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>   <span class='hs-comment'>-- ^ free variables of result</span>
<a name="line-1774"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyConBinder</span><span class='hs-keyglyph'>]</span>
<a name="line-1775"></a><span class='hs-definition'>mkTyConBindersPreferAnon</span> <span class='hs-varid'>vars</span> <span class='hs-varid'>inner_tkvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>vars</span><span class='hs-layout'>)</span>
<a name="line-1776"></a>                                           <span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>vars</span><span class='hs-layout'>)</span>
<a name="line-1777"></a>  <span class='hs-keyword'>where</span>
<a name="line-1778"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyConBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>VarSet</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- also returns the free vars</span>
<a name="line-1779"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>inner_tkvs</span><span class='hs-layout'>)</span>
<a name="line-1780"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>fvs</span>
<a name="line-1781"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Bndr</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>NamedTCB</span> <span class='hs-conid'>Required</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>binders</span>
<a name="line-1782"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span> <span class='hs-varop'>`delVarSet`</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>kind_vars</span> <span class='hs-layout'>)</span>
<a name="line-1783"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1784"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Bndr</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnonTCB</span> <span class='hs-conid'>VisArg</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>binders</span>
<a name="line-1785"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>kind_vars</span> <span class='hs-layout'>)</span>
<a name="line-1786"></a>      <span class='hs-keyword'>where</span>
<a name="line-1787"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>binders</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>vs</span>
<a name="line-1788"></a>        <span class='hs-varid'>kind_vars</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>v</span>
<a name="line-1789"></a>
<a name="line-1790"></a><a name="splitForAllTyCoVars"></a><span class='hs-comment'>-- | Take a ForAllTy apart, returning the list of tycovars and the result type.</span>
<a name="line-1791"></a><span class='hs-comment'>-- This always succeeds, even if it returns only an empty list. Note that the</span>
<a name="line-1792"></a><span class='hs-comment'>-- result type returned may have free variables that were bound by a forall.</span>
<a name="line-1793"></a><span class='hs-definition'>splitForAllTyCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1794"></a><span class='hs-definition'>splitForAllTyCoVars</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span>
<a name="line-1795"></a>  <span class='hs-keyword'>where</span>
<a name="line-1796"></a>    <span class='hs-varid'>split</span> <span class='hs-keyword'>_</span>       <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>    <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-1797"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>tvs</span>
<a name="line-1798"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-keyword'>_</span>                            <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig_ty</span><span class='hs-layout'>)</span>
<a name="line-1799"></a>
<a name="line-1800"></a><a name="splitSomeForAllTyCoVarBndrs"></a><span class='hs-comment'>-- | Splits the longest initial sequence of 'ForAllTy's that satisfy</span>
<a name="line-1801"></a><span class='hs-comment'>-- @argf_pred@, returning the binders transformed by @argf_pred@</span>
<a name="line-1802"></a><span class='hs-definition'>splitSomeForAllTyCoVarBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArgFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>af</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>VarBndr</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-varid'>af</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1803"></a><span class='hs-definition'>splitSomeForAllTyCoVarBndrs</span> <span class='hs-varid'>argf_pred</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span>
<a name="line-1804"></a>  <span class='hs-keyword'>where</span>
<a name="line-1805"></a>    <span class='hs-varid'>split</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tcv</span> <span class='hs-varid'>argf</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span>
<a name="line-1806"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>argf'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>argf_pred</span> <span class='hs-varid'>argf</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tcv</span> <span class='hs-varid'>argf'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-1807"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>tvs</span>
<a name="line-1808"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-keyword'>_</span>                            <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig_ty</span><span class='hs-layout'>)</span>
<a name="line-1809"></a>
<a name="line-1810"></a><a name="splitForAllReqTVBinders"></a><span class='hs-comment'>-- | Like 'splitForAllTyCoVars', but only splits 'ForAllTy's with 'Required' type</span>
<a name="line-1811"></a><span class='hs-comment'>-- variable binders. Furthermore, each returned tyvar is annotated with '()'.</span>
<a name="line-1812"></a><span class='hs-definition'>splitForAllReqTVBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>ReqTVBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1813"></a><span class='hs-definition'>splitForAllReqTVBinders</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitSomeForAllTyCoVarBndrs</span> <span class='hs-varid'>argf_pred</span> <span class='hs-varid'>ty</span>
<a name="line-1814"></a>  <span class='hs-keyword'>where</span>
<a name="line-1815"></a>    <span class='hs-varid'>argf_pred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ArgFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>()</span>
<a name="line-1816"></a>    <span class='hs-varid'>argf_pred</span> <span class='hs-conid'>Required</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>()</span>
<a name="line-1817"></a>    <span class='hs-varid'>argf_pred</span> <span class='hs-layout'>(</span><span class='hs-conid'>Invisible</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1818"></a>
<a name="line-1819"></a><a name="splitForAllInvisTVBinders"></a><span class='hs-comment'>-- | Like 'splitForAllTyCoVars', but only splits 'ForAllTy's with 'Invisible' type</span>
<a name="line-1820"></a><span class='hs-comment'>-- variable binders. Furthermore, each returned tyvar is annotated with its</span>
<a name="line-1821"></a><span class='hs-comment'>-- 'Specificity'.</span>
<a name="line-1822"></a><span class='hs-definition'>splitForAllInvisTVBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>InvisTVBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1823"></a><span class='hs-definition'>splitForAllInvisTVBinders</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitSomeForAllTyCoVarBndrs</span> <span class='hs-varid'>argf_pred</span> <span class='hs-varid'>ty</span>
<a name="line-1824"></a>  <span class='hs-keyword'>where</span>
<a name="line-1825"></a>    <span class='hs-varid'>argf_pred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ArgFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Specificity</span>
<a name="line-1826"></a>    <span class='hs-varid'>argf_pred</span> <span class='hs-conid'>Required</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1827"></a>    <span class='hs-varid'>argf_pred</span> <span class='hs-layout'>(</span><span class='hs-conid'>Invisible</span> <span class='hs-varid'>spec</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>spec</span>
<a name="line-1828"></a>
<a name="line-1829"></a><a name="splitForAllTyVars"></a><span class='hs-comment'>-- | Like 'splitForAllTyCoVars', but split only for tyvars.</span>
<a name="line-1830"></a><span class='hs-comment'>-- This always succeeds, even if it returns only an empty list. Note that the</span>
<a name="line-1831"></a><span class='hs-comment'>-- result type returned may have free variables that were bound by a forall.</span>
<a name="line-1832"></a><span class='hs-definition'>splitForAllTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1833"></a><span class='hs-definition'>splitForAllTyVars</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span>
<a name="line-1834"></a>  <span class='hs-keyword'>where</span>
<a name="line-1835"></a>    <span class='hs-varid'>split</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-1836"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>tvs</span>
<a name="line-1837"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-keyword'>_</span>                   <span class='hs-varid'>tvs</span>              <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig_ty</span><span class='hs-layout'>)</span>
<a name="line-1838"></a>
<a name="line-1839"></a><a name="isForAllTy"></a><span class='hs-comment'>-- | Checks whether this is a proper forall (with a named binder)</span>
<a name="line-1840"></a><span class='hs-definition'>isForAllTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1841"></a><span class='hs-definition'>isForAllTy</span> <span class='hs-varid'>ty</span>
<a name="line-1842"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1843"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1844"></a>
<a name="line-1845"></a><a name="isForAllTy_ty"></a><span class='hs-comment'>-- | Like `isForAllTy`, but returns True only if it is a tyvar binder</span>
<a name="line-1846"></a><span class='hs-definition'>isForAllTy_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1847"></a><span class='hs-definition'>isForAllTy_ty</span> <span class='hs-varid'>ty</span>
<a name="line-1848"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>ty</span>
<a name="line-1849"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-1850"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1851"></a>
<a name="line-1852"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1853"></a>
<a name="line-1854"></a><a name="isForAllTy_co"></a><span class='hs-comment'>-- | Like `isForAllTy`, but returns True only if it is a covar binder</span>
<a name="line-1855"></a><span class='hs-definition'>isForAllTy_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1856"></a><span class='hs-definition'>isForAllTy_co</span> <span class='hs-varid'>ty</span>
<a name="line-1857"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>ty</span>
<a name="line-1858"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>tv</span>
<a name="line-1859"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1860"></a>
<a name="line-1861"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1862"></a>
<a name="line-1863"></a><a name="isPiTy"></a><span class='hs-comment'>-- | Is this a function or forall?</span>
<a name="line-1864"></a><span class='hs-definition'>isPiTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1865"></a><span class='hs-definition'>isPiTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-1866"></a>  <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1867"></a>  <span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1868"></a>  <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1869"></a>
<a name="line-1870"></a><a name="isFunTy"></a><span class='hs-comment'>-- | Is this a function?</span>
<a name="line-1871"></a><span class='hs-definition'>isFunTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1872"></a><span class='hs-definition'>isFunTy</span> <span class='hs-varid'>ty</span>
<a name="line-1873"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1874"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1875"></a>
<a name="line-1876"></a><a name="splitForAllTyCoVar"></a><span class='hs-comment'>-- | Take a forall type apart, or panics if that is not possible.</span>
<a name="line-1877"></a><span class='hs-definition'>splitForAllTyCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCoVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1878"></a><span class='hs-definition'>splitForAllTyCoVar</span> <span class='hs-varid'>ty</span>
<a name="line-1879"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>answer</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllTyCoVar_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>answer</span>
<a name="line-1880"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"splitForAllTyCoVar"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1881"></a>
<a name="line-1882"></a><a name="dropForAlls"></a><span class='hs-comment'>-- | Drops all ForAllTys</span>
<a name="line-1883"></a><span class='hs-definition'>dropForAlls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1884"></a><span class='hs-definition'>dropForAlls</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-1885"></a>  <span class='hs-keyword'>where</span>
<a name="line-1886"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>res</span>
<a name="line-1887"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty'</span>
<a name="line-1888"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>res</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res</span>
<a name="line-1889"></a>
<a name="line-1890"></a><a name="splitForAllTyCoVar_maybe"></a><span class='hs-comment'>-- | Attempts to take a forall type apart, but only if it's a proper forall,</span>
<a name="line-1891"></a><span class='hs-comment'>-- with a named binder</span>
<a name="line-1892"></a><span class='hs-definition'>splitForAllTyCoVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCoVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1893"></a><span class='hs-definition'>splitForAllTyCoVar_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1894"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>inner_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>inner_ty</span><span class='hs-layout'>)</span>
<a name="line-1895"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1896"></a>
<a name="line-1897"></a><a name="splitForAllTyVar_maybe"></a><span class='hs-comment'>-- | Like 'splitForAllTyCoVar_maybe', but only returns Just if it is a tyvar binder.</span>
<a name="line-1898"></a><span class='hs-definition'>splitForAllTyVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCoVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1899"></a><span class='hs-definition'>splitForAllTyVar_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1900"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>inner_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>ty</span>
<a name="line-1901"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-1902"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>inner_ty</span><span class='hs-layout'>)</span>
<a name="line-1903"></a>
<a name="line-1904"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1905"></a>
<a name="line-1906"></a><a name="splitForAllCoVar_maybe"></a><span class='hs-comment'>-- | Like 'splitForAllTyCoVar_maybe', but only returns Just if it is a covar binder.</span>
<a name="line-1907"></a><span class='hs-definition'>splitForAllCoVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCoVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1908"></a><span class='hs-definition'>splitForAllCoVar_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1909"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>inner_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>ty</span>
<a name="line-1910"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>tv</span>
<a name="line-1911"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>inner_ty</span><span class='hs-layout'>)</span>
<a name="line-1912"></a>
<a name="line-1913"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1914"></a>
<a name="line-1915"></a><span class='hs-comment'>-- | Attempts to take a forall type apart; works with proper foralls and</span>
<a name="line-1916"></a><span class='hs-comment'>-- functions</span>
<a name="line-1917"></a><span class='hs-comment'>{-# INLINE splitPiTy_maybe #-}</span>  <span class='hs-comment'>-- callers will immediately deconstruct</span>
<a name="line-1918"></a><a name="splitPiTy_maybe"></a><span class='hs-definition'>splitPiTy_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCoBinder</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1919"></a><span class='hs-definition'>splitPiTy_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>coreFullView</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-1920"></a>  <span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1921"></a>  <span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_af</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>af</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_mult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res</span><span class='hs-layout'>}</span>
<a name="line-1922"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>af</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkScaled</span> <span class='hs-varid'>w</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-1923"></a>  <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1924"></a>
<a name="line-1925"></a><a name="splitPiTy"></a><span class='hs-comment'>-- | Takes a forall type apart, or panics</span>
<a name="line-1926"></a><span class='hs-definition'>splitPiTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCoBinder</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1927"></a><span class='hs-definition'>splitPiTy</span> <span class='hs-varid'>ty</span>
<a name="line-1928"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>answer</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitPiTy_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>answer</span>
<a name="line-1929"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"splitPiTy"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1930"></a>
<a name="line-1931"></a><a name="splitPiTys"></a><span class='hs-comment'>-- | Split off all TyCoBinders to a type, splitting both proper foralls</span>
<a name="line-1932"></a><span class='hs-comment'>-- and functions</span>
<a name="line-1933"></a><span class='hs-definition'>splitPiTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1934"></a><span class='hs-definition'>splitPiTys</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span>
<a name="line-1935"></a>  <span class='hs-keyword'>where</span>
<a name="line-1936"></a>    <span class='hs-varid'>split</span> <span class='hs-keyword'>_</span>       <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>b</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>res</span> <span class='hs-varid'>res</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>b</span>  <span class='hs-conop'>:</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-1937"></a>    <span class='hs-varid'>split</span> <span class='hs-keyword'>_</span>       <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_af</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>af</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_mult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>bs</span>
<a name="line-1938"></a>                                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>res</span> <span class='hs-varid'>res</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>af</span> <span class='hs-layout'>(</span><span class='hs-conid'>Scaled</span> <span class='hs-varid'>w</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-1939"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>bs</span>
<a name="line-1940"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-keyword'>_</span>                <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig_ty</span><span class='hs-layout'>)</span>
<a name="line-1941"></a>
<a name="line-1942"></a><a name="splitForAllTyCoVarBinders"></a><span class='hs-comment'>-- | Like 'splitPiTys' but split off only /named/ binders</span>
<a name="line-1943"></a><span class='hs-comment'>--   and returns 'TyCoVarBinder's rather than 'TyCoBinder's</span>
<a name="line-1944"></a><span class='hs-definition'>splitForAllTyCoVarBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVarBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1945"></a><span class='hs-definition'>splitForAllTyCoVarBinders</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span>
<a name="line-1946"></a>  <span class='hs-keyword'>where</span>
<a name="line-1947"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>bs</span>
<a name="line-1948"></a>    <span class='hs-varid'>split</span> <span class='hs-keyword'>_</span>       <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>b</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>res</span> <span class='hs-varid'>res</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-1949"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-keyword'>_</span>                <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig_ty</span><span class='hs-layout'>)</span>
<a name="line-1950"></a><span class='hs-comment'>{-# INLINE splitForAllTyCoVarBinders #-}</span>
<a name="line-1951"></a>
<a name="line-1952"></a><a name="invisibleTyBndrCount"></a><span class='hs-definition'>invisibleTyBndrCount</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-1953"></a><span class='hs-comment'>-- Returns the number of leading invisible forall'd binders in the type</span>
<a name="line-1954"></a><span class='hs-comment'>-- Includes invisible predicate arguments; e.g. for</span>
<a name="line-1955"></a><span class='hs-comment'>--    e.g.  forall {k}. (k ~ *) =&gt; k -&gt; k</span>
<a name="line-1956"></a><span class='hs-comment'>-- returns 2 not 1</span>
<a name="line-1957"></a><span class='hs-definition'>invisibleTyBndrCount</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitInvisPiTys</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1958"></a>
<a name="line-1959"></a><a name="splitInvisPiTys"></a><span class='hs-comment'>-- | Like 'splitPiTys', but returns only *invisible* binders, including constraints.</span>
<a name="line-1960"></a><span class='hs-comment'>-- Stops at the first visible binder.</span>
<a name="line-1961"></a><span class='hs-definition'>splitInvisPiTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1962"></a><span class='hs-definition'>splitInvisPiTys</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span>
<a name="line-1963"></a>   <span class='hs-keyword'>where</span>
<a name="line-1964"></a>    <span class='hs-varid'>split</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>b</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>bs</span>
<a name="line-1965"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Bndr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>vis</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>b</span>
<a name="line-1966"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>isInvisibleArgFlag</span> <span class='hs-varid'>vis</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>res</span> <span class='hs-varid'>res</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>b</span>  <span class='hs-conop'>:</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-1967"></a>    <span class='hs-varid'>split</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_af</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InvisArg</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_mult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mult</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-varid'>bs</span>
<a name="line-1968"></a>                                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>res</span> <span class='hs-varid'>res</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-conid'>InvisArg</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkScaled</span> <span class='hs-varid'>mult</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-1969"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>bs</span>
<a name="line-1970"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>bs</span>
<a name="line-1971"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-keyword'>_</span>          <span class='hs-varid'>bs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig_ty</span><span class='hs-layout'>)</span>
<a name="line-1972"></a>
<a name="line-1973"></a><a name="splitInvisPiTysN"></a><span class='hs-definition'>splitInvisPiTysN</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1974"></a><span class='hs-comment'>-- ^ Same as 'splitInvisPiTys', but stop when</span>
<a name="line-1975"></a><span class='hs-comment'>--   - you have found @n@ 'TyCoBinder's,</span>
<a name="line-1976"></a><span class='hs-comment'>--   - or you run out of invisible binders</span>
<a name="line-1977"></a><span class='hs-definition'>splitInvisPiTysN</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span>
<a name="line-1978"></a>   <span class='hs-keyword'>where</span>
<a name="line-1979"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>n</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>bs</span>
<a name="line-1980"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig_ty</span><span class='hs-layout'>)</span>
<a name="line-1981"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>n</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>bs</span>
<a name="line-1982"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>b</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ty</span>
<a name="line-1983"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Bndr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>vis</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>b</span>
<a name="line-1984"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>isInvisibleArgFlag</span> <span class='hs-varid'>vis</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span> <span class='hs-varid'>res</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>b</span>  <span class='hs-conop'>:</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-1985"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_af</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InvisArg</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_mult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mult</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ty</span>
<a name="line-1986"></a>                                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span> <span class='hs-varid'>res</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-conid'>InvisArg</span> <span class='hs-layout'>(</span><span class='hs-conid'>Scaled</span> <span class='hs-varid'>mult</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-1987"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>               <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig_ty</span><span class='hs-layout'>)</span>
<a name="line-1988"></a>
<a name="line-1989"></a><a name="filterOutInvisibleTypes"></a><span class='hs-comment'>-- | Given a 'TyCon' and a list of argument types, filter out any invisible</span>
<a name="line-1990"></a><span class='hs-comment'>-- (i.e., 'Inferred' or 'Specified') arguments.</span>
<a name="line-1991"></a><span class='hs-definition'>filterOutInvisibleTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-1992"></a><span class='hs-definition'>filterOutInvisibleTypes</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>partitionInvisibleTypes</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-1993"></a>
<a name="line-1994"></a><a name="filterOutInferredTypes"></a><span class='hs-comment'>-- | Given a 'TyCon' and a list of argument types, filter out any 'Inferred'</span>
<a name="line-1995"></a><span class='hs-comment'>-- arguments.</span>
<a name="line-1996"></a><span class='hs-definition'>filterOutInferredTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-1997"></a><span class='hs-definition'>filterOutInferredTypes</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span>
<a name="line-1998"></a>  <span class='hs-varid'>filterByList</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varop'>/=</span> <span class='hs-conid'>Inferred</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyConArgFlags</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-1999"></a>
<a name="line-2000"></a><a name="partitionInvisibleTypes"></a><span class='hs-comment'>-- | Given a 'TyCon' and a list of argument types, partition the arguments</span>
<a name="line-2001"></a><span class='hs-comment'>-- into:</span>
<a name="line-2002"></a><span class='hs-comment'>--</span>
<a name="line-2003"></a><span class='hs-comment'>-- 1. 'Inferred' or 'Specified' (i.e., invisible) arguments and</span>
<a name="line-2004"></a><span class='hs-comment'>--</span>
<a name="line-2005"></a><span class='hs-comment'>-- 2. 'Required' (i.e., visible) arguments</span>
<a name="line-2006"></a><span class='hs-definition'>partitionInvisibleTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2007"></a><span class='hs-definition'>partitionInvisibleTypes</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span>
<a name="line-2008"></a>  <span class='hs-varid'>partitionByList</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>isInvisibleArgFlag</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyConArgFlags</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-2009"></a>
<a name="line-2010"></a><a name="partitionInvisibles"></a><span class='hs-comment'>-- | Given a list of things paired with their visibilities, partition the</span>
<a name="line-2011"></a><span class='hs-comment'>-- things into (invisible things, visible things).</span>
<a name="line-2012"></a><span class='hs-definition'>partitionInvisibles</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>ArgFlag</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2013"></a><span class='hs-definition'>partitionInvisibles</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionWith</span> <span class='hs-varid'>pick_invis</span>
<a name="line-2014"></a>  <span class='hs-keyword'>where</span>
<a name="line-2015"></a>    <span class='hs-varid'>pick_invis</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>ArgFlag</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-varid'>a</span> <span class='hs-varid'>a</span>
<a name="line-2016"></a>    <span class='hs-varid'>pick_invis</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isInvisibleArgFlag</span> <span class='hs-varid'>vis</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Left</span> <span class='hs-varid'>thing</span>
<a name="line-2017"></a>                            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>thing</span>
<a name="line-2018"></a>
<a name="line-2019"></a><a name="tyConArgFlags"></a><span class='hs-comment'>-- | Given a 'TyCon' and a list of argument types to which the 'TyCon' is</span>
<a name="line-2020"></a><span class='hs-comment'>-- applied, determine each argument's visibility</span>
<a name="line-2021"></a><span class='hs-comment'>-- ('Inferred', 'Specified', or 'Required').</span>
<a name="line-2022"></a><span class='hs-comment'>--</span>
<a name="line-2023"></a><span class='hs-comment'>-- Wrinkle: consider the following scenario:</span>
<a name="line-2024"></a><span class='hs-comment'>--</span>
<a name="line-2025"></a><span class='hs-comment'>-- &gt; T :: forall k. k -&gt; k</span>
<a name="line-2026"></a><span class='hs-comment'>-- &gt; tyConArgFlags T [forall m. m -&gt; m -&gt; m, S, R, Q]</span>
<a name="line-2027"></a><span class='hs-comment'>--</span>
<a name="line-2028"></a><span class='hs-comment'>-- After substituting, we get</span>
<a name="line-2029"></a><span class='hs-comment'>--</span>
<a name="line-2030"></a><span class='hs-comment'>-- &gt; T (forall m. m -&gt; m -&gt; m) :: (forall m. m -&gt; m -&gt; m) -&gt; forall n. n -&gt; n -&gt; n</span>
<a name="line-2031"></a><span class='hs-comment'>--</span>
<a name="line-2032"></a><span class='hs-comment'>-- Thus, the first argument is invisible, @S@ is visible, @R@ is invisible again,</span>
<a name="line-2033"></a><span class='hs-comment'>-- and @Q@ is visible.</span>
<a name="line-2034"></a><span class='hs-definition'>tyConArgFlags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ArgFlag</span><span class='hs-keyglyph'>]</span>
<a name="line-2035"></a><span class='hs-definition'>tyConArgFlags</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fun_kind_arg_flags</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-2036"></a>
<a name="line-2037"></a><a name="appTyArgFlags"></a><span class='hs-comment'>-- | Given a 'Type' and a list of argument types to which the 'Type' is</span>
<a name="line-2038"></a><span class='hs-comment'>-- applied, determine each argument's visibility</span>
<a name="line-2039"></a><span class='hs-comment'>-- ('Inferred', 'Specified', or 'Required').</span>
<a name="line-2040"></a><span class='hs-comment'>--</span>
<a name="line-2041"></a><span class='hs-comment'>-- Most of the time, the arguments will be 'Required', but not always. Consider</span>
<a name="line-2042"></a><span class='hs-comment'>-- @f :: forall a. a -&gt; Type@. In @f Type Bool@, the first argument (@Type@) is</span>
<a name="line-2043"></a><span class='hs-comment'>-- 'Specified' and the second argument (@Bool@) is 'Required'. It is precisely</span>
<a name="line-2044"></a><span class='hs-comment'>-- this sort of higher-rank situation in which 'appTyArgFlags' comes in handy,</span>
<a name="line-2045"></a><span class='hs-comment'>-- since @f Type Bool@ would be represented in Core using 'AppTy's.</span>
<a name="line-2046"></a><span class='hs-comment'>-- (See also #15792).</span>
<a name="line-2047"></a><span class='hs-definition'>appTyArgFlags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ArgFlag</span><span class='hs-keyglyph'>]</span>
<a name="line-2048"></a><span class='hs-definition'>appTyArgFlags</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fun_kind_arg_flags</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2049"></a>
<a name="line-2050"></a><a name="fun_kind_arg_flags"></a><span class='hs-comment'>-- | Given a function kind and a list of argument types (where each argument's</span>
<a name="line-2051"></a><span class='hs-comment'>-- kind aligns with the corresponding position in the argument kind), determine</span>
<a name="line-2052"></a><span class='hs-comment'>-- each argument's visibility ('Inferred', 'Specified', or 'Required').</span>
<a name="line-2053"></a><span class='hs-definition'>fun_kind_arg_flags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ArgFlag</span><span class='hs-keyglyph'>]</span>
<a name="line-2054"></a><span class='hs-definition'>fun_kind_arg_flags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>emptyTCvSubst</span>
<a name="line-2055"></a>  <span class='hs-keyword'>where</span>
<a name="line-2056"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ki</span> <span class='hs-varid'>arg_tys</span>
<a name="line-2057"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ki'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ki</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ki'</span> <span class='hs-varid'>arg_tys</span>
<a name="line-2058"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-2059"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>argf</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ki</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_ty</span><span class='hs-conop'>:</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span>
<a name="line-2060"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>argf</span> <span class='hs-conop'>:</span> <span class='hs-varid'>go</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>res_ki</span> <span class='hs-varid'>arg_tys</span>
<a name="line-2061"></a>      <span class='hs-keyword'>where</span>
<a name="line-2062"></a>        <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>arg_ty</span>
<a name="line-2063"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys</span>
<a name="line-2064"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ki</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupTyVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ki</span> <span class='hs-varid'>arg_tys</span>
<a name="line-2065"></a>    <span class='hs-comment'>-- This FunTy case is important to handle kinds with nested foralls, such</span>
<a name="line-2066"></a>    <span class='hs-comment'>-- as this kind (inspired by #16518):</span>
<a name="line-2067"></a>    <span class='hs-comment'>--</span>
<a name="line-2068"></a>    <span class='hs-comment'>--   forall {k1} k2. k1 -&gt; k2 -&gt; forall k3. k3 -&gt; Type</span>
<a name="line-2069"></a>    <span class='hs-comment'>--</span>
<a name="line-2070"></a>    <span class='hs-comment'>-- Here, we want to get the following ArgFlags:</span>
<a name="line-2071"></a>    <span class='hs-comment'>--</span>
<a name="line-2072"></a>    <span class='hs-comment'>-- [Inferred,   Specified, Required, Required, Specified, Required]</span>
<a name="line-2073"></a>    <span class='hs-comment'>-- forall {k1}. forall k2. k1 -&gt;     k2 -&gt;     forall k3. k3 -&gt;     Type</span>
<a name="line-2074"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span><span class='hs-layout'>{</span><span class='hs-varid'>ft_af</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>af</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res_ki</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span>
<a name="line-2075"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>argf</span> <span class='hs-conop'>:</span> <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>res_ki</span> <span class='hs-varid'>arg_tys</span>
<a name="line-2076"></a>      <span class='hs-keyword'>where</span>
<a name="line-2077"></a>        <span class='hs-varid'>argf</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>af</span> <span class='hs-keyword'>of</span>
<a name="line-2078"></a>                 <span class='hs-conid'>VisArg</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Required</span>
<a name="line-2079"></a>                 <span class='hs-conid'>InvisArg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Inferred</span>
<a name="line-2080"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>Required</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys</span>
<a name="line-2081"></a>                        <span class='hs-comment'>-- something is ill-kinded. But this can happen</span>
<a name="line-2082"></a>                        <span class='hs-comment'>-- when printing errors. Assume everything is Required.</span>
<a name="line-2083"></a>
<a name="line-2084"></a><a name="isTauTy"></a><span class='hs-comment'>-- @isTauTy@ tests if a type has no foralls or (=&gt;)</span>
<a name="line-2085"></a><span class='hs-definition'>isTauTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2086"></a><span class='hs-definition'>isTauTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTauTy</span> <span class='hs-varid'>ty'</span>
<a name="line-2087"></a><span class='hs-definition'>isTauTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2088"></a><span class='hs-definition'>isTauTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2089"></a><span class='hs-definition'>isTauTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTauTy</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isTauTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-2090"></a><span class='hs-definition'>isTauTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTauTy</span> <span class='hs-varid'>a</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isTauTy</span> <span class='hs-varid'>b</span>
<a name="line-2091"></a><span class='hs-definition'>isTauTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>af</span> <span class='hs-varid'>w</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>af</span> <span class='hs-keyword'>of</span>
<a name="line-2092"></a>                                <span class='hs-conid'>InvisArg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>                               <span class='hs-comment'>-- e.g., Eq a =&gt; b</span>
<a name="line-2093"></a>                                <span class='hs-conid'>VisArg</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isTauTy</span> <span class='hs-varid'>w</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isTauTy</span> <span class='hs-varid'>a</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isTauTy</span> <span class='hs-varid'>b</span> <span class='hs-comment'>-- e.g., a -&gt; b</span>
<a name="line-2094"></a><span class='hs-definition'>isTauTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2095"></a><span class='hs-definition'>isTauTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTauTy</span> <span class='hs-varid'>ty</span>
<a name="line-2096"></a><span class='hs-definition'>isTauTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>  <span class='hs-comment'>-- Not sure about this</span>
<a name="line-2097"></a>
<a name="line-2098"></a><a name="isAtomicTy"></a><span class='hs-definition'>isAtomicTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2099"></a><span class='hs-comment'>-- True if the type is just a single token, and can be printed compactly</span>
<a name="line-2100"></a><span class='hs-comment'>-- Used when deciding how to lay out type error messages; see the</span>
<a name="line-2101"></a><span class='hs-comment'>-- call in GHC.Tc.Errors</span>
<a name="line-2102"></a><span class='hs-definition'>isAtomicTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2103"></a><span class='hs-definition'>isAtomicTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2104"></a><span class='hs-definition'>isAtomicTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2105"></a>
<a name="line-2106"></a><span class='hs-definition'>isAtomicTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2107"></a>   <span class='hs-comment'>-- 'Type' prints compactly as *</span>
<a name="line-2108"></a>   <span class='hs-comment'>-- See GHC.Iface.Type.ppr_kind_type</span>
<a name="line-2109"></a>
<a name="line-2110"></a><span class='hs-definition'>isAtomicTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2111"></a>
<a name="line-2112"></a><span class='hs-comment'>{-
<a name="line-2113"></a>%************************************************************************
<a name="line-2114"></a>%*                                                                      *
<a name="line-2115"></a>   TyCoBinders
<a name="line-2116"></a>%*                                                                      *
<a name="line-2117"></a>%************************************************************************
<a name="line-2118"></a>-}</span>
<a name="line-2119"></a>
<a name="line-2120"></a><a name="mkAnonBinder"></a><span class='hs-comment'>-- | Make an anonymous binder</span>
<a name="line-2121"></a><span class='hs-definition'>mkAnonBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AnonArgFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Scaled</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoBinder</span>
<a name="line-2122"></a><span class='hs-definition'>mkAnonBinder</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Anon</span>
<a name="line-2123"></a>
<a name="line-2124"></a><a name="isAnonTyCoBinder"></a><span class='hs-comment'>-- | Does this binder bind a variable that is /not/ erased? Returns</span>
<a name="line-2125"></a><span class='hs-comment'>-- 'True' for anonymous binders.</span>
<a name="line-2126"></a><span class='hs-definition'>isAnonTyCoBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2127"></a><span class='hs-definition'>isAnonTyCoBinder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2128"></a><span class='hs-definition'>isAnonTyCoBinder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2129"></a>
<a name="line-2130"></a><a name="tyCoBinderVar_maybe"></a><span class='hs-definition'>tyCoBinderVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TyCoVar</span>
<a name="line-2131"></a><span class='hs-definition'>tyCoBinderVar_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>binderVar</span> <span class='hs-varid'>tv</span>
<a name="line-2132"></a><span class='hs-definition'>tyCoBinderVar_maybe</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-2133"></a>
<a name="line-2134"></a><a name="tyCoBinderType"></a><span class='hs-definition'>tyCoBinderType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2135"></a><span class='hs-definition'>tyCoBinderType</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>tvb</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binderType</span> <span class='hs-varid'>tvb</span>
<a name="line-2136"></a><span class='hs-definition'>tyCoBinderType</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>scaledThing</span> <span class='hs-varid'>ty</span>
<a name="line-2137"></a>
<a name="line-2138"></a><a name="tyBinderType"></a><span class='hs-definition'>tyBinderType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2139"></a><span class='hs-definition'>tyBinderType</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2140"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-2141"></a>    <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span>
<a name="line-2142"></a><span class='hs-definition'>tyBinderType</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>scaledThing</span> <span class='hs-varid'>ty</span>
<a name="line-2143"></a>
<a name="line-2144"></a><a name="binderRelevantType_maybe"></a><span class='hs-comment'>-- | Extract a relevant type, if there is one.</span>
<a name="line-2145"></a><span class='hs-definition'>binderRelevantType_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-2146"></a><span class='hs-definition'>binderRelevantType_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-2147"></a><span class='hs-definition'>binderRelevantType_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>scaledThing</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2148"></a>
<a name="line-2149"></a><span class='hs-comment'>{-
<a name="line-2150"></a>************************************************************************
<a name="line-2151"></a>*                                                                      *
<a name="line-2152"></a>\subsection{Type families}
<a name="line-2153"></a>*                                                                      *
<a name="line-2154"></a>************************************************************************
<a name="line-2155"></a>-}</span>
<a name="line-2156"></a>
<a name="line-2157"></a><a name="mkFamilyTyConApp"></a><span class='hs-definition'>mkFamilyTyConApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2158"></a><span class='hs-comment'>-- ^ Given a family instance TyCon and its arg types, return the</span>
<a name="line-2159"></a><span class='hs-comment'>-- corresponding family type.  E.g:</span>
<a name="line-2160"></a><span class='hs-comment'>--</span>
<a name="line-2161"></a><span class='hs-comment'>-- &gt; data family T a</span>
<a name="line-2162"></a><span class='hs-comment'>-- &gt; data instance T (Maybe b) = MkT b</span>
<a name="line-2163"></a><span class='hs-comment'>--</span>
<a name="line-2164"></a><span class='hs-comment'>-- Where the instance tycon is :RTL, so:</span>
<a name="line-2165"></a><span class='hs-comment'>--</span>
<a name="line-2166"></a><span class='hs-comment'>-- &gt; mkFamilyTyConApp :RTL Int  =  T (Maybe Int)</span>
<a name="line-2167"></a><span class='hs-definition'>mkFamilyTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-2168"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>fam_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>fam_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConFamInst_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-2169"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tc</span>
<a name="line-2170"></a>        <span class='hs-varid'>fam_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-2171"></a>                    <span class='hs-varid'>zipTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-2172"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>fam_tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTys</span> <span class='hs-varid'>fam_subst</span> <span class='hs-varid'>fam_tys</span><span class='hs-layout'>)</span>
<a name="line-2173"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2174"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-2175"></a>
<a name="line-2176"></a><a name="coAxNthLHS"></a><span class='hs-comment'>-- | Get the type on the LHS of a coercion induced by a type/data</span>
<a name="line-2177"></a><span class='hs-comment'>-- family instance.</span>
<a name="line-2178"></a><span class='hs-definition'>coAxNthLHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2179"></a><span class='hs-definition'>coAxNthLHS</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-keyglyph'>=</span>
<a name="line-2180"></a>  <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomTyCon</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxBranchLHS</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2181"></a>
<a name="line-2182"></a><a name="isFamFreeTy"></a><span class='hs-definition'>isFamFreeTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2183"></a><span class='hs-definition'>isFamFreeTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isFamFreeTy</span> <span class='hs-varid'>ty'</span>
<a name="line-2184"></a><span class='hs-definition'>isFamFreeTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2185"></a><span class='hs-definition'>isFamFreeTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2186"></a><span class='hs-definition'>isFamFreeTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isFamFreeTy</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isFamFreeTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-2187"></a><span class='hs-definition'>isFamFreeTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isFamFreeTy</span> <span class='hs-varid'>a</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isFamFreeTy</span> <span class='hs-varid'>b</span>
<a name="line-2188"></a><span class='hs-definition'>isFamFreeTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isFamFreeTy</span> <span class='hs-varid'>w</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isFamFreeTy</span> <span class='hs-varid'>a</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isFamFreeTy</span> <span class='hs-varid'>b</span>
<a name="line-2189"></a><span class='hs-definition'>isFamFreeTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isFamFreeTy</span> <span class='hs-varid'>ty</span>
<a name="line-2190"></a><span class='hs-definition'>isFamFreeTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isFamFreeTy</span> <span class='hs-varid'>ty</span>
<a name="line-2191"></a><span class='hs-definition'>isFamFreeTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>  <span class='hs-comment'>-- Not sure about this</span>
<a name="line-2192"></a>
<a name="line-2193"></a><a name="isCoVarType"></a><span class='hs-comment'>-- | Does this type classify a core (unlifted) Coercion?</span>
<a name="line-2194"></a><span class='hs-comment'>-- At either role nominal or representational</span>
<a name="line-2195"></a><span class='hs-comment'>--    (t1 ~# t2) or (t1 ~R# t2)</span>
<a name="line-2196"></a><span class='hs-comment'>-- See Note [Types for coercions, predicates, and evidence] in "GHC.Core.TyCo.Rep"</span>
<a name="line-2197"></a><span class='hs-definition'>isCoVarType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2198"></a>  <span class='hs-comment'>-- ToDo: should we check saturation?</span>
<a name="line-2199"></a><span class='hs-definition'>isCoVarType</span> <span class='hs-varid'>ty</span>
<a name="line-2200"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-2201"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqPrimTyConKey</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqReprPrimTyConKey</span>
<a name="line-2202"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2203"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2204"></a>
<a name="line-2205"></a><a name="buildSynTyCon"></a><span class='hs-definition'>buildSynTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>KnotTied</span> <span class='hs-conid'>TyConBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span>   <span class='hs-comment'>-- ^ /result/ kind</span>
<a name="line-2206"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Role</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>KnotTied</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span>
<a name="line-2207"></a><span class='hs-comment'>-- This function is here because here is where we have</span>
<a name="line-2208"></a><span class='hs-comment'>--   isFamFree and isTauTy</span>
<a name="line-2209"></a><span class='hs-definition'>buildSynTyCon</span> <span class='hs-varid'>name</span> <span class='hs-varid'>binders</span> <span class='hs-varid'>res_kind</span> <span class='hs-varid'>roles</span> <span class='hs-varid'>rhs</span>
<a name="line-2210"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSynonymTyCon</span> <span class='hs-varid'>name</span> <span class='hs-varid'>binders</span> <span class='hs-varid'>res_kind</span> <span class='hs-varid'>roles</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>is_tau</span> <span class='hs-varid'>is_fam_free</span> <span class='hs-varid'>is_forgetful</span>
<a name="line-2211"></a>  <span class='hs-keyword'>where</span>
<a name="line-2212"></a>    <span class='hs-varid'>is_tau</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTauTy</span> <span class='hs-varid'>rhs</span>
<a name="line-2213"></a>    <span class='hs-varid'>is_fam_free</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isFamFreeTy</span> <span class='hs-varid'>rhs</span>
<a name="line-2214"></a>    <span class='hs-varid'>is_forgetful</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>binderVar</span><span class='hs-layout'>)</span> <span class='hs-varid'>binders</span> <span class='hs-varop'>||</span>
<a name="line-2215"></a>                   <span class='hs-varid'>uniqSetAny</span> <span class='hs-varid'>isForgetfulSynTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConsOfType</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-2216"></a>         <span class='hs-comment'>-- NB: This is allowed to be conservative, returning True more often</span>
<a name="line-2217"></a>         <span class='hs-comment'>-- than it should. See comments on GHC.Core.TyCon.isForgetfulSynTyCon</span>
<a name="line-2218"></a>
<a name="line-2219"></a><span class='hs-comment'>{-
<a name="line-2220"></a>************************************************************************
<a name="line-2221"></a>*                                                                      *
<a name="line-2222"></a>\subsection{Liftedness}
<a name="line-2223"></a>*                                                                      *
<a name="line-2224"></a>************************************************************************
<a name="line-2225"></a>-}</span>
<a name="line-2226"></a>
<a name="line-2227"></a><a name="isLiftedType_maybe"></a><span class='hs-comment'>-- | Returns Just True if this type is surely lifted, Just False</span>
<a name="line-2228"></a><span class='hs-comment'>-- if it is surely unlifted, Nothing if we can't be sure (i.e., it is</span>
<a name="line-2229"></a><span class='hs-comment'>-- levity polymorphic), and panics if the kind does not have the shape</span>
<a name="line-2230"></a><span class='hs-comment'>-- TYPE r.</span>
<a name="line-2231"></a><span class='hs-definition'>isLiftedType_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Bool</span>
<a name="line-2232"></a><span class='hs-definition'>isLiftedType_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>coreFullView</span> <span class='hs-layout'>(</span><span class='hs-varid'>getRuntimeRep</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-2233"></a>  <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isLiftedRuntimeRep</span> <span class='hs-varid'>ty'</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>True</span>
<a name="line-2234"></a>  <span class='hs-conid'>TyConApp</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>False</span>  <span class='hs-comment'>-- Everything else is unlifted</span>
<a name="line-2235"></a>  <span class='hs-keyword'>_</span>                             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>     <span class='hs-comment'>-- levity polymorphic</span>
<a name="line-2236"></a>
<a name="line-2237"></a><a name="isUnliftedType"></a><span class='hs-comment'>-- | See "Type#type_classification" for what an unlifted type is.</span>
<a name="line-2238"></a><span class='hs-comment'>-- Panics on levity polymorphic types; See 'mightBeUnliftedType' for</span>
<a name="line-2239"></a><span class='hs-comment'>-- a more approximate predicate that behaves better in the presence of</span>
<a name="line-2240"></a><span class='hs-comment'>-- levity polymorphism.</span>
<a name="line-2241"></a><span class='hs-definition'>isUnliftedType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2242"></a>        <span class='hs-comment'>-- isUnliftedType returns True for forall'd unlifted types:</span>
<a name="line-2243"></a>        <span class='hs-comment'>--      x :: forall a. Int#</span>
<a name="line-2244"></a>        <span class='hs-comment'>-- I found bindings like these were getting floated to the top level.</span>
<a name="line-2245"></a>        <span class='hs-comment'>-- They are pretty bogus types, mind you.  It would be better never to</span>
<a name="line-2246"></a>        <span class='hs-comment'>-- construct them</span>
<a name="line-2247"></a><span class='hs-definition'>isUnliftedType</span> <span class='hs-varid'>ty</span>
<a name="line-2248"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isLiftedType_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`orElse`</span>
<a name="line-2249"></a>         <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"isUnliftedType"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2250"></a>
<a name="line-2251"></a><a name="mightBeUnliftedType"></a><span class='hs-comment'>-- | Returns:</span>
<a name="line-2252"></a><span class='hs-comment'>--</span>
<a name="line-2253"></a><span class='hs-comment'>-- * 'False' if the type is /guaranteed/ lifted or</span>
<a name="line-2254"></a><span class='hs-comment'>-- * 'True' if it is unlifted, OR we aren't sure (e.g. in a levity-polymorphic case)</span>
<a name="line-2255"></a><span class='hs-definition'>mightBeUnliftedType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2256"></a><span class='hs-definition'>mightBeUnliftedType</span> <span class='hs-varid'>ty</span>
<a name="line-2257"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>isLiftedType_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-2258"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>is_lifted</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>is_lifted</span>
<a name="line-2259"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-2260"></a>
<a name="line-2261"></a><a name="isBoxedType"></a><span class='hs-comment'>-- | See "Type#type_classification" for what a boxed type is.</span>
<a name="line-2262"></a><span class='hs-comment'>-- Panics on levity polymorphic types; See 'mightBeUnliftedType' for</span>
<a name="line-2263"></a><span class='hs-comment'>-- a more approximate predicate that behaves better in the presence of</span>
<a name="line-2264"></a><span class='hs-comment'>-- levity polymorphism.</span>
<a name="line-2265"></a><span class='hs-definition'>isBoxedType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2266"></a><span class='hs-definition'>isBoxedType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isBoxedRuntimeRep</span> <span class='hs-layout'>(</span><span class='hs-varid'>getRuntimeRep</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2267"></a>
<a name="line-2268"></a><a name="isRuntimeRepKindedTy"></a><span class='hs-comment'>-- | Is this a type of kind RuntimeRep? (e.g. LiftedRep)</span>
<a name="line-2269"></a><span class='hs-definition'>isRuntimeRepKindedTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2270"></a><span class='hs-definition'>isRuntimeRepKindedTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isRuntimeRepTy</span> <span class='hs-varop'>.</span> <span class='hs-varid'>typeKind</span>
<a name="line-2271"></a>
<a name="line-2272"></a><a name="dropRuntimeRepArgs"></a><span class='hs-comment'>-- | Drops prefix of RuntimeRep constructors in 'TyConApp's. Useful for e.g.</span>
<a name="line-2273"></a><span class='hs-comment'>-- dropping 'LiftedRep arguments of unboxed tuple TyCon applications:</span>
<a name="line-2274"></a><span class='hs-comment'>--</span>
<a name="line-2275"></a><span class='hs-comment'>--   dropRuntimeRepArgs [ 'LiftedRep, 'IntRep</span>
<a name="line-2276"></a><span class='hs-comment'>--                      , String, Int# ] == [String, Int#]</span>
<a name="line-2277"></a><span class='hs-comment'>--</span>
<a name="line-2278"></a><span class='hs-definition'>dropRuntimeRepArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-2279"></a><span class='hs-definition'>dropRuntimeRepArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dropWhile</span> <span class='hs-varid'>isRuntimeRepKindedTy</span>
<a name="line-2280"></a>
<a name="line-2281"></a><a name="getRuntimeRep_maybe"></a><span class='hs-comment'>-- | Extract the RuntimeRep classifier of a type. For instance,</span>
<a name="line-2282"></a><span class='hs-comment'>-- @getRuntimeRep_maybe Int = LiftedRep@. Returns 'Nothing' if this is not</span>
<a name="line-2283"></a><span class='hs-comment'>-- possible.</span>
<a name="line-2284"></a><span class='hs-definition'>getRuntimeRep_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span>
<a name="line-2285"></a>                    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-2286"></a><span class='hs-definition'>getRuntimeRep_maybe</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kindRep_maybe</span> <span class='hs-varop'>.</span> <span class='hs-varid'>typeKind</span>
<a name="line-2287"></a>
<a name="line-2288"></a><a name="getRuntimeRep"></a><span class='hs-comment'>-- | Extract the RuntimeRep classifier of a type. For instance,</span>
<a name="line-2289"></a><span class='hs-comment'>-- @getRuntimeRep_maybe Int = LiftedRep@. Panics if this is not possible.</span>
<a name="line-2290"></a><span class='hs-definition'>getRuntimeRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2291"></a><span class='hs-definition'>getRuntimeRep</span> <span class='hs-varid'>ty</span>
<a name="line-2292"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>getRuntimeRep_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-2293"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>r</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>r</span>
<a name="line-2294"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"getRuntimeRep"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2295"></a>
<a name="line-2296"></a><a name="isUnboxedTupleType"></a><span class='hs-definition'>isUnboxedTupleType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2297"></a><span class='hs-definition'>isUnboxedTupleType</span> <span class='hs-varid'>ty</span>
<a name="line-2298"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>getRuntimeRep</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>tupleRepDataConKey</span>
<a name="line-2299"></a>  <span class='hs-comment'>-- NB: Do not use typePrimRep, as that can't tell the difference between</span>
<a name="line-2300"></a>  <span class='hs-comment'>-- unboxed tuples and unboxed sums</span>
<a name="line-2301"></a>
<a name="line-2302"></a>
<a name="line-2303"></a><a name="isUnboxedSumType"></a><span class='hs-definition'>isUnboxedSumType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2304"></a><span class='hs-definition'>isUnboxedSumType</span> <span class='hs-varid'>ty</span>
<a name="line-2305"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>getRuntimeRep</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>sumRepDataConKey</span>
<a name="line-2306"></a>
<a name="line-2307"></a><a name="isAlgType"></a><span class='hs-comment'>-- | See "Type#type_classification" for what an algebraic type is.</span>
<a name="line-2308"></a><span class='hs-comment'>-- Should only be applied to /types/, as opposed to e.g. partially</span>
<a name="line-2309"></a><span class='hs-comment'>-- saturated type constructors</span>
<a name="line-2310"></a><span class='hs-definition'>isAlgType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2311"></a><span class='hs-definition'>isAlgType</span> <span class='hs-varid'>ty</span>
<a name="line-2312"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-2313"></a>      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>ty_args</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>)</span>
<a name="line-2314"></a>                            <span class='hs-varid'>isAlgTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-2315"></a>      <span class='hs-sel'>_other</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-2316"></a>
<a name="line-2317"></a><a name="isDataFamilyAppType"></a><span class='hs-comment'>-- | Check whether a type is a data family type</span>
<a name="line-2318"></a><span class='hs-definition'>isDataFamilyAppType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2319"></a><span class='hs-definition'>isDataFamilyAppType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-2320"></a>                           <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isDataFamilyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-2321"></a>                           <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-2322"></a>
<a name="line-2323"></a><a name="isStrictType"></a><span class='hs-comment'>-- | Computes whether an argument (or let right hand side) should</span>
<a name="line-2324"></a><span class='hs-comment'>-- be computed strictly or lazily, based only on its type.</span>
<a name="line-2325"></a><span class='hs-comment'>-- Currently, it's just 'isUnliftedType'. Panics on levity-polymorphic types.</span>
<a name="line-2326"></a><span class='hs-definition'>isStrictType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2327"></a><span class='hs-definition'>isStrictType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUnliftedType</span>
<a name="line-2328"></a>
<a name="line-2329"></a><a name="isPrimitiveType"></a><span class='hs-definition'>isPrimitiveType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2330"></a><span class='hs-comment'>-- ^ Returns true of types that are opaque to Haskell.</span>
<a name="line-2331"></a><span class='hs-definition'>isPrimitiveType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-2332"></a>                        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>ty_args</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>)</span>
<a name="line-2333"></a>                                              <span class='hs-varid'>isPrimTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-2334"></a>                        <span class='hs-keyword'>_</span>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-2335"></a>
<a name="line-2336"></a><span class='hs-comment'>{-
<a name="line-2337"></a>************************************************************************
<a name="line-2338"></a>*                                                                      *
<a name="line-2339"></a>\subsection{Join points}
<a name="line-2340"></a>*                                                                      *
<a name="line-2341"></a>************************************************************************
<a name="line-2342"></a>-}</span>
<a name="line-2343"></a>
<a name="line-2344"></a><a name="isValidJoinPointType"></a><span class='hs-comment'>-- | Determine whether a type could be the type of a join point of given total</span>
<a name="line-2345"></a><span class='hs-comment'>-- arity, according to the polymorphism rule. A join point cannot be polymorphic</span>
<a name="line-2346"></a><span class='hs-comment'>-- in its return type, since given</span>
<a name="line-2347"></a><span class='hs-comment'>--   join j @a @b x y z = e1 in e2,</span>
<a name="line-2348"></a><span class='hs-comment'>-- the types of e1 and e2 must be the same, and a and b are not in scope for e2.</span>
<a name="line-2349"></a><span class='hs-comment'>-- (See Note [The polymorphism rule of join points] in "GHC.Core".) Returns False</span>
<a name="line-2350"></a><span class='hs-comment'>-- also if the type simply doesn't have enough arguments.</span>
<a name="line-2351"></a><span class='hs-comment'>--</span>
<a name="line-2352"></a><span class='hs-comment'>-- Note that we need to know how many arguments (type *and* value) the putative</span>
<a name="line-2353"></a><span class='hs-comment'>-- join point takes; for instance, if</span>
<a name="line-2354"></a><span class='hs-comment'>--   j :: forall a. a -&gt; Int</span>
<a name="line-2355"></a><span class='hs-comment'>-- then j could be a binary join point returning an Int, but it could *not* be a</span>
<a name="line-2356"></a><span class='hs-comment'>-- unary join point returning a -&gt; Int.</span>
<a name="line-2357"></a><span class='hs-comment'>--</span>
<a name="line-2358"></a><span class='hs-comment'>-- TODO: See Note [Excess polymorphism and join points]</span>
<a name="line-2359"></a><span class='hs-definition'>isValidJoinPointType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JoinArity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2360"></a><span class='hs-definition'>isValidJoinPointType</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>ty</span>
<a name="line-2361"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>valid_under</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>ty</span>
<a name="line-2362"></a>  <span class='hs-keyword'>where</span>
<a name="line-2363"></a>    <span class='hs-varid'>valid_under</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>ty</span>
<a name="line-2364"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>
<a name="line-2365"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`disjointVarSet`</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-2366"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllTyCoVar_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-2367"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>valid_under</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span> <span class='hs-varop'>`extendVarSet`</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>arity</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty'</span>
<a name="line-2368"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitFunTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-2369"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>valid_under</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>arity</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-2370"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2371"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2372"></a>
<a name="line-2373"></a><span class='hs-comment'>{- Note [Excess polymorphism and join points]
<a name="line-2374"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2375"></a>In principle, if a function would be a join point except that it fails
<a name="line-2376"></a>the polymorphism rule (see Note [The polymorphism rule of join points] in
<a name="line-2377"></a>GHC.Core), it can still be made a join point with some effort. This is because
<a name="line-2378"></a>all tail calls must return the same type (they return to the same context!), and
<a name="line-2379"></a>thus if the return type depends on an argument, that argument must always be the
<a name="line-2380"></a>same.
<a name="line-2381"></a>
<a name="line-2382"></a>For instance, consider:
<a name="line-2383"></a>
<a name="line-2384"></a>  let f :: forall a. a -&gt; Char -&gt; [a]
<a name="line-2385"></a>      f @a x c = ... f @a y 'a' ...
<a name="line-2386"></a>  in ... f @Int 1 'b' ... f @Int 2 'c' ...
<a name="line-2387"></a>
<a name="line-2388"></a>(where the calls are tail calls). `f` fails the polymorphism rule because its
<a name="line-2389"></a>return type is [a], where [a] is bound. But since the type argument is always
<a name="line-2390"></a>'Int', we can rewrite it as:
<a name="line-2391"></a>
<a name="line-2392"></a>  let f' :: Int -&gt; Char -&gt; [Int]
<a name="line-2393"></a>      f' x c = ... f' y 'a' ...
<a name="line-2394"></a>  in ... f' 1 'b' ... f 2 'c' ...
<a name="line-2395"></a>
<a name="line-2396"></a>and now we can make f' a join point:
<a name="line-2397"></a>
<a name="line-2398"></a>  join f' :: Int -&gt; Char -&gt; [Int]
<a name="line-2399"></a>       f' x c = ... jump f' y 'a' ...
<a name="line-2400"></a>  in ... jump f' 1 'b' ... jump f' 2 'c' ...
<a name="line-2401"></a>
<a name="line-2402"></a>It's not clear that this comes up often, however. TODO: Measure how often and
<a name="line-2403"></a>add this analysis if necessary.  See #14620.
<a name="line-2404"></a>
<a name="line-2405"></a>
<a name="line-2406"></a>************************************************************************
<a name="line-2407"></a>*                                                                      *
<a name="line-2408"></a>\subsection{Sequencing on types}
<a name="line-2409"></a>*                                                                      *
<a name="line-2410"></a>************************************************************************
<a name="line-2411"></a>-}</span>
<a name="line-2412"></a>
<a name="line-2413"></a><a name="seqType"></a><span class='hs-definition'>seqType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-2414"></a><span class='hs-definition'>seqType</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>()</span>
<a name="line-2415"></a><span class='hs-definition'>seqType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>()</span>
<a name="line-2416"></a><span class='hs-definition'>seqType</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>t2</span>
<a name="line-2417"></a><span class='hs-definition'>seqType</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>w</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>t2</span>
<a name="line-2418"></a><span class='hs-definition'>seqType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqTypes</span> <span class='hs-varid'>tys</span>
<a name="line-2419"></a><span class='hs-definition'>seqType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqType</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>ty</span>
<a name="line-2420"></a><span class='hs-definition'>seqType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-2421"></a><span class='hs-definition'>seqType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-2422"></a>
<a name="line-2423"></a><a name="seqTypes"></a><span class='hs-definition'>seqTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-2424"></a><span class='hs-definition'>seqTypes</span> <span class='hs-conid'>[]</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-2425"></a><span class='hs-definition'>seqTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqTypes</span> <span class='hs-varid'>tys</span>
<a name="line-2426"></a>
<a name="line-2427"></a><span class='hs-comment'>{-
<a name="line-2428"></a>************************************************************************
<a name="line-2429"></a>*                                                                      *
<a name="line-2430"></a>                Comparison for types
<a name="line-2431"></a>        (We don't use instances so that we know where it happens)
<a name="line-2432"></a>*                                                                      *
<a name="line-2433"></a>************************************************************************
<a name="line-2434"></a>
<a name="line-2435"></a>Note [Equality on AppTys]
<a name="line-2436"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2437"></a>In our cast-ignoring equality, we want to say that the following two
<a name="line-2438"></a>are equal:
<a name="line-2439"></a>
<a name="line-2440"></a>  (Maybe |&gt; co) (Int |&gt; co')   ~?       Maybe Int
<a name="line-2441"></a>
<a name="line-2442"></a>But the left is an AppTy while the right is a TyConApp. The solution is
<a name="line-2443"></a>to use repSplitAppTy_maybe to break up the TyConApp into its pieces and
<a name="line-2444"></a>then continue. Easy to do, but also easy to forget to do.
<a name="line-2445"></a>
<a name="line-2446"></a>Note [Comparing nullary type synonyms]
<a name="line-2447"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2448"></a>Consider the task of testing equality between two 'Type's of the form
<a name="line-2449"></a>
<a name="line-2450"></a>  TyConApp tc []
<a name="line-2451"></a>
<a name="line-2452"></a>where @tc@ is a type synonym. A naive way to perform this comparison these
<a name="line-2453"></a>would first expand the synonym and then compare the resulting expansions.
<a name="line-2454"></a>
<a name="line-2455"></a>However, this is obviously wasteful and the RHS of @tc@ may be large; it is
<a name="line-2456"></a>much better to rather compare the TyCons directly. Consequently, before
<a name="line-2457"></a>expanding type synonyms in type comparisons we first look for a nullary
<a name="line-2458"></a>TyConApp and simply compare the TyCons if we find one. Of course, if we find
<a name="line-2459"></a>that the TyCons are *not* equal then we still need to perform the expansion as
<a name="line-2460"></a>their RHSs may still be equal.
<a name="line-2461"></a>
<a name="line-2462"></a>We perform this optimisation in a number of places:
<a name="line-2463"></a>
<a name="line-2464"></a> * GHC.Core.Types.eqType
<a name="line-2465"></a> * GHC.Core.Types.nonDetCmpType
<a name="line-2466"></a> * GHC.Core.Unify.unify_ty
<a name="line-2467"></a> * TcCanonical.can_eq_nc'
<a name="line-2468"></a> * TcUnify.uType
<a name="line-2469"></a>
<a name="line-2470"></a>This optimisation is especially helpful for the ubiquitous GHC.Types.Type,
<a name="line-2471"></a>since GHC prefers to use the type synonym over @TYPE 'LiftedRep@ applications
<a name="line-2472"></a>whenever possible. See Note [Prefer Type over TYPE 'LiftedRep] in
<a name="line-2473"></a>GHC.Core.TyCo.Rep for details.
<a name="line-2474"></a>
<a name="line-2475"></a>-}</span>
<a name="line-2476"></a>
<a name="line-2477"></a><a name="eqType"></a><span class='hs-definition'>eqType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2478"></a><span class='hs-comment'>-- ^ Type equality on source types. Does not look through @newtypes@ or</span>
<a name="line-2479"></a><span class='hs-comment'>-- 'PredType's, but it does look through type synonyms.</span>
<a name="line-2480"></a><span class='hs-comment'>-- This first checks that the kinds of the types are equal and then</span>
<a name="line-2481"></a><span class='hs-comment'>-- checks whether the types are equal, ignoring casts and coercions.</span>
<a name="line-2482"></a><span class='hs-comment'>-- (The kind check is a recursive call, but since all kinds have type</span>
<a name="line-2483"></a><span class='hs-comment'>-- @Type@, there is no need to check the types of kinds.)</span>
<a name="line-2484"></a><span class='hs-comment'>-- See also Note [Non-trivial definitional equality] in "GHC.Core.TyCo.Rep".</span>
<a name="line-2485"></a><span class='hs-definition'>eqType</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEqual</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nonDetCmpType</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-2486"></a>  <span class='hs-comment'>-- It's OK to use nonDetCmpType here and eqType is deterministic,</span>
<a name="line-2487"></a>  <span class='hs-comment'>-- nonDetCmpType does equality deterministically</span>
<a name="line-2488"></a>
<a name="line-2489"></a><a name="eqTypeX"></a><span class='hs-comment'>-- | Compare types with respect to a (presumably) non-empty 'RnEnv2'.</span>
<a name="line-2490"></a><span class='hs-definition'>eqTypeX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RnEnv2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2491"></a><span class='hs-definition'>eqTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEqual</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nonDetCmpTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-2492"></a>  <span class='hs-comment'>-- It's OK to use nonDetCmpType here and eqTypeX is deterministic,</span>
<a name="line-2493"></a>  <span class='hs-comment'>-- nonDetCmpTypeX does equality deterministically</span>
<a name="line-2494"></a>
<a name="line-2495"></a><a name="eqTypes"></a><span class='hs-comment'>-- | Type equality on lists of types, looking through type synonyms</span>
<a name="line-2496"></a><span class='hs-comment'>-- but not newtypes.</span>
<a name="line-2497"></a><span class='hs-definition'>eqTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2498"></a><span class='hs-definition'>eqTypes</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEqual</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nonDetCmpTypes</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span>
<a name="line-2499"></a>  <span class='hs-comment'>-- It's OK to use nonDetCmpType here and eqTypes is deterministic,</span>
<a name="line-2500"></a>  <span class='hs-comment'>-- nonDetCmpTypes does equality deterministically</span>
<a name="line-2501"></a>
<a name="line-2502"></a><a name="eqVarBndrs"></a><span class='hs-definition'>eqVarBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RnEnv2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>RnEnv2</span>
<a name="line-2503"></a><span class='hs-comment'>-- Check that the var lists are the same length</span>
<a name="line-2504"></a><span class='hs-comment'>-- and have matching kinds; if so, extend the RnEnv2</span>
<a name="line-2505"></a><span class='hs-comment'>-- Returns Nothing if they don't match</span>
<a name="line-2506"></a><span class='hs-definition'>eqVarBndrs</span> <span class='hs-varid'>env</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span>
<a name="line-2507"></a> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>env</span>
<a name="line-2508"></a><span class='hs-definition'>eqVarBndrs</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv1</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv2</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs2</span><span class='hs-layout'>)</span>
<a name="line-2509"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span>
<a name="line-2510"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqVarBndrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnBndr2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs1</span> <span class='hs-varid'>tvs2</span>
<a name="line-2511"></a><span class='hs-definition'>eqVarBndrs</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-2512"></a>
<a name="line-2513"></a><span class='hs-comment'>-- Now here comes the real worker</span>
<a name="line-2514"></a>
<a name="line-2515"></a><span class='hs-comment'>{-
<a name="line-2516"></a>Note [nonDetCmpType nondeterminism]
<a name="line-2517"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2518"></a>nonDetCmpType is implemented in terms of nonDetCmpTypeX. nonDetCmpTypeX
<a name="line-2519"></a>uses nonDetCmpTc which compares TyCons by their Unique value. Using Uniques for
<a name="line-2520"></a>ordering leads to nondeterminism. We hit the same problem in the TyVarTy case,
<a name="line-2521"></a>comparing type variables is nondeterministic, note the call to nonDetCmpVar in
<a name="line-2522"></a>nonDetCmpTypeX.
<a name="line-2523"></a>See Note [Unique Determinism] for more details.
<a name="line-2524"></a>
<a name="line-2525"></a>Note [Computing equality on types]
<a name="line-2526"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2527"></a>There are several places within GHC that depend on the precise choice of
<a name="line-2528"></a>definitional equality used. If we change that definition, all these places
<a name="line-2529"></a>must be updated. This Note merely serves as a place for all these places
<a name="line-2530"></a>to refer to, so searching for references to this Note will find every place
<a name="line-2531"></a>that needs to be updated.
<a name="line-2532"></a>
<a name="line-2533"></a>See also Note [Non-trivial definitional equality] in GHC.Core.TyCo.Rep.
<a name="line-2534"></a>
<a name="line-2535"></a>-}</span>
<a name="line-2536"></a>
<a name="line-2537"></a><a name="nonDetCmpType"></a><span class='hs-definition'>nonDetCmpType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ordering</span>
<a name="line-2538"></a><span class='hs-definition'>nonDetCmpType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc2</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span>
<a name="line-2539"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EQ</span>
<a name="line-2540"></a><span class='hs-definition'>nonDetCmpType</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-2541"></a>  <span class='hs-comment'>-- we know k1 and k2 have the same kind, because they both have kind *.</span>
<a name="line-2542"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nonDetCmpTypeX</span> <span class='hs-varid'>rn_env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-2543"></a>  <span class='hs-keyword'>where</span>
<a name="line-2544"></a>    <span class='hs-varid'>rn_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRnEnv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2545"></a><span class='hs-comment'>{-# INLINE nonDetCmpType #-}</span>
<a name="line-2546"></a>
<a name="line-2547"></a><a name="nonDetCmpTypes"></a><span class='hs-definition'>nonDetCmpTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ordering</span>
<a name="line-2548"></a><span class='hs-definition'>nonDetCmpTypes</span> <span class='hs-varid'>ts1</span> <span class='hs-varid'>ts2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nonDetCmpTypesX</span> <span class='hs-varid'>rn_env</span> <span class='hs-varid'>ts1</span> <span class='hs-varid'>ts2</span>
<a name="line-2549"></a>  <span class='hs-keyword'>where</span>
<a name="line-2550"></a>    <span class='hs-varid'>rn_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRnEnv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ts1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ts2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2551"></a>
<a name="line-2552"></a><a name="TypeOrdering"></a><span class='hs-comment'>-- | An ordering relation between two 'Type's (known below as @t1 :: k1@</span>
<a name="line-2553"></a><a name="TypeOrdering"></a><span class='hs-comment'>-- and @t2 :: k2@)</span>
<a name="line-2554"></a><a name="TypeOrdering"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TypeOrdering</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TLT</span>  <span class='hs-comment'>-- ^ @t1 &lt; t2@</span>
<a name="line-2555"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TEQ</span>  <span class='hs-comment'>-- ^ @t1 ~ t2@ and there are no casts in either,</span>
<a name="line-2556"></a>                         <span class='hs-comment'>-- therefore we can conclude @k1 ~ k2@</span>
<a name="line-2557"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TEQX</span> <span class='hs-comment'>-- ^ @t1 ~ t2@ yet one of the types contains a cast so</span>
<a name="line-2558"></a>                         <span class='hs-comment'>-- they may differ in kind.</span>
<a name="line-2559"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TGT</span>  <span class='hs-comment'>-- ^ @t1 &gt; t2@</span>
<a name="line-2560"></a>                  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span><span class='hs-layout'>,</span> <span class='hs-conid'>Enum</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bounded</span><span class='hs-layout'>)</span>
<a name="line-2561"></a>
<a name="line-2562"></a><a name="nonDetCmpTypeX"></a><span class='hs-definition'>nonDetCmpTypeX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RnEnv2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ordering</span>  <span class='hs-comment'>-- Main workhorse</span>
<a name="line-2563"></a>    <span class='hs-comment'>-- See Note [Non-trivial definitional equality] in GHC.Core.TyCo.Rep</span>
<a name="line-2564"></a>    <span class='hs-comment'>-- See Note [Computing equality on types]</span>
<a name="line-2565"></a><span class='hs-definition'>nonDetCmpTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>orig_t1</span> <span class='hs-varid'>orig_t2</span> <span class='hs-keyglyph'>=</span>
<a name="line-2566"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>orig_t1</span> <span class='hs-varid'>orig_t2</span> <span class='hs-keyword'>of</span>
<a name="line-2567"></a>      <span class='hs-comment'>-- If there are casts then we also need to do a comparison of the kinds of</span>
<a name="line-2568"></a>      <span class='hs-comment'>-- the types being compared</span>
<a name="line-2569"></a>      <span class='hs-conid'>TEQX</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>toOrdering</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span>
<a name="line-2570"></a>      <span class='hs-varid'>ty_ordering</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>toOrdering</span> <span class='hs-varid'>ty_ordering</span>
<a name="line-2571"></a>  <span class='hs-keyword'>where</span>
<a name="line-2572"></a>    <span class='hs-varid'>k1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>orig_t1</span>
<a name="line-2573"></a>    <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>orig_t2</span>
<a name="line-2574"></a>
<a name="line-2575"></a>    <span class='hs-varid'>toOrdering</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeOrdering</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ordering</span>
<a name="line-2576"></a>    <span class='hs-varid'>toOrdering</span> <span class='hs-conid'>TLT</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LT</span>
<a name="line-2577"></a>    <span class='hs-varid'>toOrdering</span> <span class='hs-conid'>TEQ</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EQ</span>
<a name="line-2578"></a>    <span class='hs-varid'>toOrdering</span> <span class='hs-conid'>TEQX</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EQ</span>
<a name="line-2579"></a>    <span class='hs-varid'>toOrdering</span> <span class='hs-conid'>TGT</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-2580"></a>
<a name="line-2581"></a>    <span class='hs-varid'>liftOrdering</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ordering</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeOrdering</span>
<a name="line-2582"></a>    <span class='hs-varid'>liftOrdering</span> <span class='hs-conid'>LT</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TLT</span>
<a name="line-2583"></a>    <span class='hs-varid'>liftOrdering</span> <span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TEQ</span>
<a name="line-2584"></a>    <span class='hs-varid'>liftOrdering</span> <span class='hs-conid'>GT</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TGT</span>
<a name="line-2585"></a>
<a name="line-2586"></a>    <span class='hs-varid'>thenCmpTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeOrdering</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeOrdering</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeOrdering</span>
<a name="line-2587"></a>    <span class='hs-varid'>thenCmpTy</span> <span class='hs-conid'>TEQ</span>  <span class='hs-varid'>rel</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rel</span>
<a name="line-2588"></a>    <span class='hs-varid'>thenCmpTy</span> <span class='hs-conid'>TEQX</span> <span class='hs-varid'>rel</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hasCast</span> <span class='hs-varid'>rel</span>
<a name="line-2589"></a>    <span class='hs-varid'>thenCmpTy</span> <span class='hs-varid'>rel</span>  <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rel</span>
<a name="line-2590"></a>
<a name="line-2591"></a>    <span class='hs-varid'>hasCast</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeOrdering</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeOrdering</span>
<a name="line-2592"></a>    <span class='hs-varid'>hasCast</span> <span class='hs-conid'>TEQ</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TEQX</span>
<a name="line-2593"></a>    <span class='hs-varid'>hasCast</span> <span class='hs-varid'>rel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rel</span>
<a name="line-2594"></a>
<a name="line-2595"></a>    <span class='hs-comment'>-- Returns both the resulting ordering relation between the two types</span>
<a name="line-2596"></a>    <span class='hs-comment'>-- and whether either contains a cast.</span>
<a name="line-2597"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RnEnv2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeOrdering</span>
<a name="line-2598"></a>    <span class='hs-comment'>-- See Note [Comparing nullary type synonyms].</span>
<a name="line-2599"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>   <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc2</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-2600"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span>
<a name="line-2601"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TEQ</span>
<a name="line-2602"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-2603"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>t1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>t1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1'</span> <span class='hs-varid'>t2</span>
<a name="line-2604"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>t2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2'</span>
<a name="line-2605"></a>
<a name="line-2606"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span>       <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span>
<a name="line-2607"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftOrdering</span> <span class='hs-varop'>$</span> <span class='hs-varid'>rnOccL</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>`nonDetCmpVar`</span> <span class='hs-varid'>rnOccR</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv2</span>
<a name="line-2608"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv2</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-2609"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span>
<a name="line-2610"></a>        <span class='hs-varop'>`thenCmpTy`</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnBndr2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-2611"></a>        <span class='hs-comment'>-- See Note [Equality on AppTys]</span>
<a name="line-2612"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-2613"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>s2</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>repSplitAppTy_maybe</span> <span class='hs-varid'>ty2</span>
<a name="line-2614"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span> <span class='hs-varop'>`thenCmpTy`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-2615"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-2616"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span><span class='hs-layout'>,</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>repSplitAppTy_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-2617"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span> <span class='hs-varop'>`thenCmpTy`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-2618"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w1</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w2</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-2619"></a>        <span class='hs-comment'>-- NB: nonDepCmpTypeX does the kind check requested by</span>
<a name="line-2620"></a>        <span class='hs-comment'>-- Note [Equality on FunTys] in GHC.Core.TyCo.Rep</span>
<a name="line-2621"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftOrdering</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonDetCmpTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span> <span class='hs-varop'>`thenCmp`</span> <span class='hs-varid'>nonDetCmpTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-2622"></a>          <span class='hs-varop'>`thenCmpTy`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>w1</span> <span class='hs-varid'>w2</span>
<a name="line-2623"></a>        <span class='hs-comment'>-- Comparing multiplicities last because the test is usually true</span>
<a name="line-2624"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span>
<a name="line-2625"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftOrdering</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc1</span> <span class='hs-varop'>`nonDetCmpTc`</span> <span class='hs-varid'>tc2</span><span class='hs-layout'>)</span> <span class='hs-varop'>`thenCmpTy`</span> <span class='hs-varid'>gos</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span>
<a name="line-2626"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>   <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>l1</span><span class='hs-layout'>)</span>          <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>l2</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftOrdering</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonDetCmpTyLit</span> <span class='hs-varid'>l1</span> <span class='hs-varid'>l2</span><span class='hs-layout'>)</span>
<a name="line-2627"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>t1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-varid'>t2</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hasCast</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-2628"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span>                  <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>t2</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hasCast</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-2629"></a>
<a name="line-2630"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>   <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TEQ</span>
<a name="line-2631"></a>
<a name="line-2632"></a>        <span class='hs-comment'>-- Deal with the rest: TyVarTy &lt; CoercionTy &lt; AppTy &lt; LitTy &lt; TyConApp &lt; ForAllTy</span>
<a name="line-2633"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-2634"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftOrdering</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_rank</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-varop'>`compare`</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_rank</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-2635"></a>      <span class='hs-keyword'>where</span> <span class='hs-varid'>get_rank</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-2636"></a>            <span class='hs-varid'>get_rank</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2637"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"nonDetCmpTypeX.get_rank"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2638"></a>            <span class='hs-varid'>get_rank</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-2639"></a>            <span class='hs-varid'>get_rank</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-2640"></a>            <span class='hs-varid'>get_rank</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-num'>3</span>
<a name="line-2641"></a>            <span class='hs-varid'>get_rank</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-num'>4</span>
<a name="line-2642"></a>            <span class='hs-varid'>get_rank</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-num'>5</span>
<a name="line-2643"></a>            <span class='hs-varid'>get_rank</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-num'>6</span>
<a name="line-2644"></a>            <span class='hs-varid'>get_rank</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-num'>7</span>
<a name="line-2645"></a>
<a name="line-2646"></a>    <span class='hs-varid'>gos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RnEnv2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeOrdering</span>
<a name="line-2647"></a>    <span class='hs-varid'>gos</span> <span class='hs-keyword'>_</span>   <span class='hs-conid'>[]</span>         <span class='hs-conid'>[]</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TEQ</span>
<a name="line-2648"></a>    <span class='hs-varid'>gos</span> <span class='hs-keyword'>_</span>   <span class='hs-conid'>[]</span>         <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TLT</span>
<a name="line-2649"></a>    <span class='hs-varid'>gos</span> <span class='hs-keyword'>_</span>   <span class='hs-keyword'>_</span>          <span class='hs-conid'>[]</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TGT</span>
<a name="line-2650"></a>    <span class='hs-varid'>gos</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-conop'>:</span><span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2</span><span class='hs-conop'>:</span><span class='hs-varid'>tys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varop'>`thenCmpTy`</span> <span class='hs-varid'>gos</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span>
<a name="line-2651"></a>
<a name="line-2652"></a><a name="nonDetCmpTypesX"></a><span class='hs-comment'>-------------</span>
<a name="line-2653"></a><span class='hs-definition'>nonDetCmpTypesX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RnEnv2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ordering</span>
<a name="line-2654"></a><span class='hs-definition'>nonDetCmpTypesX</span> <span class='hs-keyword'>_</span>   <span class='hs-conid'>[]</span>        <span class='hs-conid'>[]</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EQ</span>
<a name="line-2655"></a><span class='hs-definition'>nonDetCmpTypesX</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>t1</span><span class='hs-conop'>:</span><span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>t2</span><span class='hs-conop'>:</span><span class='hs-varid'>tys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nonDetCmpTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-2656"></a>                                          <span class='hs-varop'>`thenCmp`</span>
<a name="line-2657"></a>                                          <span class='hs-varid'>nonDetCmpTypesX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span>
<a name="line-2658"></a><span class='hs-definition'>nonDetCmpTypesX</span> <span class='hs-keyword'>_</span>   <span class='hs-conid'>[]</span>        <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LT</span>
<a name="line-2659"></a><span class='hs-definition'>nonDetCmpTypesX</span> <span class='hs-keyword'>_</span>   <span class='hs-keyword'>_</span>         <span class='hs-conid'>[]</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-2660"></a>
<a name="line-2661"></a><a name="nonDetCmpTc"></a><span class='hs-comment'>-------------</span>
<a name="line-2662"></a><span class='hs-comment'>-- | Compare two 'TyCon's. NB: This should /never/ see 'Constraint' (as</span>
<a name="line-2663"></a><span class='hs-comment'>-- recognized by Kind.isConstraintKindCon) which is considered a synonym for</span>
<a name="line-2664"></a><span class='hs-comment'>-- 'Type' in Core.</span>
<a name="line-2665"></a><span class='hs-comment'>-- See Note [Kind Constraint and kind Type] in "GHC.Core.Type".</span>
<a name="line-2666"></a><span class='hs-comment'>-- See Note [nonDetCmpType nondeterminism]</span>
<a name="line-2667"></a><span class='hs-definition'>nonDetCmpTc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ordering</span>
<a name="line-2668"></a><span class='hs-definition'>nonDetCmpTc</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>tc2</span>
<a name="line-2669"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isConstraintKindCon</span> <span class='hs-varid'>tc1</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isConstraintKindCon</span> <span class='hs-varid'>tc2</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-2670"></a>    <span class='hs-varid'>u1</span> <span class='hs-varop'>`nonDetCmpUnique`</span> <span class='hs-varid'>u2</span>
<a name="line-2671"></a>  <span class='hs-keyword'>where</span>
<a name="line-2672"></a>    <span class='hs-varid'>u1</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConUnique</span> <span class='hs-varid'>tc1</span>
<a name="line-2673"></a>    <span class='hs-varid'>u2</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConUnique</span> <span class='hs-varid'>tc2</span>
<a name="line-2674"></a>
<a name="line-2675"></a><span class='hs-comment'>{-
<a name="line-2676"></a>************************************************************************
<a name="line-2677"></a>*                                                                      *
<a name="line-2678"></a>        The kind of a type
<a name="line-2679"></a>*                                                                      *
<a name="line-2680"></a>************************************************************************
<a name="line-2681"></a>
<a name="line-2682"></a>Note [typeKind vs tcTypeKind]
<a name="line-2683"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2684"></a>We have two functions to get the kind of a type
<a name="line-2685"></a>
<a name="line-2686"></a>  * typeKind   ignores  the distinction between Constraint and *
<a name="line-2687"></a>  * tcTypeKind respects the distinction between Constraint and *
<a name="line-2688"></a>
<a name="line-2689"></a>tcTypeKind is used by the type inference engine, for which Constraint
<a name="line-2690"></a>and * are different; after that we use typeKind.
<a name="line-2691"></a>
<a name="line-2692"></a>See also Note [coreView vs tcView]
<a name="line-2693"></a>
<a name="line-2694"></a>Note [Kinding rules for types]
<a name="line-2695"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2696"></a>In typeKind we consider Constraint and (TYPE LiftedRep) to be identical.
<a name="line-2697"></a>We then have
<a name="line-2698"></a>
<a name="line-2699"></a>         t1 : TYPE rep1
<a name="line-2700"></a>         t2 : TYPE rep2
<a name="line-2701"></a>   (FUN) ----------------
<a name="line-2702"></a>         t1 -&gt; t2 : Type
<a name="line-2703"></a>
<a name="line-2704"></a>         ty : TYPE rep
<a name="line-2705"></a>         `a` is not free in rep
<a name="line-2706"></a>(FORALL) -----------------------
<a name="line-2707"></a>         forall a. ty : TYPE rep
<a name="line-2708"></a>
<a name="line-2709"></a>In tcTypeKind we consider Constraint and (TYPE LiftedRep) to be distinct:
<a name="line-2710"></a>
<a name="line-2711"></a>          t1 : TYPE rep1
<a name="line-2712"></a>          t2 : TYPE rep2
<a name="line-2713"></a>    (FUN) ----------------
<a name="line-2714"></a>          t1 -&gt; t2 : Type
<a name="line-2715"></a>
<a name="line-2716"></a>          t1 : Constraint
<a name="line-2717"></a>          t2 : TYPE rep
<a name="line-2718"></a>  (PRED1) ----------------
<a name="line-2719"></a>          t1 =&gt; t2 : Type
<a name="line-2720"></a>
<a name="line-2721"></a>          t1 : Constraint
<a name="line-2722"></a>          t2 : Constraint
<a name="line-2723"></a>  (PRED2) ---------------------
<a name="line-2724"></a>          t1 =&gt; t2 : Constraint
<a name="line-2725"></a>
<a name="line-2726"></a>          ty : TYPE rep
<a name="line-2727"></a>          `a` is not free in rep
<a name="line-2728"></a>(FORALL1) -----------------------
<a name="line-2729"></a>          forall a. ty : TYPE rep
<a name="line-2730"></a>
<a name="line-2731"></a>          ty : Constraint
<a name="line-2732"></a>(FORALL2) -------------------------
<a name="line-2733"></a>          forall a. ty : Constraint
<a name="line-2734"></a>
<a name="line-2735"></a>Note that:
<a name="line-2736"></a>* The only way we distinguish '-&gt;' from '=&gt;' is by the fact
<a name="line-2737"></a>  that the argument is a PredTy.  Both are FunTys
<a name="line-2738"></a>
<a name="line-2739"></a>Note [Phantom type variables in kinds]
<a name="line-2740"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2741"></a>Consider
<a name="line-2742"></a>
<a name="line-2743"></a>  type K (r :: RuntimeRep) = Type   -- Note 'r' is unused
<a name="line-2744"></a>  data T r :: K r                   -- T :: forall r -&gt; K r
<a name="line-2745"></a>  foo :: forall r. T r
<a name="line-2746"></a>
<a name="line-2747"></a>The body of the forall in foo's type has kind (K r), and
<a name="line-2748"></a>normally it would make no sense to have
<a name="line-2749"></a>   forall r. (ty :: K r)
<a name="line-2750"></a>because the kind of the forall would escape the binding
<a name="line-2751"></a>of 'r'.  But in this case it's fine because (K r) exapands
<a name="line-2752"></a>to Type, so we explicitly /permit/ the type
<a name="line-2753"></a>   forall r. T r
<a name="line-2754"></a>
<a name="line-2755"></a>To accommodate such a type, in typeKind (forall a.ty) we use
<a name="line-2756"></a>occCheckExpand to expand any type synonyms in the kind of 'ty'
<a name="line-2757"></a>to eliminate 'a'.  See kinding rule (FORALL) in
<a name="line-2758"></a>Note [Kinding rules for types]
<a name="line-2759"></a>
<a name="line-2760"></a>See also
<a name="line-2761"></a> * GHC.Core.Type.occCheckExpand
<a name="line-2762"></a> * GHC.Core.Utils.coreAltsType
<a name="line-2763"></a> * GHC.Tc.Validity.checkEscapingKind
<a name="line-2764"></a>all of which grapple with the same problem.
<a name="line-2765"></a>
<a name="line-2766"></a>See #14939.
<a name="line-2767"></a>-}</span>
<a name="line-2768"></a>
<a name="line-2769"></a><a name="typeKind"></a><span class='hs-comment'>-----------------------------</span>
<a name="line-2770"></a><span class='hs-definition'>typeKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span>
<a name="line-2771"></a><span class='hs-comment'>-- No need to expand synonyms</span>
<a name="line-2772"></a><span class='hs-definition'>typeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>piResultTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-2773"></a><span class='hs-definition'>typeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeLiteralKind</span> <span class='hs-varid'>l</span>
<a name="line-2774"></a><span class='hs-definition'>typeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-2775"></a><span class='hs-definition'>typeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tyvar</span>
<a name="line-2776"></a><span class='hs-definition'>typeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-sel'>_ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionRKind</span> <span class='hs-varid'>co</span>
<a name="line-2777"></a><span class='hs-definition'>typeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionType</span> <span class='hs-varid'>co</span>
<a name="line-2778"></a>
<a name="line-2779"></a><span class='hs-definition'>typeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-2780"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>fun</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span>
<a name="line-2781"></a>  <span class='hs-keyword'>where</span>
<a name="line-2782"></a>    <span class='hs-comment'>-- Accumulate the type arguments, so we can call piResultTys,</span>
<a name="line-2783"></a>    <span class='hs-comment'>-- rather than a succession of calls to piResultTy (which is</span>
<a name="line-2784"></a>    <span class='hs-comment'>-- asymptotically costly as the number of arguments increases)</span>
<a name="line-2785"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-2786"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>fun</span>             <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>piResultTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-2787"></a>
<a name="line-2788"></a><span class='hs-definition'>typeKind</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2789"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>occCheckExpand</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>body_kind</span> <span class='hs-keyword'>of</span>
<a name="line-2790"></a>      <span class='hs-comment'>-- We must make sure tv does not occur in kind</span>
<a name="line-2791"></a>      <span class='hs-comment'>-- As it is already out of scope!</span>
<a name="line-2792"></a>      <span class='hs-comment'>-- See Note [Phantom type variables in kinds]</span>
<a name="line-2793"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>k'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>k'</span>
<a name="line-2794"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"typeKind"</span>
<a name="line-2795"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>body</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>body_kind</span><span class='hs-layout'>)</span>
<a name="line-2796"></a>  <span class='hs-keyword'>where</span>
<a name="line-2797"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTyVars</span> <span class='hs-varid'>ty</span>
<a name="line-2798"></a>    <span class='hs-varid'>body_kind</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>body</span>
<a name="line-2799"></a>
<a name="line-2800"></a><span class='hs-comment'>---------------------------------------------</span>
<a name="line-2801"></a><span class='hs-comment'>-- Utilities to be used in GHC.Core.Unify,</span>
<a name="line-2802"></a><span class='hs-comment'>-- which uses "tc" functions</span>
<a name="line-2803"></a><span class='hs-comment'>---------------------------------------------</span>
<a name="line-2804"></a>
<a name="line-2805"></a><a name="tcTypeKind"></a><span class='hs-definition'>tcTypeKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span>
<a name="line-2806"></a><span class='hs-comment'>-- No need to expand synonyms</span>
<a name="line-2807"></a><span class='hs-definition'>tcTypeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>piResultTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-2808"></a><span class='hs-definition'>tcTypeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeLiteralKind</span> <span class='hs-varid'>l</span>
<a name="line-2809"></a><span class='hs-definition'>tcTypeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tyvar</span>
<a name="line-2810"></a><span class='hs-definition'>tcTypeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-sel'>_ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionRKind</span> <span class='hs-varid'>co</span>
<a name="line-2811"></a><span class='hs-definition'>tcTypeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionType</span> <span class='hs-varid'>co</span>
<a name="line-2812"></a>
<a name="line-2813"></a><span class='hs-definition'>tcTypeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_af</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>af</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2814"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InvisArg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>af</span>
<a name="line-2815"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tcIsConstraintKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcTypeKind</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-2816"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>constraintKind</span>     <span class='hs-comment'>-- Eq a =&gt; Ord a         :: Constraint</span>
<a name="line-2817"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-comment'>-- Eq a =&gt; a -&gt; a        :: TYPE LiftedRep</span>
<a name="line-2818"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftedTypeKind</span>     <span class='hs-comment'>-- Eq a =&gt; Array# Int    :: Type LiftedRep (not TYPE PtrRep)</span>
<a name="line-2819"></a>
<a name="line-2820"></a><span class='hs-definition'>tcTypeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-2821"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>fun</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span>
<a name="line-2822"></a>  <span class='hs-keyword'>where</span>
<a name="line-2823"></a>    <span class='hs-comment'>-- Accumulate the type arguments, so we can call piResultTys,</span>
<a name="line-2824"></a>    <span class='hs-comment'>-- rather than a succession of calls to piResultTy (which is</span>
<a name="line-2825"></a>    <span class='hs-comment'>-- asymptotically costly as the number of arguments increases)</span>
<a name="line-2826"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-2827"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>fun</span>             <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>piResultTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcTypeKind</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-2828"></a>
<a name="line-2829"></a><span class='hs-definition'>tcTypeKind</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2830"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tcIsConstraintKind</span> <span class='hs-varid'>body_kind</span>
<a name="line-2831"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>constraintKind</span>
<a name="line-2832"></a>
<a name="line-2833"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2834"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>occCheckExpand</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>body_kind</span> <span class='hs-keyword'>of</span>
<a name="line-2835"></a>      <span class='hs-comment'>-- We must make sure tv does not occur in kind</span>
<a name="line-2836"></a>      <span class='hs-comment'>-- As it is already out of scope!</span>
<a name="line-2837"></a>      <span class='hs-comment'>-- See Note [Phantom type variables in kinds]</span>
<a name="line-2838"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>k'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>k'</span>
<a name="line-2839"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcTypeKind"</span>
<a name="line-2840"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>body</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>body_kind</span><span class='hs-layout'>)</span>
<a name="line-2841"></a>  <span class='hs-keyword'>where</span>
<a name="line-2842"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTyVars</span> <span class='hs-varid'>ty</span>
<a name="line-2843"></a>    <span class='hs-varid'>body_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTypeKind</span> <span class='hs-varid'>body</span>
<a name="line-2844"></a>
<a name="line-2845"></a>
<a name="line-2846"></a><a name="isPredTy"></a><span class='hs-definition'>isPredTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2847"></a><span class='hs-comment'>-- See Note [Types for coercions, predicates, and evidence] in GHC.Core.TyCo.Rep</span>
<a name="line-2848"></a><span class='hs-definition'>isPredTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcIsConstraintKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcTypeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2849"></a>
<a name="line-2850"></a><a name="tcIsConstraintKind"></a><span class='hs-comment'>-- tcIsConstraintKind stuff only makes sense in the typechecker</span>
<a name="line-2851"></a><span class='hs-comment'>-- After that Constraint = Type</span>
<a name="line-2852"></a><span class='hs-comment'>-- See Note [coreView vs tcView]</span>
<a name="line-2853"></a><span class='hs-comment'>-- Defined here because it is used in isPredTy and tcRepSplitAppTy_maybe (sigh)</span>
<a name="line-2854"></a><span class='hs-definition'>tcIsConstraintKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2855"></a><span class='hs-definition'>tcIsConstraintKind</span> <span class='hs-varid'>ty</span>
<a name="line-2856"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty</span>    <span class='hs-comment'>-- Note: tcSplit here</span>
<a name="line-2857"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isConstraintKindCon</span> <span class='hs-varid'>tc</span>
<a name="line-2858"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>)</span> <span class='hs-conid'>True</span>
<a name="line-2859"></a>
<a name="line-2860"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2861"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2862"></a>
<a name="line-2863"></a><a name="tcKindRep_maybe"></a><span class='hs-comment'>-- | Like 'kindRep_maybe', but considers 'Constraint' to be distinct</span>
<a name="line-2864"></a><span class='hs-comment'>-- from 'Type'. For a version that treats them as the same type, see</span>
<a name="line-2865"></a><span class='hs-comment'>-- 'kindRep_maybe'.</span>
<a name="line-2866"></a><span class='hs-definition'>tcKindRep_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-2867"></a><span class='hs-definition'>tcKindRep_maybe</span> <span class='hs-varid'>kind</span>
<a name="line-2868"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>kind</span>    <span class='hs-comment'>-- Note: tcSplit here</span>
<a name="line-2869"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>tYPETyConKey</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>arg</span>
<a name="line-2870"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-2871"></a>
<a name="line-2872"></a><a name="tcIsLiftedTypeKind"></a><span class='hs-comment'>-- | Is this kind equivalent to 'Type'?</span>
<a name="line-2873"></a><span class='hs-comment'>--</span>
<a name="line-2874"></a><span class='hs-comment'>-- This considers 'Constraint' to be distinct from 'Type'. For a version that</span>
<a name="line-2875"></a><span class='hs-comment'>-- treats them as the same type, see 'isLiftedTypeKind'.</span>
<a name="line-2876"></a><span class='hs-definition'>tcIsLiftedTypeKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2877"></a><span class='hs-definition'>tcIsLiftedTypeKind</span> <span class='hs-varid'>kind</span>
<a name="line-2878"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcKindRep_maybe</span> <span class='hs-varid'>kind</span> <span class='hs-keyword'>of</span>
<a name="line-2879"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>rep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isLiftedRuntimeRep</span> <span class='hs-varid'>rep</span>
<a name="line-2880"></a>      <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-2881"></a>
<a name="line-2882"></a><a name="tcIsBoxedTypeKind"></a><span class='hs-comment'>-- | Is this kind equivalent to @TYPE (BoxedRep l)@ for some @l :: Levity@?</span>
<a name="line-2883"></a><span class='hs-comment'>--</span>
<a name="line-2884"></a><span class='hs-comment'>-- This considers 'Constraint' to be distinct from 'Type'. For a version that</span>
<a name="line-2885"></a><span class='hs-comment'>-- treats them as the same type, see 'isLiftedTypeKind'.</span>
<a name="line-2886"></a><span class='hs-definition'>tcIsBoxedTypeKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2887"></a><span class='hs-definition'>tcIsBoxedTypeKind</span> <span class='hs-varid'>kind</span>
<a name="line-2888"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcKindRep_maybe</span> <span class='hs-varid'>kind</span> <span class='hs-keyword'>of</span>
<a name="line-2889"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>rep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isBoxedRuntimeRep</span> <span class='hs-varid'>rep</span>
<a name="line-2890"></a>      <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-2891"></a>
<a name="line-2892"></a><a name="tcIsRuntimeTypeKind"></a><span class='hs-comment'>-- | Is this kind equivalent to @TYPE r@ (for some unknown r)?</span>
<a name="line-2893"></a><span class='hs-comment'>--</span>
<a name="line-2894"></a><span class='hs-comment'>-- This considers 'Constraint' to be distinct from @*@.</span>
<a name="line-2895"></a><span class='hs-definition'>tcIsRuntimeTypeKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2896"></a><span class='hs-definition'>tcIsRuntimeTypeKind</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcKindRep_maybe</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-2897"></a>
<a name="line-2898"></a><a name="tcReturnsConstraintKind"></a><span class='hs-definition'>tcReturnsConstraintKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2899"></a><span class='hs-comment'>-- True &lt;=&gt; the Kind ultimately returns a Constraint</span>
<a name="line-2900"></a><span class='hs-comment'>--   E.g.  * -&gt; Constraint</span>
<a name="line-2901"></a><span class='hs-comment'>--         forall k. k -&gt; Constraint</span>
<a name="line-2902"></a><span class='hs-definition'>tcReturnsConstraintKind</span> <span class='hs-varid'>kind</span>
<a name="line-2903"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>kind'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcReturnsConstraintKind</span> <span class='hs-varid'>kind'</span>
<a name="line-2904"></a><span class='hs-definition'>tcReturnsConstraintKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcReturnsConstraintKind</span> <span class='hs-varid'>ty</span>
<a name="line-2905"></a><span class='hs-definition'>tcReturnsConstraintKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcReturnsConstraintKind</span> <span class='hs-varid'>ty</span>
<a name="line-2906"></a><span class='hs-definition'>tcReturnsConstraintKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isConstraintKindCon</span> <span class='hs-varid'>tc</span>
<a name="line-2907"></a><span class='hs-definition'>tcReturnsConstraintKind</span> <span class='hs-keyword'>_</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2908"></a>
<a name="line-2909"></a><a name="typeLiteralKind"></a><span class='hs-comment'>--------------------------</span>
<a name="line-2910"></a><span class='hs-definition'>typeLiteralKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyLit</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span>
<a name="line-2911"></a><span class='hs-definition'>typeLiteralKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>NumTyLit</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>naturalTy</span>
<a name="line-2912"></a><span class='hs-definition'>typeLiteralKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrTyLit</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeSymbolKind</span>
<a name="line-2913"></a><span class='hs-definition'>typeLiteralKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>CharTyLit</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>charTy</span>
<a name="line-2914"></a>
<a name="line-2915"></a><a name="isTypeLevPoly"></a><span class='hs-comment'>-- | Returns True if a type is levity polymorphic. Should be the same</span>
<a name="line-2916"></a><span class='hs-comment'>-- as (isKindLevPoly . typeKind) but much faster.</span>
<a name="line-2917"></a><span class='hs-comment'>-- Precondition: The type has kind (TYPE blah)</span>
<a name="line-2918"></a><span class='hs-definition'>isTypeLevPoly</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2919"></a><span class='hs-definition'>isTypeLevPoly</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span>
<a name="line-2920"></a>  <span class='hs-keyword'>where</span>
<a name="line-2921"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>check_kind</span> <span class='hs-varid'>ty</span>
<a name="line-2922"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>check_kind</span> <span class='hs-varid'>ty</span>
<a name="line-2923"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTcLevPoly</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2924"></a>                          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>check_kind</span> <span class='hs-varid'>ty</span>
<a name="line-2925"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>                           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-2926"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2927"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2928"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>check_kind</span> <span class='hs-varid'>ty</span>
<a name="line-2929"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"isTypeLevPoly co"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2930"></a>
<a name="line-2931"></a>    <span class='hs-varid'>check_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isKindLevPoly</span> <span class='hs-varop'>.</span> <span class='hs-varid'>typeKind</span>
<a name="line-2932"></a>
<a name="line-2933"></a><a name="resultIsLevPoly"></a><span class='hs-comment'>-- | Looking past all pi-types, is the end result potentially levity polymorphic?</span>
<a name="line-2934"></a><span class='hs-comment'>-- Example: True for (forall r (a :: TYPE r). String -&gt; a)</span>
<a name="line-2935"></a><span class='hs-comment'>-- Example: False for (forall r1 r2 (a :: TYPE r1) (b :: TYPE r2). a -&gt; b -&gt; Type)</span>
<a name="line-2936"></a><span class='hs-definition'>resultIsLevPoly</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2937"></a><span class='hs-definition'>resultIsLevPoly</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTypeLevPoly</span> <span class='hs-varop'>.</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>.</span> <span class='hs-varid'>splitPiTys</span>
<a name="line-2938"></a>
<a name="line-2939"></a>
<a name="line-2940"></a><span class='hs-comment'>{- **********************************************************************
<a name="line-2941"></a>*                                                                       *
<a name="line-2942"></a>           Occurs check expansion
<a name="line-2943"></a>%*                                                                      *
<a name="line-2944"></a>%********************************************************************* -}</span>
<a name="line-2945"></a>
<a name="line-2946"></a><span class='hs-comment'>{- Note [Occurs check expansion]
<a name="line-2947"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2948"></a>(occurCheckExpand tv xi) expands synonyms in xi just enough to get rid
<a name="line-2949"></a>of occurrences of tv outside type function arguments, if that is
<a name="line-2950"></a>possible; otherwise, it returns Nothing.
<a name="line-2951"></a>
<a name="line-2952"></a>For example, suppose we have
<a name="line-2953"></a>  type F a b = [a]
<a name="line-2954"></a>Then
<a name="line-2955"></a>  occCheckExpand b (F Int b) = Just [Int]
<a name="line-2956"></a>but
<a name="line-2957"></a>  occCheckExpand a (F a Int) = Nothing
<a name="line-2958"></a>
<a name="line-2959"></a>We don't promise to do the absolute minimum amount of expanding
<a name="line-2960"></a>necessary, but we try not to do expansions we don't need to.  We
<a name="line-2961"></a>prefer doing inner expansions first.  For example,
<a name="line-2962"></a>  type F a b = (a, Int, a, [a])
<a name="line-2963"></a>  type G b   = Char
<a name="line-2964"></a>We have
<a name="line-2965"></a>  occCheckExpand b (F (G b)) = Just (F Char)
<a name="line-2966"></a>even though we could also expand F to get rid of b.
<a name="line-2967"></a>
<a name="line-2968"></a>Note [Occurrence checking: look inside kinds]
<a name="line-2969"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2970"></a>Suppose we are considering unifying
<a name="line-2971"></a>   (alpha :: *)  ~  Int -&gt; (beta :: alpha -&gt; alpha)
<a name="line-2972"></a>This may be an error (what is that alpha doing inside beta's kind?),
<a name="line-2973"></a>but we must not make the mistake of actually unifying or we'll
<a name="line-2974"></a>build an infinite data structure.  So when looking for occurrences
<a name="line-2975"></a>of alpha in the rhs, we must look in the kinds of type variables
<a name="line-2976"></a>that occur there.
<a name="line-2977"></a>
<a name="line-2978"></a>occCheckExpand tries to expand type synonyms to remove
<a name="line-2979"></a>unnecessary occurrences of a variable, and thereby get past an
<a name="line-2980"></a>occurs-check failure.  This is good; but
<a name="line-2981"></a>     we can't do it in the /kind/ of a variable /occurrence/
<a name="line-2982"></a>
<a name="line-2983"></a>For example #18451 built an infinite type:
<a name="line-2984"></a>    type Const a b = a
<a name="line-2985"></a>    data SameKind :: k -&gt; k -&gt; Type
<a name="line-2986"></a>    type T (k :: Const Type a) = forall (b :: k). SameKind a b
<a name="line-2987"></a>
<a name="line-2988"></a>We have
<a name="line-2989"></a>  b :: k
<a name="line-2990"></a>  k :: Const Type a
<a name="line-2991"></a>  a :: k   (must be same as b)
<a name="line-2992"></a>
<a name="line-2993"></a>So if we aren't careful, a's kind mentions a, which is bad.
<a name="line-2994"></a>And expanding an /occurrence/ of 'a' doesn't help, because the
<a name="line-2995"></a>/binding site/ is the master copy and all the occurrences should
<a name="line-2996"></a>match it.
<a name="line-2997"></a>
<a name="line-2998"></a>Here's a related example:
<a name="line-2999"></a>   f :: forall a b (c :: Const Type b). Proxy '[a, c]
<a name="line-3000"></a>
<a name="line-3001"></a>The list means that 'a' gets the same kind as 'c'; but that
<a name="line-3002"></a>kind mentions 'b', so the binders are out of order.
<a name="line-3003"></a>
<a name="line-3004"></a>Bottom line: in occCheckExpand, do not expand inside the kinds
<a name="line-3005"></a>of occurrences.  See bad_var_occ in occCheckExpand.  And
<a name="line-3006"></a>see #18451 for more debate.
<a name="line-3007"></a>-}</span>
<a name="line-3008"></a>
<a name="line-3009"></a><a name="occCheckExpand"></a><span class='hs-definition'>occCheckExpand</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-3010"></a><span class='hs-comment'>-- See Note [Occurs check expansion]</span>
<a name="line-3011"></a><span class='hs-comment'>-- We may have needed to do some type synonym unfolding in order to</span>
<a name="line-3012"></a><span class='hs-comment'>-- get rid of the variable (or forall), so we also return the unfolded</span>
<a name="line-3013"></a><span class='hs-comment'>-- version of the type, which is guaranteed to be syntactically free</span>
<a name="line-3014"></a><span class='hs-comment'>-- of the given type variable.  If the type is already syntactically</span>
<a name="line-3015"></a><span class='hs-comment'>-- free of the variable, then the same type is returned.</span>
<a name="line-3016"></a><span class='hs-definition'>occCheckExpand</span> <span class='hs-varid'>vs_to_avoid</span> <span class='hs-varid'>ty</span>
<a name="line-3017"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>vs_to_avoid</span>  <span class='hs-comment'>-- Efficient shortcut</span>
<a name="line-3018"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span>           <span class='hs-comment'>-- Can happen, eg. GHC.Core.Utils.mkSingleAltCase</span>
<a name="line-3019"></a>
<a name="line-3020"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3021"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>vs_to_avoid</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyVarEnv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-3022"></a>  <span class='hs-keyword'>where</span>
<a name="line-3023"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarSet</span><span class='hs-layout'>,</span> <span class='hs-conid'>VarEnv</span> <span class='hs-conid'>TyCoVar</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-3024"></a>          <span class='hs-comment'>-- The VarSet is the set of variables we are trying to avoid</span>
<a name="line-3025"></a>          <span class='hs-comment'>-- The VarEnv carries mappings necessary</span>
<a name="line-3026"></a>          <span class='hs-comment'>-- because of kind expansion</span>
<a name="line-3027"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-keyword'>as</span><span class='hs-layout'>,</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-3028"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span>
<a name="line-3029"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bad_var_occ</span> <span class='hs-keyword'>as</span> <span class='hs-varid'>tv</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-3030"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>
<a name="line-3031"></a>
<a name="line-3032"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>   <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>
<a name="line-3033"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>ty1</span>
<a name="line-3034"></a>                                <span class='hs-layout'>;</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>ty2</span>
<a name="line-3035"></a>                                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3036"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-3037"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>w'</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>w</span>
<a name="line-3038"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>ty1</span>
<a name="line-3039"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>ty2</span>
<a name="line-3040"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_mult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty2'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3041"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>cxt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>as</span><span class='hs-layout'>,</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-varid'>body_ty</span><span class='hs-layout'>)</span>
<a name="line-3042"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ki'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-3043"></a>            <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tv'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setVarType</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ki'</span>
<a name="line-3044"></a>                  <span class='hs-varid'>env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>tv'</span>
<a name="line-3045"></a>                  <span class='hs-varid'>as'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>as</span> <span class='hs-varop'>`delVarSet`</span> <span class='hs-varid'>tv</span>
<a name="line-3046"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>body'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>as'</span><span class='hs-layout'>,</span> <span class='hs-varid'>env'</span><span class='hs-layout'>)</span> <span class='hs-varid'>body_ty</span>
<a name="line-3047"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv'</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3048"></a>
<a name="line-3049"></a>    <span class='hs-comment'>-- For a type constructor application, first try expanding away the</span>
<a name="line-3050"></a>    <span class='hs-comment'>-- offending variable from the arguments.  If that doesn't work, next</span>
<a name="line-3051"></a>    <span class='hs-comment'>-- see if the type constructor is a type synonym, and if so, expand</span>
<a name="line-3052"></a>    <span class='hs-comment'>-- it and try again.</span>
<a name="line-3053"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-3054"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>cxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-keyword'>of</span>
<a name="line-3055"></a>          <span class='hs-conid'>Just</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>
<a name="line-3056"></a>          <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>ty'</span>
<a name="line-3057"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-3058"></a>                      <span class='hs-comment'>-- Failing that, try to expand a synonym</span>
<a name="line-3059"></a>
<a name="line-3060"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>ty</span>
<a name="line-3061"></a>                                <span class='hs-layout'>;</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>co</span>
<a name="line-3062"></a>                                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCastTy</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3063"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>co</span>
<a name="line-3064"></a>                                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoercionTy</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3065"></a>
<a name="line-3066"></a>    <span class='hs-comment'>------------------</span>
<a name="line-3067"></a>    <span class='hs-varid'>bad_var_occ</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3068"></a>    <span class='hs-comment'>-- Works for TyVar and CoVar</span>
<a name="line-3069"></a>    <span class='hs-comment'>-- See Note [Occurrence checking: look inside kinds]</span>
<a name="line-3070"></a>    <span class='hs-varid'>bad_var_occ</span> <span class='hs-varid'>vs_to_avoid</span> <span class='hs-varid'>v</span>
<a name="line-3071"></a>       <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>v</span>                          <span class='hs-varop'>`elemVarSet`</span>       <span class='hs-varid'>vs_to_avoid</span>
<a name="line-3072"></a>       <span class='hs-varop'>||</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varop'>`intersectsVarSet`</span> <span class='hs-varid'>vs_to_avoid</span>
<a name="line-3073"></a>
<a name="line-3074"></a>    <span class='hs-comment'>------------------</span>
<a name="line-3075"></a>    <span class='hs-varid'>go_mco</span> <span class='hs-keyword'>_</span>   <span class='hs-conid'>MRefl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>MRefl</span>
<a name="line-3076"></a>    <span class='hs-varid'>go_mco</span> <span class='hs-varid'>ctx</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>ctx</span> <span class='hs-varid'>co</span>
<a name="line-3077"></a>
<a name="line-3078"></a>    <span class='hs-comment'>------------------</span>
<a name="line-3079"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>ty</span>
<a name="line-3080"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3081"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>mco</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mco'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_mco</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>mco</span>
<a name="line-3082"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>ty</span>
<a name="line-3083"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkGReflCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>mco'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3084"></a>      <span class='hs-comment'>-- Note: Coercions do not contain type synonyms</span>
<a name="line-3085"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-3086"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3087"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>co</span>
<a name="line-3088"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>arg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>arg</span>
<a name="line-3089"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppCo</span> <span class='hs-varid'>co'</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3090"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>as</span><span class='hs-layout'>,</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>body_co</span><span class='hs-layout'>)</span>
<a name="line-3091"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind_co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>kind_co</span>
<a name="line-3092"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setVarType</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>$</span>
<a name="line-3093"></a>                       <span class='hs-varid'>coercionLKind</span> <span class='hs-varid'>kind_co'</span>
<a name="line-3094"></a>                 <span class='hs-varid'>env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>tv'</span>
<a name="line-3095"></a>                 <span class='hs-varid'>as'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>as</span> <span class='hs-varop'>`delVarSet`</span> <span class='hs-varid'>tv</span>
<a name="line-3096"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>body'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_co</span> <span class='hs-layout'>(</span><span class='hs-varid'>as'</span><span class='hs-layout'>,</span> <span class='hs-varid'>env'</span><span class='hs-layout'>)</span> <span class='hs-varid'>body_co</span>
<a name="line-3097"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv'</span> <span class='hs-varid'>kind_co'</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3098"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>w</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>co1</span>
<a name="line-3099"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>co2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>co2</span>
<a name="line-3100"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>w'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>w</span>
<a name="line-3101"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>w'</span> <span class='hs-varid'>co1'</span> <span class='hs-varid'>co2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3102"></a>    <span class='hs-varid'>go_co</span> <span class='hs-layout'>(</span><span class='hs-keyword'>as</span><span class='hs-layout'>,</span><span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-3103"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>c'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>c</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoVarCo</span> <span class='hs-varid'>c'</span><span class='hs-layout'>)</span>
<a name="line-3104"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bad_var_occ</span> <span class='hs-keyword'>as</span> <span class='hs-varid'>c</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-3105"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>co</span>
<a name="line-3106"></a>
<a name="line-3107"></a>    <span class='hs-varid'>go_co</span> <span class='hs-layout'>(</span><span class='hs-keyword'>as</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HoleCo</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>
<a name="line-3108"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bad_var_occ</span> <span class='hs-keyword'>as</span> <span class='hs-layout'>(</span><span class='hs-varid'>ch_co_var</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-3109"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>co</span>
<a name="line-3110"></a>
<a name="line-3111"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-3112"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>args'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3113"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>p'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_prov</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>p</span>
<a name="line-3114"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>ty1</span>
<a name="line-3115"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>ty2</span>
<a name="line-3116"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkUnivCo</span> <span class='hs-varid'>p'</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3117"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>co</span>
<a name="line-3118"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3119"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>co1</span>
<a name="line-3120"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>co2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>co2</span>
<a name="line-3121"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTransCo</span> <span class='hs-varid'>co1'</span> <span class='hs-varid'>co2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3122"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>co</span>
<a name="line-3123"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3124"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>co</span>
<a name="line-3125"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3126"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>co</span>
<a name="line-3127"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>arg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>arg</span>
<a name="line-3128"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInstCo</span> <span class='hs-varid'>co'</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3129"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>co</span>
<a name="line-3130"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3131"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>co</span>
<a name="line-3132"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSubCo</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3133"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>cs</span>
<a name="line-3134"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>cs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3135"></a>
<a name="line-3136"></a>    <span class='hs-comment'>------------------</span>
<a name="line-3137"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PhantomProv</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>co</span>
<a name="line-3138"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>co</span>
<a name="line-3139"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-keyword'>_</span>   <span class='hs-varid'>p</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>p</span>
<a name="line-3140"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-keyword'>_</span>   <span class='hs-varid'>p</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CorePrepProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>p</span>
<a name="line-3141"></a>
<a name="line-3142"></a>
<a name="line-3143"></a><a name="tyConsOfType"></a><span class='hs-comment'>{-
<a name="line-3144"></a>%************************************************************************
<a name="line-3145"></a>%*                                                                      *
<a name="line-3146"></a>        Miscellaneous functions
<a name="line-3147"></a>%*                                                                      *
<a name="line-3148"></a>%************************************************************************
<a name="line-3149"></a>
<a name="line-3150"></a>-}</span>
<a name="line-3151"></a><span class='hs-comment'>-- | All type constructors occurring in the type; looking through type</span>
<a name="line-3152"></a><span class='hs-comment'>--   synonyms, but not newtypes.</span>
<a name="line-3153"></a><span class='hs-comment'>--  When it finds a Class, it returns the class TyCon.</span>
<a name="line-3154"></a><span class='hs-definition'>tyConsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSet</span> <span class='hs-conid'>TyCon</span>
<a name="line-3155"></a><span class='hs-definition'>tyConsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-3156"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-3157"></a>  <span class='hs-keyword'>where</span>
<a name="line-3158"></a>     <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSet</span> <span class='hs-conid'>TyCon</span>  <span class='hs-comment'>-- The UniqSet does duplicate elim</span>
<a name="line-3159"></a>     <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty'</span>
<a name="line-3160"></a>     <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUniqSet</span>
<a name="line-3161"></a>     <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUniqSet</span>
<a name="line-3162"></a>     <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_tc</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`unionUniqSets`</span> <span class='hs-varid'>go_s</span> <span class='hs-varid'>tys</span>
<a name="line-3163"></a>     <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`unionUniqSets`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>b</span>
<a name="line-3164"></a>     <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>w</span> <span class='hs-varop'>`unionUniqSets`</span>
<a name="line-3165"></a>                                      <span class='hs-varid'>go</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`unionUniqSets`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>b</span> <span class='hs-varop'>`unionUniqSets`</span> <span class='hs-varid'>go_tc</span> <span class='hs-varid'>funTyCon</span>
<a name="line-3166"></a>     <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`unionUniqSets`</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-3167"></a>     <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`unionUniqSets`</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>co</span>
<a name="line-3168"></a>     <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>co</span>
<a name="line-3169"></a>
<a name="line-3170"></a>     <span class='hs-varid'>go_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-3171"></a>     <span class='hs-varid'>go_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>mco</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`unionUniqSets`</span> <span class='hs-varid'>go_mco</span> <span class='hs-varid'>mco</span>
<a name="line-3172"></a>     <span class='hs-varid'>go_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_tc</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`unionUniqSets`</span> <span class='hs-varid'>go_cos</span> <span class='hs-varid'>args</span>
<a name="line-3173"></a>     <span class='hs-varid'>go_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`unionUniqSets`</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>arg</span>
<a name="line-3174"></a>     <span class='hs-varid'>go_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>kind_co</span> <span class='hs-varop'>`unionUniqSets`</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>co</span>
<a name="line-3175"></a>     <span class='hs-varid'>go_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co_mult</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>co_mult</span> <span class='hs-varop'>`unionUniqSets`</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionUniqSets`</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>co2</span>
<a name="line-3176"></a>     <span class='hs-varid'>go_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_ax</span> <span class='hs-varid'>ax</span> <span class='hs-varop'>`unionUniqSets`</span> <span class='hs-varid'>go_cos</span> <span class='hs-varid'>args</span>
<a name="line-3177"></a>     <span class='hs-varid'>go_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_prov</span> <span class='hs-varid'>p</span> <span class='hs-varop'>`unionUniqSets`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>`unionUniqSets`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>t2</span>
<a name="line-3178"></a>     <span class='hs-varid'>go_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUniqSet</span>
<a name="line-3179"></a>     <span class='hs-varid'>go_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUniqSet</span>
<a name="line-3180"></a>     <span class='hs-varid'>go_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>co</span>
<a name="line-3181"></a>     <span class='hs-varid'>go_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionUniqSets`</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>co2</span>
<a name="line-3182"></a>     <span class='hs-varid'>go_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>co</span>
<a name="line-3183"></a>     <span class='hs-varid'>go_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>co</span>
<a name="line-3184"></a>     <span class='hs-varid'>go_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`unionUniqSets`</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>arg</span>
<a name="line-3185"></a>     <span class='hs-varid'>go_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>co</span>
<a name="line-3186"></a>     <span class='hs-varid'>go_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>co</span>
<a name="line-3187"></a>     <span class='hs-varid'>go_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_cos</span> <span class='hs-varid'>cs</span>
<a name="line-3188"></a>
<a name="line-3189"></a>     <span class='hs-varid'>go_mco</span> <span class='hs-conid'>MRefl</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUniqSet</span>
<a name="line-3190"></a>     <span class='hs-varid'>go_mco</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>co</span>
<a name="line-3191"></a>
<a name="line-3192"></a>     <span class='hs-varid'>go_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>co</span>
<a name="line-3193"></a>     <span class='hs-varid'>go_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>co</span>
<a name="line-3194"></a>     <span class='hs-varid'>go_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUniqSet</span>
<a name="line-3195"></a>     <span class='hs-varid'>go_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>CorePrepProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUniqSet</span>
<a name="line-3196"></a>        <span class='hs-comment'>-- this last case can happen from the tyConsOfType used from</span>
<a name="line-3197"></a>        <span class='hs-comment'>-- checkTauTvUpdate</span>
<a name="line-3198"></a>
<a name="line-3199"></a>     <span class='hs-varid'>go_s</span> <span class='hs-varid'>tys</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionUniqSets</span> <span class='hs-varop'>.</span> <span class='hs-varid'>go</span><span class='hs-layout'>)</span>     <span class='hs-varid'>emptyUniqSet</span> <span class='hs-varid'>tys</span>
<a name="line-3200"></a>     <span class='hs-varid'>go_cos</span> <span class='hs-varid'>cos</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionUniqSets</span> <span class='hs-varop'>.</span> <span class='hs-varid'>go_co</span><span class='hs-layout'>)</span>  <span class='hs-varid'>emptyUniqSet</span> <span class='hs-varid'>cos</span>
<a name="line-3201"></a>
<a name="line-3202"></a>     <span class='hs-varid'>go_tc</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitUniqSet</span> <span class='hs-varid'>tc</span>
<a name="line-3203"></a>     <span class='hs-varid'>go_ax</span> <span class='hs-varid'>ax</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_tc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coAxiomTyCon</span> <span class='hs-varid'>ax</span>
<a name="line-3204"></a>
<a name="line-3205"></a><a name="splitVisVarsOfType"></a><span class='hs-comment'>-- | Retrieve the free variables in this type, splitting them based</span>
<a name="line-3206"></a><span class='hs-comment'>-- on whether they are used visibly or invisibly. Invisible ones come</span>
<a name="line-3207"></a><span class='hs-comment'>-- first.</span>
<a name="line-3208"></a><span class='hs-definition'>splitVisVarsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-3209"></a><span class='hs-definition'>splitVisVarsOfType</span> <span class='hs-varid'>orig_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>invis_vars</span> <span class='hs-varid'>vis_vars</span>
<a name="line-3210"></a>  <span class='hs-keyword'>where</span>
<a name="line-3211"></a>    <span class='hs-conid'>Pair</span> <span class='hs-varid'>invis_vars1</span> <span class='hs-varid'>vis_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>orig_ty</span>
<a name="line-3212"></a>    <span class='hs-varid'>invis_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>invis_vars1</span> <span class='hs-varop'>`minusVarSet`</span> <span class='hs-varid'>vis_vars</span>
<a name="line-3213"></a>
<a name="line-3214"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitVarSet</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-3215"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>`mappend`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>t2</span>
<a name="line-3216"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_tc</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-3217"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>w</span> <span class='hs-varop'>`mappend`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>`mappend`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>t2</span>
<a name="line-3218"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-3219"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>`delVarSet`</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>`mappend`</span>
<a name="line-3220"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>invisible</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varop'>$</span> <span class='hs-varid'>varType</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3221"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mempty</span>
<a name="line-3222"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`mappend`</span> <span class='hs-varid'>invisible</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3223"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>invisible</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-3224"></a>
<a name="line-3225"></a>    <span class='hs-varid'>invisible</span> <span class='hs-varid'>vs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-3226"></a>
<a name="line-3227"></a>    <span class='hs-varid'>go_tc</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>invis</span><span class='hs-layout'>,</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionInvisibleTypes</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyword'>in</span>
<a name="line-3228"></a>                   <span class='hs-varid'>invisible</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varid'>invis</span><span class='hs-layout'>)</span> <span class='hs-varop'>`mappend`</span> <span class='hs-varid'>foldMap</span> <span class='hs-varid'>go</span> <span class='hs-varid'>vis</span>
<a name="line-3229"></a>
<a name="line-3230"></a><a name="splitVisVarsOfTypes"></a><span class='hs-definition'>splitVisVarsOfTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-3231"></a><span class='hs-definition'>splitVisVarsOfTypes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldMap</span> <span class='hs-varid'>splitVisVarsOfType</span>
<a name="line-3232"></a>
<a name="line-3233"></a><span class='hs-comment'>{-
<a name="line-3234"></a>************************************************************************
<a name="line-3235"></a>*                                                                      *
<a name="line-3236"></a>        Functions over Kinds
<a name="line-3237"></a>*                                                                      *
<a name="line-3238"></a>************************************************************************
<a name="line-3239"></a>
<a name="line-3240"></a>Note [Kind Constraint and kind Type]
<a name="line-3241"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-3242"></a>The kind Constraint is the kind of classes and other type constraints.
<a name="line-3243"></a>The special thing about types of kind Constraint is that
<a name="line-3244"></a> * They are displayed with double arrow:
<a name="line-3245"></a>     f :: Ord a =&gt; a -&gt; a
<a name="line-3246"></a> * They are implicitly instantiated at call sites; so the type inference
<a name="line-3247"></a>   engine inserts an extra argument of type (Ord a) at every call site
<a name="line-3248"></a>   to f.
<a name="line-3249"></a>
<a name="line-3250"></a>However, once type inference is over, there is *no* distinction between
<a name="line-3251"></a>Constraint and Type. Indeed we can have coercions between the two. Consider
<a name="line-3252"></a>   class C a where
<a name="line-3253"></a>     op :: a -&gt; a
<a name="line-3254"></a>For this single-method class we may generate a newtype, which in turn
<a name="line-3255"></a>generates an axiom witnessing
<a name="line-3256"></a>    C a ~ (a -&gt; a)
<a name="line-3257"></a>so on the left we have Constraint, and on the right we have Type.
<a name="line-3258"></a>See #7451.
<a name="line-3259"></a>
<a name="line-3260"></a>Because we treat Constraint/Type differently during and after type inference,
<a name="line-3261"></a>GHC has two notions of equality that differ in whether they equate
<a name="line-3262"></a>Constraint/Type or not:
<a name="line-3263"></a>
<a name="line-3264"></a>* GHC.Tc.Utils.TcType.tcEqType implements typechecker equality (see
<a name="line-3265"></a>  Note [Typechecker equality vs definitional equality] in GHC.Tc.Utils.TcType),
<a name="line-3266"></a>  which treats Constraint and Type as distinct. This is used during type
<a name="line-3267"></a>  inference. See #11715 for issues that arise from this.
<a name="line-3268"></a>* GHC.Core.TyCo.Rep.eqType implements definitional equality (see
<a name="line-3269"></a>  Note [Non-trivial definitional equality] in GHC.Core.TyCo.Rep), which treats
<a name="line-3270"></a>  Constraint and Type as equal. This is used after type inference.
<a name="line-3271"></a>
<a name="line-3272"></a>Bottom line: although 'Type' and 'Constraint' are distinct TyCons, with
<a name="line-3273"></a>distinct uniques, they are treated as equal at all times except
<a name="line-3274"></a>during type inference.
<a name="line-3275"></a>-}</span>
<a name="line-3276"></a>
<a name="line-3277"></a><a name="isKindLevPoly"></a><span class='hs-comment'>-- | Tests whether the given kind (which should look like @TYPE x@)</span>
<a name="line-3278"></a><span class='hs-comment'>-- is something other than a constructor tree (that is, constructors at every node).</span>
<a name="line-3279"></a><span class='hs-comment'>-- E.g.  True of   TYPE k, TYPE (F Int)</span>
<a name="line-3280"></a><span class='hs-comment'>--       False of  TYPE 'LiftedRep</span>
<a name="line-3281"></a><span class='hs-definition'>isKindLevPoly</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3282"></a><span class='hs-definition'>isKindLevPoly</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>k</span> <span class='hs-varop'>||</span> <span class='hs-sel'>_is_type</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span> <span class='hs-layout'>)</span>
<a name="line-3283"></a>                    <span class='hs-comment'>-- the isLiftedTypeKind check is necessary b/c of Constraint</span>
<a name="line-3284"></a>                  <span class='hs-varid'>go</span> <span class='hs-varid'>k</span>
<a name="line-3285"></a>  <span class='hs-keyword'>where</span>
<a name="line-3286"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty'</span>
<a name="line-3287"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>TyVarTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-3288"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>AppTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>  <span class='hs-comment'>-- it can't be a TyConApp</span>
<a name="line-3289"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isFamilyTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>||</span> <span class='hs-varid'>any</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tys</span>
<a name="line-3290"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>ForAllTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-3291"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>w</span> <span class='hs-varop'>||</span> <span class='hs-varid'>go</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>||</span> <span class='hs-varid'>go</span> <span class='hs-varid'>t2</span>
<a name="line-3292"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>LitTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-3293"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>CastTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-3294"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>CoercionTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-3295"></a>
<a name="line-3296"></a>    <span class='hs-sel'>_is_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classifiesTypeWithValues</span> <span class='hs-varid'>k</span>
<a name="line-3297"></a>
<a name="line-3298"></a><span class='hs-comment'>-----------------------------------------</span>
<a name="line-3299"></a><span class='hs-comment'>--              Subkinding</span>
<a name="line-3300"></a><span class='hs-comment'>-- The tc variants are used during type-checking, where ConstraintKind</span>
<a name="line-3301"></a><span class='hs-comment'>-- is distinct from all other kinds</span>
<a name="line-3302"></a><span class='hs-comment'>-- After type-checking (in core), Constraint and liftedTypeKind are</span>
<a name="line-3303"></a><span class='hs-comment'>-- indistinguishable</span>
<a name="line-3304"></a>
<a name="line-3305"></a><a name="classifiesTypeWithValues"></a><span class='hs-comment'>-- | Does this classify a type allowed to have values? Responds True to things</span>
<a name="line-3306"></a><span class='hs-comment'>-- like *, #, TYPE Lifted, TYPE v, Constraint.</span>
<a name="line-3307"></a><span class='hs-definition'>classifiesTypeWithValues</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3308"></a><span class='hs-comment'>-- ^ True of any sub-kind of OpenTypeKind</span>
<a name="line-3309"></a><span class='hs-definition'>classifiesTypeWithValues</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>kindRep_maybe</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-3310"></a>
<a name="line-3311"></a><span class='hs-comment'>{-
<a name="line-3312"></a>%************************************************************************
<a name="line-3313"></a>%*                                                                      *
<a name="line-3314"></a>         Pretty-printing
<a name="line-3315"></a>%*                                                                      *
<a name="line-3316"></a>%************************************************************************
<a name="line-3317"></a>
<a name="line-3318"></a>Most pretty-printing is either in GHC.Core.TyCo.Rep or GHC.Iface.Type.
<a name="line-3319"></a>
<a name="line-3320"></a>-}</span>
<a name="line-3321"></a>
<a name="line-3322"></a><a name="tyConAppNeedsKindSig"></a><span class='hs-comment'>-- | Does a 'TyCon' (that is applied to some number of arguments) need to be</span>
<a name="line-3323"></a><span class='hs-comment'>-- ascribed with an explicit kind signature to resolve ambiguity if rendered as</span>
<a name="line-3324"></a><span class='hs-comment'>-- a source-syntax type?</span>
<a name="line-3325"></a><span class='hs-comment'>-- (See @Note [When does a tycon application need an explicit kind signature?]@</span>
<a name="line-3326"></a><span class='hs-comment'>-- for a full explanation of what this function checks for.)</span>
<a name="line-3327"></a><span class='hs-definition'>tyConAppNeedsKindSig</span>
<a name="line-3328"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>  <span class='hs-comment'>-- ^ Should specified binders count towards injective positions in</span>
<a name="line-3329"></a>           <span class='hs-comment'>--   the kind of the TyCon? (If you're using visible kind</span>
<a name="line-3330"></a>           <span class='hs-comment'>--   applications, then you want True here.</span>
<a name="line-3331"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span>
<a name="line-3332"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>   <span class='hs-comment'>-- ^ The number of args the 'TyCon' is applied to.</span>
<a name="line-3333"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>  <span class='hs-comment'>-- ^ Does @T t_1 ... t_n@ need a kind signature? (Where @n@ is the</span>
<a name="line-3334"></a>           <span class='hs-comment'>--   number of arguments)</span>
<a name="line-3335"></a><span class='hs-definition'>tyConAppNeedsKindSig</span> <span class='hs-varid'>spec_inj_pos</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>n_args</span>
<a name="line-3336"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LT</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>listLengthCmp</span> <span class='hs-varid'>tc_binders</span> <span class='hs-varid'>n_args</span>
<a name="line-3337"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-3338"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3339"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>dropped_binders</span><span class='hs-layout'>,</span> <span class='hs-varid'>remaining_binders</span><span class='hs-layout'>)</span>
<a name="line-3340"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-varid'>n_args</span> <span class='hs-varid'>tc_binders</span>
<a name="line-3341"></a>        <span class='hs-varid'>result_kind</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConKind</span> <span class='hs-varid'>remaining_binders</span> <span class='hs-varid'>tc_res_kind</span>
<a name="line-3342"></a>        <span class='hs-varid'>result_vars</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>result_kind</span>
<a name="line-3343"></a>        <span class='hs-varid'>dropped_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarSet</span> <span class='hs-varop'>$</span>
<a name="line-3344"></a>                       <span class='hs-varid'>mapUnionFV</span> <span class='hs-varid'>injective_vars_of_binder</span> <span class='hs-varid'>dropped_binders</span>
<a name="line-3345"></a>
<a name="line-3346"></a>    <span class='hs-keyword'>in</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>subVarSet</span> <span class='hs-varid'>result_vars</span> <span class='hs-varid'>dropped_vars</span><span class='hs-layout'>)</span>
<a name="line-3347"></a>  <span class='hs-keyword'>where</span>
<a name="line-3348"></a>    <span class='hs-varid'>tc_binders</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConBinders</span> <span class='hs-varid'>tc</span>
<a name="line-3349"></a>    <span class='hs-varid'>tc_res_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConResKind</span> <span class='hs-varid'>tc</span>
<a name="line-3350"></a>
<a name="line-3351"></a>    <span class='hs-comment'>-- Returns the variables that would be fixed by knowing a TyConBinder. See</span>
<a name="line-3352"></a>    <span class='hs-comment'>-- Note [When does a tycon application need an explicit kind signature?]</span>
<a name="line-3353"></a>    <span class='hs-comment'>-- for a more detailed explanation of what this function does.</span>
<a name="line-3354"></a>    <span class='hs-varid'>injective_vars_of_binder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyConBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-3355"></a>    <span class='hs-varid'>injective_vars_of_binder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-3356"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>vis</span> <span class='hs-keyword'>of</span>
<a name="line-3357"></a>        <span class='hs-conid'>AnonTCB</span> <span class='hs-conid'>VisArg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>injectiveVarsOfType</span> <span class='hs-conid'>False</span> <span class='hs-comment'>-- conservative choice</span>
<a name="line-3358"></a>                                              <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-3359"></a>        <span class='hs-conid'>NamedTCB</span> <span class='hs-varid'>argf</span>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>source_of_injectivity</span> <span class='hs-varid'>argf</span>
<a name="line-3360"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unitFV</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`unionFV`</span>
<a name="line-3361"></a>                          <span class='hs-varid'>injectiveVarsOfType</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-3362"></a>        <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyFV</span>
<a name="line-3363"></a>
<a name="line-3364"></a>    <span class='hs-varid'>source_of_injectivity</span> <span class='hs-conid'>Required</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-3365"></a>    <span class='hs-comment'>-- See Note [Explicit Case Statement for Specificity]</span>
<a name="line-3366"></a>    <span class='hs-varid'>source_of_injectivity</span> <span class='hs-layout'>(</span><span class='hs-conid'>Invisible</span> <span class='hs-varid'>spec</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>spec</span> <span class='hs-keyword'>of</span>
<a name="line-3367"></a>      <span class='hs-conid'>SpecifiedSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>spec_inj_pos</span>
<a name="line-3368"></a>      <span class='hs-conid'>InferredSpec</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-3369"></a>
<a name="line-3370"></a><span class='hs-comment'>{-
<a name="line-3371"></a>Note [Explicit Case Statement for Specificity]
<a name="line-3372"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-3373"></a>When pattern matching against an `ArgFlag`, you should not pattern match against
<a name="line-3374"></a>the pattern synonyms 'Specified' or 'Inferred', as this results in a
<a name="line-3375"></a>non-exhaustive pattern match warning.
<a name="line-3376"></a>Instead, pattern match against 'Invisible spec' and do another case analysis on
<a name="line-3377"></a>this specificity argument.
<a name="line-3378"></a>The issue has been fixed in GHC 8.10 (ticket #17876). This hack can thus be
<a name="line-3379"></a>dropped once version 8.10 is used as the minimum version for building GHC.
<a name="line-3380"></a>
<a name="line-3381"></a>Note [When does a tycon application need an explicit kind signature?]
<a name="line-3382"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-3383"></a>There are a couple of places in GHC where we convert Core Types into forms that
<a name="line-3384"></a>more closely resemble user-written syntax. These include:
<a name="line-3385"></a>
<a name="line-3386"></a>1. Template Haskell Type reification (see, for instance, GHC.Tc.Gen.Splice.reify_tc_app)
<a name="line-3387"></a>2. Converting Types to LHsTypes (such as in Haddock.Convert in haddock)
<a name="line-3388"></a>
<a name="line-3389"></a>This conversion presents a challenge: how do we ensure that the resulting type
<a name="line-3390"></a>has enough kind information so as not to be ambiguous? To better motivate this
<a name="line-3391"></a>question, consider the following Core type:
<a name="line-3392"></a>
<a name="line-3393"></a>  -- Foo :: Type -&gt; Type
<a name="line-3394"></a>  type Foo = Proxy Type
<a name="line-3395"></a>
<a name="line-3396"></a>There is nothing ambiguous about the RHS of Foo in Core. But if we were to,
<a name="line-3397"></a>say, reify it into a TH Type, then it's tempting to just drop the invisible
<a name="line-3398"></a>Type argument and simply return `Proxy`. But now we've lost crucial kind
<a name="line-3399"></a>information: we don't know if we're dealing with `Proxy Type` or `Proxy Bool`
<a name="line-3400"></a>or `Proxy Int` or something else! We've inadvertently introduced ambiguity.
<a name="line-3401"></a>
<a name="line-3402"></a>Unlike in other situations in GHC, we can't just turn on
<a name="line-3403"></a>-fprint-explicit-kinds, as we need to produce something which has the same
<a name="line-3404"></a>structure as a source-syntax type. Moreover, we can't rely on visible kind
<a name="line-3405"></a>application, since the first kind argument to Proxy is inferred, not specified.
<a name="line-3406"></a>Our solution is to annotate certain tycons with their kinds whenever they
<a name="line-3407"></a>appear in applied form in order to resolve the ambiguity. For instance, we
<a name="line-3408"></a>would reify the RHS of Foo like so:
<a name="line-3409"></a>
<a name="line-3410"></a>  type Foo = (Proxy :: Type -&gt; Type)
<a name="line-3411"></a>
<a name="line-3412"></a>We need to devise an algorithm that determines precisely which tycons need
<a name="line-3413"></a>these explicit kind signatures. We certainly don't want to annotate _every_
<a name="line-3414"></a>tycon with a kind signature, or else we might end up with horribly bloated
<a name="line-3415"></a>types like the following:
<a name="line-3416"></a>
<a name="line-3417"></a>  (Either :: Type -&gt; Type -&gt; Type) (Int :: Type) (Char :: Type)
<a name="line-3418"></a>
<a name="line-3419"></a>We only want to annotate tycons that absolutely require kind signatures in
<a name="line-3420"></a>order to resolve some sort of ambiguity, and nothing more.
<a name="line-3421"></a>
<a name="line-3422"></a>Suppose we have a tycon application (T ty_1 ... ty_n). Why might this type
<a name="line-3423"></a>require a kind signature? It might require it when we need to fill in any of
<a name="line-3424"></a>T's omitted arguments. By "omitted argument", we mean one that is dropped when
<a name="line-3425"></a>reifying ty_1 ... ty_n. Sometimes, the omitted arguments are inferred and
<a name="line-3426"></a>specified arguments (e.g., TH reification in GHC.Tc.Gen.Splice), and sometimes the
<a name="line-3427"></a>omitted arguments are only the inferred ones (e.g., in situations where
<a name="line-3428"></a>specified arguments are reified through visible kind application).
<a name="line-3429"></a>Regardless, the key idea is that _some_ arguments are going to be omitted after
<a name="line-3430"></a>reification, and the only mechanism we have at our disposal for filling them in
<a name="line-3431"></a>is through explicit kind signatures.
<a name="line-3432"></a>
<a name="line-3433"></a>What do we mean by "fill in"? Let's consider this small example:
<a name="line-3434"></a>
<a name="line-3435"></a>  T :: forall {k}. Type -&gt; (k -&gt; Type) -&gt; k
<a name="line-3436"></a>
<a name="line-3437"></a>Moreover, we have this application of T:
<a name="line-3438"></a>
<a name="line-3439"></a>  T @{j} Int aty
<a name="line-3440"></a>
<a name="line-3441"></a>When we reify this type, we omit the inferred argument @{j}. Is it fixed by the
<a name="line-3442"></a>other (non-inferred) arguments? Yes! If we know the kind of (aty :: blah), then
<a name="line-3443"></a>we'll generate an equality constraint (kappa -&gt; Type) and, assuming we can
<a name="line-3444"></a>solve it, that will fix `kappa`. (Here, `kappa` is the unification variable
<a name="line-3445"></a>that we instantiate `k` with.)
<a name="line-3446"></a>
<a name="line-3447"></a>Therefore, for any application of a tycon T to some arguments, the Question We
<a name="line-3448"></a>Must Answer is:
<a name="line-3449"></a>
<a name="line-3450"></a>* Given the first n arguments of T, do the kinds of the non-omitted arguments
<a name="line-3451"></a>  fill in the omitted arguments?
<a name="line-3452"></a>
<a name="line-3453"></a>(This is still a bit hand-wavey, but we'll refine this question incrementally
<a name="line-3454"></a>as we explain more of the machinery underlying this process.)
<a name="line-3455"></a>
<a name="line-3456"></a>Answering this question is precisely the role that the `injectiveVarsOfType`
<a name="line-3457"></a>and `injective_vars_of_binder` functions exist to serve. If an omitted argument
<a name="line-3458"></a>`a` appears in the set returned by `injectiveVarsOfType ty`, then knowing
<a name="line-3459"></a>`ty` determines (i.e., fills in) `a`. (More on `injective_vars_of_binder` in a
<a name="line-3460"></a>bit.)
<a name="line-3461"></a>
<a name="line-3462"></a>More formally, if
<a name="line-3463"></a>`a` is in `injectiveVarsOfType ty`
<a name="line-3464"></a>and  S1(ty) ~ S2(ty),
<a name="line-3465"></a>then S1(a)  ~ S2(a),
<a name="line-3466"></a>where S1 and S2 are arbitrary substitutions.
<a name="line-3467"></a>
<a name="line-3468"></a>For example, is `F` is a non-injective type family, then
<a name="line-3469"></a>
<a name="line-3470"></a>  injectiveVarsOfType(Either c (Maybe (a, F b c))) = {a, c}
<a name="line-3471"></a>
<a name="line-3472"></a>Now that we know what this function does, here is a second attempt at the
<a name="line-3473"></a>Question We Must Answer:
<a name="line-3474"></a>
<a name="line-3475"></a>* Given the first n arguments of T (ty_1 ... ty_n), consider the binders
<a name="line-3476"></a>  of T that are instantiated by non-omitted arguments. Do the injective
<a name="line-3477"></a>  variables of these binders fill in the remainder of T's kind?
<a name="line-3478"></a>
<a name="line-3479"></a>Alright, we're getting closer. Next, we need to clarify what the injective
<a name="line-3480"></a>variables of a tycon binder are. This the role that the
<a name="line-3481"></a>`injective_vars_of_binder` function serves. Here is what this function does for
<a name="line-3482"></a>each form of tycon binder:
<a name="line-3483"></a>
<a name="line-3484"></a>* Anonymous binders are injective positions. For example, in the promoted data
<a name="line-3485"></a>  constructor '(:):
<a name="line-3486"></a>
<a name="line-3487"></a>    '(:) :: forall a. a -&gt; [a] -&gt; [a]
<a name="line-3488"></a>
<a name="line-3489"></a>  The second and third tyvar binders (of kinds `a` and `[a]`) are both
<a name="line-3490"></a>  anonymous, so if we had '(:) 'True '[], then the kinds of 'True and
<a name="line-3491"></a>  '[] would contribute to the kind of '(:) 'True '[]. Therefore,
<a name="line-3492"></a>  injective_vars_of_binder(_ :: a) = injectiveVarsOfType(a) = {a}.
<a name="line-3493"></a>  (Similarly, injective_vars_of_binder(_ :: [a]) = {a}.)
<a name="line-3494"></a>* Named binders:
<a name="line-3495"></a>  - Inferred binders are never injective positions. For example, in this data
<a name="line-3496"></a>    type:
<a name="line-3497"></a>
<a name="line-3498"></a>      data Proxy a
<a name="line-3499"></a>      Proxy :: forall {k}. k -&gt; Type
<a name="line-3500"></a>
<a name="line-3501"></a>    If we had Proxy 'True, then the kind of 'True would not contribute to the
<a name="line-3502"></a>    kind of Proxy 'True. Therefore,
<a name="line-3503"></a>    injective_vars_of_binder(forall {k}. ...) = {}.
<a name="line-3504"></a>  - Required binders are injective positions. For example, in this data type:
<a name="line-3505"></a>
<a name="line-3506"></a>      data Wurble k (a :: k) :: k
<a name="line-3507"></a>      Wurble :: forall k -&gt; k -&gt; k
<a name="line-3508"></a>
<a name="line-3509"></a>  The first tyvar binder (of kind `forall k`) has required visibility, so if
<a name="line-3510"></a>  we had Wurble (Maybe a) Nothing, then the kind of Maybe a would
<a name="line-3511"></a>  contribute to the kind of Wurble (Maybe a) Nothing. Hence,
<a name="line-3512"></a>  injective_vars_of_binder(forall a -&gt; ...) = {a}.
<a name="line-3513"></a>  - Specified binders /might/ be injective positions, depending on how you
<a name="line-3514"></a>    approach things. Continuing the '(:) example:
<a name="line-3515"></a>
<a name="line-3516"></a>      '(:) :: forall a. a -&gt; [a] -&gt; [a]
<a name="line-3517"></a>
<a name="line-3518"></a>    Normally, the (forall a. ...) tyvar binder wouldn't contribute to the kind
<a name="line-3519"></a>    of '(:) 'True '[], since it's not explicitly instantiated by the user. But
<a name="line-3520"></a>    if visible kind application is enabled, then this is possible, since the
<a name="line-3521"></a>    user can write '(:) @Bool 'True '[]. (In that case,
<a name="line-3522"></a>    injective_vars_of_binder(forall a. ...) = {a}.)
<a name="line-3523"></a>
<a name="line-3524"></a>    There are some situations where using visible kind application is appropriate
<a name="line-3525"></a>    and others where it is not (e.g., TH
<a name="line-3526"></a>    reification), so the `injective_vars_of_binder` function is parametrized by
<a name="line-3527"></a>    a Bool which decides if specified binders should be counted towards
<a name="line-3528"></a>    injective positions or not.
<a name="line-3529"></a>
<a name="line-3530"></a>Now that we've defined injective_vars_of_binder, we can refine the Question We
<a name="line-3531"></a>Must Answer once more:
<a name="line-3532"></a>
<a name="line-3533"></a>* Given the first n arguments of T (ty_1 ... ty_n), consider the binders
<a name="line-3534"></a>  of T that are instantiated by non-omitted arguments. For each such binder
<a name="line-3535"></a>  b_i, take the union of all injective_vars_of_binder(b_i). Is this set a
<a name="line-3536"></a>  superset of the free variables of the remainder of T's kind?
<a name="line-3537"></a>
<a name="line-3538"></a>If the answer to this question is "no", then (T ty_1 ... ty_n) needs an
<a name="line-3539"></a>explicit kind signature, since T's kind has kind variables leftover that
<a name="line-3540"></a>aren't fixed by the non-omitted arguments.
<a name="line-3541"></a>
<a name="line-3542"></a>One last sticking point: what does "the remainder of T's kind" mean? You might
<a name="line-3543"></a>be tempted to think that it corresponds to all of the arguments in the kind of
<a name="line-3544"></a>T that would normally be instantiated by omitted arguments. But this isn't
<a name="line-3545"></a>quite right, strictly speaking. Consider the following (silly) example:
<a name="line-3546"></a>
<a name="line-3547"></a>  S :: forall {k}. Type -&gt; Type
<a name="line-3548"></a>
<a name="line-3549"></a>And suppose we have this application of S:
<a name="line-3550"></a>
<a name="line-3551"></a>  S Int Bool
<a name="line-3552"></a>
<a name="line-3553"></a>The Int argument would be omitted, and
<a name="line-3554"></a>injective_vars_of_binder(_ :: Type) = {}. This is not a superset of {k}, which
<a name="line-3555"></a>might suggest that (S Bool) needs an explicit kind signature. But
<a name="line-3556"></a>(S Bool :: Type) doesn't actually fix `k`! This is because the kind signature
<a name="line-3557"></a>only affects the /result/ of the application, not all of the individual
<a name="line-3558"></a>arguments. So adding a kind signature here won't make a difference. Therefore,
<a name="line-3559"></a>the fourth (and final) iteration of the Question We Must Answer is:
<a name="line-3560"></a>
<a name="line-3561"></a>* Given the first n arguments of T (ty_1 ... ty_n), consider the binders
<a name="line-3562"></a>  of T that are instantiated by non-omitted arguments. For each such binder
<a name="line-3563"></a>  b_i, take the union of all injective_vars_of_binder(b_i). Is this set a
<a name="line-3564"></a>  superset of the free variables of the kind of (T ty_1 ... ty_n)?
<a name="line-3565"></a>
<a name="line-3566"></a>Phew, that was a lot of work!
<a name="line-3567"></a>
<a name="line-3568"></a>How can be sure that this is correct? That is, how can we be sure that in the
<a name="line-3569"></a>event that we leave off a kind annotation, that one could infer the kind of the
<a name="line-3570"></a>tycon application from its arguments? It's essentially a proof by induction: if
<a name="line-3571"></a>we can infer the kinds of every subtree of a type, then the whole tycon
<a name="line-3572"></a>application will have an inferrable kind--unless, of course, the remainder of
<a name="line-3573"></a>the tycon application's kind has uninstantiated kind variables.
<a name="line-3574"></a>
<a name="line-3575"></a>What happens if T is oversaturated? That is, if T's kind has fewer than n
<a name="line-3576"></a>arguments, in the case that the concrete application instantiates a result
<a name="line-3577"></a>kind variable with an arrow kind? If we run out of arguments, we do not attach
<a name="line-3578"></a>a kind annotation. This should be a rare case, indeed. Here is an example:
<a name="line-3579"></a>
<a name="line-3580"></a>   data T1 :: k1 -&gt; k2 -&gt; *
<a name="line-3581"></a>   data T2 :: k1 -&gt; k2 -&gt; *
<a name="line-3582"></a>
<a name="line-3583"></a>   type family G (a :: k) :: k
<a name="line-3584"></a>   type instance G T1 = T2
<a name="line-3585"></a>
<a name="line-3586"></a>   type instance F Char = (G T1 Bool :: (* -&gt; *) -&gt; *)   -- F from above
<a name="line-3587"></a>
<a name="line-3588"></a>Here G's kind is (forall k. k -&gt; k), and the desugared RHS of that last
<a name="line-3589"></a>instance of F is (G (* -&gt; (* -&gt; *) -&gt; *) (T1 * (* -&gt; *)) Bool). According to
<a name="line-3590"></a>the algorithm above, there are 3 arguments to G so we should peel off 3
<a name="line-3591"></a>arguments in G's kind. But G's kind has only two arguments. This is the
<a name="line-3592"></a>rare special case, and we choose not to annotate the application of G with
<a name="line-3593"></a>a kind signature. After all, we needn't do this, since that instance would
<a name="line-3594"></a>be reified as:
<a name="line-3595"></a>
<a name="line-3596"></a>   type instance F Char = G (T1 :: * -&gt; (* -&gt; *) -&gt; *) Bool
<a name="line-3597"></a>
<a name="line-3598"></a>So the kind of G isn't ambiguous anymore due to the explicit kind annotation
<a name="line-3599"></a>on its argument. See #8953 and test th/T8953.
<a name="line-3600"></a>-}</span>
<a name="line-3601"></a>
<a name="line-3602"></a><span class='hs-comment'>{-
<a name="line-3603"></a>************************************************************************
<a name="line-3604"></a>*                                                                      *
<a name="line-3605"></a>        Multiplicities
<a name="line-3606"></a>*                                                                      *
<a name="line-3607"></a>************************************************************************
<a name="line-3608"></a>
<a name="line-3609"></a>These functions would prefer to be in GHC.Core.Multiplicity, but
<a name="line-3610"></a>they some are used elsewhere in this module, and wanted to bring
<a name="line-3611"></a>their friends here with them.
<a name="line-3612"></a>-}</span>
<a name="line-3613"></a>
<a name="line-3614"></a><a name="unrestricted"></a><span class='hs-definition'>unrestricted</span><span class='hs-layout'>,</span> <span class='hs-varid'>linear</span><span class='hs-layout'>,</span> <span class='hs-varid'>tymult</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Scaled</span> <span class='hs-varid'>a</span>
<a name="line-3615"></a>
<a name="line-3616"></a><span class='hs-comment'>-- | Scale a payload by Many</span>
<a name="line-3617"></a><span class='hs-definition'>unrestricted</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Scaled</span> <span class='hs-conid'>Many</span>
<a name="line-3618"></a>
<a name="line-3619"></a><a name="linear"></a><span class='hs-comment'>-- | Scale a payload by One</span>
<a name="line-3620"></a><span class='hs-definition'>linear</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Scaled</span> <span class='hs-conid'>One</span>
<a name="line-3621"></a>
<a name="line-3622"></a><a name="tymult"></a><span class='hs-comment'>-- | Scale a payload by Many; used for type arguments in core</span>
<a name="line-3623"></a><span class='hs-definition'>tymult</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Scaled</span> <span class='hs-conid'>Many</span>
<a name="line-3624"></a>
<a name="line-3625"></a><a name="irrelevantMult"></a><span class='hs-definition'>irrelevantMult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Scaled</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-3626"></a><span class='hs-definition'>irrelevantMult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>scaledThing</span>
<a name="line-3627"></a>
<a name="line-3628"></a><a name="mkScaled"></a><span class='hs-definition'>mkScaled</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Mult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Scaled</span> <span class='hs-varid'>a</span>
<a name="line-3629"></a><span class='hs-definition'>mkScaled</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Scaled</span>
<a name="line-3630"></a>
<a name="line-3631"></a><a name="scaledSet"></a><span class='hs-definition'>scaledSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Scaled</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Scaled</span> <span class='hs-varid'>b</span>
<a name="line-3632"></a><span class='hs-definition'>scaledSet</span> <span class='hs-layout'>(</span><span class='hs-conid'>Scaled</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Scaled</span> <span class='hs-varid'>m</span> <span class='hs-varid'>b</span>
<a name="line-3633"></a>
<a name="line-3634"></a><a name="pattern"></a><span class='hs-definition'>pattern</span> <span class='hs-conid'>One</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Mult</span>
<a name="line-3635"></a><span class='hs-definition'>pattern</span> <span class='hs-conid'>One</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-layout'>(</span><span class='hs-varid'>isOneDataConTy</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-3636"></a>  <span class='hs-keyword'>where</span> <span class='hs-conid'>One</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>oneDataConTy</span>
<a name="line-3637"></a>
<a name="line-3638"></a><span class='hs-definition'>pattern</span> <span class='hs-conid'>Many</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Mult</span>
<a name="line-3639"></a><span class='hs-definition'>pattern</span> <span class='hs-conid'>Many</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-layout'>(</span><span class='hs-varid'>isManyDataConTy</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-3640"></a>  <span class='hs-keyword'>where</span> <span class='hs-conid'>Many</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>manyDataConTy</span>
<a name="line-3641"></a>
<a name="line-3642"></a><a name="isManyDataConTy"></a><span class='hs-definition'>isManyDataConTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Mult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3643"></a><span class='hs-definition'>isManyDataConTy</span> <span class='hs-varid'>ty</span>
<a name="line-3644"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-3645"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>manyDataConKey</span>
<a name="line-3646"></a><span class='hs-definition'>isManyDataConTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-3647"></a>
<a name="line-3648"></a><a name="isOneDataConTy"></a><span class='hs-definition'>isOneDataConTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Mult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3649"></a><span class='hs-definition'>isOneDataConTy</span> <span class='hs-varid'>ty</span>
<a name="line-3650"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-3651"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>oneDataConKey</span>
<a name="line-3652"></a><span class='hs-definition'>isOneDataConTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-3653"></a>
<a name="line-3654"></a><a name="isLinearType"></a><span class='hs-definition'>isLinearType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3655"></a><span class='hs-comment'>-- ^ @isLinear t@ returns @True@ of a if @t@ is a type of (curried) function</span>
<a name="line-3656"></a><span class='hs-comment'>-- where at least one argument is linear (or otherwise non-unrestricted). We use</span>
<a name="line-3657"></a><span class='hs-comment'>-- this function to check whether it is safe to eta reduce an Id in CorePrep. It</span>
<a name="line-3658"></a><span class='hs-comment'>-- is always safe to return 'True', because 'True' deactivates the optimisation.</span>
<a name="line-3659"></a><span class='hs-definition'>isLinearType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-3660"></a>                      <span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Many</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isLinearType</span> <span class='hs-varid'>res</span>
<a name="line-3661"></a>                      <span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-3662"></a>                      <span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isLinearType</span> <span class='hs-varid'>res</span>
<a name="line-3663"></a>                      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
</pre></body>
</html>
