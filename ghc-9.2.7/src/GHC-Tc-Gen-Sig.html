<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Tc/Gen/Sig.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The University of Glasgow 2006-2012
<a name="line-3"></a>(c) The GRASP Project, Glasgow University, 1992-2002
<a name="line-4"></a>
<a name="line-5"></a>-}</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-8"></a><span class='hs-comment'>{-# LANGUAGE TypeFamilies #-}</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Tc.Gen.Sig</span><span class='hs-layout'>(</span>
<a name="line-11"></a>       <span class='hs-conid'>TcSigInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-12"></a>       <span class='hs-conid'>TcIdSigInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcIdSigInst</span><span class='hs-layout'>,</span>
<a name="line-13"></a>       <span class='hs-conid'>TcPatSynInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-14"></a>       <span class='hs-conid'>TcSigFun</span><span class='hs-layout'>,</span>
<a name="line-15"></a>
<a name="line-16"></a>       <span class='hs-varid'>isPartialSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>hasCompleteSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcIdSigName</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSigInfoName</span><span class='hs-layout'>,</span>
<a name="line-17"></a>       <span class='hs-varid'>completeSigPolyId_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCompleteHsSig</span><span class='hs-layout'>,</span>
<a name="line-18"></a>
<a name="line-19"></a>       <span class='hs-varid'>tcTySigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcUserTypeSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>completeSigFromId</span><span class='hs-layout'>,</span>
<a name="line-20"></a>       <span class='hs-varid'>tcInstSig</span><span class='hs-layout'>,</span>
<a name="line-21"></a>
<a name="line-22"></a>       <span class='hs-conid'>TcPragEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyPragEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupPragEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendPragEnv</span><span class='hs-layout'>,</span>
<a name="line-23"></a>       <span class='hs-varid'>mkPragEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSpecPrags</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSpecWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcImpPrags</span><span class='hs-layout'>,</span>
<a name="line-24"></a>       <span class='hs-varid'>addInlinePrags</span><span class='hs-layout'>,</span> <span class='hs-varid'>addInlinePragArity</span>
<a name="line-25"></a>   <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-28"></a>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Hs</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Gen.HsType</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Types</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Solver</span><span class='hs-layout'>(</span> <span class='hs-varid'>pushLevelAndSolveEqualitiesX</span><span class='hs-layout'>,</span> <span class='hs-varid'>reportUnsolvedEqualities</span> <span class='hs-layout'>)</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Monad</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Zonk</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Types.Origin</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.TcType</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.TcMType</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Validity</span> <span class='hs-layout'>(</span> <span class='hs-varid'>checkValidType</span> <span class='hs-layout'>)</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Unify</span><span class='hs-layout'>(</span> <span class='hs-varid'>tcTopSkolemise</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifyType</span> <span class='hs-layout'>)</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Instantiate</span><span class='hs-layout'>(</span> <span class='hs-varid'>topInstantiate</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInstTypeBndrs</span> <span class='hs-layout'>)</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Env</span><span class='hs-layout'>(</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-layout'>)</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Types.Evidence</span><span class='hs-layout'>(</span> <span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;.&gt;</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core</span><span class='hs-layout'>(</span> <span class='hs-varid'>hasSomeUnfolding</span> <span class='hs-layout'>)</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Type</span> <span class='hs-layout'>(</span> <span class='hs-varid'>mkTyVarBinders</span> <span class='hs-layout'>)</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Multiplicity</span>
<a name="line-48"></a>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Session</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Backend</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var</span> <span class='hs-layout'>(</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Specificity</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyVarKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>binderVars</span> <span class='hs-layout'>)</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Id</span>  <span class='hs-layout'>(</span> <span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-varid'>idName</span><span class='hs-layout'>,</span> <span class='hs-varid'>idType</span><span class='hs-layout'>,</span> <span class='hs-varid'>setInlinePragma</span>
<a name="line-53"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>mkLocalId</span><span class='hs-layout'>,</span> <span class='hs-varid'>realIdUnfolding</span> <span class='hs-layout'>)</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Names</span><span class='hs-layout'>(</span> <span class='hs-varid'>mkUnboundName</span> <span class='hs-layout'>)</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Basic</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module</span><span class='hs-layout'>(</span> <span class='hs-varid'>getModule</span> <span class='hs-layout'>)</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Env</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SrcLoc</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Utils</span> <span class='hs-layout'>(</span> <span class='hs-varid'>singleton</span> <span class='hs-layout'>)</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Maybe</span><span class='hs-layout'>(</span> <span class='hs-varid'>orElse</span> <span class='hs-layout'>)</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Maybe</span><span class='hs-layout'>(</span> <span class='hs-varid'>mapMaybe</span> <span class='hs-layout'>)</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad</span><span class='hs-layout'>(</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>)</span>
<a name="line-66"></a>
<a name="line-67"></a>
<a name="line-68"></a><span class='hs-comment'>{- -------------------------------------------------------------
<a name="line-69"></a>          Note [Overview of type signatures]
<a name="line-70"></a>----------------------------------------------------------------
<a name="line-71"></a>Type signatures, including partial signatures, are jolly tricky,
<a name="line-72"></a>especially on value bindings.  Here's an overview.
<a name="line-73"></a>
<a name="line-74"></a>    f :: forall a. [a] -&gt; [a]
<a name="line-75"></a>    g :: forall b. _ -&gt; b
<a name="line-76"></a>
<a name="line-77"></a>    f = ...g...
<a name="line-78"></a>    g = ...f...
<a name="line-79"></a>
<a name="line-80"></a>* HsSyn: a signature in a binding starts off as a TypeSig, in
<a name="line-81"></a>  type HsBinds.Sig
<a name="line-82"></a>
<a name="line-83"></a>* When starting a mutually recursive group, like f/g above, we
<a name="line-84"></a>  call tcTySig on each signature in the group.
<a name="line-85"></a>
<a name="line-86"></a>* tcTySig: Sig -&gt; TcIdSigInfo
<a name="line-87"></a>  - For a /complete/ signature, like 'f' above, tcTySig kind-checks
<a name="line-88"></a>    the HsType, producing a Type, and wraps it in a CompleteSig, and
<a name="line-89"></a>    extend the type environment with this polymorphic 'f'.
<a name="line-90"></a>
<a name="line-91"></a>  - For a /partial/signature, like 'g' above, tcTySig does nothing
<a name="line-92"></a>    Instead it just wraps the pieces in a PartialSig, to be handled
<a name="line-93"></a>    later.
<a name="line-94"></a>
<a name="line-95"></a>* tcInstSig: TcIdSigInfo -&gt; TcIdSigInst
<a name="line-96"></a>  In tcMonoBinds, when looking at an individual binding, we use
<a name="line-97"></a>  tcInstSig to instantiate the signature forall's in the signature,
<a name="line-98"></a>  and attribute that instantiated (monomorphic) type to the
<a name="line-99"></a>  binder.  You can see this in GHC.Tc.Gen.Bind.tcLhsId.
<a name="line-100"></a>
<a name="line-101"></a>  The instantiation does the obvious thing for complete signatures,
<a name="line-102"></a>  but for /partial/ signatures it starts from the HsSyn, so it
<a name="line-103"></a>  has to kind-check it etc: tcHsPartialSigType.  It's convenient
<a name="line-104"></a>  to do this at the same time as instantiation, because we can
<a name="line-105"></a>  make the wildcards into unification variables right away, raather
<a name="line-106"></a>  than somehow quantifying over them.  And the "TcLevel" of those
<a name="line-107"></a>  unification variables is correct because we are in tcMonoBinds.
<a name="line-108"></a>
<a name="line-109"></a>
<a name="line-110"></a>Note [Binding scoped type variables]
<a name="line-111"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-112"></a>The type variables *brought into lexical scope* by a type signature
<a name="line-113"></a>may be a subset of the *quantified type variables* of the signatures,
<a name="line-114"></a>for two reasons:
<a name="line-115"></a>
<a name="line-116"></a>* With kind polymorphism a signature like
<a name="line-117"></a>    f :: forall f a. f a -&gt; f a
<a name="line-118"></a>  may actually give rise to
<a name="line-119"></a>    f :: forall k. forall (f::k -&gt; *) (a:k). f a -&gt; f a
<a name="line-120"></a>  So the sig_tvs will be [k,f,a], but only f,a are scoped.
<a name="line-121"></a>  NB: the scoped ones are not necessarily the *initial* ones!
<a name="line-122"></a>
<a name="line-123"></a>* Even aside from kind polymorphism, there may be more instantiated
<a name="line-124"></a>  type variables than lexically-scoped ones.  For example:
<a name="line-125"></a>        type T a = forall b. b -&gt; (a,b)
<a name="line-126"></a>        f :: forall c. T c
<a name="line-127"></a>  Here, the signature for f will have one scoped type variable, c,
<a name="line-128"></a>  but two instantiated type variables, c' and b'.
<a name="line-129"></a>
<a name="line-130"></a>However, all of this only applies to the renamer.  The typechecker
<a name="line-131"></a>just puts all of them into the type environment; any lexical-scope
<a name="line-132"></a>errors were dealt with by the renamer.
<a name="line-133"></a>
<a name="line-134"></a>-}</span>
<a name="line-135"></a>
<a name="line-136"></a>
<a name="line-137"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-138"></a>*                                                                      *
<a name="line-139"></a>             Utility functions for TcSigInfo
<a name="line-140"></a>*                                                                      *
<a name="line-141"></a>********************************************************************* -}</span>
<a name="line-142"></a>
<a name="line-143"></a><a name="tcIdSigName"></a><span class='hs-definition'>tcIdSigName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcIdSigInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-144"></a><span class='hs-definition'>tcIdSigName</span> <span class='hs-layout'>(</span><span class='hs-conid'>CompleteSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>id</span>
<a name="line-145"></a><span class='hs-definition'>tcIdSigName</span> <span class='hs-layout'>(</span><span class='hs-conid'>PartialSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>psig_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-146"></a>
<a name="line-147"></a><a name="tcSigInfoName"></a><span class='hs-definition'>tcSigInfoName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSigInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-148"></a><span class='hs-definition'>tcSigInfoName</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcIdSig</span>     <span class='hs-varid'>idsi</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcIdSigName</span> <span class='hs-varid'>idsi</span>
<a name="line-149"></a><span class='hs-definition'>tcSigInfoName</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPatSynSig</span> <span class='hs-varid'>tpsi</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>patsig_name</span> <span class='hs-varid'>tpsi</span>
<a name="line-150"></a>
<a name="line-151"></a><a name="completeSigPolyId_maybe"></a><span class='hs-definition'>completeSigPolyId_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSigInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcId</span>
<a name="line-152"></a><span class='hs-definition'>completeSigPolyId_maybe</span> <span class='hs-varid'>sig</span>
<a name="line-153"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcIdSig</span> <span class='hs-varid'>sig_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sig</span>
<a name="line-154"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>CompleteSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sig_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>id</span>
<a name="line-155"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-156"></a>
<a name="line-157"></a>
<a name="line-158"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-159"></a>*                                                                      *
<a name="line-160"></a>               Typechecking user signatures
<a name="line-161"></a>*                                                                      *
<a name="line-162"></a>********************************************************************* -}</span>
<a name="line-163"></a>
<a name="line-164"></a><a name="tcTySigs"></a><span class='hs-definition'>tcTySigs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcSigFun</span><span class='hs-layout'>)</span>
<a name="line-165"></a><span class='hs-definition'>tcTySigs</span> <span class='hs-varid'>hs_sigs</span>
<a name="line-166"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span>
<a name="line-167"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Fail if any of the signatures is duff</span>
<a name="line-168"></a>         <span class='hs-comment'>-- Hence mapAndReportM</span>
<a name="line-169"></a>         <span class='hs-comment'>-- See Note [Fail eagerly on bad signatures]</span>
<a name="line-170"></a>         <span class='hs-varid'>ty_sigs_s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndReportM</span> <span class='hs-varid'>tcTySig</span> <span class='hs-varid'>hs_sigs</span>
<a name="line-171"></a>
<a name="line-172"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ty_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concat</span> <span class='hs-varid'>ty_sigs_s</span>
<a name="line-173"></a>             <span class='hs-varid'>poly_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapMaybe</span> <span class='hs-varid'>completeSigPolyId_maybe</span> <span class='hs-varid'>ty_sigs</span>
<a name="line-174"></a>                        <span class='hs-comment'>-- The returned [TcId] are the ones for which we have</span>
<a name="line-175"></a>                        <span class='hs-comment'>-- a complete type signature.</span>
<a name="line-176"></a>                        <span class='hs-comment'>-- See Note [Complete and partial type signatures]</span>
<a name="line-177"></a>             <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>tcSigInfoName</span> <span class='hs-varid'>sig</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ty_sigs</span><span class='hs-keyglyph'>]</span>
<a name="line-178"></a>
<a name="line-179"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>poly_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-180"></a>
<a name="line-181"></a><a name="tcTySig"></a><span class='hs-definition'>tcTySig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigInfo</span><span class='hs-keyglyph'>]</span>
<a name="line-182"></a><span class='hs-definition'>tcTySig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>IdSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-183"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunSigCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-conid'>False</span>
<a name="line-184"></a>                    <span class='hs-comment'>-- False: do not report redundant constraints</span>
<a name="line-185"></a>                    <span class='hs-comment'>-- The user has no control over the signature!</span>
<a name="line-186"></a>             <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>completeSigFromId</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>id</span>
<a name="line-187"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcIdSig</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-188"></a>
<a name="line-189"></a><span class='hs-definition'>tcTySig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>names</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-190"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpanA</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-191"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sigs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sequence</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>tcUserTypeSig</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>sig_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-192"></a>                          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>]</span>
<a name="line-193"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>TcIdSig</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-194"></a>
<a name="line-195"></a><span class='hs-definition'>tcTySig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>names</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-196"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpanA</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-197"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tpsigs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sequence</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>tcPatSynSig</span> <span class='hs-varid'>name</span> <span class='hs-varid'>sig_ty</span>
<a name="line-198"></a>                            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>]</span>
<a name="line-199"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>TcPatSynSig</span> <span class='hs-varid'>tpsigs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-200"></a>
<a name="line-201"></a><span class='hs-definition'>tcTySig</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-202"></a>
<a name="line-203"></a>
<a name="line-204"></a><a name="tcUserTypeSig"></a><span class='hs-definition'>tcUserTypeSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigWcType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span>
<a name="line-205"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcIdSigInfo</span>
<a name="line-206"></a><span class='hs-comment'>-- A function or expression type signature</span>
<a name="line-207"></a><span class='hs-comment'>-- Returns a fully quantified type signature; even the wildcards</span>
<a name="line-208"></a><span class='hs-comment'>-- are quantified with ordinary skolems that should be instantiated</span>
<a name="line-209"></a><span class='hs-comment'>--</span>
<a name="line-210"></a><span class='hs-comment'>-- The SrcSpan is what to declare as the binding site of the</span>
<a name="line-211"></a><span class='hs-comment'>-- any skolems in the signature. For function signatures we</span>
<a name="line-212"></a><span class='hs-comment'>-- use the whole `f :: ty' signature; for expression signatures</span>
<a name="line-213"></a><span class='hs-comment'>-- just the type part.</span>
<a name="line-214"></a><span class='hs-comment'>--</span>
<a name="line-215"></a><span class='hs-comment'>-- Just n  =&gt; Function type signature       name :: type</span>
<a name="line-216"></a><span class='hs-comment'>-- Nothing =&gt; Expression type signature   &lt;expr&gt; :: type</span>
<a name="line-217"></a><span class='hs-definition'>tcUserTypeSig</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>hs_sig_ty</span> <span class='hs-varid'>mb_name</span>
<a name="line-218"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isCompleteHsSig</span> <span class='hs-varid'>hs_sig_ty</span>
<a name="line-219"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sigma_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsSigWcType</span> <span class='hs-varid'>ctxt_F</span> <span class='hs-varid'>hs_sig_ty</span>
<a name="line-220"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcuser"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sigma_ty</span><span class='hs-layout'>)</span>
<a name="line-221"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span>
<a name="line-222"></a>         <span class='hs-conid'>CompleteSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_bndr</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>name</span> <span class='hs-conid'>Many</span> <span class='hs-varid'>sigma_ty</span>
<a name="line-223"></a>                                   <span class='hs-comment'>-- We use `Many' as the multiplicity here,</span>
<a name="line-224"></a>                                   <span class='hs-comment'>-- as if this identifier corresponds to</span>
<a name="line-225"></a>                                   <span class='hs-comment'>-- anything, it is a top-level</span>
<a name="line-226"></a>                                   <span class='hs-comment'>-- definition. Which are all unrestricted in</span>
<a name="line-227"></a>                                   <span class='hs-comment'>-- the current implementation.</span>
<a name="line-228"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>sig_ctxt</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt_T</span>
<a name="line-229"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>sig_loc</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-230"></a>                       <span class='hs-comment'>-- Location of the &lt;type&gt; in   f :: &lt;type&gt;</span>
<a name="line-231"></a>
<a name="line-232"></a>  <span class='hs-comment'>-- Partial sig with wildcards</span>
<a name="line-233"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-234"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PartialSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>psig_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>psig_hs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_sig_ty</span>
<a name="line-235"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>sig_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt_F</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-236"></a>  <span class='hs-keyword'>where</span>
<a name="line-237"></a>    <span class='hs-varid'>name</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_name</span> <span class='hs-keyword'>of</span>
<a name="line-238"></a>               <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>n</span>
<a name="line-239"></a>               <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkUnboundName</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOcc</span> <span class='hs-str'>"&lt;expression&gt;"</span><span class='hs-layout'>)</span>
<a name="line-240"></a>    <span class='hs-varid'>ctxt_F</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_name</span> <span class='hs-keyword'>of</span>
<a name="line-241"></a>               <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>n</span> <span class='hs-conid'>False</span>
<a name="line-242"></a>               <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSigCtxt</span>
<a name="line-243"></a>    <span class='hs-varid'>ctxt_T</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_name</span> <span class='hs-keyword'>of</span>
<a name="line-244"></a>               <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>n</span> <span class='hs-conid'>True</span>
<a name="line-245"></a>               <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSigCtxt</span>
<a name="line-246"></a>
<a name="line-247"></a>
<a name="line-248"></a>
<a name="line-249"></a><a name="completeSigFromId"></a><span class='hs-definition'>completeSigFromId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcIdSigInfo</span>
<a name="line-250"></a><span class='hs-comment'>-- Used for instance methods and record selectors</span>
<a name="line-251"></a><span class='hs-definition'>completeSigFromId</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>id</span>
<a name="line-252"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CompleteSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span>
<a name="line-253"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>sig_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span>
<a name="line-254"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>sig_loc</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getSrcSpan</span> <span class='hs-varid'>id</span> <span class='hs-layout'>}</span>
<a name="line-255"></a>
<a name="line-256"></a><a name="isCompleteHsSig"></a><span class='hs-definition'>isCompleteHsSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsSigWcType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-257"></a><span class='hs-comment'>-- ^ If there are no wildcards, return a LHsSigWcType</span>
<a name="line-258"></a><span class='hs-definition'>isCompleteHsSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hswc_ext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>hswc_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_sig_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-259"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>null</span> <span class='hs-varid'>wcs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>no_anon_wc_sig_ty</span> <span class='hs-varid'>hs_sig_ty</span>
<a name="line-260"></a>
<a name="line-261"></a><a name="no_anon_wc_sig_ty"></a><span class='hs-definition'>no_anon_wc_sig_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-262"></a><span class='hs-definition'>no_anon_wc_sig_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSig</span><span class='hs-layout'>{</span><span class='hs-varid'>sig_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>outer_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>body</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-263"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>all</span> <span class='hs-varid'>no_anon_wc_tvb</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsOuterExplicitBndrs</span> <span class='hs-varid'>outer_bndrs</span><span class='hs-layout'>)</span>
<a name="line-264"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>no_anon_wc_ty</span> <span class='hs-varid'>body</span>
<a name="line-265"></a>
<a name="line-266"></a><a name="no_anon_wc_ty"></a><span class='hs-definition'>no_anon_wc_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-267"></a><span class='hs-definition'>no_anon_wc_ty</span> <span class='hs-varid'>lty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>lty</span>
<a name="line-268"></a>  <span class='hs-keyword'>where</span>
<a name="line-269"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-270"></a>      <span class='hs-conid'>HsWildCardTy</span> <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-271"></a>      <span class='hs-conid'>HsAppTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty2</span>
<a name="line-272"></a>      <span class='hs-conid'>HsAppKindTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ki</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ki</span>
<a name="line-273"></a>      <span class='hs-conid'>HsFunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>arrowToHsType</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span>
<a name="line-274"></a>      <span class='hs-conid'>HsListTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-275"></a>      <span class='hs-conid'>HsTupleTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>gos</span> <span class='hs-varid'>tys</span>
<a name="line-276"></a>      <span class='hs-conid'>HsSumTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>gos</span> <span class='hs-varid'>tys</span>
<a name="line-277"></a>      <span class='hs-conid'>HsOpTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty1</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty2</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty2</span>
<a name="line-278"></a>      <span class='hs-conid'>HsParTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-279"></a>      <span class='hs-conid'>HsIParamTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-280"></a>      <span class='hs-conid'>HsKindSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>kind</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>kind</span>
<a name="line-281"></a>      <span class='hs-conid'>HsDocTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-282"></a>      <span class='hs-conid'>HsBangTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-283"></a>      <span class='hs-conid'>HsRecTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>flds</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>gos</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>cd_fld_type</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>flds</span>
<a name="line-284"></a>      <span class='hs-conid'>HsExplicitListTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>gos</span> <span class='hs-varid'>tys</span>
<a name="line-285"></a>      <span class='hs-conid'>HsExplicitTupleTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>gos</span> <span class='hs-varid'>tys</span>
<a name="line-286"></a>      <span class='hs-conid'>HsForAllTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hst_tele</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tele</span>
<a name="line-287"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>hst_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>no_anon_wc_tele</span> <span class='hs-varid'>tele</span>
<a name="line-288"></a>                                        <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-289"></a>      <span class='hs-conid'>HsQualTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hst_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span>
<a name="line-290"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>hst_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>gos</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromMaybeContext</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-291"></a>      <span class='hs-conid'>HsSpliceTy</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliced</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSplicedTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>noSrcSpanA</span> <span class='hs-varid'>ty</span>
<a name="line-292"></a>      <span class='hs-conid'>HsSpliceTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-293"></a>      <span class='hs-conid'>HsTyLit</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-294"></a>      <span class='hs-conid'>HsTyVar</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-295"></a>      <span class='hs-conid'>HsStarTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-296"></a>      <span class='hs-conid'>XHsType</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>       <span class='hs-comment'>-- HsCoreTy, which does not have any wildcard</span>
<a name="line-297"></a>
<a name="line-298"></a>    <span class='hs-varid'>gos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>go</span>
<a name="line-299"></a>
<a name="line-300"></a><a name="no_anon_wc_tele"></a><span class='hs-definition'>no_anon_wc_tele</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsForAllTelescope</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-301"></a><span class='hs-definition'>no_anon_wc_tele</span> <span class='hs-varid'>tele</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tele</span> <span class='hs-keyword'>of</span>
<a name="line-302"></a>  <span class='hs-conid'>HsForAllVis</span>   <span class='hs-layout'>{</span> <span class='hs-varid'>hsf_vis_bndrs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ltvs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>all</span> <span class='hs-varid'>no_anon_wc_tvb</span> <span class='hs-varid'>ltvs</span>
<a name="line-303"></a>  <span class='hs-conid'>HsForAllInvis</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsf_invis_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ltvs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>all</span> <span class='hs-varid'>no_anon_wc_tvb</span> <span class='hs-varid'>ltvs</span>
<a name="line-304"></a>
<a name="line-305"></a><a name="no_anon_wc_tvb"></a><span class='hs-definition'>no_anon_wc_tvb</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-varid'>flag</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-306"></a><span class='hs-definition'>no_anon_wc_tvb</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tvb</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tvb</span> <span class='hs-keyword'>of</span>
<a name="line-307"></a>  <span class='hs-conid'>UserTyVar</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-308"></a>  <span class='hs-conid'>KindedTyVar</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ki</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>no_anon_wc_ty</span> <span class='hs-varid'>ki</span>
<a name="line-309"></a>
<a name="line-310"></a><span class='hs-comment'>{- Note [Fail eagerly on bad signatures]
<a name="line-311"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-312"></a>If a type signature is wrong, fail immediately:
<a name="line-313"></a>
<a name="line-314"></a> * the type sigs may bind type variables, so proceeding without them
<a name="line-315"></a>   can lead to a cascade of errors
<a name="line-316"></a>
<a name="line-317"></a> * the type signature might be ambiguous, in which case checking
<a name="line-318"></a>   the code against the signature will give a very similar error
<a name="line-319"></a>   to the ambiguity error.
<a name="line-320"></a>
<a name="line-321"></a>ToDo: this means we fall over if any top-level type signature in the
<a name="line-322"></a>module is wrong, because we typecheck all the signatures together
<a name="line-323"></a>(see GHC.Tc.Gen.Bind.tcValBinds).  Moreover, because of top-level
<a name="line-324"></a>captureTopConstraints, only insoluble constraints will be reported.
<a name="line-325"></a>We typecheck all signatures at the same time because a signature
<a name="line-326"></a>like   f,g :: blah   might have f and g from different SCCs.
<a name="line-327"></a>
<a name="line-328"></a>So it's a bit awkward to get better error recovery, and no one
<a name="line-329"></a>has complained!
<a name="line-330"></a>-}</span>
<a name="line-331"></a>
<a name="line-332"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-333"></a>*                                                                      *
<a name="line-334"></a>        Type checking a pattern synonym signature
<a name="line-335"></a>*                                                                      *
<a name="line-336"></a>************************************************************************
<a name="line-337"></a>
<a name="line-338"></a>Note [Pattern synonym signatures]
<a name="line-339"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-340"></a>Pattern synonym signatures are surprisingly tricky (see #11224 for example).
<a name="line-341"></a>In general they look like this:
<a name="line-342"></a>
<a name="line-343"></a>   pattern P :: forall univ_tvs. req_theta
<a name="line-344"></a>             =&gt; forall ex_tvs. prov_theta
<a name="line-345"></a>             =&gt; arg1 -&gt; .. -&gt; argn -&gt; res_ty
<a name="line-346"></a>
<a name="line-347"></a>For parsing and renaming we treat the signature as an ordinary LHsSigType.
<a name="line-348"></a>
<a name="line-349"></a>Once we get to type checking, we decompose it into its parts, in tcPatSynSig.
<a name="line-350"></a>
<a name="line-351"></a>* Note that 'forall univ_tvs' and 'req_theta =&gt;'
<a name="line-352"></a>        and 'forall ex_tvs'   and 'prov_theta =&gt;'
<a name="line-353"></a>  are all optional.  We gather the pieces at the top of tcPatSynSig
<a name="line-354"></a>
<a name="line-355"></a>* Initially the implicitly-bound tyvars (added by the renamer) include both
<a name="line-356"></a>  universal and existential vars.
<a name="line-357"></a>
<a name="line-358"></a>* After we kind-check the pieces and convert to Types, we do kind generalisation.
<a name="line-359"></a>
<a name="line-360"></a>Note [Report unsolved equalities in tcPatSynSig]
<a name="line-361"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-362"></a>It's important that we solve /all/ the equalities in a pattern
<a name="line-363"></a>synonym signature, because we are going to zonk the signature to
<a name="line-364"></a>a Type (not a TcType), in GHC.Tc.TyCl.PatSyn.tc_patsyn_finish, and that
<a name="line-365"></a>fails if there are un-filled-in coercion variables mentioned
<a name="line-366"></a>in the type (#15694).
<a name="line-367"></a>
<a name="line-368"></a>So we solve all the equalities we can, and report any unsolved ones,
<a name="line-369"></a>rather than leaving them in the ambient constraints to be solved
<a name="line-370"></a>later.  Pattern synonyms are top-level, so there's no problem with
<a name="line-371"></a>completely solving them.
<a name="line-372"></a>-}</span>
<a name="line-373"></a>
<a name="line-374"></a><a name="tcPatSynSig"></a><span class='hs-definition'>tcPatSynSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcPatSynInfo</span>
<a name="line-375"></a><span class='hs-comment'>-- See Note [Pattern synonym signatures]</span>
<a name="line-376"></a><span class='hs-comment'>-- See Note [Recipe for checking a signature] in GHC.Tc.Gen.HsType</span>
<a name="line-377"></a><span class='hs-definition'>tcPatSynSig</span> <span class='hs-varid'>name</span> <span class='hs-varid'>sig_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSig</span><span class='hs-layout'>{</span><span class='hs-varid'>sig_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_outer_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-378"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>hs_req</span><span class='hs-layout'>,</span> <span class='hs-varid'>hs_ty1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitLHsQualTy</span> <span class='hs-varid'>hs_ty</span>
<a name="line-379"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ex_hs_tvbndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>hs_prov</span><span class='hs-layout'>,</span> <span class='hs-varid'>hs_body_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitLHsSigmaTyInvis</span> <span class='hs-varid'>hs_ty1</span>
<a name="line-380"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcPatSynSig 1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span>
<a name="line-381"></a>
<a name="line-382"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>skol_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DataConSkol</span> <span class='hs-varid'>name</span>
<a name="line-383"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tclvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>outer_bndrs</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ex_bndrs</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>req</span><span class='hs-layout'>,</span> <span class='hs-varid'>prov</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-384"></a>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pushLevelAndSolveEqualitiesX</span> <span class='hs-str'>"tcPatSynSig"</span>           <span class='hs-varop'>$</span>
<a name="line-385"></a>                     <span class='hs-comment'>-- See Note [solveEqualities in tcPatSynSig]</span>
<a name="line-386"></a>              <span class='hs-varid'>tcOuterTKBndrs</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>hs_outer_bndrs</span> <span class='hs-varop'>$</span>
<a name="line-387"></a>              <span class='hs-varid'>tcExplicitTKBndrs</span> <span class='hs-varid'>ex_hs_tvbndrs</span>         <span class='hs-varop'>$</span>
<a name="line-388"></a>              <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>req</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsContext</span> <span class='hs-varid'>hs_req</span>
<a name="line-389"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>prov</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsContext</span> <span class='hs-varid'>hs_prov</span>
<a name="line-390"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>body_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsOpenType</span> <span class='hs-varid'>hs_body_ty</span>
<a name="line-391"></a>                     <span class='hs-comment'>-- A (literal) pattern can be unlifted;</span>
<a name="line-392"></a>                     <span class='hs-comment'>-- e.g. pattern Zero &lt;- 0#   (#12094)</span>
<a name="line-393"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>req</span><span class='hs-layout'>,</span> <span class='hs-varid'>prov</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-394"></a>
<a name="line-395"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>implicit_tvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-396"></a>             <span class='hs-varid'>univ_bndrs</span>   <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcInvisTVBinder</span><span class='hs-keyglyph'>]</span>
<a name="line-397"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>implicit_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>univ_bndrs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>outer_bndrs</span> <span class='hs-keyword'>of</span>
<a name="line-398"></a>               <span class='hs-conid'>HsOuterImplicit</span><span class='hs-layout'>{</span><span class='hs-varid'>hso_ximplicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implicit_tvs</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>implicit_tvs</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-399"></a>               <span class='hs-conid'>HsOuterExplicit</span><span class='hs-layout'>{</span><span class='hs-varid'>hso_xexplicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>univ_bndrs</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>univ_bndrs</span><span class='hs-layout'>)</span>
<a name="line-400"></a>
<a name="line-401"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>implicit_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkAndScopedSort</span> <span class='hs-varid'>implicit_tvs</span>
<a name="line-402"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>implicit_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarBinders</span> <span class='hs-conid'>SpecifiedSpec</span> <span class='hs-varid'>implicit_tvs</span>
<a name="line-403"></a>
<a name="line-404"></a>       <span class='hs-comment'>-- Kind generalisation</span>
<a name="line-405"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ungen_patsyn_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>build_patsyn_type</span> <span class='hs-varid'>implicit_bndrs</span> <span class='hs-varid'>univ_bndrs</span>
<a name="line-406"></a>                                                 <span class='hs-varid'>req</span> <span class='hs-varid'>ex_bndrs</span> <span class='hs-varid'>prov</span> <span class='hs-varid'>body_ty</span>
<a name="line-407"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcPatSynSig"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ungen_patsyn_ty</span><span class='hs-layout'>)</span>
<a name="line-408"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kindGeneralizeAll</span> <span class='hs-varid'>ungen_patsyn_ty</span>
<a name="line-409"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>reportUnsolvedEqualities</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>wanted</span>
<a name="line-410"></a>               <span class='hs-comment'>-- See Note [Report unsolved equalities in tcPatSynSig]</span>
<a name="line-411"></a>
<a name="line-412"></a>       <span class='hs-comment'>-- These are /signatures/ so we zonk to squeeze out any kind</span>
<a name="line-413"></a>       <span class='hs-comment'>-- unification variables.  Do this after kindGeneralizeAll which may</span>
<a name="line-414"></a>       <span class='hs-comment'>-- default kind variables to *.</span>
<a name="line-415"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ze</span>                   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkEmptyZonkEnv</span> <span class='hs-conid'>NoFlexi</span>
<a name="line-416"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ze</span><span class='hs-layout'>,</span> <span class='hs-varid'>kv_bndrs</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTyVarBindersX</span>   <span class='hs-varid'>ze</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarBinders</span> <span class='hs-conid'>InferredSpec</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>)</span>
<a name="line-417"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ze</span><span class='hs-layout'>,</span> <span class='hs-varid'>implicit_bndrs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTyVarBindersX</span>   <span class='hs-varid'>ze</span> <span class='hs-varid'>implicit_bndrs</span>
<a name="line-418"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ze</span><span class='hs-layout'>,</span> <span class='hs-varid'>univ_bndrs</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTyVarBindersX</span>   <span class='hs-varid'>ze</span> <span class='hs-varid'>univ_bndrs</span>
<a name="line-419"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ze</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_bndrs</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTyVarBindersX</span>   <span class='hs-varid'>ze</span> <span class='hs-varid'>ex_bndrs</span>
<a name="line-420"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>req</span>                  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypesToTypesX</span> <span class='hs-varid'>ze</span> <span class='hs-varid'>req</span>
<a name="line-421"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>prov</span>                 <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypesToTypesX</span> <span class='hs-varid'>ze</span> <span class='hs-varid'>prov</span>
<a name="line-422"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>body_ty</span>              <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToTypeX</span>   <span class='hs-varid'>ze</span> <span class='hs-varid'>body_ty</span>
<a name="line-423"></a>
<a name="line-424"></a>       <span class='hs-comment'>-- Now do validity checking</span>
<a name="line-425"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varop'>$</span>
<a name="line-426"></a>         <span class='hs-varid'>build_patsyn_type</span> <span class='hs-varid'>implicit_bndrs</span> <span class='hs-varid'>univ_bndrs</span> <span class='hs-varid'>req</span> <span class='hs-varid'>ex_bndrs</span> <span class='hs-varid'>prov</span> <span class='hs-varid'>body_ty</span>
<a name="line-427"></a>
<a name="line-428"></a>       <span class='hs-comment'>-- arguments become the types of binders. We thus cannot allow</span>
<a name="line-429"></a>       <span class='hs-comment'>-- levity polymorphism here</span>
<a name="line-430"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitFunTys</span> <span class='hs-varid'>body_ty</span>
<a name="line-431"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkForLevPoly</span> <span class='hs-varid'>empty</span> <span class='hs-varop'>.</span> <span class='hs-varid'>scaledThing</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys</span>
<a name="line-432"></a>
<a name="line-433"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcTySig }"</span> <span class='hs-varop'>$</span>
<a name="line-434"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"kvs"</span>          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>binderVars</span> <span class='hs-varid'>kv_bndrs</span><span class='hs-layout'>)</span>
<a name="line-435"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"implicit_tvs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>binderVars</span> <span class='hs-varid'>implicit_bndrs</span><span class='hs-layout'>)</span>
<a name="line-436"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"univ_tvs"</span>     <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>binderVars</span> <span class='hs-varid'>univ_bndrs</span><span class='hs-layout'>)</span>
<a name="line-437"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"req"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>req</span>
<a name="line-438"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ex_tvs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>binderVars</span> <span class='hs-varid'>ex_bndrs</span><span class='hs-layout'>)</span>
<a name="line-439"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"prov"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>prov</span>
<a name="line-440"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"body_ty"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>body_ty</span> <span class='hs-keyglyph'>]</span>
<a name="line-441"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TPSI</span> <span class='hs-layout'>{</span> <span class='hs-varid'>patsig_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span>
<a name="line-442"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>patsig_implicit_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kv_bndrs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>implicit_bndrs</span>
<a name="line-443"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>patsig_univ_bndrs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>univ_bndrs</span>
<a name="line-444"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>patsig_req</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>req</span>
<a name="line-445"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>patsig_ex_bndrs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ex_bndrs</span>
<a name="line-446"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>patsig_prov</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prov</span>
<a name="line-447"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>patsig_body_ty</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>body_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-448"></a>  <span class='hs-keyword'>where</span>
<a name="line-449"></a>    <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PatSynCtxt</span> <span class='hs-varid'>name</span>
<a name="line-450"></a>
<a name="line-451"></a>    <span class='hs-varid'>build_patsyn_type</span> <span class='hs-varid'>implicit_bndrs</span> <span class='hs-varid'>univ_bndrs</span> <span class='hs-varid'>req</span> <span class='hs-varid'>ex_bndrs</span> <span class='hs-varid'>prov</span> <span class='hs-varid'>body</span>
<a name="line-452"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInvisForAllTys</span> <span class='hs-varid'>implicit_bndrs</span> <span class='hs-varop'>$</span>
<a name="line-453"></a>        <span class='hs-varid'>mkInvisForAllTys</span> <span class='hs-varid'>univ_bndrs</span> <span class='hs-varop'>$</span>
<a name="line-454"></a>        <span class='hs-varid'>mkPhiTy</span> <span class='hs-varid'>req</span> <span class='hs-varop'>$</span>
<a name="line-455"></a>        <span class='hs-varid'>mkInvisForAllTys</span> <span class='hs-varid'>ex_bndrs</span> <span class='hs-varop'>$</span>
<a name="line-456"></a>        <span class='hs-varid'>mkPhiTy</span> <span class='hs-varid'>prov</span> <span class='hs-varop'>$</span>
<a name="line-457"></a>        <span class='hs-varid'>body</span>
<a name="line-458"></a>
<a name="line-459"></a><a name="ppr_tvs"></a><span class='hs-definition'>ppr_tvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-460"></a><span class='hs-definition'>ppr_tvs</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-461"></a>                           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tvs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-462"></a>
<a name="line-463"></a>
<a name="line-464"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-465"></a>*                                                                      *
<a name="line-466"></a>               Instantiating user signatures
<a name="line-467"></a>*                                                                      *
<a name="line-468"></a>********************************************************************* -}</span>
<a name="line-469"></a>
<a name="line-470"></a>
<a name="line-471"></a><a name="tcInstSig"></a><span class='hs-definition'>tcInstSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcIdSigInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcIdSigInst</span>
<a name="line-472"></a><span class='hs-comment'>-- Instantiate a type signature; only used with plan InferGen</span>
<a name="line-473"></a><span class='hs-definition'>tcInstSig</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CompleteSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-474"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>  <span class='hs-comment'>-- Set the binding site of the tyvars</span>
<a name="line-475"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv_prs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstTypeBndrs</span> <span class='hs-varid'>poly_id</span>
<a name="line-476"></a>              <span class='hs-comment'>-- See Note [Pattern bindings and complete signatures]</span>
<a name="line-477"></a>
<a name="line-478"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TISI</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_inst_sig</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig</span>
<a name="line-479"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_prs</span>
<a name="line-480"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_wcs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-481"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_wcx</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-482"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>theta</span>
<a name="line-483"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_tau</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tau</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-484"></a>
<a name="line-485"></a><span class='hs-definition'>tcInstSig</span> <span class='hs-varid'>hs_sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PartialSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>psig_hs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_ty</span>
<a name="line-486"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>sig_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span>
<a name="line-487"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>sig_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-488"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>  <span class='hs-comment'>-- Set the binding site of the tyvars</span>
<a name="line-489"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Staring partial sig {"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_sig</span><span class='hs-layout'>)</span>
<a name="line-490"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wcx</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv_prs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsPartialSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span>
<a name="line-491"></a>         <span class='hs-comment'>-- See Note [Checking partial type signatures] in GHC.Tc.Gen.HsType</span>
<a name="line-492"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>inst_sig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TISI</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_inst_sig</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_sig</span>
<a name="line-493"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_prs</span>
<a name="line-494"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_wcs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wcs</span>
<a name="line-495"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_wcx</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wcx</span>
<a name="line-496"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>theta</span>
<a name="line-497"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_tau</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tau</span> <span class='hs-layout'>}</span>
<a name="line-498"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"End partial sig }"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>inst_sig</span><span class='hs-layout'>)</span>
<a name="line-499"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>inst_sig</span> <span class='hs-layout'>}</span>
<a name="line-500"></a>
<a name="line-501"></a>
<a name="line-502"></a><span class='hs-comment'>{- Note [Pattern bindings and complete signatures]
<a name="line-503"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-504"></a>Consider
<a name="line-505"></a>      data T a = MkT a a
<a name="line-506"></a>      f :: forall a. a-&gt;a
<a name="line-507"></a>      g :: forall b. b-&gt;b
<a name="line-508"></a>      MkT f g = MkT (\x-&gt;x) (\y-&gt;y)
<a name="line-509"></a>Here we'll infer a type from the pattern of 'T a', but if we feed in
<a name="line-510"></a>the signature types for f and g, we'll end up unifying 'a' and 'b'
<a name="line-511"></a>
<a name="line-512"></a>So we instantiate f and g's signature with TyVarTv skolems
<a name="line-513"></a>(newMetaTyVarTyVars) that can unify with each other.  If too much
<a name="line-514"></a>unification takes place, we'll find out when we do the final
<a name="line-515"></a>impedance-matching check in GHC.Tc.Gen.Bind.mkExport
<a name="line-516"></a>
<a name="line-517"></a>See Note [TyVarTv] in GHC.Tc.Utils.TcMType
<a name="line-518"></a>
<a name="line-519"></a>None of this applies to a function binding with a complete
<a name="line-520"></a>signature, which doesn't use tcInstSig.  See GHC.Tc.Gen.Bind.tcPolyCheck.
<a name="line-521"></a>-}</span>
<a name="line-522"></a>
<a name="line-523"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-524"></a>*                                                                      *
<a name="line-525"></a>                   Pragmas and PragEnv
<a name="line-526"></a>*                                                                      *
<a name="line-527"></a>********************************************************************* -}</span>
<a name="line-528"></a>
<a name="line-529"></a><a name="TcPragEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcPragEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>
<a name="line-530"></a>
<a name="line-531"></a><a name="emptyPragEnv"></a><span class='hs-definition'>emptyPragEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPragEnv</span>
<a name="line-532"></a><span class='hs-definition'>emptyPragEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyNameEnv</span>
<a name="line-533"></a>
<a name="line-534"></a><a name="lookupPragEnv"></a><span class='hs-definition'>lookupPragEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPragEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>
<a name="line-535"></a><span class='hs-definition'>lookupPragEnv</span> <span class='hs-varid'>prag_fn</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>prag_fn</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`orElse`</span> <span class='hs-conid'>[]</span>
<a name="line-536"></a>
<a name="line-537"></a><a name="extendPragEnv"></a><span class='hs-definition'>extendPragEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPragEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPragEnv</span>
<a name="line-538"></a><span class='hs-definition'>extendPragEnv</span> <span class='hs-varid'>prag_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendNameEnv_Acc</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-conid'>Utils.singleton</span> <span class='hs-varid'>prag_fn</span> <span class='hs-varid'>n</span> <span class='hs-varid'>sig</span>
<a name="line-539"></a>
<a name="line-540"></a><a name="mkPragEnv"></a><span class='hs-comment'>---------------</span>
<a name="line-541"></a><span class='hs-definition'>mkPragEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPragEnv</span>
<a name="line-542"></a><span class='hs-definition'>mkPragEnv</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>binds</span>
<a name="line-543"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl'</span> <span class='hs-varid'>extendPragEnv</span> <span class='hs-varid'>emptyNameEnv</span> <span class='hs-varid'>prs</span>
<a name="line-544"></a>  <span class='hs-keyword'>where</span>
<a name="line-545"></a>    <span class='hs-varid'>prs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapMaybe</span> <span class='hs-varid'>get_sig</span> <span class='hs-varid'>sigs</span>
<a name="line-546"></a>
<a name="line-547"></a>    <span class='hs-varid'>get_sig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span>
<a name="line-548"></a>    <span class='hs-varid'>get_sig</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>nm</span><span class='hs-layout'>,</span> <span class='hs-varid'>add_arity</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span>
<a name="line-549"></a>    <span class='hs-varid'>get_sig</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>InlineSig</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>nm</span><span class='hs-layout'>,</span> <span class='hs-varid'>add_arity</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span>
<a name="line-550"></a>    <span class='hs-varid'>get_sig</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCCFunSig</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>nm</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span>
<a name="line-551"></a>    <span class='hs-varid'>get_sig</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-552"></a>
<a name="line-553"></a>    <span class='hs-varid'>add_arity</span> <span class='hs-varid'>n</span> <span class='hs-varid'>sig</span>  <span class='hs-comment'>-- Adjust inl_sat field to match visible arity of function</span>
<a name="line-554"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>ar_env</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>of</span>
<a name="line-555"></a>          <span class='hs-conid'>Just</span> <span class='hs-varid'>ar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>addInlinePragArity</span> <span class='hs-varid'>ar</span> <span class='hs-varid'>sig</span>
<a name="line-556"></a>          <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sig</span> <span class='hs-comment'>-- See Note [Pattern synonym inline arity]</span>
<a name="line-557"></a>
<a name="line-558"></a>    <span class='hs-comment'>-- ar_env maps a local to the arity of its definition</span>
<a name="line-559"></a>    <span class='hs-varid'>ar_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>Arity</span>
<a name="line-560"></a>    <span class='hs-varid'>ar_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>lhsBindArity</span> <span class='hs-varid'>emptyNameEnv</span> <span class='hs-varid'>binds</span>
<a name="line-561"></a>
<a name="line-562"></a><a name="addInlinePragArity"></a><span class='hs-definition'>addInlinePragArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcRn</span>
<a name="line-563"></a><span class='hs-definition'>addInlinePragArity</span> <span class='hs-varid'>ar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>InlineSig</span> <span class='hs-varid'>x</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>InlineSig</span> <span class='hs-varid'>x</span> <span class='hs-varid'>nm</span> <span class='hs-layout'>(</span><span class='hs-varid'>add_inl_arity</span> <span class='hs-varid'>ar</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-564"></a><span class='hs-definition'>addInlinePragArity</span> <span class='hs-varid'>ar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-varid'>x</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-varid'>x</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>add_inl_arity</span> <span class='hs-varid'>ar</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-565"></a><span class='hs-definition'>addInlinePragArity</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig</span>
<a name="line-566"></a>
<a name="line-567"></a><a name="add_inl_arity"></a><span class='hs-definition'>add_inl_arity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InlinePragma</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InlinePragma</span>
<a name="line-568"></a><span class='hs-definition'>add_inl_arity</span> <span class='hs-varid'>ar</span> <span class='hs-varid'>prag</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>InlinePragma</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inl_inline</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inl_spec</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-569"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Inline</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>inl_spec</span>  <span class='hs-comment'>-- Add arity only for real INLINE pragmas, not INLINABLE</span>
<a name="line-570"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prag</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inl_sat</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ar</span> <span class='hs-layout'>}</span>
<a name="line-571"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-572"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prag</span>
<a name="line-573"></a>
<a name="line-574"></a><a name="lhsBindArity"></a><span class='hs-definition'>lhsBindArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsBind</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>Arity</span>
<a name="line-575"></a><span class='hs-definition'>lhsBindArity</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span>
<a name="line-576"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendNameEnv</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>matchGroupArity</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span>
<a name="line-577"></a><span class='hs-definition'>lhsBindArity</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>        <span class='hs-comment'>-- PatBind/VarBind</span>
<a name="line-578"></a>
<a name="line-579"></a>
<a name="line-580"></a><a name="addInlinePrags"></a><span class='hs-comment'>-----------------</span>
<a name="line-581"></a><span class='hs-definition'>addInlinePrags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcId</span>
<a name="line-582"></a><span class='hs-definition'>addInlinePrags</span> <span class='hs-varid'>poly_id</span> <span class='hs-varid'>prags_for_me</span>
<a name="line-583"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>inl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>inls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>inl_prags</span>
<a name="line-584"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"addInlinePrag"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>poly_id</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span>
<a name="line-585"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>inls</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>warn_multiple_inlines</span> <span class='hs-varid'>inl</span> <span class='hs-varid'>inls</span><span class='hs-layout'>)</span>
<a name="line-586"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>poly_id</span> <span class='hs-varop'>`setInlinePragma`</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-587"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-588"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>poly_id</span>
<a name="line-589"></a>  <span class='hs-keyword'>where</span>
<a name="line-590"></a>    <span class='hs-varid'>inl_prags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>prag</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>InlineSig</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>prags_for_me</span><span class='hs-keyglyph'>]</span>
<a name="line-591"></a>
<a name="line-592"></a>    <span class='hs-varid'>warn_multiple_inlines</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-593"></a>
<a name="line-594"></a>    <span class='hs-varid'>warn_multiple_inlines</span> <span class='hs-varid'>inl1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>prag1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>inl2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>prag2</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>inls</span><span class='hs-layout'>)</span>
<a name="line-595"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>inlinePragmaActivation</span> <span class='hs-varid'>prag1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>inlinePragmaActivation</span> <span class='hs-varid'>prag2</span>
<a name="line-596"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>noUserInlineSpec</span> <span class='hs-layout'>(</span><span class='hs-varid'>inlinePragmaSpec</span> <span class='hs-varid'>prag1</span><span class='hs-layout'>)</span>
<a name="line-597"></a>       <span class='hs-keyglyph'>=</span>    <span class='hs-comment'>-- Tiresome: inl1 is put there by virtue of being in a hs-boot loop</span>
<a name="line-598"></a>            <span class='hs-comment'>-- and inl2 is a user NOINLINE pragma; we don't want to complain</span>
<a name="line-599"></a>         <span class='hs-varid'>warn_multiple_inlines</span> <span class='hs-varid'>inl2</span> <span class='hs-varid'>inls</span>
<a name="line-600"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-601"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpanA</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-602"></a>         <span class='hs-varid'>addWarnTc</span> <span class='hs-conid'>NoReason</span>
<a name="line-603"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Multiple INLINE pragmas for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span>
<a name="line-604"></a>                       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Ignoring all but the first"</span>
<a name="line-605"></a>                                <span class='hs-conop'>:</span> <span class='hs-varid'>map</span> <span class='hs-varid'>pp_inl</span> <span class='hs-layout'>(</span><span class='hs-varid'>inl1</span><span class='hs-conop'>:</span><span class='hs-varid'>inl2</span><span class='hs-conop'>:</span><span class='hs-varid'>inls</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-606"></a>
<a name="line-607"></a>    <span class='hs-varid'>pp_inl</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>prag</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-608"></a>
<a name="line-609"></a>
<a name="line-610"></a><span class='hs-comment'>{- Note [Pattern synonym inline arity]
<a name="line-611"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-612"></a>Consider
<a name="line-613"></a>    {-# INLINE P #-}
<a name="line-614"></a>    pattern P x = (x, True)
<a name="line-615"></a>
<a name="line-616"></a>The INLINE pragma attaches to both the /matcher/ and the /builder/ for
<a name="line-617"></a>the pattern synonym; see Note [Pragmas for pattern synonyms] in
<a name="line-618"></a>GHC.Tc.TyCl.PatSyn.  But they have different inline arities (i.e. number
<a name="line-619"></a>of binders to which we apply the function before inlining), and we don't
<a name="line-620"></a>know what those arities are yet.  So for pattern synonyms we don't set
<a name="line-621"></a>the inl_sat field yet; instead we do so (via addInlinePragArity) in
<a name="line-622"></a>GHC.Tc.TyCl.PatSyn.tcPatSynMatcher and tcPatSynBuilderBind.
<a name="line-623"></a>
<a name="line-624"></a>It's a bit messy that we set the arities in different ways.  Perhaps we
<a name="line-625"></a>should add the arity later for all binders.  But it works fine like this.
<a name="line-626"></a>-}</span>
<a name="line-627"></a>
<a name="line-628"></a>
<a name="line-629"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-630"></a>*                                                                      *
<a name="line-631"></a>                   SPECIALISE pragmas
<a name="line-632"></a>*                                                                      *
<a name="line-633"></a>************************************************************************
<a name="line-634"></a>
<a name="line-635"></a>Note [Handling SPECIALISE pragmas]
<a name="line-636"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-637"></a>The basic idea is this:
<a name="line-638"></a>
<a name="line-639"></a>   foo :: Num a =&gt; a -&gt; b -&gt; a
<a name="line-640"></a>   {-# SPECIALISE foo :: Int -&gt; b -&gt; Int #-}
<a name="line-641"></a>
<a name="line-642"></a>We check that
<a name="line-643"></a>   (forall a b. Num a =&gt; a -&gt; b -&gt; a)
<a name="line-644"></a>      is more polymorphic than
<a name="line-645"></a>   forall b. Int -&gt; b -&gt; Int
<a name="line-646"></a>(for which we could use tcSubType, but see below), generating a HsWrapper
<a name="line-647"></a>to connect the two, something like
<a name="line-648"></a>      wrap = /\b. &lt;hole&gt; Int b dNumInt
<a name="line-649"></a>This wrapper is put in the TcSpecPrag, in the ABExport record of
<a name="line-650"></a>the AbsBinds.
<a name="line-651"></a>
<a name="line-652"></a>
<a name="line-653"></a>        f :: (Eq a, Ix b) =&gt; a -&gt; b -&gt; Bool
<a name="line-654"></a>        {-# SPECIALISE f :: (Ix p, Ix q) =&gt; Int -&gt; (p,q) -&gt; Bool #-}
<a name="line-655"></a>        f = &lt;poly_rhs&gt;
<a name="line-656"></a>
<a name="line-657"></a>From this the typechecker generates
<a name="line-658"></a>
<a name="line-659"></a>    AbsBinds [ab] [d1,d2] [([ab], f, f_mono, prags)] binds
<a name="line-660"></a>
<a name="line-661"></a>    SpecPrag (wrap_fn :: forall a b. (Eq a, Ix b) =&gt; XXX
<a name="line-662"></a>                      -&gt; forall p q. (Ix p, Ix q) =&gt; XXX[ Int/a, (p,q)/b ])
<a name="line-663"></a>
<a name="line-664"></a>From these we generate:
<a name="line-665"></a>
<a name="line-666"></a>    Rule:       forall p, q, (dp:Ix p), (dq:Ix q).
<a name="line-667"></a>                    f Int (p,q) dInt ($dfInPair dp dq) = f_spec p q dp dq
<a name="line-668"></a>
<a name="line-669"></a>    Spec bind:  f_spec = wrap_fn &lt;poly_rhs&gt;
<a name="line-670"></a>
<a name="line-671"></a>Note that
<a name="line-672"></a>
<a name="line-673"></a>  * The LHS of the rule may mention dictionary *expressions* (eg
<a name="line-674"></a>    $dfIxPair dp dq), and that is essential because the dp, dq are
<a name="line-675"></a>    needed on the RHS.
<a name="line-676"></a>
<a name="line-677"></a>  * The RHS of f_spec, &lt;poly_rhs&gt; has a *copy* of 'binds', so that it
<a name="line-678"></a>    can fully specialise it.
<a name="line-679"></a>
<a name="line-680"></a>From the TcSpecPrag, in GHC.HsToCore.Binds we generate a binding for f_spec and a RULE:
<a name="line-681"></a>
<a name="line-682"></a>   f_spec :: Int -&gt; b -&gt; Int
<a name="line-683"></a>   f_spec = wrap&lt;f rhs&gt;
<a name="line-684"></a>
<a name="line-685"></a>   RULE: forall b (d:Num b). f b d = f_spec b
<a name="line-686"></a>
<a name="line-687"></a>The RULE is generated by taking apart the HsWrapper, which is a little
<a name="line-688"></a>delicate, but works.
<a name="line-689"></a>
<a name="line-690"></a>Some wrinkles
<a name="line-691"></a>
<a name="line-692"></a>1. In tcSpecWrapper, rather than calling tcSubType, we directly call
<a name="line-693"></a>   skolemise/instantiate.  That is mainly because of wrinkle (2).
<a name="line-694"></a>
<a name="line-695"></a>   Historical note: in the past, tcSubType did co/contra stuff, which
<a name="line-696"></a>   could generate too complex a LHS for the RULE, which was another
<a name="line-697"></a>   reason for not using tcSubType.  But that reason has gone away
<a name="line-698"></a>   with simple subsumption (#17775).
<a name="line-699"></a>
<a name="line-700"></a>2. We need to take care with type families (#5821).  Consider
<a name="line-701"></a>      type instance F Int = Bool
<a name="line-702"></a>      f :: Num a =&gt; a -&gt; F a
<a name="line-703"></a>      {-# SPECIALISE foo :: Int -&gt; Bool #-}
<a name="line-704"></a>
<a name="line-705"></a>  We *could* try to generate an f_spec with precisely the declared type:
<a name="line-706"></a>      f_spec :: Int -&gt; Bool
<a name="line-707"></a>      f_spec = &lt;f rhs&gt; Int dNumInt |&gt; co
<a name="line-708"></a>
<a name="line-709"></a>      RULE: forall d. f Int d = f_spec |&gt; sym co
<a name="line-710"></a>
<a name="line-711"></a>  but the 'co' and 'sym co' are (a) playing no useful role, and (b) are
<a name="line-712"></a>  hard to generate.  At all costs we must avoid this:
<a name="line-713"></a>      RULE: forall d. f Int d |&gt; co = f_spec
<a name="line-714"></a>  because the LHS will never match (indeed it's rejected in
<a name="line-715"></a>  decomposeRuleLhs).
<a name="line-716"></a>
<a name="line-717"></a>  So we simply do this:
<a name="line-718"></a>    - Generate a constraint to check that the specialised type (after
<a name="line-719"></a>      skolemisation) is equal to the instantiated function type.
<a name="line-720"></a>    - But *discard* the evidence (coercion) for that constraint,
<a name="line-721"></a>      so that we ultimately generate the simpler code
<a name="line-722"></a>          f_spec :: Int -&gt; F Int
<a name="line-723"></a>          f_spec = &lt;f rhs&gt; Int dNumInt
<a name="line-724"></a>
<a name="line-725"></a>          RULE: forall d. f Int d = f_spec
<a name="line-726"></a>      You can see this discarding happening in tcSpecPrag
<a name="line-727"></a>
<a name="line-728"></a>3. Note that the HsWrapper can transform *any* function with the right
<a name="line-729"></a>   type prefix
<a name="line-730"></a>       forall ab. (Eq a, Ix b) =&gt; XXX
<a name="line-731"></a>   regardless of XXX.  It's sort of polymorphic in XXX.  This is
<a name="line-732"></a>   useful: we use the same wrapper to transform each of the class ops, as
<a name="line-733"></a>   well as the dict.  That's what goes on in GHC.Tc.TyCl.Instance.mk_meth_spec_prags
<a name="line-734"></a>-}</span>
<a name="line-735"></a>
<a name="line-736"></a><a name="tcSpecPrags"></a><span class='hs-definition'>tcSpecPrags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>
<a name="line-737"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTcSpecPrag</span><span class='hs-keyglyph'>]</span>
<a name="line-738"></a><span class='hs-comment'>-- Add INLINE and SPECIALSE pragmas</span>
<a name="line-739"></a><span class='hs-comment'>--    INLINE prags are added to the (polymorphic) Id directly</span>
<a name="line-740"></a><span class='hs-comment'>--    SPECIALISE prags are passed to the desugarer via TcSpecPrags</span>
<a name="line-741"></a><span class='hs-comment'>-- Pre-condition: the poly_id is zonked</span>
<a name="line-742"></a><span class='hs-comment'>-- Reason: required by tcSubExp</span>
<a name="line-743"></a><span class='hs-definition'>tcSpecPrags</span> <span class='hs-varid'>poly_id</span> <span class='hs-varid'>prag_sigs</span>
<a name="line-744"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcSpecPrags"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>poly_id</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>spec_sigs</span><span class='hs-layout'>)</span>
<a name="line-745"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>bad_sigs</span><span class='hs-layout'>)</span> <span class='hs-varid'>warn_discarded_sigs</span>
<a name="line-746"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>pss</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndRecoverM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocMA</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcSpecPrag</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>spec_sigs</span>
<a name="line-747"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-varid'>pss</span> <span class='hs-layout'>}</span>
<a name="line-748"></a>  <span class='hs-keyword'>where</span>
<a name="line-749"></a>    <span class='hs-varid'>spec_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isSpecLSig</span> <span class='hs-varid'>prag_sigs</span>
<a name="line-750"></a>    <span class='hs-varid'>bad_sigs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>is_bad_sig</span> <span class='hs-varid'>prag_sigs</span>
<a name="line-751"></a>    <span class='hs-varid'>is_bad_sig</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSpecLSig</span> <span class='hs-varid'>s</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isInlineLSig</span> <span class='hs-varid'>s</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isSCCFunSig</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-752"></a>
<a name="line-753"></a>    <span class='hs-varid'>warn_discarded_sigs</span>
<a name="line-754"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addWarnTc</span> <span class='hs-conid'>NoReason</span>
<a name="line-755"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Discarding unexpected pragmas for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span>
<a name="line-756"></a>                      <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>bad_sigs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-757"></a>
<a name="line-758"></a><a name="tcSpecPrag"></a><span class='hs-comment'>--------------</span>
<a name="line-759"></a><span class='hs-definition'>tcSpecPrag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Sig</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSpecPrag</span><span class='hs-keyglyph'>]</span>
<a name="line-760"></a><span class='hs-definition'>tcSpecPrag</span> <span class='hs-varid'>poly_id</span> <span class='hs-varid'>prag</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>fun_name</span> <span class='hs-varid'>hs_tys</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span>
<a name="line-761"></a><span class='hs-comment'>-- See Note [Handling SPECIALISE pragmas]</span>
<a name="line-762"></a><span class='hs-comment'>--</span>
<a name="line-763"></a><span class='hs-comment'>-- The Name fun_name in the SpecSig may not be the same as that of the poly_id</span>
<a name="line-764"></a><span class='hs-comment'>-- Example: SPECIALISE for a class method: the Name in the SpecSig is</span>
<a name="line-765"></a><span class='hs-comment'>--          for the selector Id, but the poly_id is something like $cop</span>
<a name="line-766"></a><span class='hs-comment'>-- However we want to use fun_name in the error message, since that is</span>
<a name="line-767"></a><span class='hs-comment'>-- what the user wrote (#8537)</span>
<a name="line-768"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>spec_ctxt</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-769"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>warnIf</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isOverloadedTy</span> <span class='hs-varid'>poly_ty</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isInlinePragma</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-770"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"SPECIALISE pragma for non-overloaded function"</span>
<a name="line-771"></a>                  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fun_name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-772"></a>                  <span class='hs-comment'>-- Note [SPECIALISE pragmas]</span>
<a name="line-773"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>spec_prags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tc_one</span> <span class='hs-varid'>hs_tys</span>
<a name="line-774"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcSpecPrag"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>poly_id</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>spec_prags</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-775"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>spec_prags</span> <span class='hs-layout'>}</span>
<a name="line-776"></a>  <span class='hs-keyword'>where</span>
<a name="line-777"></a>    <span class='hs-varid'>name</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>poly_id</span>
<a name="line-778"></a>    <span class='hs-varid'>poly_ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>poly_id</span>
<a name="line-779"></a>    <span class='hs-varid'>spec_ctxt</span> <span class='hs-varid'>prag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"In the pragma:"</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span>
<a name="line-780"></a>
<a name="line-781"></a>    <span class='hs-varid'>tc_one</span> <span class='hs-varid'>hs_ty</span>
<a name="line-782"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>spec_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsSigType</span>   <span class='hs-layout'>(</span><span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>name</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_ty</span>
<a name="line-783"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>wrap</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSpecWrapper</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>name</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>  <span class='hs-varid'>poly_ty</span> <span class='hs-varid'>spec_ty</span>
<a name="line-784"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecPrag</span> <span class='hs-varid'>poly_id</span> <span class='hs-varid'>wrap</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-785"></a>
<a name="line-786"></a><span class='hs-definition'>tcSpecPrag</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>prag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcSpecPrag"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span>
<a name="line-787"></a>
<a name="line-788"></a><a name="tcSpecWrapper"></a><span class='hs-comment'>--------------</span>
<a name="line-789"></a><span class='hs-definition'>tcSpecWrapper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-790"></a><span class='hs-comment'>-- A simpler variant of tcSubType, used for SPECIALISE pragmas</span>
<a name="line-791"></a><span class='hs-comment'>-- See Note [Handling SPECIALISE pragmas], wrinkle 1</span>
<a name="line-792"></a><span class='hs-definition'>tcSpecWrapper</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>poly_ty</span> <span class='hs-varid'>spec_ty</span>
<a name="line-793"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>sk_wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_wrap</span><span class='hs-layout'>)</span>
<a name="line-794"></a>               <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTopSkolemise</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>spec_ty</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>spec_tau</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-795"></a>                  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>inst_wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>topInstantiate</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>poly_ty</span>
<a name="line-796"></a>                     <span class='hs-layout'>;</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>spec_tau</span> <span class='hs-varid'>tau</span>
<a name="line-797"></a>                            <span class='hs-comment'>-- Deliberately ignore the evidence</span>
<a name="line-798"></a>                            <span class='hs-comment'>-- See Note [Handling SPECIALISE pragmas],</span>
<a name="line-799"></a>                            <span class='hs-comment'>--   wrinkle (2)</span>
<a name="line-800"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>inst_wrap</span> <span class='hs-layout'>}</span>
<a name="line-801"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sk_wrap</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>inst_wrap</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-802"></a>  <span class='hs-keyword'>where</span>
<a name="line-803"></a>    <span class='hs-varid'>orig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SpecPragOrigin</span> <span class='hs-varid'>ctxt</span>
<a name="line-804"></a>
<a name="line-805"></a><a name="tcImpPrags"></a><span class='hs-comment'>--------------</span>
<a name="line-806"></a><span class='hs-definition'>tcImpPrags</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTcSpecPrag</span><span class='hs-keyglyph'>]</span>
<a name="line-807"></a><span class='hs-comment'>-- SPECIALISE pragmas for imported things</span>
<a name="line-808"></a><span class='hs-definition'>tcImpPrags</span> <span class='hs-varid'>prags</span>
<a name="line-809"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>this_mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-810"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-811"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>not_specialising</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span>
<a name="line-812"></a>            <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-813"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-814"></a>            <span class='hs-layout'>{</span> <span class='hs-varid'>pss</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndRecoverM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocMA</span> <span class='hs-varid'>tcImpSpec</span><span class='hs-layout'>)</span>
<a name="line-815"></a>                     <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span><span class='hs-varid'>prag</span><span class='hs-layout'>)</span>
<a name="line-816"></a>                             <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>prag</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>prags</span>
<a name="line-817"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-818"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-varid'>pss</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-819"></a>  <span class='hs-keyword'>where</span>
<a name="line-820"></a>    <span class='hs-comment'>-- Ignore SPECIALISE pragmas for imported things</span>
<a name="line-821"></a>    <span class='hs-comment'>-- when we aren't specialising, or when we aren't generating</span>
<a name="line-822"></a>    <span class='hs-comment'>-- code.  The latter happens when Haddocking the base library;</span>
<a name="line-823"></a>    <span class='hs-comment'>-- we don't want complaints about lack of INLINABLE pragmas</span>
<a name="line-824"></a>    <span class='hs-varid'>not_specialising</span> <span class='hs-varid'>dflags</span>
<a name="line-825"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_Specialise</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-826"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>backend</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>of</span>
<a name="line-827"></a>                      <span class='hs-conid'>NoBackend</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-828"></a>                      <span class='hs-conid'>Interpreter</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-829"></a>                      <span class='hs-sel'>_other</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-830"></a>
<a name="line-831"></a><a name="tcImpSpec"></a><span class='hs-definition'>tcImpSpec</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Sig</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSpecPrag</span><span class='hs-keyglyph'>]</span>
<a name="line-832"></a><span class='hs-definition'>tcImpSpec</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span>
<a name="line-833"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>name</span>
<a name="line-834"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>hasSomeUnfolding</span> <span class='hs-layout'>(</span><span class='hs-varid'>realIdUnfolding</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-835"></a>           <span class='hs-comment'>-- See Note [SPECIALISE pragmas for imported Ids]</span>
<a name="line-836"></a>        <span class='hs-keyword'>then</span> <span class='hs-varid'>tcSpecPrag</span> <span class='hs-varid'>id</span> <span class='hs-varid'>prag</span>
<a name="line-837"></a>        <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>addWarnTc</span> <span class='hs-conid'>NoReason</span> <span class='hs-layout'>(</span><span class='hs-varid'>impSpecErr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-838"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-839"></a>
<a name="line-840"></a><a name="impSpecErr"></a><span class='hs-definition'>impSpecErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-841"></a><span class='hs-definition'>impSpecErr</span> <span class='hs-varid'>name</span>
<a name="line-842"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"You cannot SPECIALISE"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-843"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"because its definition is not visible in this module"</span>
<a name="line-844"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Hint: make sure"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"is compiled with -O"</span>
<a name="line-845"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"      and that"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-846"></a>                 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"has an INLINABLE pragma"</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-847"></a>  <span class='hs-keyword'>where</span>
<a name="line-848"></a>    <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span>
<a name="line-849"></a>
<a name="line-850"></a><span class='hs-comment'>{- Note [SPECIALISE pragmas for imported Ids]
<a name="line-851"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-852"></a>An imported Id may or may not have an unfolding.  If not, we obviously
<a name="line-853"></a>can't specialise it here; indeed the desugar falls over (#18118).
<a name="line-854"></a>
<a name="line-855"></a>We used to test whether it had a user-specified INLINABLE pragma but,
<a name="line-856"></a>because of Note [Worker-wrapper for INLINABLE functions] in
<a name="line-857"></a>GHC.Core.Opt.WorkWrap, even an INLINABLE function may end up with
<a name="line-858"></a>a wrapper that has no pragma, just an unfolding (#19246).  So now
<a name="line-859"></a>we just test whether the function has an unfolding.
<a name="line-860"></a>
<a name="line-861"></a>There's a risk that a pragma-free function may have an unfolding now
<a name="line-862"></a>(because it is fairly small), and then gets a bit bigger, and no
<a name="line-863"></a>longer has an unfolding in the future.  But then you'll get a helpful
<a name="line-864"></a>error message suggesting an INLINABLE pragma, which you can follow.
<a name="line-865"></a>That seems enough for now.
<a name="line-866"></a>-}</span>
</pre></body>
</html>
