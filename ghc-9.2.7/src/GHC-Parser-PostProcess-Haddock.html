<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Parser/PostProcess/Haddock.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE ApplicativeDo              #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE DeriveFunctor              #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE DerivingVia                #-}</span>
<a name="line-4"></a><span class='hs-comment'>{-# LANGUAGE FlexibleInstances          #-}</span>
<a name="line-5"></a><span class='hs-comment'>{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span>
<a name="line-6"></a><span class='hs-comment'>{-# LANGUAGE NamedFieldPuns             #-}</span>
<a name="line-7"></a><span class='hs-comment'>{-# LANGUAGE RankNTypes                 #-}</span>
<a name="line-8"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables        #-}</span>
<a name="line-9"></a><span class='hs-comment'>{-# LANGUAGE TypeApplications           #-}</span>
<a name="line-10"></a><span class='hs-comment'>{-# LANGUAGE TypeFamilies               #-}</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-comment'>{- | This module implements 'addHaddockToModule', which inserts Haddock
<a name="line-13"></a>    comments accumulated during parsing into the AST (#17544).
<a name="line-14"></a>
<a name="line-15"></a>We process Haddock comments in two phases:
<a name="line-16"></a>
<a name="line-17"></a>1. Parse the program (via the Happy parser in `Parser.y`), generating
<a name="line-18"></a>   an AST, and (quite separately) a list of all the Haddock comments
<a name="line-19"></a>   found in the file. More precisely, the Haddock comments are
<a name="line-20"></a>   accumulated in the `hdk_comments` field of the `PState`, the parser
<a name="line-21"></a>   state (see Lexer.x):
<a name="line-22"></a>
<a name="line-23"></a>     data PState = PState { ...
<a name="line-24"></a>                          ,  hdk_comments :: [PsLocated HdkComment] }
<a name="line-25"></a>
<a name="line-26"></a>   Each of these Haddock comments has a `PsSpan`, which gives the `BufPos` of
<a name="line-27"></a>   the beginning and end of the Haddock comment.
<a name="line-28"></a>
<a name="line-29"></a>2. Walk over the AST, attaching the Haddock comments to the correct
<a name="line-30"></a>   parts of the tree. This step is called `addHaddockToModule`, and is
<a name="line-31"></a>   implemented in this module.
<a name="line-32"></a>
<a name="line-33"></a>   See Note [Adding Haddock comments to the syntax tree].
<a name="line-34"></a>
<a name="line-35"></a>This approach codifies an important principle:
<a name="line-36"></a>
<a name="line-37"></a>  The presence or absence of a Haddock comment should never change the parsing
<a name="line-38"></a>  of a program.
<a name="line-39"></a>
<a name="line-40"></a>Alternative approaches that did not work properly:
<a name="line-41"></a>
<a name="line-42"></a>1. Using 'RealSrcLoc' instead of 'BufPos'. This led to failures in presence
<a name="line-43"></a>   of {-# LANGUAGE CPP #-} and other sources of line pragmas. See documentation
<a name="line-44"></a>   on 'BufPos' (in GHC.Types.SrcLoc) for the details.
<a name="line-45"></a>
<a name="line-46"></a>2. In earlier versions of GHC, the Haddock comments were incorporated into the
<a name="line-47"></a>   Parser.y grammar. The parser constructed the AST and attached comments to it in
<a name="line-48"></a>   a single pass. See Note [Old solution: Haddock in the grammar] for the details.
<a name="line-49"></a>-}</span>
<a name="line-50"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Parser.PostProcess.Haddock</span> <span class='hs-layout'>(</span><span class='hs-varid'>addHaddockToModule</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-51"></a>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-53"></a>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Hs</span>
<a name="line-55"></a>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SrcLoc</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Flags</span> <span class='hs-layout'>(</span> <span class='hs-conid'>WarningFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Bag</span>
<a name="line-60"></a>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Semigroup</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Foldable</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Traversable</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Maybe</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad.Trans.State.Strict</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad.Trans.Reader</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad.Trans.Writer</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Functor.Identity</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Coerce</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.Monoid</span>
<a name="line-72"></a>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Parser.Lexer</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Parser.Errors</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mergeListsBy</span><span class='hs-layout'>,</span> <span class='hs-varid'>filterOut</span><span class='hs-layout'>,</span> <span class='hs-varid'>mapLastM</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;&amp;&amp;&gt;</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-76"></a>
<a name="line-77"></a><span class='hs-comment'>{- Note [Adding Haddock comments to the syntax tree]
<a name="line-78"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-79"></a>'addHaddock' traverses the AST in concrete syntax order, building a computation
<a name="line-80"></a>(represented by HdkA) that reconstructs the AST but with Haddock comments
<a name="line-81"></a>inserted in appropriate positions:
<a name="line-82"></a>
<a name="line-83"></a>  addHaddock :: HasHaddock a =&gt; a -&gt; HdkA a
<a name="line-84"></a>
<a name="line-85"></a>Consider this code example:
<a name="line-86"></a>
<a name="line-87"></a>  f :: Int  -- ^ comment on argument
<a name="line-88"></a>    -&gt; Bool -- ^ comment on result
<a name="line-89"></a>
<a name="line-90"></a>In the AST, the "Int" part of this snippet is represented like this
<a name="line-91"></a>(pseudo-code):
<a name="line-92"></a>
<a name="line-93"></a>  L (BufSpan 6 8) (HsTyVar "Int") :: LHsType GhcPs
<a name="line-94"></a>
<a name="line-95"></a>And the comments are represented like this (pseudo-code):
<a name="line-96"></a>
<a name="line-97"></a>  L (BufSpan 11 35) (HdkCommentPrev "comment on argument")
<a name="line-98"></a>  L (BufSpan 46 69) (HdkCommentPrev "comment on result")
<a name="line-99"></a>
<a name="line-100"></a>So when we are traversing the AST and 'addHaddock' is applied to HsTyVar "Int",
<a name="line-101"></a>how does it know to associate it with "comment on argument" but not with
<a name="line-102"></a>"comment on result"?
<a name="line-103"></a>
<a name="line-104"></a>The trick is to look in the space between syntactic elements. In the example above,
<a name="line-105"></a>the location range in which we search for HdkCommentPrev is as follows:
<a name="line-106"></a>
<a name="line-107"></a>  f :: Int████████████████████████
<a name="line-108"></a>   ████Bool -- ^ comment on result
<a name="line-109"></a>
<a name="line-110"></a>We search for comments after  HsTyVar "Int"  and until the next syntactic
<a name="line-111"></a>element, in this case  HsTyVar "Bool".
<a name="line-112"></a>
<a name="line-113"></a>Ignoring the "-&gt;" allows us to accommodate alternative coding styles:
<a name="line-114"></a>
<a name="line-115"></a>  f :: Int -&gt;   -- ^ comment on argument
<a name="line-116"></a>       Bool     -- ^ comment on result
<a name="line-117"></a>
<a name="line-118"></a>Sometimes we also need to take indentation information into account.
<a name="line-119"></a>Compare the following examples:
<a name="line-120"></a>
<a name="line-121"></a>    class C a where
<a name="line-122"></a>      f :: a -&gt; Int
<a name="line-123"></a>      -- ^ comment on f
<a name="line-124"></a>
<a name="line-125"></a>    class C a where
<a name="line-126"></a>      f :: a -&gt; Int
<a name="line-127"></a>    -- ^ comment on C
<a name="line-128"></a>
<a name="line-129"></a>Notice how "comment on f" and "comment on C" differ only by indentation level.
<a name="line-130"></a>
<a name="line-131"></a>Therefore, in order to know the location range in which the comments are applicable
<a name="line-132"></a>to a syntactic elements, we need three nuggets of information:
<a name="line-133"></a>  1. lower bound on the BufPos of a comment
<a name="line-134"></a>  2. upper bound on the BufPos of a comment
<a name="line-135"></a>  3. minimum indentation level of a comment
<a name="line-136"></a>
<a name="line-137"></a>This information is represented by the 'LocRange' type.
<a name="line-138"></a>
<a name="line-139"></a>In order to propagate this information, we have the 'HdkA' applicative.
<a name="line-140"></a>'HdkA' is defined as follows:
<a name="line-141"></a>
<a name="line-142"></a>  data HdkA a = HdkA (Maybe BufSpan) (HdkM a)
<a name="line-143"></a>
<a name="line-144"></a>The first field contains a 'BufSpan', which represents the location
<a name="line-145"></a>span taken by a syntactic element:
<a name="line-146"></a>
<a name="line-147"></a>  addHaddock (L bufSpan ...) = HdkA (Just bufSpan) ...
<a name="line-148"></a>
<a name="line-149"></a>The second field, 'HdkM', is a stateful computation that looks up Haddock
<a name="line-150"></a>comments in the specified location range:
<a name="line-151"></a>
<a name="line-152"></a>  HdkM a ≈
<a name="line-153"></a>       LocRange                  -- The allowed location range
<a name="line-154"></a>    -&gt; [PsLocated HdkComment]    -- Unallocated comments
<a name="line-155"></a>    -&gt; (a,                       -- AST with comments inserted into it
<a name="line-156"></a>        [PsLocated HdkComment])  -- Leftover comments
<a name="line-157"></a>
<a name="line-158"></a>The 'Applicative' instance for 'HdkA' is defined in such a way that the
<a name="line-159"></a>location range of every computation is defined by its neighbours:
<a name="line-160"></a>
<a name="line-161"></a>  addHaddock aaa &lt;*&gt; addHaddock bbb &lt;*&gt; addHaddock ccc
<a name="line-162"></a>
<a name="line-163"></a>Here, the 'LocRange' passed to the 'HdkM' computation of  addHaddock bbb
<a name="line-164"></a>is determined by the BufSpan recorded in  addHaddock aaa  and  addHaddock ccc.
<a name="line-165"></a>
<a name="line-166"></a>This is why it's important to traverse the AST in the order of the concrete
<a name="line-167"></a>syntax. In the example above we assume that  aaa, bbb, ccc  are ordered by location:
<a name="line-168"></a>
<a name="line-169"></a>  * getBufSpan (getLoc aaa) &lt; getBufSpan (getLoc bbb)
<a name="line-170"></a>  * getBufSpan (getLoc bbb) &lt; getBufSpan (getLoc ccc)
<a name="line-171"></a>
<a name="line-172"></a>Violation of this assumption would lead to bugs, and care must be taken to
<a name="line-173"></a>traverse the AST correctly. For example, when dealing with class declarations,
<a name="line-174"></a>we have to use 'flattenBindsAndSigs' to traverse it in the correct order.
<a name="line-175"></a>-}</span>
<a name="line-176"></a>
<a name="line-177"></a><a name="addHaddockToModule"></a><span class='hs-comment'>-- | Add Haddock documentation accumulated in the parser state</span>
<a name="line-178"></a><span class='hs-comment'>-- to a parsed HsModule.</span>
<a name="line-179"></a><span class='hs-comment'>--</span>
<a name="line-180"></a><span class='hs-comment'>-- Reports badly positioned comments when -Winvalid-haddock is enabled.</span>
<a name="line-181"></a><span class='hs-definition'>addHaddockToModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>HsModule</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-conid'>HsModule</span><span class='hs-layout'>)</span>
<a name="line-182"></a><span class='hs-definition'>addHaddockToModule</span> <span class='hs-varid'>lmod</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-183"></a>  <span class='hs-varid'>pState</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPState</span>
<a name="line-184"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>all_comments</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toList</span> <span class='hs-layout'>(</span><span class='hs-varid'>hdk_comments</span> <span class='hs-varid'>pState</span><span class='hs-layout'>)</span>
<a name="line-185"></a>      <span class='hs-varid'>initial_hdk_st</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HdkSt</span> <span class='hs-varid'>all_comments</span> <span class='hs-conid'>[]</span>
<a name="line-186"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>lmod'</span><span class='hs-layout'>,</span> <span class='hs-varid'>final_hdk_st</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>addHaddock</span> <span class='hs-varid'>lmod</span><span class='hs-layout'>)</span> <span class='hs-varid'>initial_hdk_st</span>
<a name="line-187"></a>      <span class='hs-varid'>hdk_warnings</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectHdkWarnings</span> <span class='hs-varid'>final_hdk_st</span>
<a name="line-188"></a>        <span class='hs-comment'>-- lmod':        module with Haddock comments inserted into the AST</span>
<a name="line-189"></a>        <span class='hs-comment'>-- hdk_warnings: warnings accumulated during AST/comment processing</span>
<a name="line-190"></a>  <span class='hs-varid'>mapM_</span> <span class='hs-varid'>reportHdkWarning</span> <span class='hs-varid'>hdk_warnings</span>
<a name="line-191"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>lmod'</span>
<a name="line-192"></a>
<a name="line-193"></a><a name="reportHdkWarning"></a><span class='hs-definition'>reportHdkWarning</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HdkWarn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-conid'>()</span>
<a name="line-194"></a><span class='hs-definition'>reportHdkWarning</span> <span class='hs-layout'>(</span><span class='hs-conid'>HdkWarnInvalidComment</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-195"></a>  <span class='hs-varid'>addWarning</span> <span class='hs-conid'>Opt_WarnInvalidHaddock</span> <span class='hs-varop'>$</span> <span class='hs-conid'>PsWarnHaddockInvalidPos</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSrcSpanPs</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-196"></a><span class='hs-definition'>reportHdkWarning</span> <span class='hs-layout'>(</span><span class='hs-conid'>HdkWarnExtraComment</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-197"></a>  <span class='hs-varid'>addWarning</span> <span class='hs-conid'>Opt_WarnInvalidHaddock</span> <span class='hs-varop'>$</span> <span class='hs-conid'>PsWarnHaddockIgnoreMulti</span> <span class='hs-varid'>l</span>
<a name="line-198"></a>
<a name="line-199"></a><a name="collectHdkWarnings"></a><span class='hs-definition'>collectHdkWarnings</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HdkSt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>HdkWarn</span><span class='hs-keyglyph'>]</span>
<a name="line-200"></a><span class='hs-definition'>collectHdkWarnings</span> <span class='hs-conid'>HdkSt</span><span class='hs-layout'>{</span> <span class='hs-varid'>hdk_st_pending</span><span class='hs-layout'>,</span> <span class='hs-varid'>hdk_st_warnings</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span>
<a name="line-201"></a>  <span class='hs-varid'>map</span> <span class='hs-conid'>HdkWarnInvalidComment</span> <span class='hs-varid'>hdk_st_pending</span> <span class='hs-comment'>-- leftover Haddock comments not inserted into the AST</span>
<a name="line-202"></a>  <span class='hs-varop'>++</span> <span class='hs-varid'>hdk_st_warnings</span>
<a name="line-203"></a>
<a name="line-204"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-205"></a>*                                                                      *
<a name="line-206"></a>*       addHaddock: a family of functions that processes the AST       *
<a name="line-207"></a>*    in concrete syntax order, adding documentation comments to it     *
<a name="line-208"></a>*                                                                      *
<a name="line-209"></a>********************************************************************* -}</span>
<a name="line-210"></a>
<a name="line-211"></a><a name="HasHaddock"></a><span class='hs-comment'>-- HasHaddock is a convenience class for overloading the addHaddock operation.</span>
<a name="line-212"></a><a name="HasHaddock"></a><span class='hs-comment'>-- Alternatively, we could define a family of monomorphic functions:</span>
<a name="line-213"></a><a name="HasHaddock"></a><span class='hs-comment'>--</span>
<a name="line-214"></a><a name="HasHaddock"></a><span class='hs-comment'>--    addHaddockSomeTypeX    :: SomeTypeX    -&gt; HdkA SomeTypeX</span>
<a name="line-215"></a><a name="HasHaddock"></a><span class='hs-comment'>--    addHaddockAnotherTypeY :: AnotherTypeY -&gt; HdkA AnotherTypeY</span>
<a name="line-216"></a><a name="HasHaddock"></a><span class='hs-comment'>--    addHaddockOneMoreTypeZ :: OneMoreTypeZ -&gt; HdkA OneMoreTypeZ</span>
<a name="line-217"></a><a name="HasHaddock"></a><span class='hs-comment'>--</span>
<a name="line-218"></a><a name="HasHaddock"></a><span class='hs-comment'>-- But having a single name for all of them is just easier to read, and makes it clear</span>
<a name="line-219"></a><a name="HasHaddock"></a><span class='hs-comment'>-- that they all are of the form  t -&gt; HdkA t  for some t.</span>
<a name="line-220"></a><a name="HasHaddock"></a><span class='hs-comment'>--</span>
<a name="line-221"></a><a name="HasHaddock"></a><span class='hs-comment'>-- If you need to handle a more complicated scenario that doesn't fit this</span>
<a name="line-222"></a><a name="HasHaddock"></a><span class='hs-comment'>-- pattern, it's always possible to define separate functions outside of this</span>
<a name="line-223"></a><a name="HasHaddock"></a><span class='hs-comment'>-- class, as is done in case of e.g. addHaddockConDeclField.</span>
<a name="line-224"></a><a name="HasHaddock"></a><span class='hs-comment'>--</span>
<a name="line-225"></a><a name="HasHaddock"></a><span class='hs-comment'>-- See Note [Adding Haddock comments to the syntax tree].</span>
<a name="line-226"></a><a name="HasHaddock"></a><span class='hs-keyword'>class</span> <span class='hs-conid'>HasHaddock</span> <span class='hs-varid'>a</span> <span class='hs-keyword'>where</span>
<a name="line-227"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkA</span> <span class='hs-varid'>a</span>
<a name="line-228"></a>
<a name="line-229"></a><a name="instance%20HasHaddock%20%5ba%5d"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasHaddock</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HasHaddock</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>where</span>
<a name="line-230"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>traverse</span> <span class='hs-varid'>addHaddock</span>
<a name="line-231"></a>
<a name="line-232"></a><a name="instance%20HasHaddock%20(Located%20HsModule)"></a><span class='hs-comment'>--    -- | Module header comment</span>
<a name="line-233"></a><a name="instance%20HasHaddock%20(Located%20HsModule)"></a><span class='hs-comment'>--    module M (</span>
<a name="line-234"></a><a name="instance%20HasHaddock%20(Located%20HsModule)"></a><span class='hs-comment'>--        -- * Export list comment</span>
<a name="line-235"></a><a name="instance%20HasHaddock%20(Located%20HsModule)"></a><span class='hs-comment'>--        Item1,</span>
<a name="line-236"></a><a name="instance%20HasHaddock%20(Located%20HsModule)"></a><span class='hs-comment'>--        Item2,</span>
<a name="line-237"></a><a name="instance%20HasHaddock%20(Located%20HsModule)"></a><span class='hs-comment'>--        -- * Export list comment</span>
<a name="line-238"></a><a name="instance%20HasHaddock%20(Located%20HsModule)"></a><span class='hs-comment'>--        item3,</span>
<a name="line-239"></a><a name="instance%20HasHaddock%20(Located%20HsModule)"></a><span class='hs-comment'>--        item4</span>
<a name="line-240"></a><a name="instance%20HasHaddock%20(Located%20HsModule)"></a><span class='hs-comment'>--      ) where</span>
<a name="line-241"></a><a name="instance%20HasHaddock%20(Located%20HsModule)"></a><span class='hs-comment'>--</span>
<a name="line-242"></a><a name="instance%20HasHaddock%20(Located%20HsModule)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-conid'>HsModule</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-243"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l_mod</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-244"></a>    <span class='hs-comment'>-- Step 1, get the module header documentation comment:</span>
<a name="line-245"></a>    <span class='hs-comment'>--</span>
<a name="line-246"></a>    <span class='hs-comment'>--    -- | Module header comment</span>
<a name="line-247"></a>    <span class='hs-comment'>--    module M where</span>
<a name="line-248"></a>    <span class='hs-comment'>--</span>
<a name="line-249"></a>    <span class='hs-comment'>-- Only do this when the module header exists.</span>
<a name="line-250"></a>    <span class='hs-varid'>headerDocs</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-251"></a>      <span class='hs-varid'>for</span> <span class='hs-keyglyph'>@</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsmodName</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l_name</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-252"></a>      <span class='hs-varid'>extendHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>l_name</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liftHdkA</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-253"></a>        <span class='hs-comment'>-- todo: register keyword location of 'module', see Note [Register keyword location]</span>
<a name="line-254"></a>        <span class='hs-varid'>docs</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-255"></a>          <span class='hs-varid'>inLocRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>locRangeTo</span> <span class='hs-layout'>(</span><span class='hs-varid'>getBufPos</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcSpanStart</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>l_name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-256"></a>          <span class='hs-varid'>takeHdkComments</span> <span class='hs-varid'>mkDocNext</span>
<a name="line-257"></a>        <span class='hs-varid'>selectDocString</span> <span class='hs-varid'>docs</span>
<a name="line-258"></a>
<a name="line-259"></a>    <span class='hs-comment'>-- Step 2, process documentation comments in the export list:</span>
<a name="line-260"></a>    <span class='hs-comment'>--</span>
<a name="line-261"></a>    <span class='hs-comment'>--  module M (</span>
<a name="line-262"></a>    <span class='hs-comment'>--        -- * Export list comment</span>
<a name="line-263"></a>    <span class='hs-comment'>--        Item1,</span>
<a name="line-264"></a>    <span class='hs-comment'>--        Item2,</span>
<a name="line-265"></a>    <span class='hs-comment'>--        -- * Export list comment</span>
<a name="line-266"></a>    <span class='hs-comment'>--        item3,</span>
<a name="line-267"></a>    <span class='hs-comment'>--        item4</span>
<a name="line-268"></a>    <span class='hs-comment'>--    ) where</span>
<a name="line-269"></a>    <span class='hs-comment'>--</span>
<a name="line-270"></a>    <span class='hs-comment'>-- Only do this when the export list exists.</span>
<a name="line-271"></a>    <span class='hs-varid'>hsmodExports'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>traverse</span> <span class='hs-keyglyph'>@</span><span class='hs-conid'>Maybe</span> <span class='hs-varid'>addHaddock</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsmodExports</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-272"></a>
<a name="line-273"></a>    <span class='hs-comment'>-- Step 3, register the import section to reject invalid comments:</span>
<a name="line-274"></a>    <span class='hs-comment'>--</span>
<a name="line-275"></a>    <span class='hs-comment'>--   import Data.Maybe</span>
<a name="line-276"></a>    <span class='hs-comment'>--   -- | rejected comment (cannot appear here)</span>
<a name="line-277"></a>    <span class='hs-comment'>--   import Data.Bool</span>
<a name="line-278"></a>    <span class='hs-comment'>--</span>
<a name="line-279"></a>    <span class='hs-varid'>traverse_</span> <span class='hs-varid'>registerHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsmodImports</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-280"></a>
<a name="line-281"></a>    <span class='hs-comment'>-- Step 4, process declarations:</span>
<a name="line-282"></a>    <span class='hs-comment'>--</span>
<a name="line-283"></a>    <span class='hs-comment'>--    module M where</span>
<a name="line-284"></a>    <span class='hs-comment'>--      -- | Comment on D</span>
<a name="line-285"></a>    <span class='hs-comment'>--      data D = MkD  -- ^ Comment on MkD</span>
<a name="line-286"></a>    <span class='hs-comment'>--      data C = MkC  -- ^ Comment on MkC</span>
<a name="line-287"></a>    <span class='hs-comment'>--      -- ^ Comment on C</span>
<a name="line-288"></a>    <span class='hs-comment'>--</span>
<a name="line-289"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>layout_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsmodLayout</span> <span class='hs-varid'>mod</span>
<a name="line-290"></a>    <span class='hs-varid'>hsmodDecls'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHaddockInterleaveItems</span> <span class='hs-varid'>layout_info</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkDocHsDecl</span> <span class='hs-varid'>layout_info</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsmodDecls</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-291"></a>
<a name="line-292"></a>    <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l_mod</span> <span class='hs-varop'>$</span>
<a name="line-293"></a>      <span class='hs-varid'>mod</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsmodExports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsmodExports'</span>
<a name="line-294"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>hsmodDecls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsmodDecls'</span>
<a name="line-295"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>hsmodHaddockModHeader</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>join</span> <span class='hs-keyglyph'>@</span><span class='hs-conid'>Maybe</span> <span class='hs-varid'>headerDocs</span> <span class='hs-layout'>}</span>
<a name="line-296"></a>
<a name="line-297"></a><a name="instance%20HasHaddock%20(LocatedL%20%5bLocatedA%20(IE%20GhcPs)%5d)"></a><span class='hs-comment'>-- Only for module exports, not module imports.</span>
<a name="line-298"></a><a name="instance%20HasHaddock%20(LocatedL%20%5bLocatedA%20(IE%20GhcPs)%5d)"></a><span class='hs-comment'>--</span>
<a name="line-299"></a><a name="instance%20HasHaddock%20(LocatedL%20%5bLocatedA%20(IE%20GhcPs)%5d)"></a><span class='hs-comment'>--    module M (a, b, c) where   -- use on this [LIE GhcPs]</span>
<a name="line-300"></a><a name="instance%20HasHaddock%20(LocatedL%20%5bLocatedA%20(IE%20GhcPs)%5d)"></a><span class='hs-comment'>--    import I (a, b, c)         -- do not use here!</span>
<a name="line-301"></a><a name="instance%20HasHaddock%20(LocatedL%20%5bLocatedA%20(IE%20GhcPs)%5d)"></a><span class='hs-comment'>--</span>
<a name="line-302"></a><a name="instance%20HasHaddock%20(LocatedL%20%5bLocatedA%20(IE%20GhcPs)%5d)"></a><span class='hs-comment'>-- Imports cannot have documentation comments anyway.</span>
<a name="line-303"></a><a name="instance%20HasHaddock%20(LocatedL%20%5bLocatedA%20(IE%20GhcPs)%5d)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedL</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-conid'>IE</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-304"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l_exports</span> <span class='hs-varid'>exports</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-305"></a>    <span class='hs-varid'>extendHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>l_exports</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-306"></a>      <span class='hs-varid'>exports'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHaddockInterleaveItems</span> <span class='hs-conid'>NoLayoutInfo</span> <span class='hs-varid'>mkDocIE</span> <span class='hs-varid'>exports</span>
<a name="line-307"></a>      <span class='hs-varid'>registerLocHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcLocSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcSpanEnd</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>l_exports</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Do not consume comments after the closing parenthesis</span>
<a name="line-308"></a>      <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l_exports</span> <span class='hs-varid'>exports'</span>
<a name="line-309"></a>
<a name="line-310"></a><a name="instance%20HasHaddock%20(LocatedA%20(IE%20GhcPs))"></a><span class='hs-comment'>-- Needed to use 'addHaddockInterleaveItems' in 'instance HasHaddock (Located [LIE GhcPs])'.</span>
<a name="line-311"></a><a name="instance%20HasHaddock%20(LocatedA%20(IE%20GhcPs))"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-conid'>IE</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-312"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>&lt;$</span> <span class='hs-varid'>registerHdkA</span> <span class='hs-varid'>a</span>
<a name="line-313"></a>
<a name="line-314"></a><a name="addHaddockInterleaveItems"></a><span class='hs-comment'>{- Add Haddock items to a list of non-Haddock items.
<a name="line-315"></a>Used to process export lists (with mkDocIE) and declarations (with mkDocHsDecl).
<a name="line-316"></a>
<a name="line-317"></a>For example:
<a name="line-318"></a>
<a name="line-319"></a>  module M where
<a name="line-320"></a>    -- | Comment on D
<a name="line-321"></a>    data D = MkD  -- ^ Comment on MkD
<a name="line-322"></a>    data C = MkC  -- ^ Comment on MkC
<a name="line-323"></a>    -- ^ Comment on C
<a name="line-324"></a>
<a name="line-325"></a>In this case, we should produce four HsDecl items (pseudo-code):
<a name="line-326"></a>
<a name="line-327"></a>  1. DocD (DocCommentNext "Comment on D")
<a name="line-328"></a>  2. TyClD (DataDecl "D" ... [ConDeclH98 "MkD" ... (Just "Comment on MkD")])
<a name="line-329"></a>  3. TyClD (DataDecl "C" ... [ConDeclH98 "MkC" ... (Just "Comment on MkC")])
<a name="line-330"></a>  4. DocD (DocCommentPrev "Comment on C")
<a name="line-331"></a>
<a name="line-332"></a>The inputs to addHaddockInterleaveItems are:
<a name="line-333"></a>
<a name="line-334"></a>  * layout_info :: LayoutInfo
<a name="line-335"></a>
<a name="line-336"></a>    In the example above, note that the indentation level inside the module is
<a name="line-337"></a>    2 spaces. It would be represented as layout_info = VirtualBraces 2.
<a name="line-338"></a>
<a name="line-339"></a>    It is used to delimit the search space for comments when processing
<a name="line-340"></a>    declarations. Here, we restrict indentation levels to &gt;=(2+1), so that when
<a name="line-341"></a>    we look up comment on MkC, we get "Comment on MkC" but not "Comment on C".
<a name="line-342"></a>
<a name="line-343"></a>  * get_doc_item :: PsLocated HdkComment -&gt; Maybe a
<a name="line-344"></a>
<a name="line-345"></a>    This is the function used to look up documentation comments.
<a name="line-346"></a>    In the above example, get_doc_item = mkDocHsDecl layout_info,
<a name="line-347"></a>    and it will produce the following parts of the output:
<a name="line-348"></a>
<a name="line-349"></a>      DocD (DocCommentNext "Comment on D")
<a name="line-350"></a>      DocD (DocCommentPrev "Comment on C")
<a name="line-351"></a>
<a name="line-352"></a>  * The list of items. These are the declarations that will be annotated with
<a name="line-353"></a>    documentation comments.
<a name="line-354"></a>
<a name="line-355"></a>    Before processing:
<a name="line-356"></a>       TyClD (DataDecl "D" ... [ConDeclH98 "MkD" ... Nothing])
<a name="line-357"></a>       TyClD (DataDecl "C" ... [ConDeclH98 "MkC" ... Nothing])
<a name="line-358"></a>
<a name="line-359"></a>    After processing:
<a name="line-360"></a>       TyClD (DataDecl "D" ... [ConDeclH98 "MkD" ... (Just "Comment on MkD")])
<a name="line-361"></a>       TyClD (DataDecl "C" ... [ConDeclH98 "MkC" ... (Just "Comment on MkC")])
<a name="line-362"></a>-}</span>
<a name="line-363"></a><span class='hs-definition'>addHaddockInterleaveItems</span>
<a name="line-364"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span><span class='hs-varop'>.</span>
<a name="line-365"></a>     <span class='hs-conid'>HasHaddock</span> <span class='hs-varid'>a</span>
<a name="line-366"></a>  <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>LayoutInfo</span>
<a name="line-367"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>PsLocated</span> <span class='hs-conid'>HdkComment</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Get a documentation item</span>
<a name="line-368"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>           <span class='hs-comment'>-- Unprocessed (non-documentation) items</span>
<a name="line-369"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkA</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- Documentation items &amp; processed non-documentation items</span>
<a name="line-370"></a><span class='hs-definition'>addHaddockInterleaveItems</span> <span class='hs-varid'>layout_info</span> <span class='hs-varid'>get_doc_item</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span>
<a name="line-371"></a>  <span class='hs-keyword'>where</span>
<a name="line-372"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkA</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-373"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>takeHdkComments</span> <span class='hs-varid'>get_doc_item</span><span class='hs-layout'>)</span>
<a name="line-374"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>item</span> <span class='hs-conop'>:</span> <span class='hs-varid'>items</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-375"></a>      <span class='hs-varid'>docItems</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>takeHdkComments</span> <span class='hs-varid'>get_doc_item</span><span class='hs-layout'>)</span>
<a name="line-376"></a>      <span class='hs-varid'>item'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>with_layout_info</span> <span class='hs-layout'>(</span><span class='hs-varid'>addHaddock</span> <span class='hs-varid'>item</span><span class='hs-layout'>)</span>
<a name="line-377"></a>      <span class='hs-varid'>other_items</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>items</span>
<a name="line-378"></a>      <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-varid'>docItems</span> <span class='hs-varop'>++</span> <span class='hs-varid'>item'</span><span class='hs-conop'>:</span><span class='hs-varid'>other_items</span>
<a name="line-379"></a>
<a name="line-380"></a>    <span class='hs-varid'>with_layout_info</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HdkA</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkA</span> <span class='hs-varid'>a</span>
<a name="line-381"></a>    <span class='hs-varid'>with_layout_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>layout_info</span> <span class='hs-keyword'>of</span>
<a name="line-382"></a>      <span class='hs-conid'>NoLayoutInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>id</span>
<a name="line-383"></a>      <span class='hs-conid'>ExplicitBraces</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>id</span>
<a name="line-384"></a>      <span class='hs-conid'>VirtualBraces</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-385"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>loc_range</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mempty</span> <span class='hs-layout'>{</span> <span class='hs-varid'>loc_range_col</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ColumnFrom</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-386"></a>        <span class='hs-keyword'>in</span> <span class='hs-varid'>hoistHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>inLocRange</span> <span class='hs-varid'>loc_range</span><span class='hs-layout'>)</span>
<a name="line-387"></a>
<a name="line-388"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsDecl%20GhcPs))"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDecl</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-389"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>ldecl</span> <span class='hs-keyglyph'>=</span>
<a name="line-390"></a>    <span class='hs-varid'>extendHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLocA</span> <span class='hs-varid'>ldecl</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-391"></a>    <span class='hs-varid'>traverse</span> <span class='hs-keyglyph'>@</span><span class='hs-conid'>LocatedA</span> <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>ldecl</span>
<a name="line-392"></a>
<a name="line-393"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>-- Process documentation comments *inside* a declaration, for example:</span>
<a name="line-394"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>--</span>
<a name="line-395"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>--    data T = MkT -- ^ Comment on MkT (inside DataDecl)</span>
<a name="line-396"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>--    f, g</span>
<a name="line-397"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>--      :: Int  -- ^ Comment on Int   (inside TypeSig)</span>
<a name="line-398"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>--      -&gt; Bool -- ^ Comment on Bool  (inside TypeSig)</span>
<a name="line-399"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>--</span>
<a name="line-400"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>-- Comments that relate to the entire declaration are processed elsewhere:</span>
<a name="line-401"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>--</span>
<a name="line-402"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>--    -- | Comment on T (not processed in this instance)</span>
<a name="line-403"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>--    data T = MkT</span>
<a name="line-404"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>--</span>
<a name="line-405"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>--    -- | Comment on f, g (not processed in this instance)</span>
<a name="line-406"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>--    f, g :: Int -&gt; Bool</span>
<a name="line-407"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>--    f = ...</span>
<a name="line-408"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>--    g = ...</span>
<a name="line-409"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>--</span>
<a name="line-410"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>-- Such comments are inserted into the syntax tree as DocD declarations</span>
<a name="line-411"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>-- by addHaddockInterleaveItems, and then associated with other declarations</span>
<a name="line-412"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>-- in GHC.HsToCore.Docs (see DeclDocMap).</span>
<a name="line-413"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>--</span>
<a name="line-414"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>-- In this instance, we only process comments that relate to parts of the</span>
<a name="line-415"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-comment'>-- declaration, not to the declaration itself.</span>
<a name="line-416"></a><a name="instance%20HasHaddock%20(HsDecl%20GhcPs)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDecl</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-417"></a>
<a name="line-418"></a>  <span class='hs-comment'>-- Type signatures:</span>
<a name="line-419"></a>  <span class='hs-comment'>--</span>
<a name="line-420"></a>  <span class='hs-comment'>--    f, g</span>
<a name="line-421"></a>  <span class='hs-comment'>--      :: Int  -- ^ Comment on Int</span>
<a name="line-422"></a>  <span class='hs-comment'>--      -&gt; Bool -- ^ Comment on Bool</span>
<a name="line-423"></a>  <span class='hs-comment'>--</span>
<a name="line-424"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigD</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-varid'>x</span> <span class='hs-varid'>names</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-425"></a>      <span class='hs-varid'>traverse_</span> <span class='hs-varid'>registerHdkA</span> <span class='hs-varid'>names</span>
<a name="line-426"></a>      <span class='hs-varid'>t'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>t</span>
<a name="line-427"></a>      <span class='hs-varid'>pure</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigD</span> <span class='hs-varid'>noExtField</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-varid'>x</span> <span class='hs-varid'>names</span> <span class='hs-varid'>t'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-428"></a>
<a name="line-429"></a>  <span class='hs-comment'>-- Pattern synonym type signatures:</span>
<a name="line-430"></a>  <span class='hs-comment'>--</span>
<a name="line-431"></a>  <span class='hs-comment'>--    pattern MyPat</span>
<a name="line-432"></a>  <span class='hs-comment'>--      :: Bool       -- ^ Comment on Bool</span>
<a name="line-433"></a>  <span class='hs-comment'>--      -&gt; Maybe Bool -- ^ Comment on Maybe Bool</span>
<a name="line-434"></a>  <span class='hs-comment'>--</span>
<a name="line-435"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigD</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynSig</span> <span class='hs-varid'>x</span> <span class='hs-varid'>names</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-436"></a>    <span class='hs-varid'>traverse_</span> <span class='hs-varid'>registerHdkA</span> <span class='hs-varid'>names</span>
<a name="line-437"></a>    <span class='hs-varid'>t'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>t</span>
<a name="line-438"></a>    <span class='hs-varid'>pure</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigD</span> <span class='hs-varid'>noExtField</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynSig</span> <span class='hs-varid'>x</span> <span class='hs-varid'>names</span> <span class='hs-varid'>t'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-439"></a>
<a name="line-440"></a>  <span class='hs-comment'>-- Class method signatures and default signatures:</span>
<a name="line-441"></a>  <span class='hs-comment'>--</span>
<a name="line-442"></a>  <span class='hs-comment'>--   class C x where</span>
<a name="line-443"></a>  <span class='hs-comment'>--      method_of_c</span>
<a name="line-444"></a>  <span class='hs-comment'>--        :: Maybe x -- ^ Comment on Maybe x</span>
<a name="line-445"></a>  <span class='hs-comment'>--        -&gt; IO ()   -- ^ Comment on IO ()</span>
<a name="line-446"></a>  <span class='hs-comment'>--      default method_of_c</span>
<a name="line-447"></a>  <span class='hs-comment'>--        :: Eq x</span>
<a name="line-448"></a>  <span class='hs-comment'>--        =&gt; Maybe x -- ^ Comment on Maybe x</span>
<a name="line-449"></a>  <span class='hs-comment'>--        -&gt; IO ()   -- ^ Comment on IO ()</span>
<a name="line-450"></a>  <span class='hs-comment'>--</span>
<a name="line-451"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigD</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassOpSig</span> <span class='hs-varid'>x</span> <span class='hs-varid'>is_dflt</span> <span class='hs-varid'>names</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-452"></a>    <span class='hs-varid'>traverse_</span> <span class='hs-varid'>registerHdkA</span> <span class='hs-varid'>names</span>
<a name="line-453"></a>    <span class='hs-varid'>t'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>t</span>
<a name="line-454"></a>    <span class='hs-varid'>pure</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigD</span> <span class='hs-varid'>noExtField</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassOpSig</span> <span class='hs-varid'>x</span> <span class='hs-varid'>is_dflt</span> <span class='hs-varid'>names</span> <span class='hs-varid'>t'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-455"></a>
<a name="line-456"></a>  <span class='hs-comment'>-- Data/newtype declarations:</span>
<a name="line-457"></a>  <span class='hs-comment'>--</span>
<a name="line-458"></a>  <span class='hs-comment'>--   data T = MkT -- ^ Comment on MkT</span>
<a name="line-459"></a>  <span class='hs-comment'>--            A   -- ^ Comment on A</span>
<a name="line-460"></a>  <span class='hs-comment'>--            B   -- ^ Comment on B</span>
<a name="line-461"></a>  <span class='hs-comment'>--</span>
<a name="line-462"></a>  <span class='hs-comment'>--   data G where</span>
<a name="line-463"></a>  <span class='hs-comment'>--     -- | Comment on MkG</span>
<a name="line-464"></a>  <span class='hs-comment'>--     MkG :: A    -- ^ Comment on A</span>
<a name="line-465"></a>  <span class='hs-comment'>--         -&gt; B    -- ^ Comment on B</span>
<a name="line-466"></a>  <span class='hs-comment'>--         -&gt; G</span>
<a name="line-467"></a>  <span class='hs-comment'>--</span>
<a name="line-468"></a>  <span class='hs-comment'>--   newtype N = MkN { getN :: Natural }  -- ^ Comment on N</span>
<a name="line-469"></a>  <span class='hs-comment'>--     deriving newtype (Eq  {- ^ Comment on Eq  N -})</span>
<a name="line-470"></a>  <span class='hs-comment'>--     deriving newtype (Ord {- ^ Comment on Ord N -})</span>
<a name="line-471"></a>  <span class='hs-comment'>--</span>
<a name="line-472"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyClD</span> <span class='hs-varid'>x</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-473"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DataDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdDExt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdLName</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdFixity</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdDataDefn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defn</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>decl</span>
<a name="line-474"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-475"></a>        <span class='hs-varid'>registerHdkA</span> <span class='hs-varid'>tcdLName</span>
<a name="line-476"></a>        <span class='hs-varid'>defn'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>defn</span>
<a name="line-477"></a>        <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span>
<a name="line-478"></a>          <span class='hs-conid'>TyClD</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataDecl</span> <span class='hs-layout'>{</span>
<a name="line-479"></a>            <span class='hs-varid'>tcdDExt</span><span class='hs-layout'>,</span>
<a name="line-480"></a>            <span class='hs-varid'>tcdLName</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdFixity</span><span class='hs-layout'>,</span>
<a name="line-481"></a>            <span class='hs-varid'>tcdDataDefn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defn'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-482"></a>
<a name="line-483"></a>  <span class='hs-comment'>-- Class declarations:</span>
<a name="line-484"></a>  <span class='hs-comment'>--</span>
<a name="line-485"></a>  <span class='hs-comment'>--  class C a where</span>
<a name="line-486"></a>  <span class='hs-comment'>--      -- | Comment on the first method</span>
<a name="line-487"></a>  <span class='hs-comment'>--      first_method :: a -&gt; Bool</span>
<a name="line-488"></a>  <span class='hs-comment'>--      second_method :: a -&gt; String</span>
<a name="line-489"></a>  <span class='hs-comment'>--      -- ^ Comment on the second method</span>
<a name="line-490"></a>  <span class='hs-comment'>--</span>
<a name="line-491"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyClD</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-492"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ClassDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdCExt</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-conid'>NoAnnSortKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdLayout</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-493"></a>                  <span class='hs-varid'>tcdCtxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdLName</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdFixity</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdFDs</span><span class='hs-layout'>,</span>
<a name="line-494"></a>                  <span class='hs-varid'>tcdSigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdMeths</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdATs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdATDefs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>decl</span>
<a name="line-495"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-496"></a>        <span class='hs-varid'>registerHdkA</span> <span class='hs-varid'>tcdLName</span>
<a name="line-497"></a>        <span class='hs-comment'>-- todo: register keyword location of 'where', see Note [Register keyword location]</span>
<a name="line-498"></a>        <span class='hs-varid'>where_cls'</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-499"></a>          <span class='hs-varid'>addHaddockInterleaveItems</span> <span class='hs-varid'>tcdLayout</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkDocHsDecl</span> <span class='hs-varid'>tcdLayout</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-500"></a>          <span class='hs-varid'>flattenBindsAndSigs</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcdMeths</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdSigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdATs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdATDefs</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-501"></a>        <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span>
<a name="line-502"></a>          <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcdMeths'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdSigs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdATs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdATDefs'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdDocs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionBindsAndSigs</span> <span class='hs-varid'>where_cls'</span>
<a name="line-503"></a>              <span class='hs-varid'>decl'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ClassDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdCExt</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-conid'>NoAnnSortKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdLayout</span><span class='hs-layout'>)</span>
<a name="line-504"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>tcdCtxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdLName</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdFixity</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdFDs</span>
<a name="line-505"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>tcdSigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcdSigs'</span>
<a name="line-506"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>tcdMeths</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcdMeths'</span>
<a name="line-507"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>tcdATs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcdATs'</span>
<a name="line-508"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>tcdATDefs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcdATDefs'</span>
<a name="line-509"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>tcdDocs</span> <span class='hs-layout'>}</span>
<a name="line-510"></a>          <span class='hs-keyword'>in</span> <span class='hs-conid'>TyClD</span> <span class='hs-varid'>noExtField</span> <span class='hs-varid'>decl'</span>
<a name="line-511"></a>
<a name="line-512"></a>  <span class='hs-comment'>-- Data family instances:</span>
<a name="line-513"></a>  <span class='hs-comment'>--</span>
<a name="line-514"></a>  <span class='hs-comment'>--    data instance D Bool where ... (same as data/newtype declarations)</span>
<a name="line-515"></a>  <span class='hs-comment'>--    data instance D Bool = ...     (same as data/newtype declarations)</span>
<a name="line-516"></a>  <span class='hs-comment'>--</span>
<a name="line-517"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstD</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-518"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DataFamInstD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dfid_ext</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfid_inst</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>decl</span>
<a name="line-519"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>DataFamInstDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dfid_eqn</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dfid_inst</span>
<a name="line-520"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-521"></a>      <span class='hs-varid'>dfid_eqn'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>dfid_eqn</span> <span class='hs-keyword'>of</span>
<a name="line-522"></a>        <span class='hs-conid'>FamEqn</span> <span class='hs-layout'>{</span> <span class='hs-varid'>feqn_ext</span><span class='hs-layout'>,</span> <span class='hs-varid'>feqn_tycon</span><span class='hs-layout'>,</span> <span class='hs-varid'>feqn_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>feqn_pats</span><span class='hs-layout'>,</span> <span class='hs-varid'>feqn_fixity</span><span class='hs-layout'>,</span> <span class='hs-varid'>feqn_rhs</span> <span class='hs-layout'>}</span>
<a name="line-523"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-524"></a>            <span class='hs-varid'>registerHdkA</span> <span class='hs-varid'>feqn_tycon</span>
<a name="line-525"></a>            <span class='hs-varid'>feqn_rhs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>feqn_rhs</span>
<a name="line-526"></a>            <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-conid'>FamEqn</span> <span class='hs-layout'>{</span>
<a name="line-527"></a>                <span class='hs-varid'>feqn_ext</span><span class='hs-layout'>,</span>
<a name="line-528"></a>                <span class='hs-varid'>feqn_tycon</span><span class='hs-layout'>,</span> <span class='hs-varid'>feqn_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>feqn_pats</span><span class='hs-layout'>,</span> <span class='hs-varid'>feqn_fixity</span><span class='hs-layout'>,</span>
<a name="line-529"></a>                <span class='hs-varid'>feqn_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>feqn_rhs'</span> <span class='hs-layout'>}</span>
<a name="line-530"></a>      <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-conid'>InstD</span> <span class='hs-varid'>noExtField</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataFamInstD</span> <span class='hs-layout'>{</span>
<a name="line-531"></a>        <span class='hs-varid'>dfid_ext</span><span class='hs-layout'>,</span>
<a name="line-532"></a>        <span class='hs-varid'>dfid_inst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DataFamInstDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dfid_eqn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dfid_eqn'</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-533"></a>
<a name="line-534"></a>  <span class='hs-comment'>-- Type synonyms:</span>
<a name="line-535"></a>  <span class='hs-comment'>--</span>
<a name="line-536"></a>  <span class='hs-comment'>--    type T = Int -- ^ Comment on Int</span>
<a name="line-537"></a>  <span class='hs-comment'>--</span>
<a name="line-538"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyClD</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-539"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SynDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdSExt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdLName</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdFixity</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdRhs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>decl</span>
<a name="line-540"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-541"></a>        <span class='hs-varid'>registerHdkA</span> <span class='hs-varid'>tcdLName</span>
<a name="line-542"></a>        <span class='hs-comment'>-- todo: register keyword location of '=', see Note [Register keyword location]</span>
<a name="line-543"></a>        <span class='hs-varid'>tcdRhs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>tcdRhs</span>
<a name="line-544"></a>        <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span>
<a name="line-545"></a>          <span class='hs-conid'>TyClD</span> <span class='hs-varid'>noExtField</span> <span class='hs-layout'>(</span><span class='hs-conid'>SynDecl</span> <span class='hs-layout'>{</span>
<a name="line-546"></a>            <span class='hs-varid'>tcdSExt</span><span class='hs-layout'>,</span>
<a name="line-547"></a>            <span class='hs-varid'>tcdLName</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdFixity</span><span class='hs-layout'>,</span>
<a name="line-548"></a>            <span class='hs-varid'>tcdRhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcdRhs'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-549"></a>
<a name="line-550"></a>  <span class='hs-comment'>-- Foreign imports:</span>
<a name="line-551"></a>  <span class='hs-comment'>--</span>
<a name="line-552"></a>  <span class='hs-comment'>--    foreign import ccall unsafe</span>
<a name="line-553"></a>  <span class='hs-comment'>--      o :: Float     -- ^ The input float</span>
<a name="line-554"></a>  <span class='hs-comment'>--        -&gt; IO Float  -- ^ The output float</span>
<a name="line-555"></a>  <span class='hs-comment'>--</span>
<a name="line-556"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForD</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-557"></a>    <span class='hs-varid'>registerHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>fd_name</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-558"></a>    <span class='hs-varid'>fd_sig_ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHaddock</span> <span class='hs-layout'>(</span><span class='hs-varid'>fd_sig_ty</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-559"></a>    <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ForD</span> <span class='hs-varid'>noExtField</span> <span class='hs-layout'>(</span><span class='hs-varid'>decl</span><span class='hs-layout'>{</span> <span class='hs-varid'>fd_sig_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fd_sig_ty'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-560"></a>
<a name="line-561"></a>  <span class='hs-comment'>-- Other declarations</span>
<a name="line-562"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>d</span>
<a name="line-563"></a>
<a name="line-564"></a><a name="instance%20HasHaddock%20(HsDataDefn%20GhcPs)"></a><span class='hs-comment'>-- The right-hand side of a data/newtype declaration or data family instance.</span>
<a name="line-565"></a><a name="instance%20HasHaddock%20(HsDataDefn%20GhcPs)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDataDefn</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-566"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>defn</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>HsDataDefn</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-567"></a>
<a name="line-568"></a>    <span class='hs-comment'>-- Register the kind signature:</span>
<a name="line-569"></a>    <span class='hs-comment'>--    data D :: Type -&gt; Type        where ...</span>
<a name="line-570"></a>    <span class='hs-comment'>--    data instance D Bool :: Type  where ...</span>
<a name="line-571"></a>    <span class='hs-varid'>traverse_</span> <span class='hs-keyglyph'>@</span><span class='hs-conid'>Maybe</span> <span class='hs-varid'>registerHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>dd_kindSig</span> <span class='hs-varid'>defn</span><span class='hs-layout'>)</span>
<a name="line-572"></a>    <span class='hs-comment'>-- todo: register keyword location of '=' or 'where', see Note [Register keyword location]</span>
<a name="line-573"></a>
<a name="line-574"></a>    <span class='hs-comment'>-- Process the data constructors:</span>
<a name="line-575"></a>    <span class='hs-comment'>--</span>
<a name="line-576"></a>    <span class='hs-comment'>--    data T</span>
<a name="line-577"></a>    <span class='hs-comment'>--      = MkT1 Int Bool  -- ^ Comment on MkT1</span>
<a name="line-578"></a>    <span class='hs-comment'>--      | MkT2 Char Int  -- ^ Comment on MkT2</span>
<a name="line-579"></a>    <span class='hs-comment'>--</span>
<a name="line-580"></a>    <span class='hs-varid'>dd_cons'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHaddock</span> <span class='hs-layout'>(</span><span class='hs-varid'>dd_cons</span> <span class='hs-varid'>defn</span><span class='hs-layout'>)</span>
<a name="line-581"></a>
<a name="line-582"></a>    <span class='hs-comment'>-- Process the deriving clauses:</span>
<a name="line-583"></a>    <span class='hs-comment'>--</span>
<a name="line-584"></a>    <span class='hs-comment'>--   newtype N = MkN Natural</span>
<a name="line-585"></a>    <span class='hs-comment'>--     deriving (Eq  {- ^ Comment on Eq  N -})</span>
<a name="line-586"></a>    <span class='hs-comment'>--     deriving (Ord {- ^ Comment on Ord N -})</span>
<a name="line-587"></a>    <span class='hs-comment'>--</span>
<a name="line-588"></a>    <span class='hs-varid'>dd_derivs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHaddock</span> <span class='hs-layout'>(</span><span class='hs-varid'>dd_derivs</span> <span class='hs-varid'>defn</span><span class='hs-layout'>)</span>
<a name="line-589"></a>
<a name="line-590"></a>    <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-varid'>defn</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dd_cons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dd_cons'</span><span class='hs-layout'>,</span>
<a name="line-591"></a>                  <span class='hs-varid'>dd_derivs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dd_derivs'</span> <span class='hs-layout'>}</span>
<a name="line-592"></a>
<a name="line-593"></a><a name="instance%20HasHaddock%20(Located%20%5bLocated%20(HsDerivingClause%20GhcPs)%5d)"></a><span class='hs-comment'>-- Process the deriving clauses of a data/newtype declaration.</span>
<a name="line-594"></a><a name="instance%20HasHaddock%20(Located%20%5bLocated%20(HsDerivingClause%20GhcPs)%5d)"></a><span class='hs-comment'>-- Not used for standalone deriving.</span>
<a name="line-595"></a><a name="instance%20HasHaddock%20(Located%20%5bLocated%20(HsDerivingClause%20GhcPs)%5d)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDerivingClause</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-596"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>lderivs</span> <span class='hs-keyglyph'>=</span>
<a name="line-597"></a>    <span class='hs-varid'>extendHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varid'>lderivs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-598"></a>    <span class='hs-varid'>traverse</span> <span class='hs-keyglyph'>@</span><span class='hs-conid'>Located</span> <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>lderivs</span>
<a name="line-599"></a>
<a name="line-600"></a><a name="instance%20HasHaddock%20(Located%20(HsDerivingClause%20GhcPs))"></a><span class='hs-comment'>-- Process a single deriving clause of a data/newtype declaration:</span>
<a name="line-601"></a><a name="instance%20HasHaddock%20(Located%20(HsDerivingClause%20GhcPs))"></a><span class='hs-comment'>--</span>
<a name="line-602"></a><a name="instance%20HasHaddock%20(Located%20(HsDerivingClause%20GhcPs))"></a><span class='hs-comment'>--  newtype N = MkN Natural</span>
<a name="line-603"></a><a name="instance%20HasHaddock%20(Located%20(HsDerivingClause%20GhcPs))"></a><span class='hs-comment'>--    deriving newtype (Eq  {- ^ Comment on Eq  N -})</span>
<a name="line-604"></a><a name="instance%20HasHaddock%20(Located%20(HsDerivingClause%20GhcPs))"></a><span class='hs-comment'>--    deriving (Ord {- ^ Comment on Ord N -}) via Down N</span>
<a name="line-605"></a><a name="instance%20HasHaddock%20(Located%20(HsDerivingClause%20GhcPs))"></a><span class='hs-comment'>--</span>
<a name="line-606"></a><a name="instance%20HasHaddock%20(Located%20(HsDerivingClause%20GhcPs))"></a><span class='hs-comment'>-- Not used for standalone deriving.</span>
<a name="line-607"></a><a name="instance%20HasHaddock%20(Located%20(HsDerivingClause%20GhcPs))"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDerivingClause</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-608"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>lderiv</span> <span class='hs-keyglyph'>=</span>
<a name="line-609"></a>    <span class='hs-varid'>extendHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varid'>lderiv</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-610"></a>    <span class='hs-varid'>for</span> <span class='hs-keyglyph'>@</span><span class='hs-conid'>Located</span> <span class='hs-varid'>lderiv</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>deriv</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-611"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>deriv</span> <span class='hs-keyword'>of</span>
<a name="line-612"></a>      <span class='hs-conid'>HsDerivingClause</span> <span class='hs-layout'>{</span> <span class='hs-varid'>deriv_clause_ext</span><span class='hs-layout'>,</span> <span class='hs-varid'>deriv_clause_strategy</span><span class='hs-layout'>,</span> <span class='hs-varid'>deriv_clause_tys</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-613"></a>        <span class='hs-keyword'>let</span>
<a name="line-614"></a>          <span class='hs-comment'>-- 'stock', 'anyclass', and 'newtype' strategies come</span>
<a name="line-615"></a>          <span class='hs-comment'>-- before the clause types.</span>
<a name="line-616"></a>          <span class='hs-comment'>--</span>
<a name="line-617"></a>          <span class='hs-comment'>-- 'via' comes after.</span>
<a name="line-618"></a>          <span class='hs-comment'>--</span>
<a name="line-619"></a>          <span class='hs-comment'>-- See tests/.../T11768.hs</span>
<a name="line-620"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>register_strategy_before</span><span class='hs-layout'>,</span> <span class='hs-varid'>register_strategy_after</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-621"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>deriv_clause_strategy</span> <span class='hs-keyword'>of</span>
<a name="line-622"></a>              <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pure</span> <span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-varid'>pure</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-623"></a>              <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>ViaStrategy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pure</span> <span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-varid'>registerLocHdkA</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-624"></a>              <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>registerLocHdkA</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-varid'>pure</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-625"></a>        <span class='hs-varid'>register_strategy_before</span>
<a name="line-626"></a>        <span class='hs-varid'>deriv_clause_tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>deriv_clause_tys</span>
<a name="line-627"></a>        <span class='hs-varid'>register_strategy_after</span>
<a name="line-628"></a>        <span class='hs-varid'>pure</span> <span class='hs-conid'>HsDerivingClause</span>
<a name="line-629"></a>          <span class='hs-layout'>{</span> <span class='hs-varid'>deriv_clause_ext</span><span class='hs-layout'>,</span>
<a name="line-630"></a>            <span class='hs-varid'>deriv_clause_strategy</span><span class='hs-layout'>,</span>
<a name="line-631"></a>            <span class='hs-varid'>deriv_clause_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deriv_clause_tys'</span> <span class='hs-layout'>}</span>
<a name="line-632"></a>
<a name="line-633"></a><a name="instance%20HasHaddock%20(LocatedC%20(DerivClauseTys%20GhcPs))"></a><span class='hs-comment'>-- Process the types in a single deriving clause, which may come in one of the</span>
<a name="line-634"></a><a name="instance%20HasHaddock%20(LocatedC%20(DerivClauseTys%20GhcPs))"></a><span class='hs-comment'>-- following forms:</span>
<a name="line-635"></a><a name="instance%20HasHaddock%20(LocatedC%20(DerivClauseTys%20GhcPs))"></a><span class='hs-comment'>--</span>
<a name="line-636"></a><a name="instance%20HasHaddock%20(LocatedC%20(DerivClauseTys%20GhcPs))"></a><span class='hs-comment'>--    1. A singular type constructor:</span>
<a name="line-637"></a><a name="instance%20HasHaddock%20(LocatedC%20(DerivClauseTys%20GhcPs))"></a><span class='hs-comment'>--          deriving Eq -- ^ Comment on Eq</span>
<a name="line-638"></a><a name="instance%20HasHaddock%20(LocatedC%20(DerivClauseTys%20GhcPs))"></a><span class='hs-comment'>--</span>
<a name="line-639"></a><a name="instance%20HasHaddock%20(LocatedC%20(DerivClauseTys%20GhcPs))"></a><span class='hs-comment'>--    2. A list of comma-separated types surrounded by enclosing parentheses:</span>
<a name="line-640"></a><a name="instance%20HasHaddock%20(LocatedC%20(DerivClauseTys%20GhcPs))"></a><span class='hs-comment'>--          deriving ( Eq  -- ^ Comment on Eq</span>
<a name="line-641"></a><a name="instance%20HasHaddock%20(LocatedC%20(DerivClauseTys%20GhcPs))"></a><span class='hs-comment'>--                   , C a -- ^ Comment on C a</span>
<a name="line-642"></a><a name="instance%20HasHaddock%20(LocatedC%20(DerivClauseTys%20GhcPs))"></a><span class='hs-comment'>--                   )</span>
<a name="line-643"></a><a name="instance%20HasHaddock%20(LocatedC%20(DerivClauseTys%20GhcPs))"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedC</span> <span class='hs-layout'>(</span><span class='hs-conid'>DerivClauseTys</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-644"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l_dct</span> <span class='hs-varid'>dct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-645"></a>    <span class='hs-varid'>extendHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>l_dct</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-646"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>dct</span> <span class='hs-keyword'>of</span>
<a name="line-647"></a>      <span class='hs-conid'>DctSingle</span> <span class='hs-varid'>x</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-648"></a>        <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>ty</span>
<a name="line-649"></a>        <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l_dct</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DctSingle</span> <span class='hs-varid'>x</span> <span class='hs-varid'>ty'</span>
<a name="line-650"></a>      <span class='hs-conid'>DctMulti</span> <span class='hs-varid'>x</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-651"></a>        <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>tys</span>
<a name="line-652"></a>        <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l_dct</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DctMulti</span> <span class='hs-varid'>x</span> <span class='hs-varid'>tys'</span>
<a name="line-653"></a>
<a name="line-654"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>-- Process a single data constructor declaration, which may come in one of the</span>
<a name="line-655"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>-- following forms:</span>
<a name="line-656"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--</span>
<a name="line-657"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--    1. H98-syntax PrefixCon:</span>
<a name="line-658"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--          data T =</span>
<a name="line-659"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--            MkT    -- ^ Comment on MkT</span>
<a name="line-660"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--              Int  -- ^ Comment on Int</span>
<a name="line-661"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--              Bool -- ^ Comment on Bool</span>
<a name="line-662"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--</span>
<a name="line-663"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--    2. H98-syntax InfixCon:</span>
<a name="line-664"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--          data T =</span>
<a name="line-665"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--            Int   -- ^ Comment on Int</span>
<a name="line-666"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--              :+  -- ^ Comment on (:+)</span>
<a name="line-667"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--            Bool  -- ^ Comment on Bool</span>
<a name="line-668"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--</span>
<a name="line-669"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--    3. H98-syntax RecCon:</span>
<a name="line-670"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--          data T =</span>
<a name="line-671"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--            MkT { int_field :: Int,     -- ^ Comment on int_field</span>
<a name="line-672"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--                  bool_field :: Bool }  -- ^ Comment on bool_field</span>
<a name="line-673"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--</span>
<a name="line-674"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--    4. GADT-syntax PrefixCon:</span>
<a name="line-675"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--          data T where</span>
<a name="line-676"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--            -- | Comment on MkT</span>
<a name="line-677"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--            MkT :: Int  -- ^ Comment on Int</span>
<a name="line-678"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--                -&gt; Bool -- ^ Comment on Bool</span>
<a name="line-679"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--                -&gt; T</span>
<a name="line-680"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--</span>
<a name="line-681"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--    5. GADT-syntax RecCon:</span>
<a name="line-682"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--          data T where</span>
<a name="line-683"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--            -- | Comment on MkT</span>
<a name="line-684"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--            MkT :: { int_field :: Int,     -- ^ Comment on int_field</span>
<a name="line-685"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--                     bool_field :: Bool }  -- ^ Comment on bool_field</span>
<a name="line-686"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--                -&gt; T</span>
<a name="line-687"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-comment'>--</span>
<a name="line-688"></a><a name="instance%20HasHaddock%20(LocatedA%20(ConDecl%20GhcPs))"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConDecl</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-689"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l_con_decl</span> <span class='hs-varid'>con_decl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-690"></a>    <span class='hs-varid'>extendHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>l_con_decl</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-691"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>con_decl</span> <span class='hs-keyword'>of</span>
<a name="line-692"></a>      <span class='hs-conid'>ConDeclGADT</span> <span class='hs-layout'>{</span> <span class='hs-varid'>con_g_ext</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_mb_cxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_g_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_res_ty</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-693"></a>        <span class='hs-comment'>-- discardHasInnerDocs is ok because we don't need this info for GADTs.</span>
<a name="line-694"></a>        <span class='hs-varid'>con_doc'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>discardHasInnerDocs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getConDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLocA</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>con_names</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-695"></a>        <span class='hs-varid'>con_g_args'</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-696"></a>          <span class='hs-keyword'>case</span> <span class='hs-varid'>con_g_args</span> <span class='hs-keyword'>of</span>
<a name="line-697"></a>            <span class='hs-conid'>PrefixConGADT</span> <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PrefixConGADT</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>ts</span>
<a name="line-698"></a>            <span class='hs-conid'>RecConGADT</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l_rec</span> <span class='hs-varid'>flds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-699"></a>              <span class='hs-comment'>-- discardHasInnerDocs is ok because we don't need this info for GADTs.</span>
<a name="line-700"></a>              <span class='hs-varid'>flds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>traverse</span> <span class='hs-layout'>(</span><span class='hs-varid'>discardHasInnerDocs</span> <span class='hs-varop'>.</span> <span class='hs-varid'>addHaddockConDeclField</span><span class='hs-layout'>)</span> <span class='hs-varid'>flds</span>
<a name="line-701"></a>              <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-conid'>RecConGADT</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l_rec</span> <span class='hs-varid'>flds'</span><span class='hs-layout'>)</span>
<a name="line-702"></a>        <span class='hs-varid'>con_res_ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>con_res_ty</span>
<a name="line-703"></a>        <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l_con_decl</span> <span class='hs-varop'>$</span>
<a name="line-704"></a>          <span class='hs-conid'>ConDeclGADT</span> <span class='hs-layout'>{</span> <span class='hs-varid'>con_g_ext</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_mb_cxt</span><span class='hs-layout'>,</span>
<a name="line-705"></a>                        <span class='hs-varid'>con_doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con_doc'</span><span class='hs-layout'>,</span>
<a name="line-706"></a>                        <span class='hs-varid'>con_g_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con_g_args'</span><span class='hs-layout'>,</span>
<a name="line-707"></a>                        <span class='hs-varid'>con_res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con_res_ty'</span> <span class='hs-layout'>}</span>
<a name="line-708"></a>      <span class='hs-conid'>ConDeclH98</span> <span class='hs-layout'>{</span> <span class='hs-varid'>con_ext</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_forall</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_mb_cxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_args</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-709"></a>        <span class='hs-varid'>addConTrailingDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcSpanEnd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>locA</span> <span class='hs-varid'>l_con_decl</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-710"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>con_args</span> <span class='hs-keyword'>of</span>
<a name="line-711"></a>          <span class='hs-conid'>PrefixCon</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-712"></a>            <span class='hs-varid'>con_doc'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getConDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLocA</span> <span class='hs-varid'>con_name</span><span class='hs-layout'>)</span>
<a name="line-713"></a>            <span class='hs-varid'>ts'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>traverse</span> <span class='hs-varid'>addHaddockConDeclFieldTy</span> <span class='hs-varid'>ts</span>
<a name="line-714"></a>            <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l_con_decl</span> <span class='hs-varop'>$</span>
<a name="line-715"></a>              <span class='hs-conid'>ConDeclH98</span> <span class='hs-layout'>{</span> <span class='hs-varid'>con_ext</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_forall</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_mb_cxt</span><span class='hs-layout'>,</span>
<a name="line-716"></a>                           <span class='hs-varid'>con_doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con_doc'</span><span class='hs-layout'>,</span>
<a name="line-717"></a>                           <span class='hs-varid'>con_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PrefixCon</span> <span class='hs-varid'>noTypeArgs</span> <span class='hs-varid'>ts'</span> <span class='hs-layout'>}</span>
<a name="line-718"></a>          <span class='hs-conid'>InfixCon</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-719"></a>            <span class='hs-varid'>t1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHaddockConDeclFieldTy</span> <span class='hs-varid'>t1</span>
<a name="line-720"></a>            <span class='hs-varid'>con_doc'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getConDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLocA</span> <span class='hs-varid'>con_name</span><span class='hs-layout'>)</span>
<a name="line-721"></a>            <span class='hs-varid'>t2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHaddockConDeclFieldTy</span> <span class='hs-varid'>t2</span>
<a name="line-722"></a>            <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l_con_decl</span> <span class='hs-varop'>$</span>
<a name="line-723"></a>              <span class='hs-conid'>ConDeclH98</span> <span class='hs-layout'>{</span> <span class='hs-varid'>con_ext</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_forall</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_mb_cxt</span><span class='hs-layout'>,</span>
<a name="line-724"></a>                           <span class='hs-varid'>con_doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con_doc'</span><span class='hs-layout'>,</span>
<a name="line-725"></a>                           <span class='hs-varid'>con_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InfixCon</span> <span class='hs-varid'>t1'</span> <span class='hs-varid'>t2'</span> <span class='hs-layout'>}</span>
<a name="line-726"></a>          <span class='hs-conid'>RecCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l_rec</span> <span class='hs-varid'>flds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-727"></a>            <span class='hs-varid'>con_doc'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getConDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLocA</span> <span class='hs-varid'>con_name</span><span class='hs-layout'>)</span>
<a name="line-728"></a>            <span class='hs-varid'>flds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>traverse</span> <span class='hs-varid'>addHaddockConDeclField</span> <span class='hs-varid'>flds</span>
<a name="line-729"></a>            <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l_con_decl</span> <span class='hs-varop'>$</span>
<a name="line-730"></a>              <span class='hs-conid'>ConDeclH98</span> <span class='hs-layout'>{</span> <span class='hs-varid'>con_ext</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_forall</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_mb_cxt</span><span class='hs-layout'>,</span>
<a name="line-731"></a>                           <span class='hs-varid'>con_doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con_doc'</span><span class='hs-layout'>,</span>
<a name="line-732"></a>                           <span class='hs-varid'>con_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RecCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l_rec</span> <span class='hs-varid'>flds'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-733"></a>
<a name="line-734"></a><a name="ConHdkA"></a><span class='hs-comment'>-- Keep track of documentation comments on the data constructor or any of its</span>
<a name="line-735"></a><a name="ConHdkA"></a><span class='hs-comment'>-- fields.</span>
<a name="line-736"></a><a name="ConHdkA"></a><span class='hs-comment'>--</span>
<a name="line-737"></a><a name="ConHdkA"></a><span class='hs-comment'>-- See Note [Trailing comment on constructor declaration]</span>
<a name="line-738"></a><a name="ConHdkA"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ConHdkA</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WriterT</span> <span class='hs-conid'>HasInnerDocs</span> <span class='hs-conid'>HdkA</span>
<a name="line-739"></a>
<a name="line-740"></a><a name="HasInnerDocs"></a><span class='hs-comment'>-- Does the data constructor declaration have any inner (non-trailing)</span>
<a name="line-741"></a><a name="HasInnerDocs"></a><span class='hs-comment'>-- documentation comments?</span>
<a name="line-742"></a><a name="HasInnerDocs"></a><span class='hs-comment'>--</span>
<a name="line-743"></a><a name="HasInnerDocs"></a><span class='hs-comment'>-- Example when HasInnerDocs is True:</span>
<a name="line-744"></a><a name="HasInnerDocs"></a><span class='hs-comment'>--</span>
<a name="line-745"></a><a name="HasInnerDocs"></a><span class='hs-comment'>--   data X =</span>
<a name="line-746"></a><a name="HasInnerDocs"></a><span class='hs-comment'>--      MkX       -- ^ inner comment</span>
<a name="line-747"></a><a name="HasInnerDocs"></a><span class='hs-comment'>--        Field1  -- ^ inner comment</span>
<a name="line-748"></a><a name="HasInnerDocs"></a><span class='hs-comment'>--        Field2  -- ^ inner comment</span>
<a name="line-749"></a><a name="HasInnerDocs"></a><span class='hs-comment'>--        Field3  -- ^ trailing comment</span>
<a name="line-750"></a><a name="HasInnerDocs"></a><span class='hs-comment'>--</span>
<a name="line-751"></a><a name="HasInnerDocs"></a><span class='hs-comment'>-- Example when HasInnerDocs is False:</span>
<a name="line-752"></a><a name="HasInnerDocs"></a><span class='hs-comment'>--</span>
<a name="line-753"></a><a name="HasInnerDocs"></a><span class='hs-comment'>--   data Y = MkY Field1 Field2 Field3  -- ^ trailing comment</span>
<a name="line-754"></a><a name="HasInnerDocs"></a><span class='hs-comment'>--</span>
<a name="line-755"></a><a name="HasInnerDocs"></a><span class='hs-comment'>-- See Note [Trailing comment on constructor declaration]</span>
<a name="line-756"></a><a name="HasInnerDocs"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>HasInnerDocs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HasInnerDocs</span> <span class='hs-conid'>Bool</span>
<a name="line-757"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Semigroup</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monoid</span><span class='hs-layout'>)</span> <span class='hs-varid'>via</span> <span class='hs-conid'>Data.Monoid.Any</span>
<a name="line-758"></a>
<a name="line-759"></a><a name="discardHasInnerDocs"></a><span class='hs-comment'>-- Run ConHdkA by discarding the HasInnerDocs info when we have no use for it.</span>
<a name="line-760"></a><span class='hs-comment'>--</span>
<a name="line-761"></a><span class='hs-comment'>-- We only do this when processing data declarations that use GADT syntax,</span>
<a name="line-762"></a><span class='hs-comment'>-- because only the H98 syntax declarations have special treatment for the</span>
<a name="line-763"></a><span class='hs-comment'>-- trailing documentation comment.</span>
<a name="line-764"></a><span class='hs-comment'>--</span>
<a name="line-765"></a><span class='hs-comment'>-- See Note [Trailing comment on constructor declaration]</span>
<a name="line-766"></a><span class='hs-definition'>discardHasInnerDocs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ConHdkA</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkA</span> <span class='hs-varid'>a</span>
<a name="line-767"></a><span class='hs-definition'>discardHasInnerDocs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>.</span> <span class='hs-varid'>runWriterT</span>
<a name="line-768"></a>
<a name="line-769"></a><a name="getConDoc"></a><span class='hs-comment'>-- Get the documentation comment associated with the data constructor in a</span>
<a name="line-770"></a><span class='hs-comment'>-- data/newtype declaration.</span>
<a name="line-771"></a><span class='hs-definition'>getConDoc</span>
<a name="line-772"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span>  <span class='hs-comment'>-- Location of the data constructor</span>
<a name="line-773"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ConHdkA</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>LHsDocString</span><span class='hs-layout'>)</span>
<a name="line-774"></a><span class='hs-definition'>getConDoc</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span>
<a name="line-775"></a>  <span class='hs-conid'>WriterT</span> <span class='hs-varop'>$</span> <span class='hs-varid'>extendHdkA</span> <span class='hs-varid'>l</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liftHdkA</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-776"></a>    <span class='hs-varid'>mDoc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPrevNextDoc</span> <span class='hs-varid'>l</span>
<a name="line-777"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mDoc</span><span class='hs-layout'>,</span> <span class='hs-conid'>HasInnerDocs</span> <span class='hs-layout'>(</span><span class='hs-varid'>isJust</span> <span class='hs-varid'>mDoc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-778"></a>
<a name="line-779"></a><a name="addHaddockConDeclFieldTy"></a><span class='hs-comment'>-- Add documentation comment to a data constructor field.</span>
<a name="line-780"></a><span class='hs-comment'>-- Used for PrefixCon and InfixCon.</span>
<a name="line-781"></a><span class='hs-definition'>addHaddockConDeclFieldTy</span>
<a name="line-782"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsScaled</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-783"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ConHdkA</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsScaled</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-784"></a><span class='hs-definition'>addHaddockConDeclFieldTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsScaled</span> <span class='hs-varid'>mult</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-785"></a>  <span class='hs-conid'>WriterT</span> <span class='hs-varop'>$</span> <span class='hs-varid'>extendHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liftHdkA</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-786"></a>    <span class='hs-varid'>mDoc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPrevNextDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-787"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsScaled</span> <span class='hs-varid'>mult</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLHsDocTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-varid'>mDoc</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-788"></a>            <span class='hs-conid'>HasInnerDocs</span> <span class='hs-layout'>(</span><span class='hs-varid'>isJust</span> <span class='hs-varid'>mDoc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-789"></a>
<a name="line-790"></a><a name="addHaddockConDeclField"></a><span class='hs-comment'>-- Add documentation comment to a data constructor field.</span>
<a name="line-791"></a><span class='hs-comment'>-- Used for RecCon.</span>
<a name="line-792"></a><span class='hs-definition'>addHaddockConDeclField</span>
<a name="line-793"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LConDeclField</span> <span class='hs-conid'>GhcPs</span>
<a name="line-794"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ConHdkA</span> <span class='hs-layout'>(</span><span class='hs-conid'>LConDeclField</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-795"></a><span class='hs-definition'>addHaddockConDeclField</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l_fld</span> <span class='hs-varid'>fld</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-796"></a>  <span class='hs-conid'>WriterT</span> <span class='hs-varop'>$</span> <span class='hs-varid'>extendHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>l_fld</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liftHdkA</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-797"></a>    <span class='hs-varid'>cd_fld_doc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPrevNextDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>l_fld</span><span class='hs-layout'>)</span>
<a name="line-798"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l_fld</span> <span class='hs-layout'>(</span><span class='hs-varid'>fld</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cd_fld_doc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-799"></a>            <span class='hs-conid'>HasInnerDocs</span> <span class='hs-layout'>(</span><span class='hs-varid'>isJust</span> <span class='hs-varid'>cd_fld_doc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-800"></a>
<a name="line-801"></a><a name="addConTrailingDoc"></a><span class='hs-comment'>-- 1. Process a H98-syntax data constructor declaration in a context with no</span>
<a name="line-802"></a><span class='hs-comment'>--    access to the trailing documentation comment (by running the provided</span>
<a name="line-803"></a><span class='hs-comment'>--    ConHdkA computation).</span>
<a name="line-804"></a><span class='hs-comment'>--</span>
<a name="line-805"></a><span class='hs-comment'>-- 2. Then grab the trailing comment (if it exists) and attach it where</span>
<a name="line-806"></a><span class='hs-comment'>--    appropriate: either to the data constructor itself or to its last field,</span>
<a name="line-807"></a><span class='hs-comment'>--    depending on HasInnerDocs.</span>
<a name="line-808"></a><span class='hs-comment'>--</span>
<a name="line-809"></a><span class='hs-comment'>-- See Note [Trailing comment on constructor declaration]</span>
<a name="line-810"></a><span class='hs-definition'>addConTrailingDoc</span>
<a name="line-811"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcLoc</span>  <span class='hs-comment'>-- The end of a data constructor declaration.</span>
<a name="line-812"></a>             <span class='hs-comment'>-- Any docprev comment past this point is considered trailing.</span>
<a name="line-813"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ConHdkA</span> <span class='hs-layout'>(</span><span class='hs-conid'>LConDecl</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-814"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkA</span> <span class='hs-layout'>(</span><span class='hs-conid'>LConDecl</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-815"></a><span class='hs-definition'>addConTrailingDoc</span> <span class='hs-varid'>l_sep</span> <span class='hs-keyglyph'>=</span>
<a name="line-816"></a>    <span class='hs-varid'>hoistHdkA</span> <span class='hs-varid'>add_trailing_doc</span> <span class='hs-varop'>.</span> <span class='hs-varid'>runWriterT</span>
<a name="line-817"></a>  <span class='hs-keyword'>where</span>
<a name="line-818"></a>    <span class='hs-varid'>add_trailing_doc</span>
<a name="line-819"></a>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HdkM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LConDecl</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>,</span> <span class='hs-conid'>HasInnerDocs</span><span class='hs-layout'>)</span>
<a name="line-820"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LConDecl</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-821"></a>    <span class='hs-varid'>add_trailing_doc</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-822"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>con_decl</span><span class='hs-layout'>,</span> <span class='hs-conid'>HasInnerDocs</span> <span class='hs-varid'>has_inner_docs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-823"></a>        <span class='hs-varid'>inLocRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>locRangeTo</span> <span class='hs-layout'>(</span><span class='hs-varid'>getBufPos</span> <span class='hs-varid'>l_sep</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span>
<a name="line-824"></a>          <span class='hs-comment'>-- inLocRange delimits the context so that the inner computation</span>
<a name="line-825"></a>          <span class='hs-comment'>-- will not consume the trailing documentation comment.</span>
<a name="line-826"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>con_decl</span> <span class='hs-keyword'>of</span>
<a name="line-827"></a>        <span class='hs-conid'>ConDeclH98</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-828"></a>          <span class='hs-varid'>trailingDocs</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-829"></a>            <span class='hs-varid'>inLocRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>locRangeFrom</span> <span class='hs-layout'>(</span><span class='hs-varid'>getBufPos</span> <span class='hs-varid'>l_sep</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-830"></a>            <span class='hs-varid'>takeHdkComments</span> <span class='hs-varid'>mkDocPrev</span>
<a name="line-831"></a>          <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>trailingDocs</span>
<a name="line-832"></a>          <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>con_decl</span><span class='hs-layout'>)</span>
<a name="line-833"></a>          <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-834"></a>            <span class='hs-keyword'>if</span> <span class='hs-varid'>has_inner_docs</span> <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-835"></a>              <span class='hs-keyword'>let</span> <span class='hs-varid'>mk_doc_ty</span> <span class='hs-keyglyph'>::</span>       <span class='hs-conid'>HsScaled</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-836"></a>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsScaled</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-837"></a>                  <span class='hs-varid'>mk_doc_ty</span> <span class='hs-varid'>x</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsScaled</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>HsDocTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-838"></a>                    <span class='hs-comment'>-- Happens in the following case:</span>
<a name="line-839"></a>                    <span class='hs-comment'>--</span>
<a name="line-840"></a>                    <span class='hs-comment'>--    data T =</span>
<a name="line-841"></a>                    <span class='hs-comment'>--      MkT</span>
<a name="line-842"></a>                    <span class='hs-comment'>--        -- | Comment on SomeField</span>
<a name="line-843"></a>                    <span class='hs-comment'>--        SomeField</span>
<a name="line-844"></a>                    <span class='hs-comment'>--        -- ^ Another comment on SomeField? (rejected)</span>
<a name="line-845"></a>                    <span class='hs-comment'>--</span>
<a name="line-846"></a>                    <span class='hs-comment'>-- See tests/.../haddockExtraDocs.hs</span>
<a name="line-847"></a>                    <span class='hs-varid'>x</span> <span class='hs-varop'>&lt;$</span> <span class='hs-varid'>reportExtraDocs</span> <span class='hs-varid'>trailingDocs</span>
<a name="line-848"></a>                  <span class='hs-varid'>mk_doc_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsScaled</span> <span class='hs-varid'>mult</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l'</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-849"></a>                    <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>selectDocString</span> <span class='hs-varid'>trailingDocs</span>
<a name="line-850"></a>                    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsScaled</span> <span class='hs-varid'>mult</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLHsDocTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l'</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>
<a name="line-851"></a>              <span class='hs-keyword'>let</span> <span class='hs-varid'>mk_doc_fld</span> <span class='hs-keyglyph'>::</span>       <span class='hs-conid'>LConDeclField</span> <span class='hs-conid'>GhcPs</span>
<a name="line-852"></a>                             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LConDeclField</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-853"></a>                  <span class='hs-varid'>mk_doc_fld</span> <span class='hs-varid'>x</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConDeclField</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cd_fld_doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-854"></a>                    <span class='hs-comment'>-- Happens in the following case:</span>
<a name="line-855"></a>                    <span class='hs-comment'>--</span>
<a name="line-856"></a>                    <span class='hs-comment'>--    data T =</span>
<a name="line-857"></a>                    <span class='hs-comment'>--      MkT {</span>
<a name="line-858"></a>                    <span class='hs-comment'>--        -- | Comment on SomeField</span>
<a name="line-859"></a>                    <span class='hs-comment'>--        someField :: SomeField</span>
<a name="line-860"></a>                    <span class='hs-comment'>--      } -- ^ Another comment on SomeField? (rejected)</span>
<a name="line-861"></a>                    <span class='hs-comment'>--</span>
<a name="line-862"></a>                    <span class='hs-comment'>-- See tests/.../haddockExtraDocs.hs</span>
<a name="line-863"></a>                    <span class='hs-varid'>x</span> <span class='hs-varop'>&lt;$</span> <span class='hs-varid'>reportExtraDocs</span> <span class='hs-varid'>trailingDocs</span>
<a name="line-864"></a>                  <span class='hs-varid'>mk_doc_fld</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l'</span> <span class='hs-varid'>con_fld</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-865"></a>                    <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>selectDocString</span> <span class='hs-varid'>trailingDocs</span>
<a name="line-866"></a>                    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l'</span> <span class='hs-layout'>(</span><span class='hs-varid'>con_fld</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cd_fld_doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-867"></a>              <span class='hs-varid'>con_args'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>con_args</span> <span class='hs-varid'>con_decl</span> <span class='hs-keyword'>of</span>
<a name="line-868"></a>                <span class='hs-varid'>x</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PrefixCon</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&lt;$</span> <span class='hs-varid'>reportExtraDocs</span> <span class='hs-varid'>trailingDocs</span>
<a name="line-869"></a>                <span class='hs-varid'>x</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>RecCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&lt;$</span> <span class='hs-varid'>reportExtraDocs</span> <span class='hs-varid'>trailingDocs</span>
<a name="line-870"></a>                <span class='hs-conid'>PrefixCon</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PrefixCon</span> <span class='hs-varid'>noTypeArgs</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>mapLastM</span> <span class='hs-varid'>mk_doc_ty</span> <span class='hs-varid'>ts</span>
<a name="line-871"></a>                <span class='hs-conid'>InfixCon</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InfixCon</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>mk_doc_ty</span> <span class='hs-varid'>t2</span>
<a name="line-872"></a>                <span class='hs-conid'>RecCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l_rec</span> <span class='hs-varid'>flds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-873"></a>                  <span class='hs-varid'>flds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapLastM</span> <span class='hs-varid'>mk_doc_fld</span> <span class='hs-varid'>flds</span>
<a name="line-874"></a>                  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l_rec</span> <span class='hs-varid'>flds'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-875"></a>              <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-varid'>con_decl</span><span class='hs-layout'>{</span> <span class='hs-varid'>con_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con_args'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-876"></a>            <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-877"></a>              <span class='hs-varid'>con_doc'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>selectDocString</span> <span class='hs-layout'>(</span><span class='hs-varid'>con_doc</span> <span class='hs-varid'>con_decl</span> <span class='hs-varop'>`mcons`</span> <span class='hs-varid'>trailingDocs</span><span class='hs-layout'>)</span>
<a name="line-878"></a>              <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-varid'>con_decl</span><span class='hs-layout'>{</span> <span class='hs-varid'>con_doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con_doc'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-879"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"addConTrailingDoc: non-H98 ConDecl"</span>
<a name="line-880"></a>
<a name="line-881"></a><span class='hs-comment'>{- Note [Trailing comment on constructor declaration]
<a name="line-882"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-883"></a>The trailing comment after a constructor declaration is associated with the
<a name="line-884"></a>constructor itself when there are no other comments inside the declaration:
<a name="line-885"></a>
<a name="line-886"></a>   data T = MkT A B        -- ^ Comment on MkT
<a name="line-887"></a>   data T = MkT { x :: A } -- ^ Comment on MkT
<a name="line-888"></a>
<a name="line-889"></a>When there are other comments, the trailing comment applies to the last field:
<a name="line-890"></a>
<a name="line-891"></a>   data T = MkT -- ^ Comment on MkT
<a name="line-892"></a>            A   -- ^ Comment on A
<a name="line-893"></a>            B   -- ^ Comment on B
<a name="line-894"></a>
<a name="line-895"></a>   data T =
<a name="line-896"></a>     MkT { a :: A   -- ^ Comment on a
<a name="line-897"></a>         , b :: B   -- ^ Comment on b
<a name="line-898"></a>         , c :: C } -- ^ Comment on c
<a name="line-899"></a>
<a name="line-900"></a>This makes the trailing comment context-sensitive. Example:
<a name="line-901"></a>      data T =
<a name="line-902"></a>        -- | comment 1
<a name="line-903"></a>        MkT Int Bool -- ^ comment 2
<a name="line-904"></a>
<a name="line-905"></a>    Here, "comment 2" applies to the Bool field.
<a name="line-906"></a>    But if we removed "comment 1", then "comment 2" would be apply to the data
<a name="line-907"></a>    constructor rather than its field.
<a name="line-908"></a>
<a name="line-909"></a>All of this applies to H98-style data declarations only.
<a name="line-910"></a>GADTSyntax data constructors don't have any special treatment for the trailing comment.
<a name="line-911"></a>
<a name="line-912"></a>We implement this in two steps:
<a name="line-913"></a>
<a name="line-914"></a>  1. Process the data constructor declaration in a delimited context where the
<a name="line-915"></a>     trailing documentation comment is not visible. Delimiting the context is done
<a name="line-916"></a>     in addConTrailingDoc.
<a name="line-917"></a>
<a name="line-918"></a>     When processing the declaration, track whether the constructor or any of
<a name="line-919"></a>     its fields have a documentation comment associated with them.
<a name="line-920"></a>     This is done using WriterT HasInnerDocs, see ConHdkA.
<a name="line-921"></a>
<a name="line-922"></a>  2. Depending on whether HasInnerDocs is True or False, attach the
<a name="line-923"></a>     trailing documentation comment to the data constructor itself
<a name="line-924"></a>     or to its last field.
<a name="line-925"></a>-}</span>
<a name="line-926"></a>
<a name="line-927"></a><a name="instance%20HasHaddock%20(HsScaled%20GhcPs%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasHaddock</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HasHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsScaled</span> <span class='hs-conid'>GhcPs</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-928"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsScaled</span> <span class='hs-varid'>mult</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsScaled</span> <span class='hs-varid'>mult</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>a</span>
<a name="line-929"></a>
<a name="line-930"></a><a name="instance%20HasHaddock%20(HsWildCardBndrs%20GhcPs%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasHaddock</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HasHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWildCardBndrs</span> <span class='hs-conid'>GhcPs</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-931"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWC</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsWC</span> <span class='hs-varid'>noExtField</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>t</span>
<a name="line-932"></a>
<a name="line-933"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsSigType%20GhcPs))"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSigType</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-934"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSig</span><span class='hs-layout'>{</span><span class='hs-varid'>sig_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>outer_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>body</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-935"></a>    <span class='hs-varid'>extendHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-936"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>outer_bndrs</span> <span class='hs-keyword'>of</span>
<a name="line-937"></a>        <span class='hs-conid'>HsOuterImplicit</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-conid'>()</span>
<a name="line-938"></a>        <span class='hs-conid'>HsOuterExplicit</span><span class='hs-layout'>{</span><span class='hs-varid'>hso_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-939"></a>          <span class='hs-varid'>registerLocHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLHsTyVarBndrsLoc</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span>
<a name="line-940"></a>      <span class='hs-varid'>body'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>body</span>
<a name="line-941"></a>      <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsSig</span> <span class='hs-varid'>noExtField</span> <span class='hs-varid'>outer_bndrs</span> <span class='hs-varid'>body'</span>
<a name="line-942"></a>
<a name="line-943"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>-- Process a type, adding documentation comments to function arguments</span>
<a name="line-944"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>-- and the result. Many formatting styles are supported.</span>
<a name="line-945"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--</span>
<a name="line-946"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--  my_function ::</span>
<a name="line-947"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--      forall a.</span>
<a name="line-948"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--      Eq a =&gt;</span>
<a name="line-949"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--      Maybe a -&gt;  -- ^ Comment on Maybe a  (function argument)</span>
<a name="line-950"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--      Bool -&gt;     -- ^ Comment on Bool     (function argument)</span>
<a name="line-951"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--      String      -- ^ Comment on String   (the result)</span>
<a name="line-952"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--</span>
<a name="line-953"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--  my_function</span>
<a name="line-954"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--      :: forall a. Eq a</span>
<a name="line-955"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--      =&gt; Maybe a     -- ^ Comment on Maybe a  (function argument)</span>
<a name="line-956"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--      -&gt; Bool        -- ^ Comment on Bool     (function argument)</span>
<a name="line-957"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--      -&gt; String      -- ^ Comment on String   (the result)</span>
<a name="line-958"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--</span>
<a name="line-959"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--  my_function ::</span>
<a name="line-960"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--      forall a. Eq a =&gt;</span>
<a name="line-961"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--      -- | Comment on Maybe a (function argument)</span>
<a name="line-962"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--      Maybe a -&gt;</span>
<a name="line-963"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--      -- | Comment on Bool (function argument)</span>
<a name="line-964"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--      Bool -&gt;</span>
<a name="line-965"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--      -- | Comment on String (the result)</span>
<a name="line-966"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--      String</span>
<a name="line-967"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>--</span>
<a name="line-968"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>-- This is achieved by simply ignoring (not registering the location of) the</span>
<a name="line-969"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-comment'>-- function arrow (-&gt;).</span>
<a name="line-970"></a><a name="instance%20HasHaddock%20(LocatedA%20(HsType%20GhcPs))"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-971"></a>  <span class='hs-varid'>addHaddock</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-972"></a>    <span class='hs-varid'>extendHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-973"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>t</span> <span class='hs-keyword'>of</span>
<a name="line-974"></a>
<a name="line-975"></a>      <span class='hs-comment'>-- forall a b c. t</span>
<a name="line-976"></a>      <span class='hs-conid'>HsForAllTy</span> <span class='hs-varid'>x</span> <span class='hs-varid'>tele</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-977"></a>        <span class='hs-varid'>registerLocHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>getForAllTeleLoc</span> <span class='hs-varid'>tele</span><span class='hs-layout'>)</span>
<a name="line-978"></a>        <span class='hs-varid'>body'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>body</span>
<a name="line-979"></a>        <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-varid'>x</span> <span class='hs-varid'>tele</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span>
<a name="line-980"></a>
<a name="line-981"></a>      <span class='hs-comment'>-- (Eq a, Num a) =&gt; t</span>
<a name="line-982"></a>      <span class='hs-conid'>HsQualTy</span> <span class='hs-varid'>x</span> <span class='hs-varid'>mlhs</span> <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-983"></a>        <span class='hs-varid'>traverse_</span> <span class='hs-varid'>registerHdkA</span> <span class='hs-varid'>mlhs</span>
<a name="line-984"></a>        <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>rhs</span>
<a name="line-985"></a>        <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQualTy</span> <span class='hs-varid'>x</span> <span class='hs-varid'>mlhs</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span>
<a name="line-986"></a>
<a name="line-987"></a>      <span class='hs-comment'>-- arg -&gt; res</span>
<a name="line-988"></a>      <span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>u</span> <span class='hs-varid'>mult</span> <span class='hs-varid'>lhs</span> <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-989"></a>        <span class='hs-varid'>lhs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>lhs</span>
<a name="line-990"></a>        <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addHaddock</span> <span class='hs-varid'>rhs</span>
<a name="line-991"></a>        <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>u</span> <span class='hs-varid'>mult</span> <span class='hs-varid'>lhs'</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span>
<a name="line-992"></a>
<a name="line-993"></a>      <span class='hs-comment'>-- other types</span>
<a name="line-994"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftHdkA</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-995"></a>        <span class='hs-varid'>mDoc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPrevNextDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-996"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLHsDocTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-varid'>mDoc</span><span class='hs-layout'>)</span>
<a name="line-997"></a>
<a name="line-998"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-999"></a>*                                                                      *
<a name="line-1000"></a>*      HdkA: a layer over HdkM that propagates location information    *
<a name="line-1001"></a>*                                                                      *
<a name="line-1002"></a>********************************************************************* -}</span>
<a name="line-1003"></a>
<a name="line-1004"></a><a name="HdkA"></a><span class='hs-comment'>-- See Note [Adding Haddock comments to the syntax tree].</span>
<a name="line-1005"></a><a name="HdkA"></a><span class='hs-comment'>--</span>
<a name="line-1006"></a><a name="HdkA"></a><span class='hs-comment'>-- 'HdkA' provides a way to propagate location information from surrounding</span>
<a name="line-1007"></a><a name="HdkA"></a><span class='hs-comment'>-- computations:</span>
<a name="line-1008"></a><a name="HdkA"></a><span class='hs-comment'>--</span>
<a name="line-1009"></a><a name="HdkA"></a><span class='hs-comment'>--   left_neighbour &lt;*&gt; HdkA inner_span inner_m &lt;*&gt; right_neighbour</span>
<a name="line-1010"></a><a name="HdkA"></a><span class='hs-comment'>--</span>
<a name="line-1011"></a><a name="HdkA"></a><span class='hs-comment'>-- Here, the following holds:</span>
<a name="line-1012"></a><a name="HdkA"></a><span class='hs-comment'>--</span>
<a name="line-1013"></a><a name="HdkA"></a><span class='hs-comment'>-- * the 'left_neighbour' will only see Haddock comments until 'bufSpanStart' of 'inner_span'</span>
<a name="line-1014"></a><a name="HdkA"></a><span class='hs-comment'>-- * the 'right_neighbour' will only see Haddock comments after 'bufSpanEnd' of 'inner_span'</span>
<a name="line-1015"></a><a name="HdkA"></a><span class='hs-comment'>-- * the 'inner_m' will only see Haddock comments between its 'left_neighbour' and its 'right_neighbour'</span>
<a name="line-1016"></a><a name="HdkA"></a><span class='hs-comment'>--</span>
<a name="line-1017"></a><a name="HdkA"></a><span class='hs-comment'>-- In other words, every computation:</span>
<a name="line-1018"></a><a name="HdkA"></a><span class='hs-comment'>--</span>
<a name="line-1019"></a><a name="HdkA"></a><span class='hs-comment'>--  * delimits the surrounding computations</span>
<a name="line-1020"></a><a name="HdkA"></a><span class='hs-comment'>--  * is delimited by the surrounding computations</span>
<a name="line-1021"></a><a name="HdkA"></a><span class='hs-comment'>--</span>
<a name="line-1022"></a><a name="HdkA"></a><span class='hs-comment'>--  Therefore, a 'HdkA' computation must be always considered in the context in</span>
<a name="line-1023"></a><a name="HdkA"></a><span class='hs-comment'>--  which it is used.</span>
<a name="line-1024"></a><a name="HdkA"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>HdkA</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span>
<a name="line-1025"></a>  <span class='hs-conid'>HdkA</span>
<a name="line-1026"></a>    <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>BufSpan</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Just b  &lt;=&gt; BufSpan occupied by the processed AST element.</span>
<a name="line-1027"></a>                     <span class='hs-comment'>--             The surrounding computations will not look inside.</span>
<a name="line-1028"></a>                     <span class='hs-comment'>--</span>
<a name="line-1029"></a>                     <span class='hs-comment'>-- Nothing &lt;=&gt; No BufSpan (e.g. when the HdkA is constructed by 'pure' or 'liftHdkA').</span>
<a name="line-1030"></a>                     <span class='hs-comment'>--             The surrounding computations are not delimited.</span>
<a name="line-1031"></a>
<a name="line-1032"></a>    <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>HdkM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- The stateful computation that looks up Haddock comments and</span>
<a name="line-1033"></a>              <span class='hs-comment'>-- adds them to the resulting AST node.</span>
<a name="line-1034"></a>
<a name="line-1035"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Functor</span><span class='hs-layout'>)</span>
<a name="line-1036"></a>
<a name="line-1037"></a><a name="instance%20Applicative%20HdkA"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Applicative</span> <span class='hs-conid'>HdkA</span> <span class='hs-keyword'>where</span>
<a name="line-1038"></a>  <span class='hs-conid'>HdkA</span> <span class='hs-varid'>l1</span> <span class='hs-varid'>m1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-conid'>HdkA</span> <span class='hs-varid'>l2</span> <span class='hs-varid'>m2</span> <span class='hs-keyglyph'>=</span>
<a name="line-1039"></a>    <span class='hs-conid'>HdkA</span>
<a name="line-1040"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>l1</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>l2</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- The combined BufSpan that covers both subcomputations.</span>
<a name="line-1041"></a>                  <span class='hs-comment'>--</span>
<a name="line-1042"></a>                  <span class='hs-comment'>-- The Semigroup instance for Maybe quite conveniently does the right thing:</span>
<a name="line-1043"></a>                  <span class='hs-comment'>--    Nothing &lt;&gt; b       = b</span>
<a name="line-1044"></a>                  <span class='hs-comment'>--    a       &lt;&gt; Nothing = a</span>
<a name="line-1045"></a>                  <span class='hs-comment'>--    Just a  &lt;&gt; Just b  = Just (a &lt;&gt; b)</span>
<a name="line-1046"></a>
<a name="line-1047"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>delim1</span> <span class='hs-varid'>m1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>delim2</span> <span class='hs-varid'>m2</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Stateful computations are run in left-to-right order,</span>
<a name="line-1048"></a>                                <span class='hs-comment'>-- without any smart reordering strategy. So users of this</span>
<a name="line-1049"></a>                                <span class='hs-comment'>-- operation must take care to traverse the AST</span>
<a name="line-1050"></a>                                <span class='hs-comment'>-- in concrete syntax order.</span>
<a name="line-1051"></a>                                <span class='hs-comment'>-- See Note [Smart reordering in HdkA (or lack of thereof)]</span>
<a name="line-1052"></a>                                <span class='hs-comment'>--</span>
<a name="line-1053"></a>                                <span class='hs-comment'>-- Each computation is delimited ("sandboxed")</span>
<a name="line-1054"></a>                                <span class='hs-comment'>-- in a way that it doesn't see any Haddock</span>
<a name="line-1055"></a>                                <span class='hs-comment'>-- comments past the neighbouring AST node.</span>
<a name="line-1056"></a>                                <span class='hs-comment'>-- These delim1/delim2 are key to how HdkA operates.</span>
<a name="line-1057"></a>    <span class='hs-keyword'>where</span>
<a name="line-1058"></a>      <span class='hs-comment'>-- Delimit the LHS by the location information from the RHS</span>
<a name="line-1059"></a>      <span class='hs-varid'>delim1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inLocRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>locRangeTo</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-keyglyph'>@</span><span class='hs-conid'>Maybe</span> <span class='hs-varid'>bufSpanStart</span> <span class='hs-varid'>l2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1060"></a>      <span class='hs-comment'>-- Delimit the RHS by the location information from the LHS</span>
<a name="line-1061"></a>      <span class='hs-varid'>delim2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inLocRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>locRangeFrom</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-keyglyph'>@</span><span class='hs-conid'>Maybe</span> <span class='hs-varid'>bufSpanEnd</span> <span class='hs-varid'>l1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1062"></a>
<a name="line-1063"></a>  <span class='hs-varid'>pure</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span>
<a name="line-1064"></a>    <span class='hs-comment'>-- Return a value without performing any stateful computation, and without</span>
<a name="line-1065"></a>    <span class='hs-comment'>-- any delimiting effect on the surrounding computations.</span>
<a name="line-1066"></a>    <span class='hs-varid'>liftHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>pure</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1067"></a>
<a name="line-1068"></a><span class='hs-comment'>{- Note [Smart reordering in HdkA (or lack of thereof)]
<a name="line-1069"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1070"></a>When traversing the AST, the user must take care to traverse it in concrete
<a name="line-1071"></a>syntax order.
<a name="line-1072"></a>
<a name="line-1073"></a>For example, when processing HsFunTy, it's important to get it right and write
<a name="line-1074"></a>it like so:
<a name="line-1075"></a>
<a name="line-1076"></a>      HsFunTy _ mult lhs rhs -&gt; do
<a name="line-1077"></a>        lhs' &lt;- addHaddock lhs
<a name="line-1078"></a>        rhs' &lt;- addHaddock rhs
<a name="line-1079"></a>        pure $ L l (HsFunTy noExtField mult lhs' rhs')
<a name="line-1080"></a>
<a name="line-1081"></a>Rather than like so:
<a name="line-1082"></a>
<a name="line-1083"></a>      HsFunTy _ mult lhs rhs -&gt; do
<a name="line-1084"></a>        rhs' &lt;- addHaddock rhs   -- bad! wrong order
<a name="line-1085"></a>        lhs' &lt;- addHaddock lhs   -- bad! wrong order
<a name="line-1086"></a>        pure $ L l (HsFunTy noExtField mult lhs' rhs')
<a name="line-1087"></a>
<a name="line-1088"></a>This is somewhat bug-prone, so we could try to fix this with some Applicative
<a name="line-1089"></a>magic. When we define (&lt;*&gt;) for HdkA, why not reorder the computations as
<a name="line-1090"></a>necessary? In pseudo-code:
<a name="line-1091"></a>
<a name="line-1092"></a>  a1 &lt;*&gt; a2 | a1 `before` a2 = ... normal processing ...
<a name="line-1093"></a>            | otherwise      = a1 &lt;**&gt; a2
<a name="line-1094"></a>
<a name="line-1095"></a>While this trick could work for any two *adjacent* AST elements out of order
<a name="line-1096"></a>(as in HsFunTy example above), it would fail in more elaborate scenarios (e.g.
<a name="line-1097"></a>processing a list of declarations out of order).
<a name="line-1098"></a>
<a name="line-1099"></a>If it's not obvious why this trick doesn't work, ponder this: it's a bit like trying to get
<a name="line-1100"></a>a sorted list by defining a 'smart' concatenation operator in the following manner:
<a name="line-1101"></a>
<a name="line-1102"></a>  a ?++ b | a &lt;= b    = a ++ b
<a name="line-1103"></a>          | otherwise = b ++ a
<a name="line-1104"></a>
<a name="line-1105"></a>At first glance it seems to work:
<a name="line-1106"></a>
<a name="line-1107"></a>  ghci&gt; [1] ?++ [2] ?++ [3]
<a name="line-1108"></a>  [1,2,3]
<a name="line-1109"></a>
<a name="line-1110"></a>  ghci&gt; [2] ?++ [1] ?++ [3]
<a name="line-1111"></a>  [1,2,3]                     -- wow, sorted!
<a name="line-1112"></a>
<a name="line-1113"></a>But it actually doesn't:
<a name="line-1114"></a>
<a name="line-1115"></a>  ghci&gt; [3] ?++ [1] ?++ [2]
<a name="line-1116"></a>  [1,3,2]                     -- not sorted...
<a name="line-1117"></a>-}</span>
<a name="line-1118"></a>
<a name="line-1119"></a><a name="runHdkA"></a><span class='hs-comment'>-- Run a HdkA computation in an unrestricted LocRange. This is only used at the</span>
<a name="line-1120"></a><span class='hs-comment'>-- top level to run the final computation for the entire module.</span>
<a name="line-1121"></a><span class='hs-definition'>runHdkA</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HdkA</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkSt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>HdkSt</span><span class='hs-layout'>)</span>
<a name="line-1122"></a><span class='hs-definition'>runHdkA</span> <span class='hs-layout'>(</span><span class='hs-conid'>HdkA</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unHdkM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>mempty</span>
<a name="line-1123"></a>
<a name="line-1124"></a><a name="registerLocHdkA"></a><span class='hs-comment'>-- Let the neighbours know about an item at this location.</span>
<a name="line-1125"></a><span class='hs-comment'>--</span>
<a name="line-1126"></a><span class='hs-comment'>-- Consider this example:</span>
<a name="line-1127"></a><span class='hs-comment'>--</span>
<a name="line-1128"></a><span class='hs-comment'>--  class -- | peculiarly placed comment</span>
<a name="line-1129"></a><span class='hs-comment'>--    MyClass a where</span>
<a name="line-1130"></a><span class='hs-comment'>--        my_method :: a -&gt; a</span>
<a name="line-1131"></a><span class='hs-comment'>--</span>
<a name="line-1132"></a><span class='hs-comment'>-- How do we know to reject the "peculiarly placed comment" instead of</span>
<a name="line-1133"></a><span class='hs-comment'>-- associating it with my_method? Its indentation level matches.</span>
<a name="line-1134"></a><span class='hs-comment'>--</span>
<a name="line-1135"></a><span class='hs-comment'>-- But clearly, there's "MyClass a where" separating the comment and my_method.</span>
<a name="line-1136"></a><span class='hs-comment'>-- To take it into account, we must register its location using registerLocHdkA</span>
<a name="line-1137"></a><span class='hs-comment'>-- or registerHdkA.</span>
<a name="line-1138"></a><span class='hs-comment'>--</span>
<a name="line-1139"></a><span class='hs-comment'>-- See Note [Register keyword location].</span>
<a name="line-1140"></a><span class='hs-comment'>-- See Note [Adding Haddock comments to the syntax tree].</span>
<a name="line-1141"></a><span class='hs-definition'>registerLocHdkA</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkA</span> <span class='hs-conid'>()</span>
<a name="line-1142"></a><span class='hs-definition'>registerLocHdkA</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>getBufSpan</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>pure</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-1143"></a>
<a name="line-1144"></a><a name="registerHdkA"></a><span class='hs-comment'>-- Let the neighbours know about an item at this location.</span>
<a name="line-1145"></a><span class='hs-comment'>-- A small wrapper over registerLocHdkA.</span>
<a name="line-1146"></a><span class='hs-comment'>--</span>
<a name="line-1147"></a><span class='hs-comment'>-- See Note [Adding Haddock comments to the syntax tree].</span>
<a name="line-1148"></a><span class='hs-definition'>registerHdkA</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GenLocated</span> <span class='hs-layout'>(</span><span class='hs-conid'>SrcSpanAnn'</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkA</span> <span class='hs-conid'>()</span>
<a name="line-1149"></a><span class='hs-definition'>registerHdkA</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>registerLocHdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLocA</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1150"></a>
<a name="line-1151"></a><a name="hoistHdkA"></a><span class='hs-comment'>-- Modify the action of a HdkA computation.</span>
<a name="line-1152"></a><span class='hs-definition'>hoistHdkA</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>HdkM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkM</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkA</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkA</span> <span class='hs-varid'>b</span>
<a name="line-1153"></a><span class='hs-definition'>hoistHdkA</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>HdkA</span> <span class='hs-varid'>l</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HdkA</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-1154"></a>
<a name="line-1155"></a><a name="liftHdkA"></a><span class='hs-comment'>-- Lift a HdkM computation to HdkA.</span>
<a name="line-1156"></a><span class='hs-definition'>liftHdkA</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HdkM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkA</span> <span class='hs-varid'>a</span>
<a name="line-1157"></a><span class='hs-definition'>liftHdkA</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HdkA</span> <span class='hs-varid'>mempty</span>
<a name="line-1158"></a>
<a name="line-1159"></a><a name="extendHdkA"></a><span class='hs-comment'>-- Extend the declared location span of a 'HdkA' computation:</span>
<a name="line-1160"></a><span class='hs-comment'>--</span>
<a name="line-1161"></a><span class='hs-comment'>--    left_neighbour &lt;*&gt; extendHdkA l x &lt;*&gt; right_neighbour</span>
<a name="line-1162"></a><span class='hs-comment'>--</span>
<a name="line-1163"></a><span class='hs-comment'>-- The declared location of 'x' now includes 'l', so that the surrounding</span>
<a name="line-1164"></a><span class='hs-comment'>-- computations 'left_neighbour' and 'right_neighbour' will not look for</span>
<a name="line-1165"></a><span class='hs-comment'>-- Haddock comments inside the 'l' location span.</span>
<a name="line-1166"></a><span class='hs-definition'>extendHdkA</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkA</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkA</span> <span class='hs-varid'>a</span>
<a name="line-1167"></a><span class='hs-definition'>extendHdkA</span> <span class='hs-varid'>l'</span> <span class='hs-layout'>(</span><span class='hs-conid'>HdkA</span> <span class='hs-varid'>l</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HdkA</span> <span class='hs-layout'>(</span><span class='hs-varid'>getBufSpan</span> <span class='hs-varid'>l'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span>
<a name="line-1168"></a>
<a name="line-1169"></a>
<a name="line-1170"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1171"></a>*                                                                      *
<a name="line-1172"></a>*              HdkM: a stateful computation to associate               *
<a name="line-1173"></a>*          accumulated documentation comments with AST nodes           *
<a name="line-1174"></a>*                                                                      *
<a name="line-1175"></a>********************************************************************* -}</span>
<a name="line-1176"></a>
<a name="line-1177"></a><a name="HdkM"></a><span class='hs-comment'>-- The state of 'HdkM' contains a list of pending Haddock comments. We go</span>
<a name="line-1178"></a><a name="HdkM"></a><span class='hs-comment'>-- over the AST, looking up these comments using 'takeHdkComments' and removing</span>
<a name="line-1179"></a><a name="HdkM"></a><span class='hs-comment'>-- them from the state. The remaining, un-removed ones are ignored with a</span>
<a name="line-1180"></a><a name="HdkM"></a><span class='hs-comment'>-- warning (-Winvalid-haddock). Also, using a state means we never use the same</span>
<a name="line-1181"></a><a name="HdkM"></a><span class='hs-comment'>-- Haddock twice.</span>
<a name="line-1182"></a><a name="HdkM"></a><span class='hs-comment'>--</span>
<a name="line-1183"></a><a name="HdkM"></a><span class='hs-comment'>-- See Note [Adding Haddock comments to the syntax tree].</span>
<a name="line-1184"></a><a name="HdkM"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>HdkM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HdkM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ReaderT</span> <span class='hs-conid'>LocRange</span> <span class='hs-layout'>(</span><span class='hs-conid'>State</span> <span class='hs-conid'>HdkSt</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1185"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Functor</span><span class='hs-layout'>,</span> <span class='hs-conid'>Applicative</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monad</span><span class='hs-layout'>)</span>
<a name="line-1186"></a>
<a name="line-1187"></a><a name="HdkSt"></a><span class='hs-comment'>-- | The state of HdkM.</span>
<a name="line-1188"></a><a name="HdkSt"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>HdkSt</span> <span class='hs-keyglyph'>=</span>
<a name="line-1189"></a>  <span class='hs-conid'>HdkSt</span>
<a name="line-1190"></a>    <span class='hs-layout'>{</span> <span class='hs-varid'>hdk_st_pending</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PsLocated</span> <span class='hs-conid'>HdkComment</span><span class='hs-keyglyph'>]</span>
<a name="line-1191"></a>        <span class='hs-comment'>-- a list of pending (unassociated with an AST node)</span>
<a name="line-1192"></a>        <span class='hs-comment'>-- Haddock comments, sorted by location: in ascending order of the starting 'BufPos'</span>
<a name="line-1193"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hdk_st_warnings</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>HdkWarn</span><span class='hs-keyglyph'>]</span>
<a name="line-1194"></a>        <span class='hs-comment'>-- accumulated warnings (order doesn't matter)</span>
<a name="line-1195"></a>    <span class='hs-layout'>}</span>
<a name="line-1196"></a>
<a name="line-1197"></a><a name="HdkWarn"></a><span class='hs-comment'>-- | Warnings accumulated in HdkM.</span>
<a name="line-1198"></a><a name="HdkWarn"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>HdkWarn</span>
<a name="line-1199"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HdkWarnInvalidComment</span> <span class='hs-layout'>(</span><span class='hs-conid'>PsLocated</span> <span class='hs-conid'>HdkComment</span><span class='hs-layout'>)</span>
<a name="line-1200"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HdkWarnExtraComment</span> <span class='hs-conid'>LHsDocString</span>
<a name="line-1201"></a>
<a name="line-1202"></a><a name="InlineHdkM"></a><span class='hs-comment'>-- 'HdkM' without newtype wrapping/unwrapping.</span>
<a name="line-1203"></a><a name="InlineHdkM"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>InlineHdkM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LocRange</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkSt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>HdkSt</span><span class='hs-layout'>)</span>
<a name="line-1204"></a>
<a name="line-1205"></a><a name="mkHdkM"></a><span class='hs-definition'>mkHdkM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InlineHdkM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkM</span> <span class='hs-varid'>a</span>
<a name="line-1206"></a><a name="unHdkM"></a><span class='hs-definition'>unHdkM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HdkM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InlineHdkM</span> <span class='hs-varid'>a</span>
<a name="line-1207"></a><span class='hs-definition'>mkHdkM</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coerce</span>
<a name="line-1208"></a><span class='hs-definition'>unHdkM</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coerce</span>
<a name="line-1209"></a>
<a name="line-1210"></a><a name="inLocRange"></a><span class='hs-comment'>-- Restrict the range in which a HdkM computation will look up comments:</span>
<a name="line-1211"></a><span class='hs-comment'>--</span>
<a name="line-1212"></a><span class='hs-comment'>--   inLocRange r1 $</span>
<a name="line-1213"></a><span class='hs-comment'>--   inLocRange r2 $</span>
<a name="line-1214"></a><span class='hs-comment'>--     takeHdkComments ...  -- Only takes comments in the (r1 &lt;&gt; r2) location range.</span>
<a name="line-1215"></a><span class='hs-comment'>--</span>
<a name="line-1216"></a><span class='hs-comment'>-- Note that it does not blindly override the range but tightens it using (&lt;&gt;).</span>
<a name="line-1217"></a><span class='hs-comment'>-- At many use sites, you will see something along the lines of:</span>
<a name="line-1218"></a><span class='hs-comment'>--</span>
<a name="line-1219"></a><span class='hs-comment'>--   inLocRange (locRangeTo end_pos) $ ...</span>
<a name="line-1220"></a><span class='hs-comment'>--</span>
<a name="line-1221"></a><span class='hs-comment'>-- And 'locRangeTo' defines a location range from the start of the file to</span>
<a name="line-1222"></a><span class='hs-comment'>-- 'end_pos'. This does not mean that we now search for every comment from the</span>
<a name="line-1223"></a><span class='hs-comment'>-- start of the file, as this restriction will be combined with other</span>
<a name="line-1224"></a><span class='hs-comment'>-- restrictions. Somewhere up the callstack we might have:</span>
<a name="line-1225"></a><span class='hs-comment'>--</span>
<a name="line-1226"></a><span class='hs-comment'>--   inLocRange (locRangeFrom start_pos) $ ...</span>
<a name="line-1227"></a><span class='hs-comment'>--</span>
<a name="line-1228"></a><span class='hs-comment'>-- The net result is that the location range is delimited by 'start_pos' on</span>
<a name="line-1229"></a><span class='hs-comment'>-- one side and by 'end_pos' on the other side.</span>
<a name="line-1230"></a><span class='hs-comment'>--</span>
<a name="line-1231"></a><span class='hs-comment'>-- In 'HdkA', every (&lt;*&gt;) may restrict the location range of its</span>
<a name="line-1232"></a><span class='hs-comment'>-- subcomputations.</span>
<a name="line-1233"></a><span class='hs-definition'>inLocRange</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LocRange</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkM</span> <span class='hs-varid'>a</span>
<a name="line-1234"></a><span class='hs-definition'>inLocRange</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>HdkM</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HdkM</span> <span class='hs-layout'>(</span><span class='hs-varid'>local</span> <span class='hs-layout'>(</span><span class='hs-varid'>mappend</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-1235"></a>
<a name="line-1236"></a><a name="takeHdkComments"></a><span class='hs-comment'>-- Take the Haddock comments that satisfy the matching function,</span>
<a name="line-1237"></a><span class='hs-comment'>-- leaving the rest pending.</span>
<a name="line-1238"></a><span class='hs-definition'>takeHdkComments</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span><span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>PsLocated</span> <span class='hs-conid'>HdkComment</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkM</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-1239"></a><span class='hs-definition'>takeHdkComments</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span>
<a name="line-1240"></a>  <span class='hs-varid'>mkHdkM</span> <span class='hs-varop'>$</span>
<a name="line-1241"></a>    <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>LocRange</span> <span class='hs-varid'>hdk_from</span> <span class='hs-varid'>hdk_to</span> <span class='hs-varid'>hdk_col</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1242"></a>    <span class='hs-keyglyph'>\</span><span class='hs-varid'>hdk_st</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1243"></a>      <span class='hs-keyword'>let</span>
<a name="line-1244"></a>        <span class='hs-varid'>comments</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hdk_st_pending</span> <span class='hs-varid'>hdk_st</span>
<a name="line-1245"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>comments_before_range</span><span class='hs-layout'>,</span> <span class='hs-varid'>comments'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>break</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_after</span> <span class='hs-varid'>hdk_from</span><span class='hs-layout'>)</span> <span class='hs-varid'>comments</span>
<a name="line-1246"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>comments_in_range</span><span class='hs-layout'>,</span> <span class='hs-varid'>comments_after_range</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>span</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_before</span> <span class='hs-varid'>hdk_to</span> <span class='hs-varop'>&lt;&amp;&amp;&gt;</span> <span class='hs-varid'>is_indented</span> <span class='hs-varid'>hdk_col</span><span class='hs-layout'>)</span> <span class='hs-varid'>comments'</span>
<a name="line-1247"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>items</span><span class='hs-layout'>,</span> <span class='hs-varid'>other_comments</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>add_comment</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>comments_in_range</span>
<a name="line-1248"></a>        <span class='hs-varid'>remaining_comments</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>comments_before_range</span> <span class='hs-varop'>++</span> <span class='hs-varid'>other_comments</span> <span class='hs-varop'>++</span> <span class='hs-varid'>comments_after_range</span>
<a name="line-1249"></a>        <span class='hs-varid'>hdk_st'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hdk_st</span><span class='hs-layout'>{</span> <span class='hs-varid'>hdk_st_pending</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>remaining_comments</span> <span class='hs-layout'>}</span>
<a name="line-1250"></a>      <span class='hs-keyword'>in</span>
<a name="line-1251"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>items</span><span class='hs-layout'>,</span> <span class='hs-varid'>hdk_st'</span><span class='hs-layout'>)</span>
<a name="line-1252"></a>  <span class='hs-keyword'>where</span>
<a name="line-1253"></a>    <span class='hs-varid'>is_after</span>    <span class='hs-conid'>StartOfFile</span>    <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1254"></a>    <span class='hs-varid'>is_after</span>    <span class='hs-layout'>(</span><span class='hs-conid'>StartLoc</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>   <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l_comment</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bufSpanStart</span> <span class='hs-layout'>(</span><span class='hs-varid'>psBufSpan</span> <span class='hs-varid'>l_comment</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>l</span>
<a name="line-1255"></a>    <span class='hs-varid'>is_before</span>   <span class='hs-conid'>EndOfFile</span>      <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1256"></a>    <span class='hs-varid'>is_before</span>   <span class='hs-layout'>(</span><span class='hs-conid'>EndLoc</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>     <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l_comment</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bufSpanStart</span> <span class='hs-layout'>(</span><span class='hs-varid'>psBufSpan</span> <span class='hs-varid'>l_comment</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>l</span>
<a name="line-1257"></a>    <span class='hs-varid'>is_indented</span> <span class='hs-layout'>(</span><span class='hs-conid'>ColumnFrom</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l_comment</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>srcSpanStartCol</span> <span class='hs-layout'>(</span><span class='hs-varid'>psRealSpan</span> <span class='hs-varid'>l_comment</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>n</span>
<a name="line-1258"></a>
<a name="line-1259"></a>    <span class='hs-varid'>add_comment</span>
<a name="line-1260"></a>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PsLocated</span> <span class='hs-conid'>HdkComment</span>
<a name="line-1261"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PsLocated</span> <span class='hs-conid'>HdkComment</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1262"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PsLocated</span> <span class='hs-conid'>HdkComment</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1263"></a>    <span class='hs-varid'>add_comment</span> <span class='hs-varid'>hdk_comment</span> <span class='hs-layout'>(</span><span class='hs-varid'>items</span><span class='hs-layout'>,</span> <span class='hs-varid'>other_hdk_comments</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1264"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>f</span> <span class='hs-varid'>hdk_comment</span> <span class='hs-keyword'>of</span>
<a name="line-1265"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>item</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>item</span> <span class='hs-conop'>:</span> <span class='hs-varid'>items</span><span class='hs-layout'>,</span> <span class='hs-varid'>other_hdk_comments</span><span class='hs-layout'>)</span>
<a name="line-1266"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>items</span><span class='hs-layout'>,</span> <span class='hs-varid'>hdk_comment</span> <span class='hs-conop'>:</span> <span class='hs-varid'>other_hdk_comments</span><span class='hs-layout'>)</span>
<a name="line-1267"></a>
<a name="line-1268"></a><a name="getPrevNextDoc"></a><span class='hs-comment'>-- Get the docnext or docprev comment for an AST node at the given source span.</span>
<a name="line-1269"></a><span class='hs-definition'>getPrevNextDoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>LHsDocString</span><span class='hs-layout'>)</span>
<a name="line-1270"></a><span class='hs-definition'>getPrevNextDoc</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1271"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>l_start</span><span class='hs-layout'>,</span> <span class='hs-varid'>l_end</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcSpanStart</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-varid'>srcSpanEnd</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-1272"></a>      <span class='hs-varid'>before_t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>locRangeTo</span> <span class='hs-layout'>(</span><span class='hs-varid'>getBufPos</span> <span class='hs-varid'>l_start</span><span class='hs-layout'>)</span>
<a name="line-1273"></a>      <span class='hs-varid'>after_t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>locRangeFrom</span> <span class='hs-layout'>(</span><span class='hs-varid'>getBufPos</span> <span class='hs-varid'>l_end</span><span class='hs-layout'>)</span>
<a name="line-1274"></a>  <span class='hs-varid'>nextDocs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>inLocRange</span> <span class='hs-varid'>before_t</span> <span class='hs-varop'>$</span> <span class='hs-varid'>takeHdkComments</span> <span class='hs-varid'>mkDocNext</span>
<a name="line-1275"></a>  <span class='hs-varid'>prevDocs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>inLocRange</span> <span class='hs-varid'>after_t</span> <span class='hs-varop'>$</span> <span class='hs-varid'>takeHdkComments</span> <span class='hs-varid'>mkDocPrev</span>
<a name="line-1276"></a>  <span class='hs-varid'>selectDocString</span> <span class='hs-layout'>(</span><span class='hs-varid'>nextDocs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>prevDocs</span><span class='hs-layout'>)</span>
<a name="line-1277"></a>
<a name="line-1278"></a><a name="appendHdkWarning"></a><span class='hs-definition'>appendHdkWarning</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HdkWarn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkM</span> <span class='hs-conid'>()</span>
<a name="line-1279"></a><span class='hs-definition'>appendHdkWarning</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HdkM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ReaderT</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>modify</span> <span class='hs-varid'>append_warn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1280"></a>  <span class='hs-keyword'>where</span>
<a name="line-1281"></a>    <span class='hs-varid'>append_warn</span> <span class='hs-varid'>hdk_st</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hdk_st</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hdk_st_warnings</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>e</span> <span class='hs-conop'>:</span> <span class='hs-varid'>hdk_st_warnings</span> <span class='hs-varid'>hdk_st</span> <span class='hs-layout'>}</span>
<a name="line-1282"></a>
<a name="line-1283"></a><a name="selectDocString"></a><span class='hs-definition'>selectDocString</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDocString</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>LHsDocString</span><span class='hs-layout'>)</span>
<a name="line-1284"></a><span class='hs-definition'>selectDocString</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>select</span> <span class='hs-varop'>.</span> <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyDocString</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span>
<a name="line-1285"></a>  <span class='hs-keyword'>where</span>
<a name="line-1286"></a>    <span class='hs-varid'>select</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-1287"></a>    <span class='hs-varid'>select</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>doc</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>
<a name="line-1288"></a>    <span class='hs-varid'>select</span> <span class='hs-layout'>(</span><span class='hs-varid'>doc</span> <span class='hs-conop'>:</span> <span class='hs-varid'>extra_docs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1289"></a>      <span class='hs-varid'>reportExtraDocs</span> <span class='hs-varid'>extra_docs</span>
<a name="line-1290"></a>      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>
<a name="line-1291"></a>
<a name="line-1292"></a><a name="reportExtraDocs"></a><span class='hs-definition'>reportExtraDocs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDocString</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HdkM</span> <span class='hs-conid'>()</span>
<a name="line-1293"></a><span class='hs-definition'>reportExtraDocs</span> <span class='hs-keyglyph'>=</span>
<a name="line-1294"></a>  <span class='hs-varid'>traverse_</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>extra_doc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>appendHdkWarning</span> <span class='hs-layout'>(</span><span class='hs-conid'>HdkWarnExtraComment</span> <span class='hs-varid'>extra_doc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1295"></a>
<a name="line-1296"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1297"></a>*                                                                      *
<a name="line-1298"></a>*      Matching functions for extracting documentation comments        *
<a name="line-1299"></a>*                                                                      *
<a name="line-1300"></a>********************************************************************* -}</span>
<a name="line-1301"></a>
<a name="line-1302"></a><a name="mkDocHsDecl"></a><span class='hs-definition'>mkDocHsDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LayoutInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PsLocated</span> <span class='hs-conid'>HdkComment</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-1303"></a><span class='hs-definition'>mkDocHsDecl</span> <span class='hs-varid'>layout_info</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>DocD</span> <span class='hs-varid'>noExtField</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>mkDocDecl</span> <span class='hs-varid'>layout_info</span> <span class='hs-varid'>a</span>
<a name="line-1304"></a>
<a name="line-1305"></a><a name="mkDocDecl"></a><span class='hs-definition'>mkDocDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LayoutInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PsLocated</span> <span class='hs-conid'>HdkComment</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LDocDecl</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-1306"></a><span class='hs-definition'>mkDocDecl</span> <span class='hs-varid'>layout_info</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l_comment</span> <span class='hs-varid'>hdk_comment</span><span class='hs-layout'>)</span>
<a name="line-1307"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>indent_mismatch</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1308"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span>
<a name="line-1309"></a>    <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-layout'>(</span><span class='hs-varid'>noAnnSrcSpan</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkSrcSpanPs</span> <span class='hs-varid'>l_comment</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1310"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>hdk_comment</span> <span class='hs-keyword'>of</span>
<a name="line-1311"></a>        <span class='hs-conid'>HdkCommentNext</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DocCommentNext</span> <span class='hs-varid'>doc</span>
<a name="line-1312"></a>        <span class='hs-conid'>HdkCommentPrev</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DocCommentPrev</span> <span class='hs-varid'>doc</span>
<a name="line-1313"></a>        <span class='hs-conid'>HdkCommentNamed</span> <span class='hs-varid'>s</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DocCommentNamed</span> <span class='hs-varid'>s</span> <span class='hs-varid'>doc</span>
<a name="line-1314"></a>        <span class='hs-conid'>HdkCommentSection</span> <span class='hs-varid'>n</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DocGroup</span> <span class='hs-varid'>n</span> <span class='hs-varid'>doc</span>
<a name="line-1315"></a>  <span class='hs-keyword'>where</span>
<a name="line-1316"></a>    <span class='hs-comment'>--  'indent_mismatch' checks if the documentation comment has the exact</span>
<a name="line-1317"></a>    <span class='hs-comment'>--  indentation level expected by the parent node.</span>
<a name="line-1318"></a>    <span class='hs-comment'>--</span>
<a name="line-1319"></a>    <span class='hs-comment'>--  For example, when extracting documentation comments between class</span>
<a name="line-1320"></a>    <span class='hs-comment'>--  method declarations, there are three cases to consider:</span>
<a name="line-1321"></a>    <span class='hs-comment'>--</span>
<a name="line-1322"></a>    <span class='hs-comment'>--  1. Indent matches (indent_mismatch=False):</span>
<a name="line-1323"></a>    <span class='hs-comment'>--         class C a where</span>
<a name="line-1324"></a>    <span class='hs-comment'>--           f :: a -&gt; a</span>
<a name="line-1325"></a>    <span class='hs-comment'>--           -- ^ doc on f</span>
<a name="line-1326"></a>    <span class='hs-comment'>--</span>
<a name="line-1327"></a>    <span class='hs-comment'>--  2. Indented too much (indent_mismatch=True):</span>
<a name="line-1328"></a>    <span class='hs-comment'>--         class C a where</span>
<a name="line-1329"></a>    <span class='hs-comment'>--           f :: a -&gt; a</span>
<a name="line-1330"></a>    <span class='hs-comment'>--             -- ^ indent mismatch</span>
<a name="line-1331"></a>    <span class='hs-comment'>--</span>
<a name="line-1332"></a>    <span class='hs-comment'>--  3. Indented too little (indent_mismatch=True):</span>
<a name="line-1333"></a>    <span class='hs-comment'>--         class C a where</span>
<a name="line-1334"></a>    <span class='hs-comment'>--           f :: a -&gt; a</span>
<a name="line-1335"></a>    <span class='hs-comment'>--         -- ^ indent mismatch</span>
<a name="line-1336"></a>    <span class='hs-varid'>indent_mismatch</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>layout_info</span> <span class='hs-keyword'>of</span>
<a name="line-1337"></a>      <span class='hs-conid'>NoLayoutInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1338"></a>      <span class='hs-conid'>ExplicitBraces</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1339"></a>      <span class='hs-conid'>VirtualBraces</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>n</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>srcSpanStartCol</span> <span class='hs-layout'>(</span><span class='hs-varid'>psRealSpan</span> <span class='hs-varid'>l_comment</span><span class='hs-layout'>)</span>
<a name="line-1340"></a>
<a name="line-1341"></a><a name="mkDocIE"></a><span class='hs-definition'>mkDocIE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PsLocated</span> <span class='hs-conid'>HdkComment</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LIE</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-1342"></a><span class='hs-definition'>mkDocIE</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l_comment</span> <span class='hs-varid'>hdk_comment</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1343"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>hdk_comment</span> <span class='hs-keyword'>of</span>
<a name="line-1344"></a>    <span class='hs-conid'>HdkCommentSection</span> <span class='hs-varid'>n</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEGroup</span> <span class='hs-varid'>noExtField</span> <span class='hs-varid'>n</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>
<a name="line-1345"></a>    <span class='hs-conid'>HdkCommentNamed</span> <span class='hs-varid'>s</span> <span class='hs-sel'>_doc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEDocNamed</span> <span class='hs-varid'>noExtField</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-1346"></a>    <span class='hs-conid'>HdkCommentNext</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEDoc</span> <span class='hs-varid'>noExtField</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>
<a name="line-1347"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1348"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noAnnSrcSpan</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkSrcSpanPs</span> <span class='hs-varid'>l_comment</span>
<a name="line-1349"></a>
<a name="line-1350"></a><a name="mkDocNext"></a><span class='hs-definition'>mkDocNext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PsLocated</span> <span class='hs-conid'>HdkComment</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>LHsDocString</span>
<a name="line-1351"></a><span class='hs-definition'>mkDocNext</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>HdkCommentNext</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSrcSpanPs</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varid'>doc</span>
<a name="line-1352"></a><span class='hs-definition'>mkDocNext</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1353"></a>
<a name="line-1354"></a><a name="mkDocPrev"></a><span class='hs-definition'>mkDocPrev</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PsLocated</span> <span class='hs-conid'>HdkComment</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>LHsDocString</span>
<a name="line-1355"></a><span class='hs-definition'>mkDocPrev</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>HdkCommentPrev</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSrcSpanPs</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varid'>doc</span>
<a name="line-1356"></a><span class='hs-definition'>mkDocPrev</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1357"></a>
<a name="line-1358"></a>
<a name="line-1359"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1360"></a>*                                                                      *
<a name="line-1361"></a>*                   LocRange: a location range                         *
<a name="line-1362"></a>*                                                                      *
<a name="line-1363"></a>********************************************************************* -}</span>
<a name="line-1364"></a>
<a name="line-1365"></a><a name="LocRange"></a><span class='hs-comment'>-- A location range for extracting documentation comments.</span>
<a name="line-1366"></a><a name="LocRange"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>LocRange</span> <span class='hs-keyglyph'>=</span>
<a name="line-1367"></a>  <span class='hs-conid'>LocRange</span>
<a name="line-1368"></a>    <span class='hs-layout'>{</span> <span class='hs-varid'>loc_range_from</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>LowerLocBound</span><span class='hs-layout'>,</span>
<a name="line-1369"></a>      <span class='hs-varid'>loc_range_to</span>   <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>UpperLocBound</span><span class='hs-layout'>,</span>
<a name="line-1370"></a>      <span class='hs-varid'>loc_range_col</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>ColumnBound</span> <span class='hs-layout'>}</span>
<a name="line-1371"></a>
<a name="line-1372"></a><a name="instance%20Semigroup%20LocRange"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Semigroup</span> <span class='hs-conid'>LocRange</span> <span class='hs-keyword'>where</span>
<a name="line-1373"></a>  <span class='hs-conid'>LocRange</span> <span class='hs-varid'>from1</span> <span class='hs-varid'>to1</span> <span class='hs-varid'>col1</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-conid'>LocRange</span> <span class='hs-varid'>from2</span> <span class='hs-varid'>to2</span> <span class='hs-varid'>col2</span> <span class='hs-keyglyph'>=</span>
<a name="line-1374"></a>    <span class='hs-conid'>LocRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>from1</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>from2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>to1</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>to2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>col1</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>col2</span><span class='hs-layout'>)</span>
<a name="line-1375"></a>
<a name="line-1376"></a><a name="instance%20Monoid%20LocRange"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monoid</span> <span class='hs-conid'>LocRange</span> <span class='hs-keyword'>where</span>
<a name="line-1377"></a>  <span class='hs-varid'>mempty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LocRange</span> <span class='hs-varid'>mempty</span> <span class='hs-varid'>mempty</span> <span class='hs-varid'>mempty</span>
<a name="line-1378"></a>
<a name="line-1379"></a><a name="locRangeFrom"></a><span class='hs-comment'>-- The location range from the specified position to the end of the file.</span>
<a name="line-1380"></a><span class='hs-definition'>locRangeFrom</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>BufPos</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LocRange</span>
<a name="line-1381"></a><span class='hs-definition'>locRangeFrom</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mempty</span> <span class='hs-layout'>{</span> <span class='hs-varid'>loc_range_from</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StartLoc</span> <span class='hs-varid'>l</span> <span class='hs-layout'>}</span>
<a name="line-1382"></a><span class='hs-definition'>locRangeFrom</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mempty</span>
<a name="line-1383"></a>
<a name="line-1384"></a><a name="locRangeTo"></a><span class='hs-comment'>-- The location range from the start of the file to the specified position.</span>
<a name="line-1385"></a><span class='hs-definition'>locRangeTo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>BufPos</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LocRange</span>
<a name="line-1386"></a><span class='hs-definition'>locRangeTo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mempty</span> <span class='hs-layout'>{</span> <span class='hs-varid'>loc_range_to</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EndLoc</span> <span class='hs-varid'>l</span> <span class='hs-layout'>}</span>
<a name="line-1387"></a><span class='hs-definition'>locRangeTo</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mempty</span>
<a name="line-1388"></a>
<a name="line-1389"></a><a name="LowerLocBound"></a><span class='hs-comment'>-- Represents a predicate on BufPos:</span>
<a name="line-1390"></a><a name="LowerLocBound"></a><span class='hs-comment'>--</span>
<a name="line-1391"></a><a name="LowerLocBound"></a><span class='hs-comment'>--   LowerLocBound |   BufPos -&gt; Bool</span>
<a name="line-1392"></a><a name="LowerLocBound"></a><span class='hs-comment'>--   --------------+-----------------</span>
<a name="line-1393"></a><a name="LowerLocBound"></a><span class='hs-comment'>--   StartOfFile   |   const True</span>
<a name="line-1394"></a><a name="LowerLocBound"></a><span class='hs-comment'>--   StartLoc p    |   (&gt;= p)</span>
<a name="line-1395"></a><a name="LowerLocBound"></a><span class='hs-comment'>--</span>
<a name="line-1396"></a><a name="LowerLocBound"></a><span class='hs-comment'>--  The semigroup instance corresponds to (&amp;&amp;).</span>
<a name="line-1397"></a><a name="LowerLocBound"></a><span class='hs-comment'>--</span>
<a name="line-1398"></a><a name="LowerLocBound"></a><span class='hs-comment'>--  We don't use the  BufPos -&gt; Bool  representation</span>
<a name="line-1399"></a><a name="LowerLocBound"></a><span class='hs-comment'>--  as it would lead to redundant checks.</span>
<a name="line-1400"></a><a name="LowerLocBound"></a><span class='hs-comment'>--</span>
<a name="line-1401"></a><a name="LowerLocBound"></a><span class='hs-comment'>--  That is, instead of</span>
<a name="line-1402"></a><a name="LowerLocBound"></a><span class='hs-comment'>--</span>
<a name="line-1403"></a><a name="LowerLocBound"></a><span class='hs-comment'>--      (pos &gt;= 20) &amp;&amp; (pos &gt;= 30) &amp;&amp; (pos &gt;= 40)</span>
<a name="line-1404"></a><a name="LowerLocBound"></a><span class='hs-comment'>--</span>
<a name="line-1405"></a><a name="LowerLocBound"></a><span class='hs-comment'>--  We'd rather only do the (&gt;=40) check. So we reify the predicate to make</span>
<a name="line-1406"></a><a name="LowerLocBound"></a><span class='hs-comment'>--  sure we only check for the most restrictive bound.</span>
<a name="line-1407"></a><a name="LowerLocBound"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>LowerLocBound</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StartOfFile</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StartLoc</span> <span class='hs-varop'>!</span><span class='hs-conid'>BufPos</span>
<a name="line-1408"></a>
<a name="line-1409"></a><a name="instance%20Semigroup%20LowerLocBound"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Semigroup</span> <span class='hs-conid'>LowerLocBound</span> <span class='hs-keyword'>where</span>
<a name="line-1410"></a>  <span class='hs-conid'>StartOfFile</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l</span>
<a name="line-1411"></a>  <span class='hs-varid'>l</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-conid'>StartOfFile</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l</span>
<a name="line-1412"></a>  <span class='hs-conid'>StartLoc</span> <span class='hs-varid'>l1</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-conid'>StartLoc</span> <span class='hs-varid'>l2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StartLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>max</span> <span class='hs-varid'>l1</span> <span class='hs-varid'>l2</span><span class='hs-layout'>)</span>
<a name="line-1413"></a>
<a name="line-1414"></a><a name="instance%20Monoid%20LowerLocBound"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monoid</span> <span class='hs-conid'>LowerLocBound</span> <span class='hs-keyword'>where</span>
<a name="line-1415"></a>  <span class='hs-varid'>mempty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StartOfFile</span>
<a name="line-1416"></a>
<a name="line-1417"></a><a name="UpperLocBound"></a><span class='hs-comment'>-- Represents a predicate on BufPos:</span>
<a name="line-1418"></a><a name="UpperLocBound"></a><span class='hs-comment'>--</span>
<a name="line-1419"></a><a name="UpperLocBound"></a><span class='hs-comment'>--   UpperLocBound |   BufPos -&gt; Bool</span>
<a name="line-1420"></a><a name="UpperLocBound"></a><span class='hs-comment'>--   --------------+-----------------</span>
<a name="line-1421"></a><a name="UpperLocBound"></a><span class='hs-comment'>--   EndOfFile     |   const True</span>
<a name="line-1422"></a><a name="UpperLocBound"></a><span class='hs-comment'>--   EndLoc p      |   (&lt;= p)</span>
<a name="line-1423"></a><a name="UpperLocBound"></a><span class='hs-comment'>--</span>
<a name="line-1424"></a><a name="UpperLocBound"></a><span class='hs-comment'>--  The semigroup instance corresponds to (&amp;&amp;).</span>
<a name="line-1425"></a><a name="UpperLocBound"></a><span class='hs-comment'>--</span>
<a name="line-1426"></a><a name="UpperLocBound"></a><span class='hs-comment'>--  We don't use the  BufPos -&gt; Bool  representation</span>
<a name="line-1427"></a><a name="UpperLocBound"></a><span class='hs-comment'>--  as it would lead to redundant checks.</span>
<a name="line-1428"></a><a name="UpperLocBound"></a><span class='hs-comment'>--</span>
<a name="line-1429"></a><a name="UpperLocBound"></a><span class='hs-comment'>--  That is, instead of</span>
<a name="line-1430"></a><a name="UpperLocBound"></a><span class='hs-comment'>--</span>
<a name="line-1431"></a><a name="UpperLocBound"></a><span class='hs-comment'>--      (pos &lt;= 40) &amp;&amp; (pos &lt;= 30) &amp;&amp; (pos &lt;= 20)</span>
<a name="line-1432"></a><a name="UpperLocBound"></a><span class='hs-comment'>--</span>
<a name="line-1433"></a><a name="UpperLocBound"></a><span class='hs-comment'>--  We'd rather only do the (&lt;=20) check. So we reify the predicate to make</span>
<a name="line-1434"></a><a name="UpperLocBound"></a><span class='hs-comment'>--  sure we only check for the most restrictive bound.</span>
<a name="line-1435"></a><a name="UpperLocBound"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>UpperLocBound</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EndOfFile</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EndLoc</span> <span class='hs-varop'>!</span><span class='hs-conid'>BufPos</span>
<a name="line-1436"></a>
<a name="line-1437"></a><a name="instance%20Semigroup%20UpperLocBound"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Semigroup</span> <span class='hs-conid'>UpperLocBound</span> <span class='hs-keyword'>where</span>
<a name="line-1438"></a>  <span class='hs-conid'>EndOfFile</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l</span>
<a name="line-1439"></a>  <span class='hs-varid'>l</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-conid'>EndOfFile</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l</span>
<a name="line-1440"></a>  <span class='hs-conid'>EndLoc</span> <span class='hs-varid'>l1</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-conid'>EndLoc</span> <span class='hs-varid'>l2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EndLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>min</span> <span class='hs-varid'>l1</span> <span class='hs-varid'>l2</span><span class='hs-layout'>)</span>
<a name="line-1441"></a>
<a name="line-1442"></a><a name="instance%20Monoid%20UpperLocBound"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monoid</span> <span class='hs-conid'>UpperLocBound</span> <span class='hs-keyword'>where</span>
<a name="line-1443"></a>  <span class='hs-varid'>mempty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EndOfFile</span>
<a name="line-1444"></a>
<a name="line-1445"></a><a name="ColumnBound"></a><span class='hs-comment'>-- | Represents a predicate on the column number.</span>
<a name="line-1446"></a><a name="ColumnBound"></a><span class='hs-comment'>--</span>
<a name="line-1447"></a><a name="ColumnBound"></a><span class='hs-comment'>--   ColumnBound   |   Int -&gt; Bool</span>
<a name="line-1448"></a><a name="ColumnBound"></a><span class='hs-comment'>--   --------------+-----------------</span>
<a name="line-1449"></a><a name="ColumnBound"></a><span class='hs-comment'>--   ColumnFrom n  |   (&gt;=n)</span>
<a name="line-1450"></a><a name="ColumnBound"></a><span class='hs-comment'>--</span>
<a name="line-1451"></a><a name="ColumnBound"></a><span class='hs-comment'>--  The semigroup instance corresponds to (&amp;&amp;).</span>
<a name="line-1452"></a><a name="ColumnBound"></a><span class='hs-comment'>--</span>
<a name="line-1453"></a><a name="ColumnBound"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>ColumnBound</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ColumnFrom</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- n &gt;= GHC.Types.SrcLoc.leftmostColumn</span>
<a name="line-1454"></a>
<a name="line-1455"></a><a name="instance%20Semigroup%20ColumnBound"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Semigroup</span> <span class='hs-conid'>ColumnBound</span> <span class='hs-keyword'>where</span>
<a name="line-1456"></a>  <span class='hs-conid'>ColumnFrom</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-conid'>ColumnFrom</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ColumnFrom</span> <span class='hs-layout'>(</span><span class='hs-varid'>max</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-1457"></a>
<a name="line-1458"></a><a name="instance%20Monoid%20ColumnBound"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monoid</span> <span class='hs-conid'>ColumnBound</span> <span class='hs-keyword'>where</span>
<a name="line-1459"></a>  <span class='hs-varid'>mempty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ColumnFrom</span> <span class='hs-varid'>leftmostColumn</span>
<a name="line-1460"></a>
<a name="line-1461"></a>
<a name="line-1462"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1463"></a>*                                                                      *
<a name="line-1464"></a>*                   AST manipulation utilities                         *
<a name="line-1465"></a>*                                                                      *
<a name="line-1466"></a>********************************************************************* -}</span>
<a name="line-1467"></a>
<a name="line-1468"></a><a name="mkLHsDocTy"></a><span class='hs-definition'>mkLHsDocTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcPs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>LHsDocString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcPs</span>
<a name="line-1469"></a><span class='hs-definition'>mkLHsDocTy</span> <span class='hs-varid'>t</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span>
<a name="line-1470"></a><span class='hs-definition'>mkLHsDocTy</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDocTy</span> <span class='hs-varid'>noAnn</span> <span class='hs-varid'>t</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>
<a name="line-1471"></a>
<a name="line-1472"></a><a name="getForAllTeleLoc"></a><span class='hs-definition'>getForAllTeleLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsForAllTelescope</span> <span class='hs-conid'>GhcPs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-1473"></a><span class='hs-definition'>getForAllTeleLoc</span> <span class='hs-varid'>tele</span> <span class='hs-keyglyph'>=</span>
<a name="line-1474"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>tele</span> <span class='hs-keyword'>of</span>
<a name="line-1475"></a>    <span class='hs-conid'>HsForAllVis</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsf_vis_bndrs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>getLHsTyVarBndrsLoc</span> <span class='hs-varid'>hsf_vis_bndrs</span>
<a name="line-1476"></a>    <span class='hs-conid'>HsForAllInvis</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsf_invis_bndrs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>getLHsTyVarBndrsLoc</span> <span class='hs-varid'>hsf_invis_bndrs</span>
<a name="line-1477"></a>
<a name="line-1478"></a><a name="getLHsTyVarBndrsLoc"></a><span class='hs-definition'>getLHsTyVarBndrsLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-varid'>flag</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-1479"></a><span class='hs-definition'>getLHsTyVarBndrsLoc</span> <span class='hs-varid'>bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>combineSrcSpans</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>getLocA</span> <span class='hs-varid'>bndrs</span>
<a name="line-1480"></a>
<a name="line-1481"></a><a name="flattenBindsAndSigs"></a><span class='hs-comment'>-- | The inverse of 'partitionBindsAndSigs' that merges partitioned items back</span>
<a name="line-1482"></a><span class='hs-comment'>-- into a flat list. Elements are put back into the order in which they</span>
<a name="line-1483"></a><span class='hs-comment'>-- appeared in the original program before partitioning, using BufPos to order</span>
<a name="line-1484"></a><span class='hs-comment'>-- them.</span>
<a name="line-1485"></a><span class='hs-comment'>--</span>
<a name="line-1486"></a><span class='hs-comment'>-- Precondition (unchecked): the input lists are already sorted.</span>
<a name="line-1487"></a><span class='hs-definition'>flattenBindsAndSigs</span>
<a name="line-1488"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LFamilyDecl</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-1489"></a>      <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTyFamInstDecl</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LDataFamInstDecl</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LDocDecl</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1490"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span>
<a name="line-1491"></a><span class='hs-definition'>flattenBindsAndSigs</span> <span class='hs-layout'>(</span><span class='hs-varid'>all_bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>all_ss</span><span class='hs-layout'>,</span> <span class='hs-varid'>all_ts</span><span class='hs-layout'>,</span> <span class='hs-varid'>all_tfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>all_dfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>all_docs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1492"></a>  <span class='hs-comment'>-- 'cmpBufSpan' is safe here with the following assumptions:</span>
<a name="line-1493"></a>  <span class='hs-comment'>--</span>
<a name="line-1494"></a>  <span class='hs-comment'>-- - 'LHsDecl' produced by 'decl_cls' in Parser.y always have a 'BufSpan'</span>
<a name="line-1495"></a>  <span class='hs-comment'>-- - 'partitionBindsAndSigs' does not discard this 'BufSpan'</span>
<a name="line-1496"></a>  <span class='hs-varid'>mergeListsBy</span> <span class='hs-varid'>cmpBufSpanA</span> <span class='hs-keyglyph'>[</span>
<a name="line-1497"></a>    <span class='hs-varid'>mapLL</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ValD</span> <span class='hs-varid'>noExtField</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>all_bs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-1498"></a>    <span class='hs-varid'>mapLL</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SigD</span> <span class='hs-varid'>noExtField</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varid'>all_ss</span><span class='hs-layout'>,</span>
<a name="line-1499"></a>    <span class='hs-varid'>mapLL</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>t</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyClD</span> <span class='hs-varid'>noExtField</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamDecl</span> <span class='hs-varid'>noExtField</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>all_ts</span><span class='hs-layout'>,</span>
<a name="line-1500"></a>    <span class='hs-varid'>mapLL</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>tfi</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InstD</span> <span class='hs-varid'>noExtField</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyFamInstD</span> <span class='hs-varid'>noExtField</span> <span class='hs-varid'>tfi</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>all_tfis</span><span class='hs-layout'>,</span>
<a name="line-1501"></a>    <span class='hs-varid'>mapLL</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>dfi</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InstD</span> <span class='hs-varid'>noExtField</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataFamInstD</span> <span class='hs-varid'>noAnn</span> <span class='hs-varid'>dfi</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>all_dfis</span><span class='hs-layout'>,</span>
<a name="line-1502"></a>    <span class='hs-varid'>mapLL</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>d</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DocD</span> <span class='hs-varid'>noExtField</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varid'>all_docs</span>
<a name="line-1503"></a>  <span class='hs-keyglyph'>]</span>
<a name="line-1504"></a>
<a name="line-1505"></a><a name="cmpBufSpanA"></a><span class='hs-definition'>cmpBufSpanA</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GenLocated</span> <span class='hs-layout'>(</span><span class='hs-conid'>SrcSpanAnn'</span> <span class='hs-varid'>a1</span><span class='hs-layout'>)</span> <span class='hs-varid'>a2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GenLocated</span> <span class='hs-layout'>(</span><span class='hs-conid'>SrcSpanAnn'</span> <span class='hs-varid'>a3</span><span class='hs-layout'>)</span> <span class='hs-varid'>a2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ordering</span>
<a name="line-1506"></a><span class='hs-definition'>cmpBufSpanA</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>la</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>lb</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmpBufSpan</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>la</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>lb</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-1507"></a>
<a name="line-1508"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1509"></a>*                                                                      *
<a name="line-1510"></a>*                   General purpose utilities                          *
<a name="line-1511"></a>*                                                                      *
<a name="line-1512"></a>********************************************************************* -}</span>
<a name="line-1513"></a>
<a name="line-1514"></a><a name="mcons"></a><span class='hs-comment'>-- Cons an element to a list, if exists.</span>
<a name="line-1515"></a><span class='hs-definition'>mcons</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-1516"></a><span class='hs-definition'>mcons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybe</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span>
<a name="line-1517"></a>
<a name="line-1518"></a><a name="mapLL"></a><span class='hs-comment'>-- Map a function over a list of located items.</span>
<a name="line-1519"></a><span class='hs-definition'>mapLL</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GenLocated</span> <span class='hs-varid'>l</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GenLocated</span> <span class='hs-varid'>l</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span>
<a name="line-1520"></a><span class='hs-definition'>mapLL</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapLoc</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>
<a name="line-1521"></a>
<a name="line-1522"></a><span class='hs-comment'>{- Note [Old solution: Haddock in the grammar]
<a name="line-1523"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1524"></a>In the past, Haddock comments were incorporated into the grammar (Parser.y).
<a name="line-1525"></a>This led to excessive complexity and duplication.
<a name="line-1526"></a>
<a name="line-1527"></a>For example, here's the grammar production for types without documentation:
<a name="line-1528"></a>
<a name="line-1529"></a>  type : btype
<a name="line-1530"></a>       | btype '-&gt;' ctype
<a name="line-1531"></a>
<a name="line-1532"></a>To support Haddock, we had to also maintain an additional grammar production
<a name="line-1533"></a>for types with documentation on function arguments and function result:
<a name="line-1534"></a>
<a name="line-1535"></a>  typedoc : btype
<a name="line-1536"></a>          | btype docprev
<a name="line-1537"></a>          | docnext btype
<a name="line-1538"></a>          | btype '-&gt;'     ctypedoc
<a name="line-1539"></a>          | btype docprev '-&gt;' ctypedoc
<a name="line-1540"></a>          | docnext btype '-&gt;' ctypedoc
<a name="line-1541"></a>
<a name="line-1542"></a>Sometimes handling documentation comments during parsing led to bugs (#17561),
<a name="line-1543"></a>and sometimes it simply made it hard to modify and extend the grammar.
<a name="line-1544"></a>
<a name="line-1545"></a>Another issue was that sometimes Haddock would fail to parse code
<a name="line-1546"></a>that GHC could parse successfully:
<a name="line-1547"></a>
<a name="line-1548"></a>  class BadIndent where
<a name="line-1549"></a>    f :: a -&gt; Int
<a name="line-1550"></a>  -- ^ comment
<a name="line-1551"></a>    g :: a -&gt; Int
<a name="line-1552"></a>
<a name="line-1553"></a>This declaration was accepted by ghc but rejected by ghc -haddock.
<a name="line-1554"></a>-}</span>
<a name="line-1555"></a>
<a name="line-1556"></a><span class='hs-comment'>{- Note [Register keyword location]
<a name="line-1557"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1558"></a>At the moment, 'addHaddock' erroneously associates some comments with
<a name="line-1559"></a>constructs that are separated by a keyword. For example:
<a name="line-1560"></a>
<a name="line-1561"></a>    data Foo -- | Comment for MkFoo
<a name="line-1562"></a>      where MkFoo :: Foo
<a name="line-1563"></a>
<a name="line-1564"></a>The issue stems from the lack of location information for keywords. We could
<a name="line-1565"></a>utilize API Annotations for this purpose, but not without modification. For
<a name="line-1566"></a>example, API Annotations operate on RealSrcSpan, whereas we need BufSpan.
<a name="line-1567"></a>
<a name="line-1568"></a>Also, there's work towards making API Annotations available in-tree (not in
<a name="line-1569"></a>a separate Map), see #17638. This change should make the fix very easy (it
<a name="line-1570"></a>is not as easy with the current design).
<a name="line-1571"></a>
<a name="line-1572"></a>See also testsuite/tests/haddock/should_compile_flag_haddock/T17544_kw.hs
<a name="line-1573"></a>-}</span>
</pre></body>
</html>
