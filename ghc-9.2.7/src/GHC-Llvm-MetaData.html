<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Llvm/MetaData.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Llvm.MetaData</span> <span class='hs-keyword'>where</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Llvm.Types</span>
<a name="line-8"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-comment'>-- The LLVM Metadata System.</span>
<a name="line-11"></a><span class='hs-comment'>--</span>
<a name="line-12"></a><span class='hs-comment'>-- The LLVM metadata feature is poorly documented but roughly follows the</span>
<a name="line-13"></a><span class='hs-comment'>-- following design:</span>
<a name="line-14"></a><span class='hs-comment'>-- - Metadata can be constructed in a few different ways (See below).</span>
<a name="line-15"></a><span class='hs-comment'>-- - After which it can either be attached to LLVM statements to pass along</span>
<a name="line-16"></a><span class='hs-comment'>-- extra information to the optimizer and code generator OR specifically named</span>
<a name="line-17"></a><span class='hs-comment'>-- metadata has an affect on the whole module (i.e., linking behaviour).</span>
<a name="line-18"></a><span class='hs-comment'>--</span>
<a name="line-19"></a><span class='hs-comment'>--</span>
<a name="line-20"></a><span class='hs-comment'>-- # Constructing metadata</span>
<a name="line-21"></a><span class='hs-comment'>-- Metadata comes largely in three forms:</span>
<a name="line-22"></a><span class='hs-comment'>--</span>
<a name="line-23"></a><span class='hs-comment'>-- - Metadata expressions -- these are the raw metadata values that encode</span>
<a name="line-24"></a><span class='hs-comment'>--   information. They consist of metadata strings, metadata nodes, regular</span>
<a name="line-25"></a><span class='hs-comment'>--   LLVM values (both literals and references to global variables) and</span>
<a name="line-26"></a><span class='hs-comment'>--   metadata expressions (i.e., recursive data type). Some examples:</span>
<a name="line-27"></a><span class='hs-comment'>--     !{ !"hello", !0, i32 0 }</span>
<a name="line-28"></a><span class='hs-comment'>--     !{ !1, !{ i32 0 } }</span>
<a name="line-29"></a><span class='hs-comment'>--</span>
<a name="line-30"></a><span class='hs-comment'>-- - Metadata nodes -- global metadata variables that attach a metadata</span>
<a name="line-31"></a><span class='hs-comment'>--   expression to a number. For example:</span>
<a name="line-32"></a><span class='hs-comment'>--     !0 = !{ [&lt;metadata expressions&gt;] !}</span>
<a name="line-33"></a><span class='hs-comment'>--</span>
<a name="line-34"></a><span class='hs-comment'>-- - Named metadata -- global metadata variables that attach a metadata nodes</span>
<a name="line-35"></a><span class='hs-comment'>--   to a name. Used ONLY to communicated module level information to LLVM</span>
<a name="line-36"></a><span class='hs-comment'>--   through a meaningful name. For example:</span>
<a name="line-37"></a><span class='hs-comment'>--     !llvm.module.linkage = !{ !0, !1 }</span>
<a name="line-38"></a><span class='hs-comment'>--</span>
<a name="line-39"></a><span class='hs-comment'>--</span>
<a name="line-40"></a><span class='hs-comment'>-- # Using Metadata</span>
<a name="line-41"></a><span class='hs-comment'>-- Using metadata depends on the form it is in:</span>
<a name="line-42"></a><span class='hs-comment'>--</span>
<a name="line-43"></a><span class='hs-comment'>-- - Attach to instructions -- metadata can be attached to LLVM instructions</span>
<a name="line-44"></a><span class='hs-comment'>--   using a specific reference as follows:</span>
<a name="line-45"></a><span class='hs-comment'>--     %l = load i32* @glob, !nontemporal !10</span>
<a name="line-46"></a><span class='hs-comment'>--     %m = load i32* @glob, !nontemporal !{ i32 0, !{ i32 0 } }</span>
<a name="line-47"></a><span class='hs-comment'>--   Only metadata nodes or expressions can be attached, named metadata cannot.</span>
<a name="line-48"></a><span class='hs-comment'>--   Refer to LLVM documentation for which instructions take metadata and its</span>
<a name="line-49"></a><span class='hs-comment'>--   meaning.</span>
<a name="line-50"></a><span class='hs-comment'>--</span>
<a name="line-51"></a><span class='hs-comment'>-- - As arguments -- llvm functions can take metadata as arguments, for</span>
<a name="line-52"></a><span class='hs-comment'>--   example:</span>
<a name="line-53"></a><span class='hs-comment'>--     call void @llvm.dbg.value(metadata !{ i32 0 }, i64 0, metadata !1)</span>
<a name="line-54"></a><span class='hs-comment'>--   As with instructions, only metadata nodes or expressions can be attached.</span>
<a name="line-55"></a><span class='hs-comment'>--</span>
<a name="line-56"></a><span class='hs-comment'>-- - As a named metadata -- Here the metadata is simply declared in global</span>
<a name="line-57"></a><span class='hs-comment'>--   scope using a specific name to communicate module level information to LLVM.</span>
<a name="line-58"></a><span class='hs-comment'>--   For example:</span>
<a name="line-59"></a><span class='hs-comment'>--     !llvm.module.linkage = !{ !0, !1 }</span>
<a name="line-60"></a><span class='hs-comment'>--</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="MetaId"></a><span class='hs-comment'>-- | A reference to an un-named metadata node.</span>
<a name="line-63"></a><a name="MetaId"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>MetaId</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MetaId</span> <span class='hs-conid'>Int</span>
<a name="line-64"></a>               <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span><span class='hs-layout'>,</span> <span class='hs-conid'>Enum</span><span class='hs-layout'>)</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="instance%20Outputable%20MetaId"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>MetaId</span> <span class='hs-keyword'>where</span>
<a name="line-67"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>MetaId</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'!'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n</span>
<a name="line-68"></a>
<a name="line-69"></a><a name="MetaExpr"></a><span class='hs-comment'>-- | LLVM metadata expressions</span>
<a name="line-70"></a><a name="MetaExpr"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>MetaExpr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MetaStr</span> <span class='hs-varop'>!</span><span class='hs-conid'>LMString</span>
<a name="line-71"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MetaNode</span> <span class='hs-varop'>!</span><span class='hs-conid'>MetaId</span>
<a name="line-72"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MetaVar</span> <span class='hs-varop'>!</span><span class='hs-conid'>LlvmVar</span>
<a name="line-73"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MetaStruct</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MetaExpr</span><span class='hs-keyglyph'>]</span>
<a name="line-74"></a>              <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>)</span>
<a name="line-75"></a>
<a name="line-76"></a><a name="MetaAnnot"></a><span class='hs-comment'>-- | Associates some metadata with a specific label for attaching to an</span>
<a name="line-77"></a><a name="MetaAnnot"></a><span class='hs-comment'>-- instruction.</span>
<a name="line-78"></a><a name="MetaAnnot"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>MetaAnnot</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MetaAnnot</span> <span class='hs-conid'>LMString</span> <span class='hs-conid'>MetaExpr</span>
<a name="line-79"></a>               <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>)</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="MetaDecl"></a><span class='hs-comment'>-- | Metadata declarations. Metadata can only be declared in global scope.</span>
<a name="line-82"></a><a name="MetaDecl"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>MetaDecl</span>
<a name="line-83"></a>    <span class='hs-comment'>-- | Named metadata. Only used for communicating module information to</span>
<a name="line-84"></a>    <span class='hs-comment'>-- LLVM. ('!name = !{ [!\&lt;n&gt;] }' form).</span>
<a name="line-85"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MetaNamed</span> <span class='hs-varop'>!</span><span class='hs-conid'>LMString</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MetaId</span><span class='hs-keyglyph'>]</span>
<a name="line-86"></a>    <span class='hs-comment'>-- | Metadata node declaration.</span>
<a name="line-87"></a>    <span class='hs-comment'>-- ('!0 = metadata !{ \&lt;metadata expression&gt; }' form).</span>
<a name="line-88"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MetaUnnamed</span> <span class='hs-varop'>!</span><span class='hs-conid'>MetaId</span> <span class='hs-varop'>!</span><span class='hs-conid'>MetaExpr</span>
</pre></body>
</html>
