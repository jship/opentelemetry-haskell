<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Core/TyCo/FVs.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Core.TyCo.FVs</span>
<a name="line-4"></a>  <span class='hs-layout'>(</span>     <span class='hs-varid'>shallowTyCoVarsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>shallowTyCoVarsOfTypes</span><span class='hs-layout'>,</span>
<a name="line-5"></a>        <span class='hs-varid'>tyCoVarsOfType</span><span class='hs-layout'>,</span>        <span class='hs-varid'>tyCoVarsOfTypes</span><span class='hs-layout'>,</span>
<a name="line-6"></a>        <span class='hs-varid'>tyCoVarsOfTypeDSet</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypesDSet</span><span class='hs-layout'>,</span>
<a name="line-7"></a>
<a name="line-8"></a>        <span class='hs-varid'>tyCoFVsBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoFVsVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoFVsVarBndrs</span><span class='hs-layout'>,</span>
<a name="line-9"></a>        <span class='hs-varid'>tyCoFVsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypeList</span><span class='hs-layout'>,</span>
<a name="line-10"></a>        <span class='hs-varid'>tyCoFVsOfTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypesList</span><span class='hs-layout'>,</span>
<a name="line-11"></a>        <span class='hs-varid'>deepTcvFolder</span><span class='hs-layout'>,</span>
<a name="line-12"></a>
<a name="line-13"></a>        <span class='hs-varid'>shallowTyCoVarsOfTyVarEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>shallowTyCoVarsOfCoVarEnv</span><span class='hs-layout'>,</span>
<a name="line-14"></a>
<a name="line-15"></a>        <span class='hs-varid'>shallowTyCoVarsOfCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>shallowTyCoVarsOfCos</span><span class='hs-layout'>,</span>
<a name="line-16"></a>        <span class='hs-varid'>tyCoVarsOfCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfMCo</span><span class='hs-layout'>,</span>
<a name="line-17"></a>        <span class='hs-varid'>coVarsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarsOfTypes</span><span class='hs-layout'>,</span>
<a name="line-18"></a>        <span class='hs-varid'>coVarsOfCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarsOfCos</span><span class='hs-layout'>,</span>
<a name="line-19"></a>        <span class='hs-varid'>tyCoVarsOfCoDSet</span><span class='hs-layout'>,</span>
<a name="line-20"></a>        <span class='hs-varid'>tyCoFVsOfCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoFVsOfCos</span><span class='hs-layout'>,</span>
<a name="line-21"></a>        <span class='hs-varid'>tyCoVarsOfCoList</span><span class='hs-layout'>,</span>
<a name="line-22"></a>
<a name="line-23"></a>        <span class='hs-varid'>almostDevoidCoVarOfCo</span><span class='hs-layout'>,</span>
<a name="line-24"></a>
<a name="line-25"></a>        <span class='hs-comment'>-- Injective free vars</span>
<a name="line-26"></a>        <span class='hs-varid'>injectiveVarsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>injectiveVarsOfTypes</span><span class='hs-layout'>,</span>
<a name="line-27"></a>        <span class='hs-varid'>invisibleVarsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>invisibleVarsOfTypes</span><span class='hs-layout'>,</span>
<a name="line-28"></a>
<a name="line-29"></a>        <span class='hs-comment'>-- Any and No Free vars</span>
<a name="line-30"></a>        <span class='hs-varid'>anyFreeVarsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>anyFreeVarsOfTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>anyFreeVarsOfCo</span><span class='hs-layout'>,</span>
<a name="line-31"></a>        <span class='hs-varid'>noFreeVarsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>noFreeVarsOfTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>noFreeVarsOfCo</span><span class='hs-layout'>,</span>
<a name="line-32"></a>
<a name="line-33"></a>        <span class='hs-comment'>-- * Well-scoped free variables</span>
<a name="line-34"></a>        <span class='hs-varid'>scopedSort</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypeWellScoped</span><span class='hs-layout'>,</span>
<a name="line-35"></a>        <span class='hs-varid'>tyCoVarsOfTypesWellScoped</span><span class='hs-layout'>,</span>
<a name="line-36"></a>
<a name="line-37"></a>        <span class='hs-comment'>-- * Closing over kinds</span>
<a name="line-38"></a>        <span class='hs-varid'>closeOverKindsDSet</span><span class='hs-layout'>,</span> <span class='hs-varid'>closeOverKindsList</span><span class='hs-layout'>,</span>
<a name="line-39"></a>        <span class='hs-varid'>closeOverKinds</span><span class='hs-layout'>,</span>
<a name="line-40"></a>
<a name="line-41"></a>        <span class='hs-comment'>-- * Raw materials</span>
<a name="line-42"></a>        <span class='hs-conid'>Endo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>runTyCoVars</span>
<a name="line-43"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-44"></a>
<a name="line-45"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-46"></a>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-48"></a>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>GHC.Core.Type</span> <span class='hs-layout'>(</span><span class='hs-varid'>coreView</span><span class='hs-layout'>,</span> <span class='hs-varid'>partitionInvisibleTypes</span><span class='hs-layout'>)</span>
<a name="line-50"></a>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Monoid</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>DM</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Endo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Any</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCo.Rep</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCon</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.FV</span>
<a name="line-56"></a>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.FM</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var.Set</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var.Env</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-62"></a>
<a name="line-63"></a><span class='hs-comment'>{-
<a name="line-64"></a>%************************************************************************
<a name="line-65"></a>%*                                                                      *
<a name="line-66"></a>                 Free variables of types and coercions
<a name="line-67"></a>%*                                                                      *
<a name="line-68"></a>%************************************************************************
<a name="line-69"></a>-}</span>
<a name="line-70"></a>
<a name="line-71"></a><span class='hs-comment'>{- Note [Shallow and deep free variables]
<a name="line-72"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-73"></a>Definitions
<a name="line-74"></a>
<a name="line-75"></a>* Shallow free variables of a type: the variables
<a name="line-76"></a>  affected by substitution. Specifically, the (TyVarTy tv)
<a name="line-77"></a>  and (CoVar cv) that appear
<a name="line-78"></a>    - In the type and coercions appearing in the type
<a name="line-79"></a>    - In shallow free variables of the kind of a Forall binder
<a name="line-80"></a>  but NOT in the kind of the /occurrences/ of a type variable.
<a name="line-81"></a>
<a name="line-82"></a>* Deep free variables of a type: shallow free variables, plus
<a name="line-83"></a>  the deep free variables of the kinds of those variables.
<a name="line-84"></a>  That is,  deepFVs( t ) = closeOverKinds( shallowFVs( t ) )
<a name="line-85"></a>
<a name="line-86"></a>Examples:
<a name="line-87"></a>
<a name="line-88"></a>  Type                     Shallow     Deep
<a name="line-89"></a>  ---------------------------------
<a name="line-90"></a>  (a : (k:Type))           {a}        {a,k}
<a name="line-91"></a>  forall (a:(k:Type)). a   {k}        {k}
<a name="line-92"></a>  (a:k-&gt;Type) (b:k)        {a,b}      {a,b,k}
<a name="line-93"></a>-}</span>
<a name="line-94"></a>
<a name="line-95"></a>
<a name="line-96"></a><span class='hs-comment'>{- Note [Free variables of types]
<a name="line-97"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-98"></a>The family of functions tyCoVarsOfType, tyCoVarsOfTypes etc, returns
<a name="line-99"></a>a VarSet that is closed over the types of its variables.  More precisely,
<a name="line-100"></a>  if    S = tyCoVarsOfType( t )
<a name="line-101"></a>  and   (a:k) is in S
<a name="line-102"></a>  then  tyCoVarsOftype( k ) is a subset of S
<a name="line-103"></a>
<a name="line-104"></a>Example: The tyCoVars of this ((a:* -&gt; k) Int) is {a, k}.
<a name="line-105"></a>
<a name="line-106"></a>We could /not/ close over the kinds of the variable occurrences, and
<a name="line-107"></a>instead do so at call sites, but it seems that we always want to do
<a name="line-108"></a>so, so it's easiest to do it here.
<a name="line-109"></a>
<a name="line-110"></a>It turns out that getting the free variables of types is performance critical,
<a name="line-111"></a>so we profiled several versions, exploring different implementation strategies.
<a name="line-112"></a>
<a name="line-113"></a>1. Baseline version: uses FV naively. Essentially:
<a name="line-114"></a>
<a name="line-115"></a>   tyCoVarsOfType ty = fvVarSet $ tyCoFVsOfType ty
<a name="line-116"></a>
<a name="line-117"></a>   This is not nice, because FV introduces some overhead to implement
<a name="line-118"></a>   determinism, and through its "interesting var" function, neither of which
<a name="line-119"></a>   we need here, so they are a complete waste.
<a name="line-120"></a>
<a name="line-121"></a>2. UnionVarSet version: instead of reusing the FV-based code, we simply used
<a name="line-122"></a>   VarSets directly, trying to avoid the overhead of FV. E.g.:
<a name="line-123"></a>
<a name="line-124"></a>   -- FV version:
<a name="line-125"></a>   tyCoFVsOfType (AppTy fun arg)    a b c = (tyCoFVsOfType fun `unionFV` tyCoFVsOfType arg) a b c
<a name="line-126"></a>
<a name="line-127"></a>   -- UnionVarSet version:
<a name="line-128"></a>   tyCoVarsOfType (AppTy fun arg)    = (tyCoVarsOfType fun `unionVarSet` tyCoVarsOfType arg)
<a name="line-129"></a>
<a name="line-130"></a>   This looks deceptively similar, but while FV internally builds a list- and
<a name="line-131"></a>   set-generating function, the VarSet functions manipulate sets directly, and
<a name="line-132"></a>   the latter performs a lot worse than the naive FV version.
<a name="line-133"></a>
<a name="line-134"></a>3. Accumulator-style VarSet version: this is what we use now. We do use VarSet
<a name="line-135"></a>   as our data structure, but delegate the actual work to a new
<a name="line-136"></a>   ty_co_vars_of_...  family of functions, which use accumulator style and the
<a name="line-137"></a>   "in-scope set" filter found in the internals of FV, but without the
<a name="line-138"></a>   determinism overhead.
<a name="line-139"></a>
<a name="line-140"></a>See #14880.
<a name="line-141"></a>
<a name="line-142"></a>Note [Closing over free variable kinds]
<a name="line-143"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-144"></a>tyCoVarsOfType and tyCoFVsOfType, while traversing a type, will also close over
<a name="line-145"></a>free variable kinds. In previous GHC versions, this happened naively: whenever
<a name="line-146"></a>we would encounter an occurrence of a free type variable, we would close over
<a name="line-147"></a>its kind. This, however is wrong for two reasons (see #14880):
<a name="line-148"></a>
<a name="line-149"></a>1. Efficiency. If we have Proxy (a::k) -&gt; Proxy (a::k) -&gt; Proxy (a::k), then
<a name="line-150"></a>   we don't want to have to traverse k more than once.
<a name="line-151"></a>
<a name="line-152"></a>2. Correctness. Imagine we have forall k. b -&gt; k, where b has
<a name="line-153"></a>   kind k, for some k bound in an outer scope. If we look at b's kind inside
<a name="line-154"></a>   the forall, we'll collect that k is free and then remove k from the set of
<a name="line-155"></a>   free variables. This is plain wrong. We must instead compute that b is free
<a name="line-156"></a>   and then conclude that b's kind is free.
<a name="line-157"></a>
<a name="line-158"></a>An obvious first approach is to move the closing-over-kinds from the
<a name="line-159"></a>occurrences of a type variable to after finding the free vars - however, this
<a name="line-160"></a>turns out to introduce performance regressions, and isn't even entirely
<a name="line-161"></a>correct.
<a name="line-162"></a>
<a name="line-163"></a>In fact, it isn't even important *when* we close over kinds; what matters is
<a name="line-164"></a>that we handle each type var exactly once, and that we do it in the right
<a name="line-165"></a>context.
<a name="line-166"></a>
<a name="line-167"></a>So the next approach we tried was to use the "in-scope set" part of FV or the
<a name="line-168"></a>equivalent argument in the accumulator-style `ty_co_vars_of_type` function, to
<a name="line-169"></a>say "don't bother with variables we have already closed over". This should work
<a name="line-170"></a>fine in theory, but the code is complicated and doesn't perform well.
<a name="line-171"></a>
<a name="line-172"></a>But there is a simpler way, which is implemented here. Consider the two points
<a name="line-173"></a>above:
<a name="line-174"></a>
<a name="line-175"></a>1. Efficiency: we now have an accumulator, so the second time we encounter 'a',
<a name="line-176"></a>   we'll ignore it, certainly not looking at its kind - this is why
<a name="line-177"></a>   pre-checking set membership before inserting ends up not only being faster,
<a name="line-178"></a>   but also being correct.
<a name="line-179"></a>
<a name="line-180"></a>2. Correctness: we have an "in-scope set" (I think we should call it it a
<a name="line-181"></a>  "bound-var set"), specifying variables that are bound by a forall in the type
<a name="line-182"></a>  we are traversing; we simply ignore these variables, certainly not looking at
<a name="line-183"></a>  their kind.
<a name="line-184"></a>
<a name="line-185"></a>So now consider:
<a name="line-186"></a>
<a name="line-187"></a>    forall k. b -&gt; k
<a name="line-188"></a>
<a name="line-189"></a>where b :: k-&gt;Type is free; but of course, it's a different k! When looking at
<a name="line-190"></a>b -&gt; k we'll have k in the bound-var set. So we'll ignore the k. But suppose
<a name="line-191"></a>this is our first encounter with b; we want the free vars of its kind. But we
<a name="line-192"></a>want to behave as if we took the free vars of its kind at the end; that is,
<a name="line-193"></a>with no bound vars in scope.
<a name="line-194"></a>
<a name="line-195"></a>So the solution is easy. The old code was this:
<a name="line-196"></a>
<a name="line-197"></a>  ty_co_vars_of_type (TyVarTy v) is acc
<a name="line-198"></a>    | v `elemVarSet` is  = acc
<a name="line-199"></a>    | v `elemVarSet` acc = acc
<a name="line-200"></a>    | otherwise          = ty_co_vars_of_type (tyVarKind v) is (extendVarSet acc v)
<a name="line-201"></a>
<a name="line-202"></a>Now all we need to do is take the free vars of tyVarKind v *with an empty
<a name="line-203"></a>bound-var set*, thus:
<a name="line-204"></a>
<a name="line-205"></a>ty_co_vars_of_type (TyVarTy v) is acc
<a name="line-206"></a>  | v `elemVarSet` is  = acc
<a name="line-207"></a>  | v `elemVarSet` acc = acc
<a name="line-208"></a>  | otherwise          = ty_co_vars_of_type (tyVarKind v) emptyVarSet (extendVarSet acc v)
<a name="line-209"></a>                                                          ^^^^^^^^^^^
<a name="line-210"></a>
<a name="line-211"></a>And that's it. This works because a variable is either bound or free. If it is bound,
<a name="line-212"></a>then we won't look at it at all. If it is free, then all the variables free in its
<a name="line-213"></a>kind are free -- regardless of whether some local variable has the same Unique.
<a name="line-214"></a>So if we're looking at a variable occurrence at all, then all variables in its
<a name="line-215"></a>kind are free.
<a name="line-216"></a>-}</span>
<a name="line-217"></a>
<a name="line-218"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-219"></a>*                                                                      *
<a name="line-220"></a>          Endo for free variables
<a name="line-221"></a>*                                                                      *
<a name="line-222"></a>********************************************************************* -}</span>
<a name="line-223"></a>
<a name="line-224"></a><span class='hs-comment'>{- Note [Acumulating parameter free variables]
<a name="line-225"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-226"></a>We can use foldType to build an accumulating-parameter version of a
<a name="line-227"></a>free-var finder, thus:
<a name="line-228"></a>
<a name="line-229"></a>    fvs :: Type -&gt; TyCoVarSet
<a name="line-230"></a>    fvs ty = appEndo (foldType folder ty) emptyVarSet
<a name="line-231"></a>
<a name="line-232"></a>Recall that
<a name="line-233"></a>    foldType :: TyCoFolder env a -&gt; env -&gt; Type -&gt; a
<a name="line-234"></a>
<a name="line-235"></a>    newtype Endo a = Endo (a -&gt; a)   -- In Data.Monoid
<a name="line-236"></a>    instance Monoid a =&gt; Monoid (Endo a) where
<a name="line-237"></a>       (Endo f) `mappend` (Endo g) = Endo (f.g)
<a name="line-238"></a>
<a name="line-239"></a>    appEndo :: Endo a -&gt; a -&gt; a
<a name="line-240"></a>    appEndo (Endo f) x = f x
<a name="line-241"></a>
<a name="line-242"></a>So `mappend` for Endos is just function composition.
<a name="line-243"></a>
<a name="line-244"></a>It's very important that, after optimisation, we end up with
<a name="line-245"></a>* an arity-three function
<a name="line-246"></a>* that is strict in the accumulator
<a name="line-247"></a>
<a name="line-248"></a>   fvs env (TyVarTy v) acc
<a name="line-249"></a>      | v `elemVarSet` env = acc
<a name="line-250"></a>      | v `elemVarSet` acc = acc
<a name="line-251"></a>      | otherwise          = acc `extendVarSet` v
<a name="line-252"></a>   fvs env (AppTy t1 t2)   = fvs env t1 (fvs env t2 acc)
<a name="line-253"></a>   ...
<a name="line-254"></a>
<a name="line-255"></a>The "strict in the accumulator" part is to ensure that in the
<a name="line-256"></a>AppTy equation we don't build a thunk for (fvs env t2 acc).
<a name="line-257"></a>
<a name="line-258"></a>The optimiser does do all this, but not very robustly. It depends
<a name="line-259"></a>critially on the basic arity-2 function not being exported, so that
<a name="line-260"></a>all its calls are visibly to three arguments. This analysis is
<a name="line-261"></a>done by the Call Arity pass.
<a name="line-262"></a>
<a name="line-263"></a>TL;DR: check this regularly!
<a name="line-264"></a>-}</span>
<a name="line-265"></a>
<a name="line-266"></a><a name="runTyCoVars"></a><span class='hs-definition'>runTyCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Endo</span> <span class='hs-conid'>TyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-267"></a><span class='hs-comment'>{-# INLINE runTyCoVars #-}</span>
<a name="line-268"></a><span class='hs-definition'>runTyCoVars</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>appEndo</span> <span class='hs-varid'>f</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-269"></a>
<a name="line-270"></a><a name="noView"></a><span class='hs-definition'>noView</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-271"></a><span class='hs-definition'>noView</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-272"></a>
<a name="line-273"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-274"></a>*                                                                      *
<a name="line-275"></a>          Deep free variables
<a name="line-276"></a>          See Note [Shallow and deep free variables]
<a name="line-277"></a>*                                                                      *
<a name="line-278"></a>********************************************************************* -}</span>
<a name="line-279"></a>
<a name="line-280"></a><a name="tyCoVarsOfType"></a><span class='hs-definition'>tyCoVarsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-281"></a><span class='hs-definition'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTyCoVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>deep_ty</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-282"></a><span class='hs-comment'>-- Alternative:</span>
<a name="line-283"></a><span class='hs-comment'>--   tyCoVarsOfType ty = closeOverKinds (shallowTyCoVarsOfType ty)</span>
<a name="line-284"></a>
<a name="line-285"></a><a name="tyCoVarsOfTypes"></a><span class='hs-definition'>tyCoVarsOfTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-286"></a><span class='hs-definition'>tyCoVarsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTyCoVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>deep_tys</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-287"></a><span class='hs-comment'>-- Alternative:</span>
<a name="line-288"></a><span class='hs-comment'>--   tyCoVarsOfTypes tys = closeOverKinds (shallowTyCoVarsOfTypes tys)</span>
<a name="line-289"></a>
<a name="line-290"></a><a name="tyCoVarsOfCo"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-291"></a><span class='hs-comment'>-- See Note [Free variables of Coercions]</span>
<a name="line-292"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTyCoVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>deep_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-293"></a>
<a name="line-294"></a><a name="tyCoVarsOfMCo"></a><span class='hs-definition'>tyCoVarsOfMCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-295"></a><span class='hs-definition'>tyCoVarsOfMCo</span> <span class='hs-conid'>MRefl</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-296"></a><span class='hs-definition'>tyCoVarsOfMCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-297"></a>
<a name="line-298"></a><a name="tyCoVarsOfCos"></a><span class='hs-definition'>tyCoVarsOfCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-299"></a><span class='hs-definition'>tyCoVarsOfCos</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTyCoVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>deep_cos</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-300"></a>
<a name="line-301"></a><a name="deep_ty"></a><span class='hs-definition'>deep_ty</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Endo</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-302"></a><a name="deep_tys"></a><span class='hs-definition'>deep_tys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Endo</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-303"></a><a name="deep_co"></a><span class='hs-definition'>deep_co</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Endo</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-304"></a><a name="deep_cos"></a><span class='hs-definition'>deep_cos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Endo</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-305"></a><span class='hs-layout'>(</span><span class='hs-varid'>deep_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>deep_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>deep_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>deep_cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTyCo</span> <span class='hs-varid'>deepTcvFolder</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-306"></a>
<a name="line-307"></a><a name="deepTcvFolder"></a><span class='hs-definition'>deepTcvFolder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoFolder</span> <span class='hs-conid'>TyCoVarSet</span> <span class='hs-layout'>(</span><span class='hs-conid'>Endo</span> <span class='hs-conid'>TyCoVarSet</span><span class='hs-layout'>)</span>
<a name="line-308"></a><span class='hs-definition'>deepTcvFolder</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyCoFolder</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcf_view</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noView</span>
<a name="line-309"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>tcf_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_tcv</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcf_covar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_tcv</span>
<a name="line-310"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>tcf_hole</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_hole</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcf_tycobinder</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_bndr</span> <span class='hs-layout'>}</span>
<a name="line-311"></a>  <span class='hs-keyword'>where</span>
<a name="line-312"></a>    <span class='hs-varid'>do_tcv</span> <span class='hs-varid'>is</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Endo</span> <span class='hs-varid'>do_it</span>
<a name="line-313"></a>      <span class='hs-keyword'>where</span>
<a name="line-314"></a>        <span class='hs-varid'>do_it</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>is</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-315"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-316"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>appEndo</span> <span class='hs-layout'>(</span><span class='hs-varid'>deep_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-317"></a>                                         <span class='hs-varid'>acc</span> <span class='hs-varop'>`extendVarSet`</span> <span class='hs-varid'>v</span>
<a name="line-318"></a>
<a name="line-319"></a>    <span class='hs-varid'>do_bndr</span> <span class='hs-varid'>is</span> <span class='hs-varid'>tcv</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarSet</span> <span class='hs-varid'>is</span> <span class='hs-varid'>tcv</span>
<a name="line-320"></a>    <span class='hs-varid'>do_hole</span> <span class='hs-varid'>is</span> <span class='hs-varid'>hole</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_tcv</span> <span class='hs-varid'>is</span> <span class='hs-layout'>(</span><span class='hs-varid'>coHoleCoVar</span> <span class='hs-varid'>hole</span><span class='hs-layout'>)</span>
<a name="line-321"></a>                       <span class='hs-comment'>-- See Note [CoercionHoles and coercion free variables]</span>
<a name="line-322"></a>                       <span class='hs-comment'>-- in GHC.Core.TyCo.Rep</span>
<a name="line-323"></a>
<a name="line-324"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-325"></a>*                                                                      *
<a name="line-326"></a>          Shallow free variables
<a name="line-327"></a>          See Note [Shallow and deep free variables]
<a name="line-328"></a>*                                                                      *
<a name="line-329"></a>********************************************************************* -}</span>
<a name="line-330"></a>
<a name="line-331"></a>
<a name="line-332"></a><a name="shallowTyCoVarsOfType"></a><span class='hs-definition'>shallowTyCoVarsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-333"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-334"></a><span class='hs-definition'>shallowTyCoVarsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTyCoVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>shallow_ty</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-335"></a>
<a name="line-336"></a><a name="shallowTyCoVarsOfTypes"></a><span class='hs-definition'>shallowTyCoVarsOfTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-337"></a><span class='hs-definition'>shallowTyCoVarsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTyCoVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>shallow_tys</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-338"></a>
<a name="line-339"></a><a name="shallowTyCoVarsOfCo"></a><span class='hs-definition'>shallowTyCoVarsOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-340"></a><span class='hs-definition'>shallowTyCoVarsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTyCoVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>shallow_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-341"></a>
<a name="line-342"></a><a name="shallowTyCoVarsOfCos"></a><span class='hs-definition'>shallowTyCoVarsOfCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-343"></a><span class='hs-definition'>shallowTyCoVarsOfCos</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTyCoVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>shallow_cos</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-344"></a>
<a name="line-345"></a><a name="shallowTyCoVarsOfTyVarEnv"></a><span class='hs-comment'>-- | Returns free variables of types, including kind variables as</span>
<a name="line-346"></a><span class='hs-comment'>-- a non-deterministic set. For type synonyms it does /not/ expand the</span>
<a name="line-347"></a><span class='hs-comment'>-- synonym.</span>
<a name="line-348"></a><span class='hs-definition'>shallowTyCoVarsOfTyVarEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarEnv</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-349"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-350"></a><span class='hs-definition'>shallowTyCoVarsOfTyVarEnv</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>shallowTyCoVarsOfTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonDetEltsUFM</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-351"></a>  <span class='hs-comment'>-- It's OK to use nonDetEltsUFM here because we immediately</span>
<a name="line-352"></a>  <span class='hs-comment'>-- forget the ordering by returning a set</span>
<a name="line-353"></a>
<a name="line-354"></a><a name="shallowTyCoVarsOfCoVarEnv"></a><span class='hs-definition'>shallowTyCoVarsOfCoVarEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVarEnv</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-355"></a><span class='hs-definition'>shallowTyCoVarsOfCoVarEnv</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>shallowTyCoVarsOfCos</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonDetEltsUFM</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-356"></a>  <span class='hs-comment'>-- It's OK to use nonDetEltsUFM here because we immediately</span>
<a name="line-357"></a>  <span class='hs-comment'>-- forget the ordering by returning a set</span>
<a name="line-358"></a>
<a name="line-359"></a><a name="shallow_ty"></a><span class='hs-definition'>shallow_ty</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Endo</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-360"></a><a name="shallow_tys"></a><span class='hs-definition'>shallow_tys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Endo</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-361"></a><a name="shallow_co"></a><span class='hs-definition'>shallow_co</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Endo</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-362"></a><a name="shallow_cos"></a><span class='hs-definition'>shallow_cos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Endo</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-363"></a><span class='hs-layout'>(</span><span class='hs-varid'>shallow_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>shallow_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>shallow_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>shallow_cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTyCo</span> <span class='hs-varid'>shallowTcvFolder</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-364"></a>
<a name="line-365"></a><a name="shallowTcvFolder"></a><span class='hs-definition'>shallowTcvFolder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoFolder</span> <span class='hs-conid'>TyCoVarSet</span> <span class='hs-layout'>(</span><span class='hs-conid'>Endo</span> <span class='hs-conid'>TyCoVarSet</span><span class='hs-layout'>)</span>
<a name="line-366"></a><span class='hs-definition'>shallowTcvFolder</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyCoFolder</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcf_view</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noView</span>
<a name="line-367"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>tcf_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_tcv</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcf_covar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_tcv</span>
<a name="line-368"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>tcf_hole</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_hole</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcf_tycobinder</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_bndr</span> <span class='hs-layout'>}</span>
<a name="line-369"></a>  <span class='hs-keyword'>where</span>
<a name="line-370"></a>    <span class='hs-varid'>do_tcv</span> <span class='hs-varid'>is</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Endo</span> <span class='hs-varid'>do_it</span>
<a name="line-371"></a>      <span class='hs-keyword'>where</span>
<a name="line-372"></a>        <span class='hs-varid'>do_it</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>is</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-373"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-374"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span> <span class='hs-varop'>`extendVarSet`</span> <span class='hs-varid'>v</span>
<a name="line-375"></a>
<a name="line-376"></a>    <span class='hs-varid'>do_bndr</span> <span class='hs-varid'>is</span> <span class='hs-varid'>tcv</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarSet</span> <span class='hs-varid'>is</span> <span class='hs-varid'>tcv</span>
<a name="line-377"></a>    <span class='hs-varid'>do_hole</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mempty</span>   <span class='hs-comment'>-- Ignore coercion holes</span>
<a name="line-378"></a>
<a name="line-379"></a>
<a name="line-380"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-381"></a>*                                                                      *
<a name="line-382"></a>          Free coercion variables
<a name="line-383"></a>*                                                                      *
<a name="line-384"></a>********************************************************************* -}</span>
<a name="line-385"></a>
<a name="line-386"></a>
<a name="line-387"></a><span class='hs-comment'>{- Note [Finding free coercion varibles]
<a name="line-388"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-389"></a>Here we are only interested in the free /coercion/ variables.
<a name="line-390"></a>We can achieve this through a slightly different TyCo folder.
<a name="line-391"></a>
<a name="line-392"></a>Notice that we look deeply, into kinds.
<a name="line-393"></a>
<a name="line-394"></a>See #14880.
<a name="line-395"></a>-}</span>
<a name="line-396"></a>
<a name="line-397"></a><a name="coVarsOfType"></a><span class='hs-definition'>coVarsOfType</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarSet</span>
<a name="line-398"></a><a name="coVarsOfTypes"></a><span class='hs-definition'>coVarsOfTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarSet</span>
<a name="line-399"></a><a name="coVarsOfCo"></a><span class='hs-definition'>coVarsOfCo</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarSet</span>
<a name="line-400"></a><a name="coVarsOfCos"></a><span class='hs-definition'>coVarsOfCos</span>   <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarSet</span>
<a name="line-401"></a>
<a name="line-402"></a><span class='hs-definition'>coVarsOfType</span>  <span class='hs-varid'>ty</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTyCoVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>deep_cv_ty</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-403"></a><span class='hs-definition'>coVarsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTyCoVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>deep_cv_tys</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-404"></a><span class='hs-definition'>coVarsOfCo</span>    <span class='hs-varid'>co</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTyCoVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>deep_cv_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-405"></a><span class='hs-definition'>coVarsOfCos</span>   <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTyCoVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>deep_cv_cos</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-406"></a>
<a name="line-407"></a><a name="deep_cv_ty"></a><span class='hs-definition'>deep_cv_ty</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Endo</span> <span class='hs-conid'>CoVarSet</span>
<a name="line-408"></a><a name="deep_cv_tys"></a><span class='hs-definition'>deep_cv_tys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Endo</span> <span class='hs-conid'>CoVarSet</span>
<a name="line-409"></a><a name="deep_cv_co"></a><span class='hs-definition'>deep_cv_co</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Endo</span> <span class='hs-conid'>CoVarSet</span>
<a name="line-410"></a><a name="deep_cv_cos"></a><span class='hs-definition'>deep_cv_cos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Endo</span> <span class='hs-conid'>CoVarSet</span>
<a name="line-411"></a><span class='hs-layout'>(</span><span class='hs-varid'>deep_cv_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>deep_cv_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>deep_cv_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>deep_cv_cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTyCo</span> <span class='hs-varid'>deepCoVarFolder</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-412"></a>
<a name="line-413"></a><a name="deepCoVarFolder"></a><span class='hs-definition'>deepCoVarFolder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoFolder</span> <span class='hs-conid'>TyCoVarSet</span> <span class='hs-layout'>(</span><span class='hs-conid'>Endo</span> <span class='hs-conid'>CoVarSet</span><span class='hs-layout'>)</span>
<a name="line-414"></a><span class='hs-definition'>deepCoVarFolder</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyCoFolder</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcf_view</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noView</span>
<a name="line-415"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>tcf_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_tyvar</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcf_covar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_covar</span>
<a name="line-416"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>tcf_hole</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_hole</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcf_tycobinder</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_bndr</span> <span class='hs-layout'>}</span>
<a name="line-417"></a>  <span class='hs-keyword'>where</span>
<a name="line-418"></a>    <span class='hs-varid'>do_tyvar</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mempty</span>
<a name="line-419"></a>      <span class='hs-comment'>-- This do_tyvar means we won't see any CoVars in this</span>
<a name="line-420"></a>      <span class='hs-comment'>-- TyVar's kind.   This may be wrong; but it's the way it's</span>
<a name="line-421"></a>      <span class='hs-comment'>-- always been.  And its awkward to change, because</span>
<a name="line-422"></a>      <span class='hs-comment'>-- the tyvar won't end up in the accumulator, so</span>
<a name="line-423"></a>      <span class='hs-comment'>-- we'd look repeatedly.  Blargh.</span>
<a name="line-424"></a>
<a name="line-425"></a>    <span class='hs-varid'>do_covar</span> <span class='hs-varid'>is</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Endo</span> <span class='hs-varid'>do_it</span>
<a name="line-426"></a>      <span class='hs-keyword'>where</span>
<a name="line-427"></a>        <span class='hs-varid'>do_it</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>is</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-428"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-429"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>appEndo</span> <span class='hs-layout'>(</span><span class='hs-varid'>deep_cv_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-430"></a>                                         <span class='hs-varid'>acc</span> <span class='hs-varop'>`extendVarSet`</span> <span class='hs-varid'>v</span>
<a name="line-431"></a>
<a name="line-432"></a>    <span class='hs-varid'>do_bndr</span> <span class='hs-varid'>is</span> <span class='hs-varid'>tcv</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarSet</span> <span class='hs-varid'>is</span> <span class='hs-varid'>tcv</span>
<a name="line-433"></a>    <span class='hs-varid'>do_hole</span> <span class='hs-varid'>is</span> <span class='hs-varid'>hole</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_covar</span> <span class='hs-varid'>is</span> <span class='hs-layout'>(</span><span class='hs-varid'>coHoleCoVar</span> <span class='hs-varid'>hole</span><span class='hs-layout'>)</span>
<a name="line-434"></a>                       <span class='hs-comment'>-- See Note [CoercionHoles and coercion free variables]</span>
<a name="line-435"></a>                       <span class='hs-comment'>-- in GHC.Core.TyCo.Rep</span>
<a name="line-436"></a>
<a name="line-437"></a>
<a name="line-438"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-439"></a>*                                                                      *
<a name="line-440"></a>          Closing over kinds
<a name="line-441"></a>*                                                                      *
<a name="line-442"></a>********************************************************************* -}</span>
<a name="line-443"></a>
<a name="line-444"></a><span class='hs-comment'>------------- Closing over kinds -----------------</span>
<a name="line-445"></a>
<a name="line-446"></a><a name="closeOverKinds"></a><span class='hs-definition'>closeOverKinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-447"></a><span class='hs-comment'>-- For each element of the input set,</span>
<a name="line-448"></a><span class='hs-comment'>-- add the deep free variables of its kind</span>
<a name="line-449"></a><span class='hs-definition'>closeOverKinds</span> <span class='hs-varid'>vs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nonDetStrictFoldVarSet</span> <span class='hs-varid'>do_one</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>vs</span>
<a name="line-450"></a>  <span class='hs-keyword'>where</span>
<a name="line-451"></a>    <span class='hs-varid'>do_one</span> <span class='hs-varid'>v</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>appEndo</span> <span class='hs-layout'>(</span><span class='hs-varid'>deep_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span>
<a name="line-452"></a>
<a name="line-453"></a><span class='hs-comment'>{- --------------- Alternative version 1 (using FV) ------------
<a name="line-454"></a>closeOverKinds = fvVarSet . closeOverKindsFV . nonDetEltsUniqSet
<a name="line-455"></a>-}</span>
<a name="line-456"></a>
<a name="line-457"></a><span class='hs-comment'>{- ---------------- Alternative version 2 -------------
<a name="line-458"></a>
<a name="line-459"></a>-- | Add the kind variables free in the kinds of the tyvars in the given set.
<a name="line-460"></a>-- Returns a non-deterministic set.
<a name="line-461"></a>closeOverKinds :: TyCoVarSet -&gt; TyCoVarSet
<a name="line-462"></a>closeOverKinds vs
<a name="line-463"></a>   = go vs vs
<a name="line-464"></a>  where
<a name="line-465"></a>    go :: VarSet   -- Work list
<a name="line-466"></a>       -&gt; VarSet   -- Accumulator, always a superset of wl
<a name="line-467"></a>       -&gt; VarSet
<a name="line-468"></a>    go wl acc
<a name="line-469"></a>      | isEmptyVarSet wl = acc
<a name="line-470"></a>      | otherwise        = go wl_kvs (acc `unionVarSet` wl_kvs)
<a name="line-471"></a>      where
<a name="line-472"></a>        k v inner_acc = ty_co_vars_of_type (varType v) acc inner_acc
<a name="line-473"></a>        wl_kvs = nonDetFoldVarSet k emptyVarSet wl
<a name="line-474"></a>        -- wl_kvs = union of shallow free vars of the kinds of wl
<a name="line-475"></a>        --          but don't bother to collect vars in acc
<a name="line-476"></a>
<a name="line-477"></a>-}</span>
<a name="line-478"></a>
<a name="line-479"></a><span class='hs-comment'>{- ---------------- Alternative version 3 -------------
<a name="line-480"></a>-- | Add the kind variables free in the kinds of the tyvars in the given set.
<a name="line-481"></a>-- Returns a non-deterministic set.
<a name="line-482"></a>closeOverKinds :: TyVarSet -&gt; TyVarSet
<a name="line-483"></a>closeOverKinds vs = close_over_kinds vs emptyVarSet
<a name="line-484"></a>
<a name="line-485"></a>
<a name="line-486"></a>close_over_kinds :: TyVarSet  -- Work list
<a name="line-487"></a>                 -&gt; TyVarSet  -- Accumulator
<a name="line-488"></a>                 -&gt; TyVarSet
<a name="line-489"></a>-- Precondition: in any call (close_over_kinds wl acc)
<a name="line-490"></a>--  for every tv in acc, the shallow kind-vars of tv
<a name="line-491"></a>--  are either in the work list wl, or in acc
<a name="line-492"></a>-- Postcondition: result is the deep free vars of (wl `union` acc)
<a name="line-493"></a>close_over_kinds wl acc
<a name="line-494"></a>  = nonDetFoldVarSet do_one acc wl
<a name="line-495"></a>  where
<a name="line-496"></a>    do_one :: Var -&gt; TyVarSet -&gt; TyVarSet
<a name="line-497"></a>    -- (do_one v acc) adds v and its deep free-vars to acc
<a name="line-498"></a>    do_one v acc | v `elemVarSet` acc
<a name="line-499"></a>                 = acc
<a name="line-500"></a>                 | otherwise
<a name="line-501"></a>                 = close_over_kinds (shallowTyCoVarsOfType (varType v)) $
<a name="line-502"></a>                   acc `extendVarSet` v
<a name="line-503"></a>-}</span>
<a name="line-504"></a>
<a name="line-505"></a>
<a name="line-506"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-507"></a>*                                                                      *
<a name="line-508"></a>          The FV versions return deterministic results
<a name="line-509"></a>*                                                                      *
<a name="line-510"></a>********************************************************************* -}</span>
<a name="line-511"></a>
<a name="line-512"></a><a name="closeOverKindsFV"></a><span class='hs-comment'>-- | Given a list of tyvars returns a deterministic FV computation that</span>
<a name="line-513"></a><span class='hs-comment'>-- returns the given tyvars with the kind variables free in the kinds of the</span>
<a name="line-514"></a><span class='hs-comment'>-- given tyvars.</span>
<a name="line-515"></a><span class='hs-definition'>closeOverKindsFV</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-516"></a><span class='hs-definition'>closeOverKindsFV</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span>
<a name="line-517"></a>  <span class='hs-varid'>mapUnionFV</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyVarKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>mkFVs</span> <span class='hs-varid'>tvs</span>
<a name="line-518"></a>
<a name="line-519"></a><a name="closeOverKindsList"></a><span class='hs-comment'>-- | Add the kind variables free in the kinds of the tyvars in the given set.</span>
<a name="line-520"></a><span class='hs-comment'>-- Returns a deterministically ordered list.</span>
<a name="line-521"></a><span class='hs-definition'>closeOverKindsList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-522"></a><span class='hs-definition'>closeOverKindsList</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>closeOverKindsFV</span> <span class='hs-varid'>tvs</span>
<a name="line-523"></a>
<a name="line-524"></a><a name="closeOverKindsDSet"></a><span class='hs-comment'>-- | Add the kind variables free in the kinds of the tyvars in the given set.</span>
<a name="line-525"></a><span class='hs-comment'>-- Returns a deterministic set.</span>
<a name="line-526"></a><span class='hs-definition'>closeOverKindsDSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DTyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DTyVarSet</span>
<a name="line-527"></a><span class='hs-definition'>closeOverKindsDSet</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvDVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>closeOverKindsFV</span> <span class='hs-varop'>.</span> <span class='hs-varid'>dVarSetElems</span>
<a name="line-528"></a>
<a name="line-529"></a><a name="tyCoVarsOfTypeDSet"></a><span class='hs-comment'>-- | `tyCoFVsOfType` that returns free variables of a type in a deterministic</span>
<a name="line-530"></a><span class='hs-comment'>-- set. For explanation of why using `VarSet` is not deterministic see</span>
<a name="line-531"></a><span class='hs-comment'>-- Note [Deterministic FV] in "GHC.Utils.FV".</span>
<a name="line-532"></a><span class='hs-definition'>tyCoVarsOfTypeDSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DTyCoVarSet</span>
<a name="line-533"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-534"></a><span class='hs-definition'>tyCoVarsOfTypeDSet</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvDVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-535"></a>
<a name="line-536"></a><a name="tyCoVarsOfTypeList"></a><span class='hs-comment'>-- | `tyCoFVsOfType` that returns free variables of a type in deterministic</span>
<a name="line-537"></a><span class='hs-comment'>-- order. For explanation of why using `VarSet` is not deterministic see</span>
<a name="line-538"></a><span class='hs-comment'>-- Note [Deterministic FV] in "GHC.Utils.FV".</span>
<a name="line-539"></a><span class='hs-definition'>tyCoVarsOfTypeList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span>
<a name="line-540"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-541"></a><span class='hs-definition'>tyCoVarsOfTypeList</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-542"></a>
<a name="line-543"></a><a name="tyCoVarsOfTypesDSet"></a><span class='hs-comment'>-- | Returns free variables of types, including kind variables as</span>
<a name="line-544"></a><span class='hs-comment'>-- a deterministic set. For type synonyms it does /not/ expand the</span>
<a name="line-545"></a><span class='hs-comment'>-- synonym.</span>
<a name="line-546"></a><span class='hs-definition'>tyCoVarsOfTypesDSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DTyCoVarSet</span>
<a name="line-547"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-548"></a><span class='hs-definition'>tyCoVarsOfTypesDSet</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvDVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varid'>tys</span>
<a name="line-549"></a>
<a name="line-550"></a><a name="tyCoVarsOfTypesList"></a><span class='hs-comment'>-- | Returns free variables of types, including kind variables as</span>
<a name="line-551"></a><span class='hs-comment'>-- a deterministically ordered list. For type synonyms it does /not/ expand the</span>
<a name="line-552"></a><span class='hs-comment'>-- synonym.</span>
<a name="line-553"></a><span class='hs-definition'>tyCoVarsOfTypesList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span>
<a name="line-554"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-555"></a><span class='hs-definition'>tyCoVarsOfTypesList</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varid'>tys</span>
<a name="line-556"></a>
<a name="line-557"></a><a name="tyCoFVsOfType"></a><span class='hs-comment'>-- | The worker for `tyCoFVsOfType` and `tyCoFVsOfTypeList`.</span>
<a name="line-558"></a><span class='hs-comment'>-- The previous implementation used `unionVarSet` which is O(n+m) and can</span>
<a name="line-559"></a><span class='hs-comment'>-- make the function quadratic.</span>
<a name="line-560"></a><span class='hs-comment'>-- It's exported, so that it can be composed with</span>
<a name="line-561"></a><span class='hs-comment'>-- other functions that compute free variables.</span>
<a name="line-562"></a><span class='hs-comment'>-- See Note [FV naming conventions] in "GHC.Utils.FV".</span>
<a name="line-563"></a><span class='hs-comment'>--</span>
<a name="line-564"></a><span class='hs-comment'>-- Eta-expanded because that makes it run faster (apparently)</span>
<a name="line-565"></a><span class='hs-comment'>-- See Note [FV eta expansion] in "GHC.Utils.FV" for explanation.</span>
<a name="line-566"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-567"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-568"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>        <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-layout'>(</span><span class='hs-varid'>acc_list</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc_set</span><span class='hs-layout'>)</span>
<a name="line-569"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>acc_list</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc_set</span><span class='hs-layout'>)</span>
<a name="line-570"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>bound_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>acc_list</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc_set</span><span class='hs-layout'>)</span>
<a name="line-571"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>acc_set</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>acc_list</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc_set</span><span class='hs-layout'>)</span>
<a name="line-572"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span>
<a name="line-573"></a>                               <span class='hs-varid'>emptyVarSet</span>   <span class='hs-comment'>-- See Note [Closing over free variable kinds]</span>
<a name="line-574"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>acc_list</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendVarSet</span> <span class='hs-varid'>acc_set</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-575"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>   <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span>
<a name="line-576"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span> <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span>
<a name="line-577"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>    <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span>
<a name="line-578"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>  <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>w</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>arg</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span>
<a name="line-579"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsBndr</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span>
<a name="line-580"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>     <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span>
<a name="line-581"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span>
<a name="line-582"></a>
<a name="line-583"></a><a name="tyCoFVsBndr"></a><span class='hs-definition'>tyCoFVsBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoVarBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-584"></a><span class='hs-comment'>-- Free vars of (forall b. &lt;thing with fvs&gt;)</span>
<a name="line-585"></a><span class='hs-definition'>tyCoFVsBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsVarBndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>fvs</span>
<a name="line-586"></a>
<a name="line-587"></a><a name="tyCoFVsVarBndrs"></a><span class='hs-definition'>tyCoFVsVarBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-588"></a><span class='hs-definition'>tyCoFVsVarBndrs</span> <span class='hs-varid'>vars</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>tyCoFVsVarBndr</span> <span class='hs-varid'>fvs</span> <span class='hs-varid'>vars</span>
<a name="line-589"></a>
<a name="line-590"></a><a name="tyCoFVsVarBndr"></a><span class='hs-definition'>tyCoFVsVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-591"></a><span class='hs-definition'>tyCoFVsVarBndr</span> <span class='hs-varid'>var</span> <span class='hs-varid'>fvs</span>
<a name="line-592"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Free vars of its type/kind</span>
<a name="line-593"></a>    <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>delFV</span> <span class='hs-varid'>var</span> <span class='hs-varid'>fvs</span>       <span class='hs-comment'>-- Delete it from the thing-inside</span>
<a name="line-594"></a>
<a name="line-595"></a><a name="tyCoFVsOfTypes"></a><span class='hs-definition'>tyCoFVsOfTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-596"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-597"></a><span class='hs-definition'>tyCoFVsOfTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-598"></a><span class='hs-definition'>tyCoFVsOfTypes</span> <span class='hs-conid'>[]</span>       <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-599"></a>
<a name="line-600"></a><a name="tyCoVarsOfCoDSet"></a><span class='hs-comment'>-- | Get a deterministic set of the vars free in a coercion</span>
<a name="line-601"></a><span class='hs-definition'>tyCoVarsOfCoDSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DTyCoVarSet</span>
<a name="line-602"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-603"></a><span class='hs-definition'>tyCoVarsOfCoDSet</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvDVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-604"></a>
<a name="line-605"></a><a name="tyCoVarsOfCoList"></a><span class='hs-definition'>tyCoVarsOfCoList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span>
<a name="line-606"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-607"></a><span class='hs-definition'>tyCoVarsOfCoList</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-608"></a>
<a name="line-609"></a><a name="tyCoFVsOfMCo"></a><span class='hs-definition'>tyCoFVsOfMCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-610"></a><span class='hs-definition'>tyCoFVsOfMCo</span> <span class='hs-conid'>MRefl</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span>
<a name="line-611"></a><span class='hs-definition'>tyCoFVsOfMCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-612"></a>
<a name="line-613"></a><a name="tyCoFVsOfCo"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-614"></a><span class='hs-comment'>-- Extracts type and coercion variables from a coercion</span>
<a name="line-615"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-616"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-617"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-618"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>mco</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-619"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfMCo</span> <span class='hs-varid'>mco</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-620"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCos</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-621"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-622"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-623"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-624"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsVarBndr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>kind_co</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-625"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>    <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-626"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co2</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-627"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-628"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCoVar</span> <span class='hs-varid'>v</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-629"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleCo</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-630"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCoVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>coHoleCoVar</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-631"></a>    <span class='hs-comment'>-- See Note [CoercionHoles and coercion free variables]</span>
<a name="line-632"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCos</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-633"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-634"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfProv</span> <span class='hs-varid'>p</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>t1</span>
<a name="line-635"></a>                     <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-636"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-637"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>   <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-638"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-639"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-640"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>     <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-641"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-642"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-643"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>  <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCos</span> <span class='hs-varid'>cs</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-644"></a>
<a name="line-645"></a><a name="tyCoFVsOfCoVar"></a><span class='hs-definition'>tyCoFVsOfCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-646"></a><span class='hs-definition'>tyCoFVsOfCoVar</span> <span class='hs-varid'>v</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-647"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitFV</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-648"></a>
<a name="line-649"></a><a name="tyCoFVsOfProv"></a><span class='hs-definition'>tyCoFVsOfProv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-650"></a><span class='hs-definition'>tyCoFVsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-651"></a><span class='hs-definition'>tyCoFVsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-652"></a><span class='hs-definition'>tyCoFVsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-653"></a><span class='hs-definition'>tyCoFVsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>CorePrepProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-654"></a>
<a name="line-655"></a><a name="tyCoFVsOfCos"></a><span class='hs-definition'>tyCoFVsOfCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-656"></a><span class='hs-definition'>tyCoFVsOfCos</span> <span class='hs-conid'>[]</span>       <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-657"></a><span class='hs-definition'>tyCoFVsOfCos</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-conop'>:</span><span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCos</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-658"></a>
<a name="line-659"></a>
<a name="line-660"></a><span class='hs-comment'>----- Whether a covar is /Almost Devoid/ in a type or coercion ----</span>
<a name="line-661"></a>
<a name="line-662"></a><a name="almostDevoidCoVarOfCo"></a><span class='hs-comment'>-- | Given a covar and a coercion, returns True if covar is almost devoid in</span>
<a name="line-663"></a><span class='hs-comment'>-- the coercion. That is, covar can only appear in Refl and GRefl.</span>
<a name="line-664"></a><span class='hs-comment'>-- See last wrinkle in Note [Unused coercion variable in ForAllCo] in "GHC.Core.Coercion"</span>
<a name="line-665"></a><span class='hs-definition'>almostDevoidCoVarOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-666"></a><span class='hs-definition'>almostDevoidCoVarOfCo</span> <span class='hs-varid'>cv</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span>
<a name="line-667"></a>  <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-668"></a>
<a name="line-669"></a><a name="almost_devoid_co_var_of_co"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-670"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>   <span class='hs-comment'>-- covar is allowed in Refl and</span>
<a name="line-671"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>  <span class='hs-comment'>-- GRefl, so we don't look into</span>
<a name="line-672"></a>                                                <span class='hs-comment'>-- the coercions</span>
<a name="line-673"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-674"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_cos</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>cv</span>
<a name="line-675"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-676"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-677"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>cv</span>
<a name="line-678"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>v</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-679"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>cv</span>
<a name="line-680"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-varop'>==</span> <span class='hs-varid'>cv</span> <span class='hs-varop'>||</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-681"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-682"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>w</span> <span class='hs-varid'>cv</span>
<a name="line-683"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>cv</span>
<a name="line-684"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co2</span> <span class='hs-varid'>cv</span>
<a name="line-685"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>cv</span>
<a name="line-686"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleCo</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>  <span class='hs-varid'>cv</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>coHoleCoVar</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>cv</span>
<a name="line-687"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-688"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_cos</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>cv</span>
<a name="line-689"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-690"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_prov</span> <span class='hs-varid'>p</span> <span class='hs-varid'>cv</span>
<a name="line-691"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_type</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>cv</span>
<a name="line-692"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_type</span> <span class='hs-varid'>t2</span> <span class='hs-varid'>cv</span>
<a name="line-693"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-694"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-695"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-696"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>cv</span>
<a name="line-697"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co2</span> <span class='hs-varid'>cv</span>
<a name="line-698"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-699"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-700"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-701"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-702"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-703"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-704"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>cv</span>
<a name="line-705"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-706"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-707"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-708"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-709"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-710"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_cos</span> <span class='hs-varid'>cs</span> <span class='hs-varid'>cv</span>
<a name="line-711"></a>
<a name="line-712"></a><a name="almost_devoid_co_var_of_cos"></a><span class='hs-definition'>almost_devoid_co_var_of_cos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-713"></a><span class='hs-definition'>almost_devoid_co_var_of_cos</span> <span class='hs-conid'>[]</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-714"></a><span class='hs-definition'>almost_devoid_co_var_of_cos</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-conop'>:</span><span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-715"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-716"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_cos</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>cv</span>
<a name="line-717"></a>
<a name="line-718"></a><a name="almost_devoid_co_var_of_prov"></a><span class='hs-definition'>almost_devoid_co_var_of_prov</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-719"></a><span class='hs-definition'>almost_devoid_co_var_of_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-720"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-721"></a><span class='hs-definition'>almost_devoid_co_var_of_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-722"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-723"></a><span class='hs-definition'>almost_devoid_co_var_of_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-724"></a><span class='hs-definition'>almost_devoid_co_var_of_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>CorePrepProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-725"></a>
<a name="line-726"></a><a name="almost_devoid_co_var_of_type"></a><span class='hs-definition'>almost_devoid_co_var_of_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-727"></a><span class='hs-definition'>almost_devoid_co_var_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-728"></a><span class='hs-definition'>almost_devoid_co_var_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-729"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_types</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cv</span>
<a name="line-730"></a><span class='hs-definition'>almost_devoid_co_var_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-731"></a><span class='hs-definition'>almost_devoid_co_var_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-732"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_type</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>cv</span>
<a name="line-733"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_type</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>cv</span>
<a name="line-734"></a><span class='hs-definition'>almost_devoid_co_var_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-735"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_type</span> <span class='hs-varid'>w</span> <span class='hs-varid'>cv</span>
<a name="line-736"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_type</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>cv</span>
<a name="line-737"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_type</span> <span class='hs-varid'>res</span> <span class='hs-varid'>cv</span>
<a name="line-738"></a><span class='hs-definition'>almost_devoid_co_var_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-739"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_type</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-740"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-varop'>==</span> <span class='hs-varid'>cv</span> <span class='hs-varop'>||</span> <span class='hs-varid'>almost_devoid_co_var_of_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-741"></a><span class='hs-definition'>almost_devoid_co_var_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-742"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>cv</span>
<a name="line-743"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-744"></a><span class='hs-definition'>almost_devoid_co_var_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-745"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-746"></a>
<a name="line-747"></a><a name="almost_devoid_co_var_of_types"></a><span class='hs-definition'>almost_devoid_co_var_of_types</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-748"></a><span class='hs-definition'>almost_devoid_co_var_of_types</span> <span class='hs-conid'>[]</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-749"></a><span class='hs-definition'>almost_devoid_co_var_of_types</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-750"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>cv</span>
<a name="line-751"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_types</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cv</span>
<a name="line-752"></a>
<a name="line-753"></a>
<a name="line-754"></a>
<a name="line-755"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-756"></a>*                                                                      *
<a name="line-757"></a>                 Injective free vars
<a name="line-758"></a>*                                                                      *
<a name="line-759"></a>********************************************************************* -}</span>
<a name="line-760"></a>
<a name="line-761"></a><a name="injectiveVarsOfType"></a><span class='hs-comment'>-- | Returns the free variables of a 'Type' that are in injective positions.</span>
<a name="line-762"></a><span class='hs-comment'>-- Specifically, it finds the free variables while:</span>
<a name="line-763"></a><span class='hs-comment'>--</span>
<a name="line-764"></a><span class='hs-comment'>-- * Expanding type synonyms</span>
<a name="line-765"></a><span class='hs-comment'>--</span>
<a name="line-766"></a><span class='hs-comment'>-- * Ignoring the coercion in @(ty |&gt; co)@</span>
<a name="line-767"></a><span class='hs-comment'>--</span>
<a name="line-768"></a><span class='hs-comment'>-- * Ignoring the non-injective fields of a 'TyConApp'</span>
<a name="line-769"></a><span class='hs-comment'>--</span>
<a name="line-770"></a><span class='hs-comment'>--</span>
<a name="line-771"></a><span class='hs-comment'>-- For example, if @F@ is a non-injective type family, then:</span>
<a name="line-772"></a><span class='hs-comment'>--</span>
<a name="line-773"></a><span class='hs-comment'>-- @</span>
<a name="line-774"></a><span class='hs-comment'>-- injectiveTyVarsOf( Either c (Maybe (a, F b c)) ) = {a,c}</span>
<a name="line-775"></a><span class='hs-comment'>-- @</span>
<a name="line-776"></a><span class='hs-comment'>--</span>
<a name="line-777"></a><span class='hs-comment'>-- If @'injectiveVarsOfType' ty = itvs@, then knowing @ty@ fixes @itvs@.</span>
<a name="line-778"></a><span class='hs-comment'>-- More formally, if</span>
<a name="line-779"></a><span class='hs-comment'>-- @a@ is in @'injectiveVarsOfType' ty@</span>
<a name="line-780"></a><span class='hs-comment'>-- and  @S1(ty) ~ S2(ty)@,</span>
<a name="line-781"></a><span class='hs-comment'>-- then @S1(a)  ~ S2(a)@,</span>
<a name="line-782"></a><span class='hs-comment'>-- where @S1@ and @S2@ are arbitrary substitutions.</span>
<a name="line-783"></a><span class='hs-comment'>--</span>
<a name="line-784"></a><span class='hs-comment'>-- See @Note [When does a tycon application need an explicit kind signature?]@.</span>
<a name="line-785"></a><span class='hs-definition'>injectiveVarsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>   <span class='hs-comment'>-- ^ Should we look under injective type families?</span>
<a name="line-786"></a>                              <span class='hs-comment'>-- See Note [Coverage condition for injective type families]</span>
<a name="line-787"></a>                              <span class='hs-comment'>-- in "GHC.Tc.Instance.Family".</span>
<a name="line-788"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-789"></a><span class='hs-definition'>injectiveVarsOfType</span> <span class='hs-varid'>look_under_tfs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span>
<a name="line-790"></a>  <span class='hs-keyword'>where</span>
<a name="line-791"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>                  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span>
<a name="line-792"></a>                           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty'</span>
<a name="line-793"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitFV</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-794"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>f</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>a</span>
<a name="line-795"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>w</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty2</span>
<a name="line-796"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span>
<a name="line-797"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConInjectivityInfo</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>of</span>
<a name="line-798"></a>        <span class='hs-conid'>Injective</span> <span class='hs-varid'>inj</span>
<a name="line-799"></a>          <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>look_under_tfs</span> <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTypeFamilyTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-800"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mapUnionFV</span> <span class='hs-varid'>go</span> <span class='hs-varop'>$</span>
<a name="line-801"></a>             <span class='hs-varid'>filterByList</span> <span class='hs-layout'>(</span><span class='hs-varid'>inj</span> <span class='hs-varop'>++</span> <span class='hs-varid'>repeat</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-802"></a>                         <span class='hs-comment'>-- Oversaturated arguments to a tycon are</span>
<a name="line-803"></a>                         <span class='hs-comment'>-- always injective, hence the repeat True</span>
<a name="line-804"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyFV</span>
<a name="line-805"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>delFV</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-806"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>LitTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span>
<a name="line-807"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-808"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>CoercionTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span>
<a name="line-809"></a>
<a name="line-810"></a><a name="injectiveVarsOfTypes"></a><span class='hs-comment'>-- | Returns the free variables of a 'Type' that are in injective positions.</span>
<a name="line-811"></a><span class='hs-comment'>-- Specifically, it finds the free variables while:</span>
<a name="line-812"></a><span class='hs-comment'>--</span>
<a name="line-813"></a><span class='hs-comment'>-- * Expanding type synonyms</span>
<a name="line-814"></a><span class='hs-comment'>--</span>
<a name="line-815"></a><span class='hs-comment'>-- * Ignoring the coercion in @(ty |&gt; co)@</span>
<a name="line-816"></a><span class='hs-comment'>--</span>
<a name="line-817"></a><span class='hs-comment'>-- * Ignoring the non-injective fields of a 'TyConApp'</span>
<a name="line-818"></a><span class='hs-comment'>--</span>
<a name="line-819"></a><span class='hs-comment'>-- See @Note [When does a tycon application need an explicit kind signature?]@.</span>
<a name="line-820"></a><span class='hs-definition'>injectiveVarsOfTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-comment'>-- ^ look under injective type families?</span>
<a name="line-821"></a>                             <span class='hs-comment'>-- See Note [Coverage condition for injective type families]</span>
<a name="line-822"></a>                             <span class='hs-comment'>-- in "GHC.Tc.Instance.Family".</span>
<a name="line-823"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-824"></a><span class='hs-definition'>injectiveVarsOfTypes</span> <span class='hs-varid'>look_under_tfs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapUnionFV</span> <span class='hs-layout'>(</span><span class='hs-varid'>injectiveVarsOfType</span> <span class='hs-varid'>look_under_tfs</span><span class='hs-layout'>)</span>
<a name="line-825"></a>
<a name="line-826"></a>
<a name="line-827"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-828"></a>*                                                                      *
<a name="line-829"></a>                 Invisible vars
<a name="line-830"></a>*                                                                      *
<a name="line-831"></a>********************************************************************* -}</span>
<a name="line-832"></a>
<a name="line-833"></a>
<a name="line-834"></a><a name="invisibleVarsOfType"></a><span class='hs-comment'>-- | Returns the set of variables that are used invisibly anywhere within</span>
<a name="line-835"></a><span class='hs-comment'>-- the given type. A variable will be included even if it is used both visibly</span>
<a name="line-836"></a><span class='hs-comment'>-- and invisibly. An invisible use site includes:</span>
<a name="line-837"></a><span class='hs-comment'>--   * In the kind of a variable</span>
<a name="line-838"></a><span class='hs-comment'>--   * In the kind of a bound variable in a forall</span>
<a name="line-839"></a><span class='hs-comment'>--   * In a coercion</span>
<a name="line-840"></a><span class='hs-comment'>--   * In a Specified or Inferred argument to a function</span>
<a name="line-841"></a><span class='hs-comment'>-- See Note [VarBndrs, TyCoVarBinders, TyConBinders, and visibility] in "GHC.Core.TyCo.Rep"</span>
<a name="line-842"></a><span class='hs-definition'>invisibleVarsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-843"></a><span class='hs-definition'>invisibleVarsOfType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span>
<a name="line-844"></a>  <span class='hs-keyword'>where</span>
<a name="line-845"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>                 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span>
<a name="line-846"></a>                          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty'</span>
<a name="line-847"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-848"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>f</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>a</span>
<a name="line-849"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>w</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty2</span>
<a name="line-850"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varid'>invisibles</span> <span class='hs-varop'>`unionFV`</span>
<a name="line-851"></a>                            <span class='hs-varid'>invisibleVarsOfTypes</span> <span class='hs-varid'>visibles</span>
<a name="line-852"></a>      <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>invisibles</span><span class='hs-layout'>,</span> <span class='hs-varid'>visibles</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionInvisibleTypes</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-853"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tvb</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsBndr</span> <span class='hs-varid'>tvb</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-854"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>LitTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span>
<a name="line-855"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-856"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-857"></a>
<a name="line-858"></a><a name="invisibleVarsOfTypes"></a><span class='hs-comment'>-- | Like 'invisibleVarsOfType', but for many types.</span>
<a name="line-859"></a><span class='hs-definition'>invisibleVarsOfTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-860"></a><span class='hs-definition'>invisibleVarsOfTypes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapUnionFV</span> <span class='hs-varid'>invisibleVarsOfType</span>
<a name="line-861"></a>
<a name="line-862"></a>
<a name="line-863"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-864"></a>*                                                                      *
<a name="line-865"></a>                 Any free vars
<a name="line-866"></a>*                                                                      *
<a name="line-867"></a>********************************************************************* -}</span>
<a name="line-868"></a>
<a name="line-869"></a><span class='hs-comment'>{-# INLINE afvFolder #-}</span>   <span class='hs-comment'>-- so that specialization to (const True) works</span>
<a name="line-870"></a><a name="afvFolder"></a><span class='hs-definition'>afvFolder</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoFolder</span> <span class='hs-conid'>TyCoVarSet</span> <span class='hs-conid'>DM.Any</span>
<a name="line-871"></a><span class='hs-definition'>afvFolder</span> <span class='hs-varid'>check_fv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyCoFolder</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcf_view</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noView</span>
<a name="line-872"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>tcf_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_tcv</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcf_covar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_tcv</span>
<a name="line-873"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>tcf_hole</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_hole</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcf_tycobinder</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_bndr</span> <span class='hs-layout'>}</span>
<a name="line-874"></a>  <span class='hs-keyword'>where</span>
<a name="line-875"></a>    <span class='hs-varid'>do_tcv</span> <span class='hs-varid'>is</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Any</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>check_fv</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-876"></a>    <span class='hs-varid'>do_hole</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Any</span> <span class='hs-conid'>False</span>    <span class='hs-comment'>-- I'm unsure; probably never happens</span>
<a name="line-877"></a>    <span class='hs-varid'>do_bndr</span> <span class='hs-varid'>is</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is</span> <span class='hs-varop'>`extendVarSet`</span> <span class='hs-varid'>tv</span>
<a name="line-878"></a>
<a name="line-879"></a><a name="anyFreeVarsOfType"></a><span class='hs-definition'>anyFreeVarsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-880"></a><span class='hs-definition'>anyFreeVarsOfType</span> <span class='hs-varid'>check_fv</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DM.getAny</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-881"></a>  <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTyCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>afvFolder</span> <span class='hs-varid'>check_fv</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-882"></a>
<a name="line-883"></a><a name="anyFreeVarsOfTypes"></a><span class='hs-definition'>anyFreeVarsOfTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-884"></a><span class='hs-definition'>anyFreeVarsOfTypes</span> <span class='hs-varid'>check_fv</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DM.getAny</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-885"></a>  <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTyCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>afvFolder</span> <span class='hs-varid'>check_fv</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-886"></a>
<a name="line-887"></a><a name="anyFreeVarsOfCo"></a><span class='hs-definition'>anyFreeVarsOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-888"></a><span class='hs-definition'>anyFreeVarsOfCo</span> <span class='hs-varid'>check_fv</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DM.getAny</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-889"></a>  <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTyCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>afvFolder</span> <span class='hs-varid'>check_fv</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-890"></a>
<a name="line-891"></a><a name="noFreeVarsOfType"></a><span class='hs-definition'>noFreeVarsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-892"></a><span class='hs-definition'>noFreeVarsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DM.getAny</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-893"></a>  <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTyCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>afvFolder</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-894"></a>
<a name="line-895"></a><a name="noFreeVarsOfTypes"></a><span class='hs-definition'>noFreeVarsOfTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-896"></a><span class='hs-definition'>noFreeVarsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DM.getAny</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-897"></a>  <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTyCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>afvFolder</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-898"></a>
<a name="line-899"></a><a name="noFreeVarsOfCo"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-900"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DM.getAny</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-901"></a>  <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTyCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>afvFolder</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-902"></a>
<a name="line-903"></a>
<a name="line-904"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-905"></a>*                                                                      *
<a name="line-906"></a>                 scopedSort
<a name="line-907"></a>*                                                                      *
<a name="line-908"></a>********************************************************************* -}</span>
<a name="line-909"></a>
<a name="line-910"></a><span class='hs-comment'>{- Note [ScopedSort]
<a name="line-911"></a>~~~~~~~~~~~~~~~~~~~~
<a name="line-912"></a>Consider
<a name="line-913"></a>
<a name="line-914"></a>  foo :: Proxy a -&gt; Proxy (b :: k) -&gt; Proxy (a :: k2) -&gt; ()
<a name="line-915"></a>
<a name="line-916"></a>This function type is implicitly generalised over [a, b, k, k2]. These
<a name="line-917"></a>variables will be Specified; that is, they will be available for visible
<a name="line-918"></a>type application. This is because they are written in the type signature
<a name="line-919"></a>by the user.
<a name="line-920"></a>
<a name="line-921"></a>However, we must ask: what order will they appear in? In cases without
<a name="line-922"></a>dependency, this is easy: we just use the lexical left-to-right ordering
<a name="line-923"></a>of first occurrence. With dependency, we cannot get off the hook so
<a name="line-924"></a>easily.
<a name="line-925"></a>
<a name="line-926"></a>We thus state:
<a name="line-927"></a>
<a name="line-928"></a> * These variables appear in the order as given by ScopedSort, where
<a name="line-929"></a>   the input to ScopedSort is the left-to-right order of first occurrence.
<a name="line-930"></a>
<a name="line-931"></a>Note that this applies only to *implicit* quantification, without a
<a name="line-932"></a>`forall`. If the user writes a `forall`, then we just use the order given.
<a name="line-933"></a>
<a name="line-934"></a>ScopedSort is defined thusly (as proposed in #15743):
<a name="line-935"></a>  * Work left-to-right through the input list, with a cursor.
<a name="line-936"></a>  * If variable v at the cursor is depended on by any earlier variable w,
<a name="line-937"></a>    move v immediately before the leftmost such w.
<a name="line-938"></a>
<a name="line-939"></a>INVARIANT: The prefix of variables before the cursor form a valid telescope.
<a name="line-940"></a>
<a name="line-941"></a>Note that ScopedSort makes sense only after type inference is done and all
<a name="line-942"></a>types/kinds are fully settled and zonked.
<a name="line-943"></a>
<a name="line-944"></a>-}</span>
<a name="line-945"></a>
<a name="line-946"></a><span class='hs-comment'>-- | Do a topological sort on a list of tyvars,</span>
<a name="line-947"></a><span class='hs-comment'>--   so that binders occur before occurrences</span>
<a name="line-948"></a><span class='hs-comment'>-- E.g. given  [ a::k, k::*, b::k ]</span>
<a name="line-949"></a><span class='hs-comment'>-- it'll return a well-scoped list [ k::*, a::k, b::k ]</span>
<a name="line-950"></a><span class='hs-comment'>--</span>
<a name="line-951"></a><span class='hs-comment'>-- This is a deterministic sorting operation</span>
<a name="line-952"></a><span class='hs-comment'>-- (that is, doesn't depend on Uniques).</span>
<a name="line-953"></a><span class='hs-comment'>--</span>
<a name="line-954"></a><span class='hs-comment'>-- It is also meant to be stable: that is, variables should not</span>
<a name="line-955"></a><span class='hs-comment'>-- be reordered unnecessarily. This is specified in Note [ScopedSort]</span>
<a name="line-956"></a><span class='hs-comment'>-- See also Note [Ordering of implicit variables] in "GHC.Rename.HsType"</span>
<a name="line-957"></a>
<a name="line-958"></a><a name="scopedSort"></a><span class='hs-definition'>scopedSort</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span>
<a name="line-959"></a><span class='hs-definition'>scopedSort</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span>
<a name="line-960"></a>  <span class='hs-keyword'>where</span>
<a name="line-961"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- already sorted, in reverse order</span>
<a name="line-962"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVarSet</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- each set contains all the variables which must be placed</span>
<a name="line-963"></a>                       <span class='hs-comment'>-- before the tv corresponding to the set; they are accumulations</span>
<a name="line-964"></a>                       <span class='hs-comment'>-- of the fvs in the sorted tvs' kinds</span>
<a name="line-965"></a>
<a name="line-966"></a>                       <span class='hs-comment'>-- This list is in 1-to-1 correspondence with the sorted tyvars</span>
<a name="line-967"></a>                       <span class='hs-comment'>-- INVARIANT:</span>
<a name="line-968"></a>                       <span class='hs-comment'>--   all (\tl -&gt; all (`subVarSet` head tl) (tail tl)) (tails fv_list)</span>
<a name="line-969"></a>                       <span class='hs-comment'>-- That is, each set in the list is a superset of all later sets.</span>
<a name="line-970"></a>
<a name="line-971"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- yet to be sorted</span>
<a name="line-972"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span>
<a name="line-973"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>acc</span> <span class='hs-sel'>_fv_list</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>acc</span>
<a name="line-974"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>acc</span>  <span class='hs-varid'>fv_list</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-975"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>acc'</span> <span class='hs-varid'>fv_list'</span> <span class='hs-varid'>tvs</span>
<a name="line-976"></a>      <span class='hs-keyword'>where</span>
<a name="line-977"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>acc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_list'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insert</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>fv_list</span>
<a name="line-978"></a>
<a name="line-979"></a>    <span class='hs-varid'>insert</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoVar</span>       <span class='hs-comment'>-- var to insert</span>
<a name="line-980"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- sorted list, in reverse order</span>
<a name="line-981"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVarSet</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- list of fvs, as above</span>
<a name="line-982"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVarSet</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- augmented lists</span>
<a name="line-983"></a>    <span class='hs-varid'>insert</span> <span class='hs-varid'>tv</span> <span class='hs-conid'>[]</span>     <span class='hs-conid'>[]</span>         <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>tv</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-984"></a>    <span class='hs-varid'>insert</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fvs</span><span class='hs-conop'>:</span><span class='hs-varid'>fvss</span><span class='hs-layout'>)</span>
<a name="line-985"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>fvs</span>
<a name="line-986"></a>      <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>as'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvss'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>insert</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>as</span> <span class='hs-varid'>fvss</span>
<a name="line-987"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-varid'>as'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>fv_tv</span> <span class='hs-conop'>:</span> <span class='hs-varid'>fvss'</span><span class='hs-layout'>)</span>
<a name="line-988"></a>
<a name="line-989"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-990"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>fv_tv</span> <span class='hs-conop'>:</span> <span class='hs-varid'>fvs</span> <span class='hs-conop'>:</span> <span class='hs-varid'>fvss</span><span class='hs-layout'>)</span>
<a name="line-991"></a>      <span class='hs-keyword'>where</span>
<a name="line-992"></a>        <span class='hs-varid'>fv_tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-993"></a>
<a name="line-994"></a>       <span class='hs-comment'>-- lists not in correspondence</span>
<a name="line-995"></a>    <span class='hs-varid'>insert</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"scopedSort"</span>
<a name="line-996"></a>
<a name="line-997"></a><a name="tyCoVarsOfTypeWellScoped"></a><span class='hs-comment'>-- | Get the free vars of a type in scoped order</span>
<a name="line-998"></a><span class='hs-definition'>tyCoVarsOfTypeWellScoped</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-999"></a><span class='hs-definition'>tyCoVarsOfTypeWellScoped</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>scopedSort</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyCoVarsOfTypeList</span>
<a name="line-1000"></a>
<a name="line-1001"></a><a name="tyCoVarsOfTypesWellScoped"></a><span class='hs-comment'>-- | Get the free vars of types in scoped order</span>
<a name="line-1002"></a><span class='hs-definition'>tyCoVarsOfTypesWellScoped</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1003"></a><span class='hs-definition'>tyCoVarsOfTypesWellScoped</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>scopedSort</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyCoVarsOfTypesList</span>
</pre></body>
</html>
