<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/StgToCmm/Foreign.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-2"></a><span class='hs-comment'>--</span>
<a name="line-3"></a><span class='hs-comment'>-- Code generation for foreign calls.</span>
<a name="line-4"></a><span class='hs-comment'>--</span>
<a name="line-5"></a><span class='hs-comment'>-- (c) The University of Glasgow 2004-2006</span>
<a name="line-6"></a><span class='hs-comment'>--</span>
<a name="line-7"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.StgToCmm.Foreign</span> <span class='hs-layout'>(</span>
<a name="line-10"></a>  <span class='hs-varid'>cgForeignCall</span><span class='hs-layout'>,</span>
<a name="line-11"></a>  <span class='hs-varid'>emitPrimCall</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitCCall</span><span class='hs-layout'>,</span>
<a name="line-12"></a>  <span class='hs-varid'>emitForeignCall</span><span class='hs-layout'>,</span>
<a name="line-13"></a>  <span class='hs-varid'>emitSaveThreadState</span><span class='hs-layout'>,</span>
<a name="line-14"></a>  <span class='hs-varid'>saveThreadState</span><span class='hs-layout'>,</span>
<a name="line-15"></a>  <span class='hs-varid'>emitLoadThreadState</span><span class='hs-layout'>,</span>
<a name="line-16"></a>  <span class='hs-varid'>emitSaveRegs</span><span class='hs-layout'>,</span>
<a name="line-17"></a>  <span class='hs-varid'>emitRestoreRegs</span><span class='hs-layout'>,</span>
<a name="line-18"></a>  <span class='hs-varid'>emitPushTupleRegs</span><span class='hs-layout'>,</span>
<a name="line-19"></a>  <span class='hs-varid'>emitPopTupleRegs</span><span class='hs-layout'>,</span>
<a name="line-20"></a>  <span class='hs-varid'>loadThreadState</span><span class='hs-layout'>,</span>
<a name="line-21"></a>  <span class='hs-varid'>emitOpenNursery</span><span class='hs-layout'>,</span>
<a name="line-22"></a>  <span class='hs-varid'>emitCloseNursery</span><span class='hs-layout'>,</span>
<a name="line-23"></a> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span> <span class='hs-varid'>hiding</span><span class='hs-layout'>(</span> <span class='hs-varid'>succ</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;*&gt;</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Platform</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Platform.Profile</span>
<a name="line-29"></a>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Stg.Syntax</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.StgToCmm.Prof</span> <span class='hs-layout'>(</span><span class='hs-varid'>storeCurCCS</span><span class='hs-layout'>,</span> <span class='hs-varid'>ccsType</span><span class='hs-layout'>)</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.StgToCmm.Monad</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.StgToCmm.Utils</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.StgToCmm.Closure</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.StgToCmm.Layout</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.BlockId</span> <span class='hs-layout'>(</span><span class='hs-varid'>newBlockId</span><span class='hs-layout'>)</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.Utils</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.Graph</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.CallConv</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Type</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.RepType</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.CLabel</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Runtime.Heap.Layout</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.ForeignCall</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Maybe</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.Supply</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Basic</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Types</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCo.Rep</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Types.Prim</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipEqual</span><span class='hs-layout'>)</span>
<a name="line-56"></a>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad</span>
<a name="line-58"></a>
<a name="line-59"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-60"></a><span class='hs-comment'>-- Code generation for Foreign Calls</span>
<a name="line-61"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-62"></a>
<a name="line-63"></a><a name="cgForeignCall"></a><span class='hs-comment'>-- | Emit code for a foreign call, and return the results to the sequel.</span>
<a name="line-64"></a><span class='hs-comment'>-- Precondition: the length of the arguments list is the same as the</span>
<a name="line-65"></a><span class='hs-comment'>-- arity of the foreign function.</span>
<a name="line-66"></a><span class='hs-definition'>cgForeignCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignCall</span>            <span class='hs-comment'>-- the op</span>
<a name="line-67"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>                   <span class='hs-comment'>-- type of foreign function</span>
<a name="line-68"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgArg</span><span class='hs-keyglyph'>]</span>               <span class='hs-comment'>-- x,y    arguments</span>
<a name="line-69"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>                   <span class='hs-comment'>-- result type</span>
<a name="line-70"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>ReturnKind</span>
<a name="line-71"></a>
<a name="line-72"></a><span class='hs-definition'>cgForeignCall</span> <span class='hs-layout'>(</span><span class='hs-conid'>CCall</span> <span class='hs-layout'>(</span><span class='hs-conid'>CCallSpec</span> <span class='hs-varid'>target</span> <span class='hs-varid'>cconv</span> <span class='hs-varid'>safety</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>typ</span> <span class='hs-varid'>stg_args</span> <span class='hs-varid'>res_ty</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPlatform</span>
<a name="line-74"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-comment'>-- in the stdcall calling convention, the symbol needs @size appended</span>
<a name="line-75"></a>              <span class='hs-comment'>-- to it, where size is the total number of bytes of arguments.  We</span>
<a name="line-76"></a>              <span class='hs-comment'>-- attach this info to the CLabel here, and the CLabel pretty printer</span>
<a name="line-77"></a>              <span class='hs-comment'>-- will generate the suffix when the label is printed.</span>
<a name="line-78"></a>            <span class='hs-varid'>call_size</span> <span class='hs-varid'>args</span>
<a name="line-79"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StdCallConv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cconv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>arg_size</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-80"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-81"></a>
<a name="line-82"></a>              <span class='hs-comment'>-- ToDo: this might not be correct for 64-bit API</span>
<a name="line-83"></a>              <span class='hs-comment'>-- This is correct for the PowerPC ELF ABI version 1 and 2.</span>
<a name="line-84"></a>            <span class='hs-varid'>arg_size</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>max</span> <span class='hs-layout'>(</span><span class='hs-varid'>widthInBytes</span> <span class='hs-varop'>$</span> <span class='hs-varid'>typeWidth</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cmmExprType</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-85"></a>                                     <span class='hs-layout'>(</span><span class='hs-varid'>platformWordSizeInBytes</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-86"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>cmm_args</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getFCallArgs</span> <span class='hs-varid'>stg_args</span> <span class='hs-varid'>typ</span>
<a name="line-87"></a>        <span class='hs-comment'>-- ; traceM $ show cmm_args</span>
<a name="line-88"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>res_regs</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_hints</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnboxedTupleRegs</span> <span class='hs-varid'>res_ty</span>
<a name="line-89"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>call_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_hints</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>cmm_target</span><span class='hs-layout'>)</span>
<a name="line-90"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>target</span> <span class='hs-keyword'>of</span>
<a name="line-91"></a>                   <span class='hs-conid'>StaticTarget</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>   <span class='hs-keyword'>_</span>      <span class='hs-conid'>False</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-92"></a>                       <span class='hs-varid'>panic</span> <span class='hs-str'>"cgForeignCall: unexpected FFI value import"</span>
<a name="line-93"></a>                   <span class='hs-conid'>StaticTarget</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>mPkgId</span> <span class='hs-conid'>True</span>
<a name="line-94"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>labelSource</span>
<a name="line-95"></a>                                <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mPkgId</span> <span class='hs-keyword'>of</span>
<a name="line-96"></a>                                        <span class='hs-conid'>Nothing</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ForeignLabelInThisPackage</span>
<a name="line-97"></a>                                        <span class='hs-conid'>Just</span> <span class='hs-varid'>pkgId</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ForeignLabelInPackage</span> <span class='hs-layout'>(</span><span class='hs-varid'>toUnitId</span> <span class='hs-varid'>pkgId</span><span class='hs-layout'>)</span>
<a name="line-98"></a>                            <span class='hs-varid'>size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>call_size</span> <span class='hs-varid'>cmm_args</span>
<a name="line-99"></a>                        <span class='hs-keyword'>in</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>cmm_args</span>
<a name="line-100"></a>                            <span class='hs-layout'>,</span> <span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLabel</span>
<a name="line-101"></a>                                        <span class='hs-layout'>(</span><span class='hs-varid'>mkForeignLabel</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>size</span> <span class='hs-varid'>labelSource</span> <span class='hs-conid'>IsFunction</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-102"></a>
<a name="line-103"></a>                   <span class='hs-conid'>DynamicTarget</span>    <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-keyword'>case</span> <span class='hs-varid'>cmm_args</span> <span class='hs-keyword'>of</span>
<a name="line-104"></a>                                           <span class='hs-layout'>(</span><span class='hs-varid'>fn</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>rest</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>unzip</span> <span class='hs-varid'>rest</span><span class='hs-layout'>,</span> <span class='hs-varid'>fn</span><span class='hs-layout'>)</span>
<a name="line-105"></a>                                           <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"cgForeignCall []"</span>
<a name="line-106"></a>              <span class='hs-varid'>fc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForeignConvention</span> <span class='hs-varid'>cconv</span> <span class='hs-varid'>arg_hints</span> <span class='hs-varid'>res_hints</span> <span class='hs-conid'>CmmMayReturn</span>
<a name="line-107"></a>              <span class='hs-varid'>call_target</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForeignTarget</span> <span class='hs-varid'>cmm_target</span> <span class='hs-varid'>fc</span>
<a name="line-108"></a>
<a name="line-109"></a>        <span class='hs-comment'>-- we want to emit code for the call, and then emitReturn.</span>
<a name="line-110"></a>        <span class='hs-comment'>-- However, if the sequel is AssignTo, we shortcut a little</span>
<a name="line-111"></a>        <span class='hs-comment'>-- and generate a foreign call that assigns the results</span>
<a name="line-112"></a>        <span class='hs-comment'>-- directly.  Otherwise we end up generating a bunch of</span>
<a name="line-113"></a>        <span class='hs-comment'>-- useless "r = r" assignments, which are not merely annoying:</span>
<a name="line-114"></a>        <span class='hs-comment'>-- they prevent the common block elimination from working correctly</span>
<a name="line-115"></a>        <span class='hs-comment'>-- in the case of a safe foreign call.</span>
<a name="line-116"></a>        <span class='hs-comment'>-- See Note [safe foreign call convention]</span>
<a name="line-117"></a>        <span class='hs-comment'>--</span>
<a name="line-118"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>sequel</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSequel</span>
<a name="line-119"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>sequel</span> <span class='hs-keyword'>of</span>
<a name="line-120"></a>            <span class='hs-conid'>AssignTo</span> <span class='hs-varid'>assign_to_these</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-121"></a>                <span class='hs-varid'>emitForeignCall</span> <span class='hs-varid'>safety</span> <span class='hs-varid'>assign_to_these</span> <span class='hs-varid'>call_target</span> <span class='hs-varid'>call_args</span>
<a name="line-122"></a>
<a name="line-123"></a>            <span class='hs-sel'>_something_else</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-124"></a>                <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>emitForeignCall</span> <span class='hs-varid'>safety</span> <span class='hs-varid'>res_regs</span> <span class='hs-varid'>call_target</span> <span class='hs-varid'>call_args</span>
<a name="line-125"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>emitReturn</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varop'>.</span> <span class='hs-conid'>CmmLocal</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_regs</span><span class='hs-layout'>)</span>
<a name="line-126"></a>                   <span class='hs-layout'>}</span>
<a name="line-127"></a>         <span class='hs-layout'>}</span>
<a name="line-128"></a>
<a name="line-129"></a><span class='hs-comment'>{- Note [safe foreign call convention]
<a name="line-130"></a>
<a name="line-131"></a>The simple thing to do for a safe foreign call would be the same as an
<a name="line-132"></a>unsafe one: just
<a name="line-133"></a>
<a name="line-134"></a>    emitForeignCall ...
<a name="line-135"></a>    emitReturn ...
<a name="line-136"></a>
<a name="line-137"></a>but consider what happens in this case
<a name="line-138"></a>
<a name="line-139"></a>   case foo x y z of
<a name="line-140"></a>     (# s, r #) -&gt; ...
<a name="line-141"></a>
<a name="line-142"></a>The sequel is AssignTo [r].  The call to newUnboxedTupleRegs picks [r]
<a name="line-143"></a>as the result reg, and we generate
<a name="line-144"></a>
<a name="line-145"></a>  r = foo(x,y,z) returns to L1  -- emitForeignCall
<a name="line-146"></a> L1:
<a name="line-147"></a>  r = r  -- emitReturn
<a name="line-148"></a>  goto L2
<a name="line-149"></a>L2:
<a name="line-150"></a>  ...
<a name="line-151"></a>
<a name="line-152"></a>Now L1 is a proc point (by definition, it is the continuation of the
<a name="line-153"></a>safe foreign call).  If L2 does a heap check, then L2 will also be a
<a name="line-154"></a>proc point.
<a name="line-155"></a>
<a name="line-156"></a>Furthermore, the stack layout algorithm has to arrange to save r
<a name="line-157"></a>somewhere between the call and the jump to L1, which is annoying: we
<a name="line-158"></a>would have to treat r differently from the other live variables, which
<a name="line-159"></a>have to be saved *before* the call.
<a name="line-160"></a>
<a name="line-161"></a>So we adopt a special convention for safe foreign calls: the results
<a name="line-162"></a>are copied out according to the NativeReturn convention by the call,
<a name="line-163"></a>and the continuation of the call should copyIn the results.  (The
<a name="line-164"></a>copyOut code is actually inserted when the safe foreign call is
<a name="line-165"></a>lowered later).  The result regs attached to the safe foreign call are
<a name="line-166"></a>only used temporarily to hold the results before they are copied out.
<a name="line-167"></a>
<a name="line-168"></a>We will now generate this:
<a name="line-169"></a>
<a name="line-170"></a>  r = foo(x,y,z) returns to L1
<a name="line-171"></a> L1:
<a name="line-172"></a>  r = R1  -- copyIn, inserted by mkSafeCall
<a name="line-173"></a>  goto L2
<a name="line-174"></a> L2:
<a name="line-175"></a>  ... r ...
<a name="line-176"></a>
<a name="line-177"></a>And when the safe foreign call is lowered later (see Note [lower safe
<a name="line-178"></a>foreign calls]) we get this:
<a name="line-179"></a>
<a name="line-180"></a>  suspendThread()
<a name="line-181"></a>  r = foo(x,y,z)
<a name="line-182"></a>  resumeThread()
<a name="line-183"></a>  R1 = r  -- copyOut, inserted by lowerSafeForeignCall
<a name="line-184"></a>  jump L1
<a name="line-185"></a> L1:
<a name="line-186"></a>  r = R1  -- copyIn, inserted by mkSafeCall
<a name="line-187"></a>  goto L2
<a name="line-188"></a> L2:
<a name="line-189"></a>  ... r ...
<a name="line-190"></a>
<a name="line-191"></a>Now consider what happens if L2 does a heap check: the Adams
<a name="line-192"></a>optimisation kicks in and commons up L1 with the heap-check
<a name="line-193"></a>continuation, resulting in just one proc point instead of two. Yay!
<a name="line-194"></a>-}</span>
<a name="line-195"></a>
<a name="line-196"></a>
<a name="line-197"></a><a name="emitCCall"></a><span class='hs-definition'>emitCCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CmmFormal</span><span class='hs-layout'>,</span><span class='hs-conid'>ForeignHint</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-198"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span>
<a name="line-199"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CmmActual</span><span class='hs-layout'>,</span><span class='hs-conid'>ForeignHint</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-200"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>()</span>
<a name="line-201"></a><span class='hs-definition'>emitCCall</span> <span class='hs-varid'>hinted_results</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>hinted_args</span>
<a name="line-202"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>void</span> <span class='hs-varop'>$</span> <span class='hs-varid'>emitForeignCall</span> <span class='hs-conid'>PlayRisky</span> <span class='hs-varid'>results</span> <span class='hs-varid'>target</span> <span class='hs-varid'>args</span>
<a name="line-203"></a>  <span class='hs-keyword'>where</span>
<a name="line-204"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_hints</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>hinted_args</span>
<a name="line-205"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>results</span><span class='hs-layout'>,</span> <span class='hs-varid'>result_hints</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>hinted_results</span>
<a name="line-206"></a>    <span class='hs-varid'>target</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForeignTarget</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>fc</span>
<a name="line-207"></a>    <span class='hs-varid'>fc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForeignConvention</span> <span class='hs-conid'>CCallConv</span> <span class='hs-varid'>arg_hints</span> <span class='hs-varid'>result_hints</span> <span class='hs-conid'>CmmMayReturn</span>
<a name="line-208"></a>
<a name="line-209"></a>
<a name="line-210"></a><a name="emitPrimCall"></a><span class='hs-definition'>emitPrimCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmFormal</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CallishMachOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmActual</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>()</span>
<a name="line-211"></a><span class='hs-definition'>emitPrimCall</span> <span class='hs-varid'>res</span> <span class='hs-varid'>op</span> <span class='hs-varid'>args</span>
<a name="line-212"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>void</span> <span class='hs-varop'>$</span> <span class='hs-varid'>emitForeignCall</span> <span class='hs-conid'>PlayRisky</span> <span class='hs-varid'>res</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimTarget</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-213"></a>
<a name="line-214"></a><a name="emitForeignCall"></a><span class='hs-comment'>-- alternative entry point, used by GHC.Cmm.Parser</span>
<a name="line-215"></a><span class='hs-definition'>emitForeignCall</span>
<a name="line-216"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Safety</span>
<a name="line-217"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmFormal</span><span class='hs-keyglyph'>]</span>          <span class='hs-comment'>-- where to put the results</span>
<a name="line-218"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ForeignTarget</span>        <span class='hs-comment'>-- the op</span>
<a name="line-219"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmActual</span><span class='hs-keyglyph'>]</span>          <span class='hs-comment'>-- arguments</span>
<a name="line-220"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>ReturnKind</span>
<a name="line-221"></a><span class='hs-definition'>emitForeignCall</span> <span class='hs-varid'>safety</span> <span class='hs-varid'>results</span> <span class='hs-varid'>target</span> <span class='hs-varid'>args</span>
<a name="line-222"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>playSafe</span> <span class='hs-varid'>safety</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-223"></a>    <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPlatform</span>
<a name="line-224"></a>    <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>caller_save</span><span class='hs-layout'>,</span> <span class='hs-varid'>caller_load</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>callerSaveVolatileRegs</span> <span class='hs-varid'>platform</span>
<a name="line-225"></a>    <span class='hs-varid'>emit</span> <span class='hs-varid'>caller_save</span>
<a name="line-226"></a>    <span class='hs-varid'>target'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>load_target_into_temp</span> <span class='hs-varid'>target</span>
<a name="line-227"></a>    <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>maybe_assign_temp</span> <span class='hs-varid'>args</span>
<a name="line-228"></a>    <span class='hs-varid'>emit</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkUnsafeCall</span> <span class='hs-varid'>target'</span> <span class='hs-varid'>results</span> <span class='hs-varid'>args'</span>
<a name="line-229"></a>    <span class='hs-varid'>emit</span> <span class='hs-varid'>caller_load</span>
<a name="line-230"></a>    <span class='hs-varid'>return</span> <span class='hs-conid'>AssignedDirectly</span>
<a name="line-231"></a>
<a name="line-232"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-233"></a>    <span class='hs-varid'>profile</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getProfile</span>
<a name="line-234"></a>    <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPlatform</span>
<a name="line-235"></a>    <span class='hs-varid'>updfr_off</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getUpdFrameOff</span>
<a name="line-236"></a>    <span class='hs-varid'>target'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>load_target_into_temp</span> <span class='hs-varid'>target</span>
<a name="line-237"></a>    <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>maybe_assign_temp</span> <span class='hs-varid'>args</span>
<a name="line-238"></a>    <span class='hs-varid'>k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newBlockId</span>
<a name="line-239"></a>    <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>off</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>copyout</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>copyInOflow</span> <span class='hs-varid'>profile</span> <span class='hs-conid'>NativeReturn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Young</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-varid'>results</span> <span class='hs-conid'>[]</span>
<a name="line-240"></a>       <span class='hs-comment'>-- see Note [safe foreign call convention]</span>
<a name="line-241"></a>    <span class='hs-varid'>tscope</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTickScope</span>
<a name="line-242"></a>    <span class='hs-varid'>emit</span> <span class='hs-varop'>$</span>
<a name="line-243"></a>           <span class='hs-layout'>(</span>    <span class='hs-varid'>mkStore</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmStackSlot</span> <span class='hs-layout'>(</span><span class='hs-conid'>Young</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>widthInBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>wordWidth</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-244"></a>                        <span class='hs-layout'>(</span><span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmBlock</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-245"></a>            <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>mkLast</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmForeignCall</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tgt</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>target'</span>
<a name="line-246"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>res</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>results</span>
<a name="line-247"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args'</span>
<a name="line-248"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>succ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>k</span>
<a name="line-249"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>ret_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>off</span>
<a name="line-250"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>ret_off</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updfr_off</span>
<a name="line-251"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>intrbl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>playInterruptible</span> <span class='hs-varid'>safety</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-252"></a>            <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>mkLabel</span> <span class='hs-varid'>k</span> <span class='hs-varid'>tscope</span>
<a name="line-253"></a>            <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>copyout</span>
<a name="line-254"></a>           <span class='hs-layout'>)</span>
<a name="line-255"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ReturnedTo</span> <span class='hs-varid'>k</span> <span class='hs-varid'>off</span><span class='hs-layout'>)</span>
<a name="line-256"></a>
<a name="line-257"></a><a name="load_target_into_temp"></a><span class='hs-definition'>load_target_into_temp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignTarget</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>ForeignTarget</span>
<a name="line-258"></a><span class='hs-definition'>load_target_into_temp</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignTarget</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>conv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-259"></a>  <span class='hs-varid'>tmp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybe_assign_temp</span> <span class='hs-varid'>expr</span>
<a name="line-260"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignTarget</span> <span class='hs-varid'>tmp</span> <span class='hs-varid'>conv</span><span class='hs-layout'>)</span>
<a name="line-261"></a><span class='hs-definition'>load_target_into_temp</span> <span class='hs-varid'>other_target</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PrimTarget</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-262"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>other_target</span>
<a name="line-263"></a>
<a name="line-264"></a><a name="maybe_assign_temp"></a><span class='hs-comment'>-- What we want to do here is create a new temporary for the foreign</span>
<a name="line-265"></a><span class='hs-comment'>-- call argument if it is not safe to use the expression directly,</span>
<a name="line-266"></a><span class='hs-comment'>-- because the expression mentions caller-saves GlobalRegs (see</span>
<a name="line-267"></a><span class='hs-comment'>-- Note [Register parameter passing]).</span>
<a name="line-268"></a><span class='hs-comment'>--</span>
<a name="line-269"></a><span class='hs-comment'>-- However, we can't pattern-match on the expression here, because</span>
<a name="line-270"></a><span class='hs-comment'>-- this is used in a loop by GHC.Cmm.Parser, and testing the expression</span>
<a name="line-271"></a><span class='hs-comment'>-- results in a black hole.  So we always create a temporary, and rely</span>
<a name="line-272"></a><span class='hs-comment'>-- on GHC.Cmm.Sink to clean it up later.  (Yuck, ToDo).  The generated code</span>
<a name="line-273"></a><span class='hs-comment'>-- ends up being the same, at least for the RTS .cmm code.</span>
<a name="line-274"></a><span class='hs-comment'>--</span>
<a name="line-275"></a><span class='hs-definition'>maybe_assign_temp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>CmmExpr</span>
<a name="line-276"></a><span class='hs-definition'>maybe_assign_temp</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-277"></a>  <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPlatform</span>
<a name="line-278"></a>  <span class='hs-varid'>reg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTemp</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmExprType</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-279"></a>  <span class='hs-varid'>emitAssign</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span>
<a name="line-280"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-281"></a>
<a name="line-282"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-283"></a><span class='hs-comment'>-- Save/restore the thread state in the TSO</span>
<a name="line-284"></a>
<a name="line-285"></a><span class='hs-comment'>-- This stuff can't be done in suspendThread/resumeThread, because it</span>
<a name="line-286"></a><span class='hs-comment'>-- refers to global registers which aren't available in the C world.</span>
<a name="line-287"></a>
<a name="line-288"></a><a name="emitSaveThreadState"></a><span class='hs-definition'>emitSaveThreadState</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>()</span>
<a name="line-289"></a><span class='hs-definition'>emitSaveThreadState</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-290"></a>  <span class='hs-varid'>profile</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getProfile</span>
<a name="line-291"></a>  <span class='hs-varid'>code</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>saveThreadState</span> <span class='hs-varid'>profile</span>
<a name="line-292"></a>  <span class='hs-varid'>emit</span> <span class='hs-varid'>code</span>
<a name="line-293"></a>
<a name="line-294"></a><a name="saveThreadState"></a><span class='hs-comment'>-- | Produce code to save the current thread state to @CurrentTSO@</span>
<a name="line-295"></a><span class='hs-definition'>saveThreadState</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadUnique</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Profile</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>CmmAGraph</span>
<a name="line-296"></a><span class='hs-definition'>saveThreadState</span> <span class='hs-varid'>profile</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-297"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>profilePlatform</span> <span class='hs-varid'>profile</span>
<a name="line-298"></a>  <span class='hs-varid'>tso</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTemp</span> <span class='hs-layout'>(</span><span class='hs-varid'>gcWord</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-299"></a>  <span class='hs-varid'>close_nursery</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>closeNursery</span> <span class='hs-varid'>profile</span> <span class='hs-varid'>tso</span>
<a name="line-300"></a>  <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-varid'>catAGraphs</span>
<a name="line-301"></a>   <span class='hs-keyglyph'>[</span> <span class='hs-comment'>-- tso = CurrentTSO;</span>
<a name="line-302"></a>     <span class='hs-varid'>mkAssign</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>tso</span><span class='hs-layout'>)</span> <span class='hs-varid'>currentTSOExpr</span>
<a name="line-303"></a>
<a name="line-304"></a>   <span class='hs-layout'>,</span> <span class='hs-comment'>-- tso-&gt;stackobj-&gt;sp = Sp;</span>
<a name="line-305"></a>     <span class='hs-varid'>mkStore</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmOffset</span> <span class='hs-varid'>platform</span>
<a name="line-306"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>cmmLoadBWord</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmOffset</span> <span class='hs-varid'>platform</span>
<a name="line-307"></a>                                            <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>tso</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-308"></a>                                            <span class='hs-layout'>(</span><span class='hs-varid'>tso_stackobj</span> <span class='hs-varid'>profile</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-309"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>stack_SP</span> <span class='hs-varid'>profile</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-310"></a>             <span class='hs-varid'>spExpr</span>
<a name="line-311"></a>
<a name="line-312"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>close_nursery</span>
<a name="line-313"></a>
<a name="line-314"></a>    <span class='hs-layout'>,</span> <span class='hs-comment'>-- and save the current cost centre stack in the TSO when profiling:</span>
<a name="line-315"></a>      <span class='hs-keyword'>if</span> <span class='hs-varid'>profileIsProfiling</span> <span class='hs-varid'>profile</span>
<a name="line-316"></a>         <span class='hs-keyword'>then</span> <span class='hs-varid'>mkStore</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmOffset</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>tso</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tso_CCCS</span> <span class='hs-varid'>profile</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>cccsExpr</span>
<a name="line-317"></a>         <span class='hs-keyword'>else</span> <span class='hs-varid'>mkNop</span>
<a name="line-318"></a>    <span class='hs-keyglyph'>]</span>
<a name="line-319"></a>
<a name="line-320"></a>
<a name="line-321"></a>
<a name="line-322"></a><a name="emitSaveRegs"></a><span class='hs-comment'>-- | Save STG registers</span>
<a name="line-323"></a><span class='hs-comment'>--</span>
<a name="line-324"></a><span class='hs-comment'>-- STG registers must be saved around a C call, just in case the STG</span>
<a name="line-325"></a><span class='hs-comment'>-- register is mapped to a caller-saves machine register.  Normally we</span>
<a name="line-326"></a><span class='hs-comment'>-- don't need to worry about this the code generator has already</span>
<a name="line-327"></a><span class='hs-comment'>-- loaded any live STG registers into variables for us, but in</span>
<a name="line-328"></a><span class='hs-comment'>-- hand-written low-level Cmm code where we don't know which registers</span>
<a name="line-329"></a><span class='hs-comment'>-- are live, we might have to save them all.</span>
<a name="line-330"></a><span class='hs-definition'>emitSaveRegs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>()</span>
<a name="line-331"></a><span class='hs-definition'>emitSaveRegs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-332"></a>   <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPlatform</span>
<a name="line-333"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>regs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>realArgRegsCover</span> <span class='hs-varid'>platform</span>
<a name="line-334"></a>       <span class='hs-varid'>save</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>catAGraphs</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>callerSaveGlobalReg</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span> <span class='hs-varid'>regs</span><span class='hs-layout'>)</span>
<a name="line-335"></a>   <span class='hs-varid'>emit</span> <span class='hs-varid'>save</span>
<a name="line-336"></a>
<a name="line-337"></a><a name="emitRestoreRegs"></a><span class='hs-comment'>-- | Restore STG registers (see 'emitSaveRegs')</span>
<a name="line-338"></a><span class='hs-definition'>emitRestoreRegs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>()</span>
<a name="line-339"></a><span class='hs-definition'>emitRestoreRegs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-340"></a>   <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPlatform</span>
<a name="line-341"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>regs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>realArgRegsCover</span> <span class='hs-varid'>platform</span>
<a name="line-342"></a>       <span class='hs-varid'>restore</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>catAGraphs</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>callerRestoreGlobalReg</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span> <span class='hs-varid'>regs</span><span class='hs-layout'>)</span>
<a name="line-343"></a>   <span class='hs-varid'>emit</span> <span class='hs-varid'>restore</span>
<a name="line-344"></a>
<a name="line-345"></a><span class='hs-comment'>-- | Push a subset of STG registers onto the stack, specified by the bitmap</span>
<a name="line-346"></a><span class='hs-comment'>--</span>
<a name="line-347"></a><span class='hs-comment'>-- Sometimes, a "live" subset of the STG registers needs to be saved on the</span>
<a name="line-348"></a><span class='hs-comment'>-- stack, for example when storing an unboxed tuple to be used in the GHCi</span>
<a name="line-349"></a><span class='hs-comment'>-- bytecode interpreter.</span>
<a name="line-350"></a><span class='hs-comment'>--</span>
<a name="line-351"></a><span class='hs-comment'>-- The "live registers" bitmap corresponds to the list of registers given by</span>
<a name="line-352"></a><span class='hs-comment'>-- 'tupleRegsCover', with the least significant bit indicating liveness of</span>
<a name="line-353"></a><span class='hs-comment'>-- the first register in the list.</span>
<a name="line-354"></a><span class='hs-comment'>--</span>
<a name="line-355"></a><span class='hs-comment'>-- Each register is saved to a stack slot of one or more machine words, even</span>
<a name="line-356"></a><span class='hs-comment'>-- if the register size itself is smaller.</span>
<a name="line-357"></a><span class='hs-comment'>--</span>
<a name="line-358"></a><span class='hs-comment'>-- The resulting Cmm code looks like this, with a line for each real or</span>
<a name="line-359"></a><span class='hs-comment'>-- virtual register used for returning tuples:</span>
<a name="line-360"></a><span class='hs-comment'>--</span>
<a name="line-361"></a><span class='hs-comment'>--    ...</span>
<a name="line-362"></a><span class='hs-comment'>--    if((mask &amp; 2) != 0) { Sp_adj(-1); Sp(0) = R2; }</span>
<a name="line-363"></a><span class='hs-comment'>--    if((mask &amp; 1) != 0) { Sp_adj(-1); Sp(0) = R1; }</span>
<a name="line-364"></a><span class='hs-comment'>--</span>
<a name="line-365"></a><span class='hs-comment'>-- See Note [GHCi tuple layout]</span>
<a name="line-366"></a>
<a name="line-367"></a><a name="emitPushTupleRegs"></a><span class='hs-definition'>emitPushTupleRegs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>()</span>
<a name="line-368"></a><span class='hs-definition'>emitPushTupleRegs</span> <span class='hs-varid'>regs_live</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-369"></a>  <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPlatform</span>
<a name="line-370"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>regs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zip</span> <span class='hs-layout'>(</span><span class='hs-varid'>tupleRegsCover</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span>
<a name="line-371"></a>      <span class='hs-varid'>save_arg</span> <span class='hs-layout'>(</span><span class='hs-varid'>reg</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-372"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>mask</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmInt</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span> <span class='hs-varop'>`shiftL`</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>wordWidth</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-373"></a>            <span class='hs-varid'>live</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmAndWord</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>regs_live</span> <span class='hs-varid'>mask</span>
<a name="line-374"></a>            <span class='hs-varid'>cond</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmNeWord</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>live</span> <span class='hs-layout'>(</span><span class='hs-varid'>zeroExpr</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-375"></a>            <span class='hs-varid'>reg_ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmRegType</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span>
<a name="line-376"></a>            <span class='hs-varid'>width</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>roundUpToWords</span> <span class='hs-varid'>platform</span>
<a name="line-377"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>widthInBytes</span> <span class='hs-varop'>$</span> <span class='hs-varid'>typeWidth</span> <span class='hs-varid'>reg_ty</span><span class='hs-layout'>)</span>
<a name="line-378"></a>            <span class='hs-varid'>adj_sp</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAssign</span> <span class='hs-varid'>spReg</span>
<a name="line-379"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>cmmOffset</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>spExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>negate</span> <span class='hs-varid'>width</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-380"></a>            <span class='hs-varid'>save_reg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkStore</span> <span class='hs-varid'>spExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CmmGlobal</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span>
<a name="line-381"></a>        <span class='hs-keyword'>in</span> <span class='hs-varid'>mkCmmIfThen</span> <span class='hs-varid'>cond</span> <span class='hs-varop'>$</span> <span class='hs-varid'>catAGraphs</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>adj_sp</span><span class='hs-layout'>,</span> <span class='hs-varid'>save_reg</span><span class='hs-keyglyph'>]</span>
<a name="line-382"></a>  <span class='hs-varid'>emit</span> <span class='hs-varop'>.</span> <span class='hs-varid'>catAGraphs</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>save_arg</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>regs</span><span class='hs-layout'>)</span>
<a name="line-383"></a>
<a name="line-384"></a><a name="emitPopTupleRegs"></a><span class='hs-comment'>-- | Pop a subset of STG registers from the stack (see 'emitPushTupleRegs')</span>
<a name="line-385"></a><span class='hs-definition'>emitPopTupleRegs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>()</span>
<a name="line-386"></a><span class='hs-definition'>emitPopTupleRegs</span> <span class='hs-varid'>regs_live</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-387"></a>  <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPlatform</span>
<a name="line-388"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>regs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zip</span> <span class='hs-layout'>(</span><span class='hs-varid'>tupleRegsCover</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span>
<a name="line-389"></a>      <span class='hs-varid'>save_arg</span> <span class='hs-layout'>(</span><span class='hs-varid'>reg</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-390"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>mask</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmInt</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span> <span class='hs-varop'>`shiftL`</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>wordWidth</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-391"></a>            <span class='hs-varid'>live</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmAndWord</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>regs_live</span> <span class='hs-varid'>mask</span>
<a name="line-392"></a>            <span class='hs-varid'>cond</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmNeWord</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>live</span> <span class='hs-layout'>(</span><span class='hs-varid'>zeroExpr</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-393"></a>            <span class='hs-varid'>reg_ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmRegType</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span>
<a name="line-394"></a>            <span class='hs-varid'>width</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>roundUpToWords</span> <span class='hs-varid'>platform</span>
<a name="line-395"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>widthInBytes</span> <span class='hs-varop'>$</span> <span class='hs-varid'>typeWidth</span> <span class='hs-varid'>reg_ty</span><span class='hs-layout'>)</span>
<a name="line-396"></a>            <span class='hs-varid'>adj_sp</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAssign</span> <span class='hs-varid'>spReg</span>
<a name="line-397"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>cmmOffset</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>spExpr</span> <span class='hs-varid'>width</span><span class='hs-layout'>)</span>
<a name="line-398"></a>            <span class='hs-varid'>restore_reg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAssign</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLoad</span> <span class='hs-varid'>spExpr</span> <span class='hs-varid'>reg_ty</span> <span class='hs-conid'>NaturallyAligned</span><span class='hs-layout'>)</span>
<a name="line-399"></a>        <span class='hs-keyword'>in</span> <span class='hs-varid'>mkCmmIfThen</span> <span class='hs-varid'>cond</span> <span class='hs-varop'>$</span> <span class='hs-varid'>catAGraphs</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>restore_reg</span><span class='hs-layout'>,</span> <span class='hs-varid'>adj_sp</span><span class='hs-keyglyph'>]</span>
<a name="line-400"></a>  <span class='hs-varid'>emit</span> <span class='hs-varop'>.</span> <span class='hs-varid'>catAGraphs</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>save_arg</span> <span class='hs-varid'>regs</span>
<a name="line-401"></a>
<a name="line-402"></a>
<a name="line-403"></a><a name="emitCloseNursery"></a><span class='hs-definition'>emitCloseNursery</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>()</span>
<a name="line-404"></a><span class='hs-definition'>emitCloseNursery</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-405"></a>  <span class='hs-varid'>profile</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getProfile</span>
<a name="line-406"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>profilePlatform</span> <span class='hs-varid'>profile</span>
<a name="line-407"></a>  <span class='hs-varid'>tso</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTemp</span> <span class='hs-layout'>(</span><span class='hs-varid'>bWord</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-408"></a>  <span class='hs-varid'>code</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>closeNursery</span> <span class='hs-varid'>profile</span> <span class='hs-varid'>tso</span>
<a name="line-409"></a>  <span class='hs-varid'>emit</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkAssign</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>tso</span><span class='hs-layout'>)</span> <span class='hs-varid'>currentTSOExpr</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>code</span>
<a name="line-410"></a>
<a name="line-411"></a><a name="closeNursery"></a><span class='hs-comment'>{- |
<a name="line-412"></a>@closeNursery dflags tso@ produces code to close the nursery.
<a name="line-413"></a>A local register holding the value of @CurrentTSO@ is expected for
<a name="line-414"></a>efficiency.
<a name="line-415"></a>
<a name="line-416"></a>Closing the nursery corresponds to the following code:
<a name="line-417"></a>
<a name="line-418"></a>@
<a name="line-419"></a>  tso = CurrentTSO;
<a name="line-420"></a>  cn = CurrentNuresry;
<a name="line-421"></a>
<a name="line-422"></a>  // Update the allocation limit for the current thread.  We don't
<a name="line-423"></a>  // check to see whether it has overflowed at this point, that check is
<a name="line-424"></a>  // made when we run out of space in the current heap block (stg_gc_noregs)
<a name="line-425"></a>  // and in the scheduler when context switching (schedulePostRunThread).
<a name="line-426"></a>  tso-&gt;alloc_limit -= Hp + WDS(1) - cn-&gt;start;
<a name="line-427"></a>
<a name="line-428"></a>  // Set cn-&gt;free to the next unoccupied word in the block
<a name="line-429"></a>  cn-&gt;free = Hp + WDS(1);
<a name="line-430"></a>@
<a name="line-431"></a>-}</span>
<a name="line-432"></a><span class='hs-definition'>closeNursery</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadUnique</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Profile</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LocalReg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>CmmAGraph</span>
<a name="line-433"></a><span class='hs-definition'>closeNursery</span> <span class='hs-varid'>profile</span> <span class='hs-varid'>tso</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-434"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>tsoreg</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>tso</span>
<a name="line-435"></a>      <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>profilePlatform</span> <span class='hs-varid'>profile</span>
<a name="line-436"></a>  <span class='hs-varid'>cnreg</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>CmmLocal</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>newTemp</span> <span class='hs-layout'>(</span><span class='hs-varid'>bWord</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-437"></a>  <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-varid'>catAGraphs</span> <span class='hs-keyglyph'>[</span>
<a name="line-438"></a>    <span class='hs-varid'>mkAssign</span> <span class='hs-varid'>cnreg</span> <span class='hs-varid'>currentNurseryExpr</span><span class='hs-layout'>,</span>
<a name="line-439"></a>
<a name="line-440"></a>    <span class='hs-comment'>-- CurrentNursery-&gt;free = Hp+1;</span>
<a name="line-441"></a>    <span class='hs-varid'>mkStore</span> <span class='hs-layout'>(</span><span class='hs-varid'>nursery_bdescr_free</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>cnreg</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmOffsetW</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>hpExpr</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-442"></a>
<a name="line-443"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>alloc</span> <span class='hs-keyglyph'>=</span>
<a name="line-444"></a>           <span class='hs-conid'>CmmMachOp</span> <span class='hs-layout'>(</span><span class='hs-varid'>mo_wordSub</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-445"></a>              <span class='hs-keyglyph'>[</span> <span class='hs-varid'>cmmOffsetW</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>hpExpr</span> <span class='hs-num'>1</span>
<a name="line-446"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>cmmLoadBWord</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-varid'>nursery_bdescr_start</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>cnreg</span><span class='hs-layout'>)</span>
<a name="line-447"></a>              <span class='hs-keyglyph'>]</span>
<a name="line-448"></a>
<a name="line-449"></a>        <span class='hs-varid'>alloc_limit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmOffset</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>tsoreg</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tso_alloc_limit</span> <span class='hs-varid'>profile</span><span class='hs-layout'>)</span>
<a name="line-450"></a>    <span class='hs-keyword'>in</span>
<a name="line-451"></a>
<a name="line-452"></a>    <span class='hs-comment'>-- tso-&gt;alloc_limit += alloc</span>
<a name="line-453"></a>    <span class='hs-varid'>mkStore</span> <span class='hs-varid'>alloc_limit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmMachOp</span> <span class='hs-layout'>(</span><span class='hs-conid'>MO_Sub</span> <span class='hs-conid'>W64</span><span class='hs-layout'>)</span>
<a name="line-454"></a>                               <span class='hs-keyglyph'>[</span> <span class='hs-conid'>CmmLoad</span> <span class='hs-varid'>alloc_limit</span> <span class='hs-varid'>b64</span> <span class='hs-conid'>NaturallyAligned</span>
<a name="line-455"></a>                               <span class='hs-layout'>,</span> <span class='hs-conid'>CmmMachOp</span> <span class='hs-layout'>(</span><span class='hs-varid'>mo_WordTo64</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>alloc</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-456"></a>   <span class='hs-keyglyph'>]</span>
<a name="line-457"></a>
<a name="line-458"></a><a name="emitLoadThreadState"></a><span class='hs-definition'>emitLoadThreadState</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>()</span>
<a name="line-459"></a><span class='hs-definition'>emitLoadThreadState</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-460"></a>  <span class='hs-varid'>profile</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getProfile</span>
<a name="line-461"></a>  <span class='hs-varid'>code</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loadThreadState</span> <span class='hs-varid'>profile</span>
<a name="line-462"></a>  <span class='hs-varid'>emit</span> <span class='hs-varid'>code</span>
<a name="line-463"></a>
<a name="line-464"></a><a name="loadThreadState"></a><span class='hs-comment'>-- | Produce code to load the current thread state from @CurrentTSO@</span>
<a name="line-465"></a><span class='hs-definition'>loadThreadState</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadUnique</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Profile</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>CmmAGraph</span>
<a name="line-466"></a><span class='hs-definition'>loadThreadState</span> <span class='hs-varid'>profile</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-467"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>profilePlatform</span> <span class='hs-varid'>profile</span>
<a name="line-468"></a>  <span class='hs-varid'>tso</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTemp</span> <span class='hs-layout'>(</span><span class='hs-varid'>gcWord</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-469"></a>  <span class='hs-varid'>stack</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTemp</span> <span class='hs-layout'>(</span><span class='hs-varid'>gcWord</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-470"></a>  <span class='hs-varid'>open_nursery</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>openNursery</span> <span class='hs-varid'>profile</span> <span class='hs-varid'>tso</span>
<a name="line-471"></a>  <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-varid'>catAGraphs</span> <span class='hs-keyglyph'>[</span>
<a name="line-472"></a>    <span class='hs-comment'>-- tso = CurrentTSO;</span>
<a name="line-473"></a>    <span class='hs-varid'>mkAssign</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>tso</span><span class='hs-layout'>)</span> <span class='hs-varid'>currentTSOExpr</span><span class='hs-layout'>,</span>
<a name="line-474"></a>    <span class='hs-comment'>-- stack = tso-&gt;stackobj;</span>
<a name="line-475"></a>    <span class='hs-varid'>mkAssign</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>stack</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmLoadBWord</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmOffset</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>tso</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tso_stackobj</span> <span class='hs-varid'>profile</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-476"></a>    <span class='hs-comment'>-- Sp = stack-&gt;sp;</span>
<a name="line-477"></a>    <span class='hs-varid'>mkAssign</span> <span class='hs-varid'>spReg</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmLoadBWord</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmOffset</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>stack</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>stack_SP</span> <span class='hs-varid'>profile</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-478"></a>    <span class='hs-comment'>-- SpLim = stack-&gt;stack + RESERVED_STACK_WORDS;</span>
<a name="line-479"></a>    <span class='hs-varid'>mkAssign</span> <span class='hs-varid'>spLimReg</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmOffsetW</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmOffset</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>stack</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>stack_STACK</span> <span class='hs-varid'>profile</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-480"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>pc_RESERVED_STACK_WORDS</span> <span class='hs-layout'>(</span><span class='hs-varid'>platformConstants</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-481"></a>    <span class='hs-comment'>-- HpAlloc = 0;</span>
<a name="line-482"></a>    <span class='hs-comment'>--   HpAlloc is assumed to be set to non-zero only by a failed</span>
<a name="line-483"></a>    <span class='hs-comment'>--   a heap check, see HeapStackCheck.cmm:GC_GENERIC</span>
<a name="line-484"></a>    <span class='hs-varid'>mkAssign</span> <span class='hs-varid'>hpAllocReg</span> <span class='hs-layout'>(</span><span class='hs-varid'>zeroExpr</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-485"></a>    <span class='hs-varid'>open_nursery</span><span class='hs-layout'>,</span>
<a name="line-486"></a>    <span class='hs-comment'>-- and load the current cost centre stack from the TSO when profiling:</span>
<a name="line-487"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>profileIsProfiling</span> <span class='hs-varid'>profile</span>
<a name="line-488"></a>       <span class='hs-keyword'>then</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ccs_ptr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmOffset</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>tso</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tso_CCCS</span> <span class='hs-varid'>profile</span><span class='hs-layout'>)</span>
<a name="line-489"></a>            <span class='hs-keyword'>in</span> <span class='hs-varid'>storeCurCCS</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLoad</span> <span class='hs-varid'>ccs_ptr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ccsType</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span> <span class='hs-conid'>NaturallyAligned</span><span class='hs-layout'>)</span>
<a name="line-490"></a>       <span class='hs-keyword'>else</span> <span class='hs-varid'>mkNop</span>
<a name="line-491"></a>   <span class='hs-keyglyph'>]</span>
<a name="line-492"></a>
<a name="line-493"></a>
<a name="line-494"></a><a name="emitOpenNursery"></a><span class='hs-definition'>emitOpenNursery</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>()</span>
<a name="line-495"></a><span class='hs-definition'>emitOpenNursery</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-496"></a>  <span class='hs-varid'>profile</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getProfile</span>
<a name="line-497"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>profilePlatform</span> <span class='hs-varid'>profile</span>
<a name="line-498"></a>  <span class='hs-varid'>tso</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTemp</span> <span class='hs-layout'>(</span><span class='hs-varid'>bWord</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-499"></a>  <span class='hs-varid'>code</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>openNursery</span> <span class='hs-varid'>profile</span> <span class='hs-varid'>tso</span>
<a name="line-500"></a>  <span class='hs-varid'>emit</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkAssign</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>tso</span><span class='hs-layout'>)</span> <span class='hs-varid'>currentTSOExpr</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>code</span>
<a name="line-501"></a>
<a name="line-502"></a><a name="openNursery"></a><span class='hs-comment'>{- |
<a name="line-503"></a>@openNursery profile tso@ produces code to open the nursery. A local register
<a name="line-504"></a>holding the value of @CurrentTSO@ is expected for efficiency.
<a name="line-505"></a>
<a name="line-506"></a>Opening the nursery corresponds to the following code:
<a name="line-507"></a>
<a name="line-508"></a>@
<a name="line-509"></a>   tso = CurrentTSO;
<a name="line-510"></a>   cn = CurrentNursery;
<a name="line-511"></a>   bdfree = CurrentNursery-&gt;free;
<a name="line-512"></a>   bdstart = CurrentNursery-&gt;start;
<a name="line-513"></a>
<a name="line-514"></a>   // We *add* the currently occupied portion of the nursery block to
<a name="line-515"></a>   // the allocation limit, because we will subtract it again in
<a name="line-516"></a>   // closeNursery.
<a name="line-517"></a>   tso-&gt;alloc_limit += bdfree - bdstart;
<a name="line-518"></a>
<a name="line-519"></a>   // Set Hp to the last occupied word of the heap block.  Why not the
<a name="line-520"></a>   // next unoccupied word?  Doing it this way means that we get to use
<a name="line-521"></a>   // an offset of zero more often, which might lead to slightly smaller
<a name="line-522"></a>   // code on some architectures.
<a name="line-523"></a>   Hp = bdfree - WDS(1);
<a name="line-524"></a>
<a name="line-525"></a>   // Set HpLim to the end of the current nursery block (note that this block
<a name="line-526"></a>   // might be a block group, consisting of several adjacent blocks.
<a name="line-527"></a>   HpLim = bdstart + CurrentNursery-&gt;blocks*BLOCK_SIZE_W - 1;
<a name="line-528"></a>@
<a name="line-529"></a>-}</span>
<a name="line-530"></a><span class='hs-definition'>openNursery</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadUnique</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Profile</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LocalReg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>CmmAGraph</span>
<a name="line-531"></a><span class='hs-definition'>openNursery</span> <span class='hs-varid'>profile</span> <span class='hs-varid'>tso</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-532"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>tsoreg</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>tso</span>
<a name="line-533"></a>      <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>profilePlatform</span> <span class='hs-varid'>profile</span>
<a name="line-534"></a>  <span class='hs-varid'>cnreg</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>CmmLocal</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>newTemp</span> <span class='hs-layout'>(</span><span class='hs-varid'>bWord</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-535"></a>  <span class='hs-varid'>bdfreereg</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>CmmLocal</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>newTemp</span> <span class='hs-layout'>(</span><span class='hs-varid'>bWord</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-536"></a>  <span class='hs-varid'>bdstartreg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>CmmLocal</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>newTemp</span> <span class='hs-layout'>(</span><span class='hs-varid'>bWord</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-537"></a>
<a name="line-538"></a>  <span class='hs-comment'>-- These assignments are carefully ordered to reduce register</span>
<a name="line-539"></a>  <span class='hs-comment'>-- pressure and generate not completely awful code on x86.  To see</span>
<a name="line-540"></a>  <span class='hs-comment'>-- what code we generate, look at the assembly for</span>
<a name="line-541"></a>  <span class='hs-comment'>-- stg_returnToStackTop in rts/StgStartup.cmm.</span>
<a name="line-542"></a>  <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-varid'>catAGraphs</span> <span class='hs-keyglyph'>[</span>
<a name="line-543"></a>     <span class='hs-varid'>mkAssign</span> <span class='hs-varid'>cnreg</span> <span class='hs-varid'>currentNurseryExpr</span><span class='hs-layout'>,</span>
<a name="line-544"></a>     <span class='hs-varid'>mkAssign</span> <span class='hs-varid'>bdfreereg</span>  <span class='hs-layout'>(</span><span class='hs-varid'>cmmLoadBWord</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-varid'>nursery_bdescr_free</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>cnreg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-545"></a>
<a name="line-546"></a>     <span class='hs-comment'>-- Hp = CurrentNursery-&gt;free - 1;</span>
<a name="line-547"></a>     <span class='hs-varid'>mkAssign</span> <span class='hs-varid'>hpReg</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmOffsetW</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>bdfreereg</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-548"></a>
<a name="line-549"></a>     <span class='hs-varid'>mkAssign</span> <span class='hs-varid'>bdstartreg</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmLoadBWord</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-varid'>nursery_bdescr_start</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>cnreg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-550"></a>
<a name="line-551"></a>     <span class='hs-comment'>-- HpLim = CurrentNursery-&gt;start +</span>
<a name="line-552"></a>     <span class='hs-comment'>--              CurrentNursery-&gt;blocks*BLOCK_SIZE_W - 1;</span>
<a name="line-553"></a>     <span class='hs-varid'>mkAssign</span> <span class='hs-varid'>hpLimReg</span>
<a name="line-554"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>cmmOffsetExpr</span> <span class='hs-varid'>platform</span>
<a name="line-555"></a>             <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>bdstartreg</span><span class='hs-layout'>)</span>
<a name="line-556"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>cmmOffset</span> <span class='hs-varid'>platform</span>
<a name="line-557"></a>               <span class='hs-layout'>(</span><span class='hs-conid'>CmmMachOp</span> <span class='hs-layout'>(</span><span class='hs-varid'>mo_wordMul</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-558"></a>                 <span class='hs-keyglyph'>[</span> <span class='hs-conid'>CmmMachOp</span> <span class='hs-layout'>(</span><span class='hs-conid'>MO_SS_Conv</span> <span class='hs-conid'>W32</span> <span class='hs-layout'>(</span><span class='hs-varid'>wordWidth</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-559"></a>                     <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmLoad</span> <span class='hs-layout'>(</span><span class='hs-varid'>nursery_bdescr_blocks</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>cnreg</span><span class='hs-layout'>)</span> <span class='hs-varid'>b32</span> <span class='hs-conid'>NaturallyAligned</span><span class='hs-keyglyph'>]</span>
<a name="line-560"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>mkIntExpr</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-varid'>pc_BLOCK_SIZE</span> <span class='hs-layout'>(</span><span class='hs-varid'>platformConstants</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-561"></a>                 <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-562"></a>               <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-563"></a>             <span class='hs-layout'>)</span>
<a name="line-564"></a>         <span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-565"></a>
<a name="line-566"></a>     <span class='hs-comment'>-- alloc = bd-&gt;free - bd-&gt;start</span>
<a name="line-567"></a>     <span class='hs-keyword'>let</span> <span class='hs-varid'>alloc</span> <span class='hs-keyglyph'>=</span>
<a name="line-568"></a>           <span class='hs-conid'>CmmMachOp</span> <span class='hs-layout'>(</span><span class='hs-varid'>mo_wordSub</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>bdfreereg</span><span class='hs-layout'>,</span> <span class='hs-conid'>CmmReg</span> <span class='hs-varid'>bdstartreg</span><span class='hs-keyglyph'>]</span>
<a name="line-569"></a>
<a name="line-570"></a>         <span class='hs-varid'>alloc_limit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmOffset</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>tsoreg</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tso_alloc_limit</span> <span class='hs-varid'>profile</span><span class='hs-layout'>)</span>
<a name="line-571"></a>     <span class='hs-keyword'>in</span>
<a name="line-572"></a>
<a name="line-573"></a>     <span class='hs-comment'>-- tso-&gt;alloc_limit += alloc</span>
<a name="line-574"></a>     <span class='hs-varid'>mkStore</span> <span class='hs-varid'>alloc_limit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmMachOp</span> <span class='hs-layout'>(</span><span class='hs-conid'>MO_Add</span> <span class='hs-conid'>W64</span><span class='hs-layout'>)</span>
<a name="line-575"></a>                               <span class='hs-keyglyph'>[</span> <span class='hs-conid'>CmmLoad</span> <span class='hs-varid'>alloc_limit</span> <span class='hs-varid'>b64</span> <span class='hs-conid'>NaturallyAligned</span>
<a name="line-576"></a>                               <span class='hs-layout'>,</span> <span class='hs-conid'>CmmMachOp</span> <span class='hs-layout'>(</span><span class='hs-varid'>mo_WordTo64</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>alloc</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-577"></a>
<a name="line-578"></a>   <span class='hs-keyglyph'>]</span>
<a name="line-579"></a>
<a name="line-580"></a><a name="nursery_bdescr_free"></a><span class='hs-definition'>nursery_bdescr_free</span><span class='hs-layout'>,</span> <span class='hs-varid'>nursery_bdescr_start</span><span class='hs-layout'>,</span> <span class='hs-varid'>nursery_bdescr_blocks</span>
<a name="line-581"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmReg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span>
<a name="line-582"></a><span class='hs-definition'>nursery_bdescr_free</span>   <span class='hs-varid'>platform</span> <span class='hs-varid'>cn</span> <span class='hs-keyglyph'>=</span>
<a name="line-583"></a>  <span class='hs-varid'>cmmOffset</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>cn</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>pc_OFFSET_bdescr_free</span> <span class='hs-layout'>(</span><span class='hs-varid'>platformConstants</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-584"></a><a name="nursery_bdescr_start"></a><span class='hs-definition'>nursery_bdescr_start</span>  <span class='hs-varid'>platform</span> <span class='hs-varid'>cn</span> <span class='hs-keyglyph'>=</span>
<a name="line-585"></a>  <span class='hs-varid'>cmmOffset</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>cn</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>pc_OFFSET_bdescr_start</span> <span class='hs-layout'>(</span><span class='hs-varid'>platformConstants</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-586"></a><a name="nursery_bdescr_blocks"></a><span class='hs-definition'>nursery_bdescr_blocks</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>cn</span> <span class='hs-keyglyph'>=</span>
<a name="line-587"></a>  <span class='hs-varid'>cmmOffset</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>cn</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>pc_OFFSET_bdescr_blocks</span> <span class='hs-layout'>(</span><span class='hs-varid'>platformConstants</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-588"></a>
<a name="line-589"></a><a name="tso_stackobj"></a><span class='hs-definition'>tso_stackobj</span><span class='hs-layout'>,</span> <span class='hs-varid'>tso_CCCS</span><span class='hs-layout'>,</span> <span class='hs-varid'>tso_alloc_limit</span><span class='hs-layout'>,</span> <span class='hs-varid'>stack_STACK</span><span class='hs-layout'>,</span> <span class='hs-varid'>stack_SP</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Profile</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>
<a name="line-590"></a><span class='hs-definition'>tso_stackobj</span>    <span class='hs-varid'>profile</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closureField</span> <span class='hs-varid'>profile</span> <span class='hs-layout'>(</span><span class='hs-varid'>pc_OFFSET_StgTSO_stackobj</span>    <span class='hs-layout'>(</span><span class='hs-varid'>profileConstants</span> <span class='hs-varid'>profile</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-591"></a><a name="tso_alloc_limit"></a><span class='hs-definition'>tso_alloc_limit</span> <span class='hs-varid'>profile</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closureField</span> <span class='hs-varid'>profile</span> <span class='hs-layout'>(</span><span class='hs-varid'>pc_OFFSET_StgTSO_alloc_limit</span> <span class='hs-layout'>(</span><span class='hs-varid'>profileConstants</span> <span class='hs-varid'>profile</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-592"></a><a name="tso_CCCS"></a><span class='hs-definition'>tso_CCCS</span>        <span class='hs-varid'>profile</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closureField</span> <span class='hs-varid'>profile</span> <span class='hs-layout'>(</span><span class='hs-varid'>pc_OFFSET_StgTSO_cccs</span>        <span class='hs-layout'>(</span><span class='hs-varid'>profileConstants</span> <span class='hs-varid'>profile</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-593"></a><a name="stack_STACK"></a><span class='hs-definition'>stack_STACK</span>     <span class='hs-varid'>profile</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closureField</span> <span class='hs-varid'>profile</span> <span class='hs-layout'>(</span><span class='hs-varid'>pc_OFFSET_StgStack_stack</span>     <span class='hs-layout'>(</span><span class='hs-varid'>profileConstants</span> <span class='hs-varid'>profile</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-594"></a><a name="stack_SP"></a><span class='hs-definition'>stack_SP</span>        <span class='hs-varid'>profile</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closureField</span> <span class='hs-varid'>profile</span> <span class='hs-layout'>(</span><span class='hs-varid'>pc_OFFSET_StgStack_sp</span>        <span class='hs-layout'>(</span><span class='hs-varid'>profileConstants</span> <span class='hs-varid'>profile</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-595"></a>
<a name="line-596"></a>
<a name="line-597"></a><a name="closureField"></a><span class='hs-definition'>closureField</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Profile</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>
<a name="line-598"></a><span class='hs-definition'>closureField</span> <span class='hs-varid'>profile</span> <span class='hs-varid'>off</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>off</span> <span class='hs-varop'>+</span> <span class='hs-varid'>fixedHdrSize</span> <span class='hs-varid'>profile</span>
<a name="line-599"></a>
<a name="line-600"></a><span class='hs-comment'>-- Note [Unlifted boxed arguments to foreign calls]</span>
<a name="line-601"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-602"></a><span class='hs-comment'>--</span>
<a name="line-603"></a><span class='hs-comment'>-- For certain types passed to foreign calls, we adjust the actual</span>
<a name="line-604"></a><span class='hs-comment'>-- value passed to the call.  For ByteArray#, Array#, SmallArray#,</span>
<a name="line-605"></a><span class='hs-comment'>-- and ArrayArray#, we pass the address of the array's payload, not</span>
<a name="line-606"></a><span class='hs-comment'>-- the address of the heap object. For example, consider</span>
<a name="line-607"></a><span class='hs-comment'>--   foreign import "c_foo" foo :: ByteArray# -&gt; Int# -&gt; IO ()</span>
<a name="line-608"></a><span class='hs-comment'>-- At a Haskell call like `foo x y`, we'll generate a C call that</span>
<a name="line-609"></a><span class='hs-comment'>-- is more like</span>
<a name="line-610"></a><span class='hs-comment'>--   c_foo( x+8, y )</span>
<a name="line-611"></a><span class='hs-comment'>-- where the "+8" takes the heap pointer (x :: ByteArray#) and moves</span>
<a name="line-612"></a><span class='hs-comment'>-- it past the header words of the ByteArray object to point directly</span>
<a name="line-613"></a><span class='hs-comment'>-- to the data inside the ByteArray#. (The exact offset depends</span>
<a name="line-614"></a><span class='hs-comment'>-- on the target architecture and on profiling) By contrast, (y :: Int#)</span>
<a name="line-615"></a><span class='hs-comment'>-- requires no such adjustment.</span>
<a name="line-616"></a><span class='hs-comment'>--</span>
<a name="line-617"></a><span class='hs-comment'>-- This adjustment is performed by 'add_shim'. The size of the</span>
<a name="line-618"></a><span class='hs-comment'>-- adjustment depends on the type of heap object. But</span>
<a name="line-619"></a><span class='hs-comment'>-- how can we determine that type? There are two available options.</span>
<a name="line-620"></a><span class='hs-comment'>-- We could use the types of the actual values that the foreign call</span>
<a name="line-621"></a><span class='hs-comment'>-- has been applied to, or we could use the types present in the</span>
<a name="line-622"></a><span class='hs-comment'>-- foreign function's type. Prior to GHC 8.10, we used the former</span>
<a name="line-623"></a><span class='hs-comment'>-- strategy since it's a little more simple. However, in issue #16650</span>
<a name="line-624"></a><span class='hs-comment'>-- and more compellingly in the comments of</span>
<a name="line-625"></a><span class='hs-comment'>-- https://gitlab.haskell.org/ghc/ghc/merge_requests/939, it was</span>
<a name="line-626"></a><span class='hs-comment'>-- demonstrated that this leads to bad behavior in the presence</span>
<a name="line-627"></a><span class='hs-comment'>-- of unsafeCoerce#. Returning to the above example, suppose the</span>
<a name="line-628"></a><span class='hs-comment'>-- Haskell call looked like</span>
<a name="line-629"></a><span class='hs-comment'>--   foo (unsafeCoerce# p)</span>
<a name="line-630"></a><span class='hs-comment'>-- where the types of expressions comprising the arguments are</span>
<a name="line-631"></a><span class='hs-comment'>--   p :: (Any :: TYPE 'UnliftedRep)</span>
<a name="line-632"></a><span class='hs-comment'>--   i :: Int#</span>
<a name="line-633"></a><span class='hs-comment'>-- so that the unsafe-coerce is between Any and ByteArray#.</span>
<a name="line-634"></a><span class='hs-comment'>-- These two types have the same kind (they are both represented by</span>
<a name="line-635"></a><span class='hs-comment'>-- a heap pointer) so no GC errors will occur if we do this unsafe coerce.</span>
<a name="line-636"></a><span class='hs-comment'>-- By the time this gets to the code generator the cast has been</span>
<a name="line-637"></a><span class='hs-comment'>-- discarded so we have</span>
<a name="line-638"></a><span class='hs-comment'>--   foo p y</span>
<a name="line-639"></a><span class='hs-comment'>-- But we *must* adjust the pointer to p by a ByteArray# shim,</span>
<a name="line-640"></a><span class='hs-comment'>-- *not* by an Any shim (the Any shim involves no offset at all).</span>
<a name="line-641"></a><span class='hs-comment'>--</span>
<a name="line-642"></a><span class='hs-comment'>-- To avoid this bad behavior, we adopt the second strategy: use</span>
<a name="line-643"></a><span class='hs-comment'>-- the types present in the foreign function's type.</span>
<a name="line-644"></a><span class='hs-comment'>-- In collectStgFArgTypes, we convert the foreign function's</span>
<a name="line-645"></a><span class='hs-comment'>-- type to a list of StgFArgType. Then, in add_shim, we interpret</span>
<a name="line-646"></a><span class='hs-comment'>-- these as numeric offsets.</span>
<a name="line-647"></a>
<a name="line-648"></a><a name="getFCallArgs"></a><span class='hs-definition'>getFCallArgs</span> <span class='hs-keyglyph'>::</span>
<a name="line-649"></a>     <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgArg</span><span class='hs-keyglyph'>]</span>
<a name="line-650"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-comment'>-- the type of the foreign function</span>
<a name="line-651"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CmmExpr</span><span class='hs-layout'>,</span> <span class='hs-conid'>ForeignHint</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-652"></a><span class='hs-comment'>-- (a) Drop void args</span>
<a name="line-653"></a><span class='hs-comment'>-- (b) Add foreign-call shim code</span>
<a name="line-654"></a><span class='hs-comment'>-- It's (b) that makes this differ from getNonVoidArgAmodes</span>
<a name="line-655"></a><span class='hs-comment'>-- Precondition: args and typs have the same length</span>
<a name="line-656"></a><span class='hs-comment'>-- See Note [Unlifted boxed arguments to foreign calls]</span>
<a name="line-657"></a><span class='hs-definition'>getFCallArgs</span> <span class='hs-varid'>args</span> <span class='hs-varid'>typ</span>
<a name="line-658"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>mb_cmms</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>get</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipEqual</span> <span class='hs-str'>"getFCallArgs"</span> <span class='hs-varid'>args</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectStgFArgTypes</span> <span class='hs-varid'>typ</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-659"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>catMaybes</span> <span class='hs-varid'>mb_cmms</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-660"></a>  <span class='hs-keyword'>where</span>
<a name="line-661"></a>    <span class='hs-varid'>get</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span><span class='hs-varid'>typ</span><span class='hs-layout'>)</span>
<a name="line-662"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>arg_reps</span>
<a name="line-663"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-664"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-665"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cmm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getArgAmode</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonVoid</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-666"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>profile</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getProfile</span>
<a name="line-667"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>add_shim</span> <span class='hs-varid'>profile</span> <span class='hs-varid'>typ</span> <span class='hs-varid'>cmm</span><span class='hs-layout'>,</span> <span class='hs-varid'>hint</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-668"></a>      <span class='hs-keyword'>where</span>
<a name="line-669"></a>        <span class='hs-varid'>arg_ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stgArgType</span> <span class='hs-varid'>arg</span>
<a name="line-670"></a>        <span class='hs-varid'>arg_reps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typePrimRep</span> <span class='hs-varid'>arg_ty</span>
<a name="line-671"></a>        <span class='hs-varid'>hint</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeForeignHint</span> <span class='hs-varid'>arg_ty</span>
<a name="line-672"></a>
<a name="line-673"></a><a name="StgFArgType"></a><span class='hs-comment'>-- The minimum amount of information needed to determine</span>
<a name="line-674"></a><a name="StgFArgType"></a><span class='hs-comment'>-- the offset to apply to an argument to a foreign call.</span>
<a name="line-675"></a><a name="StgFArgType"></a><span class='hs-comment'>-- See Note [Unlifted boxed arguments to foreign calls]</span>
<a name="line-676"></a><a name="StgFArgType"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>StgFArgType</span>
<a name="line-677"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgPlainType</span>
<a name="line-678"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StgArrayType</span>
<a name="line-679"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StgSmallArrayType</span>
<a name="line-680"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StgByteArrayType</span>
<a name="line-681"></a>
<a name="line-682"></a><a name="add_shim"></a><span class='hs-comment'>-- See Note [Unlifted boxed arguments to foreign calls]</span>
<a name="line-683"></a><span class='hs-definition'>add_shim</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Profile</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgFArgType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span>
<a name="line-684"></a><span class='hs-definition'>add_shim</span> <span class='hs-varid'>profile</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-685"></a>  <span class='hs-conid'>StgPlainType</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>expr</span>
<a name="line-686"></a>  <span class='hs-conid'>StgArrayType</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cmmOffsetB</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>(</span><span class='hs-varid'>arrPtrsHdrSize</span> <span class='hs-varid'>profile</span><span class='hs-layout'>)</span>
<a name="line-687"></a>  <span class='hs-conid'>StgSmallArrayType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cmmOffsetB</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>(</span><span class='hs-varid'>smallArrPtrsHdrSize</span> <span class='hs-varid'>profile</span><span class='hs-layout'>)</span>
<a name="line-688"></a>  <span class='hs-conid'>StgByteArrayType</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cmmOffsetB</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>(</span><span class='hs-varid'>arrWordsHdrSize</span> <span class='hs-varid'>profile</span><span class='hs-layout'>)</span>
<a name="line-689"></a>  <span class='hs-keyword'>where</span>
<a name="line-690"></a>    <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>profilePlatform</span> <span class='hs-varid'>profile</span>
<a name="line-691"></a>
<a name="line-692"></a><a name="collectStgFArgTypes"></a><span class='hs-comment'>-- From a function, extract information needed to determine</span>
<a name="line-693"></a><span class='hs-comment'>-- the offset of each argument when used as a C FFI argument.</span>
<a name="line-694"></a><span class='hs-comment'>-- See Note [Unlifted boxed arguments to foreign calls]</span>
<a name="line-695"></a><span class='hs-definition'>collectStgFArgTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgFArgType</span><span class='hs-keyglyph'>]</span>
<a name="line-696"></a><span class='hs-definition'>collectStgFArgTypes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span>
<a name="line-697"></a>  <span class='hs-keyword'>where</span>
<a name="line-698"></a>    <span class='hs-comment'>-- Skip foralls</span>
<a name="line-699"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>bs</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>res</span>
<a name="line-700"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>bs</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>bs</span>
<a name="line-701"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>bs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>bs</span>
<a name="line-702"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>bs</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>bs</span>
<a name="line-703"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>bs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>bs</span>
<a name="line-704"></a>    <span class='hs-varid'>go</span>  <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"myCollectTypeArgs: CastTy"</span>
<a name="line-705"></a>    <span class='hs-varid'>go</span>  <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"myCollectTypeArgs: CoercionTy"</span>
<a name="line-706"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>bs</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span><span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>res</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-707"></a>      <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeToStgFArgType</span> <span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span>
<a name="line-708"></a>
<a name="line-709"></a><a name="typeToStgFArgType"></a><span class='hs-comment'>-- Choose the offset based on the type. For anything other</span>
<a name="line-710"></a><span class='hs-comment'>-- than an unlifted boxed type, there is no offset.</span>
<a name="line-711"></a><span class='hs-comment'>-- See Note [Unlifted boxed arguments to foreign calls]</span>
<a name="line-712"></a><span class='hs-definition'>typeToStgFArgType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgFArgType</span>
<a name="line-713"></a><span class='hs-definition'>typeToStgFArgType</span> <span class='hs-varid'>typ</span>
<a name="line-714"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tycon</span> <span class='hs-varop'>==</span> <span class='hs-varid'>arrayPrimTyCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgArrayType</span>
<a name="line-715"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tycon</span> <span class='hs-varop'>==</span> <span class='hs-varid'>mutableArrayPrimTyCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgArrayType</span>
<a name="line-716"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tycon</span> <span class='hs-varop'>==</span> <span class='hs-varid'>arrayArrayPrimTyCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgArrayType</span>
<a name="line-717"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tycon</span> <span class='hs-varop'>==</span> <span class='hs-varid'>mutableArrayArrayPrimTyCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgArrayType</span>
<a name="line-718"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tycon</span> <span class='hs-varop'>==</span> <span class='hs-varid'>smallArrayPrimTyCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgSmallArrayType</span>
<a name="line-719"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tycon</span> <span class='hs-varop'>==</span> <span class='hs-varid'>smallMutableArrayPrimTyCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgSmallArrayType</span>
<a name="line-720"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tycon</span> <span class='hs-varop'>==</span> <span class='hs-varid'>byteArrayPrimTyCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgByteArrayType</span>
<a name="line-721"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tycon</span> <span class='hs-varop'>==</span> <span class='hs-varid'>mutableByteArrayPrimTyCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgByteArrayType</span>
<a name="line-722"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgPlainType</span>
<a name="line-723"></a>  <span class='hs-keyword'>where</span>
<a name="line-724"></a>  <span class='hs-comment'>-- Should be a tycon app, since this is a foreign call. We look</span>
<a name="line-725"></a>  <span class='hs-comment'>-- through newtypes so the offset does not change if a user replaces</span>
<a name="line-726"></a>  <span class='hs-comment'>-- a type in a foreign function signature with a representationally</span>
<a name="line-727"></a>  <span class='hs-comment'>-- equivalent newtype.</span>
<a name="line-728"></a>  <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>unwrapType</span> <span class='hs-varid'>typ</span><span class='hs-layout'>)</span>
</pre></body>
</html>
