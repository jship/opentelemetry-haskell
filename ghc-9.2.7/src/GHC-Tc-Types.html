<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Tc/Types.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP                        #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE DeriveFunctor              #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE ExistentialQuantification  #-}</span>
<a name="line-4"></a><span class='hs-comment'>{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-comment'>{-
<a name="line-7"></a>(c) The University of Glasgow 2006-2012
<a name="line-8"></a>(c) The GRASP Project, Glasgow University, 1992-2002
<a name="line-9"></a>
<a name="line-10"></a>-}</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-comment'>-- | Various types used during typechecking.</span>
<a name="line-13"></a><span class='hs-comment'>--</span>
<a name="line-14"></a><span class='hs-comment'>-- Please see "GHC.Tc.Utils.Monad" as well for operations on these types. You probably</span>
<a name="line-15"></a><span class='hs-comment'>-- want to import it, instead of this module.</span>
<a name="line-16"></a><span class='hs-comment'>--</span>
<a name="line-17"></a><span class='hs-comment'>-- All the monads exported here are built on top of the same IOEnv monad. The</span>
<a name="line-18"></a><span class='hs-comment'>-- monad functions like a Reader monad in the way it passes the environment</span>
<a name="line-19"></a><span class='hs-comment'>-- around. This is done to allow the environment to be manipulated in a stack</span>
<a name="line-20"></a><span class='hs-comment'>-- like fashion when entering expressions... etc.</span>
<a name="line-21"></a><span class='hs-comment'>--</span>
<a name="line-22"></a><span class='hs-comment'>-- For state that is global and should be returned at the end (e.g not part</span>
<a name="line-23"></a><span class='hs-comment'>-- of the stack mechanism), you should use a TcRef (= IORef) to store them.</span>
<a name="line-24"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Tc.Types</span><span class='hs-layout'>(</span>
<a name="line-25"></a>        <span class='hs-conid'>TcRnIf</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcM</span><span class='hs-layout'>,</span> <span class='hs-conid'>RnM</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfM</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfL</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfG</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- The monad is opaque outside this module</span>
<a name="line-26"></a>        <span class='hs-conid'>TcRef</span><span class='hs-layout'>,</span>
<a name="line-27"></a>
<a name="line-28"></a>        <span class='hs-comment'>-- The environment types</span>
<a name="line-29"></a>        <span class='hs-conid'>Env</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-30"></a>        <span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcLclEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-31"></a>        <span class='hs-varid'>setLclEnvTcLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>getLclEnvTcLevel</span><span class='hs-layout'>,</span>
<a name="line-32"></a>        <span class='hs-varid'>setLclEnvLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>getLclEnvLoc</span><span class='hs-layout'>,</span>
<a name="line-33"></a>        <span class='hs-conid'>IfGblEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfLclEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-34"></a>        <span class='hs-varid'>tcVisibleOrphanMods</span><span class='hs-layout'>,</span>
<a name="line-35"></a>
<a name="line-36"></a>        <span class='hs-comment'>-- Frontend types (shouldn't really be here)</span>
<a name="line-37"></a>        <span class='hs-conid'>FrontendResult</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-38"></a>
<a name="line-39"></a>        <span class='hs-comment'>-- Renamer types</span>
<a name="line-40"></a>        <span class='hs-conid'>ErrCtxt</span><span class='hs-layout'>,</span> <span class='hs-conid'>RecFieldEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>pushErrCtxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>pushErrCtxtSameOrigin</span><span class='hs-layout'>,</span>
<a name="line-41"></a>        <span class='hs-conid'>ImportAvails</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyImportAvails</span><span class='hs-layout'>,</span> <span class='hs-varid'>plusImportAvails</span><span class='hs-layout'>,</span>
<a name="line-42"></a>        <span class='hs-conid'>WhereFrom</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkModDeps</span><span class='hs-layout'>,</span> <span class='hs-varid'>modDepsElts</span><span class='hs-layout'>,</span>
<a name="line-43"></a>
<a name="line-44"></a>        <span class='hs-comment'>-- Typechecker types</span>
<a name="line-45"></a>        <span class='hs-conid'>TcTypeEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcBinderStack</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcBinder</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-46"></a>        <span class='hs-conid'>TcTyThing</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>PromotionErr</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-47"></a>        <span class='hs-conid'>IdBindingInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>ClosedTypeId</span><span class='hs-layout'>,</span> <span class='hs-conid'>RhsNames</span><span class='hs-layout'>,</span>
<a name="line-48"></a>        <span class='hs-conid'>IsGroupClosed</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-49"></a>        <span class='hs-conid'>SelfBootInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-50"></a>        <span class='hs-varid'>tcTyThingCategory</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTcTyThingCategory</span><span class='hs-layout'>,</span>
<a name="line-51"></a>        <span class='hs-varid'>peCategory</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprPECategory</span><span class='hs-layout'>,</span>
<a name="line-52"></a>        <span class='hs-conid'>CompleteMatch</span><span class='hs-layout'>,</span> <span class='hs-conid'>CompleteMatches</span><span class='hs-layout'>,</span>
<a name="line-53"></a>
<a name="line-54"></a>        <span class='hs-comment'>-- Template Haskell</span>
<a name="line-55"></a>        <span class='hs-conid'>ThStage</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>SpliceType</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>PendingStuff</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-56"></a>        <span class='hs-varid'>topStage</span><span class='hs-layout'>,</span> <span class='hs-varid'>topAnnStage</span><span class='hs-layout'>,</span> <span class='hs-varid'>topSpliceStage</span><span class='hs-layout'>,</span>
<a name="line-57"></a>        <span class='hs-conid'>ThLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>impLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>outerLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>thLevel</span><span class='hs-layout'>,</span>
<a name="line-58"></a>        <span class='hs-conid'>ForeignSrcLang</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>THDocs</span><span class='hs-layout'>,</span> <span class='hs-conid'>DocLoc</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-59"></a>
<a name="line-60"></a>        <span class='hs-comment'>-- Arrows</span>
<a name="line-61"></a>        <span class='hs-conid'>ArrowCtxt</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-62"></a>
<a name="line-63"></a>        <span class='hs-comment'>-- TcSigInfo</span>
<a name="line-64"></a>        <span class='hs-conid'>TcSigFun</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcSigInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcIdSigInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-65"></a>        <span class='hs-conid'>TcIdSigInst</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcPatSynInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-66"></a>        <span class='hs-varid'>isPartialSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>hasCompleteSig</span><span class='hs-layout'>,</span>
<a name="line-67"></a>
<a name="line-68"></a>        <span class='hs-comment'>-- Misc other types</span>
<a name="line-69"></a>        <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcIdSet</span><span class='hs-layout'>,</span>
<a name="line-70"></a>        <span class='hs-conid'>NameShape</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-71"></a>        <span class='hs-varid'>removeBindingShadowing</span><span class='hs-layout'>,</span>
<a name="line-72"></a>        <span class='hs-varid'>getPlatform</span><span class='hs-layout'>,</span>
<a name="line-73"></a>
<a name="line-74"></a>        <span class='hs-comment'>-- Constraint solver plugins</span>
<a name="line-75"></a>        <span class='hs-conid'>TcPlugin</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcPluginResult</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcPluginSolver</span><span class='hs-layout'>,</span>
<a name="line-76"></a>        <span class='hs-conid'>TcPluginM</span><span class='hs-layout'>,</span> <span class='hs-varid'>runTcPluginM</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsafeTcPluginTcM</span><span class='hs-layout'>,</span>
<a name="line-77"></a>        <span class='hs-varid'>getEvBindsTcPluginM</span><span class='hs-layout'>,</span>
<a name="line-78"></a>
<a name="line-79"></a>        <span class='hs-comment'>-- Role annotations</span>
<a name="line-80"></a>        <span class='hs-conid'>RoleAnnotEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyRoleAnnotEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkRoleAnnotEnv</span><span class='hs-layout'>,</span>
<a name="line-81"></a>        <span class='hs-varid'>lookupRoleAnnot</span><span class='hs-layout'>,</span> <span class='hs-varid'>getRoleAnnots</span><span class='hs-layout'>,</span>
<a name="line-82"></a>
<a name="line-83"></a>        <span class='hs-comment'>-- Linting</span>
<a name="line-84"></a>        <span class='hs-varid'>lintGblEnv</span>
<a name="line-85"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-86"></a>
<a name="line-87"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-88"></a>
<a name="line-89"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-90"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Platform</span>
<a name="line-91"></a>
<a name="line-92"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Env</span>
<a name="line-93"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Session</span>
<a name="line-94"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>GHC.Driver.Hooks</span>
<a name="line-95"></a>
<a name="line-96"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Hs</span>
<a name="line-97"></a>
<a name="line-98"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.TcType</span>
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Types.Constraint</span>
<a name="line-100"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Types.Origin</span>
<a name="line-101"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Types.Evidence</span>
<a name="line-102"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>GHC.Tc.Errors.Hole.FitTypes</span> <span class='hs-layout'>(</span> <span class='hs-conid'>HoleFitPlugin</span> <span class='hs-layout'>)</span>
<a name="line-103"></a>
<a name="line-104"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Type</span>
<a name="line-105"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCon</span>  <span class='hs-layout'>(</span> <span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConKind</span> <span class='hs-layout'>)</span>
<a name="line-106"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.PatSyn</span> <span class='hs-layout'>(</span> <span class='hs-conid'>PatSyn</span> <span class='hs-layout'>)</span>
<a name="line-107"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Lint</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>lintAxioms</span> <span class='hs-layout'>)</span>
<a name="line-108"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.UsageEnv</span>
<a name="line-109"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.InstEnv</span>
<a name="line-110"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.FamInstEnv</span>
<a name="line-111"></a>
<a name="line-112"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Id</span>         <span class='hs-layout'>(</span> <span class='hs-varid'>idType</span><span class='hs-layout'>,</span> <span class='hs-varid'>idName</span> <span class='hs-layout'>)</span>
<a name="line-113"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.FieldLabel</span> <span class='hs-layout'>(</span> <span class='hs-conid'>FieldLabel</span> <span class='hs-layout'>)</span>
<a name="line-114"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Fixity.Env</span>
<a name="line-115"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Annotations</span>
<a name="line-116"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.CompleteMatch</span>
<a name="line-117"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Reader</span>
<a name="line-118"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name</span>
<a name="line-119"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Env</span>
<a name="line-120"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Set</span>
<a name="line-121"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Avail</span>
<a name="line-122"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var</span>
<a name="line-123"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var.Env</span>
<a name="line-124"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.TypeEnv</span>
<a name="line-125"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.TyThing</span>
<a name="line-126"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SourceFile</span>
<a name="line-127"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SrcLoc</span>
<a name="line-128"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var.Set</span>
<a name="line-129"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.FM</span>
<a name="line-130"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Basic</span>
<a name="line-131"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.CostCentre.State</span>
<a name="line-132"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.HpcInfo</span>
<a name="line-133"></a>
<a name="line-134"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.IOEnv</span>
<a name="line-135"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Bag</span>
<a name="line-136"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.List.SetOps</span>
<a name="line-137"></a>
<a name="line-138"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit</span>
<a name="line-139"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.Warnings</span>
<a name="line-140"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.Imported</span>
<a name="line-141"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.ModDetails</span>
<a name="line-142"></a>
<a name="line-143"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Error</span>
<a name="line-144"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-145"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Fingerprint</span>
<a name="line-146"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-147"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-148"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Logger</span>
<a name="line-149"></a>
<a name="line-150"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Names</span> <span class='hs-layout'>(</span> <span class='hs-varid'>isUnboundName</span> <span class='hs-layout'>)</span>
<a name="line-151"></a>
<a name="line-152"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad</span> <span class='hs-layout'>(</span><span class='hs-varid'>ap</span><span class='hs-layout'>)</span>
<a name="line-153"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Set</span>      <span class='hs-layout'>(</span> <span class='hs-conid'>Set</span> <span class='hs-layout'>)</span>
<a name="line-154"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.Set</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>S</span>
<a name="line-155"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List</span> <span class='hs-layout'>(</span> <span class='hs-varid'>sort</span> <span class='hs-layout'>)</span>
<a name="line-156"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Map</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Map</span> <span class='hs-layout'>)</span>
<a name="line-157"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Dynamic</span>  <span class='hs-layout'>(</span> <span class='hs-conid'>Dynamic</span> <span class='hs-layout'>)</span>
<a name="line-158"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Typeable</span> <span class='hs-layout'>(</span> <span class='hs-conid'>TypeRep</span> <span class='hs-layout'>)</span>
<a name="line-159"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Maybe</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>mapMaybe</span> <span class='hs-layout'>)</span>
<a name="line-160"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHCi.Message</span>
<a name="line-161"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHCi.RemoteTypes</span>
<a name="line-162"></a>
<a name="line-163"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Language.Haskell.TH</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TH</span>
<a name="line-164"></a>
<a name="line-165"></a><a name="NameShape"></a><span class='hs-comment'>-- | A 'NameShape' is a substitution on 'Name's that can be used</span>
<a name="line-166"></a><a name="NameShape"></a><span class='hs-comment'>-- to refine the identities of a hole while we are renaming interfaces</span>
<a name="line-167"></a><a name="NameShape"></a><span class='hs-comment'>-- (see "GHC.Iface.Rename").  Specifically, a 'NameShape' for</span>
<a name="line-168"></a><a name="NameShape"></a><span class='hs-comment'>-- 'ns_module_name' @A@, defines a mapping from @{A.T}@</span>
<a name="line-169"></a><a name="NameShape"></a><span class='hs-comment'>-- (for some 'OccName' @T@) to some arbitrary other 'Name'.</span>
<a name="line-170"></a><a name="NameShape"></a><span class='hs-comment'>--</span>
<a name="line-171"></a><a name="NameShape"></a><span class='hs-comment'>-- The most intruiging thing about a 'NameShape', however, is</span>
<a name="line-172"></a><a name="NameShape"></a><span class='hs-comment'>-- how it's constructed.  A 'NameShape' is *implied* by the</span>
<a name="line-173"></a><a name="NameShape"></a><span class='hs-comment'>-- exported 'AvailInfo's of the implementor of an interface:</span>
<a name="line-174"></a><a name="NameShape"></a><span class='hs-comment'>-- if an implementor of signature @\&lt;H&gt;@ exports @M.T@, you implicitly</span>
<a name="line-175"></a><a name="NameShape"></a><span class='hs-comment'>-- define a substitution from @{H.T}@ to @M.T@.  So a 'NameShape'</span>
<a name="line-176"></a><a name="NameShape"></a><span class='hs-comment'>-- is computed from the list of 'AvailInfo's that are exported</span>
<a name="line-177"></a><a name="NameShape"></a><span class='hs-comment'>-- by the implementation of a module, or successively merged</span>
<a name="line-178"></a><a name="NameShape"></a><span class='hs-comment'>-- together by the export lists of signatures which are joining</span>
<a name="line-179"></a><a name="NameShape"></a><span class='hs-comment'>-- together.</span>
<a name="line-180"></a><a name="NameShape"></a><span class='hs-comment'>--</span>
<a name="line-181"></a><a name="NameShape"></a><span class='hs-comment'>-- It's not the most obvious way to go about doing this, but it</span>
<a name="line-182"></a><a name="NameShape"></a><span class='hs-comment'>-- does seem to work!</span>
<a name="line-183"></a><a name="NameShape"></a><span class='hs-comment'>--</span>
<a name="line-184"></a><a name="NameShape"></a><span class='hs-comment'>-- NB: Can't boot this and put it in NameShape because then we</span>
<a name="line-185"></a><a name="NameShape"></a><span class='hs-comment'>-- start pulling in too many DynFlags things.</span>
<a name="line-186"></a><a name="NameShape"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>NameShape</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameShape</span> <span class='hs-layout'>{</span>
<a name="line-187"></a>        <span class='hs-varid'>ns_mod_name</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span><span class='hs-layout'>,</span>
<a name="line-188"></a>        <span class='hs-varid'>ns_exports</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-189"></a>        <span class='hs-varid'>ns_map</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccEnv</span> <span class='hs-conid'>Name</span>
<a name="line-190"></a>    <span class='hs-layout'>}</span>
<a name="line-191"></a>
<a name="line-192"></a>
<a name="line-193"></a><span class='hs-comment'>{-
<a name="line-194"></a>************************************************************************
<a name="line-195"></a>*                                                                      *
<a name="line-196"></a>               Standard monad definition for TcRn
<a name="line-197"></a>    All the combinators for the monad can be found in GHC.Tc.Utils.Monad
<a name="line-198"></a>*                                                                      *
<a name="line-199"></a>************************************************************************
<a name="line-200"></a>
<a name="line-201"></a>The monad itself has to be defined here, because it is mentioned by ErrCtxt
<a name="line-202"></a>-}</span>
<a name="line-203"></a>
<a name="line-204"></a><a name="TcRnIf"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IOEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Env</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-205"></a><a name="TcRn"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcRn</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-conid'>TcLclEnv</span>    <span class='hs-comment'>-- Type inference</span>
<a name="line-206"></a><a name="IfM"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IfM</span> <span class='hs-varid'>lcl</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-conid'>IfGblEnv</span> <span class='hs-varid'>lcl</span>         <span class='hs-comment'>-- Iface stuff</span>
<a name="line-207"></a><a name="IfG"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IfG</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfM</span> <span class='hs-conid'>()</span>                      <span class='hs-comment'>--    Top level</span>
<a name="line-208"></a><a name="IfL"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IfL</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfM</span> <span class='hs-conid'>IfLclEnv</span>                <span class='hs-comment'>--    Nested</span>
<a name="line-209"></a>
<a name="line-210"></a><span class='hs-comment'>-- TcRn is the type-checking and renaming monad: the main monad that</span>
<a name="line-211"></a><span class='hs-comment'>-- most type-checking takes place in.  The global environment is</span>
<a name="line-212"></a><span class='hs-comment'>-- 'TcGblEnv', which tracks all of the top-level type-checking</span>
<a name="line-213"></a><span class='hs-comment'>-- information we've accumulated while checking a module, while the</span>
<a name="line-214"></a><span class='hs-comment'>-- local environment is 'TcLclEnv', which tracks local information as</span>
<a name="line-215"></a><span class='hs-comment'>-- we move inside expressions.</span>
<a name="line-216"></a>
<a name="line-217"></a><a name="RnM"></a><span class='hs-comment'>-- | Historical "renaming monad" (now it's just 'TcRn').</span>
<a name="line-218"></a><a name="RnM"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>RnM</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRn</span>
<a name="line-219"></a>
<a name="line-220"></a><a name="TcM"></a><span class='hs-comment'>-- | Historical "type-checking monad" (now it's just 'TcRn').</span>
<a name="line-221"></a><a name="TcM"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcM</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRn</span>
<a name="line-222"></a>
<a name="line-223"></a><a name="Env"></a><span class='hs-comment'>-- We 'stack' these envs through the Reader like monad infrastructure</span>
<a name="line-224"></a><a name="Env"></a><span class='hs-comment'>-- as we move into an expression (although the change is focused in</span>
<a name="line-225"></a><a name="Env"></a><span class='hs-comment'>-- the lcl type).</span>
<a name="line-226"></a><a name="Env"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Env</span> <span class='hs-varid'>gbl</span> <span class='hs-varid'>lcl</span>
<a name="line-227"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Env</span> <span class='hs-layout'>{</span>
<a name="line-228"></a>        <span class='hs-varid'>env_top</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>HscEnv</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Top-level stuff that never changes</span>
<a name="line-229"></a>                             <span class='hs-comment'>-- Includes all info about imported things</span>
<a name="line-230"></a>                             <span class='hs-comment'>-- BangPattern is to fix leak, see #15111</span>
<a name="line-231"></a>
<a name="line-232"></a>        <span class='hs-varid'>env_um</span>   <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>Char</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- Mask for Uniques</span>
<a name="line-233"></a>
<a name="line-234"></a>        <span class='hs-varid'>env_gbl</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varid'>gbl</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Info about things defined at the top level</span>
<a name="line-235"></a>                             <span class='hs-comment'>-- of the module being compiled</span>
<a name="line-236"></a>
<a name="line-237"></a>        <span class='hs-varid'>env_lcl</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varid'>lcl</span>      <span class='hs-comment'>-- Nested stuff; changes as we go into</span>
<a name="line-238"></a>    <span class='hs-layout'>}</span>
<a name="line-239"></a>
<a name="line-240"></a><a name="instance%20ContainsDynFlags%20(Env%20gbl%20lcl)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ContainsDynFlags</span> <span class='hs-layout'>(</span><span class='hs-conid'>Env</span> <span class='hs-varid'>gbl</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-241"></a>    <span class='hs-varid'>extractDynFlags</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>env_top</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-242"></a>
<a name="line-243"></a><a name="instance%20ContainsHooks%20(Env%20gbl%20lcl)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ContainsHooks</span> <span class='hs-layout'>(</span><span class='hs-conid'>Env</span> <span class='hs-varid'>gbl</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-244"></a>    <span class='hs-varid'>extractHooks</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_hooks</span> <span class='hs-layout'>(</span><span class='hs-varid'>env_top</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-245"></a>
<a name="line-246"></a><a name="instance%20ContainsLogger%20(Env%20gbl%20lcl)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ContainsLogger</span> <span class='hs-layout'>(</span><span class='hs-conid'>Env</span> <span class='hs-varid'>gbl</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-247"></a>    <span class='hs-varid'>extractLogger</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_logger</span> <span class='hs-layout'>(</span><span class='hs-varid'>env_top</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-248"></a>
<a name="line-249"></a><a name="instance%20ContainsModule%20(Env%20gbl%20lcl)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ContainsModule</span> <span class='hs-varid'>gbl</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>ContainsModule</span> <span class='hs-layout'>(</span><span class='hs-conid'>Env</span> <span class='hs-varid'>gbl</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-250"></a>    <span class='hs-varid'>extractModule</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extractModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>env_gbl</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-251"></a>
<a name="line-252"></a>
<a name="line-253"></a><span class='hs-comment'>{-
<a name="line-254"></a>************************************************************************
<a name="line-255"></a>*                                                                      *
<a name="line-256"></a>                The interface environments
<a name="line-257"></a>              Used when dealing with IfaceDecls
<a name="line-258"></a>*                                                                      *
<a name="line-259"></a>************************************************************************
<a name="line-260"></a>-}</span>
<a name="line-261"></a>
<a name="line-262"></a><a name="IfGblEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>IfGblEnv</span>
<a name="line-263"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfGblEnv</span> <span class='hs-layout'>{</span>
<a name="line-264"></a>        <span class='hs-comment'>-- Some information about where this environment came from;</span>
<a name="line-265"></a>        <span class='hs-comment'>-- useful for debugging.</span>
<a name="line-266"></a>        <span class='hs-varid'>if_doc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>,</span>
<a name="line-267"></a>        <span class='hs-comment'>-- The type environment for the module being compiled,</span>
<a name="line-268"></a>        <span class='hs-comment'>-- in case the interface refers back to it via a reference that</span>
<a name="line-269"></a>        <span class='hs-comment'>-- was originally a hi-boot file.</span>
<a name="line-270"></a>        <span class='hs-comment'>-- We need the module name so we can test when it's appropriate</span>
<a name="line-271"></a>        <span class='hs-comment'>-- to look in this env.</span>
<a name="line-272"></a>        <span class='hs-comment'>-- See Note [Tying the knot] in GHC.IfaceToCore</span>
<a name="line-273"></a>        <span class='hs-varid'>if_rec_types</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Module</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfG</span> <span class='hs-conid'>TypeEnv</span><span class='hs-layout'>)</span>
<a name="line-274"></a>                <span class='hs-comment'>-- Allows a read effect, so it can be in a mutable</span>
<a name="line-275"></a>                <span class='hs-comment'>-- variable; c.f. handling the external package type env</span>
<a name="line-276"></a>                <span class='hs-comment'>-- Nothing =&gt; interactive stuff, no loops possible</span>
<a name="line-277"></a>    <span class='hs-layout'>}</span>
<a name="line-278"></a>
<a name="line-279"></a><a name="IfLclEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>IfLclEnv</span>
<a name="line-280"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfLclEnv</span> <span class='hs-layout'>{</span>
<a name="line-281"></a>        <span class='hs-comment'>-- The module for the current IfaceDecl</span>
<a name="line-282"></a>        <span class='hs-comment'>-- So if we see   f = \x -&gt; x</span>
<a name="line-283"></a>        <span class='hs-comment'>-- it means M.f = \x -&gt; x, where M is the if_mod</span>
<a name="line-284"></a>        <span class='hs-comment'>-- NB: This is a semantic module, see</span>
<a name="line-285"></a>        <span class='hs-comment'>-- Note [Identity versus semantic module]</span>
<a name="line-286"></a>        <span class='hs-varid'>if_mod</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span><span class='hs-layout'>,</span>
<a name="line-287"></a>
<a name="line-288"></a>        <span class='hs-comment'>-- Whether or not the IfaceDecl came from a boot</span>
<a name="line-289"></a>        <span class='hs-comment'>-- file or not; we'll use this to choose between</span>
<a name="line-290"></a>        <span class='hs-comment'>-- NoUnfolding and BootUnfolding</span>
<a name="line-291"></a>        <span class='hs-varid'>if_boot</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IsBootInterface</span><span class='hs-layout'>,</span>
<a name="line-292"></a>
<a name="line-293"></a>        <span class='hs-comment'>-- The field is used only for error reporting</span>
<a name="line-294"></a>        <span class='hs-comment'>-- if (say) there's a Lint error in it</span>
<a name="line-295"></a>        <span class='hs-varid'>if_loc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>,</span>
<a name="line-296"></a>                <span class='hs-comment'>-- Where the interface came from:</span>
<a name="line-297"></a>                <span class='hs-comment'>--      .hi file, or GHCi state, or ext core</span>
<a name="line-298"></a>                <span class='hs-comment'>-- plus which bit is currently being examined</span>
<a name="line-299"></a>
<a name="line-300"></a>        <span class='hs-varid'>if_nsubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>NameShape</span><span class='hs-layout'>,</span>
<a name="line-301"></a>
<a name="line-302"></a>        <span class='hs-comment'>-- This field is used to make sure "implicit" declarations</span>
<a name="line-303"></a>        <span class='hs-comment'>-- (anything that cannot be exported in mi_exports) get</span>
<a name="line-304"></a>        <span class='hs-comment'>-- wired up correctly in typecheckIfacesForMerging.  Most</span>
<a name="line-305"></a>        <span class='hs-comment'>-- of the time it's @Nothing@.  See Note [Resolving never-exported Names]</span>
<a name="line-306"></a>        <span class='hs-comment'>-- in GHC.IfaceToCore.</span>
<a name="line-307"></a>        <span class='hs-varid'>if_implicits_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TypeEnv</span><span class='hs-layout'>,</span>
<a name="line-308"></a>
<a name="line-309"></a>        <span class='hs-varid'>if_tv_env</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastStringEnv</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Nested tyvar bindings</span>
<a name="line-310"></a>        <span class='hs-varid'>if_id_env</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastStringEnv</span> <span class='hs-conid'>Id</span>         <span class='hs-comment'>-- Nested id binding</span>
<a name="line-311"></a>    <span class='hs-layout'>}</span>
<a name="line-312"></a>
<a name="line-313"></a><span class='hs-comment'>{-
<a name="line-314"></a>************************************************************************
<a name="line-315"></a>*                                                                      *
<a name="line-316"></a>                Global typechecker environment
<a name="line-317"></a>*                                                                      *
<a name="line-318"></a>************************************************************************
<a name="line-319"></a>-}</span>
<a name="line-320"></a>
<a name="line-321"></a><a name="FrontendResult"></a><span class='hs-comment'>-- | 'FrontendResult' describes the result of running the frontend of a Haskell</span>
<a name="line-322"></a><a name="FrontendResult"></a><span class='hs-comment'>-- module. Currently one always gets a 'FrontendTypecheck', since running the</span>
<a name="line-323"></a><a name="FrontendResult"></a><span class='hs-comment'>-- frontend involves typechecking a program. hs-sig merges are not handled here.</span>
<a name="line-324"></a><a name="FrontendResult"></a><span class='hs-comment'>--</span>
<a name="line-325"></a><a name="FrontendResult"></a><span class='hs-comment'>-- This data type really should be in GHC.Driver.Env, but it needs</span>
<a name="line-326"></a><a name="FrontendResult"></a><span class='hs-comment'>-- to have a TcGblEnv which is only defined here.</span>
<a name="line-327"></a><a name="FrontendResult"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>FrontendResult</span>
<a name="line-328"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FrontendTypecheck</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-329"></a>
<a name="line-330"></a><span class='hs-comment'>-- Note [Identity versus semantic module]</span>
<a name="line-331"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-332"></a><span class='hs-comment'>-- When typechecking an hsig file, it is convenient to keep track</span>
<a name="line-333"></a><span class='hs-comment'>-- of two different "this module" identifiers:</span>
<a name="line-334"></a><span class='hs-comment'>--</span>
<a name="line-335"></a><span class='hs-comment'>--      - The IDENTITY module is simply thisPackage + the module</span>
<a name="line-336"></a><span class='hs-comment'>--        name; i.e. it uniquely *identifies* the interface file</span>
<a name="line-337"></a><span class='hs-comment'>--        we're compiling.  For example, p[A=&lt;A&gt;]:A is an</span>
<a name="line-338"></a><span class='hs-comment'>--        identity module identifying the requirement named A</span>
<a name="line-339"></a><span class='hs-comment'>--        from library p.</span>
<a name="line-340"></a><span class='hs-comment'>--</span>
<a name="line-341"></a><span class='hs-comment'>--      - The SEMANTIC module, which is the actual module that</span>
<a name="line-342"></a><span class='hs-comment'>--        this signature is intended to represent (e.g. if</span>
<a name="line-343"></a><span class='hs-comment'>--        we have a identity module p[A=base:Data.IORef]:A,</span>
<a name="line-344"></a><span class='hs-comment'>--        then the semantic module is base:Data.IORef)</span>
<a name="line-345"></a><span class='hs-comment'>--</span>
<a name="line-346"></a><span class='hs-comment'>-- Which one should you use?</span>
<a name="line-347"></a><span class='hs-comment'>--</span>
<a name="line-348"></a><span class='hs-comment'>--      - In the desugarer and later phases of compilation,</span>
<a name="line-349"></a><span class='hs-comment'>--        identity and semantic modules coincide, since we never compile</span>
<a name="line-350"></a><span class='hs-comment'>--        signatures (we just generate blank object files for</span>
<a name="line-351"></a><span class='hs-comment'>--        hsig files.)</span>
<a name="line-352"></a><span class='hs-comment'>--</span>
<a name="line-353"></a><span class='hs-comment'>--        A corrolary of this is that the following invariant holds at any point</span>
<a name="line-354"></a><span class='hs-comment'>--        past desugaring,</span>
<a name="line-355"></a><span class='hs-comment'>--</span>
<a name="line-356"></a><span class='hs-comment'>--            if I have a Module, this_mod, in hand representing the module</span>
<a name="line-357"></a><span class='hs-comment'>--            currently being compiled,</span>
<a name="line-358"></a><span class='hs-comment'>--            then moduleUnit this_mod == thisPackage dflags</span>
<a name="line-359"></a><span class='hs-comment'>--</span>
<a name="line-360"></a><span class='hs-comment'>--      - For any code involving Names, we want semantic modules.</span>
<a name="line-361"></a><span class='hs-comment'>--        See lookupIfaceTop in GHC.Iface.Env, mkIface and addFingerprints</span>
<a name="line-362"></a><span class='hs-comment'>--        in GHC.Iface.{Make,Recomp}, and tcLookupGlobal in GHC.Tc.Utils.Env</span>
<a name="line-363"></a><span class='hs-comment'>--</span>
<a name="line-364"></a><span class='hs-comment'>--      - When reading interfaces, we want the identity module to</span>
<a name="line-365"></a><span class='hs-comment'>--        identify the specific interface we want (such interfaces</span>
<a name="line-366"></a><span class='hs-comment'>--        should never be loaded into the EPS).  However, if a</span>
<a name="line-367"></a><span class='hs-comment'>--        hole module &lt;A&gt; is requested, we look for A.hi</span>
<a name="line-368"></a><span class='hs-comment'>--        in the home library we are compiling.  (See GHC.Iface.Load.)</span>
<a name="line-369"></a><span class='hs-comment'>--        Similarly, in GHC.Rename.Names we check for self-imports using</span>
<a name="line-370"></a><span class='hs-comment'>--        identity modules, to allow signatures to import their implementor.</span>
<a name="line-371"></a><span class='hs-comment'>--</span>
<a name="line-372"></a><span class='hs-comment'>--      - For recompilation avoidance, you want the identity module,</span>
<a name="line-373"></a><span class='hs-comment'>--        since that will actually say the specific interface you</span>
<a name="line-374"></a><span class='hs-comment'>--        want to track (and recompile if it changes)</span>
<a name="line-375"></a>
<a name="line-376"></a><a name="TcGblEnv"></a><span class='hs-comment'>-- | 'TcGblEnv' describes the top-level of the module at the</span>
<a name="line-377"></a><a name="TcGblEnv"></a><span class='hs-comment'>-- point at which the typechecker is finished work.</span>
<a name="line-378"></a><a name="TcGblEnv"></a><span class='hs-comment'>-- It is this structure that is handed on to the desugarer</span>
<a name="line-379"></a><a name="TcGblEnv"></a><span class='hs-comment'>-- For state that needs to be updated during the typechecking</span>
<a name="line-380"></a><a name="TcGblEnv"></a><span class='hs-comment'>-- phase and returned at end, use a 'TcRef' (= 'IORef').</span>
<a name="line-381"></a><a name="TcGblEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-382"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-layout'>{</span>
<a name="line-383"></a>        <span class='hs-varid'>tcg_mod</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- ^ Module being compiled</span>
<a name="line-384"></a>        <span class='hs-varid'>tcg_semantic_mod</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- ^ If a signature, the backing module</span>
<a name="line-385"></a>            <span class='hs-comment'>-- See also Note [Identity versus semantic module]</span>
<a name="line-386"></a>        <span class='hs-varid'>tcg_src</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscSource</span><span class='hs-layout'>,</span>
<a name="line-387"></a>          <span class='hs-comment'>-- ^ What kind of module (regular Haskell, hs-boot, hsig)</span>
<a name="line-388"></a>
<a name="line-389"></a>        <span class='hs-varid'>tcg_rdr_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrEnv</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- ^ Top level envt; used during renaming</span>
<a name="line-390"></a>        <span class='hs-varid'>tcg_default</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-391"></a>          <span class='hs-comment'>-- ^ Types used for defaulting. @Nothing@ =&gt; no @default@ decl</span>
<a name="line-392"></a>
<a name="line-393"></a>        <span class='hs-varid'>tcg_fix_env</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FixityEnv</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- ^ Just for things in this module</span>
<a name="line-394"></a>        <span class='hs-varid'>tcg_field_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RecFieldEnv</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- ^ Just for things in this module</span>
<a name="line-395"></a>                                        <span class='hs-comment'>-- See Note [The interactive package] in "GHC.Runtime.Context"</span>
<a name="line-396"></a>
<a name="line-397"></a>        <span class='hs-varid'>tcg_type_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeEnv</span><span class='hs-layout'>,</span>
<a name="line-398"></a>          <span class='hs-comment'>-- ^ Global type env for the module we are compiling now.  All</span>
<a name="line-399"></a>          <span class='hs-comment'>-- TyCons and Classes (for this module) end up in here right away,</span>
<a name="line-400"></a>          <span class='hs-comment'>-- along with their derived constructors, selectors.</span>
<a name="line-401"></a>          <span class='hs-comment'>--</span>
<a name="line-402"></a>          <span class='hs-comment'>-- (Ids defined in this module start in the local envt, though they</span>
<a name="line-403"></a>          <span class='hs-comment'>--  move to the global envt during zonking)</span>
<a name="line-404"></a>          <span class='hs-comment'>--</span>
<a name="line-405"></a>          <span class='hs-comment'>-- NB: for what "things in this module" means, see</span>
<a name="line-406"></a>          <span class='hs-comment'>-- Note [The interactive package] in "GHC.Runtime.Context"</span>
<a name="line-407"></a>
<a name="line-408"></a>        <span class='hs-varid'>tcg_type_env_var</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>TypeEnv</span><span class='hs-layout'>,</span>
<a name="line-409"></a>                <span class='hs-comment'>-- Used only to initialise the interface-file</span>
<a name="line-410"></a>                <span class='hs-comment'>-- typechecker in initIfaceTcRn, so that it can see stuff</span>
<a name="line-411"></a>                <span class='hs-comment'>-- bound in this module when dealing with hi-boot recursions</span>
<a name="line-412"></a>                <span class='hs-comment'>-- Updated at intervals (e.g. after dealing with types and classes)</span>
<a name="line-413"></a>
<a name="line-414"></a>        <span class='hs-varid'>tcg_inst_env</span>     <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>InstEnv</span><span class='hs-layout'>,</span>
<a name="line-415"></a>          <span class='hs-comment'>-- ^ Instance envt for all /home-package/ modules;</span>
<a name="line-416"></a>          <span class='hs-comment'>-- Includes the dfuns in tcg_insts</span>
<a name="line-417"></a>          <span class='hs-comment'>-- NB. BangPattern is to fix a leak, see #15111</span>
<a name="line-418"></a>        <span class='hs-varid'>tcg_fam_inst_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ^ Ditto for family instances</span>
<a name="line-419"></a>          <span class='hs-comment'>-- NB. BangPattern is to fix a leak, see #15111</span>
<a name="line-420"></a>        <span class='hs-varid'>tcg_ann_env</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AnnEnv</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- ^ And for annotations</span>
<a name="line-421"></a>
<a name="line-422"></a>                <span class='hs-comment'>-- Now a bunch of things about this module that are simply</span>
<a name="line-423"></a>                <span class='hs-comment'>-- accumulated, but never consulted until the end.</span>
<a name="line-424"></a>                <span class='hs-comment'>-- Nevertheless, it's convenient to accumulate them along</span>
<a name="line-425"></a>                <span class='hs-comment'>-- with the rest of the info from this module.</span>
<a name="line-426"></a>        <span class='hs-varid'>tcg_exports</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- ^ What is exported</span>
<a name="line-427"></a>        <span class='hs-varid'>tcg_imports</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportAvails</span><span class='hs-layout'>,</span>
<a name="line-428"></a>          <span class='hs-comment'>-- ^ Information about what was imported from where, including</span>
<a name="line-429"></a>          <span class='hs-comment'>-- things bound in this module. Also store Safe Haskell info</span>
<a name="line-430"></a>          <span class='hs-comment'>-- here about transitive trusted package requirements.</span>
<a name="line-431"></a>          <span class='hs-comment'>--</span>
<a name="line-432"></a>          <span class='hs-comment'>-- There are not many uses of this field, so you can grep for</span>
<a name="line-433"></a>          <span class='hs-comment'>-- all them.</span>
<a name="line-434"></a>          <span class='hs-comment'>--</span>
<a name="line-435"></a>          <span class='hs-comment'>-- The ImportAvails records information about the following</span>
<a name="line-436"></a>          <span class='hs-comment'>-- things:</span>
<a name="line-437"></a>          <span class='hs-comment'>--</span>
<a name="line-438"></a>          <span class='hs-comment'>--    1. All of the modules you directly imported (tcRnImports)</span>
<a name="line-439"></a>          <span class='hs-comment'>--    2. The orphans (only!) of all imported modules in a GHCi</span>
<a name="line-440"></a>          <span class='hs-comment'>--       session (runTcInteractive)</span>
<a name="line-441"></a>          <span class='hs-comment'>--    3. The module that instantiated a signature</span>
<a name="line-442"></a>          <span class='hs-comment'>--    4. Each of the signatures that merged in</span>
<a name="line-443"></a>          <span class='hs-comment'>--</span>
<a name="line-444"></a>          <span class='hs-comment'>-- It is used in the following ways:</span>
<a name="line-445"></a>          <span class='hs-comment'>--    - imp_orphs is used to determine what orphan modules should be</span>
<a name="line-446"></a>          <span class='hs-comment'>--      visible in the context (tcVisibleOrphanMods)</span>
<a name="line-447"></a>          <span class='hs-comment'>--    - imp_finsts is used to determine what family instances should</span>
<a name="line-448"></a>          <span class='hs-comment'>--      be visible (tcExtendLocalFamInstEnv)</span>
<a name="line-449"></a>          <span class='hs-comment'>--    - To resolve the meaning of the export list of a module</span>
<a name="line-450"></a>          <span class='hs-comment'>--      (tcRnExports)</span>
<a name="line-451"></a>          <span class='hs-comment'>--    - imp_mods is used to compute usage info (mkIfaceTc, deSugar)</span>
<a name="line-452"></a>          <span class='hs-comment'>--    - imp_trust_own_pkg is used for Safe Haskell in interfaces</span>
<a name="line-453"></a>          <span class='hs-comment'>--      (mkIfaceTc, as well as in "GHC.Driver.Main")</span>
<a name="line-454"></a>          <span class='hs-comment'>--    - To create the Dependencies field in interface (mkDependencies)</span>
<a name="line-455"></a>
<a name="line-456"></a>          <span class='hs-comment'>-- These three fields track unused bindings and imports</span>
<a name="line-457"></a>          <span class='hs-comment'>-- See Note [Tracking unused binding and imports]</span>
<a name="line-458"></a>        <span class='hs-varid'>tcg_dus</span>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DefUses</span><span class='hs-layout'>,</span>
<a name="line-459"></a>        <span class='hs-varid'>tcg_used_gres</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-460"></a>        <span class='hs-varid'>tcg_keep</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>NameSet</span><span class='hs-layout'>,</span>
<a name="line-461"></a>
<a name="line-462"></a>        <span class='hs-varid'>tcg_th_used</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>
<a name="line-463"></a>          <span class='hs-comment'>-- ^ @True@ \&lt;=&gt; Template Haskell syntax used.</span>
<a name="line-464"></a>          <span class='hs-comment'>--</span>
<a name="line-465"></a>          <span class='hs-comment'>-- We need this so that we can generate a dependency on the</span>
<a name="line-466"></a>          <span class='hs-comment'>-- Template Haskell package, because the desugarer is going</span>
<a name="line-467"></a>          <span class='hs-comment'>-- to emit loads of references to TH symbols.  The reference</span>
<a name="line-468"></a>          <span class='hs-comment'>-- is implicit rather than explicit, so we have to zap a</span>
<a name="line-469"></a>          <span class='hs-comment'>-- mutable variable.</span>
<a name="line-470"></a>
<a name="line-471"></a>        <span class='hs-varid'>tcg_th_splice_used</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>
<a name="line-472"></a>          <span class='hs-comment'>-- ^ @True@ \&lt;=&gt; A Template Haskell splice was used.</span>
<a name="line-473"></a>          <span class='hs-comment'>--</span>
<a name="line-474"></a>          <span class='hs-comment'>-- Splices disable recompilation avoidance (see #481)</span>
<a name="line-475"></a>
<a name="line-476"></a>        <span class='hs-varid'>tcg_dfun_n</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>OccSet</span><span class='hs-layout'>,</span>
<a name="line-477"></a>          <span class='hs-comment'>-- ^ Allows us to choose unique DFun names.</span>
<a name="line-478"></a>
<a name="line-479"></a>        <span class='hs-varid'>tcg_merged</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Module</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fingerprint</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-480"></a>          <span class='hs-comment'>-- ^ The requirements we merged with; we always have to recompile</span>
<a name="line-481"></a>          <span class='hs-comment'>-- if any of these changed.</span>
<a name="line-482"></a>
<a name="line-483"></a>        <span class='hs-comment'>-- The next fields accumulate the payload of the module</span>
<a name="line-484"></a>        <span class='hs-comment'>-- The binds, rules and foreign-decl fields are collected</span>
<a name="line-485"></a>        <span class='hs-comment'>-- initially in un-zonked form and are finally zonked in tcRnSrcDecls</span>
<a name="line-486"></a>
<a name="line-487"></a>        <span class='hs-varid'>tcg_rn_exports</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LIE</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>Avails</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-488"></a>                <span class='hs-comment'>-- Nothing &lt;=&gt; no explicit export list</span>
<a name="line-489"></a>                <span class='hs-comment'>-- Is always Nothing if we don't want to retain renamed</span>
<a name="line-490"></a>                <span class='hs-comment'>-- exports.</span>
<a name="line-491"></a>                <span class='hs-comment'>-- If present contains each renamed export list item</span>
<a name="line-492"></a>                <span class='hs-comment'>-- together with its exported names.</span>
<a name="line-493"></a>
<a name="line-494"></a>        <span class='hs-varid'>tcg_rn_imports</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LImportDecl</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-495"></a>                <span class='hs-comment'>-- Keep the renamed imports regardless.  They are not</span>
<a name="line-496"></a>                <span class='hs-comment'>-- voluminous and are needed if you want to report unused imports</span>
<a name="line-497"></a>
<a name="line-498"></a>        <span class='hs-varid'>tcg_rn_decls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsGroup</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-499"></a>          <span class='hs-comment'>-- ^ Renamed decls, maybe.  @Nothing@ \&lt;=&gt; Don't retain renamed</span>
<a name="line-500"></a>          <span class='hs-comment'>-- decls.</span>
<a name="line-501"></a>
<a name="line-502"></a>        <span class='hs-varid'>tcg_dependent_files</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ^ dependencies from addDependentFile</span>
<a name="line-503"></a>
<a name="line-504"></a>        <span class='hs-varid'>tcg_th_topdecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-505"></a>        <span class='hs-comment'>-- ^ Top-level declarations from addTopDecls</span>
<a name="line-506"></a>
<a name="line-507"></a>        <span class='hs-varid'>tcg_th_foreign_files</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>ForeignSrcLang</span><span class='hs-layout'>,</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-508"></a>        <span class='hs-comment'>-- ^ Foreign files emitted from TH.</span>
<a name="line-509"></a>
<a name="line-510"></a>        <span class='hs-varid'>tcg_th_topnames</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>NameSet</span><span class='hs-layout'>,</span>
<a name="line-511"></a>        <span class='hs-comment'>-- ^ Exact names bound in top-level declarations in tcg_th_topdecls</span>
<a name="line-512"></a>
<a name="line-513"></a>        <span class='hs-varid'>tcg_th_modfinalizers</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TcLclEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThModFinalizers</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-514"></a>        <span class='hs-comment'>-- ^ Template Haskell module finalizers.</span>
<a name="line-515"></a>        <span class='hs-comment'>--</span>
<a name="line-516"></a>        <span class='hs-comment'>-- They can use particular local environments.</span>
<a name="line-517"></a>
<a name="line-518"></a>        <span class='hs-varid'>tcg_th_coreplugins</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-519"></a>        <span class='hs-comment'>-- ^ Core plugins added by Template Haskell code.</span>
<a name="line-520"></a>
<a name="line-521"></a>        <span class='hs-varid'>tcg_th_state</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span> <span class='hs-conid'>TypeRep</span> <span class='hs-conid'>Dynamic</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-522"></a>        <span class='hs-varid'>tcg_th_remote_state</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>QState</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-523"></a>        <span class='hs-comment'>-- ^ Template Haskell state</span>
<a name="line-524"></a>
<a name="line-525"></a>        <span class='hs-varid'>tcg_th_docs</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>THDocs</span><span class='hs-layout'>,</span>
<a name="line-526"></a>        <span class='hs-comment'>-- ^ Docs added in Template Haskell via @putDoc@.</span>
<a name="line-527"></a>
<a name="line-528"></a>        <span class='hs-varid'>tcg_ev_binds</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- Top-level evidence bindings</span>
<a name="line-529"></a>
<a name="line-530"></a>        <span class='hs-comment'>-- Things defined in this module, or (in GHCi)</span>
<a name="line-531"></a>        <span class='hs-comment'>-- in the declarations for a single GHCi command.</span>
<a name="line-532"></a>        <span class='hs-comment'>-- For the latter, see Note [The interactive package] in</span>
<a name="line-533"></a>        <span class='hs-comment'>-- GHC.Runtime.Context</span>
<a name="line-534"></a>        <span class='hs-varid'>tcg_tr_module</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Id</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- Id for $trModule :: GHC.Unit.Module</span>
<a name="line-535"></a>                                             <span class='hs-comment'>-- for which every module has a top-level defn</span>
<a name="line-536"></a>                                             <span class='hs-comment'>-- except in GHCi in which case we have Nothing</span>
<a name="line-537"></a>        <span class='hs-varid'>tcg_binds</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>GhcTc</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Value bindings in this module</span>
<a name="line-538"></a>        <span class='hs-varid'>tcg_sigs</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSet</span><span class='hs-layout'>,</span>            <span class='hs-comment'>-- ...Top-level names that *lack* a signature</span>
<a name="line-539"></a>        <span class='hs-varid'>tcg_imp_specs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTcSpecPrag</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- ...SPECIALISE prags for imported Ids</span>
<a name="line-540"></a>        <span class='hs-varid'>tcg_warns</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Warnings</span><span class='hs-layout'>,</span>           <span class='hs-comment'>-- ...Warnings and deprecations</span>
<a name="line-541"></a>        <span class='hs-varid'>tcg_anns</span>      <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Annotation</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- ...Annotations</span>
<a name="line-542"></a>        <span class='hs-varid'>tcg_tcs</span>       <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCon</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>            <span class='hs-comment'>-- ...TyCons and Classes</span>
<a name="line-543"></a>        <span class='hs-varid'>tcg_ksigs</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSet</span><span class='hs-layout'>,</span>            <span class='hs-comment'>-- ...Top-level TyCon names that *lack* a signature</span>
<a name="line-544"></a>        <span class='hs-varid'>tcg_insts</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>          <span class='hs-comment'>-- ...Instances</span>
<a name="line-545"></a>        <span class='hs-varid'>tcg_fam_insts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>          <span class='hs-comment'>-- ...Family instances</span>
<a name="line-546"></a>        <span class='hs-varid'>tcg_rules</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LRuleDecl</span> <span class='hs-conid'>GhcTc</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- ...Rules</span>
<a name="line-547"></a>        <span class='hs-varid'>tcg_fords</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LForeignDecl</span> <span class='hs-conid'>GhcTc</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ...Foreign import &amp; exports</span>
<a name="line-548"></a>        <span class='hs-varid'>tcg_patsyns</span>   <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PatSyn</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>            <span class='hs-comment'>-- ...Pattern synonyms</span>
<a name="line-549"></a>
<a name="line-550"></a>        <span class='hs-varid'>tcg_doc_hdr</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>LHsDocString</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ^ Maybe Haddock header docs</span>
<a name="line-551"></a>        <span class='hs-varid'>tcg_hpc</span>       <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>AnyHpcUsage</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- ^ @True@ if any part of the</span>
<a name="line-552"></a>                                             <span class='hs-comment'>--  prog uses hpc instrumentation.</span>
<a name="line-553"></a>           <span class='hs-comment'>-- NB. BangPattern is to fix a leak, see #15111</span>
<a name="line-554"></a>
<a name="line-555"></a>        <span class='hs-varid'>tcg_self_boot</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SelfBootInfo</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- ^ Whether this module has a</span>
<a name="line-556"></a>                                             <span class='hs-comment'>-- corresponding hi-boot file</span>
<a name="line-557"></a>
<a name="line-558"></a>        <span class='hs-varid'>tcg_main</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- ^ The Name of the main</span>
<a name="line-559"></a>                                             <span class='hs-comment'>-- function, if this module is</span>
<a name="line-560"></a>                                             <span class='hs-comment'>-- the main module.</span>
<a name="line-561"></a>
<a name="line-562"></a>        <span class='hs-varid'>tcg_safeInfer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>WarningMessages</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-563"></a>        <span class='hs-comment'>-- ^ Has the typechecker inferred this module as -XSafe (Safe Haskell)</span>
<a name="line-564"></a>        <span class='hs-comment'>-- See Note [Safe Haskell Overlapping Instances Implementation],</span>
<a name="line-565"></a>        <span class='hs-comment'>-- although this is used for more than just that failure case.</span>
<a name="line-566"></a>
<a name="line-567"></a>        <span class='hs-varid'>tcg_tc_plugins</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcPluginSolver</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-568"></a>        <span class='hs-comment'>-- ^ A list of user-defined plugins for the constraint solver.</span>
<a name="line-569"></a>        <span class='hs-varid'>tcg_hf_plugins</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>HoleFitPlugin</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-570"></a>        <span class='hs-comment'>-- ^ A list of user-defined plugins for hole fit suggestions.</span>
<a name="line-571"></a>
<a name="line-572"></a>        <span class='hs-varid'>tcg_top_loc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RealSrcSpan</span><span class='hs-layout'>,</span>
<a name="line-573"></a>        <span class='hs-comment'>-- ^ The RealSrcSpan this module came from</span>
<a name="line-574"></a>
<a name="line-575"></a>        <span class='hs-varid'>tcg_static_wc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>WantedConstraints</span><span class='hs-layout'>,</span>
<a name="line-576"></a>          <span class='hs-comment'>-- ^ Wanted constraints of static forms.</span>
<a name="line-577"></a>        <span class='hs-comment'>-- See Note [Constraints in static forms].</span>
<a name="line-578"></a>        <span class='hs-varid'>tcg_complete_matches</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>CompleteMatches</span><span class='hs-layout'>,</span>
<a name="line-579"></a>
<a name="line-580"></a>        <span class='hs-comment'>-- ^ Tracking indices for cost centre annotations</span>
<a name="line-581"></a>        <span class='hs-varid'>tcg_cc_st</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>CostCentreState</span>
<a name="line-582"></a>    <span class='hs-layout'>}</span>
<a name="line-583"></a>
<a name="line-584"></a><span class='hs-comment'>-- NB: topModIdentity, not topModSemantic!</span>
<a name="line-585"></a><span class='hs-comment'>-- Definition sites of orphan identities will be identity modules, not semantic</span>
<a name="line-586"></a><span class='hs-comment'>-- modules.</span>
<a name="line-587"></a>
<a name="line-588"></a><span class='hs-comment'>-- Note [Constraints in static forms]</span>
<a name="line-589"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-590"></a><span class='hs-comment'>--</span>
<a name="line-591"></a><span class='hs-comment'>-- When a static form produces constraints like</span>
<a name="line-592"></a><span class='hs-comment'>--</span>
<a name="line-593"></a><span class='hs-comment'>-- f :: StaticPtr (Bool -&gt; String)</span>
<a name="line-594"></a><span class='hs-comment'>-- f = static show</span>
<a name="line-595"></a><span class='hs-comment'>--</span>
<a name="line-596"></a><span class='hs-comment'>-- we collect them in tcg_static_wc and resolve them at the end</span>
<a name="line-597"></a><span class='hs-comment'>-- of type checking. They need to be resolved separately because</span>
<a name="line-598"></a><span class='hs-comment'>-- we don't want to resolve them in the context of the enclosing</span>
<a name="line-599"></a><span class='hs-comment'>-- expression. Consider</span>
<a name="line-600"></a><span class='hs-comment'>--</span>
<a name="line-601"></a><span class='hs-comment'>-- g :: Show a =&gt; StaticPtr (a -&gt; String)</span>
<a name="line-602"></a><span class='hs-comment'>-- g = static show</span>
<a name="line-603"></a><span class='hs-comment'>--</span>
<a name="line-604"></a><span class='hs-comment'>-- If the @Show a0@ constraint that the body of the static form produces was</span>
<a name="line-605"></a><span class='hs-comment'>-- resolved in the context of the enclosing expression, then the body of the</span>
<a name="line-606"></a><span class='hs-comment'>-- static form wouldn't be closed because the Show dictionary would come from</span>
<a name="line-607"></a><span class='hs-comment'>-- g's context instead of coming from the top level.</span>
<a name="line-608"></a>
<a name="line-609"></a><a name="tcVisibleOrphanMods"></a><span class='hs-definition'>tcVisibleOrphanMods</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleSet</span>
<a name="line-610"></a><span class='hs-definition'>tcVisibleOrphanMods</span> <span class='hs-varid'>tcg_env</span>
<a name="line-611"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkModuleSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_mod</span> <span class='hs-varid'>tcg_env</span> <span class='hs-conop'>:</span> <span class='hs-varid'>imp_orphs</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_imports</span> <span class='hs-varid'>tcg_env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-612"></a>
<a name="line-613"></a><a name="instance%20ContainsModule%20TcGblEnv"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ContainsModule</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyword'>where</span>
<a name="line-614"></a>    <span class='hs-varid'>extractModule</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_semantic_mod</span> <span class='hs-varid'>env</span>
<a name="line-615"></a>
<a name="line-616"></a><a name="RecFieldEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>RecFieldEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FieldLabel</span><span class='hs-keyglyph'>]</span>
<a name="line-617"></a>        <span class='hs-comment'>-- Maps a constructor name *in this module*</span>
<a name="line-618"></a>        <span class='hs-comment'>-- to the fields for that constructor.</span>
<a name="line-619"></a>        <span class='hs-comment'>-- This is used when dealing with ".." notation in record</span>
<a name="line-620"></a>        <span class='hs-comment'>-- construction and pattern matching.</span>
<a name="line-621"></a>        <span class='hs-comment'>-- The FieldEnv deals *only* with constructors defined in *this*</span>
<a name="line-622"></a>        <span class='hs-comment'>-- module.  For imported modules, we get the same info from the</span>
<a name="line-623"></a>        <span class='hs-comment'>-- TypeEnv</span>
<a name="line-624"></a>
<a name="line-625"></a><a name="SelfBootInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SelfBootInfo</span>
<a name="line-626"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoSelfBoot</span>    <span class='hs-comment'>-- No corresponding hi-boot file</span>
<a name="line-627"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SelfBoot</span>
<a name="line-628"></a>       <span class='hs-layout'>{</span> <span class='hs-varid'>sb_mds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModDetails</span>   <span class='hs-comment'>-- There was a hi-boot file,</span>
<a name="line-629"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>sb_tcs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSet</span> <span class='hs-layout'>}</span>    <span class='hs-comment'>-- defining these TyCons,</span>
<a name="line-630"></a><span class='hs-comment'>-- What is sb_tcs used for?  See Note [Extra dependencies from .hs-boot files]</span>
<a name="line-631"></a><span class='hs-comment'>-- in GHC.Rename.Module</span>
<a name="line-632"></a>
<a name="line-633"></a>
<a name="line-634"></a><span class='hs-comment'>{- Note [Tracking unused binding and imports]
<a name="line-635"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-636"></a>We gather three sorts of usage information
<a name="line-637"></a>
<a name="line-638"></a> * tcg_dus :: DefUses (defs/uses)
<a name="line-639"></a>      Records what is defined in this module and what is used.
<a name="line-640"></a>
<a name="line-641"></a>      Records *defined* Names (local, top-level)
<a name="line-642"></a>          and *used*    Names (local or imported)
<a name="line-643"></a>
<a name="line-644"></a>      Used (a) to report "defined but not used"
<a name="line-645"></a>               (see GHC.Rename.Names.reportUnusedNames)
<a name="line-646"></a>           (b) to generate version-tracking usage info in interface
<a name="line-647"></a>               files (see GHC.Iface.Make.mkUsedNames)
<a name="line-648"></a>   This usage info is mainly gathered by the renamer's
<a name="line-649"></a>   gathering of free-variables
<a name="line-650"></a>
<a name="line-651"></a> * tcg_used_gres :: TcRef [GlobalRdrElt]
<a name="line-652"></a>      Records occurrences of imported entities.
<a name="line-653"></a>
<a name="line-654"></a>      Used only to report unused import declarations
<a name="line-655"></a>
<a name="line-656"></a>      Records each *occurrence* an *imported* (not locally-defined) entity.
<a name="line-657"></a>      The occurrence is recorded by keeping a GlobalRdrElt for it.
<a name="line-658"></a>      These is not the GRE that is in the GlobalRdrEnv; rather it
<a name="line-659"></a>      is recorded *after* the filtering done by pickGREs.  So it reflect
<a name="line-660"></a>      /how that occurrence is in scope/.   See Note [GRE filtering] in
<a name="line-661"></a>      RdrName.
<a name="line-662"></a>
<a name="line-663"></a>  * tcg_keep :: TcRef NameSet
<a name="line-664"></a>      Records names of the type constructors, data constructors, and Ids that
<a name="line-665"></a>      are used by the constraint solver.
<a name="line-666"></a>
<a name="line-667"></a>      The typechecker may use find that some imported or
<a name="line-668"></a>      locally-defined things are used, even though they
<a name="line-669"></a>      do not appear to be mentioned in the source code:
<a name="line-670"></a>
<a name="line-671"></a>      (a) The to/from functions for generic data types
<a name="line-672"></a>
<a name="line-673"></a>      (b) Top-level variables appearing free in the RHS of an
<a name="line-674"></a>          orphan rule
<a name="line-675"></a>
<a name="line-676"></a>      (c) Top-level variables appearing free in a TH bracket
<a name="line-677"></a>          See Note [Keeping things alive for Template Haskell]
<a name="line-678"></a>          in GHC.Rename.Splice
<a name="line-679"></a>
<a name="line-680"></a>      (d) The data constructor of a newtype that is used
<a name="line-681"></a>          to solve a Coercible instance (e.g. #10347). Example
<a name="line-682"></a>              module T10347 (N, mkN) where
<a name="line-683"></a>                import Data.Coerce
<a name="line-684"></a>                newtype N a = MkN Int
<a name="line-685"></a>                mkN :: Int -&gt; N a
<a name="line-686"></a>                mkN = coerce
<a name="line-687"></a>
<a name="line-688"></a>          Then we wish to record `MkN` as used, since it is (morally)
<a name="line-689"></a>          used to perform the coercion in `mkN`. To do so, the
<a name="line-690"></a>          Coercible solver updates tcg_keep's TcRef whenever it
<a name="line-691"></a>          encounters a use of `coerce` that crosses newtype boundaries.
<a name="line-692"></a>
<a name="line-693"></a>      (e) Record fields that are used to solve HasField constraints
<a name="line-694"></a>          (see Note [Unused name reporting and HasField] in GHC.Tc.Instance.Class)
<a name="line-695"></a>
<a name="line-696"></a>      The tcg_keep field is used in two distinct ways:
<a name="line-697"></a>
<a name="line-698"></a>      * Desugar.addExportFlagsAndRules.  Where things like (a-c) are locally
<a name="line-699"></a>        defined, we should give them an Exported flag, so that the
<a name="line-700"></a>        simplifier does not discard them as dead code, and so that they are
<a name="line-701"></a>        exposed in the interface file (but not to export to the user).
<a name="line-702"></a>
<a name="line-703"></a>      * GHC.Rename.Names.reportUnusedNames.  Where newtype data constructors
<a name="line-704"></a>        like (d) are imported, we don't want to report them as unused.
<a name="line-705"></a>
<a name="line-706"></a>
<a name="line-707"></a>************************************************************************
<a name="line-708"></a>*                                                                      *
<a name="line-709"></a>                The local typechecker environment
<a name="line-710"></a>*                                                                      *
<a name="line-711"></a>************************************************************************
<a name="line-712"></a>
<a name="line-713"></a>Note [The Global-Env/Local-Env story]
<a name="line-714"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-715"></a>During type checking, we keep in the tcg_type_env
<a name="line-716"></a>        * All types and classes
<a name="line-717"></a>        * All Ids derived from types and classes (constructors, selectors)
<a name="line-718"></a>
<a name="line-719"></a>At the end of type checking, we zonk the local bindings,
<a name="line-720"></a>and as we do so we add to the tcg_type_env
<a name="line-721"></a>        * Locally defined top-level Ids
<a name="line-722"></a>
<a name="line-723"></a>Why?  Because they are now Ids not TcIds.  This final GlobalEnv is
<a name="line-724"></a>        a) fed back (via the knot) to typechecking the
<a name="line-725"></a>           unfoldings of interface signatures
<a name="line-726"></a>        b) used in the ModDetails of this module
<a name="line-727"></a>-}</span>
<a name="line-728"></a>
<a name="line-729"></a><a name="TcLclEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcLclEnv</span>           <span class='hs-comment'>-- Changes as we move inside an expression</span>
<a name="line-730"></a>                        <span class='hs-comment'>-- Discarded after typecheck/rename; not passed on to desugarer</span>
<a name="line-731"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcLclEnv</span> <span class='hs-layout'>{</span>
<a name="line-732"></a>        <span class='hs-varid'>tcl_loc</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RealSrcSpan</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Source span</span>
<a name="line-733"></a>        <span class='hs-varid'>tcl_ctxt</span>       <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ErrCtxt</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- Error context, innermost on top</span>
<a name="line-734"></a>        <span class='hs-varid'>tcl_in_gen_code</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>           <span class='hs-comment'>-- See Note [Rebindable syntax and HsExpansion]</span>
<a name="line-735"></a>        <span class='hs-varid'>tcl_tclvl</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span><span class='hs-layout'>,</span>
<a name="line-736"></a>
<a name="line-737"></a>        <span class='hs-varid'>tcl_th_ctxt</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThStage</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- Template Haskell context</span>
<a name="line-738"></a>        <span class='hs-varid'>tcl_th_bndrs</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThBindEnv</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- and binder info</span>
<a name="line-739"></a>            <span class='hs-comment'>-- The ThBindEnv records the TH binding level of in-scope Names</span>
<a name="line-740"></a>            <span class='hs-comment'>-- defined in this module (not imported)</span>
<a name="line-741"></a>            <span class='hs-comment'>-- We can't put this info in the TypeEnv because it's needed</span>
<a name="line-742"></a>            <span class='hs-comment'>-- (and extended) in the renamer, for untyed splices</span>
<a name="line-743"></a>
<a name="line-744"></a>        <span class='hs-varid'>tcl_arrow_ctxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ArrowCtxt</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- Arrow-notation context</span>
<a name="line-745"></a>
<a name="line-746"></a>        <span class='hs-varid'>tcl_rdr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LocalRdrEnv</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- Local name envt</span>
<a name="line-747"></a>                <span class='hs-comment'>-- Maintained during renaming, of course, but also during</span>
<a name="line-748"></a>                <span class='hs-comment'>-- type checking, solely so that when renaming a Template-Haskell</span>
<a name="line-749"></a>                <span class='hs-comment'>-- splice we have the right environment for the renamer.</span>
<a name="line-750"></a>                <span class='hs-comment'>--</span>
<a name="line-751"></a>                <span class='hs-comment'>--   Does *not* include global name envt; may shadow it</span>
<a name="line-752"></a>                <span class='hs-comment'>--   Includes both ordinary variables and type variables;</span>
<a name="line-753"></a>                <span class='hs-comment'>--   they are kept distinct because tyvar have a different</span>
<a name="line-754"></a>                <span class='hs-comment'>--   occurrence constructor (Name.TvOcc)</span>
<a name="line-755"></a>                <span class='hs-comment'>-- We still need the unsullied global name env so that</span>
<a name="line-756"></a>                <span class='hs-comment'>--   we can look up record field names</span>
<a name="line-757"></a>
<a name="line-758"></a>        <span class='hs-varid'>tcl_env</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTypeEnv</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- The local type environment:</span>
<a name="line-759"></a>                                  <span class='hs-comment'>-- Ids and TyVars defined in this module</span>
<a name="line-760"></a>
<a name="line-761"></a>        <span class='hs-varid'>tcl_usage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>UsageEnv</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Required multiplicity of bindings is accumulated here.</span>
<a name="line-762"></a>
<a name="line-763"></a>
<a name="line-764"></a>        <span class='hs-varid'>tcl_bndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcBinderStack</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- Used for reporting relevant bindings,</span>
<a name="line-765"></a>                                      <span class='hs-comment'>-- and for tidying types</span>
<a name="line-766"></a>
<a name="line-767"></a>        <span class='hs-varid'>tcl_lie</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>WantedConstraints</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- Place to accumulate type constraints</span>
<a name="line-768"></a>        <span class='hs-varid'>tcl_errs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>Messages</span> <span class='hs-conid'>DecoratedSDoc</span><span class='hs-layout'>)</span>     <span class='hs-comment'>-- Place to accumulate errors</span>
<a name="line-769"></a>    <span class='hs-layout'>}</span>
<a name="line-770"></a>
<a name="line-771"></a><a name="setLclEnvTcLevel"></a><span class='hs-definition'>setLclEnvTcLevel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLclEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcLclEnv</span>
<a name="line-772"></a><span class='hs-definition'>setLclEnvTcLevel</span> <span class='hs-varid'>env</span> <span class='hs-varid'>lvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcl_tclvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lvl</span> <span class='hs-layout'>}</span>
<a name="line-773"></a>
<a name="line-774"></a><a name="getLclEnvTcLevel"></a><span class='hs-definition'>getLclEnvTcLevel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLclEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcLevel</span>
<a name="line-775"></a><span class='hs-definition'>getLclEnvTcLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcl_tclvl</span>
<a name="line-776"></a>
<a name="line-777"></a><a name="setLclEnvLoc"></a><span class='hs-definition'>setLclEnvLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLclEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RealSrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcLclEnv</span>
<a name="line-778"></a><span class='hs-definition'>setLclEnvLoc</span> <span class='hs-varid'>env</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcl_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span>
<a name="line-779"></a>
<a name="line-780"></a><a name="getLclEnvLoc"></a><span class='hs-definition'>getLclEnvLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLclEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RealSrcSpan</span>
<a name="line-781"></a><span class='hs-definition'>getLclEnvLoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcl_loc</span>
<a name="line-782"></a>
<a name="line-783"></a><a name="ErrCtxt"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ErrCtxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-784"></a>        <span class='hs-comment'>-- Monadic so that we have a chance</span>
<a name="line-785"></a>        <span class='hs-comment'>-- to deal with bound type variables just before error</span>
<a name="line-786"></a>        <span class='hs-comment'>-- message construction</span>
<a name="line-787"></a>
<a name="line-788"></a>        <span class='hs-comment'>-- Bool:  True &lt;=&gt; this is a landmark context; do not</span>
<a name="line-789"></a>        <span class='hs-comment'>--                 discard it when trimming for display</span>
<a name="line-790"></a>
<a name="line-791"></a><a name="pushErrCtxt"></a><span class='hs-comment'>-- These are here to avoid module loops: one might expect them</span>
<a name="line-792"></a><span class='hs-comment'>-- in GHC.Tc.Types.Constraint, but they refer to ErrCtxt which refers to TcM.</span>
<a name="line-793"></a><span class='hs-comment'>-- Easier to just keep these definitions here, alongside TcM.</span>
<a name="line-794"></a><span class='hs-definition'>pushErrCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-795"></a><span class='hs-definition'>pushErrCtxt</span> <span class='hs-varid'>o</span> <span class='hs-varid'>err</span> <span class='hs-varid'>loc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-796"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcl_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>err</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tcl_ctxt</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-797"></a>
<a name="line-798"></a><a name="pushErrCtxtSameOrigin"></a><span class='hs-definition'>pushErrCtxtSameOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-799"></a><span class='hs-comment'>-- Just add information w/o updating the origin!</span>
<a name="line-800"></a><span class='hs-definition'>pushErrCtxtSameOrigin</span> <span class='hs-varid'>err</span> <span class='hs-varid'>loc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-801"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcl_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>err</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tcl_ctxt</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-802"></a>
<a name="line-803"></a><a name="TcTypeEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcTypeEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>TcTyThing</span>
<a name="line-804"></a>
<a name="line-805"></a><a name="ThBindEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ThBindEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TopLevelFlag</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThLevel</span><span class='hs-layout'>)</span>
<a name="line-806"></a>   <span class='hs-comment'>-- Domain = all Ids bound in this module (ie not imported)</span>
<a name="line-807"></a>   <span class='hs-comment'>-- The TopLevelFlag tells if the binding is syntactically top level.</span>
<a name="line-808"></a>   <span class='hs-comment'>-- We need to know this, because the cross-stage persistence story allows</span>
<a name="line-809"></a>   <span class='hs-comment'>-- cross-stage at arbitrary types if the Id is bound at top level.</span>
<a name="line-810"></a>   <span class='hs-comment'>--</span>
<a name="line-811"></a>   <span class='hs-comment'>-- Nota bene: a ThLevel of 'outerLevel' is *not* the same as being</span>
<a name="line-812"></a>   <span class='hs-comment'>-- bound at top level!  See Note [Template Haskell levels] in GHC.Tc.Gen.Splice</span>
<a name="line-813"></a>
<a name="line-814"></a><span class='hs-comment'>{- Note [Given Insts]
<a name="line-815"></a>   ~~~~~~~~~~~~~~~~~~
<a name="line-816"></a>Because of GADTs, we have to pass inwards the Insts provided by type signatures
<a name="line-817"></a>and existential contexts. Consider
<a name="line-818"></a>        data T a where { T1 :: b -&gt; b -&gt; T [b] }
<a name="line-819"></a>        f :: Eq a =&gt; T a -&gt; Bool
<a name="line-820"></a>        f (T1 x y) = [x]==[y]
<a name="line-821"></a>
<a name="line-822"></a>The constructor T1 binds an existential variable 'b', and we need Eq [b].
<a name="line-823"></a>Well, we have it, because Eq a refines to Eq [b], but we can only spot that if we
<a name="line-824"></a>pass it inwards.
<a name="line-825"></a>
<a name="line-826"></a>-}</span>
<a name="line-827"></a>
<a name="line-828"></a><a name="TcRef"></a><span class='hs-comment'>-- | Type alias for 'IORef'; the convention is we'll use this for mutable</span>
<a name="line-829"></a><a name="TcRef"></a><span class='hs-comment'>-- bits of data in 'TcGblEnv' which are updated during typechecking and</span>
<a name="line-830"></a><a name="TcRef"></a><span class='hs-comment'>-- returned at the end.</span>
<a name="line-831"></a><a name="TcRef"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcRef</span> <span class='hs-varid'>a</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IORef</span> <span class='hs-varid'>a</span>
<a name="line-832"></a><a name="TcId"></a><span class='hs-comment'>-- ToDo: when should I refer to it as a 'TcId' instead of an 'Id'?</span>
<a name="line-833"></a><a name="TcId"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcId</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Id</span>
<a name="line-834"></a><a name="TcIdSet"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcIdSet</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IdSet</span>
<a name="line-835"></a>
<a name="line-836"></a><span class='hs-comment'>---------------------------</span>
<a name="line-837"></a><span class='hs-comment'>-- The TcBinderStack</span>
<a name="line-838"></a><span class='hs-comment'>---------------------------</span>
<a name="line-839"></a>
<a name="line-840"></a><a name="TcBinderStack"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcBinderStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcBinder</span><span class='hs-keyglyph'>]</span>
<a name="line-841"></a>   <span class='hs-comment'>-- This is a stack of locally-bound ids and tyvars,</span>
<a name="line-842"></a>   <span class='hs-comment'>--   innermost on top</span>
<a name="line-843"></a>   <span class='hs-comment'>-- Used only in error reporting (relevantBindings in TcError),</span>
<a name="line-844"></a>   <span class='hs-comment'>--   and in tidying</span>
<a name="line-845"></a>   <span class='hs-comment'>-- We can't use the tcl_env type environment, because it doesn't</span>
<a name="line-846"></a>   <span class='hs-comment'>--   keep track of the nesting order</span>
<a name="line-847"></a>
<a name="line-848"></a><a name="TcBinder"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcBinder</span>
<a name="line-849"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcIdBndr</span>
<a name="line-850"></a>       <span class='hs-conid'>TcId</span>
<a name="line-851"></a>       <span class='hs-conid'>TopLevelFlag</span>    <span class='hs-comment'>-- Tells whether the binding is syntactically top-level</span>
<a name="line-852"></a>                       <span class='hs-comment'>-- (The monomorphic Ids for a recursive group count</span>
<a name="line-853"></a>                       <span class='hs-comment'>--  as not-top-level for this purpose.)</span>
<a name="line-854"></a>
<a name="line-855"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcIdBndr_ExpType</span>  <span class='hs-comment'>-- Variant that allows the type to be specified as</span>
<a name="line-856"></a>                      <span class='hs-comment'>-- an ExpType</span>
<a name="line-857"></a>       <span class='hs-conid'>Name</span>
<a name="line-858"></a>       <span class='hs-conid'>ExpType</span>
<a name="line-859"></a>       <span class='hs-conid'>TopLevelFlag</span>
<a name="line-860"></a>
<a name="line-861"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcTvBndr</span>          <span class='hs-comment'>-- e.g.   case x of P (y::a) -&gt; blah</span>
<a name="line-862"></a>       <span class='hs-conid'>Name</span>           <span class='hs-comment'>-- We bind the lexical name "a" to the type of y,</span>
<a name="line-863"></a>       <span class='hs-conid'>TyVar</span>          <span class='hs-comment'>-- which might be an utterly different (perhaps</span>
<a name="line-864"></a>                      <span class='hs-comment'>-- existential) tyvar</span>
<a name="line-865"></a>
<a name="line-866"></a><a name="instance%20Outputable%20TcBinder"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcBinder</span> <span class='hs-keyword'>where</span>
<a name="line-867"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcIdBndr</span> <span class='hs-varid'>id</span> <span class='hs-varid'>top_lvl</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>top_lvl</span><span class='hs-layout'>)</span>
<a name="line-868"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcIdBndr_ExpType</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>top_lvl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>top_lvl</span><span class='hs-layout'>)</span>
<a name="line-869"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTvBndr</span> <span class='hs-varid'>name</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span>
<a name="line-870"></a>
<a name="line-871"></a><a name="instance%20HasOccName%20TcBinder"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasOccName</span> <span class='hs-conid'>TcBinder</span> <span class='hs-keyword'>where</span>
<a name="line-872"></a>    <span class='hs-varid'>occName</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcIdBndr</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occName</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-873"></a>    <span class='hs-varid'>occName</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcIdBndr_ExpType</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occName</span> <span class='hs-varid'>name</span>
<a name="line-874"></a>    <span class='hs-varid'>occName</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTvBndr</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occName</span> <span class='hs-varid'>name</span>
<a name="line-875"></a>
<a name="line-876"></a><a name="removeBindingShadowing"></a><span class='hs-comment'>-- fixes #12177</span>
<a name="line-877"></a><span class='hs-comment'>-- Builds up a list of bindings whose OccName has not been seen before</span>
<a name="line-878"></a><span class='hs-comment'>-- i.e., If    ys  = removeBindingShadowing xs</span>
<a name="line-879"></a><span class='hs-comment'>-- then</span>
<a name="line-880"></a><span class='hs-comment'>--  - ys is obtained from xs by deleting some elements</span>
<a name="line-881"></a><span class='hs-comment'>--  - ys has no duplicate OccNames</span>
<a name="line-882"></a><span class='hs-comment'>--  - The first duplicated OccName in xs is retained in ys</span>
<a name="line-883"></a><span class='hs-comment'>-- Overloaded so that it can be used for both GlobalRdrElt in typed-hole</span>
<a name="line-884"></a><span class='hs-comment'>-- substitutions and TcBinder when looking for relevant bindings.</span>
<a name="line-885"></a><span class='hs-definition'>removeBindingShadowing</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasOccName</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-886"></a><span class='hs-definition'>removeBindingShadowing</span> <span class='hs-varid'>bindings</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverse</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>foldl</span>
<a name="line-887"></a>    <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>bindingAcc</span><span class='hs-layout'>,</span> <span class='hs-varid'>seenNames</span><span class='hs-layout'>)</span> <span class='hs-varid'>binding</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-888"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>occName</span> <span class='hs-varid'>binding</span> <span class='hs-varop'>`elemOccSet`</span> <span class='hs-varid'>seenNames</span> <span class='hs-comment'>-- if we've seen it</span>
<a name="line-889"></a>        <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-varid'>bindingAcc</span><span class='hs-layout'>,</span> <span class='hs-varid'>seenNames</span><span class='hs-layout'>)</span>              <span class='hs-comment'>-- skip it</span>
<a name="line-890"></a>        <span class='hs-keyword'>else</span> <span class='hs-layout'>(</span><span class='hs-varid'>binding</span><span class='hs-conop'>:</span><span class='hs-varid'>bindingAcc</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendOccSet</span> <span class='hs-varid'>seenNames</span> <span class='hs-layout'>(</span><span class='hs-varid'>occName</span> <span class='hs-varid'>binding</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-891"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyOccSet</span><span class='hs-layout'>)</span> <span class='hs-varid'>bindings</span>
<a name="line-892"></a>
<a name="line-893"></a>
<a name="line-894"></a><a name="getPlatform"></a><span class='hs-comment'>-- | Get target platform</span>
<a name="line-895"></a><span class='hs-definition'>getPlatform</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Platform</span>
<a name="line-896"></a><span class='hs-definition'>getPlatform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-897"></a>
<a name="line-898"></a><span class='hs-comment'>---------------------------</span>
<a name="line-899"></a><span class='hs-comment'>-- Template Haskell stages and levels</span>
<a name="line-900"></a><span class='hs-comment'>---------------------------</span>
<a name="line-901"></a>
<a name="line-902"></a><a name="SpliceType"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SpliceType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Typed</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Untyped</span>
<a name="line-903"></a>
<a name="line-904"></a><a name="ThStage"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ThStage</span>    <span class='hs-comment'>-- See Note [Template Haskell state diagram]</span>
<a name="line-905"></a>                <span class='hs-comment'>-- and Note [Template Haskell levels] in GHC.Tc.Gen.Splice</span>
<a name="line-906"></a>    <span class='hs-comment'>-- Start at:   Comp</span>
<a name="line-907"></a>    <span class='hs-comment'>-- At bracket: wrap current stage in Brack</span>
<a name="line-908"></a>    <span class='hs-comment'>-- At splice:  currently Brack: return to previous stage</span>
<a name="line-909"></a>    <span class='hs-comment'>--             currently Comp/Splice: compile and run</span>
<a name="line-910"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Splice</span> <span class='hs-conid'>SpliceType</span> <span class='hs-comment'>-- Inside a top-level splice</span>
<a name="line-911"></a>                      <span class='hs-comment'>-- This code will be run *at compile time*;</span>
<a name="line-912"></a>                      <span class='hs-comment'>--   the result replaces the splice</span>
<a name="line-913"></a>                      <span class='hs-comment'>-- Binding level = 0</span>
<a name="line-914"></a>
<a name="line-915"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RunSplice</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ForeignRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.Q</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-916"></a>      <span class='hs-comment'>-- Set when running a splice, i.e. NOT when renaming or typechecking the</span>
<a name="line-917"></a>      <span class='hs-comment'>-- Haskell code for the splice. See Note [RunSplice ThLevel].</span>
<a name="line-918"></a>      <span class='hs-comment'>--</span>
<a name="line-919"></a>      <span class='hs-comment'>-- Contains a list of mod finalizers collected while executing the splice.</span>
<a name="line-920"></a>      <span class='hs-comment'>--</span>
<a name="line-921"></a>      <span class='hs-comment'>-- 'addModFinalizer' inserts finalizers here, and from here they are taken</span>
<a name="line-922"></a>      <span class='hs-comment'>-- to construct an @HsSpliced@ annotation for untyped splices. See Note</span>
<a name="line-923"></a>      <span class='hs-comment'>-- [Delaying modFinalizers in untyped splices] in GHC.Rename.Splice.</span>
<a name="line-924"></a>      <span class='hs-comment'>--</span>
<a name="line-925"></a>      <span class='hs-comment'>-- For typed splices, the typechecker takes finalizers from here and</span>
<a name="line-926"></a>      <span class='hs-comment'>-- inserts them in the list of finalizers in the global environment.</span>
<a name="line-927"></a>      <span class='hs-comment'>--</span>
<a name="line-928"></a>      <span class='hs-comment'>-- See Note [Collecting modFinalizers in typed splices] in "GHC.Tc.Gen.Splice".</span>
<a name="line-929"></a>
<a name="line-930"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Comp</span>        <span class='hs-comment'>-- Ordinary Haskell code</span>
<a name="line-931"></a>                <span class='hs-comment'>-- Binding level = 1</span>
<a name="line-932"></a>
<a name="line-933"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Brack</span>                       <span class='hs-comment'>-- Inside brackets</span>
<a name="line-934"></a>      <span class='hs-conid'>ThStage</span>                   <span class='hs-comment'>--   Enclosing stage</span>
<a name="line-935"></a>      <span class='hs-conid'>PendingStuff</span>
<a name="line-936"></a>
<a name="line-937"></a><a name="PendingStuff"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PendingStuff</span>
<a name="line-938"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RnPendingUntyped</span>              <span class='hs-comment'>-- Renaming the inside of an *untyped* bracket</span>
<a name="line-939"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PendingRnSplice</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Pending splices in here</span>
<a name="line-940"></a>
<a name="line-941"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RnPendingTyped</span>                <span class='hs-comment'>-- Renaming the inside of a *typed* bracket</span>
<a name="line-942"></a>
<a name="line-943"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcPending</span>                     <span class='hs-comment'>-- Typechecking the inside of a typed bracket</span>
<a name="line-944"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PendingTcSplice</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>   <span class='hs-comment'>--   Accumulate pending splices here</span>
<a name="line-945"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>TcRef</span> <span class='hs-conid'>WantedConstraints</span><span class='hs-layout'>)</span>   <span class='hs-comment'>--     and type constraints here</span>
<a name="line-946"></a>      <span class='hs-conid'>QuoteWrapper</span>                <span class='hs-comment'>-- A type variable and evidence variable</span>
<a name="line-947"></a>                                  <span class='hs-comment'>-- for the overall monad of</span>
<a name="line-948"></a>                                  <span class='hs-comment'>-- the bracket. Splices are checked</span>
<a name="line-949"></a>                                  <span class='hs-comment'>-- against this monad. The evidence</span>
<a name="line-950"></a>                                  <span class='hs-comment'>-- variable is used for desugaring</span>
<a name="line-951"></a>                                  <span class='hs-comment'>-- `lift`.</span>
<a name="line-952"></a>
<a name="line-953"></a>
<a name="line-954"></a><a name="topStage"></a><span class='hs-definition'>topStage</span><span class='hs-layout'>,</span> <span class='hs-varid'>topAnnStage</span><span class='hs-layout'>,</span> <span class='hs-varid'>topSpliceStage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThStage</span>
<a name="line-955"></a><span class='hs-definition'>topStage</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Comp</span>
<a name="line-956"></a><a name="topAnnStage"></a><span class='hs-definition'>topAnnStage</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Splice</span> <span class='hs-conid'>Untyped</span>
<a name="line-957"></a><a name="topSpliceStage"></a><span class='hs-definition'>topSpliceStage</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Splice</span> <span class='hs-conid'>Untyped</span>
<a name="line-958"></a>
<a name="line-959"></a><a name="instance%20Outputable%20ThStage"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>ThStage</span> <span class='hs-keyword'>where</span>
<a name="line-960"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Splice</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Splice"</span>
<a name="line-961"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>RunSplice</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"RunSplice"</span>
<a name="line-962"></a>   <span class='hs-varid'>ppr</span> <span class='hs-conid'>Comp</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Comp"</span>
<a name="line-963"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Brack</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Brack"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-964"></a>
<a name="line-965"></a><a name="ThLevel"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ThLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Int</span>
<a name="line-966"></a>    <span class='hs-comment'>-- NB: see Note [Template Haskell levels] in GHC.Tc.Gen.Splice</span>
<a name="line-967"></a>    <span class='hs-comment'>-- Incremented when going inside a bracket,</span>
<a name="line-968"></a>    <span class='hs-comment'>-- decremented when going inside a splice</span>
<a name="line-969"></a>    <span class='hs-comment'>-- NB: ThLevel is one greater than the 'n' in Fig 2 of the</span>
<a name="line-970"></a>    <span class='hs-comment'>--     original "Template meta-programming for Haskell" paper</span>
<a name="line-971"></a>
<a name="line-972"></a><a name="impLevel"></a><span class='hs-definition'>impLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>outerLevel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThLevel</span>
<a name="line-973"></a><span class='hs-definition'>impLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>    <span class='hs-comment'>-- Imported things; they can be used inside a top level splice</span>
<a name="line-974"></a><a name="outerLevel"></a><span class='hs-definition'>outerLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>  <span class='hs-comment'>-- Things defined outside brackets</span>
<a name="line-975"></a>
<a name="line-976"></a><a name="thLevel"></a><span class='hs-definition'>thLevel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThStage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThLevel</span>
<a name="line-977"></a><span class='hs-definition'>thLevel</span> <span class='hs-layout'>(</span><span class='hs-conid'>Splice</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-978"></a><span class='hs-definition'>thLevel</span> <span class='hs-conid'>Comp</span>          <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-979"></a><span class='hs-definition'>thLevel</span> <span class='hs-layout'>(</span><span class='hs-conid'>Brack</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thLevel</span> <span class='hs-varid'>s</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span>
<a name="line-980"></a><span class='hs-definition'>thLevel</span> <span class='hs-layout'>(</span><span class='hs-conid'>RunSplice</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"thLevel: called when running a splice"</span>
<a name="line-981"></a>                        <span class='hs-comment'>-- See Note [RunSplice ThLevel].</span>
<a name="line-982"></a>
<a name="line-983"></a><span class='hs-comment'>{- Node [RunSplice ThLevel]
<a name="line-984"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-985"></a>The 'RunSplice' stage is set when executing a splice, and only when running a
<a name="line-986"></a>splice. In particular it is not set when the splice is renamed or typechecked.
<a name="line-987"></a>
<a name="line-988"></a>'RunSplice' is needed to provide a reference where 'addModFinalizer' can insert
<a name="line-989"></a>the finalizer (see Note [Delaying modFinalizers in untyped splices]), and
<a name="line-990"></a>'addModFinalizer' runs when doing Q things. Therefore, It doesn't make sense to
<a name="line-991"></a>set 'RunSplice' when renaming or typechecking the splice, where 'Splice',
<a name="line-992"></a>'Brack' or 'Comp' are used instead.
<a name="line-993"></a>
<a name="line-994"></a>-}</span>
<a name="line-995"></a>
<a name="line-996"></a><span class='hs-comment'>---------------------------</span>
<a name="line-997"></a><span class='hs-comment'>-- Arrow-notation context</span>
<a name="line-998"></a><span class='hs-comment'>---------------------------</span>
<a name="line-999"></a>
<a name="line-1000"></a><span class='hs-comment'>{- Note [Escaping the arrow scope]
<a name="line-1001"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1002"></a>In arrow notation, a variable bound by a proc (or enclosed let/kappa)
<a name="line-1003"></a>is not in scope to the left of an arrow tail (-&lt;) or the head of (|..|).
<a name="line-1004"></a>For example
<a name="line-1005"></a>
<a name="line-1006"></a>        proc x -&gt; (e1 -&lt; e2)
<a name="line-1007"></a>
<a name="line-1008"></a>Here, x is not in scope in e1, but it is in scope in e2.  This can get
<a name="line-1009"></a>a bit complicated:
<a name="line-1010"></a>
<a name="line-1011"></a>        let x = 3 in
<a name="line-1012"></a>        proc y -&gt; (proc z -&gt; e1) -&lt; e2
<a name="line-1013"></a>
<a name="line-1014"></a>Here, x and z are in scope in e1, but y is not.
<a name="line-1015"></a>
<a name="line-1016"></a>We implement this by
<a name="line-1017"></a>recording the environment when passing a proc (using newArrowScope),
<a name="line-1018"></a>and returning to that (using escapeArrowScope) on the left of -&lt; and the
<a name="line-1019"></a>head of (|..|).
<a name="line-1020"></a>
<a name="line-1021"></a>All this can be dealt with by the *renamer*. But the type checker needs
<a name="line-1022"></a>to be involved too.  Example (arrowfail001)
<a name="line-1023"></a>  class Foo a where foo :: a -&gt; ()
<a name="line-1024"></a>  data Bar = forall a. Foo a =&gt; Bar a
<a name="line-1025"></a>  get :: Bar -&gt; ()
<a name="line-1026"></a>  get = proc x -&gt; case x of Bar a -&gt; foo -&lt; a
<a name="line-1027"></a>Here the call of 'foo' gives rise to a (Foo a) constraint that should not
<a name="line-1028"></a>be captured by the pattern match on 'Bar'.  Rather it should join the
<a name="line-1029"></a>constraints from further out.  So we must capture the constraint bag
<a name="line-1030"></a>from further out in the ArrowCtxt that we push inwards.
<a name="line-1031"></a>-}</span>
<a name="line-1032"></a>
<a name="line-1033"></a><a name="ArrowCtxt"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ArrowCtxt</span>   <span class='hs-comment'>-- Note [Escaping the arrow scope]</span>
<a name="line-1034"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoArrowCtxt</span>
<a name="line-1035"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ArrowCtxt</span> <span class='hs-conid'>LocalRdrEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRef</span> <span class='hs-conid'>WantedConstraints</span><span class='hs-layout'>)</span>
<a name="line-1036"></a>
<a name="line-1037"></a>
<a name="line-1038"></a><span class='hs-comment'>---------------------------</span>
<a name="line-1039"></a><span class='hs-comment'>-- TcTyThing</span>
<a name="line-1040"></a><span class='hs-comment'>---------------------------</span>
<a name="line-1041"></a>
<a name="line-1042"></a><a name="TcTyThing"></a><span class='hs-comment'>-- | A typecheckable thing available in a local context.  Could be</span>
<a name="line-1043"></a><a name="TcTyThing"></a><span class='hs-comment'>-- 'AGlobal' 'TyThing', but also lexically scoped variables, etc.</span>
<a name="line-1044"></a><a name="TcTyThing"></a><span class='hs-comment'>-- See "GHC.Tc.Utils.Env" for how to retrieve a 'TyThing' given a 'Name'.</span>
<a name="line-1045"></a><a name="TcTyThing"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcTyThing</span>
<a name="line-1046"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AGlobal</span> <span class='hs-conid'>TyThing</span>             <span class='hs-comment'>-- Used only in the return type of a lookup</span>
<a name="line-1047"></a>
<a name="line-1048"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ATcId</span>           <span class='hs-comment'>-- Ids defined in this module; may not be fully zonked</span>
<a name="line-1049"></a>      <span class='hs-layout'>{</span> <span class='hs-varid'>tct_id</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcId</span>
<a name="line-1050"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>tct_info</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IdBindingInfo</span>   <span class='hs-comment'>-- See Note [Meaning of IdBindingInfo]</span>
<a name="line-1051"></a>      <span class='hs-layout'>}</span>
<a name="line-1052"></a>
<a name="line-1053"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ATyVar</span>  <span class='hs-conid'>Name</span> <span class='hs-conid'>TcTyVar</span>   <span class='hs-comment'>-- See Note [Type variables in the type environment]</span>
<a name="line-1054"></a>
<a name="line-1055"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ATcTyCon</span> <span class='hs-conid'>TyCon</span>   <span class='hs-comment'>-- Used temporarily, during kind checking, for the</span>
<a name="line-1056"></a>                     <span class='hs-comment'>-- tycons and clases in this recursive group</span>
<a name="line-1057"></a>                     <span class='hs-comment'>-- The TyCon is always a TcTyCon.  Its kind</span>
<a name="line-1058"></a>                     <span class='hs-comment'>-- can be a mono-kind or a poly-kind; in TcTyClsDcls see</span>
<a name="line-1059"></a>                     <span class='hs-comment'>-- Note [Type checking recursive type and class declarations]</span>
<a name="line-1060"></a>
<a name="line-1061"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>APromotionErr</span> <span class='hs-conid'>PromotionErr</span>
<a name="line-1062"></a>
<a name="line-1063"></a><a name="PromotionErr"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PromotionErr</span>
<a name="line-1064"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConPE</span>          <span class='hs-comment'>-- TyCon used in a kind before we are ready</span>
<a name="line-1065"></a>                     <span class='hs-comment'>--     data T :: T -&gt; * where ...</span>
<a name="line-1066"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ClassPE</span>          <span class='hs-comment'>-- Ditto Class</span>
<a name="line-1067"></a>
<a name="line-1068"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FamDataConPE</span>     <span class='hs-comment'>-- Data constructor for a data family</span>
<a name="line-1069"></a>                     <span class='hs-comment'>-- See Note [AFamDataCon: not promoting data family constructors]</span>
<a name="line-1070"></a>                     <span class='hs-comment'>-- in GHC.Tc.Utils.Env.</span>
<a name="line-1071"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ConstrainedDataConPE</span> <span class='hs-conid'>PredType</span>
<a name="line-1072"></a>                     <span class='hs-comment'>-- Data constructor with a non-equality context</span>
<a name="line-1073"></a>                     <span class='hs-comment'>-- See Note [Don't promote data constructors with</span>
<a name="line-1074"></a>                     <span class='hs-comment'>--           non-equality contexts] in GHC.Tc.Gen.HsType</span>
<a name="line-1075"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PatSynPE</span>         <span class='hs-comment'>-- Pattern synonyms</span>
<a name="line-1076"></a>                     <span class='hs-comment'>-- See Note [Don't promote pattern synonyms] in GHC.Tc.Utils.Env</span>
<a name="line-1077"></a>
<a name="line-1078"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RecDataConPE</span>     <span class='hs-comment'>-- Data constructor in a recursive loop</span>
<a name="line-1079"></a>                     <span class='hs-comment'>-- See Note [Recursion and promoting data constructors] in GHC.Tc.TyCl</span>
<a name="line-1080"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NoDataKindsTC</span>    <span class='hs-comment'>-- -XDataKinds not enabled (for a tycon)</span>
<a name="line-1081"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NoDataKindsDC</span>    <span class='hs-comment'>-- -XDataKinds not enabled (for a datacon)</span>
<a name="line-1082"></a>
<a name="line-1083"></a><a name="instance%20Outputable%20TcTyThing"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcTyThing</span> <span class='hs-keyword'>where</span>     <span class='hs-comment'>-- Debugging only</span>
<a name="line-1084"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>g</span>
<a name="line-1085"></a>   <span class='hs-varid'>ppr</span> <span class='hs-varid'>elt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ATcId</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Identifier"</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-1086"></a>                          <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tct_id</span> <span class='hs-varid'>elt</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>dcolon</span>
<a name="line-1087"></a>                                 <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tct_id</span> <span class='hs-varid'>elt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span>
<a name="line-1088"></a>                                 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tct_info</span> <span class='hs-varid'>elt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1089"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Type variable"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>equals</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span>
<a name="line-1090"></a>                            <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-1091"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATcTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ATcTyCon"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1092"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>APromotionErr</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"APromotionErr"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>err</span>
<a name="line-1093"></a>
<a name="line-1094"></a><a name="IdBindingInfo"></a><span class='hs-comment'>-- | IdBindingInfo describes how an Id is bound.</span>
<a name="line-1095"></a><a name="IdBindingInfo"></a><span class='hs-comment'>--</span>
<a name="line-1096"></a><a name="IdBindingInfo"></a><span class='hs-comment'>-- It is used for the following purposes:</span>
<a name="line-1097"></a><a name="IdBindingInfo"></a><span class='hs-comment'>-- a) for static forms in 'GHC.Tc.Gen.Expr.checkClosedInStaticForm' and</span>
<a name="line-1098"></a><a name="IdBindingInfo"></a><span class='hs-comment'>-- b) to figure out when a nested binding can be generalised,</span>
<a name="line-1099"></a><a name="IdBindingInfo"></a><span class='hs-comment'>--    in 'GHC.Tc.Gen.Bind.decideGeneralisationPlan'.</span>
<a name="line-1100"></a><a name="IdBindingInfo"></a><span class='hs-comment'>--</span>
<a name="line-1101"></a><a name="IdBindingInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>IdBindingInfo</span> <span class='hs-comment'>-- See Note [Meaning of IdBindingInfo and ClosedTypeId]</span>
<a name="line-1102"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NotLetBound</span>
<a name="line-1103"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ClosedLet</span>
<a name="line-1104"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NonClosedLet</span>
<a name="line-1105"></a>         <span class='hs-conid'>RhsNames</span>        <span class='hs-comment'>-- Used for (static e) checks only</span>
<a name="line-1106"></a>         <span class='hs-conid'>ClosedTypeId</span>    <span class='hs-comment'>-- Used for generalisation checks</span>
<a name="line-1107"></a>                         <span class='hs-comment'>-- and for (static e) checks</span>
<a name="line-1108"></a>
<a name="line-1109"></a><a name="IsGroupClosed"></a><span class='hs-comment'>-- | IsGroupClosed describes a group of mutually-recursive bindings</span>
<a name="line-1110"></a><a name="IsGroupClosed"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>IsGroupClosed</span>
<a name="line-1111"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IsGroupClosed</span>
<a name="line-1112"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>NameEnv</span> <span class='hs-conid'>RhsNames</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Free var info for the RHS of each binding in the goup</span>
<a name="line-1113"></a>                          <span class='hs-comment'>-- Used only for (static e) checks</span>
<a name="line-1114"></a>
<a name="line-1115"></a>      <span class='hs-conid'>ClosedTypeId</span>        <span class='hs-comment'>-- True &lt;=&gt; all the free vars of the group are</span>
<a name="line-1116"></a>                          <span class='hs-comment'>--          imported or ClosedLet or</span>
<a name="line-1117"></a>                          <span class='hs-comment'>--          NonClosedLet with ClosedTypeId=True.</span>
<a name="line-1118"></a>                          <span class='hs-comment'>--          In particular, no tyvars, no NotLetBound</span>
<a name="line-1119"></a>
<a name="line-1120"></a><a name="RhsNames"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>RhsNames</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameSet</span>   <span class='hs-comment'>-- Names of variables, mentioned on the RHS of</span>
<a name="line-1121"></a>                          <span class='hs-comment'>-- a definition, that are not Global or ClosedLet</span>
<a name="line-1122"></a>
<a name="line-1123"></a><a name="ClosedTypeId"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ClosedTypeId</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bool</span>
<a name="line-1124"></a>  <span class='hs-comment'>-- See Note [Meaning of IdBindingInfo and ClosedTypeId]</span>
<a name="line-1125"></a>
<a name="line-1126"></a><span class='hs-comment'>{- Note [Meaning of IdBindingInfo]
<a name="line-1127"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1128"></a>NotLetBound means that
<a name="line-1129"></a>  the Id is not let-bound (e.g. it is bound in a
<a name="line-1130"></a>  lambda-abstraction or in a case pattern)
<a name="line-1131"></a>
<a name="line-1132"></a>ClosedLet means that
<a name="line-1133"></a>   - The Id is let-bound,
<a name="line-1134"></a>   - Any free term variables are also Global or ClosedLet
<a name="line-1135"></a>   - Its type has no free variables (NB: a top-level binding subject
<a name="line-1136"></a>     to the MR might have free vars in its type)
<a name="line-1137"></a>   These ClosedLets can definitely be floated to top level; and we
<a name="line-1138"></a>   may need to do so for static forms.
<a name="line-1139"></a>
<a name="line-1140"></a>   Property:   ClosedLet
<a name="line-1141"></a>             is equivalent to
<a name="line-1142"></a>               NonClosedLet emptyNameSet True
<a name="line-1143"></a>
<a name="line-1144"></a>(NonClosedLet (fvs::RhsNames) (cl::ClosedTypeId)) means that
<a name="line-1145"></a>   - The Id is let-bound
<a name="line-1146"></a>
<a name="line-1147"></a>   - The fvs::RhsNames contains the free names of the RHS,
<a name="line-1148"></a>     excluding Global and ClosedLet ones.
<a name="line-1149"></a>
<a name="line-1150"></a>   - For the ClosedTypeId field see Note [Bindings with closed types]
<a name="line-1151"></a>
<a name="line-1152"></a>For (static e) to be valid, we need for every 'x' free in 'e',
<a name="line-1153"></a>that x's binding is floatable to the top level.  Specifically:
<a name="line-1154"></a>   * x's RhsNames must be empty
<a name="line-1155"></a>   * x's type has no free variables
<a name="line-1156"></a>See Note [Grand plan for static forms] in "GHC.Iface.Tidy.StaticPtrTable".
<a name="line-1157"></a>This test is made in GHC.Tc.Gen.Expr.checkClosedInStaticForm.
<a name="line-1158"></a>Actually knowing x's RhsNames (rather than just its emptiness
<a name="line-1159"></a>or otherwise) is just so we can produce better error messages
<a name="line-1160"></a>
<a name="line-1161"></a>Note [Bindings with closed types: ClosedTypeId]
<a name="line-1162"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1163"></a>Consider
<a name="line-1164"></a>
<a name="line-1165"></a>  f x = let g ys = map not ys
<a name="line-1166"></a>        in ...
<a name="line-1167"></a>
<a name="line-1168"></a>Can we generalise 'g' under the OutsideIn algorithm?  Yes,
<a name="line-1169"></a>because all g's free variables are top-level; that is they themselves
<a name="line-1170"></a>have no free type variables, and it is the type variables in the
<a name="line-1171"></a>environment that makes things tricky for OutsideIn generalisation.
<a name="line-1172"></a>
<a name="line-1173"></a>Here's the invariant:
<a name="line-1174"></a>   If an Id has ClosedTypeId=True (in its IdBindingInfo), then
<a name="line-1175"></a>   the Id's type is /definitely/ closed (has no free type variables).
<a name="line-1176"></a>   Specifically,
<a name="line-1177"></a>       a) The Id's actual type is closed (has no free tyvars)
<a name="line-1178"></a>       b) Either the Id has a (closed) user-supplied type signature
<a name="line-1179"></a>          or all its free variables are Global/ClosedLet
<a name="line-1180"></a>             or NonClosedLet with ClosedTypeId=True.
<a name="line-1181"></a>          In particular, none are NotLetBound.
<a name="line-1182"></a>
<a name="line-1183"></a>Why is (b) needed?   Consider
<a name="line-1184"></a>    \x. (x :: Int, let y = x+1 in ...)
<a name="line-1185"></a>Initially x::alpha.  If we happen to typecheck the 'let' before the
<a name="line-1186"></a>(x::Int), y's type will have a free tyvar; but if the other way round
<a name="line-1187"></a>it won't.  So we treat any let-bound variable with a free
<a name="line-1188"></a>non-let-bound variable as not ClosedTypeId, regardless of what the
<a name="line-1189"></a>free vars of its type actually are.
<a name="line-1190"></a>
<a name="line-1191"></a>But if it has a signature, all is well:
<a name="line-1192"></a>   \x. ...(let { y::Int; y = x+1 } in
<a name="line-1193"></a>           let { v = y+2 } in ...)...
<a name="line-1194"></a>Here the signature on 'v' makes 'y' a ClosedTypeId, so we can
<a name="line-1195"></a>generalise 'v'.
<a name="line-1196"></a>
<a name="line-1197"></a>Note that:
<a name="line-1198"></a>
<a name="line-1199"></a>  * A top-level binding may not have ClosedTypeId=True, if it suffers
<a name="line-1200"></a>    from the MR
<a name="line-1201"></a>
<a name="line-1202"></a>  * A nested binding may be closed (eg 'g' in the example we started
<a name="line-1203"></a>    with). Indeed, that's the point; whether a function is defined at
<a name="line-1204"></a>    top level or nested is orthogonal to the question of whether or
<a name="line-1205"></a>    not it is closed.
<a name="line-1206"></a>
<a name="line-1207"></a>  * A binding may be non-closed because it mentions a lexically scoped
<a name="line-1208"></a>    *type variable*  Eg
<a name="line-1209"></a>        f :: forall a. blah
<a name="line-1210"></a>        f x = let g y = ...(y::a)...
<a name="line-1211"></a>
<a name="line-1212"></a>Under OutsideIn we are free to generalise an Id all of whose free
<a name="line-1213"></a>variables have ClosedTypeId=True (or imported).  This is an extension
<a name="line-1214"></a>compared to the JFP paper on OutsideIn, which used "top-level" as a
<a name="line-1215"></a>proxy for "closed".  (It's not a good proxy anyway -- the MR can make
<a name="line-1216"></a>a top-level binding with a free type variable.)
<a name="line-1217"></a>
<a name="line-1218"></a>Note [Type variables in the type environment]
<a name="line-1219"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1220"></a>The type environment has a binding for each lexically-scoped
<a name="line-1221"></a>type variable that is in scope.  For example
<a name="line-1222"></a>
<a name="line-1223"></a>  f :: forall a. a -&gt; a
<a name="line-1224"></a>  f x = (x :: a)
<a name="line-1225"></a>
<a name="line-1226"></a>  g1 :: [a] -&gt; a
<a name="line-1227"></a>  g1 (ys :: [b]) = head ys :: b
<a name="line-1228"></a>
<a name="line-1229"></a>  g2 :: [Int] -&gt; Int
<a name="line-1230"></a>  g2 (ys :: [c]) = head ys :: c
<a name="line-1231"></a>
<a name="line-1232"></a>* The forall'd variable 'a' in the signature scopes over f's RHS.
<a name="line-1233"></a>
<a name="line-1234"></a>* The pattern-bound type variable 'b' in 'g1' scopes over g1's
<a name="line-1235"></a>  RHS; note that it is bound to a skolem 'a' which is not itself
<a name="line-1236"></a>  lexically in scope.
<a name="line-1237"></a>
<a name="line-1238"></a>* The pattern-bound type variable 'c' in 'g2' is bound to
<a name="line-1239"></a>  Int; that is, pattern-bound type variables can stand for
<a name="line-1240"></a>  arbitrary types. (see
<a name="line-1241"></a>    GHC proposal #128 "Allow ScopedTypeVariables to refer to types"
<a name="line-1242"></a>    https://github.com/ghc-proposals/ghc-proposals/pull/128,
<a name="line-1243"></a>  and the paper
<a name="line-1244"></a>    "Type variables in patterns", Haskell Symposium 2018.
<a name="line-1245"></a>
<a name="line-1246"></a>
<a name="line-1247"></a>This is implemented by the constructor
<a name="line-1248"></a>   ATyVar Name TcTyVar
<a name="line-1249"></a>in the type environment.
<a name="line-1250"></a>
<a name="line-1251"></a>* The Name is the name of the original, lexically scoped type
<a name="line-1252"></a>  variable
<a name="line-1253"></a>
<a name="line-1254"></a>* The TcTyVar is sometimes a skolem (like in 'f'), and sometimes
<a name="line-1255"></a>  a unification variable (like in 'g1', 'g2').  We never zonk the
<a name="line-1256"></a>  type environment so in the latter case it always stays as a
<a name="line-1257"></a>  unification variable, although that variable may be later
<a name="line-1258"></a>  unified with a type (such as Int in 'g2').
<a name="line-1259"></a>-}</span>
<a name="line-1260"></a>
<a name="line-1261"></a><a name="instance%20Outputable%20IdBindingInfo"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>IdBindingInfo</span> <span class='hs-keyword'>where</span>
<a name="line-1262"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>NotLetBound</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"NotLetBound"</span>
<a name="line-1263"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>ClosedLet</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TopLevelLet"</span>
<a name="line-1264"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonClosedLet</span> <span class='hs-varid'>fvs</span> <span class='hs-varid'>closed_type</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1265"></a>    <span class='hs-varid'>text</span> <span class='hs-str'>"TopLevelLet"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fvs</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>closed_type</span>
<a name="line-1266"></a>
<a name="line-1267"></a><a name="instance%20Outputable%20PromotionErr"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>PromotionErr</span> <span class='hs-keyword'>where</span>
<a name="line-1268"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>ClassPE</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ClassPE"</span>
<a name="line-1269"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>TyConPE</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TyConPE"</span>
<a name="line-1270"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>PatSynPE</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"PatSynPE"</span>
<a name="line-1271"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>FamDataConPE</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"FamDataConPE"</span>
<a name="line-1272"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConstrainedDataConPE</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ConstrainedDataConPE"</span>
<a name="line-1273"></a>                                      <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-1274"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>RecDataConPE</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"RecDataConPE"</span>
<a name="line-1275"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>NoDataKindsTC</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"NoDataKindsTC"</span>
<a name="line-1276"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>NoDataKindsDC</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"NoDataKindsDC"</span>
<a name="line-1277"></a>
<a name="line-1278"></a><a name="pprTcTyThingCategory"></a><span class='hs-comment'>--------------</span>
<a name="line-1279"></a><span class='hs-definition'>pprTcTyThingCategory</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1280"></a><span class='hs-definition'>pprTcTyThingCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-varop'>.</span> <span class='hs-varid'>capitalise</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcTyThingCategory</span>
<a name="line-1281"></a>
<a name="line-1282"></a><a name="tcTyThingCategory"></a><span class='hs-definition'>tcTyThingCategory</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-1283"></a><span class='hs-definition'>tcTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyThingCategory</span> <span class='hs-varid'>thing</span>
<a name="line-1284"></a><span class='hs-definition'>tcTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyVar</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-str'>"type variable"</span>
<a name="line-1285"></a><span class='hs-definition'>tcTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATcId</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-str'>"local identifier"</span>
<a name="line-1286"></a><span class='hs-definition'>tcTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATcTyCon</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-str'>"local tycon"</span>
<a name="line-1287"></a><span class='hs-definition'>tcTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>APromotionErr</span> <span class='hs-varid'>pe</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>peCategory</span> <span class='hs-varid'>pe</span>
<a name="line-1288"></a>
<a name="line-1289"></a><a name="pprPECategory"></a><span class='hs-comment'>--------------</span>
<a name="line-1290"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PromotionErr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1291"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-varop'>.</span> <span class='hs-varid'>capitalise</span> <span class='hs-varop'>.</span> <span class='hs-varid'>peCategory</span>
<a name="line-1292"></a>
<a name="line-1293"></a><a name="peCategory"></a><span class='hs-definition'>peCategory</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PromotionErr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-1294"></a><span class='hs-definition'>peCategory</span> <span class='hs-conid'>ClassPE</span>                <span class='hs-keyglyph'>=</span> <span class='hs-str'>"class"</span>
<a name="line-1295"></a><span class='hs-definition'>peCategory</span> <span class='hs-conid'>TyConPE</span>                <span class='hs-keyglyph'>=</span> <span class='hs-str'>"type constructor"</span>
<a name="line-1296"></a><span class='hs-definition'>peCategory</span> <span class='hs-conid'>PatSynPE</span>               <span class='hs-keyglyph'>=</span> <span class='hs-str'>"pattern synonym"</span>
<a name="line-1297"></a><span class='hs-definition'>peCategory</span> <span class='hs-conid'>FamDataConPE</span>           <span class='hs-keyglyph'>=</span> <span class='hs-str'>"data constructor"</span>
<a name="line-1298"></a><span class='hs-definition'>peCategory</span> <span class='hs-conid'>ConstrainedDataConPE</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"data constructor"</span>
<a name="line-1299"></a><span class='hs-definition'>peCategory</span> <span class='hs-conid'>RecDataConPE</span>           <span class='hs-keyglyph'>=</span> <span class='hs-str'>"data constructor"</span>
<a name="line-1300"></a><span class='hs-definition'>peCategory</span> <span class='hs-conid'>NoDataKindsTC</span>          <span class='hs-keyglyph'>=</span> <span class='hs-str'>"type constructor"</span>
<a name="line-1301"></a><span class='hs-definition'>peCategory</span> <span class='hs-conid'>NoDataKindsDC</span>          <span class='hs-keyglyph'>=</span> <span class='hs-str'>"data constructor"</span>
<a name="line-1302"></a>
<a name="line-1303"></a><span class='hs-comment'>{-
<a name="line-1304"></a>************************************************************************
<a name="line-1305"></a>*                                                                      *
<a name="line-1306"></a>        Operations over ImportAvails
<a name="line-1307"></a>*                                                                      *
<a name="line-1308"></a>************************************************************************
<a name="line-1309"></a>-}</span>
<a name="line-1310"></a>
<a name="line-1311"></a><a name="ImportAvails"></a><span class='hs-comment'>-- | 'ImportAvails' summarises what was imported from where, irrespective of</span>
<a name="line-1312"></a><a name="ImportAvails"></a><span class='hs-comment'>-- whether the imported things are actually used or not.  It is used:</span>
<a name="line-1313"></a><a name="ImportAvails"></a><span class='hs-comment'>--</span>
<a name="line-1314"></a><a name="ImportAvails"></a><span class='hs-comment'>--  * when processing the export list,</span>
<a name="line-1315"></a><a name="ImportAvails"></a><span class='hs-comment'>--</span>
<a name="line-1316"></a><a name="ImportAvails"></a><span class='hs-comment'>--  * when constructing usage info for the interface file,</span>
<a name="line-1317"></a><a name="ImportAvails"></a><span class='hs-comment'>--</span>
<a name="line-1318"></a><a name="ImportAvails"></a><span class='hs-comment'>--  * to identify the list of directly imported modules for initialisation</span>
<a name="line-1319"></a><a name="ImportAvails"></a><span class='hs-comment'>--    purposes and for optimised overlap checking of family instances,</span>
<a name="line-1320"></a><a name="ImportAvails"></a><span class='hs-comment'>--</span>
<a name="line-1321"></a><a name="ImportAvails"></a><span class='hs-comment'>--  * when figuring out what things are really unused</span>
<a name="line-1322"></a><a name="ImportAvails"></a><span class='hs-comment'>--</span>
<a name="line-1323"></a><a name="ImportAvails"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ImportAvails</span>
<a name="line-1324"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImportAvails</span> <span class='hs-layout'>{</span>
<a name="line-1325"></a>        <span class='hs-varid'>imp_mods</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportedMods</span><span class='hs-layout'>,</span>
<a name="line-1326"></a>          <span class='hs-comment'>--      = ModuleEnv [ImportedModsVal],</span>
<a name="line-1327"></a>          <span class='hs-comment'>-- ^ Domain is all directly-imported modules</span>
<a name="line-1328"></a>          <span class='hs-comment'>--</span>
<a name="line-1329"></a>          <span class='hs-comment'>-- See the documentation on ImportedModsVal in</span>
<a name="line-1330"></a>          <span class='hs-comment'>-- "GHC.Unit.Module.Imported" for the meaning of the fields.</span>
<a name="line-1331"></a>          <span class='hs-comment'>--</span>
<a name="line-1332"></a>          <span class='hs-comment'>-- We need a full ModuleEnv rather than a ModuleNameEnv here,</span>
<a name="line-1333"></a>          <span class='hs-comment'>-- because we might be importing modules of the same name from</span>
<a name="line-1334"></a>          <span class='hs-comment'>-- different packages. (currently not the case, but might be in the</span>
<a name="line-1335"></a>          <span class='hs-comment'>-- future).</span>
<a name="line-1336"></a>
<a name="line-1337"></a>        <span class='hs-varid'>imp_dep_mods</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleNameEnv</span> <span class='hs-conid'>ModuleNameWithIsBoot</span><span class='hs-layout'>,</span>
<a name="line-1338"></a>          <span class='hs-comment'>-- ^ Home-package modules needed by the module being compiled</span>
<a name="line-1339"></a>          <span class='hs-comment'>--</span>
<a name="line-1340"></a>          <span class='hs-comment'>-- It doesn't matter whether any of these dependencies</span>
<a name="line-1341"></a>          <span class='hs-comment'>-- are actually /used/ when compiling the module; they</span>
<a name="line-1342"></a>          <span class='hs-comment'>-- are listed if they are below it at all.  For</span>
<a name="line-1343"></a>          <span class='hs-comment'>-- example, suppose M imports A which imports X.  Then</span>
<a name="line-1344"></a>          <span class='hs-comment'>-- compiling M might not need to consult X.hi, but X</span>
<a name="line-1345"></a>          <span class='hs-comment'>-- is still listed in M's dependencies.</span>
<a name="line-1346"></a>
<a name="line-1347"></a>        <span class='hs-varid'>imp_dep_pkgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Set</span> <span class='hs-conid'>UnitId</span><span class='hs-layout'>,</span>
<a name="line-1348"></a>          <span class='hs-comment'>-- ^ Packages needed by the module being compiled, whether directly,</span>
<a name="line-1349"></a>          <span class='hs-comment'>-- or via other modules in this package, or via modules imported</span>
<a name="line-1350"></a>          <span class='hs-comment'>-- from other packages.</span>
<a name="line-1351"></a>
<a name="line-1352"></a>        <span class='hs-varid'>imp_trust_pkgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Set</span> <span class='hs-conid'>UnitId</span><span class='hs-layout'>,</span>
<a name="line-1353"></a>          <span class='hs-comment'>-- ^ This is strictly a subset of imp_dep_pkgs and records the</span>
<a name="line-1354"></a>          <span class='hs-comment'>-- packages the current module needs to trust for Safe Haskell</span>
<a name="line-1355"></a>          <span class='hs-comment'>-- compilation to succeed. A package is required to be trusted if</span>
<a name="line-1356"></a>          <span class='hs-comment'>-- we are dependent on a trustworthy module in that package.</span>
<a name="line-1357"></a>          <span class='hs-comment'>-- While perhaps making imp_dep_pkgs a tuple of (UnitId, Bool)</span>
<a name="line-1358"></a>          <span class='hs-comment'>-- where True for the bool indicates the package is required to be</span>
<a name="line-1359"></a>          <span class='hs-comment'>-- trusted is the more logical  design, doing so complicates a lot</span>
<a name="line-1360"></a>          <span class='hs-comment'>-- of code not concerned with Safe Haskell.</span>
<a name="line-1361"></a>          <span class='hs-comment'>-- See Note [Tracking Trust Transitively] in "GHC.Rename.Names"</span>
<a name="line-1362"></a>
<a name="line-1363"></a>        <span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>
<a name="line-1364"></a>          <span class='hs-comment'>-- ^ Do we require that our own package is trusted?</span>
<a name="line-1365"></a>          <span class='hs-comment'>-- This is to handle efficiently the case where a Safe module imports</span>
<a name="line-1366"></a>          <span class='hs-comment'>-- a Trustworthy module that resides in the same package as it.</span>
<a name="line-1367"></a>          <span class='hs-comment'>-- See Note [Trust Own Package] in "GHC.Rename.Names"</span>
<a name="line-1368"></a>
<a name="line-1369"></a>        <span class='hs-varid'>imp_orphs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-1370"></a>          <span class='hs-comment'>-- ^ Orphan modules below us in the import tree (and maybe including</span>
<a name="line-1371"></a>          <span class='hs-comment'>-- us for imported modules)</span>
<a name="line-1372"></a>
<a name="line-1373"></a>        <span class='hs-varid'>imp_finsts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span><span class='hs-keyglyph'>]</span>
<a name="line-1374"></a>          <span class='hs-comment'>-- ^ Family instance modules below us in the import tree (and maybe</span>
<a name="line-1375"></a>          <span class='hs-comment'>-- including us for imported modules)</span>
<a name="line-1376"></a>      <span class='hs-layout'>}</span>
<a name="line-1377"></a>
<a name="line-1378"></a><a name="mkModDeps"></a><span class='hs-definition'>mkModDeps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleNameWithIsBoot</span><span class='hs-keyglyph'>]</span>
<a name="line-1379"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleNameEnv</span> <span class='hs-conid'>ModuleNameWithIsBoot</span>
<a name="line-1380"></a><span class='hs-definition'>mkModDeps</span> <span class='hs-varid'>deps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl'</span> <span class='hs-varid'>add</span> <span class='hs-varid'>emptyUFM</span> <span class='hs-varid'>deps</span>
<a name="line-1381"></a>  <span class='hs-keyword'>where</span>
<a name="line-1382"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>env</span> <span class='hs-varid'>elt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToUFM</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>gwib_mod</span> <span class='hs-varid'>elt</span><span class='hs-layout'>)</span> <span class='hs-varid'>elt</span>
<a name="line-1383"></a>
<a name="line-1384"></a><a name="modDepsElts"></a><span class='hs-definition'>modDepsElts</span>
<a name="line-1385"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleNameEnv</span> <span class='hs-conid'>ModuleNameWithIsBoot</span>
<a name="line-1386"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleNameWithIsBoot</span><span class='hs-keyglyph'>]</span>
<a name="line-1387"></a><span class='hs-definition'>modDepsElts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sort</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nonDetEltsUFM</span>
<a name="line-1388"></a>  <span class='hs-comment'>-- It's OK to use nonDetEltsUFM here because sorting by module names</span>
<a name="line-1389"></a>  <span class='hs-comment'>-- restores determinism</span>
<a name="line-1390"></a>
<a name="line-1391"></a><a name="emptyImportAvails"></a><span class='hs-definition'>emptyImportAvails</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportAvails</span>
<a name="line-1392"></a><span class='hs-definition'>emptyImportAvails</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImportAvails</span> <span class='hs-layout'>{</span> <span class='hs-varid'>imp_mods</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyModuleEnv</span><span class='hs-layout'>,</span>
<a name="line-1393"></a>                                   <span class='hs-varid'>imp_dep_mods</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUFM</span><span class='hs-layout'>,</span>
<a name="line-1394"></a>                                   <span class='hs-varid'>imp_dep_pkgs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>S.empty</span><span class='hs-layout'>,</span>
<a name="line-1395"></a>                                   <span class='hs-varid'>imp_trust_pkgs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>S.empty</span><span class='hs-layout'>,</span>
<a name="line-1396"></a>                                   <span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span>
<a name="line-1397"></a>                                   <span class='hs-varid'>imp_orphs</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-1398"></a>                                   <span class='hs-varid'>imp_finsts</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span>
<a name="line-1399"></a>
<a name="line-1400"></a><a name="plusImportAvails"></a><span class='hs-comment'>-- | Union two ImportAvails</span>
<a name="line-1401"></a><span class='hs-comment'>--</span>
<a name="line-1402"></a><span class='hs-comment'>-- This function is a key part of Import handling, basically</span>
<a name="line-1403"></a><span class='hs-comment'>-- for each import we create a separate ImportAvails structure</span>
<a name="line-1404"></a><span class='hs-comment'>-- and then union them all together with this function.</span>
<a name="line-1405"></a><span class='hs-definition'>plusImportAvails</span> <span class='hs-keyglyph'>::</span>  <span class='hs-conid'>ImportAvails</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>ImportAvails</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>ImportAvails</span>
<a name="line-1406"></a><span class='hs-definition'>plusImportAvails</span>
<a name="line-1407"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>ImportAvails</span> <span class='hs-layout'>{</span> <span class='hs-varid'>imp_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mods1</span><span class='hs-layout'>,</span>
<a name="line-1408"></a>                  <span class='hs-varid'>imp_dep_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmods1</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_dep_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dpkgs1</span><span class='hs-layout'>,</span>
<a name="line-1409"></a>                  <span class='hs-varid'>imp_trust_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tpkgs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tself1</span><span class='hs-layout'>,</span>
<a name="line-1410"></a>                  <span class='hs-varid'>imp_orphs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_finsts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>finsts1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1411"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>ImportAvails</span> <span class='hs-layout'>{</span> <span class='hs-varid'>imp_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mods2</span><span class='hs-layout'>,</span>
<a name="line-1412"></a>                  <span class='hs-varid'>imp_dep_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmods2</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_dep_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dpkgs2</span><span class='hs-layout'>,</span>
<a name="line-1413"></a>                  <span class='hs-varid'>imp_trust_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tpkgs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tself2</span><span class='hs-layout'>,</span>
<a name="line-1414"></a>                  <span class='hs-varid'>imp_orphs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_finsts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>finsts2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1415"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImportAvails</span> <span class='hs-layout'>{</span> <span class='hs-varid'>imp_mods</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusModuleEnv_C</span> <span class='hs-layout'>(</span><span class='hs-varop'>++</span><span class='hs-layout'>)</span> <span class='hs-varid'>mods1</span> <span class='hs-varid'>mods2</span><span class='hs-layout'>,</span>
<a name="line-1416"></a>                   <span class='hs-varid'>imp_dep_mods</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusUFM_C</span> <span class='hs-varid'>plus_mod_dep</span> <span class='hs-varid'>dmods1</span> <span class='hs-varid'>dmods2</span><span class='hs-layout'>,</span>
<a name="line-1417"></a>                   <span class='hs-varid'>imp_dep_pkgs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dpkgs1</span> <span class='hs-varop'>`S.union`</span> <span class='hs-varid'>dpkgs2</span><span class='hs-layout'>,</span>
<a name="line-1418"></a>                   <span class='hs-varid'>imp_trust_pkgs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tpkgs1</span> <span class='hs-varop'>`S.union`</span> <span class='hs-varid'>tpkgs2</span><span class='hs-layout'>,</span>
<a name="line-1419"></a>                   <span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tself1</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tself2</span><span class='hs-layout'>,</span>
<a name="line-1420"></a>                   <span class='hs-varid'>imp_orphs</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphs1</span> <span class='hs-varop'>`unionLists`</span> <span class='hs-varid'>orphs2</span><span class='hs-layout'>,</span>
<a name="line-1421"></a>                   <span class='hs-varid'>imp_finsts</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>finsts1</span> <span class='hs-varop'>`unionLists`</span> <span class='hs-varid'>finsts2</span> <span class='hs-layout'>}</span>
<a name="line-1422"></a>  <span class='hs-keyword'>where</span>
<a name="line-1423"></a>    <span class='hs-varid'>plus_mod_dep</span> <span class='hs-varid'>r1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>GWIB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gwib_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m1</span><span class='hs-layout'>,</span> <span class='hs-varid'>gwib_isBoot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boot1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1424"></a>                 <span class='hs-varid'>r2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>GWIB</span> <span class='hs-layout'>{</span><span class='hs-varid'>gwib_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m2</span><span class='hs-layout'>,</span> <span class='hs-varid'>gwib_isBoot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boot2</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1425"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>m1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>m2</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>m1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>m2</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>boot1</span> <span class='hs-varop'>==</span> <span class='hs-conid'>IsBoot</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>boot2</span> <span class='hs-varop'>==</span> <span class='hs-conid'>IsBoot</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1426"></a>        <span class='hs-varid'>boot1</span> <span class='hs-varop'>==</span> <span class='hs-conid'>IsBoot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r2</span>
<a name="line-1427"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r1</span>
<a name="line-1428"></a>      <span class='hs-comment'>-- If either side can "see" a non-hi-boot interface, use that</span>
<a name="line-1429"></a>      <span class='hs-comment'>-- Reusing existing tuples saves 10% of allocations on test</span>
<a name="line-1430"></a>      <span class='hs-comment'>-- perf/compiler/MultiLayerModules</span>
<a name="line-1431"></a>
<a name="line-1432"></a><span class='hs-comment'>{-
<a name="line-1433"></a>************************************************************************
<a name="line-1434"></a>*                                                                      *
<a name="line-1435"></a>\subsection{Where from}
<a name="line-1436"></a>*                                                                      *
<a name="line-1437"></a>************************************************************************
<a name="line-1438"></a>
<a name="line-1439"></a>The @WhereFrom@ type controls where the renamer looks for an interface file
<a name="line-1440"></a>-}</span>
<a name="line-1441"></a>
<a name="line-1442"></a><a name="WhereFrom"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>WhereFrom</span>
<a name="line-1443"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImportByUser</span> <span class='hs-conid'>IsBootInterface</span>        <span class='hs-comment'>-- Ordinary user import (perhaps {-# SOURCE #-})</span>
<a name="line-1444"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ImportBySystem</span>                      <span class='hs-comment'>-- Non user import.</span>
<a name="line-1445"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ImportByPlugin</span>                      <span class='hs-comment'>-- Importing a plugin;</span>
<a name="line-1446"></a>                                        <span class='hs-comment'>-- See Note [Care with plugin imports] in GHC.Iface.Load</span>
<a name="line-1447"></a>
<a name="line-1448"></a><a name="instance%20Outputable%20WhereFrom"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>WhereFrom</span> <span class='hs-keyword'>where</span>
<a name="line-1449"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImportByUser</span> <span class='hs-conid'>IsBoot</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"{- SOURCE -}"</span>
<a name="line-1450"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImportByUser</span> <span class='hs-conid'>NotBoot</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-1451"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>ImportBySystem</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"{- SYSTEM -}"</span>
<a name="line-1452"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>ImportByPlugin</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"{- PLUGIN -}"</span>
<a name="line-1453"></a>
<a name="line-1454"></a>
<a name="line-1455"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1456"></a>*                                                                      *
<a name="line-1457"></a>                Type signatures
<a name="line-1458"></a>*                                                                      *
<a name="line-1459"></a>********************************************************************* -}</span>
<a name="line-1460"></a>
<a name="line-1461"></a><span class='hs-comment'>-- These data types need to be here only because</span>
<a name="line-1462"></a><span class='hs-comment'>-- GHC.Tc.Solver uses them, and GHC.Tc.Solver is fairly</span>
<a name="line-1463"></a><span class='hs-comment'>-- low down in the module hierarchy</span>
<a name="line-1464"></a>
<a name="line-1465"></a><a name="TcSigFun"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcSigFun</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcSigInfo</span>
<a name="line-1466"></a>
<a name="line-1467"></a><a name="TcSigInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcSigInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcIdSig</span>     <span class='hs-conid'>TcIdSigInfo</span>
<a name="line-1468"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcPatSynSig</span> <span class='hs-conid'>TcPatSynInfo</span>
<a name="line-1469"></a>
<a name="line-1470"></a><a name="TcIdSigInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcIdSigInfo</span>   <span class='hs-comment'>-- See Note [Complete and partial type signatures]</span>
<a name="line-1471"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CompleteSig</span>    <span class='hs-comment'>-- A complete signature with no wildcards,</span>
<a name="line-1472"></a>                   <span class='hs-comment'>-- so the complete polymorphic type is known.</span>
<a name="line-1473"></a>      <span class='hs-layout'>{</span> <span class='hs-varid'>sig_bndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcId</span>          <span class='hs-comment'>-- The polymorphic Id with that type</span>
<a name="line-1474"></a>
<a name="line-1475"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_ctxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span>  <span class='hs-comment'>-- In the case of type-class default methods,</span>
<a name="line-1476"></a>                                  <span class='hs-comment'>-- the Name in the FunSigCtxt is not the same</span>
<a name="line-1477"></a>                                  <span class='hs-comment'>-- as the TcId; the former is 'op', while the</span>
<a name="line-1478"></a>                                  <span class='hs-comment'>-- latter is '$dmop' or some such</span>
<a name="line-1479"></a>
<a name="line-1480"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_loc</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span>       <span class='hs-comment'>-- Location of the type signature</span>
<a name="line-1481"></a>      <span class='hs-layout'>}</span>
<a name="line-1482"></a>
<a name="line-1483"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PartialSig</span>     <span class='hs-comment'>-- A partial type signature (i.e. includes one or more</span>
<a name="line-1484"></a>                   <span class='hs-comment'>-- wildcards). In this case it doesn't make sense to give</span>
<a name="line-1485"></a>                   <span class='hs-comment'>-- the polymorphic Id, because we are going to /infer/ its</span>
<a name="line-1486"></a>                   <span class='hs-comment'>-- type, so we can't make the polymorphic Id ab-initio</span>
<a name="line-1487"></a>      <span class='hs-layout'>{</span> <span class='hs-varid'>psig_name</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>   <span class='hs-comment'>-- Name of the function; used when report wildcards</span>
<a name="line-1488"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>psig_hs_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsSigWcType</span> <span class='hs-conid'>GhcRn</span>  <span class='hs-comment'>-- The original partial signature in</span>
<a name="line-1489"></a>                                          <span class='hs-comment'>-- HsSyn form</span>
<a name="line-1490"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_ctxt</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-1491"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_loc</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span>            <span class='hs-comment'>-- Location of the type signature</span>
<a name="line-1492"></a>      <span class='hs-layout'>}</span>
<a name="line-1493"></a>
<a name="line-1494"></a>
<a name="line-1495"></a><span class='hs-comment'>{- Note [Complete and partial type signatures]
<a name="line-1496"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1497"></a>A type signature is partial when it contains one or more wildcards
<a name="line-1498"></a>(= type holes).  The wildcard can either be:
<a name="line-1499"></a>* A (type) wildcard occurring in sig_theta or sig_tau. These are
<a name="line-1500"></a>  stored in sig_wcs.
<a name="line-1501"></a>      f :: Bool -&gt; _
<a name="line-1502"></a>      g :: Eq _a =&gt; _a -&gt; _a -&gt; Bool
<a name="line-1503"></a>* Or an extra-constraints wildcard, stored in sig_cts:
<a name="line-1504"></a>      h :: (Num a, _) =&gt; a -&gt; a
<a name="line-1505"></a>
<a name="line-1506"></a>A type signature is a complete type signature when there are no
<a name="line-1507"></a>wildcards in the type signature, i.e. iff sig_wcs is empty and
<a name="line-1508"></a>sig_extra_cts is Nothing.
<a name="line-1509"></a>-}</span>
<a name="line-1510"></a>
<a name="line-1511"></a><a name="TcIdSigInst"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcIdSigInst</span>
<a name="line-1512"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TISI</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_inst_sig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcIdSigInfo</span>
<a name="line-1513"></a>
<a name="line-1514"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_skols</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>InvisTVBinder</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1515"></a>               <span class='hs-comment'>-- Instantiated type and kind variables, TyVarTvs</span>
<a name="line-1516"></a>               <span class='hs-comment'>-- The Name is the Name that the renamer chose;</span>
<a name="line-1517"></a>               <span class='hs-comment'>--   but the TcTyVar may come from instantiating</span>
<a name="line-1518"></a>               <span class='hs-comment'>--   the type and hence have a different unique.</span>
<a name="line-1519"></a>               <span class='hs-comment'>-- No need to keep track of whether they are truly lexically</span>
<a name="line-1520"></a>               <span class='hs-comment'>--   scoped because the renamer has named them uniquely</span>
<a name="line-1521"></a>               <span class='hs-comment'>-- See Note [Binding scoped type variables] in GHC.Tc.Gen.Sig</span>
<a name="line-1522"></a>               <span class='hs-comment'>--</span>
<a name="line-1523"></a>               <span class='hs-comment'>-- NB: The order of sig_inst_skols is irrelevant</span>
<a name="line-1524"></a>               <span class='hs-comment'>--     for a CompleteSig, but for a PartialSig see</span>
<a name="line-1525"></a>               <span class='hs-comment'>--     Note [Quantified variables in partial type signatures]</span>
<a name="line-1526"></a>
<a name="line-1527"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_theta</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcThetaType</span>
<a name="line-1528"></a>               <span class='hs-comment'>-- Instantiated theta.  In the case of a</span>
<a name="line-1529"></a>               <span class='hs-comment'>-- PartialSig, sig_theta does not include</span>
<a name="line-1530"></a>               <span class='hs-comment'>-- the extra-constraints wildcard</span>
<a name="line-1531"></a>
<a name="line-1532"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_tau</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSigmaType</span>   <span class='hs-comment'>-- Instantiated tau</span>
<a name="line-1533"></a>               <span class='hs-comment'>-- See Note [sig_inst_tau may be polymorphic]</span>
<a name="line-1534"></a>
<a name="line-1535"></a>         <span class='hs-comment'>-- Relevant for partial signature only</span>
<a name="line-1536"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_wcs</span>   <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1537"></a>               <span class='hs-comment'>-- Like sig_inst_skols, but for /named/ wildcards (_a etc).</span>
<a name="line-1538"></a>               <span class='hs-comment'>-- The named wildcards scope over the binding, and hence</span>
<a name="line-1539"></a>               <span class='hs-comment'>-- their Names may appear in type signatures in the binding</span>
<a name="line-1540"></a>
<a name="line-1541"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_wcx</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcType</span>
<a name="line-1542"></a>               <span class='hs-comment'>-- Extra-constraints wildcard to fill in, if any</span>
<a name="line-1543"></a>               <span class='hs-comment'>-- If this exists, it is surely of the form (meta_tv |&gt; co)</span>
<a name="line-1544"></a>               <span class='hs-comment'>-- (where the co might be reflexive). This is filled in</span>
<a name="line-1545"></a>               <span class='hs-comment'>-- only from the return value of GHC.Tc.Gen.HsType.tcAnonWildCardOcc</span>
<a name="line-1546"></a>         <span class='hs-layout'>}</span>
<a name="line-1547"></a>
<a name="line-1548"></a><span class='hs-comment'>{- Note [sig_inst_tau may be polymorphic]
<a name="line-1549"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1550"></a>Note that "sig_inst_tau" might actually be a polymorphic type,
<a name="line-1551"></a>if the original function had a signature like
<a name="line-1552"></a>   forall a. Eq a =&gt; forall b. Ord b =&gt; ....
<a name="line-1553"></a>But that's ok: tcMatchesFun (called by tcRhs) can deal with that
<a name="line-1554"></a>It happens, too!  See Note [Polymorphic methods] in GHC.Tc.TyCl.Class.
<a name="line-1555"></a>
<a name="line-1556"></a>Note [Quantified variables in partial type signatures]
<a name="line-1557"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1558"></a>Consider
<a name="line-1559"></a>   f :: forall a b. _ -&gt; a -&gt; _ -&gt; b
<a name="line-1560"></a>   f (x,y) p q = q
<a name="line-1561"></a>
<a name="line-1562"></a>Then we expect f's final type to be
<a name="line-1563"></a>  f :: forall {x,y}. forall a b. (x,y) -&gt; a -&gt; b -&gt; b
<a name="line-1564"></a>
<a name="line-1565"></a>Note that x,y are Inferred, and can't be use for visible type
<a name="line-1566"></a>application (VTA).  But a,b are Specified, and remain Specified
<a name="line-1567"></a>in the final type, so we can use VTA for them.  (Exception: if
<a name="line-1568"></a>it turns out that a's kind mentions b we need to reorder them
<a name="line-1569"></a>with scopedSort.)
<a name="line-1570"></a>
<a name="line-1571"></a>The sig_inst_skols of the TISI from a partial signature records
<a name="line-1572"></a>that original order, and is used to get the variables of f's
<a name="line-1573"></a>final type in the correct order.
<a name="line-1574"></a>
<a name="line-1575"></a>
<a name="line-1576"></a>Note [Wildcards in partial signatures]
<a name="line-1577"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1578"></a>The wildcards in psig_wcs may stand for a type mentioning
<a name="line-1579"></a>the universally-quantified tyvars of psig_ty
<a name="line-1580"></a>
<a name="line-1581"></a>E.g.  f :: forall a. _ -&gt; a
<a name="line-1582"></a>      f x = x
<a name="line-1583"></a>We get sig_inst_skols = [a]
<a name="line-1584"></a>       sig_inst_tau   = _22 -&gt; a
<a name="line-1585"></a>       sig_inst_wcs   = [_22]
<a name="line-1586"></a>and _22 in the end is unified with the type 'a'
<a name="line-1587"></a>
<a name="line-1588"></a>Moreover the kind of a wildcard in sig_inst_wcs may mention
<a name="line-1589"></a>the universally-quantified tyvars sig_inst_skols
<a name="line-1590"></a>e.g.   f :: t a -&gt; t _
<a name="line-1591"></a>Here we get
<a name="line-1592"></a>   sig_inst_skols = [k:*, (t::k -&gt;*), (a::k)]
<a name="line-1593"></a>   sig_inst_tau   = t a -&gt; t _22
<a name="line-1594"></a>   sig_inst_wcs   = [ _22::k ]
<a name="line-1595"></a>-}</span>
<a name="line-1596"></a>
<a name="line-1597"></a><a name="TcPatSynInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcPatSynInfo</span>
<a name="line-1598"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TPSI</span> <span class='hs-layout'>{</span>
<a name="line-1599"></a>        <span class='hs-varid'>patsig_name</span>           <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span>
<a name="line-1600"></a>        <span class='hs-varid'>patsig_implicit_bndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InvisTVBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Implicitly-bound kind vars (Inferred) and</span>
<a name="line-1601"></a>                                                  <span class='hs-comment'>-- implicitly-bound type vars (Specified)</span>
<a name="line-1602"></a>          <span class='hs-comment'>-- See Note [The pattern-synonym signature splitting rule] in GHC.Tc.TyCl.PatSyn</span>
<a name="line-1603"></a>        <span class='hs-varid'>patsig_univ_bndrs</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InvisTVBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Bound by explicit user forall</span>
<a name="line-1604"></a>        <span class='hs-varid'>patsig_req</span>            <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcThetaType</span><span class='hs-layout'>,</span>
<a name="line-1605"></a>        <span class='hs-varid'>patsig_ex_bndrs</span>       <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InvisTVBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Bound by explicit user forall</span>
<a name="line-1606"></a>        <span class='hs-varid'>patsig_prov</span>           <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcThetaType</span><span class='hs-layout'>,</span>
<a name="line-1607"></a>        <span class='hs-varid'>patsig_body_ty</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSigmaType</span>
<a name="line-1608"></a>    <span class='hs-layout'>}</span>
<a name="line-1609"></a>
<a name="line-1610"></a><a name="instance%20Outputable%20TcSigInfo"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcSigInfo</span> <span class='hs-keyword'>where</span>
<a name="line-1611"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcIdSig</span>     <span class='hs-varid'>idsi</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>idsi</span>
<a name="line-1612"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPatSynSig</span> <span class='hs-varid'>tpsi</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TcPatSynInfo"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tpsi</span>
<a name="line-1613"></a>
<a name="line-1614"></a><a name="instance%20Outputable%20TcIdSigInfo"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcIdSigInfo</span> <span class='hs-keyword'>where</span>
<a name="line-1615"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CompleteSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1616"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-1617"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PartialSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>psig_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>psig_hs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1618"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"psig"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span>
<a name="line-1619"></a>
<a name="line-1620"></a><a name="instance%20Outputable%20TcIdSigInst"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcIdSigInst</span> <span class='hs-keyword'>where</span>
<a name="line-1621"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TISI</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_inst_sig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skols</span>
<a name="line-1622"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_tau</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tau</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1623"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>skols</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>theta</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>darrow</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tau</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1624"></a>
<a name="line-1625"></a><a name="instance%20Outputable%20TcPatSynInfo"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcPatSynInfo</span> <span class='hs-keyword'>where</span>
<a name="line-1626"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TPSI</span><span class='hs-layout'>{</span> <span class='hs-varid'>patsig_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span>
<a name="line-1627"></a>
<a name="line-1628"></a><a name="isPartialSig"></a><span class='hs-definition'>isPartialSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcIdSigInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1629"></a><span class='hs-definition'>isPartialSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>TISI</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_inst_sig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PartialSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1630"></a><span class='hs-definition'>isPartialSig</span> <span class='hs-keyword'>_</span>                                       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1631"></a>
<a name="line-1632"></a><a name="hasCompleteSig"></a><span class='hs-comment'>-- | No signature or a partial signature</span>
<a name="line-1633"></a><span class='hs-definition'>hasCompleteSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSigFun</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1634"></a><span class='hs-definition'>hasCompleteSig</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>name</span>
<a name="line-1635"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>of</span>
<a name="line-1636"></a>      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcIdSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>CompleteSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1637"></a>      <span class='hs-keyword'>_</span>                               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1638"></a>
<a name="line-1639"></a>
<a name="line-1640"></a><span class='hs-comment'>{-
<a name="line-1641"></a>Constraint Solver Plugins
<a name="line-1642"></a>-------------------------
<a name="line-1643"></a>-}</span>
<a name="line-1644"></a>
<a name="line-1645"></a><a name="TcPluginSolver"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcPluginSolver</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- given</span>
<a name="line-1646"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- derived</span>
<a name="line-1647"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- wanted</span>
<a name="line-1648"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-conid'>TcPluginResult</span>
<a name="line-1649"></a>
<a name="line-1650"></a><a name="TcPluginM"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBindsVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Functor</span><span class='hs-layout'>)</span>
<a name="line-1651"></a>
<a name="line-1652"></a><a name="instance%20Applicative%20TcPluginM"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Applicative</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-keyword'>where</span>
<a name="line-1653"></a>  <span class='hs-varid'>pure</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varop'>$</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-1654"></a>  <span class='hs-layout'>(</span><span class='hs-varop'>&lt;*&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ap</span>
<a name="line-1655"></a>
<a name="line-1656"></a><a name="instance%20Monad%20TcPluginM"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monad</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-keyword'>where</span>
<a name="line-1657"></a>  <span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>m</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span>
<a name="line-1658"></a>    <span class='hs-conid'>TcPluginM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ev</span>
<a name="line-1659"></a>                          <span class='hs-varid'>runTcPluginM</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-1660"></a>
<a name="line-1661"></a><a name="instance%20MonadFail%20TcPluginM"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadFail</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-keyword'>where</span>
<a name="line-1662"></a>  <span class='hs-varid'>fail</span> <span class='hs-varid'>x</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fail</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-1663"></a>
<a name="line-1664"></a><a name="runTcPluginM"></a><span class='hs-definition'>runTcPluginM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1665"></a><span class='hs-definition'>runTcPluginM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span>
<a name="line-1666"></a>
<a name="line-1667"></a><a name="unsafeTcPluginTcM"></a><span class='hs-comment'>-- | This function provides an escape for direct access to</span>
<a name="line-1668"></a><span class='hs-comment'>-- the 'TcM` monad.  It should not be used lightly, and</span>
<a name="line-1669"></a><span class='hs-comment'>-- the provided 'TcPluginM' API should be favoured instead.</span>
<a name="line-1670"></a><span class='hs-definition'>unsafeTcPluginTcM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>a</span>
<a name="line-1671"></a><span class='hs-definition'>unsafeTcPluginTcM</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-varop'>.</span> <span class='hs-varid'>const</span>
<a name="line-1672"></a>
<a name="line-1673"></a><a name="getEvBindsTcPluginM"></a><span class='hs-comment'>-- | Access the 'EvBindsVar' carried by the 'TcPluginM' during</span>
<a name="line-1674"></a><span class='hs-comment'>-- constraint solving.  Returns 'Nothing' if invoked during</span>
<a name="line-1675"></a><span class='hs-comment'>-- 'tcPluginInit' or 'tcPluginStop'.</span>
<a name="line-1676"></a><span class='hs-definition'>getEvBindsTcPluginM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-1677"></a><span class='hs-definition'>getEvBindsTcPluginM</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>return</span>
<a name="line-1678"></a>
<a name="line-1679"></a>
<a name="line-1680"></a><a name="TcPlugin"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcPlugin</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>s</span><span class='hs-varop'>.</span> <span class='hs-conid'>TcPlugin</span>
<a name="line-1681"></a>  <span class='hs-layout'>{</span> <span class='hs-varid'>tcPluginInit</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>s</span>
<a name="line-1682"></a>    <span class='hs-comment'>-- ^ Initialize plugin, when entering type-checker.</span>
<a name="line-1683"></a>
<a name="line-1684"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tcPluginSolve</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPluginSolver</span>
<a name="line-1685"></a>    <span class='hs-comment'>-- ^ Solve some constraints.</span>
<a name="line-1686"></a>    <span class='hs-comment'>-- TODO: WRITE MORE DETAILS ON HOW THIS WORKS.</span>
<a name="line-1687"></a>
<a name="line-1688"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tcPluginStop</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-conid'>()</span>
<a name="line-1689"></a>   <span class='hs-comment'>-- ^ Clean up after the plugin, when exiting the type-checker.</span>
<a name="line-1690"></a>  <span class='hs-layout'>}</span>
<a name="line-1691"></a>
<a name="line-1692"></a><a name="TcPluginResult"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcPluginResult</span>
<a name="line-1693"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcPluginContradiction</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-1694"></a>    <span class='hs-comment'>-- ^ The plugin found a contradiction.</span>
<a name="line-1695"></a>    <span class='hs-comment'>-- The returned constraints are removed from the inert set,</span>
<a name="line-1696"></a>    <span class='hs-comment'>-- and recorded as insoluble.</span>
<a name="line-1697"></a>
<a name="line-1698"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcPluginOk</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>EvTerm</span><span class='hs-layout'>,</span><span class='hs-conid'>Ct</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-1699"></a>    <span class='hs-comment'>-- ^ The first field is for constraints that were solved.</span>
<a name="line-1700"></a>    <span class='hs-comment'>-- These are removed from the inert set,</span>
<a name="line-1701"></a>    <span class='hs-comment'>-- and the evidence for them is recorded.</span>
<a name="line-1702"></a>    <span class='hs-comment'>-- The second field contains new work, that should be processed by</span>
<a name="line-1703"></a>    <span class='hs-comment'>-- the constraint solver.</span>
<a name="line-1704"></a>
<a name="line-1705"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1706"></a>*                                                                      *
<a name="line-1707"></a>                        Role annotations
<a name="line-1708"></a>*                                                                      *
<a name="line-1709"></a>********************************************************************* -}</span>
<a name="line-1710"></a>
<a name="line-1711"></a><a name="RoleAnnotEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>RoleAnnotEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRoleAnnotDecl</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span>
<a name="line-1712"></a>
<a name="line-1713"></a><a name="mkRoleAnnotEnv"></a><span class='hs-definition'>mkRoleAnnotEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LRoleAnnotDecl</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RoleAnnotEnv</span>
<a name="line-1714"></a><span class='hs-definition'>mkRoleAnnotEnv</span> <span class='hs-varid'>role_annot_decls</span>
<a name="line-1715"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameEnv</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ra_decl</span><span class='hs-layout'>)</span>
<a name="line-1716"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ra_decl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>role_annot_decls</span>
<a name="line-1717"></a>             <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>roleAnnotDeclName</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ra_decl</span><span class='hs-layout'>)</span>
<a name="line-1718"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnboundName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-1719"></a>       <span class='hs-comment'>-- Some of the role annots will be unbound;</span>
<a name="line-1720"></a>       <span class='hs-comment'>-- we don't wish to include these</span>
<a name="line-1721"></a>
<a name="line-1722"></a><a name="emptyRoleAnnotEnv"></a><span class='hs-definition'>emptyRoleAnnotEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RoleAnnotEnv</span>
<a name="line-1723"></a><span class='hs-definition'>emptyRoleAnnotEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyNameEnv</span>
<a name="line-1724"></a>
<a name="line-1725"></a><a name="lookupRoleAnnot"></a><span class='hs-definition'>lookupRoleAnnot</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RoleAnnotEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRoleAnnotDecl</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span>
<a name="line-1726"></a><span class='hs-definition'>lookupRoleAnnot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupNameEnv</span>
<a name="line-1727"></a>
<a name="line-1728"></a><a name="getRoleAnnots"></a><span class='hs-definition'>getRoleAnnots</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RoleAnnotEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LRoleAnnotDecl</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>
<a name="line-1729"></a><span class='hs-definition'>getRoleAnnots</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>role_env</span>
<a name="line-1730"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapMaybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupRoleAnnot</span> <span class='hs-varid'>role_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs</span>
<a name="line-1731"></a>
<a name="line-1732"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1733"></a>*                                                                      *
<a name="line-1734"></a>                  Linting a TcGblEnv
<a name="line-1735"></a>*                                                                      *
<a name="line-1736"></a>********************************************************************* -}</span>
<a name="line-1737"></a>
<a name="line-1738"></a><a name="lintGblEnv"></a><span class='hs-comment'>-- | Check the 'TcGblEnv' for consistency. Currently, only checks</span>
<a name="line-1739"></a><span class='hs-comment'>-- axioms, but should check other aspects, too.</span>
<a name="line-1740"></a><span class='hs-definition'>lintGblEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Logger</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-1741"></a><span class='hs-definition'>lintGblEnv</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tcg_env</span> <span class='hs-keyglyph'>=</span>
<a name="line-1742"></a>  <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lintAxioms</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"TcGblEnv axioms"</span><span class='hs-layout'>)</span> <span class='hs-varid'>axioms</span>
<a name="line-1743"></a>  <span class='hs-keyword'>where</span>
<a name="line-1744"></a>    <span class='hs-varid'>axioms</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeEnvCoAxioms</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_type_env</span> <span class='hs-varid'>tcg_env</span><span class='hs-layout'>)</span>
<a name="line-1745"></a>
<a name="line-1746"></a><a name="DocLoc"></a><span class='hs-comment'>-- | This is a mirror of Template Haskell's DocLoc, but the TH names are</span>
<a name="line-1747"></a><a name="DocLoc"></a><span class='hs-comment'>-- resolved to GHC names.</span>
<a name="line-1748"></a><a name="DocLoc"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DocLoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DeclDoc</span> <span class='hs-conid'>Name</span>
<a name="line-1749"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ArgDoc</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>Int</span>
<a name="line-1750"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InstDoc</span> <span class='hs-conid'>Name</span>
<a name="line-1751"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ModuleDoc</span>
<a name="line-1752"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span><span class='hs-layout'>)</span>
<a name="line-1753"></a>
<a name="line-1754"></a><a name="THDocs"></a><span class='hs-comment'>-- | The current collection of docs that Template Haskell has built up via</span>
<a name="line-1755"></a><a name="THDocs"></a><span class='hs-comment'>-- putDoc.</span>
<a name="line-1756"></a><a name="THDocs"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>THDocs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>DocLoc</span> <span class='hs-conid'>String</span>
</pre></body>
</html>
