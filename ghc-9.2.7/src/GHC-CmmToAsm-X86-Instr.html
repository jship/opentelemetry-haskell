<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/CmmToAsm/X86/Instr.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP, TypeFamilies #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-4"></a><span class='hs-comment'>--</span>
<a name="line-5"></a><span class='hs-comment'>-- Machine-dependent assembly language</span>
<a name="line-6"></a><span class='hs-comment'>--</span>
<a name="line-7"></a><span class='hs-comment'>-- (c) The University of Glasgow 1993-2004</span>
<a name="line-8"></a><span class='hs-comment'>--</span>
<a name="line-9"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.CmmToAsm.X86.Instr</span>
<a name="line-12"></a>   <span class='hs-layout'>(</span> <span class='hs-conid'>Instr</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-13"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>Operand</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-14"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>PrefetchVariant</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-15"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>JumpDest</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-16"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>getJumpDestBlockId</span>
<a name="line-17"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>canShortcut</span>
<a name="line-18"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>shortcutStatics</span>
<a name="line-19"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>shortcutJump</span>
<a name="line-20"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>allocMoreStack</span>
<a name="line-21"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>maxSpillSlots</span>
<a name="line-22"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>archWordFormat</span>
<a name="line-23"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>takeRegRegMoveInstr</span>
<a name="line-24"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>regUsageOfInstr</span>
<a name="line-25"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>takeDeltaInstr</span>
<a name="line-26"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mkLoadInstr</span>
<a name="line-27"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mkJumpInstr</span>
<a name="line-28"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mkStackAllocInstr</span>
<a name="line-29"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mkStackDeallocInstr</span>
<a name="line-30"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mkSpillInstr</span>
<a name="line-31"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mkRegRegMoveInstr</span>
<a name="line-32"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>jumpDestsOfInstr</span>
<a name="line-33"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>patchRegsOfInstr</span>
<a name="line-34"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>patchJumpInstr</span>
<a name="line-35"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>isMetaInstr</span>
<a name="line-36"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>isJumpishInstr</span>
<a name="line-37"></a>   <span class='hs-layout'>)</span>
<a name="line-38"></a><span class='hs-keyword'>where</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-43"></a>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.CmmToAsm.X86.Cond</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.CmmToAsm.X86.Regs</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.CmmToAsm.Format</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.CmmToAsm.Types</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.CmmToAsm.Utils</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.CmmToAsm.Instr</span> <span class='hs-layout'>(</span><span class='hs-conid'>RegUsage</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>noUsage</span><span class='hs-layout'>)</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Platform.Reg.Class</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Platform.Reg</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.CmmToAsm.Reg.Target</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.CmmToAsm.Config</span>
<a name="line-54"></a>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.BlockId</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.Dataflow.Collections</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.Dataflow.Label</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Platform.Regs</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.FastString</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Platform</span>
<a name="line-64"></a>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.CLabel</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.Set</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.Supply</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Basic</span> <span class='hs-layout'>(</span><span class='hs-conid'>Alignment</span><span class='hs-layout'>)</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.DebugBlock</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnwindTable</span><span class='hs-layout'>)</span>
<a name="line-71"></a>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Maybe</span>       <span class='hs-layout'>(</span><span class='hs-varid'>fromMaybe</span><span class='hs-layout'>)</span>
<a name="line-74"></a>
<a name="line-75"></a><a name="archWordFormat"></a><span class='hs-comment'>-- Format of an x86/x86_64 memory address, in bytes.</span>
<a name="line-76"></a><span class='hs-comment'>--</span>
<a name="line-77"></a><span class='hs-definition'>archWordFormat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Format</span>
<a name="line-78"></a><span class='hs-definition'>archWordFormat</span> <span class='hs-varid'>is32Bit</span>
<a name="line-79"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is32Bit</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>II32</span>
<a name="line-80"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>II64</span>
<a name="line-81"></a>
<a name="line-82"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-83"></a><span class='hs-comment'>-- Intel x86 instructions</span>
<a name="line-84"></a>
<a name="line-85"></a><span class='hs-comment'>{-
<a name="line-86"></a>Intel, in their infinite wisdom, selected a stack model for floating
<a name="line-87"></a>point registers on x86.  That might have made sense back in 1979 --
<a name="line-88"></a>nowadays we can see it for the nonsense it really is.  A stack model
<a name="line-89"></a>fits poorly with the existing nativeGen infrastructure, which assumes
<a name="line-90"></a>flat integer and FP register sets.  Prior to this commit, nativeGen
<a name="line-91"></a>could not generate correct x86 FP code -- to do so would have meant
<a name="line-92"></a>somehow working the register-stack paradigm into the register
<a name="line-93"></a>allocator and spiller, which sounds very difficult.
<a name="line-94"></a>
<a name="line-95"></a>We have decided to cheat, and go for a simple fix which requires no
<a name="line-96"></a>infrastructure modifications, at the expense of generating ropey but
<a name="line-97"></a>correct FP code.  All notions of the x86 FP stack and its insns have
<a name="line-98"></a>been removed.  Instead, we pretend (to the instruction selector and
<a name="line-99"></a>register allocator) that x86 has six floating point registers, %fake0
<a name="line-100"></a>.. %fake5, which can be used in the usual flat manner.  We further
<a name="line-101"></a>claim that x86 has floating point instructions very similar to SPARC
<a name="line-102"></a>and Alpha, that is, a simple 3-operand register-register arrangement.
<a name="line-103"></a>Code generation and register allocation proceed on this basis.
<a name="line-104"></a>
<a name="line-105"></a>When we come to print out the final assembly, our convenient fiction
<a name="line-106"></a>is converted to dismal reality.  Each fake instruction is
<a name="line-107"></a>independently converted to a series of real x86 instructions.
<a name="line-108"></a>%fake0 .. %fake5 are mapped to %st(0) .. %st(5).  To do reg-reg
<a name="line-109"></a>arithmetic operations, the two operands are pushed onto the top of the
<a name="line-110"></a>FP stack, the operation done, and the result copied back into the
<a name="line-111"></a>relevant register.  There are only six %fake registers because 2 are
<a name="line-112"></a>needed for the translation, and x86 has 8 in total.
<a name="line-113"></a>
<a name="line-114"></a>The translation is inefficient but is simple and it works.  A cleverer
<a name="line-115"></a>translation would handle a sequence of insns, simulating the FP stack
<a name="line-116"></a>contents, would not impose a fixed mapping from %fake to %st regs, and
<a name="line-117"></a>hopefully could avoid most of the redundant reg-reg moves of the
<a name="line-118"></a>current translation.
<a name="line-119"></a>
<a name="line-120"></a>We might as well make use of whatever unique FP facilities Intel have
<a name="line-121"></a>chosen to bless us with (let's not be churlish, after all).
<a name="line-122"></a>Hence GLDZ and GLD1.  Bwahahahahahahaha!
<a name="line-123"></a>-}</span>
<a name="line-124"></a>
<a name="line-125"></a><span class='hs-comment'>{-
<a name="line-126"></a>Note [x86 Floating point precision]
<a name="line-127"></a>
<a name="line-128"></a>Intel's internal floating point registers are by default 80 bit
<a name="line-129"></a>extended precision.  This means that all operations done on values in
<a name="line-130"></a>registers are done at 80 bits, and unless the intermediate values are
<a name="line-131"></a>truncated to the appropriate size (32 or 64 bits) by storing in
<a name="line-132"></a>memory, calculations in registers will give different results from
<a name="line-133"></a>calculations which pass intermediate values in memory (eg. via
<a name="line-134"></a>function calls).
<a name="line-135"></a>
<a name="line-136"></a>One solution is to set the FPU into 64 bit precision mode.  Some OSs
<a name="line-137"></a>do this (eg. FreeBSD) and some don't (eg. Linux).  The problem here is
<a name="line-138"></a>that this will only affect 64-bit precision arithmetic; 32-bit
<a name="line-139"></a>calculations will still be done at 64-bit precision in registers.  So
<a name="line-140"></a>it doesn't solve the whole problem.
<a name="line-141"></a>
<a name="line-142"></a>There's also the issue of what the C library is expecting in terms of
<a name="line-143"></a>precision.  It seems to be the case that glibc on Linux expects the
<a name="line-144"></a>FPU to be set to 80 bit precision, so setting it to 64 bit could have
<a name="line-145"></a>unexpected effects.  Changing the default could have undesirable
<a name="line-146"></a>effects on other 3rd-party library code too, so the right thing would
<a name="line-147"></a>be to save/restore the FPU control word across Haskell code if we were
<a name="line-148"></a>to do this.
<a name="line-149"></a>
<a name="line-150"></a>gcc's -ffloat-store gives consistent results by always storing the
<a name="line-151"></a>results of floating-point calculations in memory, which works for both
<a name="line-152"></a>32 and 64-bit precision.  However, it only affects the values of
<a name="line-153"></a>user-declared floating point variables in C, not intermediate results.
<a name="line-154"></a>GHC in -fvia-C mode uses -ffloat-store (see the -fexcess-precision
<a name="line-155"></a>flag).
<a name="line-156"></a>
<a name="line-157"></a>Another problem is how to spill floating point registers in the
<a name="line-158"></a>register allocator.  Should we spill the whole 80 bits, or just 64?
<a name="line-159"></a>On an OS which is set to 64 bit precision, spilling 64 is fine.  On
<a name="line-160"></a>Linux, spilling 64 bits will round the results of some operations.
<a name="line-161"></a>This is what gcc does.  Spilling at 80 bits requires taking up a full
<a name="line-162"></a>128 bit slot (so we get alignment).  We spill at 80-bits and ignore
<a name="line-163"></a>the alignment problems.
<a name="line-164"></a>
<a name="line-165"></a>In the future [edit: now available in GHC 7.0.1, with the -msse2
<a name="line-166"></a>flag], we'll use the SSE registers for floating point.  This requires
<a name="line-167"></a>a CPU that supports SSE2 (ordinary SSE only supports 32 bit precision
<a name="line-168"></a>float ops), which means P4 or Xeon and above.  Using SSE will solve
<a name="line-169"></a>all these problems, because the SSE registers use fixed 32 bit or 64
<a name="line-170"></a>bit precision.
<a name="line-171"></a>
<a name="line-172"></a>--SDM 1/2003
<a name="line-173"></a>-}</span>
<a name="line-174"></a>
<a name="line-175"></a><a name="Instr"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Instr</span>
<a name="line-176"></a>        <span class='hs-comment'>-- comment pseudo-op</span>
<a name="line-177"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>COMMENT</span> <span class='hs-conid'>FastString</span>
<a name="line-178"></a>
<a name="line-179"></a>        <span class='hs-comment'>-- location pseudo-op (file, line, col, name)</span>
<a name="line-180"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LOCATION</span> <span class='hs-conid'>Int</span> <span class='hs-conid'>Int</span> <span class='hs-conid'>Int</span> <span class='hs-conid'>String</span>
<a name="line-181"></a>
<a name="line-182"></a>        <span class='hs-comment'>-- some static data spat out during code</span>
<a name="line-183"></a>        <span class='hs-comment'>-- generation.  Will be extracted before</span>
<a name="line-184"></a>        <span class='hs-comment'>-- pretty-printing.</span>
<a name="line-185"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LDATA</span>   <span class='hs-conid'>Section</span> <span class='hs-layout'>(</span><span class='hs-conid'>Alignment</span><span class='hs-layout'>,</span> <span class='hs-conid'>RawCmmStatics</span><span class='hs-layout'>)</span>
<a name="line-186"></a>
<a name="line-187"></a>        <span class='hs-comment'>-- start a new basic block.  Useful during</span>
<a name="line-188"></a>        <span class='hs-comment'>-- codegen, removed later.  Preceding</span>
<a name="line-189"></a>        <span class='hs-comment'>-- instruction should be a jump, as per the</span>
<a name="line-190"></a>        <span class='hs-comment'>-- invariants for a BasicBlock (see Cmm).</span>
<a name="line-191"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NEWBLOCK</span> <span class='hs-conid'>BlockId</span>
<a name="line-192"></a>
<a name="line-193"></a>        <span class='hs-comment'>-- unwinding information</span>
<a name="line-194"></a>        <span class='hs-comment'>-- See Note [Unwinding information in the NCG].</span>
<a name="line-195"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UNWIND</span> <span class='hs-conid'>CLabel</span> <span class='hs-conid'>UnwindTable</span>
<a name="line-196"></a>
<a name="line-197"></a>        <span class='hs-comment'>-- specify current stack offset for benefit of subsequent passes.</span>
<a name="line-198"></a>        <span class='hs-comment'>-- This carries a BlockId so it can be used in unwinding information.</span>
<a name="line-199"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DELTA</span>  <span class='hs-conid'>Int</span>
<a name="line-200"></a>
<a name="line-201"></a>        <span class='hs-comment'>-- Moves.</span>
<a name="line-202"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MOV</span>         <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Operand</span>
<a name="line-203"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CMOV</span>   <span class='hs-conid'>Cond</span> <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Reg</span>
<a name="line-204"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MOVZxL</span>      <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Operand</span> <span class='hs-comment'>-- format is the size of operand 1</span>
<a name="line-205"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MOVSxL</span>      <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Operand</span> <span class='hs-comment'>-- format is the size of operand 1</span>
<a name="line-206"></a>        <span class='hs-comment'>-- x86_64 note: plain mov into a 32-bit register always zero-extends</span>
<a name="line-207"></a>        <span class='hs-comment'>-- into the 64-bit reg, in contrast to the 8 and 16-bit movs which</span>
<a name="line-208"></a>        <span class='hs-comment'>-- don't affect the high bits of the register.</span>
<a name="line-209"></a>
<a name="line-210"></a>        <span class='hs-comment'>-- Load effective address (also a very useful three-operand add instruction :-)</span>
<a name="line-211"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LEA</span>         <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Operand</span>
<a name="line-212"></a>
<a name="line-213"></a>        <span class='hs-comment'>-- Int Arithmetic.</span>
<a name="line-214"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ADD</span>         <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Operand</span>
<a name="line-215"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ADC</span>         <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Operand</span>
<a name="line-216"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SUB</span>         <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Operand</span>
<a name="line-217"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SBB</span>         <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Operand</span>
<a name="line-218"></a>
<a name="line-219"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MUL</span>         <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Operand</span>
<a name="line-220"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MUL2</span>        <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span>         <span class='hs-comment'>-- %edx:%eax = operand * %rax</span>
<a name="line-221"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IMUL</span>        <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Operand</span> <span class='hs-comment'>-- signed int mul</span>
<a name="line-222"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IMUL2</span>       <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span>         <span class='hs-comment'>-- %edx:%eax = operand * %eax</span>
<a name="line-223"></a>
<a name="line-224"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DIV</span>         <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span>         <span class='hs-comment'>-- eax := eax:edx/op, edx := eax:edx%op</span>
<a name="line-225"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IDIV</span>        <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span>         <span class='hs-comment'>-- ditto, but signed</span>
<a name="line-226"></a>
<a name="line-227"></a>        <span class='hs-comment'>-- Int Arithmetic, where the effects on the condition register</span>
<a name="line-228"></a>        <span class='hs-comment'>-- are important. Used in specialized sequences such as MO_Add2.</span>
<a name="line-229"></a>        <span class='hs-comment'>-- Do not rewrite these instructions to "equivalent" ones that</span>
<a name="line-230"></a>        <span class='hs-comment'>-- have different effect on the condition register! (See #9013.)</span>
<a name="line-231"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ADD_CC</span>      <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Operand</span>
<a name="line-232"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SUB_CC</span>      <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Operand</span>
<a name="line-233"></a>
<a name="line-234"></a>        <span class='hs-comment'>-- Simple bit-twiddling.</span>
<a name="line-235"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AND</span>         <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Operand</span>
<a name="line-236"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OR</span>          <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Operand</span>
<a name="line-237"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>XOR</span>         <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Operand</span>
<a name="line-238"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NOT</span>         <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span>
<a name="line-239"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NEGI</span>        <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span>         <span class='hs-comment'>-- NEG instruction (name clash with Cond)</span>
<a name="line-240"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BSWAP</span>       <span class='hs-conid'>Format</span> <span class='hs-conid'>Reg</span>
<a name="line-241"></a>
<a name="line-242"></a>        <span class='hs-comment'>-- Shifts (amount may be immediate or %cl only)</span>
<a name="line-243"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SHL</span>         <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span><span class='hs-comment'>{-amount-}</span> <span class='hs-conid'>Operand</span>
<a name="line-244"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SAR</span>         <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span><span class='hs-comment'>{-amount-}</span> <span class='hs-conid'>Operand</span>
<a name="line-245"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SHR</span>         <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span><span class='hs-comment'>{-amount-}</span> <span class='hs-conid'>Operand</span>
<a name="line-246"></a>
<a name="line-247"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BT</span>          <span class='hs-conid'>Format</span> <span class='hs-conid'>Imm</span> <span class='hs-conid'>Operand</span>
<a name="line-248"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NOP</span>
<a name="line-249"></a>
<a name="line-250"></a>
<a name="line-251"></a>        <span class='hs-comment'>-- We need to support the FSTP (x87 store and pop) instruction</span>
<a name="line-252"></a>        <span class='hs-comment'>-- so that we can correctly read off the return value of an</span>
<a name="line-253"></a>        <span class='hs-comment'>-- x86 CDECL C function call when its floating point.</span>
<a name="line-254"></a>        <span class='hs-comment'>-- so we dont include a register argument, and just use st(0)</span>
<a name="line-255"></a>        <span class='hs-comment'>-- this instruction is used ONLY for return values of C ffi calls</span>
<a name="line-256"></a>        <span class='hs-comment'>-- in x86_32 abi</span>
<a name="line-257"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>X87Store</span>         <span class='hs-conid'>Format</span>  <span class='hs-conid'>AddrMode</span> <span class='hs-comment'>-- st(0), dst</span>
<a name="line-258"></a>
<a name="line-259"></a>
<a name="line-260"></a>        <span class='hs-comment'>-- SSE2 floating point: we use a restricted set of the available SSE2</span>
<a name="line-261"></a>        <span class='hs-comment'>-- instructions for floating-point.</span>
<a name="line-262"></a>        <span class='hs-comment'>-- use MOV for moving (either movss or movsd (movlpd better?))</span>
<a name="line-263"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CVTSS2SD</span>      <span class='hs-conid'>Reg</span> <span class='hs-conid'>Reg</span>            <span class='hs-comment'>-- F32 to F64</span>
<a name="line-264"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CVTSD2SS</span>      <span class='hs-conid'>Reg</span> <span class='hs-conid'>Reg</span>            <span class='hs-comment'>-- F64 to F32</span>
<a name="line-265"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CVTTSS2SIQ</span>    <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Reg</span> <span class='hs-comment'>-- F32 to I32/I64 (with truncation)</span>
<a name="line-266"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CVTTSD2SIQ</span>    <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Reg</span> <span class='hs-comment'>-- F64 to I32/I64 (with truncation)</span>
<a name="line-267"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CVTSI2SS</span>      <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Reg</span> <span class='hs-comment'>-- I32/I64 to F32</span>
<a name="line-268"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CVTSI2SD</span>      <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Reg</span> <span class='hs-comment'>-- I32/I64 to F64</span>
<a name="line-269"></a>
<a name="line-270"></a>        <span class='hs-comment'>-- use ADD, SUB, and SQRT for arithmetic.  In both cases, operands</span>
<a name="line-271"></a>        <span class='hs-comment'>-- are  Operand Reg.</span>
<a name="line-272"></a>
<a name="line-273"></a>        <span class='hs-comment'>-- SSE2 floating-point division:</span>
<a name="line-274"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FDIV</span>          <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Operand</span>   <span class='hs-comment'>-- divisor, dividend(dst)</span>
<a name="line-275"></a>
<a name="line-276"></a>        <span class='hs-comment'>-- use CMP for comparisons.  ucomiss and ucomisd instructions</span>
<a name="line-277"></a>        <span class='hs-comment'>-- compare single/double prec floating point respectively.</span>
<a name="line-278"></a>
<a name="line-279"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SQRT</span>          <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Reg</span>      <span class='hs-comment'>-- src, dst</span>
<a name="line-280"></a>
<a name="line-281"></a>
<a name="line-282"></a>        <span class='hs-comment'>-- Comparison</span>
<a name="line-283"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TEST</span>          <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Operand</span>
<a name="line-284"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CMP</span>           <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Operand</span>
<a name="line-285"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SETCC</span>         <span class='hs-conid'>Cond</span> <span class='hs-conid'>Operand</span>
<a name="line-286"></a>
<a name="line-287"></a>        <span class='hs-comment'>-- Stack Operations.</span>
<a name="line-288"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PUSH</span>          <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span>
<a name="line-289"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>POP</span>           <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span>
<a name="line-290"></a>        <span class='hs-comment'>-- both unused (SDM):</span>
<a name="line-291"></a>        <span class='hs-comment'>--  | PUSHA</span>
<a name="line-292"></a>        <span class='hs-comment'>--  | POPA</span>
<a name="line-293"></a>
<a name="line-294"></a>        <span class='hs-comment'>-- Jumping around.</span>
<a name="line-295"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>JMP</span>         <span class='hs-conid'>Operand</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Reg</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- including live Regs at the call</span>
<a name="line-296"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>JXX</span>         <span class='hs-conid'>Cond</span> <span class='hs-conid'>BlockId</span>  <span class='hs-comment'>-- includes unconditional branches</span>
<a name="line-297"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>JXX_GBL</span>     <span class='hs-conid'>Cond</span> <span class='hs-conid'>Imm</span>      <span class='hs-comment'>-- non-local version of JXX</span>
<a name="line-298"></a>        <span class='hs-comment'>-- Table jump</span>
<a name="line-299"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>JMP_TBL</span>     <span class='hs-conid'>Operand</span>   <span class='hs-comment'>-- Address to jump to</span>
<a name="line-300"></a>                      <span class='hs-keyglyph'>[</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>JumpDest</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- Targets of the jump table</span>
<a name="line-301"></a>                      <span class='hs-conid'>Section</span>   <span class='hs-comment'>-- Data section jump table should be put in</span>
<a name="line-302"></a>                      <span class='hs-conid'>CLabel</span>    <span class='hs-comment'>-- Label of jump table</span>
<a name="line-303"></a>        <span class='hs-comment'>-- | X86 call instruction</span>
<a name="line-304"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CALL</span>        <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-conid'>Imm</span> <span class='hs-conid'>Reg</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ Jump target</span>
<a name="line-305"></a>                      <span class='hs-keyglyph'>[</span><span class='hs-conid'>Reg</span><span class='hs-keyglyph'>]</span>            <span class='hs-comment'>-- ^ Arguments (required for register allocation)</span>
<a name="line-306"></a>
<a name="line-307"></a>        <span class='hs-comment'>-- Other things.</span>
<a name="line-308"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CLTD</span> <span class='hs-conid'>Format</span>            <span class='hs-comment'>-- sign extend %eax into %edx:%eax</span>
<a name="line-309"></a>
<a name="line-310"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FETCHGOT</span>    <span class='hs-conid'>Reg</span>        <span class='hs-comment'>-- pseudo-insn for ELF position-independent code</span>
<a name="line-311"></a>                                 <span class='hs-comment'>-- pretty-prints as</span>
<a name="line-312"></a>                                 <span class='hs-comment'>--       call 1f</span>
<a name="line-313"></a>                                 <span class='hs-comment'>-- 1:    popl %reg</span>
<a name="line-314"></a>                                 <span class='hs-comment'>--       addl __GLOBAL_OFFSET_TABLE__+.-1b, %reg</span>
<a name="line-315"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FETCHPC</span>     <span class='hs-conid'>Reg</span>        <span class='hs-comment'>-- pseudo-insn for Darwin position-independent code</span>
<a name="line-316"></a>                                 <span class='hs-comment'>-- pretty-prints as</span>
<a name="line-317"></a>                                 <span class='hs-comment'>--       call 1f</span>
<a name="line-318"></a>                                 <span class='hs-comment'>-- 1:    popl %reg</span>
<a name="line-319"></a>
<a name="line-320"></a>    <span class='hs-comment'>-- bit counting instructions</span>
<a name="line-321"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>POPCNT</span>      <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Reg</span> <span class='hs-comment'>-- [SSE4.2] count number of bits set to 1</span>
<a name="line-322"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LZCNT</span>       <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Reg</span> <span class='hs-comment'>-- [BMI2] count number of leading zeros</span>
<a name="line-323"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TZCNT</span>       <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Reg</span> <span class='hs-comment'>-- [BMI2] count number of trailing zeros</span>
<a name="line-324"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BSF</span>         <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Reg</span> <span class='hs-comment'>-- bit scan forward</span>
<a name="line-325"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BSR</span>         <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Reg</span> <span class='hs-comment'>-- bit scan reverse</span>
<a name="line-326"></a>
<a name="line-327"></a>    <span class='hs-comment'>-- bit manipulation instructions</span>
<a name="line-328"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PDEP</span>        <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Reg</span> <span class='hs-comment'>-- [BMI2] deposit bits to   the specified mask</span>
<a name="line-329"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PEXT</span>        <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Reg</span> <span class='hs-comment'>-- [BMI2] extract bits from the specified mask</span>
<a name="line-330"></a>
<a name="line-331"></a>    <span class='hs-comment'>-- prefetch</span>
<a name="line-332"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PREFETCH</span>  <span class='hs-conid'>PrefetchVariant</span> <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-comment'>-- prefetch Variant, addr size, address to prefetch</span>
<a name="line-333"></a>                                        <span class='hs-comment'>-- variant can be NTA, Lvl0, Lvl1, or Lvl2</span>
<a name="line-334"></a>
<a name="line-335"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LOCK</span>        <span class='hs-conid'>Instr</span> <span class='hs-comment'>-- lock prefix</span>
<a name="line-336"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>XADD</span>        <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Operand</span> <span class='hs-comment'>-- src (r), dst (r/m)</span>
<a name="line-337"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CMPXCHG</span>     <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Operand</span> <span class='hs-comment'>-- src (r), dst (r/m), eax implicit</span>
<a name="line-338"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>XCHG</span>        <span class='hs-conid'>Format</span> <span class='hs-conid'>Operand</span> <span class='hs-conid'>Reg</span>     <span class='hs-comment'>-- src (r/m), dst (r/m)</span>
<a name="line-339"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MFENCE</span>
<a name="line-340"></a>
<a name="line-341"></a><a name="PrefetchVariant"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PrefetchVariant</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NTA</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Lvl0</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Lvl1</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Lvl2</span>
<a name="line-342"></a>
<a name="line-343"></a>
<a name="line-344"></a><a name="Operand"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Operand</span>
<a name="line-345"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OpReg</span>  <span class='hs-conid'>Reg</span>            <span class='hs-comment'>-- register</span>
<a name="line-346"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OpImm</span>  <span class='hs-conid'>Imm</span>            <span class='hs-comment'>-- immediate value</span>
<a name="line-347"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OpAddr</span> <span class='hs-conid'>AddrMode</span>       <span class='hs-comment'>-- memory reference</span>
<a name="line-348"></a>
<a name="line-349"></a>
<a name="line-350"></a>
<a name="line-351"></a><a name="regUsageOfInstr"></a><span class='hs-comment'>-- | Returns which registers are read and written as a (read, written)</span>
<a name="line-352"></a><span class='hs-comment'>-- pair.</span>
<a name="line-353"></a><span class='hs-definition'>regUsageOfInstr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Instr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RegUsage</span>
<a name="line-354"></a><span class='hs-definition'>regUsageOfInstr</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>instr</span>
<a name="line-355"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>instr</span> <span class='hs-keyword'>of</span>
<a name="line-356"></a>    <span class='hs-conid'>MOV</span>    <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageRW</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-357"></a>    <span class='hs-conid'>CMOV</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>src</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dst</span><span class='hs-keyglyph'>]</span>
<a name="line-358"></a>    <span class='hs-conid'>MOVZxL</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageRW</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-359"></a>    <span class='hs-conid'>MOVSxL</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageRW</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-360"></a>    <span class='hs-conid'>LEA</span>    <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageRW</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-361"></a>    <span class='hs-conid'>ADD</span>    <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageRM</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-362"></a>    <span class='hs-conid'>ADC</span>    <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageRM</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-363"></a>    <span class='hs-conid'>SUB</span>    <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageRM</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-364"></a>    <span class='hs-conid'>SBB</span>    <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageRM</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-365"></a>    <span class='hs-conid'>IMUL</span>   <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageRM</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-366"></a>
<a name="line-367"></a>    <span class='hs-comment'>-- Result of IMULB will be in just in %ax</span>
<a name="line-368"></a>    <span class='hs-conid'>IMUL2</span>  <span class='hs-conid'>II8</span> <span class='hs-varid'>src</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>eax</span><span class='hs-conop'>:</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>src</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>eax</span><span class='hs-keyglyph'>]</span>
<a name="line-369"></a>    <span class='hs-comment'>-- Result of IMUL for wider values, will be split between %dx/%edx/%rdx and</span>
<a name="line-370"></a>    <span class='hs-comment'>-- %ax/%eax/%rax.</span>
<a name="line-371"></a>    <span class='hs-conid'>IMUL2</span>  <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>eax</span><span class='hs-conop'>:</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>src</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>eax</span><span class='hs-layout'>,</span><span class='hs-varid'>edx</span><span class='hs-keyglyph'>]</span>
<a name="line-372"></a>
<a name="line-373"></a>    <span class='hs-conid'>MUL</span>    <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageRM</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-374"></a>    <span class='hs-conid'>MUL2</span>   <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>eax</span><span class='hs-conop'>:</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>src</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>eax</span><span class='hs-layout'>,</span><span class='hs-varid'>edx</span><span class='hs-keyglyph'>]</span>
<a name="line-375"></a>    <span class='hs-conid'>DIV</span>    <span class='hs-keyword'>_</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>eax</span><span class='hs-conop'>:</span><span class='hs-varid'>edx</span><span class='hs-conop'>:</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>op</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>eax</span><span class='hs-layout'>,</span><span class='hs-varid'>edx</span><span class='hs-keyglyph'>]</span>
<a name="line-376"></a>    <span class='hs-conid'>IDIV</span>   <span class='hs-keyword'>_</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>eax</span><span class='hs-conop'>:</span><span class='hs-varid'>edx</span><span class='hs-conop'>:</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>op</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>eax</span><span class='hs-layout'>,</span><span class='hs-varid'>edx</span><span class='hs-keyglyph'>]</span>
<a name="line-377"></a>    <span class='hs-conid'>ADD_CC</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageRM</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-378"></a>    <span class='hs-conid'>SUB_CC</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageRM</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-379"></a>    <span class='hs-conid'>AND</span>    <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageRM</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-380"></a>    <span class='hs-conid'>OR</span>     <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageRM</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-381"></a>
<a name="line-382"></a>    <span class='hs-conid'>XOR</span>    <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-383"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>src</span> <span class='hs-varop'>==</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dst</span><span class='hs-keyglyph'>]</span>
<a name="line-384"></a>
<a name="line-385"></a>    <span class='hs-conid'>XOR</span>    <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageRM</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-386"></a>    <span class='hs-conid'>NOT</span>    <span class='hs-keyword'>_</span> <span class='hs-varid'>op</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageM</span> <span class='hs-varid'>op</span>
<a name="line-387"></a>    <span class='hs-conid'>BSWAP</span>  <span class='hs-keyword'>_</span> <span class='hs-varid'>reg</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>reg</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>reg</span><span class='hs-keyglyph'>]</span>
<a name="line-388"></a>    <span class='hs-conid'>NEGI</span>   <span class='hs-keyword'>_</span> <span class='hs-varid'>op</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageM</span> <span class='hs-varid'>op</span>
<a name="line-389"></a>    <span class='hs-conid'>SHL</span>    <span class='hs-keyword'>_</span> <span class='hs-varid'>imm</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageRM</span> <span class='hs-varid'>imm</span> <span class='hs-varid'>dst</span>
<a name="line-390"></a>    <span class='hs-conid'>SAR</span>    <span class='hs-keyword'>_</span> <span class='hs-varid'>imm</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageRM</span> <span class='hs-varid'>imm</span> <span class='hs-varid'>dst</span>
<a name="line-391"></a>    <span class='hs-conid'>SHR</span>    <span class='hs-keyword'>_</span> <span class='hs-varid'>imm</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageRM</span> <span class='hs-varid'>imm</span> <span class='hs-varid'>dst</span>
<a name="line-392"></a>    <span class='hs-conid'>BT</span>     <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>   <span class='hs-varid'>src</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRUR</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>src</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-393"></a>
<a name="line-394"></a>    <span class='hs-conid'>PUSH</span>   <span class='hs-keyword'>_</span> <span class='hs-varid'>op</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRUR</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>op</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-395"></a>    <span class='hs-conid'>POP</span>    <span class='hs-keyword'>_</span> <span class='hs-varid'>op</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-varid'>def_W</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-396"></a>    <span class='hs-conid'>TEST</span>   <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRUR</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>src</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>use_R</span> <span class='hs-varid'>dst</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-397"></a>    <span class='hs-conid'>CMP</span>    <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRUR</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>src</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>use_R</span> <span class='hs-varid'>dst</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-398"></a>    <span class='hs-conid'>SETCC</span>  <span class='hs-keyword'>_</span> <span class='hs-varid'>op</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-varid'>def_W</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-399"></a>    <span class='hs-conid'>JXX</span>    <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span>
<a name="line-400"></a>    <span class='hs-conid'>JXX_GBL</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span>
<a name="line-401"></a>    <span class='hs-conid'>JMP</span>     <span class='hs-varid'>op</span> <span class='hs-varid'>regs</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRUR</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>op</span> <span class='hs-varid'>regs</span><span class='hs-layout'>)</span>
<a name="line-402"></a>    <span class='hs-conid'>JMP_TBL</span> <span class='hs-varid'>op</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRUR</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>op</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-403"></a>    <span class='hs-conid'>CALL</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-varid'>params</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-varid'>params</span> <span class='hs-layout'>(</span><span class='hs-varid'>callClobberedRegs</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-404"></a>    <span class='hs-conid'>CALL</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-varid'>params</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>reg</span><span class='hs-conop'>:</span><span class='hs-varid'>params</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>callClobberedRegs</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-405"></a>    <span class='hs-conid'>CLTD</span>   <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>eax</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>edx</span><span class='hs-keyglyph'>]</span>
<a name="line-406"></a>    <span class='hs-conid'>NOP</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span>
<a name="line-407"></a>
<a name="line-408"></a>    <span class='hs-conid'>X87Store</span>    <span class='hs-keyword'>_</span>  <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRUR</span> <span class='hs-layout'>(</span> <span class='hs-varid'>use_EA</span> <span class='hs-varid'>dst</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-409"></a>
<a name="line-410"></a>    <span class='hs-conid'>CVTSS2SD</span>   <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>src</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dst</span><span class='hs-keyglyph'>]</span>
<a name="line-411"></a>    <span class='hs-conid'>CVTSD2SS</span>   <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>src</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dst</span><span class='hs-keyglyph'>]</span>
<a name="line-412"></a>    <span class='hs-conid'>CVTTSS2SIQ</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>src</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dst</span><span class='hs-keyglyph'>]</span>
<a name="line-413"></a>    <span class='hs-conid'>CVTTSD2SIQ</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>src</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dst</span><span class='hs-keyglyph'>]</span>
<a name="line-414"></a>    <span class='hs-conid'>CVTSI2SS</span>   <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>src</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dst</span><span class='hs-keyglyph'>]</span>
<a name="line-415"></a>    <span class='hs-conid'>CVTSI2SD</span>   <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>src</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dst</span><span class='hs-keyglyph'>]</span>
<a name="line-416"></a>    <span class='hs-conid'>FDIV</span> <span class='hs-keyword'>_</span>     <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageRM</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-417"></a>    <span class='hs-conid'>SQRT</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>src</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dst</span><span class='hs-keyglyph'>]</span>
<a name="line-418"></a>
<a name="line-419"></a>    <span class='hs-conid'>FETCHGOT</span> <span class='hs-varid'>reg</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>reg</span><span class='hs-keyglyph'>]</span>
<a name="line-420"></a>    <span class='hs-conid'>FETCHPC</span>  <span class='hs-varid'>reg</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>reg</span><span class='hs-keyglyph'>]</span>
<a name="line-421"></a>
<a name="line-422"></a>    <span class='hs-conid'>COMMENT</span> <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>noUsage</span>
<a name="line-423"></a>    <span class='hs-conid'>LOCATION</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>noUsage</span>
<a name="line-424"></a>    <span class='hs-conid'>UNWIND</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>noUsage</span>
<a name="line-425"></a>    <span class='hs-conid'>DELTA</span>   <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>noUsage</span>
<a name="line-426"></a>
<a name="line-427"></a>    <span class='hs-conid'>POPCNT</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>src</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dst</span><span class='hs-keyglyph'>]</span>
<a name="line-428"></a>    <span class='hs-conid'>LZCNT</span>  <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>src</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dst</span><span class='hs-keyglyph'>]</span>
<a name="line-429"></a>    <span class='hs-conid'>TZCNT</span>  <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>src</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dst</span><span class='hs-keyglyph'>]</span>
<a name="line-430"></a>    <span class='hs-conid'>BSF</span>    <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>src</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dst</span><span class='hs-keyglyph'>]</span>
<a name="line-431"></a>    <span class='hs-conid'>BSR</span>    <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>src</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dst</span><span class='hs-keyglyph'>]</span>
<a name="line-432"></a>
<a name="line-433"></a>    <span class='hs-conid'>PDEP</span>   <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>mask</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>src</span> <span class='hs-varop'>$</span> <span class='hs-varid'>use_R</span> <span class='hs-varid'>mask</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dst</span><span class='hs-keyglyph'>]</span>
<a name="line-434"></a>    <span class='hs-conid'>PEXT</span>   <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>mask</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>src</span> <span class='hs-varop'>$</span> <span class='hs-varid'>use_R</span> <span class='hs-varid'>mask</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dst</span><span class='hs-keyglyph'>]</span>
<a name="line-435"></a>
<a name="line-436"></a>    <span class='hs-comment'>-- note: might be a better way to do this</span>
<a name="line-437"></a>    <span class='hs-conid'>PREFETCH</span> <span class='hs-keyword'>_</span>  <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>src</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span>
<a name="line-438"></a>    <span class='hs-conid'>LOCK</span> <span class='hs-varid'>i</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>regUsageOfInstr</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>i</span>
<a name="line-439"></a>    <span class='hs-conid'>XADD</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageMM</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-440"></a>    <span class='hs-conid'>CMPXCHG</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageRMM</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>eax</span><span class='hs-layout'>)</span>
<a name="line-441"></a>    <span class='hs-conid'>XCHG</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>usageMM</span> <span class='hs-varid'>src</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-442"></a>    <span class='hs-conid'>MFENCE</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>noUsage</span>
<a name="line-443"></a>
<a name="line-444"></a>    <span class='hs-sel'>_other</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"regUsage: unrecognised instr"</span>
<a name="line-445"></a> <span class='hs-keyword'>where</span>
<a name="line-446"></a>    <span class='hs-comment'>-- # Definitions</span>
<a name="line-447"></a>    <span class='hs-comment'>--</span>
<a name="line-448"></a>    <span class='hs-comment'>-- Written: If the operand is a register, it's written. If it's an</span>
<a name="line-449"></a>    <span class='hs-comment'>-- address, registers mentioned in the address are read.</span>
<a name="line-450"></a>    <span class='hs-comment'>--</span>
<a name="line-451"></a>    <span class='hs-comment'>-- Modified: If the operand is a register, it's both read and</span>
<a name="line-452"></a>    <span class='hs-comment'>-- written. If it's an address, registers mentioned in the address</span>
<a name="line-453"></a>    <span class='hs-comment'>-- are read.</span>
<a name="line-454"></a>
<a name="line-455"></a>    <span class='hs-comment'>-- 2 operand form; first operand Read; second Written</span>
<a name="line-456"></a>    <span class='hs-varid'>usageRW</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Operand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Operand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RegUsage</span>
<a name="line-457"></a>    <span class='hs-varid'>usageRW</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>op</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>reg</span><span class='hs-keyglyph'>]</span>
<a name="line-458"></a>    <span class='hs-varid'>usageRW</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpAddr</span> <span class='hs-varid'>ea</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRUR</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>op</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>use_EA</span> <span class='hs-varid'>ea</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-459"></a>    <span class='hs-varid'>usageRW</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"X86.RegInfo.usageRW: no match"</span>
<a name="line-460"></a>
<a name="line-461"></a>    <span class='hs-comment'>-- 2 operand form; first operand Read; second Modified</span>
<a name="line-462"></a>    <span class='hs-varid'>usageRM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Operand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Operand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RegUsage</span>
<a name="line-463"></a>    <span class='hs-varid'>usageRM</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>reg</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>reg</span><span class='hs-keyglyph'>]</span>
<a name="line-464"></a>    <span class='hs-varid'>usageRM</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpAddr</span> <span class='hs-varid'>ea</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRUR</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_R</span> <span class='hs-varid'>op</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>use_EA</span> <span class='hs-varid'>ea</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-465"></a>    <span class='hs-varid'>usageRM</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"X86.RegInfo.usageRM: no match"</span>
<a name="line-466"></a>
<a name="line-467"></a>    <span class='hs-comment'>-- 2 operand form; first operand Modified; second Modified</span>
<a name="line-468"></a>    <span class='hs-varid'>usageMM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Operand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Operand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RegUsage</span>
<a name="line-469"></a>    <span class='hs-varid'>usageMM</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRU</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>src</span><span class='hs-layout'>,</span> <span class='hs-varid'>dst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>src</span><span class='hs-layout'>,</span> <span class='hs-varid'>dst</span><span class='hs-keyglyph'>]</span>
<a name="line-470"></a>    <span class='hs-varid'>usageMM</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpAddr</span> <span class='hs-varid'>ea</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_EA</span> <span class='hs-varid'>ea</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>src</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>src</span><span class='hs-keyglyph'>]</span>
<a name="line-471"></a>    <span class='hs-varid'>usageMM</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpAddr</span> <span class='hs-varid'>ea</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_EA</span> <span class='hs-varid'>ea</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dst</span><span class='hs-keyglyph'>]</span>
<a name="line-472"></a>    <span class='hs-varid'>usageMM</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"X86.RegInfo.usageMM: no match"</span>
<a name="line-473"></a>
<a name="line-474"></a>    <span class='hs-comment'>-- 3 operand form; first operand Read; second Modified; third Modified</span>
<a name="line-475"></a>    <span class='hs-varid'>usageRMM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Operand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Operand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Operand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RegUsage</span>
<a name="line-476"></a>    <span class='hs-varid'>usageRMM</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRU</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>src</span><span class='hs-layout'>,</span> <span class='hs-varid'>dst</span><span class='hs-layout'>,</span> <span class='hs-varid'>reg</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dst</span><span class='hs-layout'>,</span> <span class='hs-varid'>reg</span><span class='hs-keyglyph'>]</span>
<a name="line-477"></a>    <span class='hs-varid'>usageRMM</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpAddr</span> <span class='hs-varid'>ea</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRU</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_EA</span> <span class='hs-varid'>ea</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>src</span><span class='hs-layout'>,</span> <span class='hs-varid'>reg</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>reg</span><span class='hs-keyglyph'>]</span>
<a name="line-478"></a>    <span class='hs-varid'>usageRMM</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"X86.RegInfo.usageRMM: no match"</span>
<a name="line-479"></a>
<a name="line-480"></a>    <span class='hs-comment'>-- 1 operand form; operand Modified</span>
<a name="line-481"></a>    <span class='hs-varid'>usageM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Operand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RegUsage</span>
<a name="line-482"></a>    <span class='hs-varid'>usageM</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRU</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>reg</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>reg</span><span class='hs-keyglyph'>]</span>
<a name="line-483"></a>    <span class='hs-varid'>usageM</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpAddr</span> <span class='hs-varid'>ea</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRUR</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_EA</span> <span class='hs-varid'>ea</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-484"></a>    <span class='hs-varid'>usageM</span> <span class='hs-keyword'>_</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"X86.RegInfo.usageM: no match"</span>
<a name="line-485"></a>
<a name="line-486"></a>    <span class='hs-comment'>-- Registers defd when an operand is written.</span>
<a name="line-487"></a>    <span class='hs-varid'>def_W</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>reg</span><span class='hs-keyglyph'>]</span>
<a name="line-488"></a>    <span class='hs-varid'>def_W</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpAddr</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-489"></a>    <span class='hs-varid'>def_W</span> <span class='hs-keyword'>_</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"X86.RegInfo.def_W: no match"</span>
<a name="line-490"></a>
<a name="line-491"></a>    <span class='hs-comment'>-- Registers used when an operand is read.</span>
<a name="line-492"></a>    <span class='hs-varid'>use_R</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span>  <span class='hs-varid'>tl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tl</span>
<a name="line-493"></a>    <span class='hs-varid'>use_R</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpImm</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-varid'>tl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tl</span>
<a name="line-494"></a>    <span class='hs-varid'>use_R</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpAddr</span> <span class='hs-varid'>ea</span><span class='hs-layout'>)</span>  <span class='hs-varid'>tl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>use_EA</span> <span class='hs-varid'>ea</span> <span class='hs-varid'>tl</span>
<a name="line-495"></a>
<a name="line-496"></a>    <span class='hs-comment'>-- Registers used to compute an effective address.</span>
<a name="line-497"></a>    <span class='hs-varid'>use_EA</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImmAddr</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>tl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tl</span>
<a name="line-498"></a>    <span class='hs-varid'>use_EA</span> <span class='hs-layout'>(</span><span class='hs-conid'>AddrBaseIndex</span> <span class='hs-varid'>base</span> <span class='hs-varid'>index</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>tl</span> <span class='hs-keyglyph'>=</span>
<a name="line-499"></a>        <span class='hs-varid'>use_base</span> <span class='hs-varid'>base</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>use_index</span> <span class='hs-varid'>index</span> <span class='hs-varid'>tl</span>
<a name="line-500"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>use_base</span> <span class='hs-layout'>(</span><span class='hs-conid'>EABaseReg</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>  <span class='hs-varid'>tl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tl</span>
<a name="line-501"></a>              <span class='hs-varid'>use_base</span> <span class='hs-keyword'>_</span>              <span class='hs-varid'>tl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tl</span>
<a name="line-502"></a>              <span class='hs-varid'>use_index</span> <span class='hs-conid'>EAIndexNone</span>   <span class='hs-varid'>tl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tl</span>
<a name="line-503"></a>              <span class='hs-varid'>use_index</span> <span class='hs-layout'>(</span><span class='hs-conid'>EAIndex</span> <span class='hs-varid'>i</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>tl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tl</span>
<a name="line-504"></a>
<a name="line-505"></a>    <span class='hs-varid'>mkRUR</span> <span class='hs-varid'>src</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src'</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>RU</span> <span class='hs-varid'>src'</span> <span class='hs-conid'>[]</span>
<a name="line-506"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>src'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>interesting</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span>
<a name="line-507"></a>
<a name="line-508"></a>    <span class='hs-varid'>mkRU</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src'</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>dst'</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>RU</span> <span class='hs-varid'>src'</span> <span class='hs-varid'>dst'</span>
<a name="line-509"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>src'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>interesting</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span>
<a name="line-510"></a>              <span class='hs-varid'>dst'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>interesting</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span> <span class='hs-varid'>dst</span>
<a name="line-511"></a>
<a name="line-512"></a><a name="interesting"></a><span class='hs-comment'>-- | Is this register interesting for the register allocator?</span>
<a name="line-513"></a><span class='hs-definition'>interesting</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Reg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-514"></a><span class='hs-definition'>interesting</span> <span class='hs-keyword'>_</span>        <span class='hs-layout'>(</span><span class='hs-conid'>RegVirtual</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-515"></a><span class='hs-definition'>interesting</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-conid'>RegReal</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealRegSingle</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>freeReg</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>i</span>
<a name="line-516"></a><span class='hs-definition'>interesting</span> <span class='hs-keyword'>_</span>        <span class='hs-layout'>(</span><span class='hs-conid'>RegReal</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealRegPair</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"X86.interesting: no reg pairs on this arch"</span>
<a name="line-517"></a>
<a name="line-518"></a>
<a name="line-519"></a>
<a name="line-520"></a><a name="patchRegsOfInstr"></a><span class='hs-comment'>-- | Applies the supplied function to all registers in instructions.</span>
<a name="line-521"></a><span class='hs-comment'>-- Typically used to change virtual registers to real registers.</span>
<a name="line-522"></a><span class='hs-definition'>patchRegsOfInstr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Instr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Reg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Reg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Instr</span>
<a name="line-523"></a><span class='hs-definition'>patchRegsOfInstr</span> <span class='hs-varid'>instr</span> <span class='hs-varid'>env</span>
<a name="line-524"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>instr</span> <span class='hs-keyword'>of</span>
<a name="line-525"></a>    <span class='hs-conid'>MOV</span>  <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch2</span> <span class='hs-layout'>(</span><span class='hs-conid'>MOV</span>  <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-526"></a>    <span class='hs-conid'>CMOV</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CMOV</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>fmt</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchOp</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-527"></a>    <span class='hs-conid'>MOVZxL</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch2</span> <span class='hs-layout'>(</span><span class='hs-conid'>MOVZxL</span> <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-528"></a>    <span class='hs-conid'>MOVSxL</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch2</span> <span class='hs-layout'>(</span><span class='hs-conid'>MOVSxL</span> <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-529"></a>    <span class='hs-conid'>LEA</span>  <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch2</span> <span class='hs-layout'>(</span><span class='hs-conid'>LEA</span>  <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-530"></a>    <span class='hs-conid'>ADD</span>  <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch2</span> <span class='hs-layout'>(</span><span class='hs-conid'>ADD</span>  <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-531"></a>    <span class='hs-conid'>ADC</span>  <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch2</span> <span class='hs-layout'>(</span><span class='hs-conid'>ADC</span>  <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-532"></a>    <span class='hs-conid'>SUB</span>  <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch2</span> <span class='hs-layout'>(</span><span class='hs-conid'>SUB</span>  <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-533"></a>    <span class='hs-conid'>SBB</span>  <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch2</span> <span class='hs-layout'>(</span><span class='hs-conid'>SBB</span>  <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-534"></a>    <span class='hs-conid'>IMUL</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch2</span> <span class='hs-layout'>(</span><span class='hs-conid'>IMUL</span> <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-535"></a>    <span class='hs-conid'>IMUL2</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch1</span> <span class='hs-layout'>(</span><span class='hs-conid'>IMUL2</span> <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span>
<a name="line-536"></a>    <span class='hs-conid'>MUL</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch2</span> <span class='hs-layout'>(</span><span class='hs-conid'>MUL</span> <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-537"></a>    <span class='hs-conid'>MUL2</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch1</span> <span class='hs-layout'>(</span><span class='hs-conid'>MUL2</span> <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span>
<a name="line-538"></a>    <span class='hs-conid'>IDIV</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>op</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch1</span> <span class='hs-layout'>(</span><span class='hs-conid'>IDIV</span> <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>op</span>
<a name="line-539"></a>    <span class='hs-conid'>DIV</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>op</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch1</span> <span class='hs-layout'>(</span><span class='hs-conid'>DIV</span> <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>op</span>
<a name="line-540"></a>    <span class='hs-conid'>ADD_CC</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch2</span> <span class='hs-layout'>(</span><span class='hs-conid'>ADD_CC</span> <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-541"></a>    <span class='hs-conid'>SUB_CC</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch2</span> <span class='hs-layout'>(</span><span class='hs-conid'>SUB_CC</span> <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-542"></a>    <span class='hs-conid'>AND</span>  <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch2</span> <span class='hs-layout'>(</span><span class='hs-conid'>AND</span>  <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-543"></a>    <span class='hs-conid'>OR</span>   <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch2</span> <span class='hs-layout'>(</span><span class='hs-conid'>OR</span>   <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-544"></a>    <span class='hs-conid'>XOR</span>  <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch2</span> <span class='hs-layout'>(</span><span class='hs-conid'>XOR</span>  <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-545"></a>    <span class='hs-conid'>NOT</span>  <span class='hs-varid'>fmt</span> <span class='hs-varid'>op</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch1</span> <span class='hs-layout'>(</span><span class='hs-conid'>NOT</span>  <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>op</span>
<a name="line-546"></a>    <span class='hs-conid'>BSWAP</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>reg</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BSWAP</span> <span class='hs-varid'>fmt</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span>
<a name="line-547"></a>    <span class='hs-conid'>NEGI</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>op</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch1</span> <span class='hs-layout'>(</span><span class='hs-conid'>NEGI</span> <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>op</span>
<a name="line-548"></a>    <span class='hs-conid'>SHL</span>  <span class='hs-varid'>fmt</span> <span class='hs-varid'>imm</span> <span class='hs-varid'>dst</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch1</span> <span class='hs-layout'>(</span><span class='hs-conid'>SHL</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>imm</span><span class='hs-layout'>)</span> <span class='hs-varid'>dst</span>
<a name="line-549"></a>    <span class='hs-conid'>SAR</span>  <span class='hs-varid'>fmt</span> <span class='hs-varid'>imm</span> <span class='hs-varid'>dst</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch1</span> <span class='hs-layout'>(</span><span class='hs-conid'>SAR</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>imm</span><span class='hs-layout'>)</span> <span class='hs-varid'>dst</span>
<a name="line-550"></a>    <span class='hs-conid'>SHR</span>  <span class='hs-varid'>fmt</span> <span class='hs-varid'>imm</span> <span class='hs-varid'>dst</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch1</span> <span class='hs-layout'>(</span><span class='hs-conid'>SHR</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>imm</span><span class='hs-layout'>)</span> <span class='hs-varid'>dst</span>
<a name="line-551"></a>    <span class='hs-conid'>BT</span>   <span class='hs-varid'>fmt</span> <span class='hs-varid'>imm</span> <span class='hs-varid'>src</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch1</span> <span class='hs-layout'>(</span><span class='hs-conid'>BT</span>  <span class='hs-varid'>fmt</span> <span class='hs-varid'>imm</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span>
<a name="line-552"></a>    <span class='hs-conid'>TEST</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch2</span> <span class='hs-layout'>(</span><span class='hs-conid'>TEST</span> <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-553"></a>    <span class='hs-conid'>CMP</span>  <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch2</span> <span class='hs-layout'>(</span><span class='hs-conid'>CMP</span>  <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-554"></a>    <span class='hs-conid'>PUSH</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>op</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch1</span> <span class='hs-layout'>(</span><span class='hs-conid'>PUSH</span> <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>op</span>
<a name="line-555"></a>    <span class='hs-conid'>POP</span>  <span class='hs-varid'>fmt</span> <span class='hs-varid'>op</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch1</span> <span class='hs-layout'>(</span><span class='hs-conid'>POP</span>  <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>op</span>
<a name="line-556"></a>    <span class='hs-conid'>SETCC</span> <span class='hs-varid'>cond</span> <span class='hs-varid'>op</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch1</span> <span class='hs-layout'>(</span><span class='hs-conid'>SETCC</span> <span class='hs-varid'>cond</span><span class='hs-layout'>)</span> <span class='hs-varid'>op</span>
<a name="line-557"></a>    <span class='hs-conid'>JMP</span> <span class='hs-varid'>op</span> <span class='hs-varid'>regs</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JMP</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchOp</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-varid'>regs</span>
<a name="line-558"></a>    <span class='hs-conid'>JMP_TBL</span> <span class='hs-varid'>op</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>s</span> <span class='hs-varid'>lbl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JMP_TBL</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchOp</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>s</span> <span class='hs-varid'>lbl</span>
<a name="line-559"></a>
<a name="line-560"></a>    <span class='hs-comment'>-- literally only support storing the top x87 stack value st(0)</span>
<a name="line-561"></a>    <span class='hs-conid'>X87Store</span>  <span class='hs-varid'>fmt</span>  <span class='hs-varid'>dst</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>X87Store</span> <span class='hs-varid'>fmt</span>  <span class='hs-layout'>(</span><span class='hs-varid'>lookupAddr</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-562"></a>
<a name="line-563"></a>    <span class='hs-conid'>CVTSS2SD</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CVTSS2SD</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-564"></a>    <span class='hs-conid'>CVTSD2SS</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CVTSD2SS</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-565"></a>    <span class='hs-conid'>CVTTSS2SIQ</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CVTTSS2SIQ</span> <span class='hs-varid'>fmt</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchOp</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-566"></a>    <span class='hs-conid'>CVTTSD2SIQ</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CVTTSD2SIQ</span> <span class='hs-varid'>fmt</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchOp</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-567"></a>    <span class='hs-conid'>CVTSI2SS</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CVTSI2SS</span> <span class='hs-varid'>fmt</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchOp</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-568"></a>    <span class='hs-conid'>CVTSI2SD</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CVTSI2SD</span> <span class='hs-varid'>fmt</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchOp</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-569"></a>    <span class='hs-conid'>FDIV</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FDIV</span> <span class='hs-varid'>fmt</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchOp</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchOp</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-570"></a>    <span class='hs-conid'>SQRT</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SQRT</span> <span class='hs-varid'>fmt</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchOp</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-571"></a>
<a name="line-572"></a>    <span class='hs-conid'>CALL</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>instr</span>
<a name="line-573"></a>    <span class='hs-conid'>CALL</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-varid'>p</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CALL</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>p</span>
<a name="line-574"></a>
<a name="line-575"></a>    <span class='hs-conid'>FETCHGOT</span> <span class='hs-varid'>reg</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FETCHGOT</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span>
<a name="line-576"></a>    <span class='hs-conid'>FETCHPC</span>  <span class='hs-varid'>reg</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FETCHPC</span>  <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span>
<a name="line-577"></a>
<a name="line-578"></a>    <span class='hs-conid'>NOP</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>instr</span>
<a name="line-579"></a>    <span class='hs-conid'>COMMENT</span> <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>instr</span>
<a name="line-580"></a>    <span class='hs-conid'>LOCATION</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>instr</span>
<a name="line-581"></a>    <span class='hs-conid'>UNWIND</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>instr</span>
<a name="line-582"></a>    <span class='hs-conid'>DELTA</span> <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>instr</span>
<a name="line-583"></a>
<a name="line-584"></a>    <span class='hs-conid'>JXX</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>instr</span>
<a name="line-585"></a>    <span class='hs-conid'>JXX_GBL</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>instr</span>
<a name="line-586"></a>    <span class='hs-conid'>CLTD</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>instr</span>
<a name="line-587"></a>
<a name="line-588"></a>    <span class='hs-conid'>POPCNT</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>POPCNT</span> <span class='hs-varid'>fmt</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchOp</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-589"></a>    <span class='hs-conid'>LZCNT</span>  <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LZCNT</span>  <span class='hs-varid'>fmt</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchOp</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-590"></a>    <span class='hs-conid'>TZCNT</span>  <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TZCNT</span>  <span class='hs-varid'>fmt</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchOp</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-591"></a>    <span class='hs-conid'>PDEP</span>   <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>mask</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PDEP</span>   <span class='hs-varid'>fmt</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchOp</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchOp</span> <span class='hs-varid'>mask</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-592"></a>    <span class='hs-conid'>PEXT</span>   <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>mask</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PEXT</span>   <span class='hs-varid'>fmt</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchOp</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchOp</span> <span class='hs-varid'>mask</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-593"></a>    <span class='hs-conid'>BSF</span>    <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BSF</span>    <span class='hs-varid'>fmt</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchOp</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-594"></a>    <span class='hs-conid'>BSR</span>    <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BSR</span>    <span class='hs-varid'>fmt</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchOp</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-595"></a>
<a name="line-596"></a>    <span class='hs-conid'>PREFETCH</span> <span class='hs-varid'>lvl</span> <span class='hs-varid'>format</span> <span class='hs-varid'>src</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PREFETCH</span> <span class='hs-varid'>lvl</span> <span class='hs-varid'>format</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchOp</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span>
<a name="line-597"></a>
<a name="line-598"></a>    <span class='hs-conid'>LOCK</span> <span class='hs-varid'>i</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LOCK</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchRegsOfInstr</span> <span class='hs-varid'>i</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-599"></a>    <span class='hs-conid'>XADD</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch2</span> <span class='hs-layout'>(</span><span class='hs-conid'>XADD</span> <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-600"></a>    <span class='hs-conid'>CMPXCHG</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patch2</span> <span class='hs-layout'>(</span><span class='hs-conid'>CMPXCHG</span> <span class='hs-varid'>fmt</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-601"></a>    <span class='hs-conid'>XCHG</span> <span class='hs-varid'>fmt</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>XCHG</span> <span class='hs-varid'>fmt</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchOp</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-602"></a>    <span class='hs-conid'>MFENCE</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>instr</span>
<a name="line-603"></a>
<a name="line-604"></a>    <span class='hs-sel'>_other</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"patchRegs: unrecognised instr"</span>
<a name="line-605"></a>
<a name="line-606"></a>  <span class='hs-keyword'>where</span>
<a name="line-607"></a>    <span class='hs-varid'>patch1</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Operand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Operand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-608"></a>    <span class='hs-varid'>patch1</span> <span class='hs-varid'>insn</span> <span class='hs-varid'>op</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insn</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>patchOp</span> <span class='hs-varid'>op</span>
<a name="line-609"></a>    <span class='hs-varid'>patch2</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Operand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Operand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Operand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Operand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-610"></a>    <span class='hs-varid'>patch2</span> <span class='hs-varid'>insn</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>insn</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>patchOp</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>patchOp</span> <span class='hs-varid'>dst</span>
<a name="line-611"></a>
<a name="line-612"></a>    <span class='hs-varid'>patchOp</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span>  <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OpReg</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>env</span> <span class='hs-varid'>reg</span>
<a name="line-613"></a>    <span class='hs-varid'>patchOp</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpImm</span>  <span class='hs-varid'>imm</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OpImm</span> <span class='hs-varid'>imm</span>
<a name="line-614"></a>    <span class='hs-varid'>patchOp</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpAddr</span> <span class='hs-varid'>ea</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OpAddr</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>lookupAddr</span> <span class='hs-varid'>ea</span>
<a name="line-615"></a>
<a name="line-616"></a>    <span class='hs-varid'>lookupAddr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImmAddr</span> <span class='hs-varid'>imm</span> <span class='hs-varid'>off</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImmAddr</span> <span class='hs-varid'>imm</span> <span class='hs-varid'>off</span>
<a name="line-617"></a>    <span class='hs-varid'>lookupAddr</span> <span class='hs-layout'>(</span><span class='hs-conid'>AddrBaseIndex</span> <span class='hs-varid'>base</span> <span class='hs-varid'>index</span> <span class='hs-varid'>disp</span><span class='hs-layout'>)</span>
<a name="line-618"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>AddrBaseIndex</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>lookupBase</span> <span class='hs-varid'>base</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>lookupIndex</span> <span class='hs-varid'>index</span><span class='hs-layout'>)</span> <span class='hs-varid'>disp</span>
<a name="line-619"></a>      <span class='hs-keyword'>where</span>
<a name="line-620"></a>        <span class='hs-varid'>lookupBase</span> <span class='hs-conid'>EABaseNone</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EABaseNone</span>
<a name="line-621"></a>        <span class='hs-varid'>lookupBase</span> <span class='hs-conid'>EABaseRip</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EABaseRip</span>
<a name="line-622"></a>        <span class='hs-varid'>lookupBase</span> <span class='hs-layout'>(</span><span class='hs-conid'>EABaseReg</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EABaseReg</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>env</span> <span class='hs-varid'>r</span>
<a name="line-623"></a>
<a name="line-624"></a>        <span class='hs-varid'>lookupIndex</span> <span class='hs-conid'>EAIndexNone</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EAIndexNone</span>
<a name="line-625"></a>        <span class='hs-varid'>lookupIndex</span> <span class='hs-layout'>(</span><span class='hs-conid'>EAIndex</span> <span class='hs-varid'>r</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>EAIndex</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>env</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span>
<a name="line-626"></a>
<a name="line-627"></a>
<a name="line-628"></a><a name="isJumpishInstr"></a><span class='hs-comment'>--------------------------------------------------------------------------------</span>
<a name="line-629"></a><span class='hs-definition'>isJumpishInstr</span>
<a name="line-630"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Instr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-631"></a>
<a name="line-632"></a><span class='hs-definition'>isJumpishInstr</span> <span class='hs-varid'>instr</span>
<a name="line-633"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>instr</span> <span class='hs-keyword'>of</span>
<a name="line-634"></a>        <span class='hs-conid'>JMP</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-635"></a>        <span class='hs-conid'>JXX</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-636"></a>        <span class='hs-conid'>JXX_GBL</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-637"></a>        <span class='hs-conid'>JMP_TBL</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-638"></a>        <span class='hs-conid'>CALL</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-639"></a>        <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-640"></a>
<a name="line-641"></a>
<a name="line-642"></a><a name="jumpDestsOfInstr"></a><span class='hs-definition'>jumpDestsOfInstr</span>
<a name="line-643"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Instr</span>
<a name="line-644"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BlockId</span><span class='hs-keyglyph'>]</span>
<a name="line-645"></a>
<a name="line-646"></a><span class='hs-definition'>jumpDestsOfInstr</span> <span class='hs-varid'>insn</span>
<a name="line-647"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>insn</span> <span class='hs-keyword'>of</span>
<a name="line-648"></a>        <span class='hs-conid'>JXX</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>id</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>id</span><span class='hs-keyglyph'>]</span>
<a name="line-649"></a>        <span class='hs-conid'>JMP_TBL</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ids</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>id</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>DestBlockId</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ids</span><span class='hs-keyglyph'>]</span>
<a name="line-650"></a>        <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-651"></a>
<a name="line-652"></a>
<a name="line-653"></a><a name="patchJumpInstr"></a><span class='hs-definition'>patchJumpInstr</span>
<a name="line-654"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Instr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockId</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Instr</span>
<a name="line-655"></a>
<a name="line-656"></a><span class='hs-definition'>patchJumpInstr</span> <span class='hs-varid'>insn</span> <span class='hs-varid'>patchF</span>
<a name="line-657"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>insn</span> <span class='hs-keyword'>of</span>
<a name="line-658"></a>        <span class='hs-conid'>JXX</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>id</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JXX</span> <span class='hs-varid'>cc</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchF</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-659"></a>        <span class='hs-conid'>JMP_TBL</span> <span class='hs-varid'>op</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>section</span> <span class='hs-varid'>lbl</span>
<a name="line-660"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JMP_TBL</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>patchJumpDest</span> <span class='hs-varid'>patchF</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span> <span class='hs-varid'>section</span> <span class='hs-varid'>lbl</span>
<a name="line-661"></a>        <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>insn</span>
<a name="line-662"></a>    <span class='hs-keyword'>where</span>
<a name="line-663"></a>        <span class='hs-varid'>patchJumpDest</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>DestBlockId</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DestBlockId</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-664"></a>        <span class='hs-varid'>patchJumpDest</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>dest</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dest</span>
<a name="line-665"></a>
<a name="line-666"></a>
<a name="line-667"></a>
<a name="line-668"></a>
<a name="line-669"></a>
<a name="line-670"></a><a name="mkSpillInstr"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-671"></a><span class='hs-comment'>-- | Make a spill instruction.</span>
<a name="line-672"></a><span class='hs-definition'>mkSpillInstr</span>
<a name="line-673"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NCGConfig</span>
<a name="line-674"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Reg</span>      <span class='hs-comment'>-- register to spill</span>
<a name="line-675"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>      <span class='hs-comment'>-- current stack delta</span>
<a name="line-676"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>      <span class='hs-comment'>-- spill slot to use</span>
<a name="line-677"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Instr</span><span class='hs-keyglyph'>]</span>
<a name="line-678"></a>
<a name="line-679"></a><span class='hs-definition'>mkSpillInstr</span> <span class='hs-varid'>config</span> <span class='hs-varid'>reg</span> <span class='hs-varid'>delta</span> <span class='hs-varid'>slot</span>
<a name="line-680"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>off</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>spillSlotToOffset</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>slot</span> <span class='hs-comment'>-</span> <span class='hs-varid'>delta</span>
<a name="line-681"></a>    <span class='hs-keyword'>in</span>
<a name="line-682"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>targetClassOfReg</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>reg</span> <span class='hs-keyword'>of</span>
<a name="line-683"></a>           <span class='hs-conid'>RcInteger</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MOV</span> <span class='hs-layout'>(</span><span class='hs-varid'>archWordFormat</span> <span class='hs-varid'>is32Bit</span><span class='hs-layout'>)</span>
<a name="line-684"></a>                                   <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpAddr</span> <span class='hs-layout'>(</span><span class='hs-varid'>spRel</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>off</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-685"></a>           <span class='hs-conid'>RcDouble</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MOV</span> <span class='hs-conid'>FF64</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpAddr</span> <span class='hs-layout'>(</span><span class='hs-varid'>spRel</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>off</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-686"></a>           <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"X86.mkSpillInstr: no match"</span>
<a name="line-687"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ncgPlatform</span> <span class='hs-varid'>config</span>
<a name="line-688"></a>          <span class='hs-varid'>is32Bit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>target32Bit</span> <span class='hs-varid'>platform</span>
<a name="line-689"></a>
<a name="line-690"></a><a name="mkLoadInstr"></a><span class='hs-comment'>-- | Make a spill reload instruction.</span>
<a name="line-691"></a><span class='hs-definition'>mkLoadInstr</span>
<a name="line-692"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NCGConfig</span>
<a name="line-693"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Reg</span>      <span class='hs-comment'>-- register to load</span>
<a name="line-694"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>      <span class='hs-comment'>-- current stack delta</span>
<a name="line-695"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>      <span class='hs-comment'>-- spill slot to use</span>
<a name="line-696"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Instr</span><span class='hs-keyglyph'>]</span>
<a name="line-697"></a>
<a name="line-698"></a><span class='hs-definition'>mkLoadInstr</span> <span class='hs-varid'>config</span> <span class='hs-varid'>reg</span> <span class='hs-varid'>delta</span> <span class='hs-varid'>slot</span>
<a name="line-699"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>off</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>spillSlotToOffset</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>slot</span> <span class='hs-comment'>-</span> <span class='hs-varid'>delta</span>
<a name="line-700"></a>    <span class='hs-keyword'>in</span>
<a name="line-701"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>targetClassOfReg</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>reg</span> <span class='hs-keyword'>of</span>
<a name="line-702"></a>              <span class='hs-conid'>RcInteger</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>MOV</span> <span class='hs-layout'>(</span><span class='hs-varid'>archWordFormat</span> <span class='hs-varid'>is32Bit</span><span class='hs-layout'>)</span>
<a name="line-703"></a>                                 <span class='hs-layout'>(</span><span class='hs-conid'>OpAddr</span> <span class='hs-layout'>(</span><span class='hs-varid'>spRel</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>off</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-704"></a>              <span class='hs-conid'>RcDouble</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>MOV</span> <span class='hs-conid'>FF64</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpAddr</span> <span class='hs-layout'>(</span><span class='hs-varid'>spRel</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>off</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-705"></a>              <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"X86.mkLoadInstr"</span>
<a name="line-706"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ncgPlatform</span> <span class='hs-varid'>config</span>
<a name="line-707"></a>          <span class='hs-varid'>is32Bit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>target32Bit</span> <span class='hs-varid'>platform</span>
<a name="line-708"></a>
<a name="line-709"></a><a name="spillSlotSize"></a><span class='hs-definition'>spillSlotSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-710"></a><span class='hs-definition'>spillSlotSize</span> <span class='hs-varid'>platform</span>
<a name="line-711"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>target32Bit</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>12</span>
<a name="line-712"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-num'>8</span>
<a name="line-713"></a>
<a name="line-714"></a><a name="maxSpillSlots"></a><span class='hs-definition'>maxSpillSlots</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NCGConfig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-715"></a><span class='hs-definition'>maxSpillSlots</span> <span class='hs-varid'>config</span>
<a name="line-716"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>ncgSpillPreallocSize</span> <span class='hs-varid'>config</span> <span class='hs-comment'>-</span> <span class='hs-num'>64</span><span class='hs-layout'>)</span> <span class='hs-varop'>`div`</span> <span class='hs-varid'>spillSlotSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncgPlatform</span> <span class='hs-varid'>config</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span>
<a name="line-717"></a><span class='hs-comment'>--  = 0 -- useful for testing allocMoreStack</span>
<a name="line-718"></a>
<a name="line-719"></a><a name="stackAlign"></a><span class='hs-comment'>-- number of bytes that the stack pointer should be aligned to</span>
<a name="line-720"></a><span class='hs-definition'>stackAlign</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-721"></a><span class='hs-definition'>stackAlign</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>16</span>
<a name="line-722"></a>
<a name="line-723"></a><a name="spillSlotToOffset"></a><span class='hs-comment'>-- convert a spill slot number to a *byte* offset, with no sign:</span>
<a name="line-724"></a><span class='hs-comment'>-- decide on a per arch basis whether you are spilling above or below</span>
<a name="line-725"></a><span class='hs-comment'>-- the C stack pointer.</span>
<a name="line-726"></a><span class='hs-definition'>spillSlotToOffset</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-727"></a><span class='hs-definition'>spillSlotToOffset</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>slot</span>
<a name="line-728"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-num'>64</span> <span class='hs-varop'>+</span> <span class='hs-varid'>spillSlotSize</span> <span class='hs-varid'>platform</span> <span class='hs-varop'>*</span> <span class='hs-varid'>slot</span>
<a name="line-729"></a>
<a name="line-730"></a><span class='hs-comment'>--------------------------------------------------------------------------------</span>
<a name="line-731"></a>
<a name="line-732"></a><a name="takeDeltaInstr"></a><span class='hs-comment'>-- | See if this instruction is telling us the current C stack delta</span>
<a name="line-733"></a><span class='hs-definition'>takeDeltaInstr</span>
<a name="line-734"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Instr</span>
<a name="line-735"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Int</span>
<a name="line-736"></a>
<a name="line-737"></a><span class='hs-definition'>takeDeltaInstr</span> <span class='hs-varid'>instr</span>
<a name="line-738"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>instr</span> <span class='hs-keyword'>of</span>
<a name="line-739"></a>        <span class='hs-conid'>DELTA</span> <span class='hs-varid'>i</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>i</span>
<a name="line-740"></a>        <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-741"></a>
<a name="line-742"></a>
<a name="line-743"></a><a name="isMetaInstr"></a><span class='hs-definition'>isMetaInstr</span>
<a name="line-744"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Instr</span>
<a name="line-745"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-746"></a>
<a name="line-747"></a><span class='hs-definition'>isMetaInstr</span> <span class='hs-varid'>instr</span>
<a name="line-748"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>instr</span> <span class='hs-keyword'>of</span>
<a name="line-749"></a>        <span class='hs-conid'>COMMENT</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-750"></a>        <span class='hs-conid'>LOCATION</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-751"></a>        <span class='hs-conid'>LDATA</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-752"></a>        <span class='hs-conid'>NEWBLOCK</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-753"></a>        <span class='hs-conid'>UNWIND</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-754"></a>        <span class='hs-conid'>DELTA</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-755"></a>        <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-756"></a>
<a name="line-757"></a>
<a name="line-758"></a>
<a name="line-759"></a><a name="mkRegRegMoveInstr"></a><span class='hs-comment'>---  TODO: why is there</span>
<a name="line-760"></a><span class='hs-comment'>-- | Make a reg-reg move instruction.</span>
<a name="line-761"></a><span class='hs-comment'>--      On SPARC v8 there are no instructions to move directly between</span>
<a name="line-762"></a><span class='hs-comment'>--      floating point and integer regs. If we need to do that then we</span>
<a name="line-763"></a><span class='hs-comment'>--      have to go via memory.</span>
<a name="line-764"></a><span class='hs-comment'>--</span>
<a name="line-765"></a><span class='hs-definition'>mkRegRegMoveInstr</span>
<a name="line-766"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span>
<a name="line-767"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Reg</span>
<a name="line-768"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Reg</span>
<a name="line-769"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Instr</span>
<a name="line-770"></a>
<a name="line-771"></a><span class='hs-definition'>mkRegRegMoveInstr</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dst</span>
<a name="line-772"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>targetClassOfReg</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>src</span> <span class='hs-keyword'>of</span>
<a name="line-773"></a>        <span class='hs-conid'>RcInteger</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>platformArch</span> <span class='hs-varid'>platform</span> <span class='hs-keyword'>of</span>
<a name="line-774"></a>                     <span class='hs-conid'>ArchX86</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOV</span> <span class='hs-conid'>II32</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-775"></a>                     <span class='hs-conid'>ArchX86_64</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOV</span> <span class='hs-conid'>II64</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-776"></a>                     <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"X86.mkRegRegMoveInstr: Bad arch"</span>
<a name="line-777"></a>        <span class='hs-conid'>RcDouble</span>    <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>MOV</span> <span class='hs-conid'>FF64</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>dst</span><span class='hs-layout'>)</span>
<a name="line-778"></a>        <span class='hs-comment'>-- this code is the lie we tell ourselves because both float and double</span>
<a name="line-779"></a>        <span class='hs-comment'>-- use the same register class.on x86_64 and x86 32bit with SSE2,</span>
<a name="line-780"></a>        <span class='hs-comment'>-- more plainly, both use the XMM registers</span>
<a name="line-781"></a>        <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"X86.RegInfo.mkRegRegMoveInstr: no match"</span>
<a name="line-782"></a>
<a name="line-783"></a><a name="takeRegRegMoveInstr"></a><span class='hs-comment'>-- | Check whether an instruction represents a reg-reg move.</span>
<a name="line-784"></a><span class='hs-comment'>--      The register allocator attempts to eliminate reg-&gt;reg moves whenever it can,</span>
<a name="line-785"></a><span class='hs-comment'>--      by assigning the src and dest temporaries to the same real register.</span>
<a name="line-786"></a><span class='hs-comment'>--</span>
<a name="line-787"></a><span class='hs-definition'>takeRegRegMoveInstr</span>
<a name="line-788"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Instr</span>
<a name="line-789"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Reg</span><span class='hs-layout'>,</span><span class='hs-conid'>Reg</span><span class='hs-layout'>)</span>
<a name="line-790"></a>
<a name="line-791"></a><span class='hs-definition'>takeRegRegMoveInstr</span> <span class='hs-layout'>(</span><span class='hs-conid'>MOV</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-792"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>r1</span><span class='hs-layout'>,</span><span class='hs-varid'>r2</span><span class='hs-layout'>)</span>
<a name="line-793"></a>
<a name="line-794"></a><span class='hs-definition'>takeRegRegMoveInstr</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-795"></a>
<a name="line-796"></a>
<a name="line-797"></a><a name="mkJumpInstr"></a><span class='hs-comment'>-- | Make an unconditional branch instruction.</span>
<a name="line-798"></a><span class='hs-definition'>mkJumpInstr</span>
<a name="line-799"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockId</span>
<a name="line-800"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Instr</span><span class='hs-keyglyph'>]</span>
<a name="line-801"></a>
<a name="line-802"></a><span class='hs-definition'>mkJumpInstr</span> <span class='hs-varid'>id</span>
<a name="line-803"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>JXX</span> <span class='hs-conid'>ALWAYS</span> <span class='hs-varid'>id</span><span class='hs-keyglyph'>]</span>
<a name="line-804"></a>
<a name="line-805"></a><a name="needs_probe_call"></a><span class='hs-comment'>-- Note [Windows stack layout]</span>
<a name="line-806"></a><span class='hs-comment'>-- | On most OSes the kernel will place a guard page after the current stack</span>
<a name="line-807"></a><span class='hs-comment'>--   page.  If you allocate larger than a page worth you may jump over this</span>
<a name="line-808"></a><span class='hs-comment'>--   guard page.  Not only is this a security issue, but on certain OSes such</span>
<a name="line-809"></a><span class='hs-comment'>--   as Windows a new page won't be allocated if you don't hit the guard.  This</span>
<a name="line-810"></a><span class='hs-comment'>--   will cause a segfault or access fault.</span>
<a name="line-811"></a><span class='hs-comment'>--</span>
<a name="line-812"></a><span class='hs-comment'>--   This function defines if the current allocation amount requires a probe.</span>
<a name="line-813"></a><span class='hs-comment'>--   On Windows (for now) we emit a call to _chkstk for this.  For other OSes</span>
<a name="line-814"></a><span class='hs-comment'>--   this is not yet implemented.</span>
<a name="line-815"></a><span class='hs-comment'>--   See https://docs.microsoft.com/en-us/windows/desktop/DevNotes/-win32-chkstk</span>
<a name="line-816"></a><span class='hs-comment'>--   The Windows stack looks like this:</span>
<a name="line-817"></a><span class='hs-comment'>--</span>
<a name="line-818"></a><span class='hs-comment'>--                         +-------------------+</span>
<a name="line-819"></a><span class='hs-comment'>--                         |        SP         |</span>
<a name="line-820"></a><span class='hs-comment'>--                         +-------------------+</span>
<a name="line-821"></a><span class='hs-comment'>--                         |                   |</span>
<a name="line-822"></a><span class='hs-comment'>--                         |    GUARD PAGE     |</span>
<a name="line-823"></a><span class='hs-comment'>--                         |                   |</span>
<a name="line-824"></a><span class='hs-comment'>--                         +-------------------+</span>
<a name="line-825"></a><span class='hs-comment'>--                         |                   |</span>
<a name="line-826"></a><span class='hs-comment'>--                         |                   |</span>
<a name="line-827"></a><span class='hs-comment'>--                         |     UNMAPPED      |</span>
<a name="line-828"></a><span class='hs-comment'>--                         |                   |</span>
<a name="line-829"></a><span class='hs-comment'>--                         |                   |</span>
<a name="line-830"></a><span class='hs-comment'>--                         +-------------------+</span>
<a name="line-831"></a><span class='hs-comment'>--</span>
<a name="line-832"></a><span class='hs-comment'>--   In essence each allocation larger than a page size needs to be chunked and</span>
<a name="line-833"></a><span class='hs-comment'>--   a probe emitted after each page allocation.  You have to hit the guard</span>
<a name="line-834"></a><span class='hs-comment'>--   page so the kernel can map in the next page, otherwise you'll segfault.</span>
<a name="line-835"></a><span class='hs-comment'>--   See Note [Windows stack allocations].</span>
<a name="line-836"></a><span class='hs-comment'>--</span>
<a name="line-837"></a><span class='hs-definition'>needs_probe_call</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-838"></a><span class='hs-definition'>needs_probe_call</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>amount</span>
<a name="line-839"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>platformOS</span> <span class='hs-varid'>platform</span> <span class='hs-keyword'>of</span>
<a name="line-840"></a>     <span class='hs-conid'>OSMinGW32</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>platformArch</span> <span class='hs-varid'>platform</span> <span class='hs-keyword'>of</span>
<a name="line-841"></a>                    <span class='hs-conid'>ArchX86</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>amount</span> <span class='hs-varop'>&gt;</span> <span class='hs-layout'>(</span><span class='hs-num'>4</span> <span class='hs-varop'>*</span> <span class='hs-num'>1024</span><span class='hs-layout'>)</span>
<a name="line-842"></a>                    <span class='hs-conid'>ArchX86_64</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>amount</span> <span class='hs-varop'>&gt;</span> <span class='hs-layout'>(</span><span class='hs-num'>4</span> <span class='hs-varop'>*</span> <span class='hs-num'>1024</span><span class='hs-layout'>)</span>
<a name="line-843"></a>                    <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-844"></a>     <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-845"></a>
<a name="line-846"></a><a name="mkStackAllocInstr"></a><span class='hs-definition'>mkStackAllocInstr</span>
<a name="line-847"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span>
<a name="line-848"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-849"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Instr</span><span class='hs-keyglyph'>]</span>
<a name="line-850"></a><span class='hs-definition'>mkStackAllocInstr</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>amount</span>
<a name="line-851"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>platformOS</span> <span class='hs-varid'>platform</span> <span class='hs-keyword'>of</span>
<a name="line-852"></a>      <span class='hs-conid'>OSMinGW32</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-853"></a>        <span class='hs-comment'>-- These will clobber AX but this should be ok because</span>
<a name="line-854"></a>        <span class='hs-comment'>--</span>
<a name="line-855"></a>        <span class='hs-comment'>-- 1. It is the first thing we do when entering the closure and AX is</span>
<a name="line-856"></a>        <span class='hs-comment'>--    a caller saved registers on Windows both on x86_64 and x86.</span>
<a name="line-857"></a>        <span class='hs-comment'>--</span>
<a name="line-858"></a>        <span class='hs-comment'>-- 2. The closures are only entered via a call or longjmp in which case</span>
<a name="line-859"></a>        <span class='hs-comment'>--    there are no expectations for volatile registers.</span>
<a name="line-860"></a>        <span class='hs-comment'>--</span>
<a name="line-861"></a>        <span class='hs-comment'>-- 3. When the target is a local branch point it is re-targeted</span>
<a name="line-862"></a>        <span class='hs-comment'>--    after the dealloc, preserving #2.  See note [extra spill slots].</span>
<a name="line-863"></a>        <span class='hs-comment'>--</span>
<a name="line-864"></a>        <span class='hs-comment'>-- We emit a call because the stack probes are quite involved and</span>
<a name="line-865"></a>        <span class='hs-comment'>-- would bloat code size a lot.  GHC doesn't really have an -Os.</span>
<a name="line-866"></a>        <span class='hs-comment'>-- ___chkstk is guaranteed to leave all nonvolatile registers and AX</span>
<a name="line-867"></a>        <span class='hs-comment'>-- untouched.  It's part of the standard prologue code for any Windows</span>
<a name="line-868"></a>        <span class='hs-comment'>-- function dropping the stack more than a page.</span>
<a name="line-869"></a>        <span class='hs-comment'>-- See Note [Windows stack layout]</span>
<a name="line-870"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>platformArch</span> <span class='hs-varid'>platform</span> <span class='hs-keyword'>of</span>
<a name="line-871"></a>            <span class='hs-conid'>ArchX86</span>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>needs_probe_call</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>amount</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-872"></a>                           <span class='hs-keyglyph'>[</span> <span class='hs-conid'>MOV</span> <span class='hs-conid'>II32</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpImm</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImmInt</span> <span class='hs-varid'>amount</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>eax</span><span class='hs-layout'>)</span>
<a name="line-873"></a>                           <span class='hs-layout'>,</span> <span class='hs-conid'>CALL</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varop'>$</span> <span class='hs-varid'>strImmLit</span> <span class='hs-str'>"___chkstk_ms"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>eax</span><span class='hs-keyglyph'>]</span>
<a name="line-874"></a>                           <span class='hs-layout'>,</span> <span class='hs-conid'>SUB</span> <span class='hs-conid'>II32</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>eax</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>esp</span><span class='hs-layout'>)</span>
<a name="line-875"></a>                           <span class='hs-keyglyph'>]</span>
<a name="line-876"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-877"></a>                           <span class='hs-keyglyph'>[</span> <span class='hs-conid'>SUB</span> <span class='hs-conid'>II32</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpImm</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImmInt</span> <span class='hs-varid'>amount</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>esp</span><span class='hs-layout'>)</span>
<a name="line-878"></a>                           <span class='hs-layout'>,</span> <span class='hs-conid'>TEST</span> <span class='hs-conid'>II32</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>esp</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>esp</span><span class='hs-layout'>)</span>
<a name="line-879"></a>                           <span class='hs-keyglyph'>]</span>
<a name="line-880"></a>            <span class='hs-conid'>ArchX86_64</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>needs_probe_call</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>amount</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-881"></a>                           <span class='hs-keyglyph'>[</span> <span class='hs-conid'>MOV</span> <span class='hs-conid'>II64</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpImm</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImmInt</span> <span class='hs-varid'>amount</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>rax</span><span class='hs-layout'>)</span>
<a name="line-882"></a>                           <span class='hs-layout'>,</span> <span class='hs-conid'>CALL</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varop'>$</span> <span class='hs-varid'>strImmLit</span> <span class='hs-str'>"___chkstk_ms"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>rax</span><span class='hs-keyglyph'>]</span>
<a name="line-883"></a>                           <span class='hs-layout'>,</span> <span class='hs-conid'>SUB</span> <span class='hs-conid'>II64</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>rax</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>rsp</span><span class='hs-layout'>)</span>
<a name="line-884"></a>                           <span class='hs-keyglyph'>]</span>
<a name="line-885"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-886"></a>                           <span class='hs-keyglyph'>[</span> <span class='hs-conid'>SUB</span> <span class='hs-conid'>II64</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpImm</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImmInt</span> <span class='hs-varid'>amount</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>rsp</span><span class='hs-layout'>)</span>
<a name="line-887"></a>                           <span class='hs-layout'>,</span> <span class='hs-conid'>TEST</span> <span class='hs-conid'>II64</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>rsp</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>rsp</span><span class='hs-layout'>)</span>
<a name="line-888"></a>                           <span class='hs-keyglyph'>]</span>
<a name="line-889"></a>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"X86.mkStackAllocInstr"</span>
<a name="line-890"></a>      <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span>
<a name="line-891"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>platformArch</span> <span class='hs-varid'>platform</span> <span class='hs-keyword'>of</span>
<a name="line-892"></a>          <span class='hs-conid'>ArchX86</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>SUB</span> <span class='hs-conid'>II32</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpImm</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImmInt</span> <span class='hs-varid'>amount</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>esp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-893"></a>          <span class='hs-conid'>ArchX86_64</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>SUB</span> <span class='hs-conid'>II64</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpImm</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImmInt</span> <span class='hs-varid'>amount</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>rsp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-894"></a>          <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"X86.mkStackAllocInstr"</span>
<a name="line-895"></a>
<a name="line-896"></a><a name="mkStackDeallocInstr"></a><span class='hs-definition'>mkStackDeallocInstr</span>
<a name="line-897"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span>
<a name="line-898"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-899"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Instr</span><span class='hs-keyglyph'>]</span>
<a name="line-900"></a><span class='hs-definition'>mkStackDeallocInstr</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>amount</span>
<a name="line-901"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>platformArch</span> <span class='hs-varid'>platform</span> <span class='hs-keyword'>of</span>
<a name="line-902"></a>      <span class='hs-conid'>ArchX86</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ADD</span> <span class='hs-conid'>II32</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpImm</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImmInt</span> <span class='hs-varid'>amount</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>esp</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-903"></a>      <span class='hs-conid'>ArchX86_64</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ADD</span> <span class='hs-conid'>II64</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpImm</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImmInt</span> <span class='hs-varid'>amount</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpReg</span> <span class='hs-varid'>rsp</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-904"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"X86.mkStackDeallocInstr"</span>
<a name="line-905"></a>
<a name="line-906"></a>
<a name="line-907"></a><a name="allocMoreStack"></a><span class='hs-comment'>--</span>
<a name="line-908"></a><span class='hs-comment'>-- Note [extra spill slots]</span>
<a name="line-909"></a><span class='hs-comment'>--</span>
<a name="line-910"></a><span class='hs-comment'>-- If the register allocator used more spill slots than we have</span>
<a name="line-911"></a><span class='hs-comment'>-- pre-allocated (rESERVED_C_STACK_BYTES), then we must allocate more</span>
<a name="line-912"></a><span class='hs-comment'>-- C stack space on entry and exit from this proc.  Therefore we</span>
<a name="line-913"></a><span class='hs-comment'>-- insert a "sub $N, %rsp" at every entry point, and an "add $N, %rsp"</span>
<a name="line-914"></a><span class='hs-comment'>-- before every non-local jump.</span>
<a name="line-915"></a><span class='hs-comment'>--</span>
<a name="line-916"></a><span class='hs-comment'>-- This became necessary when the new codegen started bundling entire</span>
<a name="line-917"></a><span class='hs-comment'>-- functions together into one proc, because the register allocator</span>
<a name="line-918"></a><span class='hs-comment'>-- assigns a different stack slot to each virtual reg within a proc.</span>
<a name="line-919"></a><span class='hs-comment'>-- To avoid using so many slots we could also:</span>
<a name="line-920"></a><span class='hs-comment'>--</span>
<a name="line-921"></a><span class='hs-comment'>--   - split up the proc into connected components before code generator</span>
<a name="line-922"></a><span class='hs-comment'>--</span>
<a name="line-923"></a><span class='hs-comment'>--   - rename the virtual regs, so that we re-use vreg names and hence</span>
<a name="line-924"></a><span class='hs-comment'>--     stack slots for non-overlapping vregs.</span>
<a name="line-925"></a><span class='hs-comment'>--</span>
<a name="line-926"></a><span class='hs-comment'>-- Note that when a block is both a non-local entry point (with an</span>
<a name="line-927"></a><span class='hs-comment'>-- info table) and a local branch target, we have to split it into</span>
<a name="line-928"></a><span class='hs-comment'>-- two, like so:</span>
<a name="line-929"></a><span class='hs-comment'>--</span>
<a name="line-930"></a><span class='hs-comment'>--    &lt;info table&gt;</span>
<a name="line-931"></a><span class='hs-comment'>--    L:</span>
<a name="line-932"></a><span class='hs-comment'>--       &lt;code&gt;</span>
<a name="line-933"></a><span class='hs-comment'>--</span>
<a name="line-934"></a><span class='hs-comment'>-- becomes</span>
<a name="line-935"></a><span class='hs-comment'>--</span>
<a name="line-936"></a><span class='hs-comment'>--    &lt;info table&gt;</span>
<a name="line-937"></a><span class='hs-comment'>--    L:</span>
<a name="line-938"></a><span class='hs-comment'>--       subl $rsp, N</span>
<a name="line-939"></a><span class='hs-comment'>--       jmp Lnew</span>
<a name="line-940"></a><span class='hs-comment'>--    Lnew:</span>
<a name="line-941"></a><span class='hs-comment'>--       &lt;code&gt;</span>
<a name="line-942"></a><span class='hs-comment'>--</span>
<a name="line-943"></a><span class='hs-comment'>-- and all branches pointing to L are retargetted to point to Lnew.</span>
<a name="line-944"></a><span class='hs-comment'>-- Otherwise, we would repeat the $rsp adjustment for each branch to</span>
<a name="line-945"></a><span class='hs-comment'>-- L.</span>
<a name="line-946"></a><span class='hs-comment'>--</span>
<a name="line-947"></a><span class='hs-comment'>-- Returns a list of (L,Lnew) pairs.</span>
<a name="line-948"></a><span class='hs-comment'>--</span>
<a name="line-949"></a><span class='hs-definition'>allocMoreStack</span>
<a name="line-950"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span>
<a name="line-951"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-952"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NatCmmDecl</span> <span class='hs-varid'>statics</span> <span class='hs-conid'>GHC.CmmToAsm.X86.Instr.Instr</span>
<a name="line-953"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>NatCmmDecl</span> <span class='hs-varid'>statics</span> <span class='hs-conid'>GHC.CmmToAsm.X86.Instr.Instr</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>BlockId</span><span class='hs-layout'>,</span><span class='hs-conid'>BlockId</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-954"></a>
<a name="line-955"></a><span class='hs-definition'>allocMoreStack</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>top</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CmmData</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>top</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-956"></a><span class='hs-definition'>allocMoreStack</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>slots</span> <span class='hs-varid'>proc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CmmProc</span> <span class='hs-varid'>info</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>live</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListGraph</span> <span class='hs-varid'>code</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-957"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>entries</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>entryBlocks</span> <span class='hs-varid'>proc</span>
<a name="line-958"></a>
<a name="line-959"></a>    <span class='hs-varid'>uniqs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>replicateM</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>entries</span><span class='hs-layout'>)</span> <span class='hs-varid'>getUniqueM</span>
<a name="line-960"></a>
<a name="line-961"></a>    <span class='hs-keyword'>let</span>
<a name="line-962"></a>      <span class='hs-varid'>delta</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>x</span> <span class='hs-varop'>+</span> <span class='hs-varid'>stackAlign</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varop'>`quot`</span> <span class='hs-varid'>stackAlign</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-varid'>stackAlign</span> <span class='hs-comment'>-- round up</span>
<a name="line-963"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>slots</span> <span class='hs-varop'>*</span> <span class='hs-varid'>spillSlotSize</span> <span class='hs-varid'>platform</span> <span class='hs-comment'>-- sp delta</span>
<a name="line-964"></a>
<a name="line-965"></a>      <span class='hs-varid'>alloc</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkStackAllocInstr</span>   <span class='hs-varid'>platform</span> <span class='hs-varid'>delta</span>
<a name="line-966"></a>      <span class='hs-varid'>dealloc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkStackDeallocInstr</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>delta</span>
<a name="line-967"></a>
<a name="line-968"></a>      <span class='hs-varid'>retargetList</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-varid'>entries</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mkBlockId</span> <span class='hs-varid'>uniqs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-969"></a>
<a name="line-970"></a>      <span class='hs-varid'>new_blockmap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>BlockId</span>
<a name="line-971"></a>      <span class='hs-varid'>new_blockmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapFromList</span> <span class='hs-varid'>retargetList</span>
<a name="line-972"></a>
<a name="line-973"></a>      <span class='hs-varid'>insert_stack_insns</span> <span class='hs-layout'>(</span><span class='hs-conid'>BasicBlock</span> <span class='hs-varid'>id</span> <span class='hs-varid'>insns</span><span class='hs-layout'>)</span>
<a name="line-974"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>new_blockid</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapLookup</span> <span class='hs-varid'>id</span> <span class='hs-varid'>new_blockmap</span>
<a name="line-975"></a>         <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>BasicBlock</span> <span class='hs-varid'>id</span> <span class='hs-varop'>$</span> <span class='hs-varid'>alloc</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>JXX</span> <span class='hs-conid'>ALWAYS</span> <span class='hs-varid'>new_blockid</span><span class='hs-keyglyph'>]</span>
<a name="line-976"></a>           <span class='hs-layout'>,</span> <span class='hs-conid'>BasicBlock</span> <span class='hs-varid'>new_blockid</span> <span class='hs-varid'>block'</span> <span class='hs-keyglyph'>]</span>
<a name="line-977"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-978"></a>         <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>BasicBlock</span> <span class='hs-varid'>id</span> <span class='hs-varid'>block'</span> <span class='hs-keyglyph'>]</span>
<a name="line-979"></a>         <span class='hs-keyword'>where</span>
<a name="line-980"></a>           <span class='hs-varid'>block'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>insert_dealloc</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>insns</span>
<a name="line-981"></a>
<a name="line-982"></a>      <span class='hs-varid'>insert_dealloc</span> <span class='hs-varid'>insn</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>insn</span> <span class='hs-keyword'>of</span>
<a name="line-983"></a>         <span class='hs-conid'>JMP</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>dealloc</span> <span class='hs-varop'>++</span> <span class='hs-layout'>(</span><span class='hs-varid'>insn</span> <span class='hs-conop'>:</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-984"></a>         <span class='hs-conid'>JXX_GBL</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"insert_dealloc: cannot handle JXX_GBL"</span>
<a name="line-985"></a>         <span class='hs-sel'>_other</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patchJumpInstr</span> <span class='hs-varid'>insn</span> <span class='hs-varid'>retarget</span> <span class='hs-conop'>:</span> <span class='hs-varid'>r</span>
<a name="line-986"></a>           <span class='hs-keyword'>where</span> <span class='hs-varid'>retarget</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromMaybe</span> <span class='hs-varid'>b</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapLookup</span> <span class='hs-varid'>b</span> <span class='hs-varid'>new_blockmap</span><span class='hs-layout'>)</span>
<a name="line-987"></a>
<a name="line-988"></a>      <span class='hs-varid'>new_code</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>insert_stack_insns</span> <span class='hs-varid'>code</span>
<a name="line-989"></a>    <span class='hs-comment'>-- in</span>
<a name="line-990"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmProc</span> <span class='hs-varid'>info</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>live</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListGraph</span> <span class='hs-varid'>new_code</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>retargetList</span><span class='hs-layout'>)</span>
<a name="line-991"></a>
<a name="line-992"></a><a name="JumpDest"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>JumpDest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DestBlockId</span> <span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DestImm</span> <span class='hs-conid'>Imm</span>
<a name="line-993"></a>
<a name="line-994"></a><a name="instance%20Outputable%20JumpDest"></a><span class='hs-comment'>-- Debug Instance</span>
<a name="line-995"></a><a name="instance%20Outputable%20JumpDest"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>JumpDest</span> <span class='hs-keyword'>where</span>
<a name="line-996"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>DestBlockId</span> <span class='hs-varid'>bid</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"jd&lt;blk&gt;:"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bid</span>
<a name="line-997"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>DestImm</span> <span class='hs-sel'>_imm</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"jd&lt;imm&gt;:noShow"</span>
<a name="line-998"></a>
<a name="line-999"></a>
<a name="line-1000"></a><a name="getJumpDestBlockId"></a><span class='hs-definition'>getJumpDestBlockId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JumpDest</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>BlockId</span>
<a name="line-1001"></a><span class='hs-definition'>getJumpDestBlockId</span> <span class='hs-layout'>(</span><span class='hs-conid'>DestBlockId</span> <span class='hs-varid'>bid</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>bid</span>
<a name="line-1002"></a><span class='hs-definition'>getJumpDestBlockId</span> <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1003"></a>
<a name="line-1004"></a><a name="canShortcut"></a><span class='hs-definition'>canShortcut</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Instr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>JumpDest</span>
<a name="line-1005"></a><span class='hs-definition'>canShortcut</span> <span class='hs-layout'>(</span><span class='hs-conid'>JXX</span> <span class='hs-conid'>ALWAYS</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>DestBlockId</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-1006"></a><span class='hs-definition'>canShortcut</span> <span class='hs-layout'>(</span><span class='hs-conid'>JMP</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpImm</span> <span class='hs-varid'>imm</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>DestImm</span> <span class='hs-varid'>imm</span><span class='hs-layout'>)</span>
<a name="line-1007"></a><span class='hs-definition'>canShortcut</span> <span class='hs-keyword'>_</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1008"></a>
<a name="line-1009"></a>
<a name="line-1010"></a><a name="shortcutJump"></a><span class='hs-comment'>-- This helper shortcuts a sequence of branches.</span>
<a name="line-1011"></a><span class='hs-comment'>-- The blockset helps avoid following cycles.</span>
<a name="line-1012"></a><span class='hs-definition'>shortcutJump</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>JumpDest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Instr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Instr</span>
<a name="line-1013"></a><span class='hs-definition'>shortcutJump</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>insn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>shortcutJump'</span> <span class='hs-varid'>fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>setEmpty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LabelSet</span><span class='hs-layout'>)</span> <span class='hs-varid'>insn</span>
<a name="line-1014"></a>  <span class='hs-keyword'>where</span>
<a name="line-1015"></a>    <span class='hs-varid'>shortcutJump'</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>JumpDest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LabelSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Instr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Instr</span>
<a name="line-1016"></a>    <span class='hs-varid'>shortcutJump'</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>seen</span> <span class='hs-varid'>insn</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>JXX</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1017"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>setMember</span> <span class='hs-varid'>id</span> <span class='hs-varid'>seen</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>insn</span>
<a name="line-1018"></a>        <span class='hs-keyword'>else</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-1019"></a>            <span class='hs-conid'>Nothing</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>insn</span>
<a name="line-1020"></a>            <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>DestBlockId</span> <span class='hs-varid'>id'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>shortcutJump'</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>seen'</span> <span class='hs-layout'>(</span><span class='hs-conid'>JXX</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>id'</span><span class='hs-layout'>)</span>
<a name="line-1021"></a>            <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>DestImm</span> <span class='hs-varid'>imm</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>shortcutJump'</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>seen'</span> <span class='hs-layout'>(</span><span class='hs-conid'>JXX_GBL</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>imm</span><span class='hs-layout'>)</span>
<a name="line-1022"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>seen'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setInsert</span> <span class='hs-varid'>id</span> <span class='hs-varid'>seen</span>
<a name="line-1023"></a>    <span class='hs-varid'>shortcutJump'</span> <span class='hs-varid'>fn</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>JMP_TBL</span> <span class='hs-varid'>addr</span> <span class='hs-varid'>blocks</span> <span class='hs-varid'>section</span> <span class='hs-varid'>tblId</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1024"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>updateBlock</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>DestBlockId</span> <span class='hs-varid'>bid</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span>
<a name="line-1025"></a>                <span class='hs-keyword'>case</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>bid</span> <span class='hs-keyword'>of</span>
<a name="line-1026"></a>                    <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>DestBlockId</span> <span class='hs-varid'>bid</span> <span class='hs-layout'>)</span>
<a name="line-1027"></a>                    <span class='hs-conid'>Just</span> <span class='hs-varid'>dest</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>dest</span>
<a name="line-1028"></a>            <span class='hs-varid'>updateBlock</span> <span class='hs-varid'>dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dest</span>
<a name="line-1029"></a>            <span class='hs-varid'>blocks'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>updateBlock</span> <span class='hs-varid'>blocks</span>
<a name="line-1030"></a>        <span class='hs-keyword'>in</span>  <span class='hs-conid'>JMP_TBL</span> <span class='hs-varid'>addr</span> <span class='hs-varid'>blocks'</span> <span class='hs-varid'>section</span> <span class='hs-varid'>tblId</span>
<a name="line-1031"></a>    <span class='hs-varid'>shortcutJump'</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>other</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>other</span>
<a name="line-1032"></a>
<a name="line-1033"></a><a name="shortcutStatics"></a><span class='hs-comment'>-- Here because it knows about JumpDest</span>
<a name="line-1034"></a><span class='hs-definition'>shortcutStatics</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>JumpDest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Alignment</span><span class='hs-layout'>,</span> <span class='hs-conid'>RawCmmStatics</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Alignment</span><span class='hs-layout'>,</span> <span class='hs-conid'>RawCmmStatics</span><span class='hs-layout'>)</span>
<a name="line-1035"></a><span class='hs-definition'>shortcutStatics</span> <span class='hs-varid'>fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>align</span><span class='hs-layout'>,</span> <span class='hs-conid'>CmmStaticsRaw</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>statics</span><span class='hs-layout'>)</span>
<a name="line-1036"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>align</span><span class='hs-layout'>,</span> <span class='hs-conid'>CmmStaticsRaw</span> <span class='hs-varid'>lbl</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>shortcutStatic</span> <span class='hs-varid'>fn</span><span class='hs-layout'>)</span> <span class='hs-varid'>statics</span><span class='hs-layout'>)</span>
<a name="line-1037"></a>  <span class='hs-comment'>-- we need to get the jump tables, so apply the mapping to the entries</span>
<a name="line-1038"></a>  <span class='hs-comment'>-- of a CmmData too.</span>
<a name="line-1039"></a>
<a name="line-1040"></a><a name="shortcutLabel"></a><span class='hs-definition'>shortcutLabel</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>JumpDest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CLabel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CLabel</span>
<a name="line-1041"></a><span class='hs-definition'>shortcutLabel</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>lab</span>
<a name="line-1042"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>blkId</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeLocalBlockLabel</span> <span class='hs-varid'>lab</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>shortBlockId</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>emptyUniqSet</span> <span class='hs-varid'>blkId</span>
<a name="line-1043"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lab</span>
<a name="line-1044"></a>
<a name="line-1045"></a><a name="shortcutStatic"></a><span class='hs-definition'>shortcutStatic</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>JumpDest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmStatic</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmStatic</span>
<a name="line-1046"></a><span class='hs-definition'>shortcutStatic</span> <span class='hs-varid'>fn</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmStaticLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLabel</span> <span class='hs-varid'>lab</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1047"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmStaticLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLabel</span> <span class='hs-layout'>(</span><span class='hs-varid'>shortcutLabel</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>lab</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1048"></a><span class='hs-definition'>shortcutStatic</span> <span class='hs-varid'>fn</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmStaticLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLabelDiffOff</span> <span class='hs-varid'>lbl1</span> <span class='hs-varid'>lbl2</span> <span class='hs-varid'>off</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1049"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmStaticLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLabelDiffOff</span> <span class='hs-layout'>(</span><span class='hs-varid'>shortcutLabel</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>lbl1</span><span class='hs-layout'>)</span> <span class='hs-varid'>lbl2</span> <span class='hs-varid'>off</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span>
<a name="line-1050"></a>        <span class='hs-comment'>-- slightly dodgy, we're ignoring the second label, but this</span>
<a name="line-1051"></a>        <span class='hs-comment'>-- works with the way we use CmmLabelDiffOff for jump tables now.</span>
<a name="line-1052"></a><span class='hs-definition'>shortcutStatic</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>other_static</span>
<a name="line-1053"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>other_static</span>
<a name="line-1054"></a>
<a name="line-1055"></a><a name="shortBlockId"></a><span class='hs-definition'>shortBlockId</span>
<a name="line-1056"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>JumpDest</span><span class='hs-layout'>)</span>
<a name="line-1057"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSet</span> <span class='hs-conid'>Unique</span>
<a name="line-1058"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockId</span>
<a name="line-1059"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CLabel</span>
<a name="line-1060"></a>
<a name="line-1061"></a><span class='hs-definition'>shortBlockId</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>seen</span> <span class='hs-varid'>blockid</span> <span class='hs-keyglyph'>=</span>
<a name="line-1062"></a>  <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>elementOfUniqSet</span> <span class='hs-varid'>uq</span> <span class='hs-varid'>seen</span><span class='hs-layout'>,</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>blockid</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1063"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>blockLbl</span> <span class='hs-varid'>blockid</span>
<a name="line-1064"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>blockLbl</span> <span class='hs-varid'>blockid</span>
<a name="line-1065"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>DestBlockId</span> <span class='hs-varid'>blockid'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>shortBlockId</span> <span class='hs-varid'>fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>addOneToUniqSet</span> <span class='hs-varid'>seen</span> <span class='hs-varid'>uq</span><span class='hs-layout'>)</span> <span class='hs-varid'>blockid'</span>
<a name="line-1066"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>DestImm</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImmCLbl</span> <span class='hs-varid'>lbl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lbl</span>
<a name="line-1067"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-sel'>_other</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"shortBlockId"</span>
<a name="line-1068"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>uq</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUnique</span> <span class='hs-varid'>blockid</span>
</pre></body>
</html>
