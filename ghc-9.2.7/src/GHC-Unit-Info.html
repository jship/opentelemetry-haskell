<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Unit/Info.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP, RecordWildCards, FlexibleInstances, MultiParamTypeClasses #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-comment'>-- | Info about installed units (compiled libraries)</span>
<a name="line-4"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Unit.Info</span>
<a name="line-5"></a>   <span class='hs-layout'>(</span> <span class='hs-conid'>GenericUnitInfo</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-6"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>GenUnitInfo</span>
<a name="line-7"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>UnitInfo</span>
<a name="line-8"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>UnitKey</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-9"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>UnitKeyInfo</span>
<a name="line-10"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mkUnitKeyInfo</span>
<a name="line-11"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mapUnitInfo</span>
<a name="line-12"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mkUnitPprInfo</span>
<a name="line-13"></a>
<a name="line-14"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mkUnit</span>
<a name="line-15"></a>
<a name="line-16"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>PackageId</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-17"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>PackageName</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-18"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>Version</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-19"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitPackageNameString</span>
<a name="line-20"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitPackageIdString</span>
<a name="line-21"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>pprUnitInfo</span>
<a name="line-22"></a>
<a name="line-23"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>collectIncludeDirs</span>
<a name="line-24"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>collectExtraCcOpts</span>
<a name="line-25"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>collectLibraryDirs</span>
<a name="line-26"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>collectFrameworks</span>
<a name="line-27"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>collectFrameworksDirs</span>
<a name="line-28"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>unitHsLibs</span>
<a name="line-29"></a>   <span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-keyword'>where</span>
<a name="line-31"></a>
<a name="line-32"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Platform.Ways</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-40"></a>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique</span>
<a name="line-42"></a>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.FastString</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.Data.ShortText</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>ST</span>
<a name="line-45"></a>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Module</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Ppr</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Database</span>
<a name="line-49"></a>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Settings</span>
<a name="line-51"></a>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Version</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Bifunctor</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List</span> <span class='hs-layout'>(</span><span class='hs-varid'>isPrefixOf</span><span class='hs-layout'>,</span> <span class='hs-varid'>stripPrefix</span><span class='hs-layout'>)</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.Set</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Set</span>
<a name="line-56"></a>
<a name="line-57"></a>
<a name="line-58"></a><a name="GenUnitInfo"></a><span class='hs-comment'>-- | Information about an installed unit</span>
<a name="line-59"></a><a name="GenUnitInfo"></a><span class='hs-comment'>--</span>
<a name="line-60"></a><a name="GenUnitInfo"></a><span class='hs-comment'>-- We parameterize on the unit identifier:</span>
<a name="line-61"></a><a name="GenUnitInfo"></a><span class='hs-comment'>--    * UnitKey: identifier used in the database (cf 'UnitKeyInfo')</span>
<a name="line-62"></a><a name="GenUnitInfo"></a><span class='hs-comment'>--    * UnitId: identifier used to generate code (cf 'UnitInfo')</span>
<a name="line-63"></a><a name="GenUnitInfo"></a><span class='hs-comment'>--</span>
<a name="line-64"></a><a name="GenUnitInfo"></a><span class='hs-comment'>-- These two identifiers are different for wired-in packages. See Note [About</span>
<a name="line-65"></a><a name="GenUnitInfo"></a><span class='hs-comment'>-- Units] in "GHC.Unit"</span>
<a name="line-66"></a><a name="GenUnitInfo"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>GenUnitInfo</span> <span class='hs-varid'>unit</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GenericUnitInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Indefinite</span> <span class='hs-varid'>unit</span><span class='hs-layout'>)</span> <span class='hs-conid'>PackageId</span> <span class='hs-conid'>PackageName</span> <span class='hs-varid'>unit</span> <span class='hs-conid'>ModuleName</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenModule</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenUnit</span> <span class='hs-varid'>unit</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-67"></a>
<a name="line-68"></a><a name="UnitKeyInfo"></a><span class='hs-comment'>-- | Information about an installed unit (units are identified by their database</span>
<a name="line-69"></a><a name="UnitKeyInfo"></a><span class='hs-comment'>-- UnitKey)</span>
<a name="line-70"></a><a name="UnitKeyInfo"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>UnitKeyInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GenUnitInfo</span> <span class='hs-conid'>UnitKey</span>
<a name="line-71"></a>
<a name="line-72"></a><a name="UnitInfo"></a><span class='hs-comment'>-- | Information about an installed unit (units are identified by their internal</span>
<a name="line-73"></a><a name="UnitInfo"></a><span class='hs-comment'>-- UnitId)</span>
<a name="line-74"></a><a name="UnitInfo"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>UnitInfo</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GenUnitInfo</span> <span class='hs-conid'>UnitId</span>
<a name="line-75"></a>
<a name="line-76"></a><a name="mkUnitKeyInfo"></a><span class='hs-comment'>-- | Convert a DbUnitInfo (read from a package database) into `UnitKeyInfo`</span>
<a name="line-77"></a><span class='hs-definition'>mkUnitKeyInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DbUnitInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnitKeyInfo</span>
<a name="line-78"></a><span class='hs-definition'>mkUnitKeyInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapGenericUnitInfo</span>
<a name="line-79"></a>   <span class='hs-varid'>mkUnitKey'</span>
<a name="line-80"></a>   <span class='hs-varid'>mkIndefUnitKey'</span>
<a name="line-81"></a>   <span class='hs-varid'>mkPackageIdentifier'</span>
<a name="line-82"></a>   <span class='hs-varid'>mkPackageName'</span>
<a name="line-83"></a>   <span class='hs-varid'>mkModuleName'</span>
<a name="line-84"></a>   <span class='hs-varid'>mkModule'</span>
<a name="line-85"></a>   <span class='hs-keyword'>where</span>
<a name="line-86"></a>     <span class='hs-varid'>mkPackageIdentifier'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PackageId</span>      <span class='hs-varop'>.</span> <span class='hs-varid'>mkFastStringByteString</span>
<a name="line-87"></a>     <span class='hs-varid'>mkPackageName'</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PackageName</span>    <span class='hs-varop'>.</span> <span class='hs-varid'>mkFastStringByteString</span>
<a name="line-88"></a>     <span class='hs-varid'>mkUnitKey'</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnitKey</span>        <span class='hs-varop'>.</span> <span class='hs-varid'>mkFastStringByteString</span>
<a name="line-89"></a>     <span class='hs-varid'>mkModuleName'</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkModuleNameFS</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mkFastStringByteString</span>
<a name="line-90"></a>     <span class='hs-varid'>mkIndefUnitKey'</span> <span class='hs-varid'>cid</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Indefinite</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkUnitKey'</span> <span class='hs-varid'>cid</span><span class='hs-layout'>)</span>
<a name="line-91"></a>     <span class='hs-varid'>mkVirtUnitKey'</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>i</span> <span class='hs-keyword'>of</span>
<a name="line-92"></a>      <span class='hs-conid'>DbInstUnitId</span> <span class='hs-varid'>cid</span> <span class='hs-varid'>insts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkVirtUnit</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIndefUnitKey'</span> <span class='hs-varid'>cid</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>bimap</span> <span class='hs-varid'>mkModuleName'</span> <span class='hs-varid'>mkModule'</span><span class='hs-layout'>)</span> <span class='hs-varid'>insts</span><span class='hs-layout'>)</span>
<a name="line-93"></a>      <span class='hs-conid'>DbUnitId</span> <span class='hs-varid'>uid</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RealUnit</span> <span class='hs-layout'>(</span><span class='hs-conid'>Definite</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkUnitKey'</span> <span class='hs-varid'>uid</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-94"></a>     <span class='hs-varid'>mkModule'</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>of</span>
<a name="line-95"></a>       <span class='hs-conid'>DbModule</span> <span class='hs-varid'>uid</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVirtUnitKey'</span> <span class='hs-varid'>uid</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkModuleName'</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-96"></a>       <span class='hs-conid'>DbModuleVar</span>  <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkHoleModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkModuleName'</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-97"></a>
<a name="line-98"></a><a name="mapUnitInfo"></a><span class='hs-comment'>-- | Map over the unit parameter</span>
<a name="line-99"></a><span class='hs-definition'>mapUnitInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IsUnitId</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>u</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GenUnitInfo</span> <span class='hs-varid'>u</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GenUnitInfo</span> <span class='hs-varid'>v</span>
<a name="line-100"></a><span class='hs-definition'>mapUnitInfo</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapGenericUnitInfo</span>
<a name="line-101"></a>   <span class='hs-varid'>f</span>         <span class='hs-comment'>-- unit identifier</span>
<a name="line-102"></a>   <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- indefinite unit identifier</span>
<a name="line-103"></a>   <span class='hs-varid'>id</span>        <span class='hs-comment'>-- package identifier</span>
<a name="line-104"></a>   <span class='hs-varid'>id</span>        <span class='hs-comment'>-- package name</span>
<a name="line-105"></a>   <span class='hs-varid'>id</span>        <span class='hs-comment'>-- module name</span>
<a name="line-106"></a>   <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapGenUnit</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- instantiating modules</span>
<a name="line-107"></a>
<a name="line-108"></a><a name="PackageId"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>PackageId</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PackageId</span>    <span class='hs-conid'>FastString</span> <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>)</span>
<a name="line-109"></a><a name="PackageName"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>PackageName</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PackageName</span>
<a name="line-110"></a>   <span class='hs-layout'>{</span> <span class='hs-varid'>unPackageName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span>
<a name="line-111"></a>   <span class='hs-layout'>}</span>
<a name="line-112"></a>   <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>)</span>
<a name="line-113"></a>
<a name="line-114"></a><a name="instance%20Uniquable%20PackageId"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Uniquable</span> <span class='hs-conid'>PackageId</span> <span class='hs-keyword'>where</span>
<a name="line-115"></a>  <span class='hs-varid'>getUnique</span> <span class='hs-layout'>(</span><span class='hs-conid'>PackageId</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUnique</span> <span class='hs-varid'>n</span>
<a name="line-116"></a>
<a name="line-117"></a><a name="instance%20Uniquable%20PackageName"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Uniquable</span> <span class='hs-conid'>PackageName</span> <span class='hs-keyword'>where</span>
<a name="line-118"></a>  <span class='hs-varid'>getUnique</span> <span class='hs-layout'>(</span><span class='hs-conid'>PackageName</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUnique</span> <span class='hs-varid'>n</span>
<a name="line-119"></a>
<a name="line-120"></a><a name="instance%20Outputable%20PackageId"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>PackageId</span> <span class='hs-keyword'>where</span>
<a name="line-121"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PackageId</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ftext</span> <span class='hs-varid'>str</span>
<a name="line-122"></a>
<a name="line-123"></a><a name="instance%20Outputable%20PackageName"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>PackageName</span> <span class='hs-keyword'>where</span>
<a name="line-124"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PackageName</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ftext</span> <span class='hs-varid'>str</span>
<a name="line-125"></a>
<a name="line-126"></a><a name="unitPackageIdString"></a><span class='hs-definition'>unitPackageIdString</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GenUnitInfo</span> <span class='hs-varid'>u</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-127"></a><span class='hs-definition'>unitPackageIdString</span> <span class='hs-varid'>pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unpackFS</span> <span class='hs-varid'>str</span>
<a name="line-128"></a>  <span class='hs-keyword'>where</span>
<a name="line-129"></a>    <span class='hs-conid'>PackageId</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitPackageId</span> <span class='hs-varid'>pkg</span>
<a name="line-130"></a>
<a name="line-131"></a><a name="unitPackageNameString"></a><span class='hs-definition'>unitPackageNameString</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GenUnitInfo</span> <span class='hs-varid'>u</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-132"></a><span class='hs-definition'>unitPackageNameString</span> <span class='hs-varid'>pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unpackFS</span> <span class='hs-varid'>str</span>
<a name="line-133"></a>  <span class='hs-keyword'>where</span>
<a name="line-134"></a>    <span class='hs-conid'>PackageName</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitPackageName</span> <span class='hs-varid'>pkg</span>
<a name="line-135"></a>
<a name="line-136"></a><a name="pprUnitInfo"></a><span class='hs-definition'>pprUnitInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnitInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-137"></a><span class='hs-definition'>pprUnitInfo</span> <span class='hs-conid'>GenericUnitInfo</span> <span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span>
<a name="line-138"></a>    <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span>
<a name="line-139"></a>      <span class='hs-varid'>field</span> <span class='hs-str'>"name"</span>                 <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>unitPackageName</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-140"></a>      <span class='hs-varid'>field</span> <span class='hs-str'>"version"</span>              <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>showVersion</span> <span class='hs-varid'>unitPackageVersion</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-141"></a>      <span class='hs-varid'>field</span> <span class='hs-str'>"id"</span>                   <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>unitId</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-142"></a>      <span class='hs-varid'>field</span> <span class='hs-str'>"exposed"</span>              <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>unitIsExposed</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-143"></a>      <span class='hs-varid'>field</span> <span class='hs-str'>"exposed-modules"</span>      <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>unitExposedModules</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-144"></a>      <span class='hs-varid'>field</span> <span class='hs-str'>"hidden-modules"</span>       <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>unitHiddenModules</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-145"></a>      <span class='hs-varid'>field</span> <span class='hs-str'>"trusted"</span>              <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>unitIsTrusted</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-146"></a>      <span class='hs-varid'>field</span> <span class='hs-str'>"import-dirs"</span>          <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varop'>.</span> <span class='hs-conid'>ST.unpack</span><span class='hs-layout'>)</span> <span class='hs-varid'>unitImportDirs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-147"></a>      <span class='hs-varid'>field</span> <span class='hs-str'>"library-dirs"</span>         <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varop'>.</span> <span class='hs-conid'>ST.unpack</span><span class='hs-layout'>)</span> <span class='hs-varid'>unitLibraryDirs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-148"></a>      <span class='hs-varid'>field</span> <span class='hs-str'>"dynamic-library-dirs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varop'>.</span> <span class='hs-conid'>ST.unpack</span><span class='hs-layout'>)</span> <span class='hs-varid'>unitLibraryDynDirs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-149"></a>      <span class='hs-varid'>field</span> <span class='hs-str'>"hs-libraries"</span>         <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varop'>.</span> <span class='hs-conid'>ST.unpack</span><span class='hs-layout'>)</span> <span class='hs-varid'>unitLibraries</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-150"></a>      <span class='hs-varid'>field</span> <span class='hs-str'>"extra-libraries"</span>      <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varop'>.</span> <span class='hs-conid'>ST.unpack</span><span class='hs-layout'>)</span> <span class='hs-varid'>unitExtDepLibsSys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-151"></a>      <span class='hs-varid'>field</span> <span class='hs-str'>"extra-ghci-libraries"</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varop'>.</span> <span class='hs-conid'>ST.unpack</span><span class='hs-layout'>)</span> <span class='hs-varid'>unitExtDepLibsGhc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-152"></a>      <span class='hs-varid'>field</span> <span class='hs-str'>"include-dirs"</span>         <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varop'>.</span> <span class='hs-conid'>ST.unpack</span><span class='hs-layout'>)</span> <span class='hs-varid'>unitIncludeDirs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-153"></a>      <span class='hs-varid'>field</span> <span class='hs-str'>"includes"</span>             <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varop'>.</span> <span class='hs-conid'>ST.unpack</span><span class='hs-layout'>)</span> <span class='hs-varid'>unitIncludes</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-154"></a>      <span class='hs-varid'>field</span> <span class='hs-str'>"depends"</span>              <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span>  <span class='hs-varid'>unitDepends</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-155"></a>      <span class='hs-varid'>field</span> <span class='hs-str'>"cc-options"</span>           <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varop'>.</span> <span class='hs-conid'>ST.unpack</span><span class='hs-layout'>)</span> <span class='hs-varid'>unitCcOptions</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-156"></a>      <span class='hs-varid'>field</span> <span class='hs-str'>"ld-options"</span>           <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varop'>.</span> <span class='hs-conid'>ST.unpack</span><span class='hs-layout'>)</span> <span class='hs-varid'>unitLinkerOptions</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-157"></a>      <span class='hs-varid'>field</span> <span class='hs-str'>"framework-dirs"</span>       <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varop'>.</span> <span class='hs-conid'>ST.unpack</span><span class='hs-layout'>)</span> <span class='hs-varid'>unitExtDepFrameworkDirs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-158"></a>      <span class='hs-varid'>field</span> <span class='hs-str'>"frameworks"</span>           <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varop'>.</span> <span class='hs-conid'>ST.unpack</span><span class='hs-layout'>)</span> <span class='hs-varid'>unitExtDepFrameworks</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-159"></a>      <span class='hs-varid'>field</span> <span class='hs-str'>"haddock-interfaces"</span>   <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varop'>.</span> <span class='hs-conid'>ST.unpack</span><span class='hs-layout'>)</span> <span class='hs-varid'>unitHaddockInterfaces</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-160"></a>      <span class='hs-varid'>field</span> <span class='hs-str'>"haddock-html"</span>         <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varop'>.</span> <span class='hs-conid'>ST.unpack</span><span class='hs-layout'>)</span> <span class='hs-varid'>unitHaddockHTMLs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-161"></a>    <span class='hs-keyglyph'>]</span>
<a name="line-162"></a>  <span class='hs-keyword'>where</span>
<a name="line-163"></a>    <span class='hs-varid'>field</span> <span class='hs-varid'>name</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>nest</span> <span class='hs-num'>4</span> <span class='hs-varid'>body</span>
<a name="line-164"></a>
<a name="line-165"></a><a name="mkUnit"></a><span class='hs-comment'>-- | Make a `Unit` from a `UnitInfo`</span>
<a name="line-166"></a><span class='hs-comment'>--</span>
<a name="line-167"></a><span class='hs-comment'>-- If the unit is definite, make a `RealUnit` from `unitId` field.</span>
<a name="line-168"></a><span class='hs-comment'>--</span>
<a name="line-169"></a><span class='hs-comment'>-- If the unit is indefinite, make a `VirtUnit` from `unitInstanceOf` and</span>
<a name="line-170"></a><span class='hs-comment'>-- `unitInstantiations` fields. Note that in this case we don't keep track of</span>
<a name="line-171"></a><span class='hs-comment'>-- `unitId`. It can be retrieved later with "improvement", i.e. matching on</span>
<a name="line-172"></a><span class='hs-comment'>-- `unitInstanceOf/unitInstantiations` fields (see Note [About units] in</span>
<a name="line-173"></a><span class='hs-comment'>-- GHC.Unit).</span>
<a name="line-174"></a><span class='hs-definition'>mkUnit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnitInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unit</span>
<a name="line-175"></a><span class='hs-definition'>mkUnit</span> <span class='hs-varid'>p</span>
<a name="line-176"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>unitIsIndefinite</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVirtUnit</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitInstanceOf</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitInstantiations</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span>
<a name="line-177"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RealUnit</span> <span class='hs-layout'>(</span><span class='hs-conid'>Definite</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitId</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-178"></a>
<a name="line-179"></a><a name="mkUnitPprInfo"></a><span class='hs-comment'>-- | Create a UnitPprInfo from a UnitInfo</span>
<a name="line-180"></a><span class='hs-definition'>mkUnitPprInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>u</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FastString</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GenUnitInfo</span> <span class='hs-varid'>u</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnitPprInfo</span>
<a name="line-181"></a><span class='hs-definition'>mkUnitPprInfo</span> <span class='hs-varid'>ufs</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnitPprInfo</span>
<a name="line-182"></a>   <span class='hs-layout'>(</span><span class='hs-varid'>ufs</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitId</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-183"></a>   <span class='hs-layout'>(</span><span class='hs-varid'>unitPackageNameString</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-184"></a>   <span class='hs-layout'>(</span><span class='hs-varid'>unitPackageVersion</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-185"></a>   <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>unpackFS</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unPackageName</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>unitComponentName</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-186"></a>
<a name="line-187"></a><a name="collectIncludeDirs"></a><span class='hs-comment'>-- | Find all the include directories in the given units</span>
<a name="line-188"></a><span class='hs-definition'>collectIncludeDirs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UnitInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>
<a name="line-189"></a><span class='hs-definition'>collectIncludeDirs</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>ST.unpack</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ordNub</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-conid'>ST.null</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-varid'>unitIncludeDirs</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-190"></a>
<a name="line-191"></a><a name="collectExtraCcOpts"></a><span class='hs-comment'>-- | Find all the C-compiler options in the given units</span>
<a name="line-192"></a><span class='hs-definition'>collectExtraCcOpts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UnitInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-193"></a><span class='hs-definition'>collectExtraCcOpts</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>ST.unpack</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-varid'>unitCcOptions</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-194"></a>
<a name="line-195"></a><a name="collectLibraryDirs"></a><span class='hs-comment'>-- | Find all the library directories in the given units for the given ways</span>
<a name="line-196"></a><span class='hs-definition'>collectLibraryDirs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ways</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UnitInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>
<a name="line-197"></a><span class='hs-definition'>collectLibraryDirs</span> <span class='hs-varid'>ws</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ordNub</span> <span class='hs-varop'>.</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>notNull</span> <span class='hs-varop'>.</span> <span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>libraryDirsForWay</span> <span class='hs-varid'>ws</span><span class='hs-layout'>)</span>
<a name="line-198"></a>
<a name="line-199"></a><a name="collectFrameworks"></a><span class='hs-comment'>-- | Find all the frameworks in the given units</span>
<a name="line-200"></a><span class='hs-definition'>collectFrameworks</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UnitInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-201"></a><span class='hs-definition'>collectFrameworks</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>ST.unpack</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-varid'>unitExtDepFrameworks</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-202"></a>
<a name="line-203"></a><a name="collectFrameworksDirs"></a><span class='hs-comment'>-- | Find all the package framework paths in these and the preload packages</span>
<a name="line-204"></a><span class='hs-definition'>collectFrameworksDirs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UnitInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-205"></a><span class='hs-definition'>collectFrameworksDirs</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>ST.unpack</span> <span class='hs-layout'>(</span><span class='hs-varid'>ordNub</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-conid'>ST.null</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-varid'>unitExtDepFrameworkDirs</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-206"></a>
<a name="line-207"></a><a name="libraryDirsForWay"></a><span class='hs-comment'>-- | Either the 'unitLibraryDirs' or 'unitLibraryDynDirs' as appropriate for the way.</span>
<a name="line-208"></a><span class='hs-definition'>libraryDirsForWay</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ways</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnitInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-209"></a><span class='hs-definition'>libraryDirsForWay</span> <span class='hs-varid'>ws</span>
<a name="line-210"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WayDyn</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>ws</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>ST.unpack</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unitLibraryDynDirs</span>
<a name="line-211"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>ST.unpack</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unitLibraryDirs</span>
<a name="line-212"></a>
<a name="line-213"></a><a name="unitHsLibs"></a><span class='hs-definition'>unitHsLibs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcNameVersion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ways</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnitInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-214"></a><span class='hs-definition'>unitHsLibs</span> <span class='hs-varid'>namever</span> <span class='hs-varid'>ways0</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkDynName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>addSuffix</span> <span class='hs-varop'>.</span> <span class='hs-conid'>ST.unpack</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitLibraries</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span>
<a name="line-215"></a>  <span class='hs-keyword'>where</span>
<a name="line-216"></a>        <span class='hs-varid'>ways1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Set.filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>/=</span> <span class='hs-conid'>WayDyn</span><span class='hs-layout'>)</span> <span class='hs-varid'>ways0</span>
<a name="line-217"></a>        <span class='hs-comment'>-- the name of a shared library is libHSfoo-ghc&lt;version&gt;.so</span>
<a name="line-218"></a>        <span class='hs-comment'>-- we leave out the _dyn, because it is superfluous</span>
<a name="line-219"></a>
<a name="line-220"></a>        <span class='hs-comment'>-- debug and profiled RTSs include support for -eventlog</span>
<a name="line-221"></a>        <span class='hs-varid'>ways2</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WayDebug</span> <span class='hs-varop'>`Set.member`</span> <span class='hs-varid'>ways1</span> <span class='hs-varop'>||</span> <span class='hs-conid'>WayProf</span> <span class='hs-varop'>`Set.member`</span> <span class='hs-varid'>ways1</span>
<a name="line-222"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Set.filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>/=</span> <span class='hs-conid'>WayTracing</span><span class='hs-layout'>)</span> <span class='hs-varid'>ways1</span>
<a name="line-223"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-224"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ways1</span>
<a name="line-225"></a>
<a name="line-226"></a>        <span class='hs-varid'>tag</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>waysTag</span> <span class='hs-layout'>(</span><span class='hs-varid'>fullWays</span> <span class='hs-varid'>ways2</span><span class='hs-layout'>)</span>
<a name="line-227"></a>        <span class='hs-varid'>rts_tag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>waysTag</span> <span class='hs-varid'>ways2</span>
<a name="line-228"></a>
<a name="line-229"></a>        <span class='hs-varid'>mkDynName</span> <span class='hs-varid'>x</span>
<a name="line-230"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>ways0</span> <span class='hs-varop'>`hasWay`</span> <span class='hs-conid'>WayDyn</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span>
<a name="line-231"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-str'>"HS"</span> <span class='hs-varop'>`isPrefixOf`</span> <span class='hs-varid'>x</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span> <span class='hs-varop'>++</span> <span class='hs-varid'>dynLibSuffix</span> <span class='hs-varid'>namever</span>
<a name="line-232"></a>           <span class='hs-comment'>-- For non-Haskell libraries, we use the name "Cfoo". The .a</span>
<a name="line-233"></a>           <span class='hs-comment'>-- file is libCfoo.a, and the .so is libfoo.so. That way the</span>
<a name="line-234"></a>           <span class='hs-comment'>-- linker knows what we mean for the vanilla (-lCfoo) and dyn</span>
<a name="line-235"></a>           <span class='hs-comment'>-- (-lfoo) ways. We therefore need to strip the 'C' off here.</span>
<a name="line-236"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>x'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stripPrefix</span> <span class='hs-str'>"C"</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x'</span>
<a name="line-237"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-238"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"Don't understand library name "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-239"></a>
<a name="line-240"></a>        <span class='hs-comment'>-- Add _thr and other rts suffixes to packages named</span>
<a name="line-241"></a>        <span class='hs-comment'>-- `rts` or `rts-1.0`. Why both?  Traditionally the rts</span>
<a name="line-242"></a>        <span class='hs-comment'>-- package is called `rts` only.  However the tooling</span>
<a name="line-243"></a>        <span class='hs-comment'>-- usually expects a package name to have a version.</span>
<a name="line-244"></a>        <span class='hs-comment'>-- As such we will gradually move towards the `rts-1.0`</span>
<a name="line-245"></a>        <span class='hs-comment'>-- package name, at which point the `rts` package name</span>
<a name="line-246"></a>        <span class='hs-comment'>-- will eventually be unused.</span>
<a name="line-247"></a>        <span class='hs-comment'>--</span>
<a name="line-248"></a>        <span class='hs-comment'>-- This change elevates the need to add custom hooks</span>
<a name="line-249"></a>        <span class='hs-comment'>-- and handling specifically for the `rts` package for</span>
<a name="line-250"></a>        <span class='hs-comment'>-- example in ghc-cabal.</span>
<a name="line-251"></a>        <span class='hs-varid'>addSuffix</span> <span class='hs-varid'>rts</span><span class='hs-keyglyph'>@</span><span class='hs-str'>"HSrts"</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rts</span>       <span class='hs-varop'>++</span> <span class='hs-layout'>(</span><span class='hs-varid'>expandTag</span> <span class='hs-varid'>rts_tag</span><span class='hs-layout'>)</span>
<a name="line-252"></a>        <span class='hs-varid'>addSuffix</span> <span class='hs-varid'>rts</span><span class='hs-keyglyph'>@</span><span class='hs-str'>"HSrts-1.0.2"</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rts</span>       <span class='hs-varop'>++</span> <span class='hs-layout'>(</span><span class='hs-varid'>expandTag</span> <span class='hs-varid'>rts_tag</span><span class='hs-layout'>)</span>
<a name="line-253"></a>        <span class='hs-varid'>addSuffix</span> <span class='hs-varid'>other_lib</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>other_lib</span> <span class='hs-varop'>++</span> <span class='hs-layout'>(</span><span class='hs-varid'>expandTag</span> <span class='hs-varid'>tag</span><span class='hs-layout'>)</span>
<a name="line-254"></a>
<a name="line-255"></a>        <span class='hs-varid'>expandTag</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>""</span>
<a name="line-256"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-chr'>'_'</span><span class='hs-conop'>:</span><span class='hs-varid'>t</span>
</pre></body>
</html>
