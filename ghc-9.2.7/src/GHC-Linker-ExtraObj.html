<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Linker/ExtraObj.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-2"></a><span class='hs-comment'>--</span>
<a name="line-3"></a><span class='hs-comment'>-- GHC Extra object linking code</span>
<a name="line-4"></a><span class='hs-comment'>--</span>
<a name="line-5"></a><span class='hs-comment'>-- (c) The GHC Team 2017</span>
<a name="line-6"></a><span class='hs-comment'>--</span>
<a name="line-7"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Linker.ExtraObj</span>
<a name="line-10"></a>   <span class='hs-layout'>(</span> <span class='hs-varid'>mkExtraObj</span>
<a name="line-11"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mkExtraObjToLinkIntoBinary</span>
<a name="line-12"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mkNoteObjsToLinkIntoBinary</span>
<a name="line-13"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>checkLinkInfo</span>
<a name="line-14"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>getLinkInfo</span>
<a name="line-15"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>getCompilerInfo</span>
<a name="line-16"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>ghcLinkInfoSectionName</span>
<a name="line-17"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>ghcLinkInfoNoteName</span>
<a name="line-18"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>platformSupportsSavingLinkOpts</span>
<a name="line-19"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>haveRtsOptsFlags</span>
<a name="line-20"></a>   <span class='hs-layout'>)</span>
<a name="line-21"></a><span class='hs-keyword'>where</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Platform</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Env</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.State</span>
<a name="line-29"></a>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Asm</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Error</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Outputable</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Logger</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.TmpFs</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Session</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Ppr</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.Data.ShortText</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>ST</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.SysTools.Elf</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.SysTools.Tasks</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.SysTools.Info</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Linker.Unit</span>
<a name="line-46"></a>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad.IO.Class</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Maybe</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="mkExtraObj"></a><span class='hs-definition'>mkExtraObj</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Logger</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TmpFs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnitState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Suffix</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FilePath</span>
<a name="line-52"></a><span class='hs-definition'>mkExtraObj</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>tmpfs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>unit_state</span> <span class='hs-varid'>extn</span> <span class='hs-varid'>xs</span>
<a name="line-53"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>cFile</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTempName</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>tmpfs</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>TFL_CurrentModule</span> <span class='hs-varid'>extn</span>
<a name="line-54"></a>      <span class='hs-varid'>oFile</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTempName</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>tmpfs</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>TFL_GhcSession</span> <span class='hs-str'>"o"</span>
<a name="line-55"></a>      <span class='hs-varid'>writeFile</span> <span class='hs-varid'>cFile</span> <span class='hs-varid'>xs</span>
<a name="line-56"></a>      <span class='hs-varid'>ccInfo</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getCompilerInfo</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span>
<a name="line-57"></a>      <span class='hs-varid'>runCc</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>tmpfs</span> <span class='hs-varid'>dflags</span>
<a name="line-58"></a>            <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span>        <span class='hs-str'>"-c"</span><span class='hs-layout'>,</span>
<a name="line-59"></a>              <span class='hs-conid'>FileOption</span> <span class='hs-str'>""</span> <span class='hs-varid'>cFile</span><span class='hs-layout'>,</span>
<a name="line-60"></a>              <span class='hs-conid'>Option</span>        <span class='hs-str'>"-o"</span><span class='hs-layout'>,</span>
<a name="line-61"></a>              <span class='hs-conid'>FileOption</span> <span class='hs-str'>""</span> <span class='hs-varid'>oFile</span><span class='hs-keyglyph'>]</span>
<a name="line-62"></a>              <span class='hs-varop'>++</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>extn</span> <span class='hs-varop'>/=</span> <span class='hs-str'>"s"</span>
<a name="line-63"></a>                    <span class='hs-keyword'>then</span> <span class='hs-varid'>cOpts</span>
<a name="line-64"></a>                    <span class='hs-keyword'>else</span> <span class='hs-varid'>asmOpts</span> <span class='hs-varid'>ccInfo</span><span class='hs-layout'>)</span>
<a name="line-65"></a>      <span class='hs-varid'>return</span> <span class='hs-varid'>oFile</span>
<a name="line-66"></a>    <span class='hs-keyword'>where</span>
<a name="line-67"></a>      <span class='hs-comment'>-- Pass a different set of options to the C compiler depending one whether</span>
<a name="line-68"></a>      <span class='hs-comment'>-- we're compiling C or assembler. When compiling C, we pass the usual</span>
<a name="line-69"></a>      <span class='hs-comment'>-- set of include directories and PIC flags.</span>
<a name="line-70"></a>      <span class='hs-varid'>cOpts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>picCCOpts</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-71"></a>                    <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>FileOption</span> <span class='hs-str'>"-I"</span> <span class='hs-varop'>.</span> <span class='hs-conid'>ST.unpack</span><span class='hs-layout'>)</span>
<a name="line-72"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>unitIncludeDirs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unsafeLookupUnit</span> <span class='hs-varid'>unit_state</span> <span class='hs-varid'>rtsUnit</span><span class='hs-layout'>)</span>
<a name="line-73"></a>
<a name="line-74"></a>      <span class='hs-comment'>-- When compiling assembler code, we drop the usual C options, and if the</span>
<a name="line-75"></a>      <span class='hs-comment'>-- compiler is Clang, we add an extra argument to tell Clang to ignore</span>
<a name="line-76"></a>      <span class='hs-comment'>-- unused command line options. See trac #11684.</span>
<a name="line-77"></a>      <span class='hs-varid'>asmOpts</span> <span class='hs-varid'>ccInfo</span> <span class='hs-keyglyph'>=</span>
<a name="line-78"></a>            <span class='hs-keyword'>if</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>ccInfo</span> <span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Clang</span><span class='hs-layout'>,</span> <span class='hs-conid'>AppleClang</span><span class='hs-layout'>,</span> <span class='hs-conid'>AppleClang51</span><span class='hs-keyglyph'>]</span>
<a name="line-79"></a>                <span class='hs-keyword'>then</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span> <span class='hs-str'>"-Qunused-arguments"</span><span class='hs-keyglyph'>]</span>
<a name="line-80"></a>                <span class='hs-keyword'>else</span> <span class='hs-conid'>[]</span>
<a name="line-81"></a>
<a name="line-82"></a><a name="mkExtraObjToLinkIntoBinary"></a><span class='hs-comment'>-- When linking a binary, we need to create a C main() function that</span>
<a name="line-83"></a><span class='hs-comment'>-- starts everything off.  This used to be compiled statically as part</span>
<a name="line-84"></a><span class='hs-comment'>-- of the RTS, but that made it hard to change the -rtsopts setting,</span>
<a name="line-85"></a><span class='hs-comment'>-- so now we generate and compile a main() stub as part of every</span>
<a name="line-86"></a><span class='hs-comment'>-- binary and pass the -rtsopts setting directly to the RTS (#5373)</span>
<a name="line-87"></a><span class='hs-comment'>--</span>
<a name="line-88"></a><span class='hs-comment'>-- On Windows, when making a shared library we also may need a DllMain.</span>
<a name="line-89"></a><span class='hs-comment'>--</span>
<a name="line-90"></a><span class='hs-definition'>mkExtraObjToLinkIntoBinary</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Logger</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TmpFs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnitState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span>
<a name="line-91"></a><span class='hs-definition'>mkExtraObjToLinkIntoBinary</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>tmpfs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>unit_state</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-92"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_NoHsMain</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>haveRtsOptsFlags</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-93"></a>     <span class='hs-varid'>logInfo</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span> <span class='hs-varid'>withPprStyle</span> <span class='hs-varid'>defaultUserStyle</span>
<a name="line-94"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Warning: -rtsopts and -with-rtsopts have no effect with -no-hs-main."</span> <span class='hs-varop'>$$</span>
<a name="line-95"></a>          <span class='hs-varid'>text</span> <span class='hs-str'>"    Call hs_init_ghc() from your main() function to set these options."</span><span class='hs-layout'>)</span>
<a name="line-96"></a>
<a name="line-97"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>ghcLink</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>of</span>
<a name="line-98"></a>    <span class='hs-comment'>-- Don't try to build the extra object if it is not needed.  Compiling the</span>
<a name="line-99"></a>    <span class='hs-comment'>-- extra object assumes the presence of the RTS in the unit database</span>
<a name="line-100"></a>    <span class='hs-comment'>-- (because the extra object imports Rts.h) but GHC's build system may try</span>
<a name="line-101"></a>    <span class='hs-comment'>-- to build some helper programs before building and registering the RTS!</span>
<a name="line-102"></a>    <span class='hs-comment'>-- See #18938 for an example where hp2ps failed to build because of a failed</span>
<a name="line-103"></a>    <span class='hs-comment'>-- (unsafe) lookup for the RTS in the unit db.</span>
<a name="line-104"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_NoHsMain</span> <span class='hs-varid'>dflags</span>
<a name="line-105"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-106"></a>
<a name="line-107"></a>    <span class='hs-conid'>LinkDynLib</span>
<a name="line-108"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OSMinGW32</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>platformOS</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-109"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mk_extra_obj</span> <span class='hs-varid'>dllMain</span>
<a name="line-110"></a>
<a name="line-111"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-112"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-113"></a>
<a name="line-114"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mk_extra_obj</span> <span class='hs-varid'>exeMain</span>
<a name="line-115"></a>
<a name="line-116"></a>  <span class='hs-keyword'>where</span>
<a name="line-117"></a>    <span class='hs-varid'>mk_extra_obj</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mkExtraObj</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>tmpfs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>unit_state</span> <span class='hs-str'>"c"</span> <span class='hs-varop'>.</span> <span class='hs-varid'>showSDoc</span> <span class='hs-varid'>dflags</span>
<a name="line-118"></a>
<a name="line-119"></a>    <span class='hs-varid'>exeMain</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span>
<a name="line-120"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"#include &lt;Rts.h&gt;"</span><span class='hs-layout'>,</span>
<a name="line-121"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"extern StgClosure ZCMain_main_closure;"</span><span class='hs-layout'>,</span>
<a name="line-122"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"int main(int argc, char *argv[])"</span><span class='hs-layout'>,</span>
<a name="line-123"></a>        <span class='hs-varid'>char</span> <span class='hs-chr'>'{'</span><span class='hs-layout'>,</span>
<a name="line-124"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>" RtsConfig __conf = defaultRtsConfig;"</span><span class='hs-layout'>,</span>
<a name="line-125"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>" __conf.rts_opts_enabled = "</span>
<a name="line-126"></a>            <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>rtsOptsEnabled</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>semi</span><span class='hs-layout'>,</span>
<a name="line-127"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>" __conf.rts_opts_suggestions = "</span>
<a name="line-128"></a>            <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>rtsOptsSuggestions</span> <span class='hs-varid'>dflags</span>
<a name="line-129"></a>                        <span class='hs-keyword'>then</span> <span class='hs-str'>"true"</span>
<a name="line-130"></a>                        <span class='hs-keyword'>else</span> <span class='hs-str'>"false"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>semi</span><span class='hs-layout'>,</span>
<a name="line-131"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"__conf.keep_cafs = "</span>
<a name="line-132"></a>            <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_KeepCAFs</span> <span class='hs-varid'>dflags</span>
<a name="line-133"></a>                       <span class='hs-keyword'>then</span> <span class='hs-str'>"true"</span>
<a name="line-134"></a>                       <span class='hs-keyword'>else</span> <span class='hs-str'>"false"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>semi</span><span class='hs-layout'>,</span>
<a name="line-135"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>rtsOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>of</span>
<a name="line-136"></a>            <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Outputable.empty</span>
<a name="line-137"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>opts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"    __conf.rts_opts= "</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-138"></a>                          <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>opts</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>semi</span><span class='hs-layout'>,</span>
<a name="line-139"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>" __conf.rts_hs_main = true;"</span><span class='hs-layout'>,</span>
<a name="line-140"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>" return hs_main(argc,argv,&amp;ZCMain_main_closure,__conf);"</span><span class='hs-layout'>,</span>
<a name="line-141"></a>        <span class='hs-varid'>char</span> <span class='hs-chr'>'}'</span><span class='hs-layout'>,</span>
<a name="line-142"></a>        <span class='hs-varid'>char</span> <span class='hs-chr'>'\n'</span> <span class='hs-comment'>-- final newline, to keep gcc happy</span>
<a name="line-143"></a>        <span class='hs-keyglyph'>]</span>
<a name="line-144"></a>
<a name="line-145"></a>    <span class='hs-varid'>dllMain</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span>
<a name="line-146"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"#include &lt;Rts.h&gt;"</span><span class='hs-layout'>,</span>
<a name="line-147"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"#include &lt;windows.h&gt;"</span><span class='hs-layout'>,</span>
<a name="line-148"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"#include &lt;stdbool.h&gt;"</span><span class='hs-layout'>,</span>
<a name="line-149"></a>        <span class='hs-varid'>char</span> <span class='hs-chr'>'\n'</span><span class='hs-layout'>,</span>
<a name="line-150"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"bool"</span><span class='hs-layout'>,</span>
<a name="line-151"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"WINAPI"</span><span class='hs-layout'>,</span>
<a name="line-152"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"DllMain ( HINSTANCE hInstance STG_UNUSED"</span><span class='hs-layout'>,</span>
<a name="line-153"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"        , DWORD reason STG_UNUSED"</span><span class='hs-layout'>,</span>
<a name="line-154"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"        , LPVOID reserved STG_UNUSED"</span><span class='hs-layout'>,</span>
<a name="line-155"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"        )"</span><span class='hs-layout'>,</span>
<a name="line-156"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"{"</span><span class='hs-layout'>,</span>
<a name="line-157"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"  return true;"</span><span class='hs-layout'>,</span>
<a name="line-158"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"}"</span><span class='hs-layout'>,</span>
<a name="line-159"></a>        <span class='hs-varid'>char</span> <span class='hs-chr'>'\n'</span> <span class='hs-comment'>-- final newline, to keep gcc happy</span>
<a name="line-160"></a>        <span class='hs-keyglyph'>]</span>
<a name="line-161"></a>
<a name="line-162"></a><a name="mkNoteObjsToLinkIntoBinary"></a><span class='hs-comment'>-- Write out the link info section into a new assembly file. Previously</span>
<a name="line-163"></a><span class='hs-comment'>-- this was included as inline assembly in the main.c file but this</span>
<a name="line-164"></a><span class='hs-comment'>-- is pretty fragile. gas gets upset trying to calculate relative offsets</span>
<a name="line-165"></a><span class='hs-comment'>-- that span the .note section (notably .text) when debug info is present</span>
<a name="line-166"></a><span class='hs-definition'>mkNoteObjsToLinkIntoBinary</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Logger</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TmpFs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnitEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UnitId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>
<a name="line-167"></a><span class='hs-definition'>mkNoteObjsToLinkIntoBinary</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>tmpfs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>unit_env</span> <span class='hs-varid'>dep_packages</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-168"></a>   <span class='hs-varid'>link_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLinkInfo</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>unit_env</span> <span class='hs-varid'>dep_packages</span>
<a name="line-169"></a>
<a name="line-170"></a>   <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>platformSupportsSavingLinkOpts</span> <span class='hs-layout'>(</span><span class='hs-varid'>platformOS</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-171"></a>     <span class='hs-keyword'>then</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkExtraObj</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>tmpfs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>unit_state</span> <span class='hs-str'>"s"</span> <span class='hs-layout'>(</span><span class='hs-varid'>showSDoc</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>link_opts</span> <span class='hs-varid'>link_info</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-172"></a>     <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-173"></a>
<a name="line-174"></a>  <span class='hs-keyword'>where</span>
<a name="line-175"></a>    <span class='hs-varid'>unit_state</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ue_units</span> <span class='hs-varid'>unit_env</span>
<a name="line-176"></a>    <span class='hs-varid'>platform</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ue_platform</span> <span class='hs-varid'>unit_env</span>
<a name="line-177"></a>    <span class='hs-varid'>link_opts</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hcat</span>
<a name="line-178"></a>        <span class='hs-keyglyph'>[</span> <span class='hs-comment'>-- "link info" section (see Note [LinkInfo section])</span>
<a name="line-179"></a>          <span class='hs-varid'>makeElfNote</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>ghcLinkInfoSectionName</span> <span class='hs-varid'>ghcLinkInfoNoteName</span> <span class='hs-num'>0</span> <span class='hs-varid'>info</span>
<a name="line-180"></a>
<a name="line-181"></a>        <span class='hs-comment'>-- ALL generated assembly must have this section to disable</span>
<a name="line-182"></a>        <span class='hs-comment'>-- executable stacks.  See also</span>
<a name="line-183"></a>        <span class='hs-comment'>-- "GHC.CmmToAsm" for another instance</span>
<a name="line-184"></a>        <span class='hs-comment'>-- where we need to do this.</span>
<a name="line-185"></a>        <span class='hs-layout'>,</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>platformHasGnuNonexecStack</span> <span class='hs-varid'>platform</span>
<a name="line-186"></a>            <span class='hs-keyword'>then</span> <span class='hs-varid'>text</span> <span class='hs-str'>".section .note.GNU-stack,\"\","</span>
<a name="line-187"></a>                 <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>sectionType</span> <span class='hs-varid'>platform</span> <span class='hs-str'>"progbits"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'\n'</span>
<a name="line-188"></a>            <span class='hs-keyword'>else</span> <span class='hs-conid'>Outputable.empty</span>
<a name="line-189"></a>        <span class='hs-keyglyph'>]</span>
<a name="line-190"></a>
<a name="line-191"></a><a name="getLinkInfo"></a><span class='hs-comment'>-- | Return the "link info" string</span>
<a name="line-192"></a><span class='hs-comment'>--</span>
<a name="line-193"></a><span class='hs-comment'>-- See Note [LinkInfo section]</span>
<a name="line-194"></a><span class='hs-definition'>getLinkInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnitEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UnitId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>String</span>
<a name="line-195"></a><span class='hs-definition'>getLinkInfo</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>unit_env</span> <span class='hs-varid'>dep_packages</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-196"></a>    <span class='hs-varid'>package_link_opts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getUnitLinkOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>unit_env</span> <span class='hs-varid'>dep_packages</span>
<a name="line-197"></a>    <span class='hs-varid'>pkg_frameworks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>platformUsesFrameworks</span> <span class='hs-layout'>(</span><span class='hs-varid'>ue_platform</span> <span class='hs-varid'>unit_env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-198"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-199"></a>      <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-200"></a>         <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mayThrowUnitErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>preloadUnitsInfo'</span> <span class='hs-varid'>unit_env</span> <span class='hs-varid'>dep_packages</span><span class='hs-layout'>)</span>
<a name="line-201"></a>         <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectFrameworks</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-202"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>link_info</span> <span class='hs-keyglyph'>=</span>
<a name="line-203"></a>             <span class='hs-layout'>(</span> <span class='hs-varid'>package_link_opts</span>
<a name="line-204"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>pkg_frameworks</span>
<a name="line-205"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>rtsOpts</span> <span class='hs-varid'>dflags</span>
<a name="line-206"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>rtsOptsEnabled</span> <span class='hs-varid'>dflags</span>
<a name="line-207"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_NoHsMain</span> <span class='hs-varid'>dflags</span>
<a name="line-208"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>map</span> <span class='hs-varid'>showOpt</span> <span class='hs-layout'>(</span><span class='hs-varid'>ldInputs</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-209"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_l</span>
<a name="line-210"></a>             <span class='hs-layout'>)</span>
<a name="line-211"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>link_info</span><span class='hs-layout'>)</span>
<a name="line-212"></a>
<a name="line-213"></a><a name="platformSupportsSavingLinkOpts"></a><span class='hs-definition'>platformSupportsSavingLinkOpts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OS</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-214"></a><span class='hs-definition'>platformSupportsSavingLinkOpts</span> <span class='hs-varid'>os</span>
<a name="line-215"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>os</span> <span class='hs-varop'>==</span> <span class='hs-conid'>OSSolaris2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-comment'>-- see #5382</span>
<a name="line-216"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>osElfTarget</span> <span class='hs-varid'>os</span>
<a name="line-217"></a>
<a name="line-218"></a><a name="ghcLinkInfoSectionName"></a><span class='hs-comment'>-- See Note [LinkInfo section]</span>
<a name="line-219"></a><span class='hs-definition'>ghcLinkInfoSectionName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span>
<a name="line-220"></a><span class='hs-definition'>ghcLinkInfoSectionName</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>".debug-ghc-link-info"</span>
<a name="line-221"></a>  <span class='hs-comment'>-- if we use the ".debug" prefix, then strip will strip it by default</span>
<a name="line-222"></a>
<a name="line-223"></a><a name="ghcLinkInfoNoteName"></a><span class='hs-comment'>-- Identifier for the note (see Note [LinkInfo section])</span>
<a name="line-224"></a><span class='hs-definition'>ghcLinkInfoNoteName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span>
<a name="line-225"></a><span class='hs-definition'>ghcLinkInfoNoteName</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"GHC link info"</span>
<a name="line-226"></a>
<a name="line-227"></a><a name="checkLinkInfo"></a><span class='hs-comment'>-- Returns 'False' if it was, and we can avoid linking, because the</span>
<a name="line-228"></a><span class='hs-comment'>-- previous binary was linked with "the same options".</span>
<a name="line-229"></a><span class='hs-definition'>checkLinkInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Logger</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnitEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UnitId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Bool</span>
<a name="line-230"></a><span class='hs-definition'>checkLinkInfo</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>unit_env</span> <span class='hs-varid'>pkg_deps</span> <span class='hs-varid'>exe_file</span>
<a name="line-231"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>platformSupportsSavingLinkOpts</span> <span class='hs-layout'>(</span><span class='hs-varid'>platformOS</span> <span class='hs-layout'>(</span><span class='hs-varid'>ue_platform</span> <span class='hs-varid'>unit_env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-232"></a> <span class='hs-comment'>-- ToDo: Windows and OS X do not use the ELF binary format, so</span>
<a name="line-233"></a> <span class='hs-comment'>-- readelf does not work there.  We need to find another way to do</span>
<a name="line-234"></a> <span class='hs-comment'>-- this.</span>
<a name="line-235"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span> <span class='hs-comment'>-- conservatively we should return True, but not</span>
<a name="line-236"></a>                <span class='hs-comment'>-- linking in this case was the behaviour for a long</span>
<a name="line-237"></a>                <span class='hs-comment'>-- time so we leave it as-is.</span>
<a name="line-238"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-239"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-240"></a>   <span class='hs-varid'>link_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLinkInfo</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>unit_env</span> <span class='hs-varid'>pkg_deps</span>
<a name="line-241"></a>   <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>3</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-str'>"Link info: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>link_info</span><span class='hs-layout'>)</span>
<a name="line-242"></a>   <span class='hs-varid'>m_exe_link_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readElfNoteAsString</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>exe_file</span>
<a name="line-243"></a>                          <span class='hs-varid'>ghcLinkInfoSectionName</span> <span class='hs-varid'>ghcLinkInfoNoteName</span>
<a name="line-244"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>sameLinkInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>link_info</span> <span class='hs-varop'>==</span> <span class='hs-varid'>m_exe_link_info</span><span class='hs-layout'>)</span>
<a name="line-245"></a>   <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>3</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>m_exe_link_info</span> <span class='hs-keyword'>of</span>
<a name="line-246"></a>     <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Exe link info: Not found"</span>
<a name="line-247"></a>     <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span>
<a name="line-248"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>sameLinkInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-str'>"Exe link info is the same"</span><span class='hs-layout'>)</span>
<a name="line-249"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-str'>"Exe link info is different: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-250"></a>   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>sameLinkInfo</span><span class='hs-layout'>)</span>
<a name="line-251"></a>
<a name="line-252"></a><span class='hs-comment'>{- Note [LinkInfo section]
<a name="line-253"></a>   ~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-254"></a>
<a name="line-255"></a>The "link info" is a string representing the parameters of the link. We save
<a name="line-256"></a>this information in the binary, and the next time we link, if nothing else has
<a name="line-257"></a>changed, we use the link info stored in the existing binary to decide whether
<a name="line-258"></a>to re-link or not.
<a name="line-259"></a>
<a name="line-260"></a>The "link info" string is stored in a ELF section called ".debug-ghc-link-info"
<a name="line-261"></a>(see ghcLinkInfoSectionName) with the SHT_NOTE type.  For some time, it used to
<a name="line-262"></a>not follow the specified record-based format (see #11022).
<a name="line-263"></a>
<a name="line-264"></a>-}</span>
<a name="line-265"></a>
<a name="line-266"></a><a name="haveRtsOptsFlags"></a><span class='hs-definition'>haveRtsOptsFlags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-267"></a><span class='hs-definition'>haveRtsOptsFlags</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span>
<a name="line-268"></a>        <span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>rtsOpts</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>rtsOptsEnabled</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>of</span>
<a name="line-269"></a>                                       <span class='hs-conid'>RtsOptsSafeOnly</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-270"></a>                                       <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
</pre></body>
</html>
