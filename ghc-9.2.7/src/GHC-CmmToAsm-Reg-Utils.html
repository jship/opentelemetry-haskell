<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/CmmToAsm/Reg/Utils.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.CmmToAsm.Reg.Utils</span>
<a name="line-2"></a>    <span class='hs-layout'>(</span> <span class='hs-varid'>toRegMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>toVRegMap</span> <span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-keyword'>where</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-comment'>{- Note [UniqFM and the register allocator]
<a name="line-6"></a>   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-7"></a>
<a name="line-8"></a>   Before UniqFM had a key type the register allocator
<a name="line-9"></a>   wasn't picky about key types, using VirtualReg, Reg
<a name="line-10"></a>   and Unique at various use sites for the same map.
<a name="line-11"></a>
<a name="line-12"></a>   This is safe.
<a name="line-13"></a>   * The Unique values come from registers at various
<a name="line-14"></a>     points where we lose a reference to the original
<a name="line-15"></a>     register value, but the unique is still valid.
<a name="line-16"></a>
<a name="line-17"></a>   * VirtualReg is a subset of the registers in Reg's type.
<a name="line-18"></a>     Making a value of VirtualReg into a Reg in fact doesn't
<a name="line-19"></a>     change its unique. This is because Reg consists of virtual
<a name="line-20"></a>     regs and real regs, whose unique values do not overlap.
<a name="line-21"></a>
<a name="line-22"></a>   * Since the code was written in the assumption that keys are
<a name="line-23"></a>     not typed it's hard to reverse this assumption now. So we get
<a name="line-24"></a>     some gnarly but correct code where we often pass around Uniques
<a name="line-25"></a>     and switch between using Uniques, VirtualReg and RealReg as keys
<a name="line-26"></a>     of the same map. These issues were always there. But with the
<a name="line-27"></a>     now-typed keys they become visible. It's a classic case of not all
<a name="line-28"></a>     correct programs type checking.
<a name="line-29"></a>
<a name="line-30"></a>   We reduce some of the burden by providing a way to cast
<a name="line-31"></a>
<a name="line-32"></a>        UniqFM VirtualReg a
<a name="line-33"></a>
<a name="line-34"></a>   to
<a name="line-35"></a>
<a name="line-36"></a>        UniqFM Reg a
<a name="line-37"></a>
<a name="line-38"></a>    in this module. This is safe as Reg is the sum of VirtualReg and
<a name="line-39"></a>    RealReg. With each kind of register keeping the same unique when
<a name="line-40"></a>    treated as Reg.
<a name="line-41"></a>
<a name="line-42"></a>   TODO: If you take offense to this I encourage you to refactor this
<a name="line-43"></a>   code. I'm sure we can do with less casting of keys and direct use
<a name="line-44"></a>   of uniques. It might also be reasonable to just use a IntMap directly
<a name="line-45"></a>   instead of dealing with UniqFM at all.
<a name="line-46"></a>
<a name="line-47"></a>
<a name="line-48"></a>-}</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.FM</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Platform.Reg</span>
<a name="line-51"></a>
<a name="line-52"></a><span class='hs-comment'>-- These should hopefully be zero cost.</span>
<a name="line-53"></a>
<a name="line-54"></a><a name="toRegMap"></a><span class='hs-definition'>toRegMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqFM</span> <span class='hs-conid'>VirtualReg</span> <span class='hs-varid'>elt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqFM</span> <span class='hs-conid'>Reg</span> <span class='hs-varid'>elt</span>
<a name="line-55"></a><span class='hs-definition'>toRegMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeCastUFMKey</span>
<a name="line-56"></a>
<a name="line-57"></a><a name="toVRegMap"></a><span class='hs-definition'>toVRegMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqFM</span> <span class='hs-conid'>Reg</span> <span class='hs-varid'>elt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqFM</span> <span class='hs-conid'>VirtualReg</span> <span class='hs-varid'>elt</span>
<a name="line-58"></a><span class='hs-definition'>toVRegMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeCastUFMKey</span>
<a name="line-59"></a>
</pre></body>
</html>
