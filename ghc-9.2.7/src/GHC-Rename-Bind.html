<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Rename/Bind.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE ConstraintKinds #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables, BangPatterns #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE TypeFamilies #-}</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-comment'>{-# OPTIONS_GHC -Wno-incomplete-uni-patterns   #-}</span>
<a name="line-6"></a><span class='hs-comment'>{-# OPTIONS_GHC -Wno-incomplete-record-updates #-}</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-comment'>{-
<a name="line-9"></a>(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
<a name="line-10"></a>
<a name="line-11"></a>Renaming and dependency analysis of bindings
<a name="line-12"></a>
<a name="line-13"></a>This module does renaming and dependency analysis on value bindings in
<a name="line-14"></a>the abstract syntax.  It does {\em not} do cycle-checks on class or
<a name="line-15"></a>type-synonym declarations; those cannot be done at this stage because
<a name="line-16"></a>they may be affected by renaming (which isn't fully worked out yet).
<a name="line-17"></a>-}</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Rename.Bind</span> <span class='hs-layout'>(</span>
<a name="line-20"></a>   <span class='hs-comment'>-- Renaming top-level bindings</span>
<a name="line-21"></a>   <span class='hs-varid'>rnTopBindsLHS</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnTopBindsBoot</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnValBindsRHS</span><span class='hs-layout'>,</span>
<a name="line-22"></a>
<a name="line-23"></a>   <span class='hs-comment'>-- Renaming local bindings</span>
<a name="line-24"></a>   <span class='hs-varid'>rnLocalBindsAndThen</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnLocalValBindsLHS</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnLocalValBindsRHS</span><span class='hs-layout'>,</span>
<a name="line-25"></a>
<a name="line-26"></a>   <span class='hs-comment'>-- Other bindings</span>
<a name="line-27"></a>   <span class='hs-varid'>rnMethodBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>renameSigs</span><span class='hs-layout'>,</span>
<a name="line-28"></a>   <span class='hs-varid'>rnMatchGroup</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnGRHSs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnGRHS</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnSrcFixityDecl</span><span class='hs-layout'>,</span>
<a name="line-29"></a>   <span class='hs-varid'>makeMiniFixityEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>MiniFixityEnv</span><span class='hs-layout'>,</span>
<a name="line-30"></a>   <span class='hs-conid'>HsSigCtxt</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-31"></a>   <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-34"></a>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>GHC.Rename.Expr</span><span class='hs-layout'>(</span> <span class='hs-varid'>rnExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnLExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnStmts</span> <span class='hs-layout'>)</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Hs</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Monad</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Rename.HsType</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Rename.Pat</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Rename.Names</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Rename.Env</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Rename.Fixity</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Rename.Utils</span> <span class='hs-layout'>(</span> <span class='hs-conid'>HsDocContext</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>mapFvRn</span>
<a name="line-45"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>checkDupRdrNames</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkDupRdrNamesN</span><span class='hs-layout'>,</span> <span class='hs-varid'>warnUnusedLocalBinds</span>
<a name="line-46"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>checkUnusedRecordWildcard</span>
<a name="line-47"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>checkDupAndShadowedNames</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindLocalNamesFV</span>
<a name="line-48"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>addNoNestedForallsContextsErr</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkInferredVars</span> <span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Session</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.FieldLabel</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Env</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Set</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Reader</span> <span class='hs-layout'>(</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> <span class='hs-varid'>rdrNameOcc</span> <span class='hs-layout'>)</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SrcLoc</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.List.SetOps</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>findDupsEq</span> <span class='hs-layout'>)</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Basic</span>         <span class='hs-layout'>(</span> <span class='hs-conid'>RecFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TypeOrKind</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Graph.Directed</span> <span class='hs-layout'>(</span> <span class='hs-conid'>SCC</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Bag</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.Set</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Maybe</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>orElse</span> <span class='hs-layout'>)</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.OrdList</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.LanguageExtensions</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>LangExt</span>
<a name="line-68"></a>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Foldable</span>      <span class='hs-layout'>(</span> <span class='hs-varid'>toList</span> <span class='hs-layout'>)</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>partition</span><span class='hs-layout'>,</span> <span class='hs-varid'>sortBy</span> <span class='hs-layout'>)</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List.NonEmpty</span> <span class='hs-layout'>(</span> <span class='hs-conid'>NonEmpty</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-73"></a>
<a name="line-74"></a><span class='hs-comment'>{-
<a name="line-75"></a>-- ToDo: Put the annotations into the monad, so that they arrive in the proper
<a name="line-76"></a>-- place and can be used when complaining.
<a name="line-77"></a>
<a name="line-78"></a>The code tree received by the function @rnBinds@ contains definitions
<a name="line-79"></a>in where-clauses which are all apparently mutually recursive, but which may
<a name="line-80"></a>not really depend upon each other. For example, in the top level program
<a name="line-81"></a>\begin{verbatim}
<a name="line-82"></a>f x = y where a = x
<a name="line-83"></a>              y = x
<a name="line-84"></a>\end{verbatim}
<a name="line-85"></a>the definitions of @a@ and @y@ do not depend on each other at all.
<a name="line-86"></a>Unfortunately, the typechecker cannot always check such definitions.
<a name="line-87"></a>\footnote{Mycroft, A. 1984. Polymorphic type schemes and recursive
<a name="line-88"></a>definitions. In Proceedings of the International Symposium on Programming,
<a name="line-89"></a>Toulouse, pp. 217-39. LNCS 167. Springer Verlag.}
<a name="line-90"></a>However, the typechecker usually can check definitions in which only the
<a name="line-91"></a>strongly connected components have been collected into recursive bindings.
<a name="line-92"></a>This is precisely what the function @rnBinds@ does.
<a name="line-93"></a>
<a name="line-94"></a>ToDo: deal with case where a single monobinds binds the same variable
<a name="line-95"></a>twice.
<a name="line-96"></a>
<a name="line-97"></a>The vertag tag is a unique @Int@; the tags only need to be unique
<a name="line-98"></a>within one @MonoBinds@, so that unique-Int plumbing is done explicitly
<a name="line-99"></a>(heavy monad machinery not needed).
<a name="line-100"></a>
<a name="line-101"></a>
<a name="line-102"></a>************************************************************************
<a name="line-103"></a>*                                                                      *
<a name="line-104"></a>* naming conventions                                                   *
<a name="line-105"></a>*                                                                      *
<a name="line-106"></a>************************************************************************
<a name="line-107"></a>
<a name="line-108"></a>\subsection[name-conventions]{Name conventions}
<a name="line-109"></a>
<a name="line-110"></a>The basic algorithm involves walking over the tree and returning a tuple
<a name="line-111"></a>containing the new tree plus its free variables. Some functions, such
<a name="line-112"></a>as those walking polymorphic bindings (HsBinds) and qualifier lists in
<a name="line-113"></a>list comprehensions (@Quals@), return the variables bound in local
<a name="line-114"></a>environments. These are then used to calculate the free variables of the
<a name="line-115"></a>expression evaluated in these environments.
<a name="line-116"></a>
<a name="line-117"></a>Conventions for variable names are as follows:
<a name="line-118"></a>\begin{itemize}
<a name="line-119"></a>\item
<a name="line-120"></a>new code is given a prime to distinguish it from the old.
<a name="line-121"></a>
<a name="line-122"></a>\item
<a name="line-123"></a>a set of variables defined in @Exp@ is written @dvExp@
<a name="line-124"></a>
<a name="line-125"></a>\item
<a name="line-126"></a>a set of variables free in @Exp@ is written @fvExp@
<a name="line-127"></a>\end{itemize}
<a name="line-128"></a>
<a name="line-129"></a>************************************************************************
<a name="line-130"></a>*                                                                      *
<a name="line-131"></a>* analysing polymorphic bindings (HsBindGroup, HsBind)
<a name="line-132"></a>*                                                                      *
<a name="line-133"></a>************************************************************************
<a name="line-134"></a>
<a name="line-135"></a>\subsubsection[dep-HsBinds]{Polymorphic bindings}
<a name="line-136"></a>
<a name="line-137"></a>Non-recursive expressions are reconstructed without any changes at top
<a name="line-138"></a>level, although their component expressions may have to be altered.
<a name="line-139"></a>However, non-recursive expressions are currently not expected as
<a name="line-140"></a>\Haskell{} programs, and this code should not be executed.
<a name="line-141"></a>
<a name="line-142"></a>Monomorphic bindings contain information that is returned in a tuple
<a name="line-143"></a>(a @FlatMonoBinds@) containing:
<a name="line-144"></a>
<a name="line-145"></a>\begin{enumerate}
<a name="line-146"></a>\item
<a name="line-147"></a>a unique @Int@ that serves as the ``vertex tag'' for this binding.
<a name="line-148"></a>
<a name="line-149"></a>\item
<a name="line-150"></a>the name of a function or the names in a pattern. These are a set
<a name="line-151"></a>referred to as @dvLhs@, the defined variables of the left hand side.
<a name="line-152"></a>
<a name="line-153"></a>\item
<a name="line-154"></a>the free variables of the body. These are referred to as @fvBody@.
<a name="line-155"></a>
<a name="line-156"></a>\item
<a name="line-157"></a>the definition's actual code. This is referred to as just @code@.
<a name="line-158"></a>\end{enumerate}
<a name="line-159"></a>
<a name="line-160"></a>The function @nonRecDvFv@ returns two sets of variables. The first is
<a name="line-161"></a>the set of variables defined in the set of monomorphic bindings, while the
<a name="line-162"></a>second is the set of free variables in those bindings.
<a name="line-163"></a>
<a name="line-164"></a>The set of variables defined in a non-recursive binding is just the
<a name="line-165"></a>union of all of them, as @union@ removes duplicates. However, the
<a name="line-166"></a>free variables in each successive set of cumulative bindings is the
<a name="line-167"></a>union of those in the previous set plus those of the newest binding after
<a name="line-168"></a>the defined variables of the previous set have been removed.
<a name="line-169"></a>
<a name="line-170"></a>@rnMethodBinds@ deals only with the declarations in class and
<a name="line-171"></a>instance declarations.  It expects only to see @FunMonoBind@s, and
<a name="line-172"></a>it expects the global environment to contain bindings for the binders
<a name="line-173"></a>(which are all class operations).
<a name="line-174"></a>
<a name="line-175"></a>************************************************************************
<a name="line-176"></a>*                                                                      *
<a name="line-177"></a>\subsubsection{ Top-level bindings}
<a name="line-178"></a>*                                                                      *
<a name="line-179"></a>************************************************************************
<a name="line-180"></a>-}</span>
<a name="line-181"></a>
<a name="line-182"></a><a name="rnTopBindsLHS"></a><span class='hs-comment'>-- for top-level bindings, we need to make top-level names,</span>
<a name="line-183"></a><span class='hs-comment'>-- so we have a different entry point than for local bindings</span>
<a name="line-184"></a><span class='hs-definition'>rnTopBindsLHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MiniFixityEnv</span>
<a name="line-185"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>GhcPs</span>
<a name="line-186"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBindsLR</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-187"></a><span class='hs-definition'>rnTopBindsLHS</span> <span class='hs-varid'>fix_env</span> <span class='hs-varid'>binds</span>
<a name="line-188"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnValBindsLHS</span> <span class='hs-layout'>(</span><span class='hs-varid'>topRecNameMaker</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span>
<a name="line-189"></a>
<a name="line-190"></a><a name="rnTopBindsBoot"></a><span class='hs-definition'>rnTopBindsBoot</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsValBindsLR</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcPs</span>
<a name="line-191"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>DefUses</span><span class='hs-layout'>)</span>
<a name="line-192"></a><span class='hs-comment'>-- A hs-boot file has no bindings.</span>
<a name="line-193"></a><span class='hs-comment'>-- Return a single HsBindGroup with empty binds and renamed signatures</span>
<a name="line-194"></a><span class='hs-definition'>rnTopBindsBoot</span> <span class='hs-varid'>bound_names</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValBinds</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>mbinds</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span>
<a name="line-195"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>checkErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyLHsBinds</span> <span class='hs-varid'>mbinds</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>bindsInHsBootFile</span> <span class='hs-varid'>mbinds</span><span class='hs-layout'>)</span>
<a name="line-196"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>sigs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>renameSigs</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBootCtxt</span> <span class='hs-varid'>bound_names</span><span class='hs-layout'>)</span> <span class='hs-varid'>sigs</span>
<a name="line-197"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>XValBindsLR</span> <span class='hs-layout'>(</span><span class='hs-conid'>NValBinds</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>sigs'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>usesOnly</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-198"></a><span class='hs-definition'>rnTopBindsBoot</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rnTopBindsBoot"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-199"></a>
<a name="line-200"></a><span class='hs-comment'>{-
<a name="line-201"></a>*********************************************************
<a name="line-202"></a>*                                                      *
<a name="line-203"></a>                HsLocalBinds
<a name="line-204"></a>*                                                      *
<a name="line-205"></a>*********************************************************
<a name="line-206"></a>-}</span>
<a name="line-207"></a>
<a name="line-208"></a><a name="rnLocalBindsAndThen"></a><span class='hs-definition'>rnLocalBindsAndThen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsLocalBinds</span> <span class='hs-conid'>GhcPs</span>
<a name="line-209"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLocalBinds</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-210"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-211"></a><span class='hs-comment'>-- This version (a) assumes that the binding vars are *not* already in scope</span>
<a name="line-212"></a><span class='hs-comment'>--               (b) removes the binders from the free vars of the thing inside</span>
<a name="line-213"></a><span class='hs-comment'>-- The parser doesn't produce ThenBinds</span>
<a name="line-214"></a><span class='hs-definition'>rnLocalBindsAndThen</span> <span class='hs-layout'>(</span><span class='hs-conid'>EmptyLocalBinds</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span> <span class='hs-keyglyph'>=</span>
<a name="line-215"></a>  <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-conid'>EmptyLocalBinds</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyNameSet</span>
<a name="line-216"></a>
<a name="line-217"></a><span class='hs-definition'>rnLocalBindsAndThen</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-varid'>x</span> <span class='hs-varid'>val_binds</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-218"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLocalValBindsAndThen</span> <span class='hs-varid'>val_binds</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>val_binds'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-219"></a>      <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-varid'>x</span> <span class='hs-varid'>val_binds'</span><span class='hs-layout'>)</span>
<a name="line-220"></a>
<a name="line-221"></a><span class='hs-definition'>rnLocalBindsAndThen</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIPBinds</span> <span class='hs-varid'>x</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-222"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>binds'</span><span class='hs-layout'>,</span><span class='hs-varid'>fv_binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnIPBinds</span> <span class='hs-varid'>binds</span>
<a name="line-223"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIPBinds</span> <span class='hs-varid'>x</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_binds</span>
<a name="line-224"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_thing</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fv_binds</span><span class='hs-layout'>)</span>
<a name="line-225"></a>
<a name="line-226"></a><a name="rnIPBinds"></a><span class='hs-definition'>rnIPBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsIPBinds</span> <span class='hs-conid'>GhcPs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIPBinds</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-227"></a><span class='hs-definition'>rnIPBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBinds</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ip_binds</span> <span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-228"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ip_binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocFstMA</span> <span class='hs-varid'>rnIPBind</span><span class='hs-layout'>)</span> <span class='hs-varid'>ip_binds</span>
<a name="line-229"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBinds</span> <span class='hs-varid'>noExtField</span> <span class='hs-varid'>ip_binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>plusFVs</span> <span class='hs-varid'>fvs_s</span><span class='hs-layout'>)</span>
<a name="line-230"></a>
<a name="line-231"></a><a name="rnIPBind"></a><span class='hs-definition'>rnIPBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IPBind</span> <span class='hs-conid'>GhcPs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBind</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-232"></a><span class='hs-definition'>rnIPBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBind</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>~</span><span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-233"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-234"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBind</span> <span class='hs-varid'>noAnn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span>
<a name="line-235"></a>
<a name="line-236"></a><span class='hs-comment'>{-
<a name="line-237"></a>************************************************************************
<a name="line-238"></a>*                                                                      *
<a name="line-239"></a>                ValBinds
<a name="line-240"></a>*                                                                      *
<a name="line-241"></a>************************************************************************
<a name="line-242"></a>-}</span>
<a name="line-243"></a>
<a name="line-244"></a><a name="rnLocalValBindsLHS"></a><span class='hs-comment'>-- Renaming local binding groups</span>
<a name="line-245"></a><span class='hs-comment'>-- Does duplicate/shadow check</span>
<a name="line-246"></a><span class='hs-definition'>rnLocalValBindsLHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MiniFixityEnv</span>
<a name="line-247"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>GhcPs</span>
<a name="line-248"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsValBindsLR</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-249"></a><span class='hs-definition'>rnLocalValBindsLHS</span> <span class='hs-varid'>fix_env</span> <span class='hs-varid'>binds</span>
<a name="line-250"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>binds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnValBindsLHS</span> <span class='hs-layout'>(</span><span class='hs-varid'>localRecNameMaker</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span>
<a name="line-251"></a>
<a name="line-252"></a>         <span class='hs-comment'>-- Check for duplicates and shadowing</span>
<a name="line-253"></a>         <span class='hs-comment'>-- Must do this *after* renaming the patterns</span>
<a name="line-254"></a>         <span class='hs-comment'>-- See Note [Collect binders only after renaming] in GHC.Hs.Utils</span>
<a name="line-255"></a>
<a name="line-256"></a>         <span class='hs-comment'>-- We need to check for dups here because we</span>
<a name="line-257"></a>         <span class='hs-comment'>-- don't don't bind all of the variables from the ValBinds at once</span>
<a name="line-258"></a>         <span class='hs-comment'>-- with bindLocatedLocals any more.</span>
<a name="line-259"></a>         <span class='hs-comment'>--</span>
<a name="line-260"></a>         <span class='hs-comment'>-- Note that we don't want to do this at the top level, since</span>
<a name="line-261"></a>         <span class='hs-comment'>-- sorting out duplicates and shadowing there happens elsewhere.</span>
<a name="line-262"></a>         <span class='hs-comment'>-- The behavior is even different. For example,</span>
<a name="line-263"></a>         <span class='hs-comment'>--   import A(f)</span>
<a name="line-264"></a>         <span class='hs-comment'>--   f = ...</span>
<a name="line-265"></a>         <span class='hs-comment'>-- should not produce a shadowing warning (but it will produce</span>
<a name="line-266"></a>         <span class='hs-comment'>-- an ambiguity warning if you use f), but</span>
<a name="line-267"></a>         <span class='hs-comment'>--   import A(f)</span>
<a name="line-268"></a>         <span class='hs-comment'>--   g = let f = ... in f</span>
<a name="line-269"></a>         <span class='hs-comment'>-- should.</span>
<a name="line-270"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bound_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectHsValBinders</span> <span class='hs-conid'>CollNoDictBinders</span> <span class='hs-varid'>binds'</span>
<a name="line-271"></a>             <span class='hs-comment'>-- There should be only Ids, but if there are any bogus</span>
<a name="line-272"></a>             <span class='hs-comment'>-- pattern synonyms, we'll collect them anyway, so that</span>
<a name="line-273"></a>             <span class='hs-comment'>-- we don't generate subsequent out-of-scope messages</span>
<a name="line-274"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getRdrEnvs</span>
<a name="line-275"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkDupAndShadowedNames</span> <span class='hs-varid'>envs</span> <span class='hs-varid'>bound_names</span>
<a name="line-276"></a>
<a name="line-277"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bound_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-278"></a>
<a name="line-279"></a><a name="rnValBindsLHS"></a><span class='hs-comment'>-- renames the left-hand sides</span>
<a name="line-280"></a><span class='hs-comment'>-- generic version used both at the top level and for local binds</span>
<a name="line-281"></a><span class='hs-comment'>-- does some error checking, but not what gets done elsewhere at the top level</span>
<a name="line-282"></a><span class='hs-definition'>rnValBindsLHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameMaker</span>
<a name="line-283"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>GhcPs</span>
<a name="line-284"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBindsLR</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-285"></a><span class='hs-definition'>rnValBindsLHS</span> <span class='hs-varid'>topP</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValBinds</span> <span class='hs-varid'>x</span> <span class='hs-varid'>mbinds</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span>
<a name="line-286"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mbinds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapBagM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocMA</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnBindLHS</span> <span class='hs-varid'>topP</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>mbinds</span>
<a name="line-287"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ValBinds</span> <span class='hs-varid'>x</span> <span class='hs-varid'>mbinds'</span> <span class='hs-varid'>sigs</span> <span class='hs-layout'>}</span>
<a name="line-288"></a>  <span class='hs-keyword'>where</span>
<a name="line-289"></a>    <span class='hs-varid'>bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectHsBindsBinders</span> <span class='hs-conid'>CollNoDictBinders</span> <span class='hs-varid'>mbinds</span>
<a name="line-290"></a>    <span class='hs-varid'>doc</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"In the binding group for:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bndrs</span>
<a name="line-291"></a>
<a name="line-292"></a><span class='hs-definition'>rnValBindsLHS</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rnValBindsLHSFromDoc"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-293"></a>
<a name="line-294"></a><a name="rnValBindsRHS"></a><span class='hs-comment'>-- General version used both from the top-level and for local things</span>
<a name="line-295"></a><span class='hs-comment'>-- Assumes the LHS vars are in scope</span>
<a name="line-296"></a><span class='hs-comment'>--</span>
<a name="line-297"></a><span class='hs-comment'>-- Does not bind the local fixity declarations</span>
<a name="line-298"></a><span class='hs-definition'>rnValBindsRHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSigCtxt</span>
<a name="line-299"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsValBindsLR</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcPs</span>
<a name="line-300"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>DefUses</span><span class='hs-layout'>)</span>
<a name="line-301"></a>
<a name="line-302"></a><span class='hs-definition'>rnValBindsRHS</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValBinds</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>mbinds</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span>
<a name="line-303"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>sigs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>renameSigs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sigs</span>
<a name="line-304"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>binds_w_dus</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapBagM</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnLBind</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkScopedTvFn</span> <span class='hs-varid'>sigs'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>mbinds</span>
<a name="line-305"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-varid'>anal_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>anal_dus</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>depAnalBinds</span> <span class='hs-varid'>binds_w_dus</span>
<a name="line-306"></a>
<a name="line-307"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>patsyn_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionNameSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>psb_ext</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyNameSet</span> <span class='hs-varop'>$</span>
<a name="line-308"></a>                          <span class='hs-varid'>getPatSynBinds</span> <span class='hs-varid'>anal_binds</span>
<a name="line-309"></a>                <span class='hs-comment'>-- The uses in binds_w_dus for PatSynBinds do not include</span>
<a name="line-310"></a>                <span class='hs-comment'>-- variables used in the patsyn builders; see</span>
<a name="line-311"></a>                <span class='hs-comment'>-- Note [Pattern synonym builders don't yield dependencies]</span>
<a name="line-312"></a>                <span class='hs-comment'>-- But psb_fvs /does/ include those builder fvs.  So we</span>
<a name="line-313"></a>                <span class='hs-comment'>-- add them back in here to avoid bogus warnings about</span>
<a name="line-314"></a>                <span class='hs-comment'>-- unused variables (#12548)</span>
<a name="line-315"></a>
<a name="line-316"></a>             <span class='hs-varid'>valbind'_dus</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>anal_dus</span> <span class='hs-varop'>`plusDU`</span> <span class='hs-varid'>usesOnly</span> <span class='hs-varid'>sig_fvs</span>
<a name="line-317"></a>                                     <span class='hs-varop'>`plusDU`</span> <span class='hs-varid'>usesOnly</span> <span class='hs-varid'>patsyn_fvs</span>
<a name="line-318"></a>                            <span class='hs-comment'>-- Put the sig uses *after* the bindings</span>
<a name="line-319"></a>                            <span class='hs-comment'>-- so that the binders are removed from</span>
<a name="line-320"></a>                            <span class='hs-comment'>-- the uses in the sigs</span>
<a name="line-321"></a>
<a name="line-322"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>XValBindsLR</span> <span class='hs-layout'>(</span><span class='hs-conid'>NValBinds</span> <span class='hs-varid'>anal_binds</span> <span class='hs-varid'>sigs'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>valbind'_dus</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-323"></a>
<a name="line-324"></a><span class='hs-definition'>rnValBindsRHS</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rnValBindsRHS"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-325"></a>
<a name="line-326"></a><a name="rnLocalValBindsRHS"></a><span class='hs-comment'>-- Wrapper for local binds</span>
<a name="line-327"></a><span class='hs-comment'>--</span>
<a name="line-328"></a><span class='hs-comment'>-- The *client* of this function is responsible for checking for unused binders;</span>
<a name="line-329"></a><span class='hs-comment'>-- it doesn't (and can't: we don't have the thing inside the binds) happen here</span>
<a name="line-330"></a><span class='hs-comment'>--</span>
<a name="line-331"></a><span class='hs-comment'>-- The client is also responsible for bringing the fixities into scope</span>
<a name="line-332"></a><span class='hs-definition'>rnLocalValBindsRHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSet</span>  <span class='hs-comment'>-- names bound by the LHSes</span>
<a name="line-333"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsValBindsLR</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcPs</span>
<a name="line-334"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>DefUses</span><span class='hs-layout'>)</span>
<a name="line-335"></a><span class='hs-definition'>rnLocalValBindsRHS</span> <span class='hs-varid'>bound_names</span> <span class='hs-varid'>binds</span>
<a name="line-336"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnValBindsRHS</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocalBindCtxt</span> <span class='hs-varid'>bound_names</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span>
<a name="line-337"></a>
<a name="line-338"></a><a name="rnLocalValBindsAndThen"></a><span class='hs-comment'>-- for local binds</span>
<a name="line-339"></a><span class='hs-comment'>-- wrapper that does both the left- and right-hand sides</span>
<a name="line-340"></a><span class='hs-comment'>--</span>
<a name="line-341"></a><span class='hs-comment'>-- here there are no local fixity decls passed in;</span>
<a name="line-342"></a><span class='hs-comment'>-- the local fixity decls come from the ValBinds sigs</span>
<a name="line-343"></a><span class='hs-definition'>rnLocalValBindsAndThen</span>
<a name="line-344"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>GhcPs</span>
<a name="line-345"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-346"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-347"></a><span class='hs-definition'>rnLocalValBindsAndThen</span> <span class='hs-varid'>binds</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ValBinds</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-348"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>   <span class='hs-layout'>{</span>     <span class='hs-comment'>-- (A) Create the local fixity environment</span>
<a name="line-349"></a>          <span class='hs-varid'>new_fixities</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>makeMiniFixityEnv</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>sig</span>
<a name="line-350"></a>                                            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>FixSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sigs</span><span class='hs-keyglyph'>]</span>
<a name="line-351"></a>
<a name="line-352"></a>              <span class='hs-comment'>-- (B) Rename the LHSes</span>
<a name="line-353"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>bound_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_lhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLocalValBindsLHS</span> <span class='hs-varid'>new_fixities</span> <span class='hs-varid'>binds</span>
<a name="line-354"></a>
<a name="line-355"></a>              <span class='hs-comment'>--     ...and bring them (and their fixities) into scope</span>
<a name="line-356"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>bindLocalNamesFV</span> <span class='hs-varid'>bound_names</span>              <span class='hs-varop'>$</span>
<a name="line-357"></a>          <span class='hs-varid'>addLocalFixities</span> <span class='hs-varid'>new_fixities</span> <span class='hs-varid'>bound_names</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-358"></a>
<a name="line-359"></a>        <span class='hs-layout'>{</span>      <span class='hs-comment'>-- (C) Do the RHS and thing inside</span>
<a name="line-360"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>dus</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLocalValBindsRHS</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNameSet</span> <span class='hs-varid'>bound_names</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_lhs</span>
<a name="line-361"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>result_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>binds'</span> <span class='hs-layout'>(</span><span class='hs-varid'>allUses</span> <span class='hs-varid'>dus</span><span class='hs-layout'>)</span>
<a name="line-362"></a>
<a name="line-363"></a>                <span class='hs-comment'>-- Report unused bindings based on the (accurate)</span>
<a name="line-364"></a>                <span class='hs-comment'>-- findUses.  E.g.</span>
<a name="line-365"></a>                <span class='hs-comment'>--      let x = x in 3</span>
<a name="line-366"></a>                <span class='hs-comment'>-- should report 'x' unused</span>
<a name="line-367"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>real_uses</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findUses</span> <span class='hs-varid'>dus</span> <span class='hs-varid'>result_fvs</span>
<a name="line-368"></a>              <span class='hs-comment'>-- Insert fake uses for variables introduced implicitly by</span>
<a name="line-369"></a>              <span class='hs-comment'>-- wildcards (#4404)</span>
<a name="line-370"></a>              <span class='hs-varid'>rec_uses</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsValBindsImplicits</span> <span class='hs-varid'>binds'</span>
<a name="line-371"></a>              <span class='hs-varid'>implicit_uses</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>snd</span>
<a name="line-372"></a>                                        <span class='hs-varop'>$</span> <span class='hs-varid'>rec_uses</span>
<a name="line-373"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-374"></a>                    <span class='hs-varid'>checkUnusedRecordWildcard</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>real_uses</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-375"></a>                <span class='hs-varid'>rec_uses</span>
<a name="line-376"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>warnUnusedLocalBinds</span> <span class='hs-varid'>bound_names</span>
<a name="line-377"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>real_uses</span> <span class='hs-varop'>`unionNameSet`</span> <span class='hs-varid'>implicit_uses</span><span class='hs-layout'>)</span>
<a name="line-378"></a>
<a name="line-379"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>
<a name="line-380"></a>            <span class='hs-comment'>-- The variables "used" in the val binds are:</span>
<a name="line-381"></a>            <span class='hs-comment'>--   (1) the uses of the binds (allUses)</span>
<a name="line-382"></a>            <span class='hs-comment'>--   (2) the FVs of the thing-inside</span>
<a name="line-383"></a>            <span class='hs-varid'>all_uses</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>allUses</span> <span class='hs-varid'>dus</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>result_fvs</span>
<a name="line-384"></a>                <span class='hs-comment'>-- Note [Unused binding hack]</span>
<a name="line-385"></a>                <span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-386"></a>                <span class='hs-comment'>-- Note that *in contrast* to the above reporting of</span>
<a name="line-387"></a>                <span class='hs-comment'>-- unused bindings, (1) above uses duUses to return *all*</span>
<a name="line-388"></a>                <span class='hs-comment'>-- the uses, even if the binding is unused.  Otherwise consider:</span>
<a name="line-389"></a>                <span class='hs-comment'>--      x = 3</span>
<a name="line-390"></a>                <span class='hs-comment'>--      y = let p = x in 'x'    -- NB: p not used</span>
<a name="line-391"></a>                <span class='hs-comment'>-- If we don't "see" the dependency of 'y' on 'x', we may put the</span>
<a name="line-392"></a>                <span class='hs-comment'>-- bindings in the wrong order, and the type checker will complain</span>
<a name="line-393"></a>                <span class='hs-comment'>-- that x isn't in scope</span>
<a name="line-394"></a>                <span class='hs-comment'>--</span>
<a name="line-395"></a>                <span class='hs-comment'>-- But note that this means we won't report 'x' as unused,</span>
<a name="line-396"></a>                <span class='hs-comment'>-- whereas we would if we had { x = 3; p = x; y = 'x' }</span>
<a name="line-397"></a>
<a name="line-398"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>all_uses</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-399"></a>                <span class='hs-comment'>-- The bound names are pruned out of all_uses</span>
<a name="line-400"></a>                <span class='hs-comment'>-- by the bindLocalNamesFV call above</span>
<a name="line-401"></a>
<a name="line-402"></a><span class='hs-definition'>rnLocalValBindsAndThen</span> <span class='hs-varid'>bs</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rnLocalValBindsAndThen"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-403"></a>
<a name="line-404"></a>
<a name="line-405"></a><span class='hs-comment'>---------------------</span>
<a name="line-406"></a>
<a name="line-407"></a><span class='hs-comment'>-- renaming a single bind</span>
<a name="line-408"></a>
<a name="line-409"></a><a name="rnBindLHS"></a><span class='hs-definition'>rnBindLHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameMaker</span>
<a name="line-410"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-411"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsBind</span> <span class='hs-conid'>GhcPs</span>
<a name="line-412"></a>          <span class='hs-comment'>-- returns the renamed left-hand side,</span>
<a name="line-413"></a>          <span class='hs-comment'>-- and the FreeVars *of the LHS*</span>
<a name="line-414"></a>          <span class='hs-comment'>-- (i.e., any free variables of the pattern)</span>
<a name="line-415"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBindLR</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-416"></a>
<a name="line-417"></a><span class='hs-definition'>rnBindLHS</span> <span class='hs-varid'>name_maker</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PatBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-418"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-419"></a>      <span class='hs-comment'>-- we don't actually use the FV processing of rnPatsAndThen here</span>
<a name="line-420"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span><span class='hs-varid'>pat'_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnBindPat</span> <span class='hs-varid'>name_maker</span> <span class='hs-varid'>pat</span>
<a name="line-421"></a>      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_ext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat'_fvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-422"></a>                <span class='hs-comment'>-- We temporarily store the pat's FVs in bind_fvs;</span>
<a name="line-423"></a>                <span class='hs-comment'>-- gets updated to the FVs of the whole bind</span>
<a name="line-424"></a>                <span class='hs-comment'>-- when doing the RHS below</span>
<a name="line-425"></a>
<a name="line-426"></a><span class='hs-definition'>rnBindLHS</span> <span class='hs-varid'>name_maker</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rdr_name</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-427"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>applyNameMaker</span> <span class='hs-varid'>name_maker</span> <span class='hs-varid'>rdr_name</span>
<a name="line-428"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span>
<a name="line-429"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>fun_ext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noExtField</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-430"></a>
<a name="line-431"></a><span class='hs-definition'>rnBindLHS</span> <span class='hs-varid'>name_maker</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynBind</span> <span class='hs-varid'>x</span> <span class='hs-varid'>psb</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>PSB</span><span class='hs-layout'>{</span> <span class='hs-varid'>psb_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rdrname</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-432"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTopRecNameMaker</span> <span class='hs-varid'>name_maker</span>
<a name="line-433"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>addLocMA</span> <span class='hs-varid'>checkConName</span> <span class='hs-varid'>rdrname</span>
<a name="line-434"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupLocatedTopBndrRnN</span> <span class='hs-varid'>rdrname</span> <span class='hs-comment'>-- Should be in scope already</span>
<a name="line-435"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynBind</span> <span class='hs-varid'>x</span> <span class='hs-varid'>psb</span><span class='hs-layout'>{</span> <span class='hs-varid'>psb_ext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noAnn</span><span class='hs-layout'>,</span> <span class='hs-varid'>psb_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-436"></a>
<a name="line-437"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-comment'>-- Pattern synonym, not at top level</span>
<a name="line-438"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>addErr</span> <span class='hs-varid'>localPatternSynonymErr</span>  <span class='hs-comment'>-- Complain, but make up a fake</span>
<a name="line-439"></a>                                        <span class='hs-comment'>-- name so that we can carry on</span>
<a name="line-440"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>applyNameMaker</span> <span class='hs-varid'>name_maker</span> <span class='hs-varid'>rdrname</span>
<a name="line-441"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynBind</span> <span class='hs-varid'>x</span> <span class='hs-varid'>psb</span><span class='hs-layout'>{</span> <span class='hs-varid'>psb_ext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noAnn</span><span class='hs-layout'>,</span> <span class='hs-varid'>psb_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-442"></a>  <span class='hs-keyword'>where</span>
<a name="line-443"></a>    <span class='hs-varid'>localPatternSynonymErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-444"></a>    <span class='hs-varid'>localPatternSynonymErr</span>
<a name="line-445"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Illegal pattern synonym declaration for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rdrname</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-446"></a>           <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Pattern synonym declarations are only valid at top level"</span><span class='hs-layout'>)</span>
<a name="line-447"></a>
<a name="line-448"></a><span class='hs-definition'>rnBindLHS</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rnBindHS"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-449"></a>
<a name="line-450"></a><a name="rnLBind"></a><span class='hs-definition'>rnLBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>      <span class='hs-comment'>-- Signature tyvar function</span>
<a name="line-451"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsBindLR</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcPs</span>
<a name="line-452"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBind</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Uses</span><span class='hs-layout'>)</span>
<a name="line-453"></a><span class='hs-definition'>rnLBind</span> <span class='hs-varid'>sig_fn</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>
<a name="line-454"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpanA</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-455"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>dus</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnBind</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>bind</span>
<a name="line-456"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>bind'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>dus</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-457"></a>
<a name="line-458"></a><a name="rnBind"></a><span class='hs-comment'>-- assumes the left-hands-side vars are in scope</span>
<a name="line-459"></a><span class='hs-definition'>rnBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- Signature tyvar function</span>
<a name="line-460"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsBindLR</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcPs</span>
<a name="line-461"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBind</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Uses</span><span class='hs-layout'>)</span>
<a name="line-462"></a><span class='hs-definition'>rnBind</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PatBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat</span>
<a name="line-463"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>pat_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grhss</span>
<a name="line-464"></a>                                   <span class='hs-comment'>-- pat fvs were stored in bind_fvs</span>
<a name="line-465"></a>                                   <span class='hs-comment'>-- after processing the LHS</span>
<a name="line-466"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>pat_ext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat_fvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-467"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-468"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>grhss'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnGRHSs</span> <span class='hs-conid'>PatBindRhs</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>grhss</span>
<a name="line-469"></a>
<a name="line-470"></a>                <span class='hs-comment'>-- No scoped type variables for pattern bindings</span>
<a name="line-471"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>all_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat_fvs</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>rhs_fvs</span>
<a name="line-472"></a>              <span class='hs-varid'>fvs'</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>all_fvs</span>
<a name="line-473"></a>                <span class='hs-comment'>-- Keep locally-defined Names</span>
<a name="line-474"></a>                <span class='hs-comment'>-- As well as dependency analysis, we need these for the</span>
<a name="line-475"></a>                <span class='hs-comment'>-- MonoLocalBinds test in GHC.Tc.Gen.Bind.decideGeneralisationPlan</span>
<a name="line-476"></a>              <span class='hs-varid'>bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectPatBinders</span> <span class='hs-conid'>CollNoDictBinders</span> <span class='hs-varid'>pat</span>
<a name="line-477"></a>              <span class='hs-varid'>bind'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_rhs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grhss'</span>
<a name="line-478"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>pat_ext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvs'</span> <span class='hs-layout'>}</span>
<a name="line-479"></a>
<a name="line-480"></a>              <span class='hs-varid'>ok_nobind_pat</span>
<a name="line-481"></a>                  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- See Note [Pattern bindings that bind no variables]</span>
<a name="line-482"></a>                    <span class='hs-keyword'>case</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>pat</span> <span class='hs-keyword'>of</span>
<a name="line-483"></a>                       <span class='hs-conid'>WildPat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-484"></a>                       <span class='hs-conid'>BangPat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span> <span class='hs-comment'>-- #9127, #13646</span>
<a name="line-485"></a>                       <span class='hs-conid'>SplicePat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-486"></a>                       <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-487"></a>
<a name="line-488"></a>        <span class='hs-comment'>-- Warn if the pattern binds no variables</span>
<a name="line-489"></a>        <span class='hs-comment'>-- See Note [Pattern bindings that bind no variables]</span>
<a name="line-490"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>whenWOptM</span> <span class='hs-conid'>Opt_WarnUnusedPatternBinds</span> <span class='hs-varop'>$</span>
<a name="line-491"></a>          <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>bndrs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>ok_nobind_pat</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-492"></a>          <span class='hs-varid'>addWarn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Reason</span> <span class='hs-conid'>Opt_WarnUnusedPatternBinds</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-493"></a>          <span class='hs-varid'>unusedPatBindWarn</span> <span class='hs-varid'>bind'</span>
<a name="line-494"></a>
<a name="line-495"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>fvs'</span> <span class='hs-varop'>`seq`</span> <span class='hs-comment'>-- See Note [Free-variable space leak]</span>
<a name="line-496"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>all_fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-497"></a>
<a name="line-498"></a><span class='hs-definition'>rnBind</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span>
<a name="line-499"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>fun_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matches</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-500"></a>       <span class='hs-comment'>-- invariant: no free vars here when it's a FunBind</span>
<a name="line-501"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>plain_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>name</span>
<a name="line-502"></a>
<a name="line-503"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>matches'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindSigTyVarsFV</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_fn</span> <span class='hs-varid'>plain_name</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-504"></a>                                <span class='hs-comment'>-- bindSigTyVars tests for LangExt.ScopedTyVars</span>
<a name="line-505"></a>                                 <span class='hs-varid'>rnMatchGroup</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPrefixFunRhs</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-506"></a>                                              <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>matches</span>
<a name="line-507"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>is_infix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isInfixFunBind</span> <span class='hs-varid'>bind</span>
<a name="line-508"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-varid'>is_infix</span> <span class='hs-varop'>$</span> <span class='hs-varid'>checkPrecMatch</span> <span class='hs-varid'>plain_name</span> <span class='hs-varid'>matches'</span>
<a name="line-509"></a>
<a name="line-510"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-511"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fvs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs_fvs</span>
<a name="line-512"></a>                <span class='hs-comment'>-- Keep locally-defined Names</span>
<a name="line-513"></a>                <span class='hs-comment'>-- As well as dependency analysis, we need these for the</span>
<a name="line-514"></a>                <span class='hs-comment'>-- MonoLocalBinds test in GHC.Tc.Gen.Bind.decideGeneralisationPlan</span>
<a name="line-515"></a>
<a name="line-516"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>fvs'</span> <span class='hs-varop'>`seq`</span> <span class='hs-comment'>-- See Note [Free-variable space leak]</span>
<a name="line-517"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matches'</span>
<a name="line-518"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>fun_ext</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvs'</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span>
<a name="line-519"></a>                  <span class='hs-keyglyph'>[</span><span class='hs-varid'>plain_name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_fvs</span><span class='hs-layout'>)</span>
<a name="line-520"></a>      <span class='hs-layout'>}</span>
<a name="line-521"></a>
<a name="line-522"></a><span class='hs-definition'>rnBind</span> <span class='hs-varid'>sig_fn</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynBind</span> <span class='hs-varid'>x</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>
<a name="line-523"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind'</span><span class='hs-layout'>,</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnPatSynBind</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>bind</span>
<a name="line-524"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynBind</span> <span class='hs-varid'>x</span> <span class='hs-varid'>bind'</span><span class='hs-layout'>,</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-525"></a>
<a name="line-526"></a><span class='hs-definition'>rnBind</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rnBind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-527"></a>
<a name="line-528"></a><span class='hs-comment'>{- Note [Pattern bindings that bind no variables]
<a name="line-529"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-530"></a>Generally, we want to warn about pattern bindings like
<a name="line-531"></a>  Just _ = e
<a name="line-532"></a>because they don't do anything!  But we have three exceptions:
<a name="line-533"></a>
<a name="line-534"></a>* A wildcard pattern
<a name="line-535"></a>       _ = rhs
<a name="line-536"></a>  which (a) is not that different from  _v = rhs
<a name="line-537"></a>        (b) is sometimes used to give a type sig for,
<a name="line-538"></a>            or an occurrence of, a variable on the RHS
<a name="line-539"></a>
<a name="line-540"></a>* A strict pattern binding; that is, one with an outermost bang
<a name="line-541"></a>     !Just _ = e
<a name="line-542"></a>  This can fail, so unlike the lazy variant, it is not a no-op.
<a name="line-543"></a>  Moreover, #13646 argues that even for single constructor
<a name="line-544"></a>  types, you might want to write the constructor.  See also #9127.
<a name="line-545"></a>
<a name="line-546"></a>* A splice pattern
<a name="line-547"></a>      $(th-lhs) = rhs
<a name="line-548"></a>   It is impossible to determine whether or not th-lhs really
<a name="line-549"></a>   binds any variable. We should disable the warning for any pattern
<a name="line-550"></a>   which contain splices, but that is a more expensive check.
<a name="line-551"></a>
<a name="line-552"></a>Note [Free-variable space leak]
<a name="line-553"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-554"></a>We have
<a name="line-555"></a>    fvs' = trim fvs
<a name="line-556"></a>and we seq fvs' before turning it as part of a record.
<a name="line-557"></a>
<a name="line-558"></a>The reason is that trim is sometimes something like
<a name="line-559"></a>    \xs -&gt; intersectNameSet (mkNameSet bound_names) xs
<a name="line-560"></a>and we don't want to retain the list bound_names. This showed up in
<a name="line-561"></a>trac ticket #1136.
<a name="line-562"></a>-}</span>
<a name="line-563"></a>
<a name="line-564"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-565"></a>*                                                                      *
<a name="line-566"></a>          Dependency analysis and other support functions
<a name="line-567"></a>*                                                                      *
<a name="line-568"></a>********************************************************************* -}</span>
<a name="line-569"></a>
<a name="line-570"></a><a name="depAnalBinds"></a><span class='hs-definition'>depAnalBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBind</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Uses</span><span class='hs-layout'>)</span>
<a name="line-571"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>RecFlag</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>DefUses</span><span class='hs-layout'>)</span>
<a name="line-572"></a><span class='hs-comment'>-- Dependency analysis; this is important so that</span>
<a name="line-573"></a><span class='hs-comment'>-- unused-binding reporting is accurate</span>
<a name="line-574"></a><span class='hs-definition'>depAnalBinds</span> <span class='hs-varid'>binds_w_dus</span>
<a name="line-575"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>get_binds</span> <span class='hs-varid'>sccs</span><span class='hs-layout'>,</span> <span class='hs-varid'>toOL</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>get_du</span> <span class='hs-varid'>sccs</span><span class='hs-layout'>)</span>
<a name="line-576"></a>  <span class='hs-keyword'>where</span>
<a name="line-577"></a>    <span class='hs-varid'>sccs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>depAnal</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>defs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>defs</span><span class='hs-layout'>)</span>
<a name="line-578"></a>                   <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>nonDetEltsUniqSet</span> <span class='hs-varid'>uses</span><span class='hs-layout'>)</span>
<a name="line-579"></a>                   <span class='hs-comment'>-- It's OK to use nonDetEltsUniqSet here as explained in</span>
<a name="line-580"></a>                   <span class='hs-comment'>-- Note [depAnal determinism] in GHC.Types.Name.Env.</span>
<a name="line-581"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>binds_w_dus</span><span class='hs-layout'>)</span>
<a name="line-582"></a>
<a name="line-583"></a>    <span class='hs-varid'>get_binds</span> <span class='hs-layout'>(</span><span class='hs-conid'>AcyclicSCC</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRecursive</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitBag</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>
<a name="line-584"></a>    <span class='hs-varid'>get_binds</span> <span class='hs-layout'>(</span><span class='hs-conid'>CyclicSCC</span>  <span class='hs-varid'>binds_w_dus</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Recursive</span><span class='hs-layout'>,</span> <span class='hs-varid'>listToBag</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>binds_w_dus</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-585"></a>
<a name="line-586"></a>    <span class='hs-varid'>get_du</span> <span class='hs-layout'>(</span><span class='hs-conid'>AcyclicSCC</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNameSet</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses</span><span class='hs-layout'>)</span>
<a name="line-587"></a>    <span class='hs-varid'>get_du</span> <span class='hs-layout'>(</span><span class='hs-conid'>CyclicSCC</span>  <span class='hs-varid'>binds_w_dus</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>defs</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses</span><span class='hs-layout'>)</span>
<a name="line-588"></a>        <span class='hs-keyword'>where</span>
<a name="line-589"></a>          <span class='hs-varid'>defs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameSet</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>binds_w_dus</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bs</span><span class='hs-keyglyph'>]</span>
<a name="line-590"></a>          <span class='hs-varid'>uses</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionNameSets</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>u</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>binds_w_dus</span><span class='hs-keyglyph'>]</span>
<a name="line-591"></a>
<a name="line-592"></a><span class='hs-comment'>---------------------</span>
<a name="line-593"></a><span class='hs-comment'>-- Bind the top-level forall'd type variables in the sigs.</span>
<a name="line-594"></a><span class='hs-comment'>-- E.g  f :: forall a. a -&gt; a</span>
<a name="line-595"></a><span class='hs-comment'>--      f = rhs</span>
<a name="line-596"></a><span class='hs-comment'>--      The 'a' scopes over the rhs</span>
<a name="line-597"></a><span class='hs-comment'>--</span>
<a name="line-598"></a><span class='hs-comment'>-- NB: there'll usually be just one (for a function binding)</span>
<a name="line-599"></a><span class='hs-comment'>--     but if there are many, one may shadow the rest; too bad!</span>
<a name="line-600"></a><span class='hs-comment'>--      e.g  x :: forall a. [a] -&gt; [a]</span>
<a name="line-601"></a><span class='hs-comment'>--           y :: forall a. [(a,a)] -&gt; a</span>
<a name="line-602"></a><span class='hs-comment'>--           (x,y) = e</span>
<a name="line-603"></a><span class='hs-comment'>--      In e, 'a' will be in scope, and it'll be the one from 'y'!</span>
<a name="line-604"></a>
<a name="line-605"></a><a name="mkScopedTvFn"></a><span class='hs-definition'>mkScopedTvFn</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-606"></a><span class='hs-comment'>-- Return a lookup function that maps an Id Name to the names</span>
<a name="line-607"></a><span class='hs-comment'>-- of the type variables that should scope over its body.</span>
<a name="line-608"></a><span class='hs-definition'>mkScopedTvFn</span> <span class='hs-varid'>sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`orElse`</span> <span class='hs-conid'>[]</span>
<a name="line-609"></a>  <span class='hs-keyword'>where</span>
<a name="line-610"></a>    <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHsSigEnv</span> <span class='hs-varid'>get_scoped_tvs</span> <span class='hs-varid'>sigs</span>
<a name="line-611"></a>
<a name="line-612"></a>    <span class='hs-varid'>get_scoped_tvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LocatedN</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-613"></a>    <span class='hs-comment'>-- Returns (binders, scoped tvs for those binders)</span>
<a name="line-614"></a>    <span class='hs-varid'>get_scoped_tvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassOpSig</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>names</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-615"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>names</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsScopedTvs</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span>
<a name="line-616"></a>    <span class='hs-varid'>get_scoped_tvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>names</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-617"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>names</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsWcScopedTvs</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span>
<a name="line-618"></a>    <span class='hs-varid'>get_scoped_tvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>names</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-619"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>names</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsScopedTvs</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span>
<a name="line-620"></a>    <span class='hs-varid'>get_scoped_tvs</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-621"></a>
<a name="line-622"></a><span class='hs-comment'>-- Process the fixity declarations, making a FastString -&gt; (Located Fixity) map</span>
<a name="line-623"></a><span class='hs-comment'>-- (We keep the location around for reporting duplicate fixity declarations.)</span>
<a name="line-624"></a><span class='hs-comment'>--</span>
<a name="line-625"></a><span class='hs-comment'>-- Checks for duplicates, but not that only locally defined things are fixed.</span>
<a name="line-626"></a><span class='hs-comment'>-- Note: for local fixity declarations, duplicates would also be checked in</span>
<a name="line-627"></a><span class='hs-comment'>--       check_sigs below.  But we also use this function at the top level.</span>
<a name="line-628"></a>
<a name="line-629"></a><a name="makeMiniFixityEnv"></a><span class='hs-definition'>makeMiniFixityEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LFixitySig</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>MiniFixityEnv</span>
<a name="line-630"></a>
<a name="line-631"></a><span class='hs-definition'>makeMiniFixityEnv</span> <span class='hs-varid'>decls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldlM</span> <span class='hs-varid'>add_one_sig</span> <span class='hs-varid'>emptyFsEnv</span> <span class='hs-varid'>decls</span>
<a name="line-632"></a> <span class='hs-keyword'>where</span>
<a name="line-633"></a>   <span class='hs-varid'>add_one_sig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MiniFixityEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LFixitySig</span> <span class='hs-conid'>GhcPs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>MiniFixityEnv</span>
<a name="line-634"></a>   <span class='hs-varid'>add_one_sig</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>FixitySig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>names</span> <span class='hs-varid'>fixity</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-635"></a>     <span class='hs-varid'>foldlM</span> <span class='hs-varid'>add_one</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>loc</span><span class='hs-layout'>,</span><span class='hs-varid'>locA</span> <span class='hs-varid'>name_loc</span><span class='hs-layout'>,</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span><span class='hs-varid'>fixity</span><span class='hs-layout'>)</span>
<a name="line-636"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-varid'>name_loc</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>]</span>
<a name="line-637"></a>
<a name="line-638"></a>   <span class='hs-varid'>add_one</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>name_loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span><span class='hs-varid'>fixity</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-639"></a>     <span class='hs-layout'>{</span> <span class='hs-comment'>-- this fixity decl is a duplicate iff</span>
<a name="line-640"></a>       <span class='hs-comment'>-- the ReaderName's OccName's FastString is already in the env</span>
<a name="line-641"></a>       <span class='hs-comment'>-- (we only need to check the local fix_env because</span>
<a name="line-642"></a>       <span class='hs-comment'>--  definitions of non-local will be caught elsewhere)</span>
<a name="line-643"></a>       <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occNameFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameOcc</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-644"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>fix_item</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>fixity</span> <span class='hs-layout'>}</span><span class='hs-layout'>;</span>
<a name="line-645"></a>
<a name="line-646"></a>       <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupFsEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fs</span> <span class='hs-keyword'>of</span>
<a name="line-647"></a>         <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>extendFsEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fs</span> <span class='hs-varid'>fix_item</span>
<a name="line-648"></a>         <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc'</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-649"></a>           <span class='hs-layout'>{</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-650"></a>             <span class='hs-varid'>addErrAt</span> <span class='hs-varid'>name_loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>dupFixityDecl</span> <span class='hs-varid'>loc'</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-651"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>env</span><span class='hs-layout'>}</span>
<a name="line-652"></a>     <span class='hs-layout'>}</span>
<a name="line-653"></a>
<a name="line-654"></a><a name="dupFixityDecl"></a><span class='hs-definition'>dupFixityDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-655"></a><span class='hs-definition'>dupFixityDecl</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>rdr_name</span>
<a name="line-656"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"Multiple fixity declarations for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rdr_name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-657"></a>          <span class='hs-varid'>text</span> <span class='hs-str'>"also at "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>loc</span><span class='hs-keyglyph'>]</span>
<a name="line-658"></a>
<a name="line-659"></a>
<a name="line-660"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-661"></a>*                                                                      *
<a name="line-662"></a>                Pattern synonym bindings
<a name="line-663"></a>*                                                                      *
<a name="line-664"></a>********************************************************************* -}</span>
<a name="line-665"></a>
<a name="line-666"></a><a name="rnPatSynBind"></a><span class='hs-definition'>rnPatSynBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>           <span class='hs-comment'>-- Signature tyvar function</span>
<a name="line-667"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PatSynBind</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcPs</span>
<a name="line-668"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynBind</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Uses</span><span class='hs-layout'>)</span>
<a name="line-669"></a><span class='hs-definition'>rnPatSynBind</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PSB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>psb_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>name</span>
<a name="line-670"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>psb_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>details</span>
<a name="line-671"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>psb_def</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat</span>
<a name="line-672"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>psb_dir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dir</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-673"></a>       <span class='hs-comment'>-- invariant: no free vars here when it's a FunBind</span>
<a name="line-674"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>pattern_synonym_ok</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt.PatternSynonyms</span>
<a name="line-675"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>pattern_synonym_ok</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-varid'>patternSynonymErr</span><span class='hs-layout'>)</span>
<a name="line-676"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>scoped_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>name</span>
<a name="line-677"></a>
<a name="line-678"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>details'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindSigTyVarsFV</span> <span class='hs-varid'>scoped_tvs</span> <span class='hs-varop'>$</span>
<a name="line-679"></a>                                      <span class='hs-varid'>rnPat</span> <span class='hs-conid'>PatSyn</span> <span class='hs-varid'>pat</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>pat'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-680"></a>         <span class='hs-comment'>-- We check the 'RdrName's instead of the 'Name's</span>
<a name="line-681"></a>         <span class='hs-comment'>-- so that the binding locations are reported</span>
<a name="line-682"></a>         <span class='hs-comment'>-- from the left-hand side</span>
<a name="line-683"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>details</span> <span class='hs-keyword'>of</span>
<a name="line-684"></a>               <span class='hs-conid'>PrefixCon</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>vars</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-685"></a>                   <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkDupRdrNamesN</span> <span class='hs-varid'>vars</span>
<a name="line-686"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>lookupPatSynBndr</span> <span class='hs-varid'>vars</span>
<a name="line-687"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-conid'>PrefixCon</span> <span class='hs-varid'>noTypeArgs</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span>
<a name="line-688"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>mkFVs</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-689"></a>               <span class='hs-conid'>InfixCon</span> <span class='hs-varid'>var1</span> <span class='hs-varid'>var2</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-690"></a>                   <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkDupRdrNames</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>var1</span><span class='hs-layout'>,</span> <span class='hs-varid'>var2</span><span class='hs-keyglyph'>]</span>
<a name="line-691"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>name1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupPatSynBndr</span> <span class='hs-varid'>var1</span>
<a name="line-692"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>name2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupPatSynBndr</span> <span class='hs-varid'>var2</span>
<a name="line-693"></a>                      <span class='hs-comment'>-- ; checkPrecMatch -- TODO</span>
<a name="line-694"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-conid'>InfixCon</span> <span class='hs-varid'>name1</span> <span class='hs-varid'>name2</span><span class='hs-layout'>)</span>
<a name="line-695"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>mkFVs</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>unLoc</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>name1</span><span class='hs-layout'>,</span> <span class='hs-varid'>name2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-696"></a>               <span class='hs-conid'>RecCon</span> <span class='hs-varid'>vars</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-697"></a>                   <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkDupRdrNames</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameFieldOcc</span> <span class='hs-varop'>.</span> <span class='hs-varid'>recordPatSynField</span><span class='hs-layout'>)</span> <span class='hs-varid'>vars</span><span class='hs-layout'>)</span>
<a name="line-698"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>fls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupConstructorFields</span> <span class='hs-varid'>name</span>
<a name="line-699"></a>                      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fld_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFsEnv</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>flLabel</span> <span class='hs-varid'>fl</span><span class='hs-layout'>,</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fls</span> <span class='hs-keyglyph'>]</span>
<a name="line-700"></a>                      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rnRecordPatSynField</span>
<a name="line-701"></a>                              <span class='hs-layout'>(</span><span class='hs-conid'>RecordPatSynField</span> <span class='hs-layout'>{</span> <span class='hs-varid'>recordPatSynField</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>visible</span>
<a name="line-702"></a>                                                 <span class='hs-layout'>,</span> <span class='hs-varid'>recordPatSynPatVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hidden</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-703"></a>                              <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>visible'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupField</span> <span class='hs-varid'>fld_env</span> <span class='hs-varid'>visible</span>
<a name="line-704"></a>                                   <span class='hs-layout'>;</span> <span class='hs-varid'>hidden'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupPatSynBndr</span> <span class='hs-varid'>hidden</span>
<a name="line-705"></a>                                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>RecordPatSynField</span> <span class='hs-layout'>{</span> <span class='hs-varid'>recordPatSynField</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>visible'</span>
<a name="line-706"></a>                                                                <span class='hs-layout'>,</span> <span class='hs-varid'>recordPatSynPatVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hidden'</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-707"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>rnRecordPatSynField</span>  <span class='hs-varid'>vars</span>
<a name="line-708"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-conid'>RecCon</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span>
<a name="line-709"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>mkFVs</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varop'>.</span> <span class='hs-varid'>recordPatSynPatVar</span><span class='hs-layout'>)</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-710"></a>
<a name="line-711"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>dir'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>dir</span> <span class='hs-keyword'>of</span>
<a name="line-712"></a>            <span class='hs-conid'>Unidirectional</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unidirectional</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-713"></a>            <span class='hs-conid'>ImplicitBidirectional</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImplicitBidirectional</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-714"></a>            <span class='hs-conid'>ExplicitBidirectional</span> <span class='hs-varid'>mg</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-715"></a>                <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>mg'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindSigTyVarsFV</span> <span class='hs-varid'>scoped_tvs</span> <span class='hs-varop'>$</span>
<a name="line-716"></a>                                   <span class='hs-varid'>rnMatchGroup</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPrefixFunRhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-717"></a>                                                <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>mg</span>
<a name="line-718"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitBidirectional</span> <span class='hs-varid'>mg'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-719"></a>
<a name="line-720"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-721"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span>
<a name="line-722"></a>              <span class='hs-varid'>fvs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>fvs</span>
<a name="line-723"></a>                <span class='hs-comment'>-- Keep locally-defined Names</span>
<a name="line-724"></a>                <span class='hs-comment'>-- As well as dependency analysis, we need these for the</span>
<a name="line-725"></a>                <span class='hs-comment'>-- MonoLocalBinds test in GHC.Tc.Gen.Bind.decideGeneralisationPlan</span>
<a name="line-726"></a>
<a name="line-727"></a>              <span class='hs-varid'>bind'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bind</span><span class='hs-layout'>{</span> <span class='hs-varid'>psb_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>details'</span>
<a name="line-728"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>psb_def</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat'</span>
<a name="line-729"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>psb_dir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dir'</span>
<a name="line-730"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>psb_ext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvs'</span> <span class='hs-layout'>}</span>
<a name="line-731"></a>              <span class='hs-varid'>selector_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>details'</span> <span class='hs-keyword'>of</span>
<a name="line-732"></a>                                 <span class='hs-conid'>RecCon</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-733"></a>                                  <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>extFieldOcc</span> <span class='hs-varop'>.</span> <span class='hs-varid'>recordPatSynField</span><span class='hs-layout'>)</span> <span class='hs-varid'>names</span>
<a name="line-734"></a>                                 <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-735"></a>
<a name="line-736"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>fvs'</span> <span class='hs-varop'>`seq`</span> <span class='hs-comment'>-- See Note [Free-variable space leak]</span>
<a name="line-737"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind'</span><span class='hs-layout'>,</span> <span class='hs-varid'>name</span> <span class='hs-conop'>:</span> <span class='hs-varid'>selector_names</span> <span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span>
<a name="line-738"></a>          <span class='hs-comment'>-- Why fvs1?  See Note [Pattern synonym builders don't yield dependencies]</span>
<a name="line-739"></a>      <span class='hs-layout'>}</span>
<a name="line-740"></a>  <span class='hs-keyword'>where</span>
<a name="line-741"></a>    <span class='hs-comment'>-- See Note [Renaming pattern synonym variables]</span>
<a name="line-742"></a>    <span class='hs-varid'>lookupPatSynBndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapLocMA</span> <span class='hs-varid'>lookupLocalOccRn</span>
<a name="line-743"></a>
<a name="line-744"></a>    <span class='hs-varid'>patternSynonymErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-745"></a>    <span class='hs-varid'>patternSynonymErr</span>
<a name="line-746"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Illegal pattern synonym declaration"</span><span class='hs-layout'>)</span>
<a name="line-747"></a>           <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Use -XPatternSynonyms to enable this extension"</span><span class='hs-layout'>)</span>
<a name="line-748"></a>
<a name="line-749"></a><span class='hs-comment'>{-
<a name="line-750"></a>Note [Renaming pattern synonym variables]
<a name="line-751"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-752"></a>
<a name="line-753"></a>We rename pattern synonym declaractions backwards to normal to reuse
<a name="line-754"></a>the logic already implemented for renaming patterns.
<a name="line-755"></a>
<a name="line-756"></a>We first rename the RHS of a declaration which brings into
<a name="line-757"></a>scope the variables bound by the pattern (as they would be
<a name="line-758"></a>in normal function definitions). We then lookup the variables
<a name="line-759"></a>which we want to bind in this local environment.
<a name="line-760"></a>
<a name="line-761"></a>It is crucial that we then only lookup in the *local* environment which
<a name="line-762"></a>only contains the variables brought into scope by the pattern and nothing
<a name="line-763"></a>else. Amazingly no-one encountered this bug for 3 GHC versions but
<a name="line-764"></a>it was possible to define a pattern synonym which referenced global
<a name="line-765"></a>identifiers and worked correctly.
<a name="line-766"></a>
<a name="line-767"></a>```
<a name="line-768"></a>x = 5
<a name="line-769"></a>
<a name="line-770"></a>pattern P :: Int -&gt; ()
<a name="line-771"></a>pattern P x &lt;- _
<a name="line-772"></a>
<a name="line-773"></a>f (P x) = x
<a name="line-774"></a>
<a name="line-775"></a>&gt; f () = 5
<a name="line-776"></a>```
<a name="line-777"></a>
<a name="line-778"></a>See #13470 for the original report.
<a name="line-779"></a>
<a name="line-780"></a>Note [Pattern synonym builders don't yield dependencies]
<a name="line-781"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-782"></a>When renaming a pattern synonym that has an explicit builder,
<a name="line-783"></a>references in the builder definition should not be used when
<a name="line-784"></a>calculating dependencies. For example, consider the following pattern
<a name="line-785"></a>synonym definition:
<a name="line-786"></a>
<a name="line-787"></a>pattern P x &lt;- C1 x where
<a name="line-788"></a>  P x = f (C1 x)
<a name="line-789"></a>
<a name="line-790"></a>f (P x) = C2 x
<a name="line-791"></a>
<a name="line-792"></a>In this case, 'P' needs to be typechecked in two passes:
<a name="line-793"></a>
<a name="line-794"></a>1. Typecheck the pattern definition of 'P', which fully determines the
<a name="line-795"></a>   type of 'P'. This step doesn't require knowing anything about 'f',
<a name="line-796"></a>   since the builder definition is not looked at.
<a name="line-797"></a>
<a name="line-798"></a>2. Typecheck the builder definition, which needs the typechecked
<a name="line-799"></a>   definition of 'f' to be in scope; done by calls oo tcPatSynBuilderBind
<a name="line-800"></a>   in GHC.Tc.Gen.Bind.tcValBinds.
<a name="line-801"></a>
<a name="line-802"></a>This behaviour is implemented in 'tcValBinds', but it crucially
<a name="line-803"></a>depends on 'P' not being put in a recursive group with 'f' (which
<a name="line-804"></a>would make it look like a recursive pattern synonym a la 'pattern P =
<a name="line-805"></a>P' which is unsound and rejected).
<a name="line-806"></a>
<a name="line-807"></a>So:
<a name="line-808"></a> * We do not include builder fvs in the Uses returned by rnPatSynBind
<a name="line-809"></a>   (which is then used for dependency analysis)
<a name="line-810"></a> * But we /do/ include them in the psb_fvs for the PatSynBind
<a name="line-811"></a> * In rnValBinds we record these builder uses, to avoid bogus
<a name="line-812"></a>   unused-variable warnings (#12548)
<a name="line-813"></a>-}</span>
<a name="line-814"></a>
<a name="line-815"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-816"></a>*                                                                      *
<a name="line-817"></a>                Class/instance method bindings
<a name="line-818"></a>*                                                                      *
<a name="line-819"></a>********************************************************************* -}</span>
<a name="line-820"></a>
<a name="line-821"></a><span class='hs-comment'>{- @rnMethodBinds@ is used for the method bindings of a class and an instance
<a name="line-822"></a>declaration.   Like @rnBinds@ but without dependency analysis.
<a name="line-823"></a>
<a name="line-824"></a>NOTA BENE: we record each {\em binder} of a method-bind group as a free variable.
<a name="line-825"></a>That's crucial when dealing with an instance decl:
<a name="line-826"></a>\begin{verbatim}
<a name="line-827"></a>        instance Foo (T a) where
<a name="line-828"></a>           op x = ...
<a name="line-829"></a>\end{verbatim}
<a name="line-830"></a>This might be the {\em sole} occurrence of @op@ for an imported class @Foo@,
<a name="line-831"></a>and unless @op@ occurs we won't treat the type signature of @op@ in the class
<a name="line-832"></a>decl for @Foo@ as a source of instance-decl gates.  But we should!  Indeed,
<a name="line-833"></a>in many ways the @op@ in an instance decl is just like an occurrence, not
<a name="line-834"></a>a binder.
<a name="line-835"></a>-}</span>
<a name="line-836"></a>
<a name="line-837"></a><a name="rnMethodBinds"></a><span class='hs-definition'>rnMethodBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>                   <span class='hs-comment'>-- True &lt;=&gt; is a class declaration</span>
<a name="line-838"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>                   <span class='hs-comment'>-- Class name</span>
<a name="line-839"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>                 <span class='hs-comment'>-- Type variables from the class/instance header</span>
<a name="line-840"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>GhcPs</span>         <span class='hs-comment'>-- Binds</span>
<a name="line-841"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span>           <span class='hs-comment'>-- and signatures/pragmas</span>
<a name="line-842"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-843"></a><span class='hs-comment'>-- Used for</span>
<a name="line-844"></a><span class='hs-comment'>--   * the default method bindings in a class decl</span>
<a name="line-845"></a><span class='hs-comment'>--   * the method bindings in an instance decl</span>
<a name="line-846"></a><span class='hs-definition'>rnMethodBinds</span> <span class='hs-varid'>is_cls_decl</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>ktv_names</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>sigs</span>
<a name="line-847"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkDupRdrNamesN</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectMethodBinders</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-848"></a>             <span class='hs-comment'>-- Check that the same method is not given twice in the</span>
<a name="line-849"></a>             <span class='hs-comment'>-- same instance decl      instance C T where</span>
<a name="line-850"></a>             <span class='hs-comment'>--                       f x = ...</span>
<a name="line-851"></a>             <span class='hs-comment'>--                       g y = ...</span>
<a name="line-852"></a>             <span class='hs-comment'>--                       f x = ...</span>
<a name="line-853"></a>             <span class='hs-comment'>-- We must use checkDupRdrNames because the Name of the</span>
<a name="line-854"></a>             <span class='hs-comment'>-- method is the Name of the class selector, whose SrcSpan</span>
<a name="line-855"></a>             <span class='hs-comment'>-- points to the class declaration; and we use rnMethodBinds</span>
<a name="line-856"></a>             <span class='hs-comment'>-- for instance decls too</span>
<a name="line-857"></a>
<a name="line-858"></a>       <span class='hs-comment'>-- Rename the bindings LHSs</span>
<a name="line-859"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>binds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>foldrM</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnMethodBindLHS</span> <span class='hs-varid'>is_cls_decl</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyBag</span> <span class='hs-varid'>binds</span>
<a name="line-860"></a>
<a name="line-861"></a>       <span class='hs-comment'>-- Rename the pragmas and signatures</span>
<a name="line-862"></a>       <span class='hs-comment'>-- Annoyingly the type variables /are/ in scope for signatures, but</span>
<a name="line-863"></a>       <span class='hs-comment'>-- /are not/ in scope in SPECIALISE and SPECIALISE instance pragmas.</span>
<a name="line-864"></a>       <span class='hs-comment'>-- See Note [Type variable scoping in SPECIALISE pragmas].</span>
<a name="line-865"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>spec_prags</span><span class='hs-layout'>,</span> <span class='hs-varid'>other_sigs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSpecLSig</span> <span class='hs-varop'>&lt;||&gt;</span> <span class='hs-varid'>isSpecInstLSig</span><span class='hs-layout'>)</span> <span class='hs-varid'>sigs</span>
<a name="line-866"></a>             <span class='hs-varid'>bound_nms</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectHsBindsBinders</span> <span class='hs-conid'>CollNoDictBinders</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span>
<a name="line-867"></a>             <span class='hs-varid'>sig_ctxt</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_cls_decl</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ClsDeclCtxt</span> <span class='hs-varid'>cls</span>
<a name="line-868"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InstDeclCtxt</span> <span class='hs-varid'>bound_nms</span>
<a name="line-869"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>spec_prags'</span><span class='hs-layout'>,</span> <span class='hs-varid'>spg_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>renameSigs</span> <span class='hs-varid'>sig_ctxt</span> <span class='hs-varid'>spec_prags</span>
<a name="line-870"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>other_sigs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindLocalNamesFV</span> <span class='hs-varid'>ktv_names</span> <span class='hs-varop'>$</span>
<a name="line-871"></a>                                      <span class='hs-varid'>renameSigs</span> <span class='hs-varid'>sig_ctxt</span> <span class='hs-varid'>other_sigs</span>
<a name="line-872"></a>
<a name="line-873"></a>       <span class='hs-comment'>-- Rename the bindings RHSs.  Again there's an issue about whether the</span>
<a name="line-874"></a>       <span class='hs-comment'>-- type variables from the class/instance head are in scope.</span>
<a name="line-875"></a>       <span class='hs-comment'>-- Answer no in Haskell 2010, but yes if you have -XScopedTypeVariables</span>
<a name="line-876"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds''</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindSigTyVarsFV</span> <span class='hs-varid'>ktv_names</span> <span class='hs-varop'>$</span>
<a name="line-877"></a>              <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>binds_w_dus</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapBagM</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnLBind</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkScopedTvFn</span> <span class='hs-varid'>other_sigs'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds'</span>
<a name="line-878"></a>                 <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bind_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>fv1</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fv1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fv2</span><span class='hs-layout'>)</span>
<a name="line-879"></a>                                           <span class='hs-varid'>emptyFVs</span> <span class='hs-varid'>binds_w_dus</span>
<a name="line-880"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapBag</span> <span class='hs-varid'>fstOf3</span> <span class='hs-varid'>binds_w_dus</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-881"></a>
<a name="line-882"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>binds''</span><span class='hs-layout'>,</span> <span class='hs-varid'>spec_prags'</span> <span class='hs-varop'>++</span> <span class='hs-varid'>other_sigs'</span>
<a name="line-883"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>sig_fvs</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>spg_fvs</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>bind_fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-884"></a>
<a name="line-885"></a><span class='hs-comment'>{- Note [Type variable scoping in SPECIALISE pragmas]
<a name="line-886"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-887"></a>When renaming the methods of a class or instance declaration, we must be careful
<a name="line-888"></a>with the scoping of the type variables that occur in SPECIALISE and SPECIALISE instance
<a name="line-889"></a>pragmas: the type variables from the class/instance header DO NOT scope over these,
<a name="line-890"></a>unlike class/instance method type signatures.
<a name="line-891"></a>
<a name="line-892"></a>Examples:
<a name="line-893"></a>
<a name="line-894"></a>  1. SPECIALISE
<a name="line-895"></a>
<a name="line-896"></a>    class C a where
<a name="line-897"></a>      meth :: a
<a name="line-898"></a>    instance C (Maybe a) where
<a name="line-899"></a>      meth = Nothing
<a name="line-900"></a>      {-# SPECIALISE INLINE meth :: Maybe [a] #-}
<a name="line-901"></a>
<a name="line-902"></a>  2. SPECIALISE instance
<a name="line-903"></a>
<a name="line-904"></a>    instance Eq a =&gt; Eq (T a) where
<a name="line-905"></a>       (==) :: a -&gt; a -&gt; a
<a name="line-906"></a>       {-# SPECIALISE instance Eq a =&gt; Eq (T [a]) #-}
<a name="line-907"></a>
<a name="line-908"></a>  In both cases, the type variable `a` mentioned in the PRAGMA is NOT the same
<a name="line-909"></a>  as the type variable `a` from the instance header.
<a name="line-910"></a>  For example, the SPECIALISE instance pragma above is a shorthand for
<a name="line-911"></a>
<a name="line-912"></a>      {-# SPECIALISE instance forall a. Eq a =&gt; Eq (T [a]) #-}
<a name="line-913"></a>
<a name="line-914"></a>  which is alpha-equivalent to
<a name="line-915"></a>
<a name="line-916"></a>      {-# SPECIALISE instance forall b. Eq b =&gt; Eq (T [b]) #-}
<a name="line-917"></a>
<a name="line-918"></a>  This shows that the type variables are not bound in the header.
<a name="line-919"></a>
<a name="line-920"></a>  Getting this scoping wrong can lead to out-of-scope type variable errors from
<a name="line-921"></a>  Core Lint, see e.g. #22913.
<a name="line-922"></a>-}</span>
<a name="line-923"></a>
<a name="line-924"></a><a name="rnMethodBindLHS"></a><span class='hs-definition'>rnMethodBindLHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-925"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsBindLR</span> <span class='hs-conid'>GhcPs</span> <span class='hs-conid'>GhcPs</span>
<a name="line-926"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsBindsLR</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcPs</span>
<a name="line-927"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBindsLR</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-928"></a><span class='hs-definition'>rnMethodBindLHS</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>rest</span>
<a name="line-929"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpanA</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-930"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sel_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapLocMA</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupInstDeclBndr</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"method"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span>
<a name="line-931"></a>                     <span class='hs-comment'>-- We use the selector name as the binder</span>
<a name="line-932"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bind'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sel_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_ext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noExtField</span> <span class='hs-layout'>}</span>
<a name="line-933"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>bind'</span> <span class='hs-varop'>`consBag`</span> <span class='hs-varid'>rest</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-934"></a>
<a name="line-935"></a><span class='hs-comment'>-- Report error for all other forms of bindings</span>
<a name="line-936"></a><span class='hs-comment'>-- This is why we use a fold rather than map</span>
<a name="line-937"></a><span class='hs-definition'>rnMethodBindLHS</span> <span class='hs-varid'>is_cls_decl</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span> <span class='hs-varid'>rest</span>
<a name="line-938"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>addErrAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-939"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>what</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"not allowed in"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>decl_sort</span>
<a name="line-940"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-941"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>rest</span> <span class='hs-layout'>}</span>
<a name="line-942"></a>  <span class='hs-keyword'>where</span>
<a name="line-943"></a>    <span class='hs-varid'>decl_sort</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_cls_decl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"class declaration:"</span>
<a name="line-944"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"instance declaration:"</span>
<a name="line-945"></a>    <span class='hs-varid'>what</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>bind</span> <span class='hs-keyword'>of</span>
<a name="line-946"></a>              <span class='hs-conid'>PatBind</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Pattern bindings (except simple variables)"</span>
<a name="line-947"></a>              <span class='hs-conid'>PatSynBind</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Pattern synonyms"</span>
<a name="line-948"></a>                               <span class='hs-comment'>-- Associated pattern synonyms are not implemented yet</span>
<a name="line-949"></a>              <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rnMethodBind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>
<a name="line-950"></a>
<a name="line-951"></a><span class='hs-comment'>{-
<a name="line-952"></a>************************************************************************
<a name="line-953"></a>*                                                                      *
<a name="line-954"></a>\subsubsection[dep-Sigs]{Signatures (and user-pragmas for values)}
<a name="line-955"></a>*                                                                      *
<a name="line-956"></a>************************************************************************
<a name="line-957"></a>
<a name="line-958"></a>@renameSigs@ checks for:
<a name="line-959"></a>\begin{enumerate}
<a name="line-960"></a>\item more than one sig for one thing;
<a name="line-961"></a>\item signatures given for things not bound here;
<a name="line-962"></a>\end{enumerate}
<a name="line-963"></a>
<a name="line-964"></a>At the moment we don't gather free-var info from the types in
<a name="line-965"></a>signatures.  We'd only need this if we wanted to report unused tyvars.
<a name="line-966"></a>-}</span>
<a name="line-967"></a>
<a name="line-968"></a><a name="renameSigs"></a><span class='hs-definition'>renameSigs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSigCtxt</span>
<a name="line-969"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span>
<a name="line-970"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-971"></a><span class='hs-comment'>-- Renames the signatures and performs error checks</span>
<a name="line-972"></a><span class='hs-definition'>renameSigs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sigs</span>
<a name="line-973"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>dupSigDeclErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>findDupSigs</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span>
<a name="line-974"></a>
<a name="line-975"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkDupMinimalSigs</span> <span class='hs-varid'>sigs</span>
<a name="line-976"></a>
<a name="line-977"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>sigs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapFvRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocFstMA</span> <span class='hs-layout'>(</span><span class='hs-varid'>renameSig</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>sigs</span>
<a name="line-978"></a>
<a name="line-979"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>good_sigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>bad_sigs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-layout'>(</span><span class='hs-varid'>okHsSig</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>sigs'</span>
<a name="line-980"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>misplacedSigErr</span> <span class='hs-varid'>bad_sigs</span>                 <span class='hs-comment'>-- Misplaced</span>
<a name="line-981"></a>
<a name="line-982"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>good_sigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-983"></a>
<a name="line-984"></a><span class='hs-comment'>----------------------</span>
<a name="line-985"></a><span class='hs-comment'>-- We use lookupSigOccRn in the signatures, which is a little bit unsatisfactory</span>
<a name="line-986"></a><span class='hs-comment'>-- because this won't work for:</span>
<a name="line-987"></a><span class='hs-comment'>--      instance Foo T where</span>
<a name="line-988"></a><span class='hs-comment'>--        {-# INLINE op #-}</span>
<a name="line-989"></a><span class='hs-comment'>--        Baz.op = ...</span>
<a name="line-990"></a><span class='hs-comment'>-- We'll just rename the INLINE prag to refer to whatever other 'op'</span>
<a name="line-991"></a><span class='hs-comment'>-- is in scope.  (I'm assuming that Baz.op isn't in scope unqualified.)</span>
<a name="line-992"></a><span class='hs-comment'>-- Doesn't seem worth much trouble to sort this.</span>
<a name="line-993"></a>
<a name="line-994"></a><a name="renameSig"></a><span class='hs-definition'>renameSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSigCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Sig</span> <span class='hs-conid'>GhcPs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Sig</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-995"></a><span class='hs-definition'>renameSig</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>IdSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-996"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>IdSig</span> <span class='hs-varid'>noExtField</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- Actually this never occurs</span>
<a name="line-997"></a>
<a name="line-998"></a><span class='hs-definition'>renameSig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-999"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>new_vs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupSigOccRnN</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-varid'>vs</span>
<a name="line-1000"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeSigCtx</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_sig_bndrs</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span>
<a name="line-1001"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnHsSigWcType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-1002"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-varid'>noAnn</span> <span class='hs-varid'>new_vs</span> <span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1003"></a>
<a name="line-1004"></a><span class='hs-definition'>renameSig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ClassOpSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>is_deflt</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1005"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>defaultSigs_on</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt.DefaultSignatures</span>
<a name="line-1006"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_deflt</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>defaultSigs_on</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1007"></a>          <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>defaultSigErr</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span>
<a name="line-1008"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupSigOccRnN</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-varid'>vs</span>
<a name="line-1009"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnHsSigType</span> <span class='hs-varid'>ty_ctxt</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-varid'>ty</span>
<a name="line-1010"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassOpSig</span> <span class='hs-varid'>noAnn</span> <span class='hs-varid'>is_deflt</span> <span class='hs-varid'>new_v</span> <span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1011"></a>  <span class='hs-keyword'>where</span>
<a name="line-1012"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>v1</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vs</span>
<a name="line-1013"></a>    <span class='hs-varid'>ty_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GenericCtx</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"a class method signature for"</span>
<a name="line-1014"></a>                          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>v1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1015"></a>
<a name="line-1016"></a><span class='hs-definition'>renameSig</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecInstSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>src</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1017"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>checkInferredVars</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>inf_msg</span> <span class='hs-varid'>ty</span>
<a name="line-1018"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnHsSigType</span> <span class='hs-varid'>doc</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-varid'>ty</span>
<a name="line-1019"></a>          <span class='hs-comment'>-- Check if there are any nested `forall`s or contexts, which are</span>
<a name="line-1020"></a>          <span class='hs-comment'>-- illegal in the type of an instance declaration (see</span>
<a name="line-1021"></a>          <span class='hs-comment'>-- Note [No nested foralls or contexts in instance types] in</span>
<a name="line-1022"></a>          <span class='hs-comment'>-- GHC.Hs.Type).</span>
<a name="line-1023"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>addNoNestedForallsContextsErr</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"SPECIALISE instance type"</span><span class='hs-layout'>)</span>
<a name="line-1024"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>getLHsInstDeclHead</span> <span class='hs-varid'>new_ty</span><span class='hs-layout'>)</span>
<a name="line-1025"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecInstSig</span> <span class='hs-varid'>noAnn</span> <span class='hs-varid'>src</span> <span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span><span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1026"></a>  <span class='hs-keyword'>where</span>
<a name="line-1027"></a>    <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SpecInstSigCtx</span>
<a name="line-1028"></a>    <span class='hs-varid'>inf_msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Inferred type variables are not allowed"</span><span class='hs-layout'>)</span>
<a name="line-1029"></a>
<a name="line-1030"></a><span class='hs-comment'>-- {-# SPECIALISE #-} pragmas can refer to imported Ids</span>
<a name="line-1031"></a><span class='hs-comment'>-- so, in the top-level case (when mb_names is Nothing)</span>
<a name="line-1032"></a><span class='hs-comment'>-- we use lookupOccRn.  If there's both an imported and a local 'f'</span>
<a name="line-1033"></a><span class='hs-comment'>-- then the SPECIALISE pragma is ambiguous, unlike all other signatures</span>
<a name="line-1034"></a><span class='hs-definition'>renameSig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>v</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span>
<a name="line-1035"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>new_v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-1036"></a>                     <span class='hs-conid'>TopSigCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookupLocatedOccRn</span> <span class='hs-varid'>v</span>
<a name="line-1037"></a>                     <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookupSigOccRnN</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span> <span class='hs-varid'>v</span>
<a name="line-1038"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>foldM</span> <span class='hs-varid'>do_one</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-1039"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-varid'>noAnn</span> <span class='hs-varid'>new_v</span> <span class='hs-varid'>new_ty</span> <span class='hs-varid'>inl</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1040"></a>  <span class='hs-keyword'>where</span>
<a name="line-1041"></a>    <span class='hs-varid'>ty_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GenericCtx</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"a SPECIALISE signature for"</span>
<a name="line-1042"></a>                          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1043"></a>    <span class='hs-varid'>do_one</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys</span><span class='hs-layout'>,</span><span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1044"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnHsSigType</span> <span class='hs-varid'>ty_ctxt</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-varid'>ty</span>
<a name="line-1045"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>new_ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_ty</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1046"></a>
<a name="line-1047"></a><span class='hs-definition'>renameSig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>InlineSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>v</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-1048"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>new_v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupSigOccRnN</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span> <span class='hs-varid'>v</span>
<a name="line-1049"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>InlineSig</span> <span class='hs-varid'>noAnn</span> <span class='hs-varid'>new_v</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1050"></a>
<a name="line-1051"></a><span class='hs-definition'>renameSig</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>FixSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>fsig</span><span class='hs-layout'>)</span>
<a name="line-1052"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>new_fsig</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnSrcFixityDecl</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>fsig</span>
<a name="line-1053"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FixSig</span> <span class='hs-varid'>noAnn</span> <span class='hs-varid'>new_fsig</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1054"></a>
<a name="line-1055"></a><span class='hs-definition'>renameSig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>MinimalSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>bf</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1056"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_bf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>traverse</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupSigOccRnN</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-varid'>bf</span>
<a name="line-1057"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>MinimalSig</span> <span class='hs-varid'>noAnn</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>new_bf</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-1058"></a>
<a name="line-1059"></a><span class='hs-definition'>renameSig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PatSynSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1060"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>new_vs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupSigOccRnN</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-varid'>vs</span>
<a name="line-1061"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnHsSigType</span> <span class='hs-varid'>ty_ctxt</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-varid'>ty</span>
<a name="line-1062"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynSig</span> <span class='hs-varid'>noAnn</span> <span class='hs-varid'>new_vs</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1063"></a>  <span class='hs-keyword'>where</span>
<a name="line-1064"></a>    <span class='hs-varid'>ty_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GenericCtx</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"a pattern synonym signature for"</span>
<a name="line-1065"></a>                          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_sig_bndrs</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span>
<a name="line-1066"></a>
<a name="line-1067"></a><span class='hs-definition'>renameSig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SCCFunSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>st</span> <span class='hs-varid'>v</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-1068"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>new_v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupSigOccRnN</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span> <span class='hs-varid'>v</span>
<a name="line-1069"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCCFunSig</span> <span class='hs-varid'>noAnn</span> <span class='hs-varid'>st</span> <span class='hs-varid'>new_v</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1070"></a>
<a name="line-1071"></a><span class='hs-comment'>-- COMPLETE Sigs can refer to imported IDs which is why we use</span>
<a name="line-1072"></a><span class='hs-comment'>-- lookupLocatedOccRn rather than lookupSigOccRn</span>
<a name="line-1073"></a><span class='hs-definition'>renameSig</span> <span class='hs-sel'>_ctxt</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CompleteMatchSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>bf</span><span class='hs-layout'>)</span> <span class='hs-varid'>mty</span><span class='hs-layout'>)</span>
<a name="line-1074"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_bf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>traverse</span> <span class='hs-varid'>lookupLocatedOccRn</span> <span class='hs-varid'>bf</span>
<a name="line-1075"></a>       <span class='hs-varid'>new_mty</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>traverse</span> <span class='hs-varid'>lookupLocatedOccRn</span> <span class='hs-varid'>mty</span>
<a name="line-1076"></a>
<a name="line-1077"></a>       <span class='hs-varid'>this_mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tcg_mod</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-1078"></a>       <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>this_mod</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_bf</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1079"></a>         <span class='hs-comment'>-- Why 'any'? See Note [Orphan COMPLETE pragmas]</span>
<a name="line-1080"></a>         <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"In"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>orphanError</span>
<a name="line-1081"></a>
<a name="line-1082"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>CompleteMatchSig</span> <span class='hs-varid'>noAnn</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>new_bf</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_mty</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-1083"></a>  <span class='hs-keyword'>where</span>
<a name="line-1084"></a>    <span class='hs-varid'>orphanError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-1085"></a>    <span class='hs-varid'>orphanError</span> <span class='hs-keyglyph'>=</span>
<a name="line-1086"></a>      <span class='hs-varid'>text</span> <span class='hs-str'>"Orphan COMPLETE pragmas not supported"</span> <span class='hs-varop'>$$</span>
<a name="line-1087"></a>      <span class='hs-varid'>text</span> <span class='hs-str'>"A COMPLETE pragma must mention at least one data constructor"</span> <span class='hs-varop'>$$</span>
<a name="line-1088"></a>      <span class='hs-varid'>text</span> <span class='hs-str'>"or pattern synonym defined in the same module."</span>
<a name="line-1089"></a>
<a name="line-1090"></a><span class='hs-comment'>{-
<a name="line-1091"></a>Note [Orphan COMPLETE pragmas]
<a name="line-1092"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1093"></a>We define a COMPLETE pragma to be a non-orphan if it includes at least
<a name="line-1094"></a>one conlike defined in the current module. Why is this sufficient?
<a name="line-1095"></a>Well if you have a pattern match
<a name="line-1096"></a>
<a name="line-1097"></a>  case expr of
<a name="line-1098"></a>    P1 -&gt; ...
<a name="line-1099"></a>    P2 -&gt; ...
<a name="line-1100"></a>    P3 -&gt; ...
<a name="line-1101"></a>
<a name="line-1102"></a>any COMPLETE pragma which mentions a conlike other than P1, P2 or P3
<a name="line-1103"></a>will not be of any use in verifying that the pattern match is
<a name="line-1104"></a>exhaustive. So as we have certainly read the interface files that
<a name="line-1105"></a>define P1, P2 and P3, we will have loaded all non-orphan COMPLETE
<a name="line-1106"></a>pragmas that could be relevant to this pattern match.
<a name="line-1107"></a>
<a name="line-1108"></a>For now we simply disallow orphan COMPLETE pragmas, as the added
<a name="line-1109"></a>complexity of supporting them properly doesn't seem worthwhile.
<a name="line-1110"></a>-}</span>
<a name="line-1111"></a>
<a name="line-1112"></a><a name="ppr_sig_bndrs"></a><span class='hs-definition'>ppr_sig_bndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LocatedN</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1113"></a><span class='hs-definition'>ppr_sig_bndrs</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-1114"></a>
<a name="line-1115"></a><a name="okHsSig"></a><span class='hs-definition'>okHsSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSigCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>GhcPass</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1116"></a><span class='hs-definition'>okHsSig</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span>
<a name="line-1117"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1118"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>ClassOpSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>ClsDeclCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1119"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>ClassOpSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>InstDeclCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1120"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>ClassOpSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1121"></a>
<a name="line-1122"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>ClsDeclCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1123"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>InstDeclCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1124"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1125"></a>
<a name="line-1126"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>PatSynSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>TopSigCtxt</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1127"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>PatSynSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1128"></a>
<a name="line-1129"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>FixSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>InstDeclCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1130"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>FixSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1131"></a>
<a name="line-1132"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>IdSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>TopSigCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1133"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>IdSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>InstDeclCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1134"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>IdSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1135"></a>
<a name="line-1136"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>InlineSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsBootCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1137"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>InlineSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1138"></a>
<a name="line-1139"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>TopSigCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1140"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>LocalBindCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1141"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>InstDeclCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1142"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1143"></a>
<a name="line-1144"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>SpecInstSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>InstDeclCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1145"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>SpecInstSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1146"></a>
<a name="line-1147"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>MinimalSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>ClsDeclCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1148"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>MinimalSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1149"></a>
<a name="line-1150"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>SCCFunSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsBootCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1151"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>SCCFunSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1152"></a>
<a name="line-1153"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>CompleteMatchSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>TopSigCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1154"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>CompleteMatchSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1155"></a>
<a name="line-1156"></a><a name="findDupSigs"></a><span class='hs-comment'>-------------------</span>
<a name="line-1157"></a><span class='hs-definition'>findDupSigs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NonEmpty</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedN</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> <span class='hs-conid'>Sig</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1158"></a><span class='hs-comment'>-- Check for duplicates on RdrName version,</span>
<a name="line-1159"></a><span class='hs-comment'>-- because renamed version has unboundName for</span>
<a name="line-1160"></a><span class='hs-comment'>-- not-in-scope binders, which gives bogus dup-sig errors</span>
<a name="line-1161"></a><span class='hs-comment'>-- NB: in a class decl, a 'generic' sig is not considered</span>
<a name="line-1162"></a><span class='hs-comment'>--     equal to an ordinary sig, so we allow, say</span>
<a name="line-1163"></a><span class='hs-comment'>--           class C a where</span>
<a name="line-1164"></a><span class='hs-comment'>--             op :: a -&gt; a</span>
<a name="line-1165"></a><span class='hs-comment'>--             default op :: Eq a =&gt; a -&gt; a</span>
<a name="line-1166"></a><span class='hs-definition'>findDupSigs</span> <span class='hs-varid'>sigs</span>
<a name="line-1167"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findDupsEq</span> <span class='hs-varid'>matching_sig</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>expand_sig</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span>
<a name="line-1168"></a>  <span class='hs-keyword'>where</span>
<a name="line-1169"></a>    <span class='hs-varid'>expand_sig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Sig</span> <span class='hs-conid'>GhcPs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LocatedN</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> <span class='hs-conid'>Sig</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- AZ</span>
<a name="line-1170"></a>    <span class='hs-varid'>expand_sig</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FixSig</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>FixitySig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ns</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zip</span> <span class='hs-varid'>ns</span> <span class='hs-layout'>(</span><span class='hs-varid'>repeat</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span>
<a name="line-1171"></a>    <span class='hs-varid'>expand_sig</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>InlineSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>sig</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1172"></a>    <span class='hs-varid'>expand_sig</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ns</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ns</span><span class='hs-keyglyph'>]</span>
<a name="line-1173"></a>    <span class='hs-varid'>expand_sig</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ClassOpSig</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ns</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ns</span><span class='hs-keyglyph'>]</span>
<a name="line-1174"></a>    <span class='hs-varid'>expand_sig</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PatSynSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ns</span>  <span class='hs-keyword'>_</span> <span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ns</span><span class='hs-keyglyph'>]</span>
<a name="line-1175"></a>    <span class='hs-varid'>expand_sig</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SCCFunSig</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>sig</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1176"></a>    <span class='hs-varid'>expand_sig</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-1177"></a>
<a name="line-1178"></a>    <span class='hs-varid'>matching_sig</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedN</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> <span class='hs-conid'>Sig</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedN</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> <span class='hs-conid'>Sig</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-varop'>--AZ</span>
<a name="line-1179"></a>    <span class='hs-varid'>matching_sig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n1</span><span class='hs-layout'>,</span><span class='hs-varid'>sig1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n2</span><span class='hs-layout'>,</span><span class='hs-varid'>sig2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>n2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>mtch</span> <span class='hs-varid'>sig1</span> <span class='hs-varid'>sig2</span>
<a name="line-1180"></a>    <span class='hs-varid'>mtch</span> <span class='hs-layout'>(</span><span class='hs-conid'>FixSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>           <span class='hs-layout'>(</span><span class='hs-conid'>FixSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1181"></a>    <span class='hs-varid'>mtch</span> <span class='hs-layout'>(</span><span class='hs-conid'>InlineSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-layout'>(</span><span class='hs-conid'>InlineSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1182"></a>    <span class='hs-varid'>mtch</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>          <span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1183"></a>    <span class='hs-varid'>mtch</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassOpSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>d1</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassOpSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>d2</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>d2</span>
<a name="line-1184"></a>    <span class='hs-varid'>mtch</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynSig</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-layout'>(</span><span class='hs-conid'>PatSynSig</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1185"></a>    <span class='hs-varid'>mtch</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCCFunSig</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-layout'>(</span><span class='hs-conid'>SCCFunSig</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1186"></a>    <span class='hs-varid'>mtch</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1187"></a>
<a name="line-1188"></a><a name="checkDupMinimalSigs"></a><span class='hs-comment'>-- Warn about multiple MINIMAL signatures</span>
<a name="line-1189"></a><span class='hs-definition'>checkDupMinimalSigs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-1190"></a><span class='hs-definition'>checkDupMinimalSigs</span> <span class='hs-varid'>sigs</span>
<a name="line-1191"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isMinimalLSig</span> <span class='hs-varid'>sigs</span> <span class='hs-keyword'>of</span>
<a name="line-1192"></a>      <span class='hs-varid'>minSigs</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>dupMinimalSigErr</span> <span class='hs-varid'>minSigs</span>
<a name="line-1193"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1194"></a>
<a name="line-1195"></a><span class='hs-comment'>{-
<a name="line-1196"></a>************************************************************************
<a name="line-1197"></a>*                                                                      *
<a name="line-1198"></a>\subsection{Match}
<a name="line-1199"></a>*                                                                      *
<a name="line-1200"></a>************************************************************************
<a name="line-1201"></a>-}</span>
<a name="line-1202"></a>
<a name="line-1203"></a><a name="AnnoBody"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>AnnoBody</span> <span class='hs-varid'>body</span>
<a name="line-1204"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Anno</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>SrcSpanAnnL</span>
<a name="line-1205"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>Anno</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>SrcSpanAnnL</span>
<a name="line-1206"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>Anno</span> <span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>SrcSpanAnnA</span>
<a name="line-1207"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>Anno</span> <span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>SrcSpanAnnA</span>
<a name="line-1208"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>Anno</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHS</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-1209"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>Anno</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHS</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-1210"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-1211"></a>    <span class='hs-layout'>)</span>
<a name="line-1212"></a>
<a name="line-1213"></a><a name="rnMatchGroup"></a><span class='hs-definition'>rnMatchGroup</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>AnnoBody</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>GhcRn</span>
<a name="line-1214"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1215"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1216"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-1217"></a><span class='hs-definition'>rnMatchGroup</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>MG</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_alts</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>lm</span> <span class='hs-varid'>ms</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>origin</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1218"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>empty_case_ok</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt.EmptyCase</span>
<a name="line-1219"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>ms</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>empty_case_ok</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyCaseErr</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1220"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ms</span><span class='hs-layout'>,</span> <span class='hs-varid'>ms_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapFvRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnMatch</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span><span class='hs-layout'>)</span> <span class='hs-varid'>ms</span>
<a name="line-1221"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkMatchGroup</span> <span class='hs-varid'>origin</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>lm</span> <span class='hs-varid'>new_ms</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ms_fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1222"></a>
<a name="line-1223"></a><a name="rnMatch"></a><span class='hs-definition'>rnMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AnnoBody</span> <span class='hs-varid'>body</span>
<a name="line-1224"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>GhcRn</span>
<a name="line-1225"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1226"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LMatch</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1227"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LMatch</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-1228"></a><span class='hs-definition'>rnMatch</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapLocFstMA</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnMatch'</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span><span class='hs-layout'>)</span>
<a name="line-1229"></a>
<a name="line-1230"></a><a name="rnMatch'"></a><span class='hs-definition'>rnMatch'</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnnoBody</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-1231"></a>         <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>GhcRn</span>
<a name="line-1232"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1233"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Match</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1234"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-1235"></a><span class='hs-definition'>rnMatch'</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-layout'>{</span> <span class='hs-varid'>m_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mf</span><span class='hs-layout'>,</span> <span class='hs-varid'>m_pats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pats</span><span class='hs-layout'>,</span> <span class='hs-varid'>m_grhss</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grhss</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1236"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnPats</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>pats</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>pats'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1237"></a>        <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>grhss'</span><span class='hs-layout'>,</span> <span class='hs-varid'>grhss_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnGRHSs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>grhss</span>
<a name="line-1238"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mf'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>mf</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1239"></a>                      <span class='hs-layout'>(</span><span class='hs-conid'>FunRhs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mc_fun</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>funid</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>FunRhs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mc_fun</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>lf</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1240"></a>                                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mf</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mc_fun</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>lf</span> <span class='hs-varid'>funid</span> <span class='hs-layout'>}</span>
<a name="line-1241"></a>                      <span class='hs-keyword'>_</span>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ctxt</span>
<a name="line-1242"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-layout'>{</span> <span class='hs-varid'>m_ext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noAnn</span><span class='hs-layout'>,</span> <span class='hs-varid'>m_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mf'</span><span class='hs-layout'>,</span> <span class='hs-varid'>m_pats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pats'</span>
<a name="line-1243"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>m_grhss</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grhss'</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-varid'>grhss_fvs</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1244"></a>
<a name="line-1245"></a><a name="emptyCaseErr"></a><span class='hs-definition'>emptyCaseErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1246"></a><span class='hs-definition'>emptyCaseErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Empty list of alternatives in"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_ctxt</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-1247"></a>                       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Use EmptyCase to allow this"</span><span class='hs-layout'>)</span>
<a name="line-1248"></a>  <span class='hs-keyword'>where</span>
<a name="line-1249"></a>    <span class='hs-varid'>pp_ctxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1250"></a>    <span class='hs-varid'>pp_ctxt</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>c</span> <span class='hs-keyword'>of</span>
<a name="line-1251"></a>      <span class='hs-conid'>CaseAlt</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"case expression"</span>
<a name="line-1252"></a>      <span class='hs-conid'>LambdaExpr</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"\\case expression"</span>
<a name="line-1253"></a>      <span class='hs-conid'>ArrowMatchCtxt</span> <span class='hs-conid'>ArrowCaseAlt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"case expression"</span>
<a name="line-1254"></a>      <span class='hs-conid'>ArrowMatchCtxt</span> <span class='hs-conid'>KappaExpr</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"kappa abstraction"</span>
<a name="line-1255"></a>      <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"(unexpected)"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprMatchContextNoun</span> <span class='hs-varid'>c</span>
<a name="line-1256"></a>
<a name="line-1257"></a><span class='hs-comment'>{-
<a name="line-1258"></a>************************************************************************
<a name="line-1259"></a>*                                                                      *
<a name="line-1260"></a>\subsubsection{Guarded right-hand sides (GRHSs)}
<a name="line-1261"></a>*                                                                      *
<a name="line-1262"></a>************************************************************************
<a name="line-1263"></a>-}</span>
<a name="line-1264"></a>
<a name="line-1265"></a><a name="rnGRHSs"></a><span class='hs-definition'>rnGRHSs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AnnoBody</span> <span class='hs-varid'>body</span>
<a name="line-1266"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>GhcRn</span>
<a name="line-1267"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1268"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GRHSs</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1269"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-1270"></a><span class='hs-definition'>rnGRHSs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>grhss</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-1271"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLocalBindsAndThen</span> <span class='hs-varid'>binds</span>   <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>binds'</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1272"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>grhss'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvGRHSs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapFvRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnGRHS</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span><span class='hs-layout'>)</span> <span class='hs-varid'>grhss</span>
<a name="line-1273"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-varid'>emptyComments</span> <span class='hs-varid'>grhss'</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvGRHSs</span><span class='hs-layout'>)</span>
<a name="line-1274"></a>
<a name="line-1275"></a><a name="rnGRHS"></a><span class='hs-definition'>rnGRHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AnnoBody</span> <span class='hs-varid'>body</span>
<a name="line-1276"></a>       <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>GhcRn</span>
<a name="line-1277"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1278"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LGRHS</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1279"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LGRHS</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-1280"></a><span class='hs-definition'>rnGRHS</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapLocFstM</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnGRHS'</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span><span class='hs-layout'>)</span>
<a name="line-1281"></a>
<a name="line-1282"></a><a name="rnGRHS'"></a><span class='hs-definition'>rnGRHS'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>GhcRn</span>
<a name="line-1283"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1284"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GRHS</span> <span class='hs-conid'>GhcPs</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1285"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHS</span> <span class='hs-conid'>GhcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedA</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-1286"></a><span class='hs-definition'>rnGRHS'</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHS</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>guards</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-1287"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>pattern_guards_allowed</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt.PatternGuards</span>
<a name="line-1288"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>guards'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnStmts</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatGuard</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>rnExpr</span> <span class='hs-varid'>guards</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1289"></a>                                    <span class='hs-varid'>rnBody</span> <span class='hs-varid'>rhs</span>
<a name="line-1290"></a>
<a name="line-1291"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>pattern_guards_allowed</span> <span class='hs-varop'>||</span> <span class='hs-varid'>is_standard_guard</span> <span class='hs-varid'>guards'</span><span class='hs-layout'>)</span>
<a name="line-1292"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>addWarn</span> <span class='hs-conid'>NoReason</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonStdGuardErr</span> <span class='hs-varid'>guards'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1293"></a>
<a name="line-1294"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHS</span> <span class='hs-varid'>noAnn</span> <span class='hs-varid'>guards'</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1295"></a>  <span class='hs-keyword'>where</span>
<a name="line-1296"></a>        <span class='hs-comment'>-- Standard Haskell 1.4 guards are just a single boolean</span>
<a name="line-1297"></a>        <span class='hs-comment'>-- expression, rather than a list of qualifiers as in the</span>
<a name="line-1298"></a>        <span class='hs-comment'>-- Glasgow extension</span>
<a name="line-1299"></a>    <span class='hs-varid'>is_standard_guard</span> <span class='hs-conid'>[]</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1300"></a>    <span class='hs-varid'>is_standard_guard</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1301"></a>    <span class='hs-varid'>is_standard_guard</span> <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1302"></a>
<a name="line-1303"></a><span class='hs-comment'>{-
<a name="line-1304"></a>*********************************************************
<a name="line-1305"></a>*                                                       *
<a name="line-1306"></a>        Source-code fixity declarations
<a name="line-1307"></a>*                                                       *
<a name="line-1308"></a>*********************************************************
<a name="line-1309"></a>-}</span>
<a name="line-1310"></a>
<a name="line-1311"></a><a name="rnSrcFixityDecl"></a><span class='hs-definition'>rnSrcFixityDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSigCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FixitySig</span> <span class='hs-conid'>GhcPs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>FixitySig</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span>
<a name="line-1312"></a><span class='hs-comment'>-- Rename a fixity decl, so we can put</span>
<a name="line-1313"></a><span class='hs-comment'>-- the renamed decl in the renamed syntax tree</span>
<a name="line-1314"></a><span class='hs-comment'>-- Errors if the thing being fixed is not defined locally.</span>
<a name="line-1315"></a><span class='hs-definition'>rnSrcFixityDecl</span> <span class='hs-varid'>sig_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rn_decl</span>
<a name="line-1316"></a>  <span class='hs-keyword'>where</span>
<a name="line-1317"></a>    <span class='hs-varid'>rn_decl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FixitySig</span> <span class='hs-conid'>GhcPs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>FixitySig</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span>
<a name="line-1318"></a>        <span class='hs-comment'>-- GHC extension: look up both the tycon and data con</span>
<a name="line-1319"></a>        <span class='hs-comment'>-- for con-like things; hence returning a list</span>
<a name="line-1320"></a>        <span class='hs-comment'>-- If neither are in scope, report an error; otherwise</span>
<a name="line-1321"></a>        <span class='hs-comment'>-- return a fixity sig for each (slightly odd)</span>
<a name="line-1322"></a>    <span class='hs-varid'>rn_decl</span> <span class='hs-layout'>(</span><span class='hs-conid'>FixitySig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>fnames</span> <span class='hs-varid'>fixity</span><span class='hs-layout'>)</span>
<a name="line-1323"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>concatMapM</span> <span class='hs-varid'>lookup_one</span> <span class='hs-varid'>fnames</span>
<a name="line-1324"></a>           <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FixitySig</span> <span class='hs-varid'>noExtField</span> <span class='hs-varid'>names</span> <span class='hs-varid'>fixity</span><span class='hs-layout'>)</span>
<a name="line-1325"></a>
<a name="line-1326"></a>    <span class='hs-varid'>lookup_one</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LocatedN</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LocatedN</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-1327"></a>    <span class='hs-varid'>lookup_one</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>name_loc</span> <span class='hs-varid'>rdr_name</span><span class='hs-layout'>)</span>
<a name="line-1328"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpanA</span> <span class='hs-varid'>name_loc</span> <span class='hs-varop'>$</span>
<a name="line-1329"></a>                    <span class='hs-comment'>-- This lookup will fail if the name is not defined in the</span>
<a name="line-1330"></a>                    <span class='hs-comment'>-- same binding group as this fixity declaration.</span>
<a name="line-1331"></a>        <span class='hs-keyword'>do</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupLocalTcNames</span> <span class='hs-varid'>sig_ctxt</span> <span class='hs-varid'>what</span> <span class='hs-varid'>rdr_name</span>
<a name="line-1332"></a>           <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>L</span> <span class='hs-varid'>name_loc</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>]</span>
<a name="line-1333"></a>    <span class='hs-varid'>what</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"fixity signature"</span>
<a name="line-1334"></a>
<a name="line-1335"></a><span class='hs-comment'>{-
<a name="line-1336"></a>************************************************************************
<a name="line-1337"></a>*                                                                      *
<a name="line-1338"></a>\subsection{Error messages}
<a name="line-1339"></a>*                                                                      *
<a name="line-1340"></a>************************************************************************
<a name="line-1341"></a>-}</span>
<a name="line-1342"></a>
<a name="line-1343"></a><a name="dupSigDeclErr"></a><span class='hs-definition'>dupSigDeclErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NonEmpty</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedN</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> <span class='hs-conid'>Sig</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-1344"></a><span class='hs-definition'>dupSigDeclErr</span> <span class='hs-varid'>pairs</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-conop'>:|</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-1345"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1346"></a>    <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Duplicate"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>what_it_is</span>
<a name="line-1347"></a>           <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"s for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-1348"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"at"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sortBy</span> <span class='hs-conid'>SrcLoc.leftmost_smallest</span>
<a name="line-1349"></a>                                       <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLocA</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span>
<a name="line-1350"></a>                                       <span class='hs-varop'>$</span> <span class='hs-varid'>toList</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>
<a name="line-1351"></a>         <span class='hs-keyglyph'>]</span>
<a name="line-1352"></a>  <span class='hs-keyword'>where</span>
<a name="line-1353"></a>    <span class='hs-varid'>what_it_is</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsSigDoc</span> <span class='hs-varid'>sig</span>
<a name="line-1354"></a>
<a name="line-1355"></a><a name="misplacedSigErr"></a><span class='hs-definition'>misplacedSigErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-1356"></a><span class='hs-definition'>misplacedSigErr</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span>
<a name="line-1357"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1358"></a>    <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"Misplaced"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>hsSigDoc</span> <span class='hs-varid'>sig</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>]</span>
<a name="line-1359"></a>
<a name="line-1360"></a><a name="defaultSigErr"></a><span class='hs-definition'>defaultSigErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Sig</span> <span class='hs-conid'>GhcPs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1361"></a><span class='hs-definition'>defaultSigErr</span> <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Unexpected default signature:"</span><span class='hs-layout'>)</span>
<a name="line-1362"></a>                              <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span>
<a name="line-1363"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Use DefaultSignatures to enable default signatures"</span> <span class='hs-keyglyph'>]</span>
<a name="line-1364"></a>
<a name="line-1365"></a><a name="bindsInHsBootFile"></a><span class='hs-definition'>bindsInHsBootFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsBindsLR</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcPs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1366"></a><span class='hs-definition'>bindsInHsBootFile</span> <span class='hs-varid'>mbinds</span>
<a name="line-1367"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Bindings in hs-boot files are not allowed"</span><span class='hs-layout'>)</span>
<a name="line-1368"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mbinds</span><span class='hs-layout'>)</span>
<a name="line-1369"></a>
<a name="line-1370"></a><a name="nonStdGuardErr"></a><span class='hs-definition'>nonStdGuardErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Outputable</span> <span class='hs-varid'>body</span><span class='hs-layout'>,</span>
<a name="line-1371"></a>                   <span class='hs-conid'>Anno</span> <span class='hs-layout'>(</span><span class='hs-conid'>Stmt</span> <span class='hs-conid'>GhcRn</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>SrcSpanAnnA</span><span class='hs-layout'>)</span>
<a name="line-1372"></a>               <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmtLR</span> <span class='hs-conid'>GhcRn</span> <span class='hs-conid'>GhcRn</span> <span class='hs-varid'>body</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1373"></a><span class='hs-definition'>nonStdGuardErr</span> <span class='hs-varid'>guards</span>
<a name="line-1374"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"accepting non-standard pattern guards (use PatternGuards to suppress this message)"</span><span class='hs-layout'>)</span>
<a name="line-1375"></a>       <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>interpp'SP</span> <span class='hs-varid'>guards</span><span class='hs-layout'>)</span>
<a name="line-1376"></a>
<a name="line-1377"></a><a name="unusedPatBindWarn"></a><span class='hs-definition'>unusedPatBindWarn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsBind</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1378"></a><span class='hs-definition'>unusedPatBindWarn</span> <span class='hs-varid'>bind</span>
<a name="line-1379"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"This pattern-binding binds no variables:"</span><span class='hs-layout'>)</span>
<a name="line-1380"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>
<a name="line-1381"></a>
<a name="line-1382"></a><a name="dupMinimalSigErr"></a><span class='hs-definition'>dupMinimalSigErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-1383"></a><span class='hs-definition'>dupMinimalSigErr</span> <span class='hs-varid'>sigs</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-keyword'>_</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-1384"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1385"></a>    <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Multiple minimal complete definitions"</span>
<a name="line-1386"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"at"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sortBy</span> <span class='hs-conid'>SrcLoc.leftmost_smallest</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>getLocA</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span>
<a name="line-1387"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Combine alternative minimal complete definitions with `|'"</span> <span class='hs-keyglyph'>]</span>
<a name="line-1388"></a><span class='hs-definition'>dupMinimalSigErr</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dupMinimalSigErr"</span>
</pre></body>
</html>
