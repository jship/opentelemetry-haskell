<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Core/Opt/FloatOut.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
<a name="line-3"></a>
<a name="line-4"></a>\section[FloatOut]{Float bindings outwards (towards the top level)}
<a name="line-5"></a>
<a name="line-6"></a>``Long-distance'' floating of bindings towards the top level.
<a name="line-7"></a>-}</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Core.Opt.FloatOut</span> <span class='hs-layout'>(</span> <span class='hs-varid'>floatOutwards</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Utils</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Make</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.Arity</span> <span class='hs-layout'>(</span> <span class='hs-varid'>exprArity</span><span class='hs-layout'>,</span> <span class='hs-varid'>etaExpand</span> <span class='hs-layout'>)</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.Monad</span> <span class='hs-layout'>(</span> <span class='hs-conid'>FloatOutSwitches</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Session</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Logger</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>dumpIfSet_dyn</span><span class='hs-layout'>,</span> <span class='hs-conid'>DumpFormat</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Logger</span> <span class='hs-layout'>)</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Id</span>      <span class='hs-layout'>(</span> <span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-varid'>idArity</span><span class='hs-layout'>,</span> <span class='hs-varid'>idType</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDeadEndId</span><span class='hs-layout'>,</span>
<a name="line-24"></a>                           <span class='hs-varid'>isJoinId</span><span class='hs-layout'>,</span> <span class='hs-varid'>isJoinId_maybe</span> <span class='hs-layout'>)</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Tickish</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.SetLevels</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.Supply</span> <span class='hs-layout'>(</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-layout'>)</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Bag</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Maybe</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Type</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.IntMap</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>M</span>
<a name="line-35"></a>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>partition</span> <span class='hs-layout'>)</span>
<a name="line-37"></a>
<a name="line-38"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-comment'>{-
<a name="line-41"></a>        -----------------
<a name="line-42"></a>        Overall game plan
<a name="line-43"></a>        -----------------
<a name="line-44"></a>
<a name="line-45"></a>The Big Main Idea is:
<a name="line-46"></a>
<a name="line-47"></a>        To float out sub-expressions that can thereby get outside
<a name="line-48"></a>        a non-one-shot value lambda, and hence may be shared.
<a name="line-49"></a>
<a name="line-50"></a>
<a name="line-51"></a>To achieve this we may need to do two things:
<a name="line-52"></a>
<a name="line-53"></a>   a) Let-bind the sub-expression:
<a name="line-54"></a>
<a name="line-55"></a>        f (g x)  ==&gt;  let lvl = f (g x) in lvl
<a name="line-56"></a>
<a name="line-57"></a>      Now we can float the binding for 'lvl'.
<a name="line-58"></a>
<a name="line-59"></a>   b) More than that, we may need to abstract wrt a type variable
<a name="line-60"></a>
<a name="line-61"></a>        \x -&gt; ... /\a -&gt; let v = ...a... in ....
<a name="line-62"></a>
<a name="line-63"></a>      Here the binding for v mentions 'a' but not 'x'.  So we
<a name="line-64"></a>      abstract wrt 'a', to give this binding for 'v':
<a name="line-65"></a>
<a name="line-66"></a>            vp = /\a -&gt; ...a...
<a name="line-67"></a>            v  = vp a
<a name="line-68"></a>
<a name="line-69"></a>      Now the binding for vp can float out unimpeded.
<a name="line-70"></a>      I can't remember why this case seemed important enough to
<a name="line-71"></a>      deal with, but I certainly found cases where important floats
<a name="line-72"></a>      didn't happen if we did not abstract wrt tyvars.
<a name="line-73"></a>
<a name="line-74"></a>With this in mind we can also achieve another goal: lambda lifting.
<a name="line-75"></a>We can make an arbitrary (function) binding float to top level by
<a name="line-76"></a>abstracting wrt *all* local variables, not just type variables, leaving
<a name="line-77"></a>a binding that can be floated right to top level.  Whether or not this
<a name="line-78"></a>happens is controlled by a flag.
<a name="line-79"></a>
<a name="line-80"></a>
<a name="line-81"></a>Random comments
<a name="line-82"></a>~~~~~~~~~~~~~~~
<a name="line-83"></a>
<a name="line-84"></a>At the moment we never float a binding out to between two adjacent
<a name="line-85"></a>lambdas.  For example:
<a name="line-86"></a>
<a name="line-87"></a>@
<a name="line-88"></a>        \x y -&gt; let t = x+x in ...
<a name="line-89"></a>===&gt;
<a name="line-90"></a>        \x -&gt; let t = x+x in \y -&gt; ...
<a name="line-91"></a>@
<a name="line-92"></a>Reason: this is less efficient in the case where the original lambda
<a name="line-93"></a>is never partially applied.
<a name="line-94"></a>
<a name="line-95"></a>But there's a case I've seen where this might not be true.  Consider:
<a name="line-96"></a>@
<a name="line-97"></a>elEm2 x ys
<a name="line-98"></a>  = elem' x ys
<a name="line-99"></a>  where
<a name="line-100"></a>    elem' _ []  = False
<a name="line-101"></a>    elem' x (y:ys)      = x==y || elem' x ys
<a name="line-102"></a>@
<a name="line-103"></a>It turns out that this generates a subexpression of the form
<a name="line-104"></a>@
<a name="line-105"></a>        \deq x ys -&gt; let eq = eqFromEqDict deq in ...
<a name="line-106"></a>@
<a name="line-107"></a>which might usefully be separated to
<a name="line-108"></a>@
<a name="line-109"></a>        \deq -&gt; let eq = eqFromEqDict deq in \xy -&gt; ...
<a name="line-110"></a>@
<a name="line-111"></a>Well, maybe.  We don't do this at the moment.
<a name="line-112"></a>
<a name="line-113"></a>Note [Join points]
<a name="line-114"></a>~~~~~~~~~~~~~~~~~~
<a name="line-115"></a>Every occurrence of a join point must be a tail call (see Note [Invariants on
<a name="line-116"></a>join points] in GHC.Core), so we must be careful with how far we float them. The
<a name="line-117"></a>mechanism for doing so is the *join ceiling*, detailed in Note [Join ceiling]
<a name="line-118"></a>in GHC.Core.Opt.SetLevels. For us, the significance is that a binder might be marked to be
<a name="line-119"></a>dropped at the nearest boundary between tail calls and non-tail calls. For
<a name="line-120"></a>example:
<a name="line-121"></a>
<a name="line-122"></a>  (&lt; join j = ... in
<a name="line-123"></a>     let x = &lt; ... &gt; in
<a name="line-124"></a>     case &lt; ... &gt; of
<a name="line-125"></a>       A -&gt; ...
<a name="line-126"></a>       B -&gt; ...
<a name="line-127"></a>   &gt;) &lt; ... &gt; &lt; ... &gt;
<a name="line-128"></a>
<a name="line-129"></a>Here the join ceilings are marked with angle brackets. Either side of an
<a name="line-130"></a>application is a join ceiling, as is the scrutinee position of a case
<a name="line-131"></a>expression or the RHS of a let binding (but not a join point).
<a name="line-132"></a>
<a name="line-133"></a>Why do we *want* do float join points at all? After all, they're never
<a name="line-134"></a>allocated, so there's no sharing to be gained by floating them. However, the
<a name="line-135"></a>other benefit of floating is making RHSes small, and this can have a significant
<a name="line-136"></a>impact. In particular, stream fusion has been known to produce nested loops like
<a name="line-137"></a>this:
<a name="line-138"></a>
<a name="line-139"></a>  joinrec j1 x1 =
<a name="line-140"></a>    joinrec j2 x2 =
<a name="line-141"></a>      joinrec j3 x3 = ... jump j1 (x3 + 1) ... jump j2 (x3 + 1) ...
<a name="line-142"></a>      in jump j3 x2
<a name="line-143"></a>    in jump j2 x1
<a name="line-144"></a>  in jump j1 x
<a name="line-145"></a>
<a name="line-146"></a>(Assume x1 and x2 do *not* occur free in j3.)
<a name="line-147"></a>
<a name="line-148"></a>Here j1 and j2 are wholly superfluous---each of them merely forwards its
<a name="line-149"></a>argument to j3. Since j3 only refers to x3, we can float j2 and j3 to make
<a name="line-150"></a>everything one big mutual recursion:
<a name="line-151"></a>
<a name="line-152"></a>  joinrec j1 x1 = jump j2 x1
<a name="line-153"></a>          j2 x2 = jump j3 x2
<a name="line-154"></a>          j3 x3 = ... jump j1 (x3 + 1) ... jump j2 (x3 + 1) ...
<a name="line-155"></a>  in jump j1 x
<a name="line-156"></a>
<a name="line-157"></a>Now the simplifier will happily inline the trivial j1 and j2, leaving only j3.
<a name="line-158"></a>Without floating, we're stuck with three loops instead of one.
<a name="line-159"></a>
<a name="line-160"></a>************************************************************************
<a name="line-161"></a>*                                                                      *
<a name="line-162"></a>\subsection[floatOutwards]{@floatOutwards@: let-floating interface function}
<a name="line-163"></a>*                                                                      *
<a name="line-164"></a>************************************************************************
<a name="line-165"></a>-}</span>
<a name="line-166"></a>
<a name="line-167"></a><a name="floatOutwards"></a><span class='hs-definition'>floatOutwards</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Logger</span>
<a name="line-168"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatOutSwitches</span>
<a name="line-169"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span>
<a name="line-170"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-171"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CoreProgram</span>
<a name="line-172"></a>
<a name="line-173"></a><span class='hs-definition'>floatOutwards</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>float_sws</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>us</span> <span class='hs-varid'>pgm</span>
<a name="line-174"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-175"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>annotated_w_levels</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setLevels</span> <span class='hs-varid'>float_sws</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>us</span> <span class='hs-layout'>;</span>
<a name="line-176"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>fss</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds_s'</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>floatTopBind</span> <span class='hs-varid'>annotated_w_levels</span><span class='hs-layout'>)</span>
<a name="line-177"></a>            <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-178"></a>
<a name="line-179"></a>        <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_verbose_core2core</span> <span class='hs-str'>"Levels added:"</span>
<a name="line-180"></a>                  <span class='hs-conid'>FormatCore</span>
<a name="line-181"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>annotated_w_levels</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span>
<a name="line-182"></a>
<a name="line-183"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tlets</span><span class='hs-layout'>,</span> <span class='hs-varid'>ntlets</span><span class='hs-layout'>,</span> <span class='hs-varid'>lams</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>get_stats</span> <span class='hs-layout'>(</span><span class='hs-varid'>sum_stats</span> <span class='hs-varid'>fss</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>;</span>
<a name="line-184"></a>
<a name="line-185"></a>        <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_simpl_stats</span> <span class='hs-str'>"FloatOut stats:"</span>
<a name="line-186"></a>                <span class='hs-conid'>FormatText</span>
<a name="line-187"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>hcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>int</span> <span class='hs-varid'>tlets</span><span class='hs-layout'>,</span>  <span class='hs-varid'>text</span> <span class='hs-str'>" Lets floated to top level; "</span><span class='hs-layout'>,</span>
<a name="line-188"></a>                        <span class='hs-varid'>int</span> <span class='hs-varid'>ntlets</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>" Lets floated elsewhere; from "</span><span class='hs-layout'>,</span>
<a name="line-189"></a>                        <span class='hs-varid'>int</span> <span class='hs-varid'>lams</span><span class='hs-layout'>,</span>   <span class='hs-varid'>text</span> <span class='hs-str'>" Lambda groups"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span>
<a name="line-190"></a>
<a name="line-191"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionManyBags</span> <span class='hs-varid'>binds_s'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-192"></a>    <span class='hs-layout'>}</span>
<a name="line-193"></a>
<a name="line-194"></a><a name="floatTopBind"></a><span class='hs-definition'>floatTopBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LevelledBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatStats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>CoreBind</span><span class='hs-layout'>)</span>
<a name="line-195"></a><span class='hs-definition'>floatTopBind</span> <span class='hs-varid'>bind</span>
<a name="line-196"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatBind</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-197"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>float_bag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flattenTopFloats</span> <span class='hs-varid'>floats</span>
<a name="line-198"></a>    <span class='hs-keyword'>in</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>bind'</span> <span class='hs-keyword'>of</span>
<a name="line-199"></a>      <span class='hs-comment'>-- bind' can't have unlifted values or join points, so can only be one</span>
<a name="line-200"></a>      <span class='hs-comment'>-- value bind, rec or non-rec (see comment on floatBind)</span>
<a name="line-201"></a>      <span class='hs-keyglyph'>[</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>prs</span><span class='hs-keyglyph'>]</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitBag</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-varid'>addTopFloatPairs</span> <span class='hs-varid'>float_bag</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-202"></a>      <span class='hs-keyglyph'>[</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>float_bag</span> <span class='hs-varop'>`snocBag`</span> <span class='hs-conid'>NonRec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-203"></a>      <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"floatTopBind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bind'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-204"></a>
<a name="line-205"></a><span class='hs-comment'>{-
<a name="line-206"></a>************************************************************************
<a name="line-207"></a>*                                                                      *
<a name="line-208"></a>\subsection[FloatOut-Bind]{Floating in a binding (the business end)}
<a name="line-209"></a>*                                                                      *
<a name="line-210"></a>************************************************************************
<a name="line-211"></a>-}</span>
<a name="line-212"></a>
<a name="line-213"></a><a name="floatBind"></a><span class='hs-definition'>floatBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LevelledBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatStats</span><span class='hs-layout'>,</span> <span class='hs-conid'>FloatBinds</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBind</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-214"></a>  <span class='hs-comment'>-- Returns a list with either</span>
<a name="line-215"></a>  <span class='hs-comment'>--   * A single non-recursive binding (value or join point), or</span>
<a name="line-216"></a>  <span class='hs-comment'>--   * The following, in order:</span>
<a name="line-217"></a>  <span class='hs-comment'>--     * Zero or more non-rec unlifted bindings</span>
<a name="line-218"></a>  <span class='hs-comment'>--     * One or both of:</span>
<a name="line-219"></a>  <span class='hs-comment'>--       * A recursive group of join binds</span>
<a name="line-220"></a>  <span class='hs-comment'>--       * A recursive group of value binds</span>
<a name="line-221"></a>  <span class='hs-comment'>-- See Note [Floating out of Rec rhss] for why things get arranged this way.</span>
<a name="line-222"></a><span class='hs-definition'>floatBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-layout'>(</span><span class='hs-conid'>TB</span> <span class='hs-varid'>var</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-223"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatRhs</span> <span class='hs-varid'>var</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-224"></a>
<a name="line-225"></a>        <span class='hs-comment'>-- A tiresome hack:</span>
<a name="line-226"></a>        <span class='hs-comment'>-- see Note [Bottoming floats: eta expansion] in GHC.Core.Opt.SetLevels</span>
<a name="line-227"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>rhs''</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDeadEndId</span> <span class='hs-varid'>var</span>
<a name="line-228"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>exprArity</span> <span class='hs-varid'>rhs'</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>idArity</span> <span class='hs-varid'>var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>etaExpand</span> <span class='hs-layout'>(</span><span class='hs-varid'>idArity</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs'</span>
<a name="line-229"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs'</span>
<a name="line-230"></a>
<a name="line-231"></a>    <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_floats</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>var</span> <span class='hs-varid'>rhs''</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-232"></a>
<a name="line-233"></a><span class='hs-definition'>floatBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>
<a name="line-234"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>floatList</span> <span class='hs-varid'>do_pair</span> <span class='hs-varid'>pairs</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_pairs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-235"></a>    <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ul_pairss</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_other_pairss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>new_pairs</span>
<a name="line-236"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>new_join_pairs</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_l_pairs</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-layout'>(</span><span class='hs-varid'>isJoinId</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span>
<a name="line-237"></a>                                                      <span class='hs-layout'>(</span><span class='hs-varid'>concat</span> <span class='hs-varid'>new_other_pairss</span><span class='hs-layout'>)</span>
<a name="line-238"></a>        <span class='hs-comment'>-- Can't put the join points and the values in the same rec group</span>
<a name="line-239"></a>        <span class='hs-varid'>new_rec_binds</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>new_join_pairs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Rec</span> <span class='hs-varid'>new_l_pairs</span>    <span class='hs-keyglyph'>]</span>
<a name="line-240"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>new_l_pairs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Rec</span> <span class='hs-varid'>new_join_pairs</span> <span class='hs-keyglyph'>]</span>
<a name="line-241"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>           <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Rec</span> <span class='hs-varid'>new_l_pairs</span>
<a name="line-242"></a>                                              <span class='hs-layout'>,</span> <span class='hs-conid'>Rec</span> <span class='hs-varid'>new_join_pairs</span> <span class='hs-keyglyph'>]</span>
<a name="line-243"></a>        <span class='hs-varid'>new_non_rec_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>NonRec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>concat</span> <span class='hs-varid'>new_ul_pairss</span> <span class='hs-keyglyph'>]</span>
<a name="line-244"></a>    <span class='hs-keyword'>in</span>
<a name="line-245"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_non_rec_binds</span> <span class='hs-varop'>++</span> <span class='hs-varid'>new_rec_binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-246"></a>  <span class='hs-keyword'>where</span>
<a name="line-247"></a>    <span class='hs-varid'>do_pair</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>LevelledBndr</span><span class='hs-layout'>,</span> <span class='hs-conid'>LevelledExpr</span><span class='hs-layout'>)</span>
<a name="line-248"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatStats</span><span class='hs-layout'>,</span> <span class='hs-conid'>FloatBinds</span><span class='hs-layout'>,</span>
<a name="line-249"></a>                <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- Non-recursive unlifted value bindings</span>
<a name="line-250"></a>                 <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Join points and lifted value bindings</span>
<a name="line-251"></a>    <span class='hs-varid'>do_pair</span> <span class='hs-layout'>(</span><span class='hs-conid'>TB</span> <span class='hs-varid'>name</span> <span class='hs-varid'>spec</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-252"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTopLvl</span> <span class='hs-varid'>dest_lvl</span>  <span class='hs-comment'>-- See Note [floatBind for top level]</span>
<a name="line-253"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatRhs</span> <span class='hs-varid'>name</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-254"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>addTopFloatPairs</span> <span class='hs-layout'>(</span><span class='hs-varid'>flattenTopFloats</span> <span class='hs-varid'>rhs_floats</span><span class='hs-layout'>)</span>
<a name="line-255"></a>                                                <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>}</span>
<a name="line-256"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-comment'>-- Note [Floating out of Rec rhss]</span>
<a name="line-257"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatRhs</span> <span class='hs-varid'>name</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-258"></a>        <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>partitionByLevel</span> <span class='hs-varid'>dest_lvl</span> <span class='hs-varid'>rhs_floats</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>rhs_floats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>heres</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-259"></a>        <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitRecFloats</span> <span class='hs-varid'>heres</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ul_pairs</span><span class='hs-layout'>,</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>,</span> <span class='hs-varid'>case_heres</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-260"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>pairs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>installUnderLambdas</span> <span class='hs-varid'>case_heres</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>pairs</span> <span class='hs-keyword'>in</span>
<a name="line-261"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_floats'</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ul_pairs</span><span class='hs-layout'>,</span> <span class='hs-varid'>pairs'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-262"></a>      <span class='hs-keyword'>where</span>
<a name="line-263"></a>        <span class='hs-varid'>dest_lvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>floatSpecLevel</span> <span class='hs-varid'>spec</span>
<a name="line-264"></a>
<a name="line-265"></a><a name="splitRecFloats"></a><span class='hs-definition'>splitRecFloats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>FloatBind</span>
<a name="line-266"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Non-recursive unlifted value bindings</span>
<a name="line-267"></a>                   <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Join points and lifted value bindings</span>
<a name="line-268"></a>                   <span class='hs-conid'>Bag</span> <span class='hs-conid'>FloatBind</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- A tail of further bindings</span>
<a name="line-269"></a><span class='hs-comment'>-- The "tail" begins with a case</span>
<a name="line-270"></a><span class='hs-comment'>-- See Note [Floating out of Rec rhss]</span>
<a name="line-271"></a><span class='hs-definition'>splitRecFloats</span> <span class='hs-varid'>fs</span>
<a name="line-272"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span>
<a name="line-273"></a>  <span class='hs-keyword'>where</span>
<a name="line-274"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ul_prs</span> <span class='hs-varid'>prs</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnliftedType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-275"></a>                                               <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isJoinId</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-276"></a>                                               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>ul_prs</span><span class='hs-layout'>)</span> <span class='hs-varid'>prs</span> <span class='hs-varid'>fs</span>
<a name="line-277"></a>                                               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-278"></a>                                               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ul_prs</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>prs</span><span class='hs-layout'>)</span> <span class='hs-varid'>fs</span>
<a name="line-279"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ul_prs</span> <span class='hs-varid'>prs</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>prs'</span><span class='hs-layout'>)</span>   <span class='hs-conop'>:</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ul_prs</span> <span class='hs-layout'>(</span><span class='hs-varid'>prs'</span> <span class='hs-varop'>++</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span> <span class='hs-varid'>fs</span>
<a name="line-280"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ul_prs</span> <span class='hs-varid'>prs</span> <span class='hs-varid'>fs</span>                           <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>ul_prs</span><span class='hs-layout'>,</span> <span class='hs-varid'>prs</span><span class='hs-layout'>,</span>
<a name="line-281"></a>                                                  <span class='hs-varid'>listToBag</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span>
<a name="line-282"></a>                                                   <span class='hs-comment'>-- Order only matters for</span>
<a name="line-283"></a>                                                   <span class='hs-comment'>-- non-rec</span>
<a name="line-284"></a>
<a name="line-285"></a><a name="installUnderLambdas"></a><span class='hs-definition'>installUnderLambdas</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>FloatBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-286"></a><span class='hs-comment'>-- Note [Floating out of Rec rhss]</span>
<a name="line-287"></a><span class='hs-definition'>installUnderLambdas</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>e</span>
<a name="line-288"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>floats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>e</span>
<a name="line-289"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>e</span>
<a name="line-290"></a>  <span class='hs-keyword'>where</span>
<a name="line-291"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lam</span> <span class='hs-varid'>b</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-292"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>e</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>install</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>e</span>
<a name="line-293"></a>
<a name="line-294"></a><a name="floatList"></a><span class='hs-comment'>---------------</span>
<a name="line-295"></a><span class='hs-definition'>floatList</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatStats</span><span class='hs-layout'>,</span> <span class='hs-conid'>FloatBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatStats</span><span class='hs-layout'>,</span> <span class='hs-conid'>FloatBinds</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-296"></a><span class='hs-definition'>floatList</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>zeroStats</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-297"></a><span class='hs-definition'>floatList</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a</span>            <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs_a</span><span class='hs-layout'>,</span>  <span class='hs-varid'>binds_a</span><span class='hs-layout'>,</span>  <span class='hs-varid'>b</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span>
<a name="line-298"></a>                     <span class='hs-keyword'>case</span> <span class='hs-varid'>floatList</span> <span class='hs-varid'>f</span> <span class='hs-keyword'>as</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs_as</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds_as</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-299"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>fs_a</span> <span class='hs-varop'>`add_stats`</span> <span class='hs-varid'>fs_as</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds_a</span> <span class='hs-varop'>`plusFloats`</span>  <span class='hs-varid'>binds_as</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-300"></a>
<a name="line-301"></a><span class='hs-comment'>{-
<a name="line-302"></a>Note [Floating out of Rec rhss]
<a name="line-303"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-304"></a>Consider   Rec { f&lt;1,0&gt; = \xy. body }
<a name="line-305"></a>From the body we may get some floats. The ones with level &lt;1,0&gt; must
<a name="line-306"></a>stay here, since they may mention f.  Ideally we'd like to make them
<a name="line-307"></a>part of the Rec block pairs -- but we can't if there are any
<a name="line-308"></a>FloatCases involved.
<a name="line-309"></a>
<a name="line-310"></a>Nor is it a good idea to dump them in the rhs, but outside the lambda
<a name="line-311"></a>    f = case x of I# y -&gt; \xy. body
<a name="line-312"></a>because now f's arity might get worse, which is Not Good. (And if
<a name="line-313"></a>there's an SCC around the RHS it might not get better again.
<a name="line-314"></a>See #5342.)
<a name="line-315"></a>
<a name="line-316"></a>So, gruesomely, we split the floats into
<a name="line-317"></a> * the outer FloatLets, which can join the Rec, and
<a name="line-318"></a> * an inner batch starting in a FloatCase, which are then
<a name="line-319"></a>   pushed *inside* the lambdas.
<a name="line-320"></a>This loses full-laziness the rare situation where there is a
<a name="line-321"></a>FloatCase and a Rec interacting.
<a name="line-322"></a>
<a name="line-323"></a>If there are unlifted FloatLets (that *aren't* join points) among the floats,
<a name="line-324"></a>we can't add them to the recursive group without angering Core Lint, but since
<a name="line-325"></a>they must be ok-for-speculation, they can't actually be making any recursive
<a name="line-326"></a>calls, so we can safely pull them out and keep them non-recursive.
<a name="line-327"></a>
<a name="line-328"></a>(Why is something getting floated to &lt;1,0&gt; that doesn't make a recursive call?
<a name="line-329"></a>The case that came up in testing was that f *and* the unlifted binding were
<a name="line-330"></a>getting floated *to the same place*:
<a name="line-331"></a>
<a name="line-332"></a>  \x&lt;2,0&gt; -&gt;
<a name="line-333"></a>    ... &lt;3,0&gt;
<a name="line-334"></a>    letrec { f&lt;F&lt;2,0&gt;&gt; =
<a name="line-335"></a>      ... let x'&lt;F&lt;2,0&gt;&gt; = x +# 1# in ...
<a name="line-336"></a>    } in ...
<a name="line-337"></a>
<a name="line-338"></a>Everything gets labeled "float to &lt;2,0&gt;" because it all depends on x, but this
<a name="line-339"></a>makes f and x' look mutually recursive when they're not.
<a name="line-340"></a>
<a name="line-341"></a>The test was shootout/k-nucleotide, as compiled using commit 47d5dd68 on the
<a name="line-342"></a>wip/join-points branch.
<a name="line-343"></a>
<a name="line-344"></a>TODO: This can probably be solved somehow in GHC.Core.Opt.SetLevels. The difference between
<a name="line-345"></a>"this *is at* level &lt;2,0&gt;" and "this *depends on* level &lt;2,0&gt;" is very
<a name="line-346"></a>important.)
<a name="line-347"></a>
<a name="line-348"></a>Note [floatBind for top level]
<a name="line-349"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-350"></a>We may have a *nested* binding whose destination level is (FloatMe tOP_LEVEL), thus
<a name="line-351"></a>         letrec { foo &lt;0,0&gt; = .... (let bar&lt;0,0&gt; = .. in ..) .... }
<a name="line-352"></a>The binding for bar will be in the "tops" part of the floating binds,
<a name="line-353"></a>and thus not partioned by floatBody.
<a name="line-354"></a>
<a name="line-355"></a>We could perhaps get rid of the 'tops' component of the floating binds,
<a name="line-356"></a>but this case works just as well.
<a name="line-357"></a>
<a name="line-358"></a>
<a name="line-359"></a>************************************************************************
<a name="line-360"></a>
<a name="line-361"></a>\subsection[FloatOut-Expr]{Floating in expressions}
<a name="line-362"></a>*                                                                      *
<a name="line-363"></a>************************************************************************
<a name="line-364"></a>-}</span>
<a name="line-365"></a>
<a name="line-366"></a><a name="floatBody"></a><span class='hs-definition'>floatBody</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Level</span>
<a name="line-367"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LevelledExpr</span>
<a name="line-368"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatStats</span><span class='hs-layout'>,</span> <span class='hs-conid'>FloatBinds</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>
<a name="line-369"></a>
<a name="line-370"></a><span class='hs-definition'>floatBody</span> <span class='hs-varid'>lvl</span> <span class='hs-varid'>arg</span>       <span class='hs-comment'>-- Used rec rhss, and case-alternative rhss</span>
<a name="line-371"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatExpr</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsa</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-372"></a>    <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>partitionByLevel</span> <span class='hs-varid'>lvl</span> <span class='hs-varid'>floats</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>heres</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-373"></a>        <span class='hs-comment'>-- Dump bindings are bound here</span>
<a name="line-374"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fsa</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>install</span> <span class='hs-varid'>heres</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-375"></a>
<a name="line-376"></a><span class='hs-comment'>-----------------</span>
<a name="line-377"></a>
<a name="line-378"></a><span class='hs-comment'>{- Note [Floating past breakpoints]
<a name="line-379"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-380"></a>
<a name="line-381"></a>We used to disallow floating out of breakpoint ticks (see #10052). However, I
<a name="line-382"></a>think this is too restrictive.
<a name="line-383"></a>
<a name="line-384"></a>Consider the case of an expression scoped over by a breakpoint tick,
<a name="line-385"></a>
<a name="line-386"></a>  tick&lt;...&gt; (let x = ... in f x)
<a name="line-387"></a>
<a name="line-388"></a>In this case it is completely legal to float out x, despite the fact that
<a name="line-389"></a>breakpoint ticks are scoped,
<a name="line-390"></a>
<a name="line-391"></a>  let x = ... in (tick&lt;...&gt;  f x)
<a name="line-392"></a>
<a name="line-393"></a>The reason here is that we know that the breakpoint will still be hit when the
<a name="line-394"></a>expression is entered since the tick still scopes over the RHS.
<a name="line-395"></a>
<a name="line-396"></a>-}</span>
<a name="line-397"></a>
<a name="line-398"></a><a name="floatExpr"></a><span class='hs-definition'>floatExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LevelledExpr</span>
<a name="line-399"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatStats</span><span class='hs-layout'>,</span> <span class='hs-conid'>FloatBinds</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>
<a name="line-400"></a><span class='hs-definition'>floatExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>zeroStats</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-401"></a><span class='hs-definition'>floatExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>zeroStats</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-402"></a><span class='hs-definition'>floatExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>zeroStats</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-403"></a><span class='hs-definition'>floatExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>zeroStats</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Lit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>
<a name="line-404"></a>
<a name="line-405"></a><span class='hs-definition'>floatExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>e</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-406"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>atJoinCeiling</span> <span class='hs-varop'>$</span> <span class='hs-varid'>floatExpr</span>  <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fse</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats_e</span><span class='hs-layout'>,</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-407"></a>    <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>atJoinCeiling</span> <span class='hs-varop'>$</span> <span class='hs-varid'>floatExpr</span>  <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsa</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats_a</span><span class='hs-layout'>,</span> <span class='hs-varid'>a'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-408"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fse</span> <span class='hs-varop'>`add_stats`</span> <span class='hs-varid'>fsa</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats_e</span> <span class='hs-varop'>`plusFloats`</span> <span class='hs-varid'>floats_a</span><span class='hs-layout'>,</span> <span class='hs-conid'>App</span> <span class='hs-varid'>e'</span> <span class='hs-varid'>a'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-409"></a>
<a name="line-410"></a><span class='hs-definition'>floatExpr</span> <span class='hs-varid'>lam</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-layout'>(</span><span class='hs-conid'>TB</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>lam_spec</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-411"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs_w_lvls</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectBinders</span> <span class='hs-varid'>lam</span>
<a name="line-412"></a>        <span class='hs-varid'>bndrs</span>                <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TB</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bndrs_w_lvls</span><span class='hs-keyglyph'>]</span>
<a name="line-413"></a>        <span class='hs-varid'>bndr_lvl</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>asJoinCeilLvl</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatSpecLevel</span> <span class='hs-varid'>lam_spec</span><span class='hs-layout'>)</span>
<a name="line-414"></a>        <span class='hs-comment'>-- All the binders have the same level</span>
<a name="line-415"></a>        <span class='hs-comment'>-- See GHC.Core.Opt.SetLevels.lvlLamBndrs</span>
<a name="line-416"></a>        <span class='hs-comment'>-- Use asJoinCeilLvl to make this the join ceiling</span>
<a name="line-417"></a>    <span class='hs-keyword'>in</span>
<a name="line-418"></a>    <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatBody</span> <span class='hs-varid'>bndr_lvl</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-419"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>add_to_stats</span> <span class='hs-varid'>fs</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkLams</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-420"></a>
<a name="line-421"></a><span class='hs-definition'>floatExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>tickish</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-422"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tickish</span> <span class='hs-varop'>`tickishScopesLike`</span> <span class='hs-conid'>SoftScope</span> <span class='hs-comment'>-- not scoped, can just float</span>
<a name="line-423"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>atJoinCeiling</span> <span class='hs-varop'>$</span> <span class='hs-varid'>floatExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>    <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>floating_defns</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-424"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>floating_defns</span><span class='hs-layout'>,</span> <span class='hs-conid'>Tick</span> <span class='hs-varid'>tickish</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-425"></a>
<a name="line-426"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tickishCounts</span> <span class='hs-varid'>tickish</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tickishCanSplit</span> <span class='hs-varid'>tickish</span>
<a name="line-427"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>atJoinCeiling</span> <span class='hs-varop'>$</span> <span class='hs-varid'>floatExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>    <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>floating_defns</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-428"></a>    <span class='hs-keyword'>let</span> <span class='hs-comment'>-- Annotate bindings floated outwards past an scc expression</span>
<a name="line-429"></a>        <span class='hs-comment'>-- with the cc.  We mark that cc as "duplicated", though.</span>
<a name="line-430"></a>        <span class='hs-varid'>annotated_defns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTick</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNoCount</span> <span class='hs-varid'>tickish</span><span class='hs-layout'>)</span> <span class='hs-varid'>floating_defns</span>
<a name="line-431"></a>    <span class='hs-keyword'>in</span>
<a name="line-432"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>annotated_defns</span><span class='hs-layout'>,</span> <span class='hs-conid'>Tick</span> <span class='hs-varid'>tickish</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-433"></a>
<a name="line-434"></a>  <span class='hs-comment'>-- Note [Floating past breakpoints]</span>
<a name="line-435"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Breakpoint</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tickish</span>
<a name="line-436"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>    <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>floating_defns</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-437"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>floating_defns</span><span class='hs-layout'>,</span> <span class='hs-conid'>Tick</span> <span class='hs-varid'>tickish</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-438"></a>
<a name="line-439"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-440"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"floatExpr tick"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tickish</span><span class='hs-layout'>)</span>
<a name="line-441"></a>
<a name="line-442"></a><span class='hs-definition'>floatExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-443"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>atJoinCeiling</span> <span class='hs-varop'>$</span> <span class='hs-varid'>floatExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>floating_defns</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-444"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>floating_defns</span><span class='hs-layout'>,</span> <span class='hs-conid'>Cast</span> <span class='hs-varid'>expr'</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-445"></a>
<a name="line-446"></a><span class='hs-definition'>floatExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-447"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>bind_spec</span> <span class='hs-keyword'>of</span>
<a name="line-448"></a>      <span class='hs-conid'>FloatMe</span> <span class='hs-varid'>dest_lvl</span>
<a name="line-449"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatBind</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsb</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-450"></a>           <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatExpr</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fse</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-451"></a>           <span class='hs-keyword'>let</span> <span class='hs-varid'>new_bind_floats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>plusFloats</span> <span class='hs-varid'>emptyFloats</span>
<a name="line-452"></a>                                   <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitLetFloat</span> <span class='hs-varid'>dest_lvl</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span> <span class='hs-keyword'>in</span>
<a name="line-453"></a>           <span class='hs-layout'>(</span> <span class='hs-varid'>add_stats</span> <span class='hs-varid'>fsb</span> <span class='hs-varid'>fse</span>
<a name="line-454"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>bind_floats</span> <span class='hs-varop'>`plusFloats`</span> <span class='hs-varid'>new_bind_floats</span>
<a name="line-455"></a>                         <span class='hs-varop'>`plusFloats`</span> <span class='hs-varid'>body_floats</span>
<a name="line-456"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-457"></a>
<a name="line-458"></a>      <span class='hs-conid'>StayPut</span> <span class='hs-varid'>bind_lvl</span>  <span class='hs-comment'>-- See Note [Avoiding unnecessary floating]</span>
<a name="line-459"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatBind</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>          <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsb</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-460"></a>           <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatBody</span> <span class='hs-varid'>bind_lvl</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fse</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-461"></a>           <span class='hs-layout'>(</span> <span class='hs-varid'>add_stats</span> <span class='hs-varid'>fsb</span> <span class='hs-varid'>fse</span>
<a name="line-462"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>bind_floats</span> <span class='hs-varop'>`plusFloats`</span> <span class='hs-varid'>body_floats</span>
<a name="line-463"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>foldr</span> <span class='hs-conid'>Let</span> <span class='hs-varid'>body'</span> <span class='hs-varid'>binds'</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-464"></a>  <span class='hs-keyword'>where</span>
<a name="line-465"></a>    <span class='hs-varid'>bind_spec</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>bind</span> <span class='hs-keyword'>of</span>
<a name="line-466"></a>                 <span class='hs-conid'>NonRec</span> <span class='hs-layout'>(</span><span class='hs-conid'>TB</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span>
<a name="line-467"></a>                 <span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>TB</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span>
<a name="line-468"></a>                 <span class='hs-conid'>Rec</span> <span class='hs-conid'>[]</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"floatExpr:rec"</span>
<a name="line-469"></a>
<a name="line-470"></a><span class='hs-definition'>floatExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>scrut</span> <span class='hs-layout'>(</span><span class='hs-conid'>TB</span> <span class='hs-varid'>case_bndr</span> <span class='hs-varid'>case_spec</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-471"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>case_spec</span> <span class='hs-keyword'>of</span>
<a name="line-472"></a>      <span class='hs-conid'>FloatMe</span> <span class='hs-varid'>dest_lvl</span>  <span class='hs-comment'>-- Case expression moves</span>
<a name="line-473"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Alt</span> <span class='hs-varid'>con</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>rhs</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>alts</span>
<a name="line-474"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>atJoinCeiling</span> <span class='hs-varop'>$</span> <span class='hs-varid'>floatExpr</span> <span class='hs-varid'>scrut</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fse</span><span class='hs-layout'>,</span> <span class='hs-varid'>fde</span><span class='hs-layout'>,</span> <span class='hs-varid'>scrut'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-475"></a>           <span class='hs-keyword'>case</span>                 <span class='hs-varid'>floatExpr</span> <span class='hs-varid'>rhs</span>   <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsb</span><span class='hs-layout'>,</span> <span class='hs-varid'>fdb</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-476"></a>           <span class='hs-keyword'>let</span>
<a name="line-477"></a>             <span class='hs-varid'>float</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitCaseFloat</span> <span class='hs-varid'>dest_lvl</span> <span class='hs-varid'>scrut'</span>
<a name="line-478"></a>                          <span class='hs-varid'>case_bndr</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TB</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bndrs</span><span class='hs-keyglyph'>]</span>
<a name="line-479"></a>           <span class='hs-keyword'>in</span>
<a name="line-480"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>add_stats</span> <span class='hs-varid'>fse</span> <span class='hs-varid'>fsb</span><span class='hs-layout'>,</span> <span class='hs-varid'>fde</span> <span class='hs-varop'>`plusFloats`</span> <span class='hs-varid'>float</span> <span class='hs-varop'>`plusFloats`</span> <span class='hs-varid'>fdb</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-481"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-482"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"Floating multi-case"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-483"></a>
<a name="line-484"></a>      <span class='hs-conid'>StayPut</span> <span class='hs-varid'>bind_lvl</span>  <span class='hs-comment'>-- Case expression stays put</span>
<a name="line-485"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>atJoinCeiling</span> <span class='hs-varop'>$</span> <span class='hs-varid'>floatExpr</span> <span class='hs-varid'>scrut</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fse</span><span class='hs-layout'>,</span> <span class='hs-varid'>fde</span><span class='hs-layout'>,</span> <span class='hs-varid'>scrut'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-486"></a>           <span class='hs-keyword'>case</span> <span class='hs-varid'>floatList</span> <span class='hs-layout'>(</span><span class='hs-varid'>float_alt</span> <span class='hs-varid'>bind_lvl</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsa</span><span class='hs-layout'>,</span> <span class='hs-varid'>fda</span><span class='hs-layout'>,</span> <span class='hs-varid'>alts'</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span>
<a name="line-487"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>add_stats</span> <span class='hs-varid'>fse</span> <span class='hs-varid'>fsa</span><span class='hs-layout'>,</span> <span class='hs-varid'>fda</span> <span class='hs-varop'>`plusFloats`</span> <span class='hs-varid'>fde</span><span class='hs-layout'>,</span> <span class='hs-conid'>Case</span> <span class='hs-varid'>scrut'</span> <span class='hs-varid'>case_bndr</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>alts'</span><span class='hs-layout'>)</span>
<a name="line-488"></a>           <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-489"></a>  <span class='hs-keyword'>where</span>
<a name="line-490"></a>    <span class='hs-varid'>float_alt</span> <span class='hs-varid'>bind_lvl</span> <span class='hs-layout'>(</span><span class='hs-conid'>Alt</span> <span class='hs-varid'>con</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-491"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatBody</span> <span class='hs-varid'>bind_lvl</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-492"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Alt</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TB</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bs</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-493"></a>
<a name="line-494"></a><a name="floatRhs"></a><span class='hs-definition'>floatRhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreBndr</span>
<a name="line-495"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LevelledExpr</span>
<a name="line-496"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatStats</span><span class='hs-layout'>,</span> <span class='hs-conid'>FloatBinds</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>
<a name="line-497"></a><span class='hs-definition'>floatRhs</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span>
<a name="line-498"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>join_arity</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isJoinId_maybe</span> <span class='hs-varid'>bndr</span>
<a name="line-499"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>try_collect</span> <span class='hs-varid'>join_arity</span> <span class='hs-varid'>rhs</span> <span class='hs-conid'>[]</span>
<a name="line-500"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>bndrs</span> <span class='hs-keyword'>of</span>
<a name="line-501"></a>      <span class='hs-conid'>[]</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>floatExpr</span> <span class='hs-varid'>rhs</span>
<a name="line-502"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>TB</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>lam_spec</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-503"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>lvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>floatSpecLevel</span> <span class='hs-varid'>lam_spec</span> <span class='hs-keyword'>in</span>
<a name="line-504"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>floatBody</span> <span class='hs-varid'>lvl</span> <span class='hs-varid'>body</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-505"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkLams</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TB</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bndrs</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-506"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-507"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>atJoinCeiling</span> <span class='hs-varop'>$</span> <span class='hs-varid'>floatExpr</span> <span class='hs-varid'>rhs</span>
<a name="line-508"></a>  <span class='hs-keyword'>where</span>
<a name="line-509"></a>    <span class='hs-varid'>try_collect</span> <span class='hs-num'>0</span> <span class='hs-varid'>expr</span>      <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>acc</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-510"></a>    <span class='hs-varid'>try_collect</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>try_collect</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-511"></a>    <span class='hs-varid'>try_collect</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>         <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-512"></a>
<a name="line-513"></a><span class='hs-comment'>{-
<a name="line-514"></a>Note [Avoiding unnecessary floating]
<a name="line-515"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-516"></a>In general we want to avoid floating a let unnecessarily, because
<a name="line-517"></a>it might worsen strictness:
<a name="line-518"></a>    let
<a name="line-519"></a>       x = ...(let y = e in y+y)....
<a name="line-520"></a>Here y is demanded.  If we float it outside the lazy 'x=..' then
<a name="line-521"></a>we'd have to zap its demand info, and it may never be restored.
<a name="line-522"></a>
<a name="line-523"></a>So at a 'let' we leave the binding right where the are unless
<a name="line-524"></a>the binding will escape a value lambda, e.g.
<a name="line-525"></a>
<a name="line-526"></a>(\x -&gt; let y = fac 100 in y)
<a name="line-527"></a>
<a name="line-528"></a>That's what the partitionByMajorLevel does in the floatExpr (Let ...)
<a name="line-529"></a>case.
<a name="line-530"></a>
<a name="line-531"></a>Notice, though, that we must take care to drop any bindings
<a name="line-532"></a>from the body of the let that depend on the staying-put bindings.
<a name="line-533"></a>
<a name="line-534"></a>We used instead to do the partitionByMajorLevel on the RHS of an '=',
<a name="line-535"></a>in floatRhs.  But that was quite tiresome.  We needed to test for
<a name="line-536"></a>values or trivial rhss, because (in particular) we don't want to insert
<a name="line-537"></a>new bindings between the "=" and the "\".  E.g.
<a name="line-538"></a>        f = \x -&gt; let &lt;bind&gt; in &lt;body&gt;
<a name="line-539"></a>We do not want
<a name="line-540"></a>        f = let &lt;bind&gt; in \x -&gt; &lt;body&gt;
<a name="line-541"></a>(a) The simplifier will immediately float it further out, so we may
<a name="line-542"></a>        as well do so right now; in general, keeping rhss as manifest
<a name="line-543"></a>        values is good
<a name="line-544"></a>(b) If a float-in pass follows immediately, it might add yet more
<a name="line-545"></a>        bindings just after the '='.  And some of them might (correctly)
<a name="line-546"></a>        be strict even though the 'let f' is lazy, because f, being a value,
<a name="line-547"></a>        gets its demand-info zapped by the simplifier.
<a name="line-548"></a>And even all that turned out to be very fragile, and broke
<a name="line-549"></a>altogether when profiling got in the way.
<a name="line-550"></a>
<a name="line-551"></a>So now we do the partition right at the (Let..) itself.
<a name="line-552"></a>
<a name="line-553"></a>************************************************************************
<a name="line-554"></a>*                                                                      *
<a name="line-555"></a>\subsection{Utility bits for floating stats}
<a name="line-556"></a>*                                                                      *
<a name="line-557"></a>************************************************************************
<a name="line-558"></a>
<a name="line-559"></a>I didn't implement this with unboxed numbers.  I don't want to be too
<a name="line-560"></a>strict in this stuff, as it is rarely turned on.  (WDP 95/09)
<a name="line-561"></a>-}</span>
<a name="line-562"></a>
<a name="line-563"></a><a name="FloatStats"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>FloatStats</span>
<a name="line-564"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FlS</span> <span class='hs-conid'>Int</span>  <span class='hs-comment'>-- Number of top-floats * lambda groups they've been past</span>
<a name="line-565"></a>        <span class='hs-conid'>Int</span>  <span class='hs-comment'>-- Number of non-top-floats * lambda groups they've been past</span>
<a name="line-566"></a>        <span class='hs-conid'>Int</span>  <span class='hs-comment'>-- Number of lambda (groups) seen</span>
<a name="line-567"></a>
<a name="line-568"></a><a name="get_stats"></a><span class='hs-definition'>get_stats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FloatStats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-569"></a><span class='hs-definition'>get_stats</span> <span class='hs-layout'>(</span><span class='hs-conid'>FlS</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-570"></a>
<a name="line-571"></a><a name="zeroStats"></a><span class='hs-definition'>zeroStats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FloatStats</span>
<a name="line-572"></a><span class='hs-definition'>zeroStats</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FlS</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span>
<a name="line-573"></a>
<a name="line-574"></a><a name="sum_stats"></a><span class='hs-definition'>sum_stats</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FloatStats</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatStats</span>
<a name="line-575"></a><span class='hs-definition'>sum_stats</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>add_stats</span> <span class='hs-varid'>zeroStats</span> <span class='hs-varid'>xs</span>
<a name="line-576"></a>
<a name="line-577"></a><a name="add_stats"></a><span class='hs-definition'>add_stats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FloatStats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatStats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatStats</span>
<a name="line-578"></a><span class='hs-definition'>add_stats</span> <span class='hs-layout'>(</span><span class='hs-conid'>FlS</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>b1</span> <span class='hs-varid'>c1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FlS</span> <span class='hs-varid'>a2</span> <span class='hs-varid'>b2</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span>
<a name="line-579"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FlS</span> <span class='hs-layout'>(</span><span class='hs-varid'>a1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>b1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>b2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>c1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span>
<a name="line-580"></a>
<a name="line-581"></a><a name="add_to_stats"></a><span class='hs-definition'>add_to_stats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FloatStats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatBinds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatStats</span>
<a name="line-582"></a><span class='hs-definition'>add_to_stats</span> <span class='hs-layout'>(</span><span class='hs-conid'>FlS</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FB</span> <span class='hs-varid'>tops</span> <span class='hs-varid'>ceils</span> <span class='hs-varid'>others</span><span class='hs-layout'>)</span>
<a name="line-583"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FlS</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-varop'>+</span> <span class='hs-varid'>lengthBag</span> <span class='hs-varid'>tops</span><span class='hs-layout'>)</span>
<a name="line-584"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>b</span> <span class='hs-varop'>+</span> <span class='hs-varid'>lengthBag</span> <span class='hs-varid'>ceils</span> <span class='hs-varop'>+</span> <span class='hs-varid'>lengthBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>flattenMajor</span> <span class='hs-varid'>others</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-585"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>c</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-586"></a>
<a name="line-587"></a><span class='hs-comment'>{-
<a name="line-588"></a>************************************************************************
<a name="line-589"></a>*                                                                      *
<a name="line-590"></a>\subsection{Utility bits for floating}
<a name="line-591"></a>*                                                                      *
<a name="line-592"></a>************************************************************************
<a name="line-593"></a>
<a name="line-594"></a>Note [Representation of FloatBinds]
<a name="line-595"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-596"></a>The FloatBinds types is somewhat important.  We can get very large numbers
<a name="line-597"></a>of floating bindings, often all destined for the top level.  A typical example
<a name="line-598"></a>is     x = [4,2,5,2,5, .... ]
<a name="line-599"></a>Then we get lots of small expressions like (fromInteger 4), which all get
<a name="line-600"></a>lifted to top level.
<a name="line-601"></a>
<a name="line-602"></a>The trouble is that
<a name="line-603"></a>  (a) we partition these floating bindings *at every binding site*
<a name="line-604"></a>  (b) GHC.Core.Opt.SetLevels introduces a new bindings site for every float
<a name="line-605"></a>So we had better not look at each binding at each binding site!
<a name="line-606"></a>
<a name="line-607"></a>That is why MajorEnv is represented as a finite map.
<a name="line-608"></a>
<a name="line-609"></a>We keep the bindings destined for the *top* level separate, because
<a name="line-610"></a>we float them out even if they don't escape a *value* lambda; see
<a name="line-611"></a>partitionByMajorLevel.
<a name="line-612"></a>-}</span>
<a name="line-613"></a>
<a name="line-614"></a><a name="FloatLet"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FloatLet</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreBind</span>        <span class='hs-comment'>-- INVARIANT: a FloatLet is always lifted</span>
<a name="line-615"></a><a name="MajorEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>MajorEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M.IntMap</span> <span class='hs-conid'>MinorEnv</span>         <span class='hs-comment'>-- Keyed by major level</span>
<a name="line-616"></a><a name="MinorEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>MinorEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M.IntMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>FloatBind</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Keyed by minor level</span>
<a name="line-617"></a>
<a name="line-618"></a><a name="FloatBinds"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>FloatBinds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FB</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>FloatLet</span><span class='hs-layout'>)</span>           <span class='hs-comment'>-- Destined for top level</span>
<a name="line-619"></a>                      <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>FloatBind</span><span class='hs-layout'>)</span>          <span class='hs-comment'>-- Destined for join ceiling</span>
<a name="line-620"></a>                      <span class='hs-varop'>!</span><span class='hs-conid'>MajorEnv</span>                 <span class='hs-comment'>-- Other levels</span>
<a name="line-621"></a>     <span class='hs-comment'>-- See Note [Representation of FloatBinds]</span>
<a name="line-622"></a>
<a name="line-623"></a><a name="instance%20Outputable%20FloatBinds"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>FloatBinds</span> <span class='hs-keyword'>where</span>
<a name="line-624"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>FB</span> <span class='hs-varid'>fbs</span> <span class='hs-varid'>ceils</span> <span class='hs-varid'>defs</span><span class='hs-layout'>)</span>
<a name="line-625"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"FB"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>braces</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span>
<a name="line-626"></a>           <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tops ="</span>     <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fbs</span>
<a name="line-627"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ceils ="</span>    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ceils</span>
<a name="line-628"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"non-tops ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>defs</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-629"></a>
<a name="line-630"></a><a name="flattenTopFloats"></a><span class='hs-definition'>flattenTopFloats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FloatBinds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>CoreBind</span>
<a name="line-631"></a><span class='hs-definition'>flattenTopFloats</span> <span class='hs-layout'>(</span><span class='hs-conid'>FB</span> <span class='hs-varid'>tops</span> <span class='hs-varid'>ceils</span> <span class='hs-varid'>defs</span><span class='hs-layout'>)</span>
<a name="line-632"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>flattenMajor</span> <span class='hs-varid'>defs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>defs</span> <span class='hs-layout'>)</span>
<a name="line-633"></a>    <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>ceils</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ceils</span> <span class='hs-layout'>)</span>
<a name="line-634"></a>    <span class='hs-varid'>tops</span>
<a name="line-635"></a>
<a name="line-636"></a><a name="addTopFloatPairs"></a><span class='hs-definition'>addTopFloatPairs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>CoreBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-637"></a><span class='hs-definition'>addTopFloatPairs</span> <span class='hs-varid'>float_bag</span> <span class='hs-varid'>prs</span>
<a name="line-638"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>add</span> <span class='hs-varid'>prs</span> <span class='hs-varid'>float_bag</span>
<a name="line-639"></a>  <span class='hs-keyword'>where</span>
<a name="line-640"></a>    <span class='hs-varid'>add</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>prs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>prs</span>
<a name="line-641"></a>    <span class='hs-varid'>add</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>prs1</span><span class='hs-layout'>)</span>   <span class='hs-varid'>prs2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prs1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>prs2</span>
<a name="line-642"></a>
<a name="line-643"></a><a name="flattenMajor"></a><span class='hs-definition'>flattenMajor</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MajorEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>FloatBind</span>
<a name="line-644"></a><span class='hs-definition'>flattenMajor</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M.foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionBags</span> <span class='hs-varop'>.</span> <span class='hs-varid'>flattenMinor</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyBag</span>
<a name="line-645"></a>
<a name="line-646"></a><a name="flattenMinor"></a><span class='hs-definition'>flattenMinor</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MinorEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>FloatBind</span>
<a name="line-647"></a><span class='hs-definition'>flattenMinor</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M.foldr</span> <span class='hs-varid'>unionBags</span> <span class='hs-varid'>emptyBag</span>
<a name="line-648"></a>
<a name="line-649"></a><a name="emptyFloats"></a><span class='hs-definition'>emptyFloats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FloatBinds</span>
<a name="line-650"></a><span class='hs-definition'>emptyFloats</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FB</span> <span class='hs-varid'>emptyBag</span> <span class='hs-varid'>emptyBag</span> <span class='hs-conid'>M.empty</span>
<a name="line-651"></a>
<a name="line-652"></a><a name="unitCaseFloat"></a><span class='hs-definition'>unitCaseFloat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Level</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AltCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatBinds</span>
<a name="line-653"></a><span class='hs-definition'>unitCaseFloat</span> <span class='hs-layout'>(</span><span class='hs-conid'>Level</span> <span class='hs-varid'>major</span> <span class='hs-varid'>minor</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-varid'>b</span> <span class='hs-varid'>con</span> <span class='hs-varid'>bs</span>
<a name="line-654"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>t</span> <span class='hs-varop'>==</span> <span class='hs-conid'>JoinCeilLvl</span>
<a name="line-655"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FB</span> <span class='hs-varid'>emptyBag</span> <span class='hs-varid'>floats</span> <span class='hs-conid'>M.empty</span>
<a name="line-656"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-657"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FB</span> <span class='hs-varid'>emptyBag</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>(</span><span class='hs-conid'>M.singleton</span> <span class='hs-varid'>major</span> <span class='hs-layout'>(</span><span class='hs-conid'>M.singleton</span> <span class='hs-varid'>minor</span> <span class='hs-varid'>floats</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-658"></a>  <span class='hs-keyword'>where</span>
<a name="line-659"></a>    <span class='hs-varid'>floats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitBag</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatCase</span> <span class='hs-varid'>e</span> <span class='hs-varid'>b</span> <span class='hs-varid'>con</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-660"></a>
<a name="line-661"></a><a name="unitLetFloat"></a><span class='hs-definition'>unitLetFloat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Level</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatLet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatBinds</span>
<a name="line-662"></a><span class='hs-definition'>unitLetFloat</span> <span class='hs-varid'>lvl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Level</span> <span class='hs-varid'>major</span> <span class='hs-varid'>minor</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span>
<a name="line-663"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTopLvl</span> <span class='hs-varid'>lvl</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FB</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitBag</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyBag</span> <span class='hs-conid'>M.empty</span>
<a name="line-664"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>t</span> <span class='hs-varop'>==</span> <span class='hs-conid'>JoinCeilLvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FB</span> <span class='hs-varid'>emptyBag</span> <span class='hs-varid'>floats</span> <span class='hs-conid'>M.empty</span>
<a name="line-665"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FB</span> <span class='hs-varid'>emptyBag</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>(</span><span class='hs-conid'>M.singleton</span> <span class='hs-varid'>major</span>
<a name="line-666"></a>                                              <span class='hs-layout'>(</span><span class='hs-conid'>M.singleton</span> <span class='hs-varid'>minor</span> <span class='hs-varid'>floats</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-667"></a>  <span class='hs-keyword'>where</span>
<a name="line-668"></a>    <span class='hs-varid'>floats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitBag</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-669"></a>
<a name="line-670"></a><a name="plusFloats"></a><span class='hs-definition'>plusFloats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FloatBinds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatBinds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatBinds</span>
<a name="line-671"></a><span class='hs-definition'>plusFloats</span> <span class='hs-layout'>(</span><span class='hs-conid'>FB</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>l1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FB</span> <span class='hs-varid'>t2</span> <span class='hs-varid'>c2</span> <span class='hs-varid'>l2</span><span class='hs-layout'>)</span>
<a name="line-672"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FB</span> <span class='hs-layout'>(</span><span class='hs-varid'>t1</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>c1</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>l1</span> <span class='hs-varop'>`plusMajor`</span> <span class='hs-varid'>l2</span><span class='hs-layout'>)</span>
<a name="line-673"></a>
<a name="line-674"></a><a name="plusMajor"></a><span class='hs-definition'>plusMajor</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MajorEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MajorEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MajorEnv</span>
<a name="line-675"></a><span class='hs-definition'>plusMajor</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M.unionWith</span> <span class='hs-varid'>plusMinor</span>
<a name="line-676"></a>
<a name="line-677"></a><a name="plusMinor"></a><span class='hs-definition'>plusMinor</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MinorEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MinorEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MinorEnv</span>
<a name="line-678"></a><span class='hs-definition'>plusMinor</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M.unionWith</span> <span class='hs-varid'>unionBags</span>
<a name="line-679"></a>
<a name="line-680"></a><a name="install"></a><span class='hs-definition'>install</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>FloatBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-681"></a><span class='hs-definition'>install</span> <span class='hs-varid'>defn_groups</span> <span class='hs-varid'>expr</span>
<a name="line-682"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>wrapFloat</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>defn_groups</span>
<a name="line-683"></a>
<a name="line-684"></a><a name="partitionByLevel"></a><span class='hs-definition'>partitionByLevel</span>
<a name="line-685"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Level</span>                <span class='hs-comment'>-- Partitioning level</span>
<a name="line-686"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatBinds</span>           <span class='hs-comment'>-- Defns to be divided into 2 piles...</span>
<a name="line-687"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatBinds</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- Defns  with level strictly &lt; partition level,</span>
<a name="line-688"></a>            <span class='hs-conid'>Bag</span> <span class='hs-conid'>FloatBind</span><span class='hs-layout'>)</span>      <span class='hs-comment'>-- The rest</span>
<a name="line-689"></a>
<a name="line-690"></a><span class='hs-comment'>{-
<a name="line-691"></a>--       ---- partitionByMajorLevel ----
<a name="line-692"></a>-- Float it if we escape a value lambda,
<a name="line-693"></a>--     *or* if we get to the top level
<a name="line-694"></a>--     *or* if it's a case-float and its minor level is &lt; current
<a name="line-695"></a>--
<a name="line-696"></a>-- If we can get to the top level, say "yes" anyway. This means that
<a name="line-697"></a>--      x = f e
<a name="line-698"></a>-- transforms to
<a name="line-699"></a>--    lvl = e
<a name="line-700"></a>--    x = f lvl
<a name="line-701"></a>-- which is as it should be
<a name="line-702"></a>
<a name="line-703"></a>partitionByMajorLevel (Level major _) (FB tops defns)
<a name="line-704"></a>  = (FB tops outer, heres `unionBags` flattenMajor inner)
<a name="line-705"></a>  where
<a name="line-706"></a>    (outer, mb_heres, inner) = M.splitLookup major defns
<a name="line-707"></a>    heres = case mb_heres of
<a name="line-708"></a>               Nothing -&gt; emptyBag
<a name="line-709"></a>               Just h  -&gt; flattenMinor h
<a name="line-710"></a>-}</span>
<a name="line-711"></a>
<a name="line-712"></a><span class='hs-definition'>partitionByLevel</span> <span class='hs-layout'>(</span><span class='hs-conid'>Level</span> <span class='hs-varid'>major</span> <span class='hs-varid'>minor</span> <span class='hs-varid'>typ</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FB</span> <span class='hs-varid'>tops</span> <span class='hs-varid'>ceils</span> <span class='hs-varid'>defns</span><span class='hs-layout'>)</span>
<a name="line-713"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>FB</span> <span class='hs-varid'>tops</span> <span class='hs-varid'>ceils'</span> <span class='hs-layout'>(</span><span class='hs-varid'>outer_maj</span> <span class='hs-varop'>`plusMajor`</span> <span class='hs-conid'>M.singleton</span> <span class='hs-varid'>major</span> <span class='hs-varid'>outer_min</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-714"></a>     <span class='hs-varid'>here_min</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>here_ceil</span>
<a name="line-715"></a>              <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>flattenMinor</span> <span class='hs-varid'>inner_min</span>
<a name="line-716"></a>              <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>flattenMajor</span> <span class='hs-varid'>inner_maj</span><span class='hs-layout'>)</span>
<a name="line-717"></a>
<a name="line-718"></a>  <span class='hs-keyword'>where</span>
<a name="line-719"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>outer_maj</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_here_maj</span><span class='hs-layout'>,</span> <span class='hs-varid'>inner_maj</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M.splitLookup</span> <span class='hs-varid'>major</span> <span class='hs-varid'>defns</span>
<a name="line-720"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>outer_min</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_here_min</span><span class='hs-layout'>,</span> <span class='hs-varid'>inner_min</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_here_maj</span> <span class='hs-keyword'>of</span>
<a name="line-721"></a>                                            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>M.empty</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-conid'>M.empty</span><span class='hs-layout'>)</span>
<a name="line-722"></a>                                            <span class='hs-conid'>Just</span> <span class='hs-varid'>min_defns</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>M.splitLookup</span> <span class='hs-varid'>minor</span> <span class='hs-varid'>min_defns</span>
<a name="line-723"></a>    <span class='hs-varid'>here_min</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_here_min</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>emptyBag</span>
<a name="line-724"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>here_ceil</span><span class='hs-layout'>,</span> <span class='hs-varid'>ceils'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>typ</span> <span class='hs-varop'>==</span> <span class='hs-conid'>JoinCeilLvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ceils</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyBag</span><span class='hs-layout'>)</span>
<a name="line-725"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>ceils</span><span class='hs-layout'>)</span>
<a name="line-726"></a>
<a name="line-727"></a><a name="partitionAtJoinCeiling"></a><span class='hs-comment'>-- Like partitionByLevel, but instead split out the bindings that are marked</span>
<a name="line-728"></a><span class='hs-comment'>-- to float to the nearest join ceiling (see Note [Join points])</span>
<a name="line-729"></a><span class='hs-definition'>partitionAtJoinCeiling</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FloatBinds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatBinds</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>FloatBind</span><span class='hs-layout'>)</span>
<a name="line-730"></a><span class='hs-definition'>partitionAtJoinCeiling</span> <span class='hs-layout'>(</span><span class='hs-conid'>FB</span> <span class='hs-varid'>tops</span> <span class='hs-varid'>ceils</span> <span class='hs-varid'>defs</span><span class='hs-layout'>)</span>
<a name="line-731"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>FB</span> <span class='hs-varid'>tops</span> <span class='hs-varid'>emptyBag</span> <span class='hs-varid'>defs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ceils</span><span class='hs-layout'>)</span>
<a name="line-732"></a>
<a name="line-733"></a><a name="atJoinCeiling"></a><span class='hs-comment'>-- Perform some action at a join ceiling, i.e., don't let join points float out</span>
<a name="line-734"></a><span class='hs-comment'>-- (see Note [Join points])</span>
<a name="line-735"></a><span class='hs-definition'>atJoinCeiling</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatStats</span><span class='hs-layout'>,</span> <span class='hs-conid'>FloatBinds</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>
<a name="line-736"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatStats</span><span class='hs-layout'>,</span> <span class='hs-conid'>FloatBinds</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>
<a name="line-737"></a><span class='hs-definition'>atJoinCeiling</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span>
<a name="line-738"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>install</span> <span class='hs-varid'>ceils</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span>
<a name="line-739"></a>  <span class='hs-keyword'>where</span>
<a name="line-740"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>floats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ceils</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionAtJoinCeiling</span> <span class='hs-varid'>floats</span>
<a name="line-741"></a>
<a name="line-742"></a><a name="wrapTick"></a><span class='hs-definition'>wrapTick</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreTickish</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatBinds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatBinds</span>
<a name="line-743"></a><span class='hs-definition'>wrapTick</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>FB</span> <span class='hs-varid'>tops</span> <span class='hs-varid'>ceils</span> <span class='hs-varid'>defns</span><span class='hs-layout'>)</span>
<a name="line-744"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FB</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapBag</span> <span class='hs-varid'>wrap_bind</span> <span class='hs-varid'>tops</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap_defns</span> <span class='hs-varid'>ceils</span><span class='hs-layout'>)</span>
<a name="line-745"></a>       <span class='hs-layout'>(</span><span class='hs-conid'>M.map</span> <span class='hs-layout'>(</span><span class='hs-conid'>M.map</span> <span class='hs-varid'>wrap_defns</span><span class='hs-layout'>)</span> <span class='hs-varid'>defns</span><span class='hs-layout'>)</span>
<a name="line-746"></a>  <span class='hs-keyword'>where</span>
<a name="line-747"></a>    <span class='hs-varid'>wrap_defns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapBag</span> <span class='hs-varid'>wrap_one</span>
<a name="line-748"></a>
<a name="line-749"></a>    <span class='hs-varid'>wrap_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>binder</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NonRec</span> <span class='hs-varid'>binder</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybe_tick</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-750"></a>    <span class='hs-varid'>wrap_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapSnd</span> <span class='hs-varid'>maybe_tick</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>
<a name="line-751"></a>
<a name="line-752"></a>    <span class='hs-varid'>wrap_one</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap_bind</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>
<a name="line-753"></a>    <span class='hs-varid'>wrap_one</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatCase</span> <span class='hs-varid'>e</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FloatCase</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybe_tick</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-varid'>bs</span>
<a name="line-754"></a>
<a name="line-755"></a>    <span class='hs-varid'>maybe_tick</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>exprIsHNF</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tickHNFArgs</span> <span class='hs-varid'>t</span> <span class='hs-varid'>e</span>
<a name="line-756"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>e</span>
<a name="line-757"></a>      <span class='hs-comment'>-- we don't need to wrap a tick around an HNF when we float it</span>
<a name="line-758"></a>      <span class='hs-comment'>-- outside a tick: that is an invariant of the tick semantics</span>
<a name="line-759"></a>      <span class='hs-comment'>-- Conversely, inlining of HNFs inside an SCC is allowed, and</span>
<a name="line-760"></a>      <span class='hs-comment'>-- indeed the HNF we're floating here might well be inlined back</span>
<a name="line-761"></a>      <span class='hs-comment'>-- again, and we don't want to end up with duplicate ticks.</span>
</pre></body>
</html>
