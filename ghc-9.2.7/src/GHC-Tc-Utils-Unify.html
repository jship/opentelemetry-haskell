<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Tc/Utils/Unify.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP                 #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE TupleSections       #-}</span>
<a name="line-4"></a><span class='hs-comment'>{-# LANGUAGE BlockArguments      #-}</span>
<a name="line-5"></a><span class='hs-comment'>{-# LANGUAGE RecursiveDo         #-}</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-comment'>{-# OPTIONS_GHC -Wno-incomplete-uni-patterns   #-}</span>
<a name="line-8"></a><span class='hs-comment'>{-# OPTIONS_GHC -Wno-incomplete-record-updates #-}</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-comment'>{-
<a name="line-11"></a>(c) The University of Glasgow 2006
<a name="line-12"></a>(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
<a name="line-13"></a>-}</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-comment'>-- | Type subsumption and unification</span>
<a name="line-16"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Tc.Utils.Unify</span> <span class='hs-layout'>(</span>
<a name="line-17"></a>  <span class='hs-comment'>-- Full-blown subsumption</span>
<a name="line-18"></a>  <span class='hs-varid'>tcWrapResult</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcWrapResultO</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcWrapResultMono</span><span class='hs-layout'>,</span>
<a name="line-19"></a>  <span class='hs-varid'>tcTopSkolemise</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSkolemiseScoped</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSkolemiseExpType</span><span class='hs-layout'>,</span>
<a name="line-20"></a>  <span class='hs-varid'>tcSubType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSubTypeSigma</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSubTypePat</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSubTypeDS</span><span class='hs-layout'>,</span>
<a name="line-21"></a>  <span class='hs-varid'>tcSubTypeAmbiguity</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSubMult</span><span class='hs-layout'>,</span>
<a name="line-22"></a>  <span class='hs-varid'>checkConstraints</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkTvConstraints</span><span class='hs-layout'>,</span>
<a name="line-23"></a>  <span class='hs-varid'>buildImplicationFor</span><span class='hs-layout'>,</span> <span class='hs-varid'>buildTvImplication</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitResidualTvConstraint</span><span class='hs-layout'>,</span>
<a name="line-24"></a>
<a name="line-25"></a>  <span class='hs-comment'>-- Various unifications</span>
<a name="line-26"></a>  <span class='hs-varid'>unifyType</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifyKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifyExpectedType</span><span class='hs-layout'>,</span>
<a name="line-27"></a>  <span class='hs-varid'>uType</span><span class='hs-layout'>,</span> <span class='hs-varid'>promoteTcType</span><span class='hs-layout'>,</span>
<a name="line-28"></a>  <span class='hs-varid'>swapOverTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>canSolveByUnification</span><span class='hs-layout'>,</span>
<a name="line-29"></a>
<a name="line-30"></a>  <span class='hs-comment'>--------------------------------</span>
<a name="line-31"></a>  <span class='hs-comment'>-- Holes</span>
<a name="line-32"></a>  <span class='hs-varid'>tcInfer</span><span class='hs-layout'>,</span>
<a name="line-33"></a>  <span class='hs-varid'>matchExpectedListTy</span><span class='hs-layout'>,</span>
<a name="line-34"></a>  <span class='hs-varid'>matchExpectedTyConApp</span><span class='hs-layout'>,</span>
<a name="line-35"></a>  <span class='hs-varid'>matchExpectedAppTy</span><span class='hs-layout'>,</span>
<a name="line-36"></a>  <span class='hs-varid'>matchExpectedFunTys</span><span class='hs-layout'>,</span>
<a name="line-37"></a>  <span class='hs-varid'>matchExpectedFunKind</span><span class='hs-layout'>,</span>
<a name="line-38"></a>  <span class='hs-varid'>matchActualFunTySigma</span><span class='hs-layout'>,</span> <span class='hs-varid'>matchActualFunTysRho</span><span class='hs-layout'>,</span>
<a name="line-39"></a>
<a name="line-40"></a>  <span class='hs-varid'>checkTyVarEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkTyFamEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkTypeEq</span>
<a name="line-41"></a>
<a name="line-42"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-43"></a>
<a name="line-44"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-45"></a>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-47"></a>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Hs</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCo.Rep</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCo.Ppr</span><span class='hs-layout'>(</span> <span class='hs-varid'>debugPprType</span> <span class='hs-layout'>)</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.TcMType</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Monad</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.TcType</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Env</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Type</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Coercion</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Multiplicity</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.LanguageExtensions</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>LangExt</span>
<a name="line-59"></a>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Types.Evidence</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Types.Constraint</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Types.Origin</span>
<a name="line-63"></a>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Instantiate</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCon</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Types</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name</span><span class='hs-layout'>(</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSystemName</span> <span class='hs-layout'>)</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Var</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var.Set</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var.Env</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Error</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Session</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Basic</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Bag</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.FastString</span><span class='hs-layout'>(</span> <span class='hs-varid'>fsLit</span> <span class='hs-layout'>)</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-77"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Outputable</span>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-79"></a>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Exts</span>      <span class='hs-layout'>(</span> <span class='hs-varid'>inline</span> <span class='hs-layout'>)</span>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad</span>
<a name="line-82"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.Semigroup</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>S</span> <span class='hs-layout'>(</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;&gt;</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-83"></a>
<a name="line-84"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-85"></a>*                                                                      *
<a name="line-86"></a>              matchActualFunTys
<a name="line-87"></a>*                                                                      *
<a name="line-88"></a>********************************************************************* -}</span>
<a name="line-89"></a>
<a name="line-90"></a><a name="matchActualFunTySigma"></a><span class='hs-comment'>-- | matchActualFunTySigma does looks for just one function arrow</span>
<a name="line-91"></a><span class='hs-comment'>--   returning an uninstantiated sigma-type</span>
<a name="line-92"></a><span class='hs-definition'>matchActualFunTySigma</span>
<a name="line-93"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-comment'>-- See Note [Herald for matchExpectedFunTys]</span>
<a name="line-94"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SDoc</span>                    <span class='hs-comment'>-- The thing with type TcSigmaType</span>
<a name="line-95"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Arity</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Scaled</span> <span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Total number of value args in the call, and</span>
<a name="line-96"></a>                                   <span class='hs-comment'>-- types of values args to which function has</span>
<a name="line-97"></a>                                   <span class='hs-comment'>--   been applied already (reversed)</span>
<a name="line-98"></a>                                   <span class='hs-comment'>-- Both are used only for error messages)</span>
<a name="line-99"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>                     <span class='hs-comment'>-- Type to analyse: a TcRhoType</span>
<a name="line-100"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-conid'>Scaled</span> <span class='hs-conid'>TcSigmaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcSigmaType</span><span class='hs-layout'>)</span>
<a name="line-101"></a><span class='hs-comment'>-- The /argument/ is a RhoType</span>
<a name="line-102"></a><span class='hs-comment'>-- The /result/   is an (uninstantiated) SigmaType</span>
<a name="line-103"></a><span class='hs-comment'>--</span>
<a name="line-104"></a><span class='hs-comment'>-- See Note [matchActualFunTy error handling] for the first three arguments</span>
<a name="line-105"></a>
<a name="line-106"></a><span class='hs-comment'>-- If   (wrap, arg_ty, res_ty) = matchActualFunTySigma ... fun_ty</span>
<a name="line-107"></a><span class='hs-comment'>-- then wrap :: fun_ty ~&gt; (arg_ty -&gt; res_ty)</span>
<a name="line-108"></a><span class='hs-comment'>-- and NB: res_ty is an (uninstantiated) SigmaType</span>
<a name="line-109"></a>
<a name="line-110"></a><span class='hs-definition'>matchActualFunTySigma</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>mb_thing</span> <span class='hs-varid'>err_info</span> <span class='hs-varid'>fun_ty</span>
<a name="line-111"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isRhoTy</span> <span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fun_ty</span> <span class='hs-layout'>)</span>
<a name="line-112"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>fun_ty</span>
<a name="line-113"></a>  <span class='hs-keyword'>where</span>
<a name="line-114"></a>    <span class='hs-comment'>-- Does not allocate unnecessary meta variables: if the input already is</span>
<a name="line-115"></a>    <span class='hs-comment'>-- a function, we just take it apart.  Not only is this efficient,</span>
<a name="line-116"></a>    <span class='hs-comment'>-- it's important for higher rank: the argument might be of form</span>
<a name="line-117"></a>    <span class='hs-comment'>--              (forall a. ty) -&gt; other</span>
<a name="line-118"></a>    <span class='hs-comment'>-- If allocated (fresh-meta-var1 -&gt; fresh-meta-var2) and unified, we'd</span>
<a name="line-119"></a>    <span class='hs-comment'>-- hide the forall inside a meta-variable</span>
<a name="line-120"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRhoType</span>   <span class='hs-comment'>-- The type we're processing, perhaps after</span>
<a name="line-121"></a>                      <span class='hs-comment'>-- expanding any type synonym</span>
<a name="line-122"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-conid'>Scaled</span> <span class='hs-conid'>TcSigmaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcSigmaType</span><span class='hs-layout'>)</span>
<a name="line-123"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty'</span>
<a name="line-124"></a>
<a name="line-125"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_af</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>af</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_mult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-126"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>af</span> <span class='hs-varop'>==</span> <span class='hs-conid'>VisArg</span> <span class='hs-layout'>)</span>
<a name="line-127"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>idHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-conid'>Scaled</span> <span class='hs-varid'>w</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-128"></a>
<a name="line-129"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-130"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-131"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-132"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>of</span>
<a name="line-133"></a>               <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty'</span>
<a name="line-134"></a>               <span class='hs-conid'>Flexi</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>defer</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-135"></a>
<a name="line-136"></a>       <span class='hs-comment'>-- In all other cases we bale out into ordinary unification</span>
<a name="line-137"></a>       <span class='hs-comment'>-- However unlike the meta-tyvar case, we are sure that the</span>
<a name="line-138"></a>       <span class='hs-comment'>-- number of arguments doesn't match arity of the original</span>
<a name="line-139"></a>       <span class='hs-comment'>-- type, so we can add a bit more context to the error message</span>
<a name="line-140"></a>       <span class='hs-comment'>-- (cf #7869).</span>
<a name="line-141"></a>       <span class='hs-comment'>--</span>
<a name="line-142"></a>       <span class='hs-comment'>-- It is not always an error, because specialized type may have</span>
<a name="line-143"></a>       <span class='hs-comment'>-- different arity, for example:</span>
<a name="line-144"></a>       <span class='hs-comment'>--</span>
<a name="line-145"></a>       <span class='hs-comment'>-- &gt; f1 = f2 'a'</span>
<a name="line-146"></a>       <span class='hs-comment'>-- &gt; f2 :: Monad m =&gt; m Bool</span>
<a name="line-147"></a>       <span class='hs-comment'>-- &gt; f2 = undefined</span>
<a name="line-148"></a>       <span class='hs-comment'>--</span>
<a name="line-149"></a>       <span class='hs-comment'>-- But in that case we add specialized type into error context</span>
<a name="line-150"></a>       <span class='hs-comment'>-- anyway, because it may be useful. See also #9605.</span>
<a name="line-151"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxtM</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_ctxt</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>defer</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-152"></a>
<a name="line-153"></a>    <span class='hs-comment'>------------</span>
<a name="line-154"></a>    <span class='hs-varid'>defer</span> <span class='hs-varid'>fun_ty</span>
<a name="line-155"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newOpenFlexiTyVarTy</span>
<a name="line-156"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newOpenFlexiTyVarTy</span>
<a name="line-157"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>mult</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>multiplicityTy</span>
<a name="line-158"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>unif_fun_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVisFunTy</span> <span class='hs-varid'>mult</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varid'>res_ty</span>
<a name="line-159"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>mb_thing</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>unif_fun_ty</span>
<a name="line-160"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWpCastN</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-conid'>Scaled</span> <span class='hs-varid'>mult</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-161"></a>
<a name="line-162"></a>    <span class='hs-comment'>------------</span>
<a name="line-163"></a>    <span class='hs-varid'>mk_ctxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-164"></a>    <span class='hs-varid'>mk_ctxt</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunTysMsg</span> <span class='hs-varid'>env</span> <span class='hs-varid'>herald</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>arg_tys_so_far</span><span class='hs-layout'>)</span>
<a name="line-165"></a>                                     <span class='hs-varid'>res_ty</span> <span class='hs-varid'>n_val_args_in_call</span>
<a name="line-166"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>n_val_args_in_call</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys_so_far</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>err_info</span>
<a name="line-167"></a>
<a name="line-168"></a><span class='hs-comment'>{- Note [matchActualFunTy error handling]
<a name="line-169"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-170"></a>matchActualFunTySigma is made much more complicated by the
<a name="line-171"></a>desire to produce good error messages. Consider the application
<a name="line-172"></a>    f @Int x y
<a name="line-173"></a>In GHC.Tc.Gen.Expr.tcArgs we deal with visible type arguments,
<a name="line-174"></a>and then call matchActualFunTysPart for each individual value
<a name="line-175"></a>argument. It, in turn, must instantiate any type/dictionary args,
<a name="line-176"></a>before looking for an arrow type.
<a name="line-177"></a>
<a name="line-178"></a>But if it doesn't find an arrow type, it wants to generate a message
<a name="line-179"></a>like "f is applied to two arguments but its type only has one".
<a name="line-180"></a>To do that, it needs to know about the args that tcArgs has already
<a name="line-181"></a>munched up -- hence passing in n_val_args_in_call and arg_tys_so_far;
<a name="line-182"></a>and hence also the accumulating so_far arg to 'go'.
<a name="line-183"></a>
<a name="line-184"></a>This allows us (in mk_ctxt) to construct f's /instantiated/ type,
<a name="line-185"></a>with just the values-arg arrows, which is what we really want
<a name="line-186"></a>in the error message.
<a name="line-187"></a>
<a name="line-188"></a>Ugh!
<a name="line-189"></a>-}</span>
<a name="line-190"></a>
<a name="line-191"></a><a name="matchActualFunTysRho"></a><span class='hs-comment'>-- Like 'matchExpectedFunTys', but used when you have an "actual" type,</span>
<a name="line-192"></a><span class='hs-comment'>-- for example in function application</span>
<a name="line-193"></a><span class='hs-definition'>matchActualFunTysRho</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>   <span class='hs-comment'>-- See Note [Herald for matchExpectedFunTys]</span>
<a name="line-194"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-195"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SDoc</span>  <span class='hs-comment'>-- the thing with type TcSigmaType</span>
<a name="line-196"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-197"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span>
<a name="line-198"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Scaled</span> <span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRhoType</span><span class='hs-layout'>)</span>
<a name="line-199"></a><span class='hs-comment'>-- If    matchActualFunTysRho n ty = (wrap, [t1,..,tn], res_ty)</span>
<a name="line-200"></a><span class='hs-comment'>-- then  wrap : ty ~&gt; (t1 -&gt; ... -&gt; tn -&gt; res_ty)</span>
<a name="line-201"></a><span class='hs-comment'>--       and res_ty is a RhoType</span>
<a name="line-202"></a><span class='hs-comment'>-- NB: the returned type is top-instantiated; it's a RhoType</span>
<a name="line-203"></a><span class='hs-definition'>matchActualFunTysRho</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>ct_orig</span> <span class='hs-varid'>mb_thing</span> <span class='hs-varid'>n_val_args_wanted</span> <span class='hs-varid'>fun_ty</span>
<a name="line-204"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n_val_args_wanted</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>fun_ty</span>
<a name="line-205"></a>  <span class='hs-keyword'>where</span>
<a name="line-206"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>so_far</span> <span class='hs-varid'>fun_ty</span>
<a name="line-207"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isRhoTy</span> <span class='hs-varid'>fun_ty</span><span class='hs-layout'>)</span>
<a name="line-208"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap1</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>topInstantiate</span> <span class='hs-varid'>ct_orig</span> <span class='hs-varid'>fun_ty</span>
<a name="line-209"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap2</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>so_far</span> <span class='hs-varid'>rho</span>
<a name="line-210"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap2</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>wrap1</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-211"></a>
<a name="line-212"></a>    <span class='hs-varid'>go</span> <span class='hs-num'>0</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>fun_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>idHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_ty</span><span class='hs-layout'>)</span>
<a name="line-213"></a>
<a name="line-214"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>so_far</span> <span class='hs-varid'>fun_ty</span>
<a name="line-215"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap_fun1</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchActualFunTySigma</span>
<a name="line-216"></a>                                                 <span class='hs-varid'>herald</span> <span class='hs-varid'>mb_thing</span>
<a name="line-217"></a>                                                 <span class='hs-layout'>(</span><span class='hs-varid'>n_val_args_wanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>so_far</span><span class='hs-layout'>)</span>
<a name="line-218"></a>                                                 <span class='hs-varid'>fun_ty</span>
<a name="line-219"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap_res</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_ty1</span><span class='hs-conop'>:</span><span class='hs-varid'>so_far</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty1</span>
<a name="line-220"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>wrap_fun2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWpFun</span> <span class='hs-varid'>idHsWrapper</span> <span class='hs-varid'>wrap_res</span> <span class='hs-varid'>arg_ty1</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>doc</span>
<a name="line-221"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap_fun2</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>wrap_fun1</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_ty1</span><span class='hs-conop'>:</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-222"></a>      <span class='hs-keyword'>where</span>
<a name="line-223"></a>        <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"When inferring the argument type of a function with type"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-224"></a>              <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fun_ty</span><span class='hs-layout'>)</span>
<a name="line-225"></a>
<a name="line-226"></a>
<a name="line-227"></a><span class='hs-comment'>{-
<a name="line-228"></a>************************************************************************
<a name="line-229"></a>*                                                                      *
<a name="line-230"></a>             matchExpected functions
<a name="line-231"></a>*                                                                      *
<a name="line-232"></a>************************************************************************
<a name="line-233"></a>
<a name="line-234"></a>Note [Herald for matchExpectedFunTys]
<a name="line-235"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-236"></a>The 'herald' always looks like:
<a name="line-237"></a>   "The equation(s) for 'f' have"
<a name="line-238"></a>   "The abstraction (\x.e) takes"
<a name="line-239"></a>   "The section (+ x) expects"
<a name="line-240"></a>   "The function 'f' is applied to"
<a name="line-241"></a>
<a name="line-242"></a>This is used to construct a message of form
<a name="line-243"></a>
<a name="line-244"></a>   The abstraction `\Just 1 -&gt; ...' takes two arguments
<a name="line-245"></a>   but its type `Maybe a -&gt; a' has only one
<a name="line-246"></a>
<a name="line-247"></a>   The equation(s) for `f' have two arguments
<a name="line-248"></a>   but its type `Maybe a -&gt; a' has only one
<a name="line-249"></a>
<a name="line-250"></a>   The section `(f 3)' requires 'f' to take two arguments
<a name="line-251"></a>   but its type `Int -&gt; Int' has only one
<a name="line-252"></a>
<a name="line-253"></a>   The function 'f' is applied to two arguments
<a name="line-254"></a>   but its type `Int -&gt; Int' has only one
<a name="line-255"></a>
<a name="line-256"></a>When visible type applications (e.g., `f @Int 1 2`, as in #13902) enter the
<a name="line-257"></a>picture, we have a choice in deciding whether to count the type applications as
<a name="line-258"></a>proper arguments:
<a name="line-259"></a>
<a name="line-260"></a>   The function 'f' is applied to one visible type argument
<a name="line-261"></a>     and two value arguments
<a name="line-262"></a>   but its type `forall a. a -&gt; a` has only one visible type argument
<a name="line-263"></a>     and one value argument
<a name="line-264"></a>
<a name="line-265"></a>Or whether to include the type applications as part of the herald itself:
<a name="line-266"></a>
<a name="line-267"></a>   The expression 'f @Int' is applied to two arguments
<a name="line-268"></a>   but its type `Int -&gt; Int` has only one
<a name="line-269"></a>
<a name="line-270"></a>The latter is easier to implement and is arguably easier to understand, so we
<a name="line-271"></a>choose to implement that option.
<a name="line-272"></a>
<a name="line-273"></a>Note [matchExpectedFunTys]
<a name="line-274"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-275"></a>matchExpectedFunTys checks that a sigma has the form
<a name="line-276"></a>of an n-ary function.  It passes the decomposed type to the
<a name="line-277"></a>thing_inside, and returns a wrapper to coerce between the two types
<a name="line-278"></a>
<a name="line-279"></a>It's used wherever a language construct must have a functional type,
<a name="line-280"></a>namely:
<a name="line-281"></a>        A lambda expression
<a name="line-282"></a>        A function definition
<a name="line-283"></a>     An operator section
<a name="line-284"></a>
<a name="line-285"></a>This function must be written CPS'd because it needs to fill in the
<a name="line-286"></a>ExpTypes produced for arguments before it can fill in the ExpType
<a name="line-287"></a>passed in.
<a name="line-288"></a>
<a name="line-289"></a>-}</span>
<a name="line-290"></a>
<a name="line-291"></a><a name="matchExpectedFunTys"></a><span class='hs-comment'>-- Use this one when you have an "expected" type.</span>
<a name="line-292"></a><span class='hs-comment'>-- This function skolemises at each polytype.</span>
<a name="line-293"></a><span class='hs-definition'>matchExpectedFunTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span><span class='hs-varop'>.</span>
<a name="line-294"></a>                       <span class='hs-conid'>SDoc</span>   <span class='hs-comment'>-- See Note [Herald for matchExpectedFunTys]</span>
<a name="line-295"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-296"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-297"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span>      <span class='hs-comment'>-- Skolemised</span>
<a name="line-298"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Scaled</span> <span class='hs-conid'>ExpSigmaType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-299"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-300"></a><span class='hs-comment'>-- If    matchExpectedFunTys n ty = (_, wrap)</span>
<a name="line-301"></a><span class='hs-comment'>-- then  wrap : (t1 -&gt; ... -&gt; tn -&gt; ty_r) ~&gt; ty,</span>
<a name="line-302"></a><span class='hs-comment'>--   where [t1, ..., tn], ty_r are passed to the thing_inside</span>
<a name="line-303"></a><span class='hs-definition'>matchExpectedFunTys</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>ctx</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-304"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>orig_ty</span> <span class='hs-keyword'>of</span>
<a name="line-305"></a>      <span class='hs-conid'>Check</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>ty</span>
<a name="line-306"></a>      <span class='hs-keyword'>_</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>defer</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>orig_ty</span>
<a name="line-307"></a>  <span class='hs-keyword'>where</span>
<a name="line-308"></a>    <span class='hs-comment'>-- Skolemise any foralls /before/ the zero-arg case</span>
<a name="line-309"></a>    <span class='hs-comment'>-- so that we guarantee to return a rho-type</span>
<a name="line-310"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span>
<a name="line-311"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitSigmaTy</span> <span class='hs-varid'>ty</span>
<a name="line-312"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span>
<a name="line-313"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap_gen</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap_res</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTopSkolemise</span> <span class='hs-varid'>ctx</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-314"></a>                                               <span class='hs-varid'>go</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty'</span>
<a name="line-315"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap_gen</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>wrap_res</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-316"></a>
<a name="line-317"></a>    <span class='hs-comment'>-- No more args; do this /before/ tcView, so</span>
<a name="line-318"></a>    <span class='hs-comment'>-- that we do not unnecessarily unwrap synonyms</span>
<a name="line-319"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-num'>0</span> <span class='hs-varid'>rho_ty</span>
<a name="line-320"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>acc_arg_tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCheckExpType</span> <span class='hs-varid'>rho_ty</span><span class='hs-layout'>)</span>
<a name="line-321"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>idHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-322"></a>
<a name="line-323"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span>
<a name="line-324"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty'</span>
<a name="line-325"></a>
<a name="line-326"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_mult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mult</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_af</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>af</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-327"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>af</span> <span class='hs-varop'>==</span> <span class='hs-conid'>VisArg</span> <span class='hs-layout'>)</span>
<a name="line-328"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap_res</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>Scaled</span> <span class='hs-varid'>mult</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkCheckExpType</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>acc_arg_tys</span><span class='hs-layout'>)</span>
<a name="line-329"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-330"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fun_wrap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWpFun</span> <span class='hs-varid'>idHsWrapper</span> <span class='hs-varid'>wrap_res</span> <span class='hs-layout'>(</span><span class='hs-conid'>Scaled</span> <span class='hs-varid'>mult</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>doc</span>
<a name="line-331"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>fun_wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-332"></a>      <span class='hs-keyword'>where</span>
<a name="line-333"></a>        <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"When inferring the argument type of a function with type"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-334"></a>              <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_ty</span><span class='hs-layout'>)</span>
<a name="line-335"></a>
<a name="line-336"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-337"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-338"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-339"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>of</span>
<a name="line-340"></a>               <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty'</span>
<a name="line-341"></a>               <span class='hs-conid'>Flexi</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>defer</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCheckExpType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-342"></a>
<a name="line-343"></a>       <span class='hs-comment'>-- In all other cases we bale out into ordinary unification</span>
<a name="line-344"></a>       <span class='hs-comment'>-- However unlike the meta-tyvar case, we are sure that the</span>
<a name="line-345"></a>       <span class='hs-comment'>-- number of arguments doesn't match arity of the original</span>
<a name="line-346"></a>       <span class='hs-comment'>-- type, so we can add a bit more context to the error message</span>
<a name="line-347"></a>       <span class='hs-comment'>-- (cf #7869).</span>
<a name="line-348"></a>       <span class='hs-comment'>--</span>
<a name="line-349"></a>       <span class='hs-comment'>-- It is not always an error, because specialized type may have</span>
<a name="line-350"></a>       <span class='hs-comment'>-- different arity, for example:</span>
<a name="line-351"></a>       <span class='hs-comment'>--</span>
<a name="line-352"></a>       <span class='hs-comment'>-- &gt; f1 = f2 'a'</span>
<a name="line-353"></a>       <span class='hs-comment'>-- &gt; f2 :: Monad m =&gt; m Bool</span>
<a name="line-354"></a>       <span class='hs-comment'>-- &gt; f2 = undefined</span>
<a name="line-355"></a>       <span class='hs-comment'>--</span>
<a name="line-356"></a>       <span class='hs-comment'>-- But in that case we add specialized type into error context</span>
<a name="line-357"></a>       <span class='hs-comment'>-- anyway, because it may be useful. See also #9605.</span>
<a name="line-358"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxtM</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_ctxt</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-359"></a>                          <span class='hs-varid'>defer</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCheckExpType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-360"></a>
<a name="line-361"></a>    <span class='hs-comment'>------------</span>
<a name="line-362"></a>    <span class='hs-varid'>defer</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Scaled</span> <span class='hs-conid'>ExpSigmaType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-363"></a>    <span class='hs-varid'>defer</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varid'>n</span> <span class='hs-varid'>fun_ty</span>
<a name="line-364"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>more_arg_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>replicateM</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkScaled</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>multiplicityTy</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>newInferExpType</span><span class='hs-layout'>)</span>
<a name="line-365"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>res_ty</span>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newInferExpType</span>
<a name="line-366"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>result</span>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>acc_arg_tys</span> <span class='hs-varop'>++</span> <span class='hs-varid'>more_arg_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-367"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>more_arg_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>Scaled</span> <span class='hs-varid'>m</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Scaled</span> <span class='hs-varid'>m</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>readExpType</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-varid'>more_arg_tys</span>
<a name="line-368"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>res_ty</span>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readExpType</span> <span class='hs-varid'>res_ty</span>
<a name="line-369"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>unif_fun_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVisFunTys</span> <span class='hs-varid'>more_arg_tys</span> <span class='hs-varid'>res_ty</span>
<a name="line-370"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSubType</span> <span class='hs-conid'>AppOrigin</span> <span class='hs-varid'>ctx</span> <span class='hs-varid'>unif_fun_ty</span> <span class='hs-varid'>fun_ty</span>
<a name="line-371"></a>                         <span class='hs-comment'>-- Not a good origin at all :-(</span>
<a name="line-372"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-373"></a>
<a name="line-374"></a>    <span class='hs-comment'>------------</span>
<a name="line-375"></a>    <span class='hs-varid'>mk_ctxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Scaled</span> <span class='hs-conid'>ExpSigmaType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-376"></a>    <span class='hs-varid'>mk_ctxt</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>env</span>
<a name="line-377"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunTysMsg</span> <span class='hs-varid'>env</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>arg_tys'</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>arity</span>
<a name="line-378"></a>      <span class='hs-keyword'>where</span>
<a name="line-379"></a>        <span class='hs-varid'>arg_tys'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>Scaled</span> <span class='hs-varid'>u</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Scaled</span> <span class='hs-varid'>u</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkingExpType</span> <span class='hs-str'>"matchExpectedFunTys"</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-380"></a>                   <span class='hs-varid'>reverse</span> <span class='hs-varid'>arg_tys</span>
<a name="line-381"></a>            <span class='hs-comment'>-- this is safe b/c we're called from "go"</span>
<a name="line-382"></a>
<a name="line-383"></a><a name="mkFunTysMsg"></a><span class='hs-definition'>mkFunTysMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Scaled</span> <span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-384"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-385"></a><span class='hs-definition'>mkFunTysMsg</span> <span class='hs-varid'>env</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>n_val_args_in_call</span>
<a name="line-386"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>env</span> <span class='hs-varop'>$</span>
<a name="line-387"></a>                            <span class='hs-varid'>mkVisFunTys</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>res_ty</span>
<a name="line-388"></a>
<a name="line-389"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>all_arg_tys</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitFunTys</span> <span class='hs-varid'>fun_rho</span>
<a name="line-390"></a>             <span class='hs-varid'>n_fun_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>all_arg_tys</span>
<a name="line-391"></a>
<a name="line-392"></a>             <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n_val_args_in_call</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>n_fun_args</span>  <span class='hs-comment'>-- Enough args, in the end</span>
<a name="line-393"></a>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"In the result of a function call"</span>
<a name="line-394"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-395"></a>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>full_herald</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span><span class='hs-layout'>)</span>
<a name="line-396"></a>                      <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"but its type"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprType</span> <span class='hs-varid'>fun_rho</span><span class='hs-layout'>)</span>
<a name="line-397"></a>                             <span class='hs-layout'>,</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>n_fun_args</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>text</span> <span class='hs-str'>"has none"</span>
<a name="line-398"></a>                               <span class='hs-keyword'>else</span> <span class='hs-varid'>text</span> <span class='hs-str'>"has only"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>speakN</span> <span class='hs-varid'>n_fun_args</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-399"></a>
<a name="line-400"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-401"></a> <span class='hs-keyword'>where</span>
<a name="line-402"></a>  <span class='hs-varid'>full_herald</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>herald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>speakNOf</span> <span class='hs-varid'>n_val_args_in_call</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"value argument"</span><span class='hs-layout'>)</span>
<a name="line-403"></a>
<a name="line-404"></a><a name="matchExpectedListTy"></a><span class='hs-comment'>----------------------</span>
<a name="line-405"></a><span class='hs-definition'>matchExpectedListTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercionN</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRhoType</span><span class='hs-layout'>)</span>
<a name="line-406"></a><span class='hs-comment'>-- Special case for lists</span>
<a name="line-407"></a><span class='hs-definition'>matchExpectedListTy</span> <span class='hs-varid'>exp_ty</span>
<a name="line-408"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>elt_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedTyConApp</span> <span class='hs-varid'>listTyCon</span> <span class='hs-varid'>exp_ty</span>
<a name="line-409"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-410"></a>
<a name="line-411"></a><a name="matchExpectedTyConApp"></a><span class='hs-comment'>---------------------</span>
<a name="line-412"></a><span class='hs-definition'>matchExpectedTyConApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span>                <span class='hs-comment'>-- T :: forall kv1 ... kvm. k1 -&gt; ... -&gt; kn -&gt; *</span>
<a name="line-413"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>            <span class='hs-comment'>-- orig_ty</span>
<a name="line-414"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercionN</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- T k1 k2 k3 a b c ~N orig_ty</span>
<a name="line-415"></a>                              <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Element types, k1 k2 k3 a b c</span>
<a name="line-416"></a>
<a name="line-417"></a><span class='hs-comment'>-- It's used for wired-in tycons, so we call checkWiredInTyCon</span>
<a name="line-418"></a><span class='hs-comment'>-- Precondition: never called with FunTyCon</span>
<a name="line-419"></a><span class='hs-comment'>-- Precondition: input type :: *</span>
<a name="line-420"></a><span class='hs-comment'>-- Postcondition: (T k1 k2 k3 a b c) is well-kinded</span>
<a name="line-421"></a>
<a name="line-422"></a><span class='hs-definition'>matchExpectedTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>orig_ty</span>
<a name="line-423"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>isFunTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>go</span> <span class='hs-varid'>orig_ty</span>
<a name="line-424"></a>  <span class='hs-keyword'>where</span>
<a name="line-425"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-426"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span>
<a name="line-427"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty'</span>
<a name="line-428"></a>
<a name="line-429"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-430"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tycon</span>  <span class='hs-comment'>-- Common case</span>
<a name="line-431"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcNomReflCo</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-432"></a>
<a name="line-433"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-434"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-435"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-436"></a>            <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>of</span>
<a name="line-437"></a>                <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-438"></a>                <span class='hs-conid'>Flexi</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>defer</span> <span class='hs-layout'>}</span>
<a name="line-439"></a>
<a name="line-440"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer</span>
<a name="line-441"></a>
<a name="line-442"></a>    <span class='hs-comment'>-- If the common case does not occur, instantiate a template</span>
<a name="line-443"></a>    <span class='hs-comment'>-- T k1 .. kn t1 .. tm, and unify with the original type</span>
<a name="line-444"></a>    <span class='hs-comment'>-- Doing it this way ensures that the types we return are</span>
<a name="line-445"></a>    <span class='hs-comment'>-- kind-compatible with T.  For example, suppose we have</span>
<a name="line-446"></a>    <span class='hs-comment'>--       matchExpectedTyConApp T (f Maybe)</span>
<a name="line-447"></a>    <span class='hs-comment'>-- where data T a = MkT a</span>
<a name="line-448"></a>    <span class='hs-comment'>-- Then we don't want to instantiate T's data constructors with</span>
<a name="line-449"></a>    <span class='hs-comment'>--    (a::*) ~ Maybe</span>
<a name="line-450"></a>    <span class='hs-comment'>-- because that'll make types that are utterly ill-kinded.</span>
<a name="line-451"></a>    <span class='hs-comment'>-- This happened in #7368</span>
<a name="line-452"></a>    <span class='hs-varid'>defer</span>
<a name="line-453"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-454"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"matchExpectedTyConApp"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>arg_tvs</span><span class='hs-layout'>)</span>
<a name="line-455"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>arg_tvs</span>
<a name="line-456"></a>                 <span class='hs-varid'>tc_template</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span>
<a name="line-457"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>tc_template</span> <span class='hs-varid'>orig_ty</span>
<a name="line-458"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-459"></a>
<a name="line-460"></a><a name="matchExpectedAppTy"></a><span class='hs-comment'>----------------------</span>
<a name="line-461"></a><span class='hs-definition'>matchExpectedAppTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRhoType</span>                         <span class='hs-comment'>-- orig_ty</span>
<a name="line-462"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span>                   <span class='hs-comment'>-- m a ~N orig_ty</span>
<a name="line-463"></a>                           <span class='hs-layout'>(</span><span class='hs-conid'>TcSigmaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcSigmaType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Returns m, a</span>
<a name="line-464"></a><span class='hs-comment'>-- If the incoming type is a mutable type variable of kind k, then</span>
<a name="line-465"></a><span class='hs-comment'>-- matchExpectedAppTy returns a new type variable (m: * -&gt; k); note the *.</span>
<a name="line-466"></a>
<a name="line-467"></a><span class='hs-definition'>matchExpectedAppTy</span> <span class='hs-varid'>orig_ty</span>
<a name="line-468"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>orig_ty</span>
<a name="line-469"></a>  <span class='hs-keyword'>where</span>
<a name="line-470"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-471"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty'</span>
<a name="line-472"></a>
<a name="line-473"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitAppTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-474"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcNomReflCo</span> <span class='hs-varid'>orig_ty</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-475"></a>
<a name="line-476"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-477"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-478"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-479"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>of</span>
<a name="line-480"></a>               <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-481"></a>               <span class='hs-conid'>Flexi</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>defer</span> <span class='hs-layout'>}</span>
<a name="line-482"></a>
<a name="line-483"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer</span>
<a name="line-484"></a>
<a name="line-485"></a>    <span class='hs-comment'>-- Defer splitting by generating an equality constraint</span>
<a name="line-486"></a>    <span class='hs-varid'>defer</span>
<a name="line-487"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>kind1</span>
<a name="line-488"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>kind2</span>
<a name="line-489"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>orig_ty</span>
<a name="line-490"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-491"></a>
<a name="line-492"></a>    <span class='hs-varid'>orig_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTypeKind</span> <span class='hs-varid'>orig_ty</span>
<a name="line-493"></a>    <span class='hs-varid'>kind1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVisFunTyMany</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>orig_kind</span>
<a name="line-494"></a>    <span class='hs-varid'>kind2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftedTypeKind</span>    <span class='hs-comment'>-- m :: * -&gt; k</span>
<a name="line-495"></a>                              <span class='hs-comment'>-- arg type :: *</span>
<a name="line-496"></a>
<a name="line-497"></a><span class='hs-comment'>{-
<a name="line-498"></a>************************************************************************
<a name="line-499"></a>*                                                                      *
<a name="line-500"></a>                Subsumption checking
<a name="line-501"></a>*                                                                      *
<a name="line-502"></a>************************************************************************
<a name="line-503"></a>
<a name="line-504"></a>Note [Subsumption checking: tcSubType]
<a name="line-505"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-506"></a>All the tcSubType calls have the form
<a name="line-507"></a>                tcSubType actual_ty expected_ty
<a name="line-508"></a>which checks
<a name="line-509"></a>                actual_ty &lt;= expected_ty
<a name="line-510"></a>
<a name="line-511"></a>That is, that a value of type actual_ty is acceptable in
<a name="line-512"></a>a place expecting a value of type expected_ty.  I.e. that
<a name="line-513"></a>
<a name="line-514"></a>    actual ty   is more polymorphic than   expected_ty
<a name="line-515"></a>
<a name="line-516"></a>It returns a wrapper function
<a name="line-517"></a>        co_fn :: actual_ty ~ expected_ty
<a name="line-518"></a>which takes an HsExpr of type actual_ty into one of type
<a name="line-519"></a>expected_ty.
<a name="line-520"></a>
<a name="line-521"></a>Note [Ambiguity check and deep subsumption]
<a name="line-522"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-523"></a>Consider
<a name="line-524"></a>   f :: (forall b. Eq b =&gt; a -&gt; a) -&gt; Int
<a name="line-525"></a>
<a name="line-526"></a>Does `f` have an ambiguous type?   The ambiguity check usually checks
<a name="line-527"></a>that this definition of f' would typecheck, where f' has the exact same
<a name="line-528"></a>type as f:
<a name="line-529"></a>   f' :: (forall b. Eq b =&gt; a -&gt; a) -&gt; Intp
<a name="line-530"></a>   f' = f
<a name="line-531"></a>
<a name="line-532"></a>This will be /rejected/ with DeepSubsumption but /accepted/ with
<a name="line-533"></a>ShallowSubsumption.  On the other hand, this eta-expanded version f''
<a name="line-534"></a>would be rejected both ways:
<a name="line-535"></a>   f'' :: (forall b. Eq b =&gt; a -&gt; a) -&gt; Intp
<a name="line-536"></a>   f'' x = f x
<a name="line-537"></a>
<a name="line-538"></a>This is squishy in the same way as other examples in GHC.Tc.Validity
<a name="line-539"></a>Note [The squishiness of the ambiguity check]
<a name="line-540"></a>
<a name="line-541"></a>The situation in June 2022.  Since we have SimpleSubsumption at the moment,
<a name="line-542"></a>we don't want introduce new breakage if you add -XDeepSubsumption, by
<a name="line-543"></a>rejecting types as ambiguous that weren't ambiguous before.  So, as a
<a name="line-544"></a>holding decision, we /always/ use SimpleSubsumption for the ambiguity check
<a name="line-545"></a>(erring on the side accepting more programs). Hence tcSubTypeAmbiguity.
<a name="line-546"></a>-}</span>
<a name="line-547"></a>
<a name="line-548"></a>
<a name="line-549"></a>
<a name="line-550"></a><a name="tcWrapResult"></a><span class='hs-comment'>-----------------</span>
<a name="line-551"></a><span class='hs-comment'>-- tcWrapResult needs both un-type-checked (for origins and error messages)</span>
<a name="line-552"></a><span class='hs-comment'>-- and type-checked (for wrapping) expressions</span>
<a name="line-553"></a><span class='hs-definition'>tcWrapResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcTc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span>
<a name="line-554"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcTc</span><span class='hs-layout'>)</span>
<a name="line-555"></a><span class='hs-definition'>tcWrapResult</span> <span class='hs-varid'>rn_expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcWrapResultO</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprCtOrigin</span> <span class='hs-varid'>rn_expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>rn_expr</span>
<a name="line-556"></a>
<a name="line-557"></a><a name="tcWrapResultO"></a><span class='hs-definition'>tcWrapResultO</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcTc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span>
<a name="line-558"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcTc</span><span class='hs-layout'>)</span>
<a name="line-559"></a><span class='hs-definition'>tcWrapResultO</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>rn_expr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>actual_ty</span> <span class='hs-varid'>res_ty</span>
<a name="line-560"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcWrapResult"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Actual:  "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>actual_ty</span>
<a name="line-561"></a>                                      <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Expected:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-562"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSubTypeNC</span> <span class='hs-varid'>orig</span> <span class='hs-conid'>GenSigCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rn_expr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>actual_ty</span> <span class='hs-varid'>res_ty</span>
<a name="line-563"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrap</span> <span class='hs-varid'>wrap</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-564"></a>
<a name="line-565"></a><a name="tcWrapResultMono"></a><span class='hs-definition'>tcWrapResultMono</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcTc</span>
<a name="line-566"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>   <span class='hs-comment'>-- Actual -- a rho-type not a sigma-type</span>
<a name="line-567"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span>  <span class='hs-comment'>-- Expected</span>
<a name="line-568"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcTc</span><span class='hs-layout'>)</span>
<a name="line-569"></a><span class='hs-comment'>-- A version of tcWrapResult to use when the actual type is a</span>
<a name="line-570"></a><span class='hs-comment'>-- rho-type, so nothing to instantiate; just go straight to unify.</span>
<a name="line-571"></a><span class='hs-comment'>-- It means we don't need to pass in a CtOrigin</span>
<a name="line-572"></a><span class='hs-definition'>tcWrapResultMono</span> <span class='hs-varid'>rn_expr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>act_ty</span> <span class='hs-varid'>res_ty</span>
<a name="line-573"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isRhoTy</span> <span class='hs-varid'>act_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>act_ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rn_expr</span> <span class='hs-layout'>)</span>
<a name="line-574"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyExpectedType</span> <span class='hs-varid'>rn_expr</span> <span class='hs-varid'>act_ty</span> <span class='hs-varid'>res_ty</span>
<a name="line-575"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-576"></a>
<a name="line-577"></a><a name="unifyExpectedType"></a><span class='hs-definition'>unifyExpectedType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcRn</span>
<a name="line-578"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>   <span class='hs-comment'>-- Actual -- a rho-type not a sigma-type</span>
<a name="line-579"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span>  <span class='hs-comment'>-- Expected</span>
<a name="line-580"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcCoercionN</span>
<a name="line-581"></a><span class='hs-definition'>unifyExpectedType</span> <span class='hs-varid'>rn_expr</span> <span class='hs-varid'>act_ty</span> <span class='hs-varid'>exp_ty</span>
<a name="line-582"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>exp_ty</span> <span class='hs-keyword'>of</span>
<a name="line-583"></a>      <span class='hs-conid'>Infer</span> <span class='hs-varid'>inf_res</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fillInferResult</span> <span class='hs-varid'>act_ty</span> <span class='hs-varid'>inf_res</span>
<a name="line-584"></a>      <span class='hs-conid'>Check</span> <span class='hs-varid'>exp_ty</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unifyType</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rn_expr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>act_ty</span> <span class='hs-varid'>exp_ty</span>
<a name="line-585"></a>
<a name="line-586"></a><a name="tcSubTypePat"></a><span class='hs-comment'>------------------------</span>
<a name="line-587"></a><span class='hs-definition'>tcSubTypePat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-588"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-589"></a><span class='hs-comment'>-- Used in patterns; polarity is backwards compared</span>
<a name="line-590"></a><span class='hs-comment'>--   to tcSubType</span>
<a name="line-591"></a><span class='hs-comment'>-- If wrap = tc_sub_type_et t1 t2</span>
<a name="line-592"></a><span class='hs-comment'>--    =&gt; wrap :: t1 ~&gt; t2</span>
<a name="line-593"></a><span class='hs-definition'>tcSubTypePat</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>Check</span> <span class='hs-varid'>ty_actual</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty_expected</span>
<a name="line-594"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-595"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_sub_type</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>unifyTypeET</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span> <span class='hs-layout'>}</span>
<a name="line-596"></a>
<a name="line-597"></a><span class='hs-definition'>tcSubTypePat</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Infer</span> <span class='hs-varid'>inf_res</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty_expected</span>
<a name="line-598"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fillInferResult</span> <span class='hs-varid'>ty_expected</span> <span class='hs-varid'>inf_res</span>
<a name="line-599"></a>               <span class='hs-comment'>-- In patterns we do not instantatiate</span>
<a name="line-600"></a>
<a name="line-601"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWpCastN</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-602"></a>
<a name="line-603"></a><a name="tcSubType"></a><span class='hs-comment'>---------------</span>
<a name="line-604"></a><span class='hs-definition'>tcSubType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-605"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span>  <span class='hs-comment'>-- Actual</span>
<a name="line-606"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span>   <span class='hs-comment'>-- Expected</span>
<a name="line-607"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-608"></a><span class='hs-comment'>-- Checks that 'actual' is more polymorphic than 'expected'</span>
<a name="line-609"></a><span class='hs-definition'>tcSubType</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-610"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addSubTypeCtxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span> <span class='hs-varop'>$</span>
<a name="line-611"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcSubType"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprUserTypeCtxt</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_actual</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_expected</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-612"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcSubTypeNC</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span> <span class='hs-layout'>}</span>
<a name="line-613"></a>
<a name="line-614"></a><a name="tcSubTypeDS"></a><span class='hs-comment'>---------------</span>
<a name="line-615"></a><span class='hs-definition'>tcSubTypeDS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcRn</span>
<a name="line-616"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>   <span class='hs-comment'>-- Actual -- a rho-type not a sigma-type</span>
<a name="line-617"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span>  <span class='hs-comment'>-- Expected</span>
<a name="line-618"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-619"></a><span class='hs-comment'>-- Similar signature to unifyExpectedType; does deep subsumption</span>
<a name="line-620"></a><span class='hs-comment'>-- Only one call site, in GHC.Tc.Gen.App.tcApp</span>
<a name="line-621"></a><span class='hs-definition'>tcSubTypeDS</span> <span class='hs-varid'>rn_expr</span> <span class='hs-varid'>act_rho</span> <span class='hs-varid'>res_ty</span>
<a name="line-622"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyword'>of</span>
<a name="line-623"></a>      <span class='hs-conid'>Check</span> <span class='hs-varid'>exp_rho</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-624"></a>                          <span class='hs-layout'>;</span> <span class='hs-varid'>tc_sub_type_deep</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>unifyType</span> <span class='hs-varid'>m_thing</span><span class='hs-layout'>)</span> <span class='hs-varid'>orig</span>
<a name="line-625"></a>                                        <span class='hs-conid'>GenSigCtxt</span> <span class='hs-varid'>act_rho</span> <span class='hs-varid'>exp_rho</span>
<a name="line-626"></a>                          <span class='hs-layout'>}</span>
<a name="line-627"></a>
<a name="line-628"></a>      <span class='hs-conid'>Infer</span> <span class='hs-varid'>inf_res</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fillInferResult</span> <span class='hs-varid'>act_rho</span> <span class='hs-varid'>inf_res</span>
<a name="line-629"></a>                          <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWpCastN</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-630"></a>  <span class='hs-keyword'>where</span>
<a name="line-631"></a>    <span class='hs-varid'>orig</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprCtOrigin</span> <span class='hs-varid'>rn_expr</span>
<a name="line-632"></a>    <span class='hs-varid'>m_thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rn_expr</span><span class='hs-layout'>)</span>
<a name="line-633"></a>
<a name="line-634"></a><a name="tcSubTypeNC"></a><span class='hs-comment'>---------------</span>
<a name="line-635"></a><span class='hs-definition'>tcSubTypeNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span>          <span class='hs-comment'>-- ^ Used when instantiating</span>
<a name="line-636"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span>      <span class='hs-comment'>-- ^ Used when skolemising</span>
<a name="line-637"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SDoc</span>        <span class='hs-comment'>-- ^ The expression that has type 'actual' (if known)</span>
<a name="line-638"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span>       <span class='hs-comment'>-- ^ Actual type</span>
<a name="line-639"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span>        <span class='hs-comment'>-- ^ Expected type</span>
<a name="line-640"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-641"></a><span class='hs-definition'>tcSubTypeNC</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>m_thing</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>res_ty</span>
<a name="line-642"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyword'>of</span>
<a name="line-643"></a>      <span class='hs-conid'>Check</span> <span class='hs-varid'>ty_expected</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-644"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>tc_sub_type</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>unifyType</span> <span class='hs-varid'>m_thing</span><span class='hs-layout'>)</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span>
<a name="line-645"></a>                                            <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span> <span class='hs-layout'>}</span>
<a name="line-646"></a>
<a name="line-647"></a>      <span class='hs-conid'>Infer</span> <span class='hs-varid'>inf_res</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>topInstantiate</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ty_actual</span>
<a name="line-648"></a>                                   <span class='hs-comment'>-- See Note [Instantiation of InferResult]</span>
<a name="line-649"></a>                          <span class='hs-layout'>;</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fillInferResult</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>inf_res</span>
<a name="line-650"></a>                          <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWpCastN</span> <span class='hs-varid'>co</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-651"></a>
<a name="line-652"></a><a name="tcSubTypeSigma"></a><span class='hs-comment'>---------------</span>
<a name="line-653"></a><span class='hs-definition'>tcSubTypeSigma</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span>       <span class='hs-comment'>-- where did the actual type arise / why are we</span>
<a name="line-654"></a>                                 <span class='hs-comment'>-- doing this subtype check?</span>
<a name="line-655"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span>   <span class='hs-comment'>-- where did the expected type arise?</span>
<a name="line-656"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-657"></a><span class='hs-comment'>-- External entry point, but no ExpTypes on either side</span>
<a name="line-658"></a><span class='hs-comment'>-- Checks that actual &lt;= expected</span>
<a name="line-659"></a><span class='hs-comment'>-- Returns HsWrapper :: actual ~ expected</span>
<a name="line-660"></a><span class='hs-definition'>tcSubTypeSigma</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-661"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-662"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_sub_type</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>unifyType</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-663"></a>       <span class='hs-layout'>}</span>
<a name="line-664"></a>
<a name="line-665"></a><a name="tcSubTypeAmbiguity"></a><span class='hs-comment'>---------------</span>
<a name="line-666"></a><span class='hs-definition'>tcSubTypeAmbiguity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span>   <span class='hs-comment'>-- Where did this type arise</span>
<a name="line-667"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-668"></a><span class='hs-comment'>-- See Note [Ambiguity check and deep subsumption]</span>
<a name="line-669"></a><span class='hs-definition'>tcSubTypeAmbiguity</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-670"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-671"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_sub_type_shallow</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>unifyType</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-672"></a>                        <span class='hs-layout'>(</span><span class='hs-conid'>AmbiguityCheckOrigin</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-673"></a>                        <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-674"></a>       <span class='hs-layout'>}</span>
<a name="line-675"></a>
<a name="line-676"></a><a name="addSubTypeCtxt"></a><span class='hs-comment'>---------------</span>
<a name="line-677"></a><span class='hs-definition'>addSubTypeCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-678"></a><span class='hs-definition'>addSubTypeCtxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span> <span class='hs-varid'>thing_inside</span>
<a name="line-679"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isRhoTy</span> <span class='hs-varid'>ty_actual</span>        <span class='hs-comment'>-- If there is no polymorphism involved, the</span>
<a name="line-680"></a> <span class='hs-layout'>,</span> <span class='hs-varid'>isRhoExpTy</span> <span class='hs-varid'>ty_expected</span>   <span class='hs-comment'>-- TypeEqOrigin stuff (added by the _NC functions)</span>
<a name="line-681"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thing_inside</span>             <span class='hs-comment'>-- gives enough context by itself</span>
<a name="line-682"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-683"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxtM</span> <span class='hs-varid'>mk_msg</span> <span class='hs-varid'>thing_inside</span>
<a name="line-684"></a>  <span class='hs-keyword'>where</span>
<a name="line-685"></a>    <span class='hs-varid'>mk_msg</span> <span class='hs-varid'>tidy_env</span>
<a name="line-686"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty_actual</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>ty_actual</span>
<a name="line-687"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>ty_expected</span>             <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readExpType</span> <span class='hs-varid'>ty_expected</span>
<a name="line-688"></a>                   <span class='hs-comment'>-- A worry: might not be filled if we're debugging. Ugh.</span>
<a name="line-689"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty_expected</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>ty_expected</span>
<a name="line-690"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"When checking that:"</span><span class='hs-layout'>)</span>
<a name="line-691"></a>                                 <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_actual</span><span class='hs-layout'>)</span>
<a name="line-692"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"is more polymorphic than:"</span><span class='hs-layout'>)</span>
<a name="line-693"></a>                                         <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_expected</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-694"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-695"></a>
<a name="line-696"></a>
<a name="line-697"></a><span class='hs-comment'>{- Note [Instantiation of InferResult]
<a name="line-698"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-699"></a>We now always instantiate before filling in InferResult, so that
<a name="line-700"></a>the result is a TcRhoType: see #17173 for discussion.
<a name="line-701"></a>
<a name="line-702"></a>For example:
<a name="line-703"></a>
<a name="line-704"></a>1. Consider
<a name="line-705"></a>    f x = (*)
<a name="line-706"></a>   We want to instantiate the type of (*) before returning, else we
<a name="line-707"></a>   will infer the type
<a name="line-708"></a>     f :: forall {a}. a -&gt; forall b. Num b =&gt; b -&gt; b -&gt; b
<a name="line-709"></a>   This is surely confusing for users.
<a name="line-710"></a>
<a name="line-711"></a>   And worse, the monomorphism restriction won't work properly. The MR is
<a name="line-712"></a>   dealt with in simplifyInfer, and simplifyInfer has no way of
<a name="line-713"></a>   instantiating. This could perhaps be worked around, but it may be
<a name="line-714"></a>   hard to know even when instantiation should happen.
<a name="line-715"></a>
<a name="line-716"></a>2. Another reason.  Consider
<a name="line-717"></a>       f :: (?x :: Int) =&gt; a -&gt; a
<a name="line-718"></a>       g y = let ?x = 3::Int in f
<a name="line-719"></a>   Here want to instantiate f's type so that the ?x::Int constraint
<a name="line-720"></a>  gets discharged by the enclosing implicit-parameter binding.
<a name="line-721"></a>
<a name="line-722"></a>3. Suppose one defines plus = (+). If we instantiate lazily, we will
<a name="line-723"></a>   infer plus :: forall a. Num a =&gt; a -&gt; a -&gt; a. However, the monomorphism
<a name="line-724"></a>   restriction compels us to infer
<a name="line-725"></a>      plus :: Integer -&gt; Integer -&gt; Integer
<a name="line-726"></a>   (or similar monotype). Indeed, the only way to know whether to apply
<a name="line-727"></a>   the monomorphism restriction at all is to instantiate
<a name="line-728"></a>
<a name="line-729"></a>There is one place where we don't want to instantiate eagerly,
<a name="line-730"></a>namely in GHC.Tc.Module.tcRnExpr, which implements GHCi's :type
<a name="line-731"></a>command. See Note [Implementing :type] in GHC.Tc.Module.
<a name="line-732"></a>-}</span>
<a name="line-733"></a>
<a name="line-734"></a><a name="tc_sub_type"></a><span class='hs-comment'>---------------</span>
<a name="line-735"></a><span class='hs-definition'>tc_sub_type</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_sub_type_deep</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_sub_type_shallow</span>
<a name="line-736"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-737"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcCoercionN</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- How to unify</span>
<a name="line-738"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span>       <span class='hs-comment'>-- Used when instantiating</span>
<a name="line-739"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span>   <span class='hs-comment'>-- Used when skolemising</span>
<a name="line-740"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span>    <span class='hs-comment'>-- Actual; a sigma-type</span>
<a name="line-741"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span>    <span class='hs-comment'>-- Expected; also a sigma-type</span>
<a name="line-742"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-743"></a><span class='hs-comment'>-- Checks that actual_ty is more polymorphic than expected_ty</span>
<a name="line-744"></a><span class='hs-comment'>-- If wrap = tc_sub_type t1 t2</span>
<a name="line-745"></a><span class='hs-comment'>--    =&gt; wrap :: t1 ~&gt; t2</span>
<a name="line-746"></a><span class='hs-comment'>--</span>
<a name="line-747"></a><span class='hs-comment'>-- The "how to unify argument" is always a call to `uType TypeLevel orig`,</span>
<a name="line-748"></a><span class='hs-comment'>-- but with different ways of constructing the CtOrigin `orig` from</span>
<a name="line-749"></a><span class='hs-comment'>-- the argument types and context.</span>
<a name="line-750"></a>
<a name="line-751"></a><span class='hs-comment'>----------------------</span>
<a name="line-752"></a><span class='hs-definition'>tc_sub_type</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-753"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>deep_subsumption</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt.DeepSubsumption</span>
<a name="line-754"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>deep_subsumption</span>
<a name="line-755"></a>         <span class='hs-keyword'>then</span> <span class='hs-varid'>tc_sub_type_deep</span>    <span class='hs-varid'>dflags</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-756"></a>         <span class='hs-keyword'>else</span> <span class='hs-varid'>tc_sub_type_shallow</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-757"></a>  <span class='hs-layout'>}</span>
<a name="line-758"></a>
<a name="line-759"></a><a name="tc_sub_type_shallow"></a><span class='hs-comment'>----------------------</span>
<a name="line-760"></a><span class='hs-definition'>tc_sub_type_shallow</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-761"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>definitely_poly</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ty_expected</span>   <span class='hs-comment'>-- See Note [Don't skolemise unnecessarily]</span>
<a name="line-762"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>definitely_mono_shallow</span> <span class='hs-varid'>ty_actual</span>
<a name="line-763"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_sub_type (drop to equality)"</span> <span class='hs-varop'>$</span>
<a name="line-764"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ty_actual   ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_actual</span>
<a name="line-765"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ty_expected ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_expected</span> <span class='hs-keyglyph'>]</span>
<a name="line-766"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mkWpCastN</span> <span class='hs-varop'>&lt;$&gt;</span>
<a name="line-767"></a>         <span class='hs-varid'>unify</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span> <span class='hs-layout'>}</span>
<a name="line-768"></a>
<a name="line-769"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-comment'>-- This is the general case</span>
<a name="line-770"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_sub_type (general case)"</span> <span class='hs-varop'>$</span>
<a name="line-771"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ty_actual   ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_actual</span>
<a name="line-772"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ty_expected ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_expected</span> <span class='hs-keyglyph'>]</span>
<a name="line-773"></a>
<a name="line-774"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>sk_wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>inner_wrap</span><span class='hs-layout'>)</span>
<a name="line-775"></a>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTopSkolemise</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_expected</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>sk_rho</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-776"></a>              <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho_a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>topInstantiate</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ty_actual</span>
<a name="line-777"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>cow</span>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>rho_a</span> <span class='hs-varid'>sk_rho</span>
<a name="line-778"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWpCastN</span> <span class='hs-varid'>cow</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-779"></a>
<a name="line-780"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sk_wrap</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>inner_wrap</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-781"></a>
<a name="line-782"></a><a name="tc_sub_type_deep"></a><span class='hs-comment'>----------------------</span>
<a name="line-783"></a><span class='hs-definition'>tc_sub_type_deep</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-784"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>definitely_poly</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ty_expected</span>      <span class='hs-comment'>-- See Note [Don't skolemise unnecessarily]</span>
<a name="line-785"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>definitely_mono_deep</span> <span class='hs-varid'>ty_actual</span>
<a name="line-786"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_sub_type_deep (drop to equality)"</span> <span class='hs-varop'>$</span>
<a name="line-787"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ty_actual   ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_actual</span>
<a name="line-788"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ty_expected ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_expected</span> <span class='hs-keyglyph'>]</span>
<a name="line-789"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mkWpCastN</span> <span class='hs-varop'>&lt;$&gt;</span>
<a name="line-790"></a>         <span class='hs-varid'>unify</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span> <span class='hs-layout'>}</span>
<a name="line-791"></a>
<a name="line-792"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-comment'>-- This is the general case</span>
<a name="line-793"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_sub_type_deep (general case)"</span> <span class='hs-varop'>$</span>
<a name="line-794"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ty_actual   ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_actual</span>
<a name="line-795"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ty_expected ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_expected</span> <span class='hs-keyglyph'>]</span>
<a name="line-796"></a>
<a name="line-797"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>sk_wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>inner_wrap</span><span class='hs-layout'>)</span>
<a name="line-798"></a>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcDeeplySkolemise</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_expected</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>sk_rho</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-799"></a>              <span class='hs-comment'>-- See Note [Deep subsumption]</span>
<a name="line-800"></a>              <span class='hs-varid'>tc_sub_type_ds</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>sk_rho</span>
<a name="line-801"></a>
<a name="line-802"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sk_wrap</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>inner_wrap</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-803"></a>
<a name="line-804"></a><a name="definitely_mono_shallow"></a><span class='hs-definition'>definitely_mono_shallow</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-805"></a><span class='hs-definition'>definitely_mono_shallow</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isRhoTy</span> <span class='hs-varid'>ty</span>
<a name="line-806"></a>    <span class='hs-comment'>-- isRhoTy: no top level forall or (=&gt;)</span>
<a name="line-807"></a>
<a name="line-808"></a><a name="definitely_mono_deep"></a><span class='hs-definition'>definitely_mono_deep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-809"></a><span class='hs-definition'>definitely_mono_deep</span> <span class='hs-varid'>ty</span>
<a name="line-810"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>definitely_mono_shallow</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-811"></a>    <span class='hs-comment'>-- isRhoTy: False means top level forall or (=&gt;)</span>
<a name="line-812"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitFunTy_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>definitely_mono_deep</span> <span class='hs-varid'>res</span>
<a name="line-813"></a>    <span class='hs-comment'>-- Top level (-&gt;)</span>
<a name="line-814"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-815"></a>
<a name="line-816"></a><a name="definitely_poly"></a><span class='hs-definition'>definitely_poly</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-817"></a><span class='hs-comment'>-- A very conservative test:</span>
<a name="line-818"></a><span class='hs-comment'>-- see Note [Don't skolemise unnecessarily]</span>
<a name="line-819"></a><span class='hs-definition'>definitely_poly</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ty</span>
<a name="line-820"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitSigmaTy</span> <span class='hs-varid'>ty</span>
<a name="line-821"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tvs</span>   <span class='hs-comment'>-- At least one tyvar</span>
<a name="line-822"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>null</span> <span class='hs-varid'>theta</span>      <span class='hs-comment'>-- No constraints; see (DP1)</span>
<a name="line-823"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>checkTyVarEq</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>tau</span> <span class='hs-varop'>`cterHasProblem`</span> <span class='hs-varid'>cteInsolubleOccurs</span>
<a name="line-824"></a>       <span class='hs-comment'>-- The tyvar actually occurs (DP2),</span>
<a name="line-825"></a>       <span class='hs-comment'>--     and occurs in an injective position (DP3).</span>
<a name="line-826"></a>       <span class='hs-comment'>-- Fortunately checkTyVarEq, used for the occur check,</span>
<a name="line-827"></a>       <span class='hs-comment'>-- is just what we need.</span>
<a name="line-828"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-829"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-830"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-831"></a>
<a name="line-832"></a><span class='hs-comment'>{- Note [Don't skolemise unnecessarily]
<a name="line-833"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-834"></a>Suppose we are trying to solve
<a name="line-835"></a>     ty_actual   &lt;= ty_expected
<a name="line-836"></a>    (Char-&gt;Char) &lt;= (forall a. a-&gt;a)
<a name="line-837"></a>We could skolemise the 'forall a', and then complain
<a name="line-838"></a>that (Char ~ a) is insoluble; but that's a pretty obscure
<a name="line-839"></a>error.  It's better to say that
<a name="line-840"></a>    (Char-&gt;Char) ~ (forall a. a-&gt;a)
<a name="line-841"></a>fails.
<a name="line-842"></a>
<a name="line-843"></a>If we prematurely go to equality we'll reject a program we should
<a name="line-844"></a>accept (e.g. #13752).  So the test (which is only to improve error
<a name="line-845"></a>message) is very conservative:
<a name="line-846"></a>
<a name="line-847"></a> * ty_actual   is /definitely/ monomorphic: see `definitely_mono`
<a name="line-848"></a>   This definitely_mono test comes in "shallow" and "deep" variants
<a name="line-849"></a>
<a name="line-850"></a> * ty_expected is /definitely/ polymorphic: see `definitely_poly`
<a name="line-851"></a>   This definitely_poly test is more subtle than you might think.
<a name="line-852"></a>   Here are three cases where expected_ty looks polymorphic, but
<a name="line-853"></a>   isn't, and where it would be /wrong/ to switch to equality:
<a name="line-854"></a>
<a name="line-855"></a>   (DP1)  (Char-&gt;Char) &lt;= (forall a. (a~Char) =&gt; a -&gt; a)
<a name="line-856"></a>
<a name="line-857"></a>   (DP2)  (Char-&gt;Char) &lt;= (forall a. Char -&gt; Char)
<a name="line-858"></a>
<a name="line-859"></a>   (DP3)  (Char-&gt;Char) &lt;= (forall a. F [a] Char -&gt; Char)
<a name="line-860"></a>                          where type instance F [x] t = t
<a name="line-861"></a>
<a name="line-862"></a>
<a name="line-863"></a>Note [Wrapper returned from tcSubMult]
<a name="line-864"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-865"></a>There is no notion of multiplicity coercion in Core, therefore the wrapper
<a name="line-866"></a>returned by tcSubMult (and derived functions such as tcCheckUsage and
<a name="line-867"></a>checkManyPattern) is quite unlike any other wrapper: it checks whether the
<a name="line-868"></a>coercion produced by the constraint solver is trivial, producing a type error
<a name="line-869"></a>is it is not. This is implemented via the WpMultCoercion wrapper, as desugared
<a name="line-870"></a>by GHC.HsToCore.Binds.dsHsWrapper, which does the reflexivity check.
<a name="line-871"></a>
<a name="line-872"></a>This wrapper needs to be placed in the term; otherwise, checking of the
<a name="line-873"></a>eventual coercion won't be triggered during desugaring. But it can be put
<a name="line-874"></a>anywhere, since it doesn't affect the desugared code.
<a name="line-875"></a>
<a name="line-876"></a>Why do we check this in the desugarer? It's a convenient place, since it's
<a name="line-877"></a>right after all the constraints are solved. We need the constraints to be
<a name="line-878"></a>solved to check whether they are trivial or not. Plus there is precedent for
<a name="line-879"></a>type errors during desuraging (such as the levity polymorphism
<a name="line-880"></a>restriction). An alternative would be to have a kind of constraint which can
<a name="line-881"></a>only produce trivial evidence, then this check would happen in the constraint
<a name="line-882"></a>solver.
<a name="line-883"></a>-}</span>
<a name="line-884"></a>
<a name="line-885"></a><a name="tcSubMult"></a><span class='hs-definition'>tcSubMult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Mult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Mult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-886"></a><span class='hs-definition'>tcSubMult</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>w_actual</span> <span class='hs-varid'>w_expected</span>
<a name="line-887"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>w1</span><span class='hs-layout'>,</span> <span class='hs-varid'>w2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isMultMul</span> <span class='hs-varid'>w_actual</span> <span class='hs-keyglyph'>=</span>
<a name="line-888"></a>  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>w1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSubMult</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>w1</span> <span class='hs-varid'>w_expected</span>
<a name="line-889"></a>     <span class='hs-layout'>;</span> <span class='hs-varid'>w2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSubMult</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>w2</span> <span class='hs-varid'>w_expected</span>
<a name="line-890"></a>     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>w1</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>w2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-891"></a>  <span class='hs-comment'>-- Currently, we consider p*q and sup p q to be equal.  Therefore, p*q &lt;= r is</span>
<a name="line-892"></a>  <span class='hs-comment'>-- equivalent to p &lt;= r and q &lt;= r.  For other cases, we approximate p &lt;= q by p</span>
<a name="line-893"></a>  <span class='hs-comment'>-- ~ q.  This is not complete, but it's sound. See also Note [Overapproximating</span>
<a name="line-894"></a>  <span class='hs-comment'>-- multiplicities] in Multiplicity.</span>
<a name="line-895"></a><span class='hs-definition'>tcSubMult</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>w_actual</span> <span class='hs-varid'>w_expected</span> <span class='hs-keyglyph'>=</span>
<a name="line-896"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>submult</span> <span class='hs-varid'>w_actual</span> <span class='hs-varid'>w_expected</span> <span class='hs-keyword'>of</span>
<a name="line-897"></a>    <span class='hs-conid'>Submult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>WpHole</span>
<a name="line-898"></a>    <span class='hs-conid'>Unknown</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcEqMult</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>w_actual</span> <span class='hs-varid'>w_expected</span>
<a name="line-899"></a>
<a name="line-900"></a><a name="tcEqMult"></a><span class='hs-definition'>tcEqMult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Mult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Mult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-901"></a><span class='hs-definition'>tcEqMult</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>w_actual</span> <span class='hs-varid'>w_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-902"></a>  <span class='hs-layout'>{</span>
<a name="line-903"></a>  <span class='hs-comment'>-- Note that here we do not call to `submult`, so we check</span>
<a name="line-904"></a>  <span class='hs-comment'>-- for strict equality.</span>
<a name="line-905"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>coercion</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>w_actual</span> <span class='hs-varid'>w_expected</span>
<a name="line-906"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isReflCo</span> <span class='hs-varid'>coercion</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>WpHole</span> <span class='hs-keyword'>else</span> <span class='hs-conid'>WpMultCoercion</span> <span class='hs-varid'>coercion</span> <span class='hs-layout'>}</span>
<a name="line-907"></a>
<a name="line-908"></a>
<a name="line-909"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-910"></a>*                                                                      *
<a name="line-911"></a>                    Deep subsumption
<a name="line-912"></a>*                                                                      *
<a name="line-913"></a>********************************************************************* -}</span>
<a name="line-914"></a>
<a name="line-915"></a><span class='hs-comment'>{- Note [Deep subsumption]
<a name="line-916"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-917"></a>The DeepSubsumption extension, documented here
<a name="line-918"></a>
<a name="line-919"></a>    https://github.com/ghc-proposals/ghc-proposals/pull/511.
<a name="line-920"></a>
<a name="line-921"></a>makes a best-efforts attempt implement deep subsumption as it was
<a name="line-922"></a>prior to the the Simplify Subsumption proposal:
<a name="line-923"></a>
<a name="line-924"></a>    https://github.com/ghc-proposals/ghc-proposals/pull/287
<a name="line-925"></a>
<a name="line-926"></a>The effects are in these main places:
<a name="line-927"></a>
<a name="line-928"></a>1. In the subsumption check, tcSubType, we must do deep skolemisation:
<a name="line-929"></a>   see the call to tcDeeplySkolemise in tc_sub_type_deep
<a name="line-930"></a>
<a name="line-931"></a>2. In tcPolyExpr we must do deep skolemisation:
<a name="line-932"></a>   see the call to tcDeeplySkolemise in tcSkolemiseExpType
<a name="line-933"></a>
<a name="line-934"></a>3. for expression type signatures (e :: ty), and functions with type
<a name="line-935"></a>   signatures (e.g. f :: ty; f = e), we must deeply skolemise the type;
<a name="line-936"></a>   see the call to tcDeeplySkolemise in tcSkolemiseScoped.
<a name="line-937"></a>
<a name="line-938"></a>4. In GHC.Tc.Gen.App.tcApp we call tcSubTypeDS to match the result
<a name="line-939"></a>   type. Without deep subsumption, unifyExpectedType would be sufficent.
<a name="line-940"></a>
<a name="line-941"></a>In all these cases note that the deep skolemisation must be done /first/.
<a name="line-942"></a>Consider (1)
<a name="line-943"></a>     (forall a. Int -&gt; a -&gt; a)  &lt;=  Int -&gt; (forall b. b -&gt; b)
<a name="line-944"></a>We must skolemise the `forall b` before instantiating the `forall a`.
<a name="line-945"></a>See also Note [Deep skolemisation].
<a name="line-946"></a>
<a name="line-947"></a>Note that we /always/ use shallow subsumption in the ambiguity check.
<a name="line-948"></a>See Note [Ambiguity check and deep subsumption].
<a name="line-949"></a>
<a name="line-950"></a>Note [Deep skolemisation]
<a name="line-951"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-952"></a>deeplySkolemise decomposes and skolemises a type, returning a type
<a name="line-953"></a>with all its arrows visible (ie not buried under foralls)
<a name="line-954"></a>
<a name="line-955"></a>Examples:
<a name="line-956"></a>
<a name="line-957"></a>  deeplySkolemise (Int -&gt; forall a. Ord a =&gt; blah)
<a name="line-958"></a>    =  ( wp, [a], [d:Ord a], Int -&gt; blah )
<a name="line-959"></a>    where wp = \x:Int. /\a. \(d:Ord a). &lt;hole&gt; x
<a name="line-960"></a>
<a name="line-961"></a>  deeplySkolemise  (forall a. Ord a =&gt; Maybe a -&gt; forall b. Eq b =&gt; blah)
<a name="line-962"></a>    =  ( wp, [a,b], [d1:Ord a,d2:Eq b], Maybe a -&gt; blah )
<a name="line-963"></a>    where wp = /\a.\(d1:Ord a).\(x:Maybe a)./\b.\(d2:Ord b). &lt;hole&gt; x
<a name="line-964"></a>
<a name="line-965"></a>In general,
<a name="line-966"></a>  if      deeplySkolemise ty = (wrap, tvs, evs, rho)
<a name="line-967"></a>    and   e :: rho
<a name="line-968"></a>  then    wrap e :: ty
<a name="line-969"></a>    and   'wrap' binds tvs, evs
<a name="line-970"></a>
<a name="line-971"></a>ToDo: this eta-abstraction plays fast and loose with termination,
<a name="line-972"></a>      because it can introduce extra lambdas.  Maybe add a `seq` to
<a name="line-973"></a>      fix this
<a name="line-974"></a>
<a name="line-975"></a>Note [Setting the argument context]
<a name="line-976"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-977"></a>Consider we are doing the ambiguity check for the (bogus)
<a name="line-978"></a>  f :: (forall a b. C b =&gt; a -&gt; a) -&gt; Int
<a name="line-979"></a>
<a name="line-980"></a>We'll call
<a name="line-981"></a>   tcSubType ((forall a b. C b =&gt; a-&gt;a) -&gt; Int )
<a name="line-982"></a>             ((forall a b. C b =&gt; a-&gt;a) -&gt; Int )
<a name="line-983"></a>
<a name="line-984"></a>with a UserTypeCtxt of (FunSigCtxt "f").  Then we'll do the co/contra thing
<a name="line-985"></a>on the argument type of the (-&gt;) -- and at that point we want to switch
<a name="line-986"></a>to a UserTypeCtxt of GenSigCtxt.  Why?
<a name="line-987"></a>
<a name="line-988"></a>* Error messages.  If we stick with FunSigCtxt we get errors like
<a name="line-989"></a>     * Could not deduce: C b
<a name="line-990"></a>       from the context: C b0
<a name="line-991"></a>        bound by the type signature for:
<a name="line-992"></a>            f :: forall a b. C b =&gt; a-&gt;a
<a name="line-993"></a>  But of course f does not have that type signature!
<a name="line-994"></a>  Example tests: T10508, T7220a, Simple14
<a name="line-995"></a>
<a name="line-996"></a>* Implications. We may decide to build an implication for the whole
<a name="line-997"></a>  ambiguity check, but we don't need one for each level within it,
<a name="line-998"></a>  and TcUnify.alwaysBuildImplication checks the UserTypeCtxt.
<a name="line-999"></a>  See Note [When to build an implication]
<a name="line-1000"></a>
<a name="line-1001"></a>Note [Multiplicity in deep subsumption]
<a name="line-1002"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1003"></a>Consider
<a name="line-1004"></a>   t1 -&gt;{mt} t2  &lt;=   s1 -&gt;{ms} s2
<a name="line-1005"></a>
<a name="line-1006"></a>At the moment we /unify/ ms~mt, via tcEqMult.
<a name="line-1007"></a>
<a name="line-1008"></a>Arguably we should use `tcSubMult`. But then if mt=m0 (a unification
<a name="line-1009"></a>variable) and ms=Many, `tcSubMult` is a no-op (since anything is a
<a name="line-1010"></a>sub-multiplicty of Many).  But then `m0` may never get unified with
<a name="line-1011"></a>anything.  It is then skolemised by the zonker; see GHC.HsToCore.Binds
<a name="line-1012"></a>Note [Free tyvars on rule LHS].  So we in RULE foldr/app in GHC.Base
<a name="line-1013"></a>we get this
<a name="line-1014"></a>
<a name="line-1015"></a> "foldr/app"     [1] forall ys m1 m2. foldr (\x{m1} \xs{m2}. (:) x xs) ys
<a name="line-1016"></a>                                       = \xs -&gt; xs ++ ys
<a name="line-1017"></a>
<a name="line-1018"></a>where we eta-expanded that (:).  But now foldr expects an argument
<a name="line-1019"></a>with -&gt;{Many} and gets an argument with -&gt;{m1} or -&gt;{m2}, and Lint
<a name="line-1020"></a>complains.
<a name="line-1021"></a>
<a name="line-1022"></a>The easiest solution was to use tcEqMult in tc_sub_type_ds, and
<a name="line-1023"></a>insist on equality. This is only in the DeepSubsumption code anyway.
<a name="line-1024"></a>-}</span>
<a name="line-1025"></a>
<a name="line-1026"></a><a name="tc_sub_type_ds"></a><span class='hs-definition'>tc_sub_type_ds</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcCoercionN</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- How to unify</span>
<a name="line-1027"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span>       <span class='hs-comment'>-- Used when instantiating</span>
<a name="line-1028"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span>   <span class='hs-comment'>-- Used when skolemising</span>
<a name="line-1029"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span>    <span class='hs-comment'>-- Actual; a sigma-type</span>
<a name="line-1030"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>      <span class='hs-comment'>-- Expected; deeply skolemised</span>
<a name="line-1031"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-1032"></a>
<a name="line-1033"></a><span class='hs-comment'>-- If wrap = tc_sub_type_ds t1 t2</span>
<a name="line-1034"></a><span class='hs-comment'>--    =&gt; wrap :: t1 ~&gt; t2</span>
<a name="line-1035"></a><span class='hs-comment'>-- Here is where the work actually happens!</span>
<a name="line-1036"></a><span class='hs-comment'>-- Precondition: ty_expected is deeply skolemised</span>
<a name="line-1037"></a>
<a name="line-1038"></a><span class='hs-definition'>tc_sub_type_ds</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-1039"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_sub_type_ds"</span> <span class='hs-varop'>$</span>
<a name="line-1040"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ty_actual   ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_actual</span>
<a name="line-1041"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ty_expected ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_expected</span> <span class='hs-keyglyph'>]</span>
<a name="line-1042"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span> <span class='hs-layout'>}</span>
<a name="line-1043"></a>  <span class='hs-keyword'>where</span>
<a name="line-1044"></a>    <span class='hs-comment'>-- NB: 'go' is not recursive, except for doing tcView</span>
<a name="line-1045"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty_a</span> <span class='hs-varid'>ty_e</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty_a'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty_a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty_a'</span> <span class='hs-varid'>ty_e</span>
<a name="line-1046"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty_e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty_e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty_a</span>  <span class='hs-varid'>ty_e'</span>
<a name="line-1047"></a>
<a name="line-1048"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv_a</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty_e</span>
<a name="line-1049"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lookup_res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isFilledMetaTyVar_maybe</span> <span class='hs-varid'>tv_a</span>
<a name="line-1050"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookup_res</span> <span class='hs-keyword'>of</span>
<a name="line-1051"></a>               <span class='hs-conid'>Just</span> <span class='hs-varid'>ty_a'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1052"></a>                 <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_sub_type_ds following filled meta-tyvar:"</span>
<a name="line-1053"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv_a</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"--&gt;"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_a'</span><span class='hs-layout'>)</span>
<a name="line-1054"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>tc_sub_type_ds</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_a'</span> <span class='hs-varid'>ty_e</span> <span class='hs-layout'>}</span>
<a name="line-1055"></a>               <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>just_unify</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span> <span class='hs-layout'>}</span>
<a name="line-1056"></a>
<a name="line-1057"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty_a</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_af</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VisArg</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_mult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act_mult</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act_arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act_res</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1058"></a>       <span class='hs-varid'>ty_e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_af</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VisArg</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_mult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp_mult</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp_arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp_res</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1059"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTauTy</span> <span class='hs-varid'>ty_a</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTauTy</span> <span class='hs-varid'>ty_e</span>         <span class='hs-comment'>-- Short cut common case to avoid</span>
<a name="line-1060"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>just_unify</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>   <span class='hs-comment'>-- unnecessary eta expansion</span>
<a name="line-1061"></a>
<a name="line-1062"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1063"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- This is where we do the co/contra thing, and generate a WpFun, which in turn</span>
<a name="line-1064"></a>        <span class='hs-comment'>-- causes eta-expansion, which we don't like; hence encouraging NoDeepSubsumption</span>
<a name="line-1065"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-1066"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>arg_wrap</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_sub_type_deep</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>given_orig</span> <span class='hs-conid'>GenSigCtxt</span> <span class='hs-varid'>exp_arg</span> <span class='hs-varid'>act_arg</span>
<a name="line-1067"></a>                          <span class='hs-comment'>-- GenSigCtxt: See Note [Setting the argument context]</span>
<a name="line-1068"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>res_wrap</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_sub_type_ds</span>   <span class='hs-varid'>unify</span> <span class='hs-varid'>inst_orig</span>  <span class='hs-varid'>ctxt</span>       <span class='hs-varid'>act_res</span> <span class='hs-varid'>exp_res</span>
<a name="line-1069"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>mult_wrap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcEqMult</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>act_mult</span> <span class='hs-varid'>exp_mult</span>
<a name="line-1070"></a>                          <span class='hs-comment'>-- See Note [Multiplicity in deep subsumption]</span>
<a name="line-1071"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"When checking that"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_actual</span><span class='hs-layout'>)</span>
<a name="line-1072"></a>                   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"is more polymorphic than"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_expected</span><span class='hs-layout'>)</span>
<a name="line-1073"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mult_wrap</span> <span class='hs-varop'>&lt;.&gt;</span>
<a name="line-1074"></a>                     <span class='hs-varid'>mkWpFun</span> <span class='hs-varid'>arg_wrap</span> <span class='hs-varid'>res_wrap</span> <span class='hs-layout'>(</span><span class='hs-conid'>Scaled</span> <span class='hs-varid'>exp_mult</span> <span class='hs-varid'>exp_arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_res</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span><span class='hs-layout'>}</span>
<a name="line-1075"></a>                     <span class='hs-comment'>-- arg_wrap :: exp_arg ~&gt; act_arg</span>
<a name="line-1076"></a>                     <span class='hs-comment'>-- res_wrap :: act-res ~&gt; exp_res</span>
<a name="line-1077"></a>      <span class='hs-keyword'>where</span>
<a name="line-1078"></a>        <span class='hs-varid'>given_orig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GivenOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigSkol</span> <span class='hs-conid'>GenSigCtxt</span> <span class='hs-varid'>exp_arg</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-1079"></a>
<a name="line-1080"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty_a</span> <span class='hs-varid'>ty_e</span>
<a name="line-1081"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitSigmaTy</span> <span class='hs-varid'>ty_a</span>
<a name="line-1082"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span>
<a name="line-1083"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>in_rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>topInstantiate</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ty_a</span>
<a name="line-1084"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>body_wrap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_sub_type_ds</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>in_rho</span> <span class='hs-varid'>ty_e</span>
<a name="line-1085"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>body_wrap</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>in_wrap</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1086"></a>
<a name="line-1087"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-comment'>-- Revert to unification</span>
<a name="line-1088"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- It's still possible that ty_actual has nested foralls. Instantiate</span>
<a name="line-1089"></a>             <span class='hs-comment'>-- these, as there's no way unification will succeed with them in.</span>
<a name="line-1090"></a>             <span class='hs-comment'>-- See typecheck/should_compile/T11305 for an example of when this</span>
<a name="line-1091"></a>             <span class='hs-comment'>-- is important. The problem is that we're checking something like</span>
<a name="line-1092"></a>             <span class='hs-comment'>--  a -&gt; forall b. b -&gt; b     &lt;=   alpha beta gamma</span>
<a name="line-1093"></a>             <span class='hs-comment'>-- where we end up with alpha := (-&gt;)</span>
<a name="line-1094"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>inst_wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho_a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>deeplyInstantiate</span> <span class='hs-varid'>inst_orig</span> <span class='hs-varid'>ty_actual</span>
<a name="line-1095"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>unify_wrap</span>         <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>just_unify</span> <span class='hs-varid'>rho_a</span> <span class='hs-varid'>ty_expected</span>
<a name="line-1096"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unify_wrap</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>inst_wrap</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1097"></a>
<a name="line-1098"></a>    <span class='hs-varid'>just_unify</span> <span class='hs-varid'>ty_a</span> <span class='hs-varid'>ty_e</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cow</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>ty_a</span> <span class='hs-varid'>ty_e</span>
<a name="line-1099"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWpCastN</span> <span class='hs-varid'>cow</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1100"></a>
<a name="line-1101"></a><a name="tcDeeplySkolemise"></a><span class='hs-definition'>tcDeeplySkolemise</span>
<a name="line-1102"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span>
<a name="line-1103"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-1104"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-1105"></a>        <span class='hs-comment'>-- ^ The wrapper has type: spec_ty ~&gt; expected_ty</span>
<a name="line-1106"></a><span class='hs-comment'>-- Just like tcTopSkolemise, but calls</span>
<a name="line-1107"></a><span class='hs-comment'>-- deeplySkolemise instead of topSkolemise</span>
<a name="line-1108"></a><span class='hs-comment'>-- See Note [Deep skolemisation]</span>
<a name="line-1109"></a><span class='hs-definition'>tcDeeplySkolemise</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>expected_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1110"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTauTy</span> <span class='hs-varid'>expected_ty</span>  <span class='hs-comment'>-- Short cut for common case</span>
<a name="line-1111"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>expected_ty</span>
<a name="line-1112"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>idHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1113"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1114"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv_prs</span><span class='hs-layout'>,</span> <span class='hs-varid'>given</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>deeplySkolemise</span> <span class='hs-varid'>expected_ty</span>
<a name="line-1115"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>skol_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SigSkol</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>expected_ty</span> <span class='hs-varid'>tv_prs</span>
<a name="line-1116"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcDeeplySkolemise"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>expected_ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rho_ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv_prs</span><span class='hs-layout'>)</span>
<a name="line-1117"></a>
<a name="line-1118"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>skol_tvs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>tv_prs</span>
<a name="line-1119"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-1120"></a>              <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkConstraints</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>given</span> <span class='hs-varop'>$</span>
<a name="line-1121"></a>                 <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>rho_ty</span>
<a name="line-1122"></a>
<a name="line-1123"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>mkWpLet</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1124"></a>          <span class='hs-comment'>-- The ev_binds returned by checkConstraints is very</span>
<a name="line-1125"></a>          <span class='hs-comment'>-- often empty, in which case mkWpLet is a no-op</span>
<a name="line-1126"></a>
<a name="line-1127"></a><a name="deeplySkolemise"></a><span class='hs-definition'>deeplySkolemise</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSigmaType</span>
<a name="line-1128"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-1129"></a>                       <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- All skolemised variables</span>
<a name="line-1130"></a>                       <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span>            <span class='hs-comment'>-- All "given"s</span>
<a name="line-1131"></a>                       <span class='hs-layout'>,</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-layout'>)</span>
<a name="line-1132"></a><span class='hs-comment'>-- See Note [Deep skolemisation]</span>
<a name="line-1133"></a><span class='hs-definition'>deeplySkolemise</span> <span class='hs-varid'>ty</span>
<a name="line-1134"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>init_subst</span> <span class='hs-varid'>ty</span>
<a name="line-1135"></a>  <span class='hs-keyword'>where</span>
<a name="line-1136"></a>    <span class='hs-varid'>init_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1137"></a>
<a name="line-1138"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-1139"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcDeepSplitSigmaTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1140"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arg_tys'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substScaledTys</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>arg_tys</span>
<a name="line-1141"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>ids1</span>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalIds</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"dk"</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys'</span>
<a name="line-1142"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstSkolTyVarsX</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span>
<a name="line-1143"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>ev_vars1</span>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEvVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTheta</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span>
<a name="line-1144"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs_prs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_vars2</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>ty'</span>
<a name="line-1145"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tv_prs1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>tvs1</span>
<a name="line-1146"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>mkWpLams</span> <span class='hs-varid'>ids1</span>
<a name="line-1147"></a>                      <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>mkWpTyLams</span> <span class='hs-varid'>tvs1</span>
<a name="line-1148"></a>                      <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>mkWpLams</span> <span class='hs-varid'>ev_vars1</span>
<a name="line-1149"></a>                      <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>wrap</span>
<a name="line-1150"></a>                      <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>mkWpEvVarApps</span> <span class='hs-varid'>ids1</span>
<a name="line-1151"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>tv_prs1</span>  <span class='hs-varop'>++</span> <span class='hs-varid'>tvs_prs2</span>
<a name="line-1152"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>ev_vars1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ev_vars2</span>
<a name="line-1153"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>mkVisFunTys</span> <span class='hs-varid'>arg_tys'</span> <span class='hs-varid'>rho</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1154"></a>
<a name="line-1155"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1156"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>idHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1157"></a>        <span class='hs-comment'>-- substTy is a quick no-op on an empty substitution</span>
<a name="line-1158"></a>
<a name="line-1159"></a><a name="deeplyInstantiate"></a><span class='hs-definition'>deeplyInstantiate</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1160"></a><span class='hs-definition'>deeplyInstantiate</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>ty</span>
<a name="line-1161"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>init_subst</span> <span class='hs-varid'>ty</span>
<a name="line-1162"></a>  <span class='hs-keyword'>where</span>
<a name="line-1163"></a>    <span class='hs-varid'>init_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1164"></a>
<a name="line-1165"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-1166"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcDeepSplitSigmaTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1167"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaTyVarsX</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span>
<a name="line-1168"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arg_tys'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substScaledTys</span>   <span class='hs-varid'>subst'</span> <span class='hs-varid'>arg_tys</span>
<a name="line-1169"></a>                 <span class='hs-varid'>theta'</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTheta</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>theta</span>
<a name="line-1170"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>ids1</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalIds</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"di"</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys'</span>
<a name="line-1171"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>wrap1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instCall</span> <span class='hs-varid'>orig</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span> <span class='hs-varid'>theta'</span>
<a name="line-1172"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap2</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>rho</span>
<a name="line-1173"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWpLams</span> <span class='hs-varid'>ids1</span>
<a name="line-1174"></a>                        <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>wrap2</span>
<a name="line-1175"></a>                        <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>wrap1</span>
<a name="line-1176"></a>                        <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>mkWpEvVarApps</span> <span class='hs-varid'>ids1</span><span class='hs-layout'>,</span>
<a name="line-1177"></a>                     <span class='hs-varid'>mkVisFunTys</span> <span class='hs-varid'>arg_tys'</span> <span class='hs-varid'>rho2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1178"></a>
<a name="line-1179"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1180"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-1181"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>idHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1182"></a>
<a name="line-1183"></a><a name="tcDeepSplitSigmaTy_maybe"></a><span class='hs-definition'>tcDeepSplitSigmaTy_maybe</span>
<a name="line-1184"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Scaled</span> <span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcSigmaType</span><span class='hs-layout'>)</span>
<a name="line-1185"></a><span class='hs-comment'>-- Looks for a *non-trivial* quantified type, under zero or more function arrows</span>
<a name="line-1186"></a><span class='hs-comment'>-- By "non-trivial" we mean either tyvars or constraints are non-empty</span>
<a name="line-1187"></a>
<a name="line-1188"></a><span class='hs-definition'>tcDeepSplitSigmaTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1189"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitFunTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1190"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcDeepSplitSigmaTy_maybe</span> <span class='hs-varid'>res_ty</span>
<a name="line-1191"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_ty</span><span class='hs-conop'>:</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span>
<a name="line-1192"></a>
<a name="line-1193"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitSigmaTy</span> <span class='hs-varid'>ty</span>
<a name="line-1194"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span>
<a name="line-1195"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span>
<a name="line-1196"></a>
<a name="line-1197"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1198"></a>
<a name="line-1199"></a>
<a name="line-1200"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1201"></a>*                                                                      *
<a name="line-1202"></a>                    Generalisation
<a name="line-1203"></a>*                                                                      *
<a name="line-1204"></a>********************************************************************* -}</span>
<a name="line-1205"></a>
<a name="line-1206"></a><span class='hs-comment'>{- Note [Skolemisation]
<a name="line-1207"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1208"></a>tcTopSkolemise takes "expected type" and strip off quantifiers to expose the
<a name="line-1209"></a>type underneath, binding the new skolems for the 'thing_inside'
<a name="line-1210"></a>The returned 'HsWrapper' has type (specific_ty -&gt; expected_ty).
<a name="line-1211"></a>
<a name="line-1212"></a>Note that for a nested type like
<a name="line-1213"></a>   forall a. Eq a =&gt; forall b. Ord b =&gt; blah
<a name="line-1214"></a>we still only build one implication constraint
<a name="line-1215"></a>   forall a b. (Eq a, Ord b) =&gt; &lt;constraints&gt;
<a name="line-1216"></a>This is just an optimisation, but it's why we use topSkolemise to
<a name="line-1217"></a>build the pieces from all the layers, before making a single call
<a name="line-1218"></a>to checkConstraints.
<a name="line-1219"></a>
<a name="line-1220"></a>tcSkolemiseScoped is very similar, but differs in two ways:
<a name="line-1221"></a>
<a name="line-1222"></a>* It deals specially with just the outer forall, bringing those type
<a name="line-1223"></a>  variables into lexical scope.  To my surprise, I found that doing
<a name="line-1224"></a>  this unconditionally in tcTopSkolemise (i.e. doing it even if we don't
<a name="line-1225"></a>  need to bring the variables into lexical scope, which is harmless)
<a name="line-1226"></a>  caused a non-trivial (1%-ish) perf hit on the compiler.
<a name="line-1227"></a>
<a name="line-1228"></a>* It handles deep subumption, wheres tcTopSkolemise never looks under
<a name="line-1229"></a>  function arrows.
<a name="line-1230"></a>
<a name="line-1231"></a>* It always calls checkConstraints, even if there are no skolem
<a name="line-1232"></a>  variables at all.  Reason: there might be nested deferred errors
<a name="line-1233"></a>  that must not be allowed to float to top level.
<a name="line-1234"></a>  See Note [When to build an implication] below.
<a name="line-1235"></a>-}</span>
<a name="line-1236"></a>
<a name="line-1237"></a><a name="tcTopSkolemise"></a><span class='hs-definition'>tcTopSkolemise</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSkolemiseScoped</span>
<a name="line-1238"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span>
<a name="line-1239"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-1240"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-1241"></a>        <span class='hs-comment'>-- ^ The wrapper has type: spec_ty ~&gt; expected_ty</span>
<a name="line-1242"></a><span class='hs-comment'>-- See Note [Skolemisation] for the differences between</span>
<a name="line-1243"></a><span class='hs-comment'>-- tcSkolemiseScoped and tcTopSkolemise</span>
<a name="line-1244"></a>
<a name="line-1245"></a><a name="tcSkolemiseScoped"></a><span class='hs-definition'>tcSkolemiseScoped</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>expected_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1246"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>deep_subsumption</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt.DeepSubsumption</span>
<a name="line-1247"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>skolemise</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>deep_subsumption</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deeplySkolemise</span>
<a name="line-1248"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topSkolemise</span>
<a name="line-1249"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv_prs</span><span class='hs-layout'>,</span> <span class='hs-varid'>given</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>skolemise</span> <span class='hs-varid'>expected_ty</span>
<a name="line-1250"></a>
<a name="line-1251"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>tv_prs</span>
<a name="line-1252"></a>             <span class='hs-varid'>skol_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SigSkol</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>expected_ty</span> <span class='hs-varid'>tv_prs</span>
<a name="line-1253"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-1254"></a>             <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkConstraints</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>given</span> <span class='hs-varop'>$</span>
<a name="line-1255"></a>                <span class='hs-varid'>tcExtendNameTyVarEnv</span> <span class='hs-varid'>tv_prs</span>               <span class='hs-varop'>$</span>
<a name="line-1256"></a>                <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>rho_ty</span>
<a name="line-1257"></a>
<a name="line-1258"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>mkWpLet</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1259"></a>
<a name="line-1260"></a><span class='hs-definition'>tcTopSkolemise</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>expected_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1261"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isRhoTy</span> <span class='hs-varid'>expected_ty</span>  <span class='hs-comment'>-- Short cut for common case</span>
<a name="line-1262"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>expected_ty</span>
<a name="line-1263"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>idHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1264"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1265"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rec</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>skol_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SigSkol</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>expected_ty</span> <span class='hs-varid'>tv_prs</span>
<a name="line-1266"></a>             <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv_prs</span><span class='hs-layout'>,</span> <span class='hs-varid'>given</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>topSkolemise</span> <span class='hs-varid'>expected_ty</span>
<a name="line-1267"></a>             <span class='hs-layout'>}</span>
<a name="line-1268"></a>
<a name="line-1269"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>tv_prs</span>
<a name="line-1270"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-1271"></a>             <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkConstraints</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>given</span> <span class='hs-varop'>$</span>
<a name="line-1272"></a>                <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>rho_ty</span>
<a name="line-1273"></a>
<a name="line-1274"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>mkWpLet</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1275"></a>         <span class='hs-comment'>-- The ev_binds returned by checkConstraints is very</span>
<a name="line-1276"></a>        <span class='hs-comment'>-- often empty, in which case mkWpLet is a no-op</span>
<a name="line-1277"></a>
<a name="line-1278"></a><a name="tcSkolemiseExpType"></a><span class='hs-comment'>-- | Variant of 'tcTopSkolemise' that takes an ExpType</span>
<a name="line-1279"></a><span class='hs-definition'>tcSkolemiseExpType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpSigmaType</span>
<a name="line-1280"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExpRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-1281"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-1282"></a><span class='hs-definition'>tcSkolemiseExpType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>et</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Infer</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1283"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>idHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>et</span>
<a name="line-1284"></a><span class='hs-definition'>tcSkolemiseExpType</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>Check</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1285"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>deep_subsumption</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt.DeepSubsumption</span>
<a name="line-1286"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>skolemise</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>deep_subsumption</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcDeeplySkolemise</span>
<a name="line-1287"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTopSkolemise</span>
<a name="line-1288"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>skolemise</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>rho_ty</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1289"></a>         <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCheckExpType</span> <span class='hs-varid'>rho_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1290"></a>
<a name="line-1291"></a><a name="checkConstraints"></a><span class='hs-definition'>checkConstraints</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-1292"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>           <span class='hs-comment'>-- Skolems</span>
<a name="line-1293"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span>             <span class='hs-comment'>-- Given</span>
<a name="line-1294"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>result</span>
<a name="line-1295"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-1296"></a>
<a name="line-1297"></a><span class='hs-definition'>checkConstraints</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>given</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1298"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>implication_needed</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>implicationNeeded</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>given</span>
<a name="line-1299"></a>
<a name="line-1300"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>implication_needed</span>
<a name="line-1301"></a>         <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tclvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pushLevelAndCaptureConstraints</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1302"></a>                 <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>implics</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>buildImplicationFor</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>given</span> <span class='hs-varid'>wanted</span>
<a name="line-1303"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"checkConstraints"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tclvl</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>skol_tvs</span><span class='hs-layout'>)</span>
<a name="line-1304"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>emitImplications</span> <span class='hs-varid'>implics</span>
<a name="line-1305"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1306"></a>
<a name="line-1307"></a>         <span class='hs-keyword'>else</span> <span class='hs-comment'>-- Fast path.  We check every function argument with tcCheckPolyExpr,</span>
<a name="line-1308"></a>              <span class='hs-comment'>-- which uses tcTopSkolemise and hence checkConstraints.</span>
<a name="line-1309"></a>              <span class='hs-comment'>-- So this fast path is well-exercised</span>
<a name="line-1310"></a>              <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1311"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyTcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1312"></a>
<a name="line-1313"></a><a name="checkTvConstraints"></a><span class='hs-definition'>checkTvConstraints</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-1314"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>          <span class='hs-comment'>-- Skolem tyvars</span>
<a name="line-1315"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>result</span>
<a name="line-1316"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>result</span>
<a name="line-1317"></a>
<a name="line-1318"></a><span class='hs-definition'>checkTvConstraints</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1319"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tclvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pushLevelAndCaptureConstraints</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1320"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>emitResidualTvConstraint</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>wanted</span>
<a name="line-1321"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>result</span> <span class='hs-layout'>}</span>
<a name="line-1322"></a>
<a name="line-1323"></a><a name="emitResidualTvConstraint"></a><span class='hs-definition'>emitResidualTvConstraint</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1324"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-1325"></a><span class='hs-definition'>emitResidualTvConstraint</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>wanted</span>
<a name="line-1326"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyWC</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span>
<a name="line-1327"></a>    <span class='hs-varid'>checkTelescopeSkol</span> <span class='hs-varid'>skol_info</span>
<a name="line-1328"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- checkTelescopeSkol: in this case, /always/ emit this implication</span>
<a name="line-1329"></a>    <span class='hs-comment'>-- even if 'wanted' is empty. We need the implication so that we check</span>
<a name="line-1330"></a>    <span class='hs-comment'>-- for a bad telescope. See Note [Skolem escape and forall-types] in</span>
<a name="line-1331"></a>    <span class='hs-comment'>-- GHC.Tc.Gen.HsType</span>
<a name="line-1332"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>implic</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>buildTvImplication</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>wanted</span>
<a name="line-1333"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>emitImplication</span> <span class='hs-varid'>implic</span> <span class='hs-layout'>}</span>
<a name="line-1334"></a>
<a name="line-1335"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-comment'>-- Empty 'wanted', emit nothing</span>
<a name="line-1336"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1337"></a>
<a name="line-1338"></a><a name="buildTvImplication"></a><span class='hs-definition'>buildTvImplication</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1339"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Implication</span>
<a name="line-1340"></a><span class='hs-definition'>buildTvImplication</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>wanted</span>
<a name="line-1341"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newNoTcEvBinds</span>  <span class='hs-comment'>-- Used for equalities only, so all the constraints</span>
<a name="line-1342"></a>                                     <span class='hs-comment'>-- are solved by filling in coercion holes, not</span>
<a name="line-1343"></a>                                     <span class='hs-comment'>-- by creating a value-level evidence binding</span>
<a name="line-1344"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>implic</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newImplication</span>
<a name="line-1345"></a>
<a name="line-1346"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_tclvl</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tclvl</span>
<a name="line-1347"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ic_skols</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-1348"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoGivenEqs</span>
<a name="line-1349"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanted</span>
<a name="line-1350"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ic_binds</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds</span>
<a name="line-1351"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_info</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1352"></a>
<a name="line-1353"></a><a name="implicationNeeded"></a><span class='hs-definition'>implicationNeeded</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Bool</span>
<a name="line-1354"></a><span class='hs-comment'>-- See Note [When to build an implication]</span>
<a name="line-1355"></a><span class='hs-definition'>implicationNeeded</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>given</span>
<a name="line-1356"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-1357"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>null</span> <span class='hs-varid'>given</span>
<a name="line-1358"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>alwaysBuildImplication</span> <span class='hs-varid'>skol_info</span><span class='hs-layout'>)</span>
<a name="line-1359"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- Empty skolems and givens</span>
<a name="line-1360"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tc_lvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcLevel</span>
<a name="line-1361"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTopTcLevel</span> <span class='hs-varid'>tc_lvl</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- No implication needed if we are</span>
<a name="line-1362"></a>         <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>             <span class='hs-comment'>-- already inside an implication</span>
<a name="line-1363"></a>         <span class='hs-keyword'>else</span>
<a name="line-1364"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>       <span class='hs-comment'>-- If any deferral can happen,</span>
<a name="line-1365"></a>                                     <span class='hs-comment'>-- we must build an implication</span>
<a name="line-1366"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_DeferTypeErrors</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>||</span>
<a name="line-1367"></a>                 <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_DeferTypedHoles</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>||</span>
<a name="line-1368"></a>                 <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_DeferOutOfScopeVariables</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1369"></a>
<a name="line-1370"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-comment'>-- Non-empty skolems or givens</span>
<a name="line-1371"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>True</span>   <span class='hs-comment'>-- Definitely need an implication</span>
<a name="line-1372"></a>
<a name="line-1373"></a><a name="alwaysBuildImplication"></a><span class='hs-definition'>alwaysBuildImplication</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1374"></a><span class='hs-comment'>-- See Note [When to build an implication]</span>
<a name="line-1375"></a><span class='hs-definition'>alwaysBuildImplication</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1376"></a>
<a name="line-1377"></a><span class='hs-comment'>{-  Commmented out for now while I figure out about error messages.
<a name="line-1378"></a>    See #14185
<a name="line-1379"></a>
<a name="line-1380"></a>alwaysBuildImplication (SigSkol ctxt _ _)
<a name="line-1381"></a>  = case ctxt of
<a name="line-1382"></a>      FunSigCtxt {} -&gt; True  -- RHS of a binding with a signature
<a name="line-1383"></a>      _             -&gt; False
<a name="line-1384"></a>alwaysBuildImplication (RuleSkol {})      = True
<a name="line-1385"></a>alwaysBuildImplication (InstSkol {})      = True
<a name="line-1386"></a>alwaysBuildImplication (FamInstSkol {})   = True
<a name="line-1387"></a>alwaysBuildImplication _                  = False
<a name="line-1388"></a>-}</span>
<a name="line-1389"></a>
<a name="line-1390"></a><a name="buildImplicationFor"></a><span class='hs-definition'>buildImplicationFor</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1391"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-1392"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcEvBinds</span><span class='hs-layout'>)</span>
<a name="line-1393"></a><span class='hs-definition'>buildImplicationFor</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>given</span> <span class='hs-varid'>wanted</span>
<a name="line-1394"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyWC</span> <span class='hs-varid'>wanted</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>given</span>
<a name="line-1395"></a>             <span class='hs-comment'>-- Optimisation : if there are no wanteds, and no givens</span>
<a name="line-1396"></a>             <span class='hs-comment'>-- don't generate an implication at all.</span>
<a name="line-1397"></a>             <span class='hs-comment'>-- Reason for the (null given): we don't want to lose</span>
<a name="line-1398"></a>             <span class='hs-comment'>-- the "inaccessible alternative" error check</span>
<a name="line-1399"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyTcEvBinds</span><span class='hs-layout'>)</span>
<a name="line-1400"></a>
<a name="line-1401"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1402"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSkolemTyVar</span> <span class='hs-varop'>&lt;||&gt;</span> <span class='hs-varid'>isTyVarTyVar</span><span class='hs-layout'>)</span> <span class='hs-varid'>skol_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-layout'>)</span>
<a name="line-1403"></a>      <span class='hs-comment'>-- Why allow TyVarTvs? Because implicitly declared kind variables in</span>
<a name="line-1404"></a>      <span class='hs-comment'>-- non-CUSK type declarations are TyVarTvs, and we need to bring them</span>
<a name="line-1405"></a>      <span class='hs-comment'>-- into scope as a skolem in an implication. This is OK, though,</span>
<a name="line-1406"></a>      <span class='hs-comment'>-- because TyVarTvs will always remain tyvars, even after unification.</span>
<a name="line-1407"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTcEvBinds</span>
<a name="line-1408"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>implic</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newImplication</span>
<a name="line-1409"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>implic'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_tclvl</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tclvl</span>
<a name="line-1410"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>ic_skols</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-1411"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given</span>
<a name="line-1412"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanted</span>
<a name="line-1413"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>ic_binds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-1414"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_info</span> <span class='hs-layout'>}</span>
<a name="line-1415"></a>
<a name="line-1416"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitBag</span> <span class='hs-varid'>implic'</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-varid'>ev_binds_var</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1417"></a>
<a name="line-1418"></a><span class='hs-comment'>{- Note [When to build an implication]
<a name="line-1419"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1420"></a>Suppose we have some 'skolems' and some 'givens', and we are
<a name="line-1421"></a>considering whether to wrap the constraints in their scope into an
<a name="line-1422"></a>implication.  We must /always/ so if either 'skolems' or 'givens' are
<a name="line-1423"></a>non-empty.  But what if both are empty?  You might think we could
<a name="line-1424"></a>always drop the implication.  Other things being equal, the fewer
<a name="line-1425"></a>implications the better.  Less clutter and overhead.  But we must
<a name="line-1426"></a>take care:
<a name="line-1427"></a>
<a name="line-1428"></a>* If we have an unsolved [W] g :: a ~# b, and -fdefer-type-errors,
<a name="line-1429"></a>  we'll make a /term-level/ evidence binding for 'g = error "blah"'.
<a name="line-1430"></a>  We must have an EvBindsVar those bindings!, otherwise they end up as
<a name="line-1431"></a>  top-level unlifted bindings, which are verboten. This only matters
<a name="line-1432"></a>  at top level, so we check for that
<a name="line-1433"></a>  See also Note [Deferred errors for coercion holes] in GHC.Tc.Errors.
<a name="line-1434"></a>  cf #14149 for an example of what goes wrong.
<a name="line-1435"></a>
<a name="line-1436"></a>* If you have
<a name="line-1437"></a>     f :: Int;  f = f_blah
<a name="line-1438"></a>     g :: Bool; g = g_blah
<a name="line-1439"></a>  If we don't build an implication for f or g (no tyvars, no givens),
<a name="line-1440"></a>  the constraints for f_blah and g_blah are solved together.  And that
<a name="line-1441"></a>  can yield /very/ confusing error messages, because we can get
<a name="line-1442"></a>      [W] C Int b1    -- from f_blah
<a name="line-1443"></a>      [W] C Int b2    -- from g_blan
<a name="line-1444"></a>  and fundpes can yield [D] b1 ~ b2, even though the two functions have
<a name="line-1445"></a>  literally nothing to do with each other.  #14185 is an example.
<a name="line-1446"></a>  Building an implication keeps them separate.
<a name="line-1447"></a>-}</span>
<a name="line-1448"></a>
<a name="line-1449"></a><span class='hs-comment'>{-
<a name="line-1450"></a>************************************************************************
<a name="line-1451"></a>*                                                                      *
<a name="line-1452"></a>                Boxy unification
<a name="line-1453"></a>*                                                                      *
<a name="line-1454"></a>************************************************************************
<a name="line-1455"></a>
<a name="line-1456"></a>The exported functions are all defined as versions of some
<a name="line-1457"></a>non-exported generic functions.
<a name="line-1458"></a>-}</span>
<a name="line-1459"></a>
<a name="line-1460"></a><a name="unifyType"></a><span class='hs-definition'>unifyType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SDoc</span>  <span class='hs-comment'>-- ^ If present, the thing that has type ty1</span>
<a name="line-1461"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTauType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTauType</span>    <span class='hs-comment'>-- ty1, ty2</span>
<a name="line-1462"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcCoercionN</span>           <span class='hs-comment'>-- :: ty1 ~# ty2</span>
<a name="line-1463"></a><span class='hs-comment'>-- Actual and expected types</span>
<a name="line-1464"></a><span class='hs-comment'>-- Returns a coercion : ty1 ~ ty2</span>
<a name="line-1465"></a><span class='hs-definition'>unifyType</span> <span class='hs-varid'>thing</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1466"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uType</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1467"></a>  <span class='hs-keyword'>where</span>
<a name="line-1468"></a>    <span class='hs-varid'>origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty1</span>
<a name="line-1469"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty2</span>
<a name="line-1470"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>uo_thing</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>thing</span>
<a name="line-1471"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>uo_visible</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span>
<a name="line-1472"></a>
<a name="line-1473"></a><a name="unifyTypeET"></a><span class='hs-definition'>unifyTypeET</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTauType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTauType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>CoercionN</span>
<a name="line-1474"></a><span class='hs-comment'>-- Like unifyType, but swap expected and actual in error messages</span>
<a name="line-1475"></a><span class='hs-comment'>-- This is used when typechecking patterns</span>
<a name="line-1476"></a><span class='hs-definition'>unifyTypeET</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1477"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uType</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1478"></a>  <span class='hs-keyword'>where</span>
<a name="line-1479"></a>    <span class='hs-varid'>origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty2</span>   <span class='hs-comment'>-- NB swapped</span>
<a name="line-1480"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty1</span>   <span class='hs-comment'>-- NB swapped</span>
<a name="line-1481"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>uo_thing</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1482"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>uo_visible</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span>
<a name="line-1483"></a>
<a name="line-1484"></a>
<a name="line-1485"></a><a name="unifyKind"></a><span class='hs-definition'>unifyKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>CoercionN</span>
<a name="line-1486"></a><span class='hs-definition'>unifyKind</span> <span class='hs-varid'>mb_thing</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1487"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uType</span> <span class='hs-conid'>KindLevel</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1488"></a>  <span class='hs-keyword'>where</span>
<a name="line-1489"></a>    <span class='hs-varid'>origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty1</span>
<a name="line-1490"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty2</span>
<a name="line-1491"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>uo_thing</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_thing</span>
<a name="line-1492"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>uo_visible</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span>
<a name="line-1493"></a>
<a name="line-1494"></a>
<a name="line-1495"></a><span class='hs-comment'>{-
<a name="line-1496"></a>%************************************************************************
<a name="line-1497"></a>%*                                                                      *
<a name="line-1498"></a>                 uType and friends
<a name="line-1499"></a>%*                                                                      *
<a name="line-1500"></a>%************************************************************************
<a name="line-1501"></a>
<a name="line-1502"></a>uType is the heart of the unifier.
<a name="line-1503"></a>-}</span>
<a name="line-1504"></a>
<a name="line-1505"></a><a name="uType"></a><span class='hs-definition'>uType</span><span class='hs-layout'>,</span> <span class='hs-varid'>uType_defer</span>
<a name="line-1506"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeOrKind</span>
<a name="line-1507"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-1508"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>    <span class='hs-comment'>-- ty1 is the *actual* type</span>
<a name="line-1509"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>    <span class='hs-comment'>-- ty2 is the *expected* type</span>
<a name="line-1510"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>CoercionN</span>
<a name="line-1511"></a>
<a name="line-1512"></a><a name="uType_defer"></a><span class='hs-comment'>--------------</span>
<a name="line-1513"></a><span class='hs-comment'>-- It is always safe to defer unification to the main constraint solver</span>
<a name="line-1514"></a><span class='hs-comment'>-- See Note [Deferred unification]</span>
<a name="line-1515"></a><span class='hs-definition'>uType_defer</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1516"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>emitWantedEq</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1517"></a>
<a name="line-1518"></a>       <span class='hs-comment'>-- Error trace only</span>
<a name="line-1519"></a>       <span class='hs-comment'>-- NB. do *not* call mkErrInfo unless tracing is on,</span>
<a name="line-1520"></a>       <span class='hs-comment'>--     because it is hugely expensive (#5631)</span>
<a name="line-1521"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>whenDOptM</span> <span class='hs-conid'>Opt_D_dump_tc_trace</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1522"></a>            <span class='hs-layout'>{</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getErrCtxt</span>
<a name="line-1523"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkErrInfo</span> <span class='hs-varid'>emptyTidyEnv</span> <span class='hs-varid'>ctxt</span>
<a name="line-1524"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"utype_defer"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>debugPprType</span> <span class='hs-varid'>ty1</span>
<a name="line-1525"></a>                                          <span class='hs-layout'>,</span> <span class='hs-varid'>debugPprType</span> <span class='hs-varid'>ty2</span>
<a name="line-1526"></a>                                          <span class='hs-layout'>,</span> <span class='hs-varid'>pprCtOrigin</span> <span class='hs-varid'>origin</span>
<a name="line-1527"></a>                                          <span class='hs-layout'>,</span> <span class='hs-varid'>doc</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1528"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"utype_defer2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1529"></a>            <span class='hs-layout'>}</span>
<a name="line-1530"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>co</span> <span class='hs-layout'>}</span>
<a name="line-1531"></a>
<a name="line-1532"></a><span class='hs-comment'>--------------</span>
<a name="line-1533"></a><span class='hs-definition'>uType</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>orig_ty1</span> <span class='hs-varid'>orig_ty2</span>
<a name="line-1534"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tclvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcLevel</span>
<a name="line-1535"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"u_tys"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span>
<a name="line-1536"></a>              <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tclvl"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tclvl</span>
<a name="line-1537"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"~"</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-1538"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>pprCtOrigin</span> <span class='hs-varid'>origin</span><span class='hs-keyglyph'>]</span>
<a name="line-1539"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>orig_ty1</span> <span class='hs-varid'>orig_ty2</span>
<a name="line-1540"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isReflCo</span> <span class='hs-varid'>co</span>
<a name="line-1541"></a>            <span class='hs-keyword'>then</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"u_tys yields no coercion"</span> <span class='hs-conid'>Outputable.empty</span>
<a name="line-1542"></a>            <span class='hs-keyword'>else</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"u_tys yields coercion:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1543"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>co</span> <span class='hs-layout'>}</span>
<a name="line-1544"></a>  <span class='hs-keyword'>where</span>
<a name="line-1545"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>CoercionN</span>
<a name="line-1546"></a>        <span class='hs-comment'>-- The arguments to 'go' are always semantically identical</span>
<a name="line-1547"></a>        <span class='hs-comment'>-- to orig_ty{1,2} except for looking through type synonyms</span>
<a name="line-1548"></a>
<a name="line-1549"></a>     <span class='hs-comment'>-- Unwrap casts before looking for variables. This way, we can easily</span>
<a name="line-1550"></a>     <span class='hs-comment'>-- recognize (t |&gt; co) ~ (t |&gt; co), which is nice. Previously, we</span>
<a name="line-1551"></a>     <span class='hs-comment'>-- didn't do it this way, and then the unification above was deferred.</span>
<a name="line-1552"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varid'>t2</span>
<a name="line-1553"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-1554"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoherenceLeftCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co_tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1555"></a>
<a name="line-1556"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>t1</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>t2</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1557"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-1558"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoherenceRightCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>t2</span> <span class='hs-varid'>co2</span> <span class='hs-varid'>co_tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1559"></a>
<a name="line-1560"></a>        <span class='hs-comment'>-- Variables; go for uUnfilledVar</span>
<a name="line-1561"></a>        <span class='hs-comment'>-- Note that we pass in *original* (before synonym expansion),</span>
<a name="line-1562"></a>        <span class='hs-comment'>-- so that type variables tend to get filled in with</span>
<a name="line-1563"></a>        <span class='hs-comment'>-- the most informative version of the type</span>
<a name="line-1564"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-1565"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lookup_res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isFilledMetaTyVar_maybe</span> <span class='hs-varid'>tv1</span>
<a name="line-1566"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookup_res</span> <span class='hs-keyword'>of</span>
<a name="line-1567"></a>               <span class='hs-conid'>Just</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"found filled tyvar"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>":-&gt;"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span>
<a name="line-1568"></a>                                <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>}</span>
<a name="line-1569"></a>               <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uUnfilledVar</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-conid'>NotSwapped</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>}</span>
<a name="line-1570"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span>
<a name="line-1571"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lookup_res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isFilledMetaTyVar_maybe</span> <span class='hs-varid'>tv2</span>
<a name="line-1572"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookup_res</span> <span class='hs-keyword'>of</span>
<a name="line-1573"></a>               <span class='hs-conid'>Just</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"found filled tyvar"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv2</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>":-&gt;"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-1574"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>}</span>
<a name="line-1575"></a>               <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uUnfilledVar</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-conid'>IsSwapped</span> <span class='hs-varid'>tv2</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>}</span>
<a name="line-1576"></a>
<a name="line-1577"></a>      <span class='hs-comment'>-- See Note [Expanding synonyms during unification]</span>
<a name="line-1578"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc2</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-1579"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span>
<a name="line-1580"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>ty1</span>
<a name="line-1581"></a>
<a name="line-1582"></a>        <span class='hs-comment'>-- See Note [Expanding synonyms during unification]</span>
<a name="line-1583"></a>        <span class='hs-comment'>--</span>
<a name="line-1584"></a>        <span class='hs-comment'>-- Also NB that we recurse to 'go' so that we don't push a</span>
<a name="line-1585"></a>        <span class='hs-comment'>-- new item on the origin stack. As a result if we have</span>
<a name="line-1586"></a>        <span class='hs-comment'>--   type Foo = Int</span>
<a name="line-1587"></a>        <span class='hs-comment'>-- and we try to unify  Foo ~ Bool</span>
<a name="line-1588"></a>        <span class='hs-comment'>-- we'll end up saying "can't match Foo with Bool"</span>
<a name="line-1589"></a>        <span class='hs-comment'>-- rather than "can't match "Int with Bool".  See #4535.</span>
<a name="line-1590"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1591"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2</span>
<a name="line-1592"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span>  <span class='hs-varid'>ty2'</span>
<a name="line-1593"></a>
<a name="line-1594"></a>    <span class='hs-comment'>-- Functions (t1 -&gt; t2) just check the two parts</span>
<a name="line-1595"></a>    <span class='hs-comment'>-- Do not attempt (c =&gt; t); just defer</span>
<a name="line-1596"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_af</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VisArg</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_mult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1597"></a>       <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_af</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VisArg</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_mult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1598"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>arg1</span> <span class='hs-varid'>arg2</span>
<a name="line-1599"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>co_r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>res1</span> <span class='hs-varid'>res2</span>
<a name="line-1600"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>co_w</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>w1</span> <span class='hs-varid'>w2</span>
<a name="line-1601"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkFunCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>co_w</span> <span class='hs-varid'>co_l</span> <span class='hs-varid'>co_r</span> <span class='hs-layout'>}</span>
<a name="line-1602"></a>
<a name="line-1603"></a>        <span class='hs-comment'>-- Always defer if a type synonym family (type function)</span>
<a name="line-1604"></a>        <span class='hs-comment'>-- is involved.  (Data families behave rigidly.)</span>
<a name="line-1605"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-1606"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTypeFamilyTyCon</span> <span class='hs-varid'>tc1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1607"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc2</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-1608"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTypeFamilyTyCon</span> <span class='hs-varid'>tc2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1609"></a>
<a name="line-1610"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span>
<a name="line-1611"></a>      <span class='hs-comment'>-- See Note [Mismatched type lists and application decomposition]</span>
<a name="line-1612"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span><span class='hs-layout'>,</span> <span class='hs-varid'>equalLength</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span>
<a name="line-1613"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isGenerativeTyCon</span> <span class='hs-varid'>tc1</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc1</span> <span class='hs-layout'>)</span>
<a name="line-1614"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWith3M</span> <span class='hs-layout'>(</span><span class='hs-varid'>uType</span> <span class='hs-varid'>t_or_k</span><span class='hs-layout'>)</span> <span class='hs-varid'>origins'</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span>
<a name="line-1615"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>cos</span> <span class='hs-layout'>}</span>
<a name="line-1616"></a>      <span class='hs-keyword'>where</span>
<a name="line-1617"></a>        <span class='hs-varid'>origins'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>is_vis</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>is_vis</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>origin</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>toInvisibleOrigin</span> <span class='hs-varid'>origin</span><span class='hs-layout'>)</span>
<a name="line-1618"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>tcTyConVisibilities</span> <span class='hs-varid'>tc1</span><span class='hs-layout'>)</span>
<a name="line-1619"></a>
<a name="line-1620"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-1621"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>m</span> <span class='hs-varop'>==</span> <span class='hs-varid'>n</span>
<a name="line-1622"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>ty</span>
<a name="line-1623"></a>
<a name="line-1624"></a>        <span class='hs-comment'>-- See Note [Care with type applications]</span>
<a name="line-1625"></a>        <span class='hs-comment'>-- Do not decompose FunTy against App;</span>
<a name="line-1626"></a>        <span class='hs-comment'>-- it's often a type error, so leave it for the constraint solver</span>
<a name="line-1627"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-1628"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_app</span> <span class='hs-layout'>(</span><span class='hs-varid'>isNextArgVisible</span> <span class='hs-varid'>s1</span><span class='hs-layout'>)</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>t2</span>
<a name="line-1629"></a>
<a name="line-1630"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>ts2</span><span class='hs-layout'>)</span>
<a name="line-1631"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ts2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>snocView</span> <span class='hs-varid'>ts2</span>
<a name="line-1632"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>mustBeSaturated</span> <span class='hs-varid'>tc2</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-1633"></a>        <span class='hs-varid'>go_app</span> <span class='hs-layout'>(</span><span class='hs-varid'>isNextTyConArgVisible</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>ts2'</span><span class='hs-layout'>)</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>t1</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>ts2'</span><span class='hs-layout'>)</span> <span class='hs-varid'>t2'</span>
<a name="line-1634"></a>
<a name="line-1635"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>ts1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-1636"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ts1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>t1'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>snocView</span> <span class='hs-varid'>ts1</span>
<a name="line-1637"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>mustBeSaturated</span> <span class='hs-varid'>tc1</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-1638"></a>        <span class='hs-varid'>go_app</span> <span class='hs-layout'>(</span><span class='hs-varid'>isNextTyConArgVisible</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>ts1'</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>ts1'</span><span class='hs-layout'>)</span> <span class='hs-varid'>t1'</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>t2</span>
<a name="line-1639"></a>
<a name="line-1640"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1641"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionType</span> <span class='hs-varid'>co1</span>
<a name="line-1642"></a>                 <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionType</span> <span class='hs-varid'>co2</span>
<a name="line-1643"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>kco</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-conid'>KindLevel</span>
<a name="line-1644"></a>                          <span class='hs-layout'>(</span><span class='hs-conid'>KindEqOrigin</span> <span class='hs-varid'>orig_ty1</span> <span class='hs-varid'>orig_ty2</span> <span class='hs-varid'>origin</span>
<a name="line-1645"></a>                                        <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>t_or_k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1646"></a>                          <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1647"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkProofIrrelCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>kco</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-layout'>}</span>
<a name="line-1648"></a>
<a name="line-1649"></a>        <span class='hs-comment'>-- Anything else fails</span>
<a name="line-1650"></a>        <span class='hs-comment'>-- E.g. unifying for-all types, which is relative unusual</span>
<a name="line-1651"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1652"></a>
<a name="line-1653"></a>    <span class='hs-comment'>------------------</span>
<a name="line-1654"></a>    <span class='hs-varid'>defer</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>   <span class='hs-comment'>-- See Note [Check for equality before deferring]</span>
<a name="line-1655"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`tcEqType`</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span>
<a name="line-1656"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uType_defer</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1657"></a>
<a name="line-1658"></a>    <span class='hs-comment'>------------------</span>
<a name="line-1659"></a>    <span class='hs-varid'>go_app</span> <span class='hs-varid'>vis</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>t2</span>
<a name="line-1660"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span>
<a name="line-1661"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arg_origin</span>
<a name="line-1662"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>vis</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>origin</span>
<a name="line-1663"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toInvisibleOrigin</span> <span class='hs-varid'>origin</span>
<a name="line-1664"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>co_t</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>arg_origin</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-1665"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkAppCo</span> <span class='hs-varid'>co_s</span> <span class='hs-varid'>co_t</span> <span class='hs-layout'>}</span>
<a name="line-1666"></a>
<a name="line-1667"></a><span class='hs-comment'>{- Note [Check for equality before deferring]
<a name="line-1668"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1669"></a>Particularly in ambiguity checks we can get equalities like (ty ~ ty).
<a name="line-1670"></a>If ty involves a type function we may defer, which isn't very sensible.
<a name="line-1671"></a>An egregious example of this was in test T9872a, which has a type signature
<a name="line-1672"></a>       Proxy :: Proxy (Solutions Cubes)
<a name="line-1673"></a>Doing the ambiguity check on this signature generates the equality
<a name="line-1674"></a>   Solutions Cubes ~ Solutions Cubes
<a name="line-1675"></a>and currently the constraint solver normalises both sides at vast cost.
<a name="line-1676"></a>This little short-cut in 'defer' helps quite a bit.
<a name="line-1677"></a>
<a name="line-1678"></a>Note [Care with type applications]
<a name="line-1679"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1680"></a>Note: type applications need a bit of care!
<a name="line-1681"></a>They can match FunTy and TyConApp, so use splitAppTy_maybe
<a name="line-1682"></a>NB: we've already dealt with type variables and Notes,
<a name="line-1683"></a>so if one type is an App the other one jolly well better be too
<a name="line-1684"></a>
<a name="line-1685"></a>Note [Mismatched type lists and application decomposition]
<a name="line-1686"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1687"></a>When we find two TyConApps, you might think that the argument lists
<a name="line-1688"></a>are guaranteed equal length.  But they aren't. Consider matching
<a name="line-1689"></a>        w (T x) ~ Foo (T x y)
<a name="line-1690"></a>We do match (w ~ Foo) first, but in some circumstances we simply create
<a name="line-1691"></a>a deferred constraint; and then go ahead and match (T x ~ T x y).
<a name="line-1692"></a>This came up in #3950.
<a name="line-1693"></a>
<a name="line-1694"></a>So either
<a name="line-1695"></a>   (a) either we must check for identical argument kinds
<a name="line-1696"></a>       when decomposing applications,
<a name="line-1697"></a>
<a name="line-1698"></a>   (b) or we must be prepared for ill-kinded unification sub-problems
<a name="line-1699"></a>
<a name="line-1700"></a>Currently we adopt (b) since it seems more robust -- no need to maintain
<a name="line-1701"></a>a global invariant.
<a name="line-1702"></a>
<a name="line-1703"></a>Note [Expanding synonyms during unification]
<a name="line-1704"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1705"></a>We expand synonyms during unification, but:
<a name="line-1706"></a> * We expand *after* the variable case so that we tend to unify
<a name="line-1707"></a>   variables with un-expanded type synonym. This just makes it
<a name="line-1708"></a>   more likely that the inferred types will mention type synonyms
<a name="line-1709"></a>   understandable to the user
<a name="line-1710"></a>
<a name="line-1711"></a> * Similarly, we expand *after* the CastTy case, just in case the
<a name="line-1712"></a>   CastTy wraps a variable.
<a name="line-1713"></a>
<a name="line-1714"></a> * We expand *before* the TyConApp case.  For example, if we have
<a name="line-1715"></a>      type Phantom a = Int
<a name="line-1716"></a>   and are unifying
<a name="line-1717"></a>      Phantom Int ~ Phantom Char
<a name="line-1718"></a>   it is *wrong* to unify Int and Char.
<a name="line-1719"></a>
<a name="line-1720"></a> * The problem case immediately above can happen only with arguments
<a name="line-1721"></a>   to the tycon. So we check for nullary tycons *before* expanding.
<a name="line-1722"></a>   This is particularly helpful when checking (* ~ *), because * is
<a name="line-1723"></a>   now a type synonym.
<a name="line-1724"></a>
<a name="line-1725"></a>Note [Deferred unification]
<a name="line-1726"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1727"></a>We may encounter a unification ty1 ~ ty2 that cannot be performed syntactically,
<a name="line-1728"></a>and yet its consistency is undetermined. Previously, there was no way to still
<a name="line-1729"></a>make it consistent. So a mismatch error was issued.
<a name="line-1730"></a>
<a name="line-1731"></a>Now these unifications are deferred until constraint simplification, where type
<a name="line-1732"></a>family instances and given equations may (or may not) establish the consistency.
<a name="line-1733"></a>Deferred unifications are of the form
<a name="line-1734"></a>                F ... ~ ...
<a name="line-1735"></a>or              x ~ ...
<a name="line-1736"></a>where F is a type function and x is a type variable.
<a name="line-1737"></a>E.g.
<a name="line-1738"></a>        id :: x ~ y =&gt; x -&gt; y
<a name="line-1739"></a>        id e = e
<a name="line-1740"></a>
<a name="line-1741"></a>involves the unification x = y. It is deferred until we bring into account the
<a name="line-1742"></a>context x ~ y to establish that it holds.
<a name="line-1743"></a>
<a name="line-1744"></a>If available, we defer original types (rather than those where closed type
<a name="line-1745"></a>synonyms have already been expanded via tcCoreView).  This is, as usual, to
<a name="line-1746"></a>improve error messages.
<a name="line-1747"></a>
<a name="line-1748"></a>
<a name="line-1749"></a>************************************************************************
<a name="line-1750"></a>*                                                                      *
<a name="line-1751"></a>                 uUnfilledVar and friends
<a name="line-1752"></a>*                                                                      *
<a name="line-1753"></a>************************************************************************
<a name="line-1754"></a>
<a name="line-1755"></a>@uunfilledVar@ is called when at least one of the types being unified is a
<a name="line-1756"></a>variable.  It does {\em not} assume that the variable is a fixed point
<a name="line-1757"></a>of the substitution; rather, notice that @uVar@ (defined below) nips
<a name="line-1758"></a>back into @uTys@ if it turns out that the variable is already bound.
<a name="line-1759"></a>-}</span>
<a name="line-1760"></a>
<a name="line-1761"></a><a name="uUnfilledVar"></a><span class='hs-comment'>----------</span>
<a name="line-1762"></a><span class='hs-definition'>uUnfilledVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-1763"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeOrKind</span>
<a name="line-1764"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SwapFlag</span>
<a name="line-1765"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span>        <span class='hs-comment'>-- Tyvar 1: not necessarily a meta-tyvar</span>
<a name="line-1766"></a>                               <span class='hs-comment'>--    definitely not a /filled/ meta-tyvar</span>
<a name="line-1767"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTauType</span>      <span class='hs-comment'>-- Type 2</span>
<a name="line-1768"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Coercion</span>
<a name="line-1769"></a><span class='hs-comment'>-- "Unfilled" means that the variable is definitely not a filled-in meta tyvar</span>
<a name="line-1770"></a><span class='hs-comment'>--            It might be a skolem, or untouchable, or meta</span>
<a name="line-1771"></a>
<a name="line-1772"></a><span class='hs-definition'>uUnfilledVar</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>swapped</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-1773"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty2</span>
<a name="line-1774"></a>             <span class='hs-comment'>-- Zonk to expose things to the</span>
<a name="line-1775"></a>             <span class='hs-comment'>-- occurs check, and so that if ty2</span>
<a name="line-1776"></a>             <span class='hs-comment'>-- looks like a type variable then it</span>
<a name="line-1777"></a>             <span class='hs-comment'>-- /is/ a type variable</span>
<a name="line-1778"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>uUnfilledVar1</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>swapped</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>}</span>
<a name="line-1779"></a>
<a name="line-1780"></a><a name="uUnfilledVar1"></a><span class='hs-comment'>----------</span>
<a name="line-1781"></a><span class='hs-definition'>uUnfilledVar1</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-1782"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeOrKind</span>
<a name="line-1783"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SwapFlag</span>
<a name="line-1784"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span>        <span class='hs-comment'>-- Tyvar 1: not necessarily a meta-tyvar</span>
<a name="line-1785"></a>                                <span class='hs-comment'>--    definitely not a /filled/ meta-tyvar</span>
<a name="line-1786"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTauType</span>      <span class='hs-comment'>-- Type 2, zonked</span>
<a name="line-1787"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Coercion</span>
<a name="line-1788"></a><span class='hs-definition'>uUnfilledVar1</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>swapped</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-1789"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>ty2</span>
<a name="line-1790"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tv2</span>
<a name="line-1791"></a>
<a name="line-1792"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1793"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uUnfilledVar2</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>swapped</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-1794"></a>
<a name="line-1795"></a>  <span class='hs-keyword'>where</span>
<a name="line-1796"></a>    <span class='hs-comment'>-- 'go' handles the case where both are</span>
<a name="line-1797"></a>    <span class='hs-comment'>-- tyvars so we might want to swap</span>
<a name="line-1798"></a>    <span class='hs-comment'>-- E.g. maybe tv2 is a meta-tyvar and tv1 is not</span>
<a name="line-1799"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>tv2</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tv2</span>  <span class='hs-comment'>-- Same type variable =&gt; no-op</span>
<a name="line-1800"></a>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNomReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1801"></a>
<a name="line-1802"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>swapOverTyVars</span> <span class='hs-conid'>False</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>tv2</span>   <span class='hs-comment'>-- Distinct type variables</span>
<a name="line-1803"></a>               <span class='hs-comment'>-- Swap meta tyvar to the left if poss</span>
<a name="line-1804"></a>           <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tv1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTyCoVarKind</span> <span class='hs-varid'>tv1</span>
<a name="line-1805"></a>                     <span class='hs-comment'>-- We must zonk tv1's kind because that might</span>
<a name="line-1806"></a>                     <span class='hs-comment'>-- not have happened yet, and it's an invariant of</span>
<a name="line-1807"></a>                     <span class='hs-comment'>-- uUnfilledTyVar2 that ty2 is fully zonked</span>
<a name="line-1808"></a>                     <span class='hs-comment'>-- Omitting this caused #16902</span>
<a name="line-1809"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>uUnfilledVar2</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-layout'>(</span><span class='hs-varid'>flipSwap</span> <span class='hs-varid'>swapped</span><span class='hs-layout'>)</span>
<a name="line-1810"></a>                           <span class='hs-varid'>tv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1811"></a>
<a name="line-1812"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1813"></a>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uUnfilledVar2</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>swapped</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-1814"></a>
<a name="line-1815"></a><a name="uUnfilledVar2"></a><span class='hs-comment'>----------</span>
<a name="line-1816"></a><span class='hs-definition'>uUnfilledVar2</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-1817"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeOrKind</span>
<a name="line-1818"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SwapFlag</span>
<a name="line-1819"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span>        <span class='hs-comment'>-- Tyvar 1: not necessarily a meta-tyvar</span>
<a name="line-1820"></a>                                <span class='hs-comment'>--    definitely not a /filled/ meta-tyvar</span>
<a name="line-1821"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTauType</span>      <span class='hs-comment'>-- Type 2, zonked</span>
<a name="line-1822"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Coercion</span>
<a name="line-1823"></a><span class='hs-definition'>uUnfilledVar2</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>swapped</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-1824"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-1825"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>cur_lvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcLevel</span>
<a name="line-1826"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>cur_lvl</span> <span class='hs-layout'>}</span>
<a name="line-1827"></a>  <span class='hs-keyword'>where</span>
<a name="line-1828"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>cur_lvl</span>
<a name="line-1829"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTouchableMetaTyVar</span> <span class='hs-varid'>cur_lvl</span> <span class='hs-varid'>tv1</span>
<a name="line-1830"></a>           <span class='hs-comment'>-- See Note [Unification preconditions], (UNTOUCHABLE) wrinkles</span>
<a name="line-1831"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>canSolveByUnification</span> <span class='hs-layout'>(</span><span class='hs-varid'>metaTyVarInfo</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-1832"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>cterHasNoProblem</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkTyVarEq</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-1833"></a>           <span class='hs-comment'>-- See Note [Prevent unification with type families]</span>
<a name="line-1834"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-conid'>KindLevel</span> <span class='hs-varid'>kind_origin</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcTypeKind</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span>
<a name="line-1835"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"uUnfilledVar2 ok"</span> <span class='hs-varop'>$</span>
<a name="line-1836"></a>             <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span>
<a name="line-1837"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcTypeKind</span>  <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-1838"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTcReflCo</span> <span class='hs-varid'>co_k</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co_k</span> <span class='hs-keyglyph'>]</span>
<a name="line-1839"></a>
<a name="line-1840"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isTcReflCo</span> <span class='hs-varid'>co_k</span>
<a name="line-1841"></a>               <span class='hs-comment'>-- Only proceed if the kinds match</span>
<a name="line-1842"></a>               <span class='hs-comment'>-- NB: tv1 should still be unfilled, despite the kind unification</span>
<a name="line-1843"></a>               <span class='hs-comment'>--     because tv1 is not free in ty2 (or, hence, in its kind)</span>
<a name="line-1844"></a>             <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-1845"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcNomReflCo</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1846"></a>
<a name="line-1847"></a>             <span class='hs-keyword'>else</span> <span class='hs-varid'>defer</span> <span class='hs-layout'>}</span> <span class='hs-comment'>-- This cannot be solved now.  See GHC.Tc.Solver.Canonical</span>
<a name="line-1848"></a>                          <span class='hs-comment'>-- Note [Equalities with incompatible kinds]</span>
<a name="line-1849"></a>
<a name="line-1850"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1851"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"uUnfilledVar2 not ok"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-1852"></a>               <span class='hs-comment'>-- Occurs check or an untouchable: just defer</span>
<a name="line-1853"></a>               <span class='hs-comment'>-- NB: occurs check isn't necessarily fatal:</span>
<a name="line-1854"></a>               <span class='hs-comment'>--     eg tv1 occurred in type family parameter</span>
<a name="line-1855"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>defer</span> <span class='hs-layout'>}</span>
<a name="line-1856"></a>
<a name="line-1857"></a>    <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv1</span>
<a name="line-1858"></a>    <span class='hs-varid'>kind_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>KindEqOrigin</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>origin</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>t_or_k</span><span class='hs-layout'>)</span>
<a name="line-1859"></a>
<a name="line-1860"></a>    <span class='hs-varid'>defer</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unSwap</span> <span class='hs-varid'>swapped</span> <span class='hs-layout'>(</span><span class='hs-varid'>uType_defer</span> <span class='hs-varid'>t_or_k</span> <span class='hs-varid'>origin</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1861"></a>
<a name="line-1862"></a><a name="canSolveByUnification"></a><span class='hs-definition'>canSolveByUnification</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MetaInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1863"></a><span class='hs-comment'>-- See Note [Unification preconditions, (TYVAR-TV)]</span>
<a name="line-1864"></a><span class='hs-definition'>canSolveByUnification</span> <span class='hs-varid'>info</span> <span class='hs-varid'>xi</span>
<a name="line-1865"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>info</span> <span class='hs-keyword'>of</span>
<a name="line-1866"></a>      <span class='hs-conid'>CycleBreakerTv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1867"></a>      <span class='hs-conid'>TyVarTv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>xi</span> <span class='hs-keyword'>of</span>
<a name="line-1868"></a>                   <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1869"></a>                   <span class='hs-conid'>Just</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-1870"></a>                                 <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span> <span class='hs-layout'>}</span>
<a name="line-1871"></a>                                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>info</span> <span class='hs-keyword'>of</span>
<a name="line-1872"></a>                                                 <span class='hs-conid'>TyVarTv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1873"></a>                                                 <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1874"></a>                                 <span class='hs-conid'>SkolemTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1875"></a>                                 <span class='hs-conid'>RuntimeUnk</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1876"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1877"></a>
<a name="line-1878"></a><a name="swapOverTyVars"></a><span class='hs-definition'>swapOverTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1879"></a><span class='hs-definition'>swapOverTyVars</span> <span class='hs-varid'>is_given</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>tv2</span>
<a name="line-1880"></a>  <span class='hs-comment'>-- See Note [Unification variables on the left]</span>
<a name="line-1881"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>is_given</span><span class='hs-layout'>,</span> <span class='hs-varid'>pri1</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-varid'>pri2</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1882"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>is_given</span><span class='hs-layout'>,</span> <span class='hs-varid'>pri2</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-varid'>pri1</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1883"></a>
<a name="line-1884"></a>  <span class='hs-comment'>-- Level comparison: see Note [TyVar/TyVar orientation]</span>
<a name="line-1885"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>lvl1</span> <span class='hs-varop'>`strictlyDeeperThan`</span> <span class='hs-varid'>lvl2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1886"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>lvl2</span> <span class='hs-varop'>`strictlyDeeperThan`</span> <span class='hs-varid'>lvl1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1887"></a>
<a name="line-1888"></a>  <span class='hs-comment'>-- Priority: see Note [TyVar/TyVar orientation]</span>
<a name="line-1889"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>pri1</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>pri2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1890"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>pri2</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>pri1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1891"></a>
<a name="line-1892"></a>  <span class='hs-comment'>-- Names: see Note [TyVar/TyVar orientation]</span>
<a name="line-1893"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSystemName</span> <span class='hs-varid'>tv2_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSystemName</span> <span class='hs-varid'>tv1_name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1894"></a>
<a name="line-1895"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1896"></a>
<a name="line-1897"></a>  <span class='hs-keyword'>where</span>
<a name="line-1898"></a>    <span class='hs-varid'>lvl1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyVarLevel</span> <span class='hs-varid'>tv1</span>
<a name="line-1899"></a>    <span class='hs-varid'>lvl2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyVarLevel</span> <span class='hs-varid'>tv2</span>
<a name="line-1900"></a>    <span class='hs-varid'>pri1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhsPriority</span> <span class='hs-varid'>tv1</span>
<a name="line-1901"></a>    <span class='hs-varid'>pri2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhsPriority</span> <span class='hs-varid'>tv2</span>
<a name="line-1902"></a>    <span class='hs-varid'>tv1_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var.varName</span> <span class='hs-varid'>tv1</span>
<a name="line-1903"></a>    <span class='hs-varid'>tv2_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var.varName</span> <span class='hs-varid'>tv2</span>
<a name="line-1904"></a>
<a name="line-1905"></a>
<a name="line-1906"></a><a name="lhsPriority"></a><span class='hs-definition'>lhsPriority</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-1907"></a><span class='hs-comment'>-- Higher =&gt; more important to be on the LHS</span>
<a name="line-1908"></a><span class='hs-comment'>--        =&gt; more likely to be eliminated</span>
<a name="line-1909"></a><span class='hs-comment'>-- See Note [TyVar/TyVar orientation]</span>
<a name="line-1910"></a><span class='hs-definition'>lhsPriority</span> <span class='hs-varid'>tv</span>
<a name="line-1911"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-1912"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-1913"></a>      <span class='hs-conid'>RuntimeUnk</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>0</span>
<a name="line-1914"></a>      <span class='hs-conid'>SkolemTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>0</span>
<a name="line-1915"></a>      <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>info</span> <span class='hs-keyword'>of</span>
<a name="line-1916"></a>                                     <span class='hs-conid'>CycleBreakerTv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>0</span>
<a name="line-1917"></a>                                     <span class='hs-conid'>TyVarTv</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>1</span>
<a name="line-1918"></a>                                     <span class='hs-conid'>TauTv</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>2</span>
<a name="line-1919"></a>                                     <span class='hs-conid'>RuntimeUnkTv</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>3</span>
<a name="line-1920"></a>
<a name="line-1921"></a><span class='hs-comment'>{- Note [Unification preconditions]
<a name="line-1922"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1923"></a>Question: given a homogeneous equality (alpha ~# ty), when is it OK to
<a name="line-1924"></a>unify alpha := ty?
<a name="line-1925"></a>
<a name="line-1926"></a>This note only applied to /homogeneous/ equalities, in which both
<a name="line-1927"></a>sides have the same kind.
<a name="line-1928"></a>
<a name="line-1929"></a>There are three reasons not to unify:
<a name="line-1930"></a>
<a name="line-1931"></a>1. (SKOL-ESC) Skolem-escape
<a name="line-1932"></a>   Consider the constraint
<a name="line-1933"></a>        forall[2] a[2]. alpha[1] ~ Maybe a[2]
<a name="line-1934"></a>   If we unify alpha := Maybe a, the skolem 'a' may escape its scope.
<a name="line-1935"></a>   The level alpha[1] says that alpha may be used outside this constraint,
<a name="line-1936"></a>   where 'a' is not in scope at all.  So we must not unify.
<a name="line-1937"></a>
<a name="line-1938"></a>   Bottom line: when looking at a constraint alpha[n] := ty, do not unify
<a name="line-1939"></a>   if any free variable of 'ty' has level deeper (greater) than n
<a name="line-1940"></a>
<a name="line-1941"></a>2. (UNTOUCHABLE) Untouchable unification variables
<a name="line-1942"></a>   Consider the constraint
<a name="line-1943"></a>        forall[2] a[2]. b[1] ~ Int =&gt; alpha[1] ~ Int
<a name="line-1944"></a>   There is no (SKOL-ESC) problem with unifying alpha := Int, but it might
<a name="line-1945"></a>   not be the principal solution. Perhaps the "right" solution is alpha := b.
<a name="line-1946"></a>   We simply can't tell.  See "OutsideIn(X): modular type inference with local
<a name="line-1947"></a>   assumptions", section 2.2.  We say that alpha[1] is "untouchable" inside
<a name="line-1948"></a>   this implication.
<a name="line-1949"></a>
<a name="line-1950"></a>   Bottom line: at amibient level 'l', when looking at a constraint
<a name="line-1951"></a>   alpha[n] ~ ty, do not unify alpha := ty if there are any given equalities
<a name="line-1952"></a>   between levels 'n' and 'l'.
<a name="line-1953"></a>
<a name="line-1954"></a>   Exactly what is a "given equality" for the purpose of (UNTOUCHABLE)?
<a name="line-1955"></a>   Answer: see Note [Tracking Given equalities] in GHC.Tc.Solver.Monad
<a name="line-1956"></a>
<a name="line-1957"></a>3. (TYVAR-TV) Unifying TyVarTvs and CycleBreakerTvs
<a name="line-1958"></a>   This precondition looks at the MetaInfo of the unification variable:
<a name="line-1959"></a>
<a name="line-1960"></a>   * TyVarTv: When considering alpha{tyv} ~ ty, if alpha{tyv} is a
<a name="line-1961"></a>     TyVarTv it can only unify with a type variable, not with a
<a name="line-1962"></a>     structured type.  So if 'ty' is a structured type, such as (Maybe x),
<a name="line-1963"></a>     don't unify.
<a name="line-1964"></a>
<a name="line-1965"></a>   * CycleBreakerTv: never unified, except by restoreTyVarCycles.
<a name="line-1966"></a>
<a name="line-1967"></a>
<a name="line-1968"></a>Needless to say, all three have wrinkles:
<a name="line-1969"></a>
<a name="line-1970"></a>* (SKOL-ESC) Promotion.  Given alpha[n] ~ ty, what if beta[k] is free
<a name="line-1971"></a>  in 'ty', where beta is a unification variable, and k&gt;n?  'beta'
<a name="line-1972"></a>  stands for a monotype, and since it is part of a level-n type
<a name="line-1973"></a>  (equal to alpha[n]), we must /promote/ beta to level n.  Just make
<a name="line-1974"></a>  up a fresh gamma[n], and unify beta[k] := gamma[n].
<a name="line-1975"></a>
<a name="line-1976"></a>* (TYVAR-TV) Unification variables.  Suppose alpha[tyv,n] is a level-n
<a name="line-1977"></a>  TyVarTv (see Note [TyVarTv] in GHC.Tc.Types.TcMType)? Now
<a name="line-1978"></a>  consider alpha[tyv,n] ~ Bool.  We don't want to unify because that
<a name="line-1979"></a>  would break the TyVarTv invariant.
<a name="line-1980"></a>
<a name="line-1981"></a>  What about alpha[tyv,n] ~ beta[tau,n], where beta is an ordinary
<a name="line-1982"></a>  TauTv?  Again, don't unify, because beta might later be unified
<a name="line-1983"></a>  with, say Bool.  (If levels permit, we reverse the orientation here;
<a name="line-1984"></a>  see Note [TyVar/TyVar orientation].)
<a name="line-1985"></a>
<a name="line-1986"></a>* (UNTOUCHABLE) Untouchability.  When considering (alpha[n] ~ ty), how
<a name="line-1987"></a>  do we know whether there are any given equalities between level n
<a name="line-1988"></a>  and the ambient level?  We answer in two ways:
<a name="line-1989"></a>
<a name="line-1990"></a>  * In the eager unifier, we only unify if l=n.  If not, alpha may be
<a name="line-1991"></a>    untouchable, and defer to the constraint solver.  This check is
<a name="line-1992"></a>    made in GHC.Tc.Utils.uUnifilledVar2, in the guard
<a name="line-1993"></a>    isTouchableMetaTyVar.
<a name="line-1994"></a>
<a name="line-1995"></a>  * In the constraint solver, we track where Given equalities occur
<a name="line-1996"></a>    and use that to guard unification in GHC.Tc.Solver.Canonical.unifyTest
<a name="line-1997"></a>    More details in Note [Tracking Given equalities] in GHC.Tc.Solver.InertSet
<a name="line-1998"></a>
<a name="line-1999"></a>    Historical note: in the olden days (pre 2021) the constraint solver
<a name="line-2000"></a>    also used to unify only if l=n.  Equalities were "floated" out of the
<a name="line-2001"></a>    implication in a separate step, so that they would become touchable.
<a name="line-2002"></a>    But the float/don't-float question turned out to be very delicate,
<a name="line-2003"></a>    as you can see if you look at the long series of Notes associated with
<a name="line-2004"></a>    GHC.Tc.Solver.floatEqualities, around Nov 2020.  It's much easier
<a name="line-2005"></a>    to unify in-place, with no floating.
<a name="line-2006"></a>
<a name="line-2007"></a>Note [TyVar/TyVar orientation]
<a name="line-2008"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2009"></a>Given (a ~ b), should we orient the CEqCan as (a~b) or (b~a)?
<a name="line-2010"></a>This is a surprisingly tricky question! This is invariant (TyEq:TV).
<a name="line-2011"></a>
<a name="line-2012"></a>The question is answered by swapOverTyVars, which is used
<a name="line-2013"></a>  - in the eager unifier, in GHC.Tc.Utils.Unify.uUnfilledVar1
<a name="line-2014"></a>  - in the constraint solver, in GHC.Tc.Solver.Canonical.canEqCanLHS2
<a name="line-2015"></a>
<a name="line-2016"></a>First note: only swap if you have to!
<a name="line-2017"></a>   See Note [Avoid unnecessary swaps]
<a name="line-2018"></a>
<a name="line-2019"></a>So we look for a positive reason to swap, using a three-step test:
<a name="line-2020"></a>
<a name="line-2021"></a>* Level comparison. If 'a' has deeper level than 'b',
<a name="line-2022"></a>  put 'a' on the left.  See Note [Deeper level on the left]
<a name="line-2023"></a>
<a name="line-2024"></a>* Priority.  If the levels are the same, look at what kind of
<a name="line-2025"></a>  type variable it is, using 'lhsPriority'.
<a name="line-2026"></a>
<a name="line-2027"></a>  Generally speaking we always try to put a MetaTv on the left
<a name="line-2028"></a>  in preference to SkolemTv or RuntimeUnkTv:
<a name="line-2029"></a>     a) Because the MetaTv may be touchable and can be unified
<a name="line-2030"></a>     b) Even if it's not touchable, GHC.Tc.Solver.floatEqualities
<a name="line-2031"></a>        looks for meta tyvars on the left
<a name="line-2032"></a>
<a name="line-2033"></a>  Tie-breaking rules for MetaTvs:
<a name="line-2034"></a>  - CycleBreakerTv: This is essentially a stand-in for another type;
<a name="line-2035"></a>       it's untouchable and should have the same priority as a skolem: 0.
<a name="line-2036"></a>
<a name="line-2037"></a>  - TyVarTv: These can unify only with another tyvar, but we can't unify
<a name="line-2038"></a>       a TyVarTv with a TauTv, because then the TyVarTv could (transitively)
<a name="line-2039"></a>       get a non-tyvar type. So give these a low priority: 1.
<a name="line-2040"></a>
<a name="line-2041"></a>  - TauTv: This is the common case; we want these on the left so that they
<a name="line-2042"></a>       can be written to: 2.
<a name="line-2043"></a>
<a name="line-2044"></a>  - RuntimeUnkTv: These aren't really meta-variables used in type inference,
<a name="line-2045"></a>       but just a convenience in the implementation of the GHCi debugger.
<a name="line-2046"></a>       Eagerly write to these: 3. See Note [RuntimeUnkTv] in
<a name="line-2047"></a>       GHC.Runtime.Heap.Inspect.
<a name="line-2048"></a>
<a name="line-2049"></a>* Names. If the level and priority comparisons are all
<a name="line-2050"></a>  equal, try to eliminate a TyVar with a System Name in
<a name="line-2051"></a>  favour of ones with a Name derived from a user type signature
<a name="line-2052"></a>
<a name="line-2053"></a>* Age.  At one point in the past we tried to break any remaining
<a name="line-2054"></a>  ties by eliminating the younger type variable, based on their
<a name="line-2055"></a>  Uniques.  See Note [Eliminate younger unification variables]
<a name="line-2056"></a>  (which also explains why we don't do this any more)
<a name="line-2057"></a>
<a name="line-2058"></a>Note [Unification variables on the left]
<a name="line-2059"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2060"></a>For wanteds, but not givens, swap (skolem ~ meta-tv) regardless of
<a name="line-2061"></a>level, so that the unification variable is on the left.
<a name="line-2062"></a>
<a name="line-2063"></a>* We /don't/ want this for Givens because if we ave
<a name="line-2064"></a>    [G] a[2] ~ alpha[1]
<a name="line-2065"></a>    [W] Bool ~ a[2]
<a name="line-2066"></a>  we want to rewrite the wanted to Bool ~ alpha[1],
<a name="line-2067"></a>  so we can float the constraint and solve it.
<a name="line-2068"></a>
<a name="line-2069"></a>* But for Wanteds putting the unification variable on
<a name="line-2070"></a>  the left means an easier job when floating, and when
<a name="line-2071"></a>  reporting errors -- just fewer cases to consider.
<a name="line-2072"></a>
<a name="line-2073"></a>  In particular, we get better skolem-escape messages:
<a name="line-2074"></a>  see #18114
<a name="line-2075"></a>
<a name="line-2076"></a>Note [Deeper level on the left]
<a name="line-2077"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2078"></a>The most important thing is that we want to put tyvars with
<a name="line-2079"></a>the deepest level on the left.  The reason to do so differs for
<a name="line-2080"></a>Wanteds and Givens, but either way, deepest wins!  Simple.
<a name="line-2081"></a>
<a name="line-2082"></a>* Wanteds.  Putting the deepest variable on the left maximise the
<a name="line-2083"></a>  chances that it's a touchable meta-tyvar which can be solved.
<a name="line-2084"></a>
<a name="line-2085"></a>* Givens. Suppose we have something like
<a name="line-2086"></a>     forall a[2]. b[1] ~ a[2] =&gt; beta[1] ~ a[2]
<a name="line-2087"></a>
<a name="line-2088"></a>  If we orient the Given a[2] on the left, we'll rewrite the Wanted to
<a name="line-2089"></a>  (beta[1] ~ b[1]), and that can float out of the implication.
<a name="line-2090"></a>  Otherwise it can't.  By putting the deepest variable on the left
<a name="line-2091"></a>  we maximise our changes of eliminating skolem capture.
<a name="line-2092"></a>
<a name="line-2093"></a>  See also GHC.Tc.Solver.Monad Note [Let-bound skolems] for another reason
<a name="line-2094"></a>  to orient with the deepest skolem on the left.
<a name="line-2095"></a>
<a name="line-2096"></a>  IMPORTANT NOTE: this test does a level-number comparison on
<a name="line-2097"></a>  skolems, so it's important that skolems have (accurate) level
<a name="line-2098"></a>  numbers.
<a name="line-2099"></a>
<a name="line-2100"></a>See #15009 for an further analysis of why "deepest on the left"
<a name="line-2101"></a>is a good plan.
<a name="line-2102"></a>
<a name="line-2103"></a>Note [Avoid unnecessary swaps]
<a name="line-2104"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2105"></a>If we swap without actually improving matters, we can get an infinite loop.
<a name="line-2106"></a>Consider
<a name="line-2107"></a>    work item:  a ~ b
<a name="line-2108"></a>   inert item:  b ~ c
<a name="line-2109"></a>We canonicalise the work-item to (a ~ c).  If we then swap it before
<a name="line-2110"></a>adding to the inert set, we'll add (c ~ a), and therefore kick out the
<a name="line-2111"></a>inert guy, so we get
<a name="line-2112"></a>   new work item:  b ~ c
<a name="line-2113"></a>   inert item:     c ~ a
<a name="line-2114"></a>And now the cycle just repeats
<a name="line-2115"></a>
<a name="line-2116"></a>Historical Note [Eliminate younger unification variables]
<a name="line-2117"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2118"></a>Given a choice of unifying
<a name="line-2119"></a>     alpha := beta   or   beta := alpha
<a name="line-2120"></a>we try, if possible, to eliminate the "younger" one, as determined
<a name="line-2121"></a>by `ltUnique`.  Reason: the younger one is less likely to appear free in
<a name="line-2122"></a>an existing inert constraint, and hence we are less likely to be forced
<a name="line-2123"></a>into kicking out and rewriting inert constraints.
<a name="line-2124"></a>
<a name="line-2125"></a>This is a performance optimisation only.  It turns out to fix
<a name="line-2126"></a>#14723 all by itself, but clearly not reliably so!
<a name="line-2127"></a>
<a name="line-2128"></a>It's simple to implement (see nicer_to_update_tv2 in swapOverTyVars).
<a name="line-2129"></a>But, to my surprise, it didn't seem to make any significant difference
<a name="line-2130"></a>to the compiler's performance, so I didn't take it any further.  Still
<a name="line-2131"></a>it seemed too nice to discard altogether, so I'm leaving these
<a name="line-2132"></a>notes.  SLPJ Jan 18.
<a name="line-2133"></a>
<a name="line-2134"></a>Note [Prevent unification with type families]
<a name="line-2135"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2136"></a>We prevent unification with type families because of an uneasy compromise.
<a name="line-2137"></a>It's perfectly sound to unify with type families, and it even improves the
<a name="line-2138"></a>error messages in the testsuite. It also modestly improves performance, at
<a name="line-2139"></a>least in some cases. But it's disastrous for test case perf/compiler/T3064.
<a name="line-2140"></a>Here is the problem: Suppose we have (F ty) where we also have [G] F ty ~ a.
<a name="line-2141"></a>What do we do? Do we reduce F? Or do we use the given? Hard to know what's
<a name="line-2142"></a>best. GHC reduces. This is a disaster for T3064, where the type's size
<a name="line-2143"></a>spirals out of control during reduction. If we prevent
<a name="line-2144"></a>unification with type families, then the solver happens to use the equality
<a name="line-2145"></a>before expanding the type family.
<a name="line-2146"></a>
<a name="line-2147"></a>It would be lovely in the future to revisit this problem and remove this
<a name="line-2148"></a>extra, unnecessary check. But we retain it for now as it seems to work
<a name="line-2149"></a>better in practice.
<a name="line-2150"></a>
<a name="line-2151"></a>Revisited in Nov '20, along with removing flattening variables. Problem
<a name="line-2152"></a>is still present, and the solution is still the same.
<a name="line-2153"></a>
<a name="line-2154"></a>Note [Refactoring hazard: metaTyVarUpdateOK]
<a name="line-2155"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2156"></a>I (Richard E.) have a sad story about refactoring this code, retained here
<a name="line-2157"></a>to prevent others (or a future me!) from falling into the same traps.
<a name="line-2158"></a>
<a name="line-2159"></a>It all started with #11407, which was caused by the fact that the TyVarTy
<a name="line-2160"></a>case of defer_me didn't look in the kind. But it seemed reasonable to
<a name="line-2161"></a>simply remove the defer_me check instead.
<a name="line-2162"></a>
<a name="line-2163"></a>It referred to two Notes (since removed) that were out of date, and the
<a name="line-2164"></a>fast_check code in occurCheckExpand seemed to do just about the same thing as
<a name="line-2165"></a>defer_me. The one piece that defer_me did that wasn't repeated by
<a name="line-2166"></a>occurCheckExpand was the type-family check. (See Note [Prevent unification
<a name="line-2167"></a>with type families].) So I checked the result of occurCheckExpand for any
<a name="line-2168"></a>type family occurrences and deferred if there were any. This was done
<a name="line-2169"></a>in commit e9bf7bb5cc9fb3f87dd05111aa23da76b86a8967 .
<a name="line-2170"></a>
<a name="line-2171"></a>This approach turned out not to be performant, because the expanded
<a name="line-2172"></a>type was bigger than the original type, and tyConsOfType (needed to
<a name="line-2173"></a>see if there are any type family occurrences) looks through type
<a name="line-2174"></a>synonyms. So it then struck me that we could dispense with the
<a name="line-2175"></a>defer_me check entirely. This simplified the code nicely, and it cut
<a name="line-2176"></a>the allocations in T5030 by half. But, as documented in Note [Prevent
<a name="line-2177"></a>unification with type families], this destroyed performance in
<a name="line-2178"></a>T3064. Regardless, I missed this regression and the change was
<a name="line-2179"></a>committed as 3f5d1a13f112f34d992f6b74656d64d95a3f506d .
<a name="line-2180"></a>
<a name="line-2181"></a>Bottom lines:
<a name="line-2182"></a> * defer_me is back, but now fixed w.r.t. #11407.
<a name="line-2183"></a> * Tread carefully before you start to refactor here. There can be
<a name="line-2184"></a>   lots of hard-to-predict consequences.
<a name="line-2185"></a>
<a name="line-2186"></a>Note [Type synonyms and the occur check]
<a name="line-2187"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2188"></a>Generally speaking we try to update a variable with type synonyms not
<a name="line-2189"></a>expanded, which improves later error messages, unless looking
<a name="line-2190"></a>inside a type synonym may help resolve a spurious occurs check
<a name="line-2191"></a>error. Consider:
<a name="line-2192"></a>          type A a = ()
<a name="line-2193"></a>
<a name="line-2194"></a>          f :: (A a -&gt; a -&gt; ()) -&gt; ()
<a name="line-2195"></a>          f = \ _ -&gt; ()
<a name="line-2196"></a>
<a name="line-2197"></a>          x :: ()
<a name="line-2198"></a>          x = f (\ x p -&gt; p x)
<a name="line-2199"></a>
<a name="line-2200"></a>We will eventually get a constraint of the form t ~ A t. The ok function above will
<a name="line-2201"></a>properly expand the type (A t) to just (), which is ok to be unified with t. If we had
<a name="line-2202"></a>unified with the original type A t, we would lead the type checker into an infinite loop.
<a name="line-2203"></a>
<a name="line-2204"></a>Hence, if the occurs check fails for a type synonym application, then (and *only* then),
<a name="line-2205"></a>the ok function expands the synonym to detect opportunities for occurs check success using
<a name="line-2206"></a>the underlying definition of the type synonym.
<a name="line-2207"></a>
<a name="line-2208"></a>The same applies later on in the constraint interaction code; see GHC.Tc.Solver.Interact,
<a name="line-2209"></a>function @occ_check_ok@.
<a name="line-2210"></a>
<a name="line-2211"></a>Note [Non-TcTyVars in GHC.Tc.Utils.Unify]
<a name="line-2212"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2213"></a>Because the same code is now shared between unifying types and unifying
<a name="line-2214"></a>kinds, we sometimes will see proper TyVars floating around the unifier.
<a name="line-2215"></a>Example (from test case polykinds/PolyKinds12):
<a name="line-2216"></a>
<a name="line-2217"></a>    type family Apply (f :: k1 -&gt; k2) (x :: k1) :: k2
<a name="line-2218"></a>    type instance Apply g y = g y
<a name="line-2219"></a>
<a name="line-2220"></a>When checking the instance declaration, we first *kind-check* the LHS
<a name="line-2221"></a>and RHS, discovering that the instance really should be
<a name="line-2222"></a>
<a name="line-2223"></a>    type instance Apply k3 k4 (g :: k3 -&gt; k4) (y :: k3) = g y
<a name="line-2224"></a>
<a name="line-2225"></a>During this kind-checking, all the tyvars will be TcTyVars. Then, however,
<a name="line-2226"></a>as a second pass, we desugar the RHS (which is done in functions prefixed
<a name="line-2227"></a>with "tc" in GHC.Tc.TyCl"). By this time, all the kind-vars are proper
<a name="line-2228"></a>TyVars, not TcTyVars, get some kind unification must happen.
<a name="line-2229"></a>
<a name="line-2230"></a>Thus, we always check if a TyVar is a TcTyVar before asking if it's a
<a name="line-2231"></a>meta-tyvar.
<a name="line-2232"></a>
<a name="line-2233"></a>This used to not be necessary for type-checking (that is, before * :: *)
<a name="line-2234"></a>because expressions get desugared via an algorithm separate from
<a name="line-2235"></a>type-checking (with wrappers, etc.). Types get desugared very differently,
<a name="line-2236"></a>causing this wibble in behavior seen here.
<a name="line-2237"></a>-}</span>
<a name="line-2238"></a>
<a name="line-2239"></a><a name="matchExpectedFunKind"></a><span class='hs-comment'>-- | Breaks apart a function kind into its pieces.</span>
<a name="line-2240"></a><span class='hs-definition'>matchExpectedFunKind</span>
<a name="line-2241"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>fun</span>
<a name="line-2242"></a>  <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>fun</span>             <span class='hs-comment'>-- ^ type, only for errors</span>
<a name="line-2243"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>           <span class='hs-comment'>-- ^ n: number of desired arrows</span>
<a name="line-2244"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>          <span class='hs-comment'>-- ^ fun_ kind</span>
<a name="line-2245"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Coercion</span>    <span class='hs-comment'>-- ^ co :: fun_kind ~ (arg1 -&gt; ... -&gt; argn -&gt; res)</span>
<a name="line-2246"></a>
<a name="line-2247"></a><span class='hs-definition'>matchExpectedFunKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>n</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>k</span>
<a name="line-2248"></a>  <span class='hs-keyword'>where</span>
<a name="line-2249"></a>    <span class='hs-varid'>go</span> <span class='hs-num'>0</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-2250"></a>
<a name="line-2251"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>k'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>k'</span>
<a name="line-2252"></a>
<a name="line-2253"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>k</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>kvar</span><span class='hs-layout'>)</span>
<a name="line-2254"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>kvar</span>
<a name="line-2255"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>maybe_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMetaTyVar</span> <span class='hs-varid'>kvar</span>
<a name="line-2256"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_kind</span> <span class='hs-keyword'>of</span>
<a name="line-2257"></a>                <span class='hs-conid'>Indirect</span> <span class='hs-varid'>fun_kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>fun_kind</span>
<a name="line-2258"></a>                <span class='hs-conid'>Flexi</span> <span class='hs-keyglyph'>-&gt;</span>             <span class='hs-varid'>defer</span> <span class='hs-varid'>n</span> <span class='hs-varid'>k</span> <span class='hs-layout'>}</span>
<a name="line-2259"></a>
<a name="line-2260"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_mult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2261"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span>
<a name="line-2262"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcFunCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcNomReflCo</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcNomReflCo</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2263"></a>
<a name="line-2264"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>other</span>
<a name="line-2265"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer</span> <span class='hs-varid'>n</span> <span class='hs-varid'>other</span>
<a name="line-2266"></a>
<a name="line-2267"></a>    <span class='hs-varid'>defer</span> <span class='hs-varid'>n</span> <span class='hs-varid'>k</span>
<a name="line-2268"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVars</span> <span class='hs-varid'>n</span>
<a name="line-2269"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>res_kind</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-2270"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_fun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVisFunTysMany</span> <span class='hs-varid'>arg_kinds</span> <span class='hs-varid'>res_kind</span>
<a name="line-2271"></a>                 <span class='hs-varid'>origin</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>k</span>
<a name="line-2272"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_fun</span>
<a name="line-2273"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>uo_thing</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-2274"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>uo_visible</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2275"></a>                                        <span class='hs-layout'>}</span>
<a name="line-2276"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>uType</span> <span class='hs-conid'>KindLevel</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>k</span> <span class='hs-varid'>new_fun</span> <span class='hs-layout'>}</span>
<a name="line-2277"></a>
<a name="line-2278"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-2279"></a>*                                                                      *
<a name="line-2280"></a>                 Equality invariant checking
<a name="line-2281"></a>*                                                                      *
<a name="line-2282"></a>********************************************************************* -}</span>
<a name="line-2283"></a>
<a name="line-2284"></a>
<a name="line-2285"></a><span class='hs-comment'>{-  Note [Checking for foralls]
<a name="line-2286"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2287"></a>Unless we have -XImpredicativeTypes (which is a totally unsupported
<a name="line-2288"></a>feature), we do not want to unify
<a name="line-2289"></a>    alpha ~ (forall a. a-&gt;a) -&gt; Int
<a name="line-2290"></a>So we look for foralls hidden inside the type, and it's convenient
<a name="line-2291"></a>to do that at the same time as the occurs check (which looks for
<a name="line-2292"></a>occurrences of alpha).
<a name="line-2293"></a>
<a name="line-2294"></a>However, it's not just a question of looking for foralls /anywhere/!
<a name="line-2295"></a>Consider
<a name="line-2296"></a>   (alpha :: forall k. k-&gt;*)  ~  (beta :: forall k. k-&gt;*)
<a name="line-2297"></a>This is legal; e.g. dependent/should_compile/T11635.
<a name="line-2298"></a>
<a name="line-2299"></a>We don't want to reject it because of the forall in beta's kind, but
<a name="line-2300"></a>(see Note [Occurrence checking: look inside kinds] in GHC.Core.Type)
<a name="line-2301"></a>we do need to look in beta's kind.  So we carry a flag saying if a
<a name="line-2302"></a>'forall' is OK, and switch the flag on when stepping inside a kind.
<a name="line-2303"></a>
<a name="line-2304"></a>Why is it OK?  Why does it not count as impredicative polymorphism?
<a name="line-2305"></a>The reason foralls are bad is because we reply on "seeing" foralls
<a name="line-2306"></a>when doing implicit instantiation.  But the forall inside the kind is
<a name="line-2307"></a>fine.  We'll generate a kind equality constraint
<a name="line-2308"></a>  (forall k. k-&gt;*) ~ (forall k. k-&gt;*)
<a name="line-2309"></a>to check that the kinds of lhs and rhs are compatible.  If alpha's
<a name="line-2310"></a>kind had instead been
<a name="line-2311"></a>  (alpha :: kappa)
<a name="line-2312"></a>then this kind equality would rightly complain about unifying kappa
<a name="line-2313"></a>with (forall k. k-&gt;*)
<a name="line-2314"></a>
<a name="line-2315"></a>-}</span>
<a name="line-2316"></a>
<a name="line-2317"></a><span class='hs-comment'>----------------</span>
<a name="line-2318"></a><span class='hs-comment'>{-# NOINLINE checkTyVarEq #-}</span>  <span class='hs-comment'>-- checkTyVarEq becomes big after the `inline` fires</span>
<a name="line-2319"></a><a name="checkTyVarEq"></a><span class='hs-definition'>checkTyVarEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CheckTyEqResult</span>
<a name="line-2320"></a><span class='hs-definition'>checkTyVarEq</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-2321"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inline</span> <span class='hs-varid'>checkTypeEq</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarLHS</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-2322"></a>    <span class='hs-comment'>-- inline checkTypeEq so that the `case`s over the CanEqLHS get blasted away</span>
<a name="line-2323"></a>
<a name="line-2324"></a><span class='hs-comment'>{-# NOINLINE checkTyFamEq #-}</span>  <span class='hs-comment'>-- checkTyFamEq becomes big after the `inline` fires</span>
<a name="line-2325"></a><a name="checkTyFamEq"></a><span class='hs-definition'>checkTyFamEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-2326"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span>     <span class='hs-comment'>-- type function</span>
<a name="line-2327"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- args, exactly saturated</span>
<a name="line-2328"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>    <span class='hs-comment'>-- RHS</span>
<a name="line-2329"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CheckTyEqResult</span>   <span class='hs-comment'>-- always drops cteTypeFamily</span>
<a name="line-2330"></a><span class='hs-definition'>checkTyFamEq</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>fun_tc</span> <span class='hs-varid'>fun_args</span> <span class='hs-varid'>ty</span>
<a name="line-2331"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inline</span> <span class='hs-varid'>checkTypeEq</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyFamLHS</span> <span class='hs-varid'>fun_tc</span> <span class='hs-varid'>fun_args</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-2332"></a>    <span class='hs-varop'>`cterRemoveProblem`</span> <span class='hs-varid'>cteTypeFamily</span>
<a name="line-2333"></a>    <span class='hs-comment'>-- inline checkTypeEq so that the `case`s over the CanEqLHS get blasted away</span>
<a name="line-2334"></a>
<a name="line-2335"></a><a name="checkTypeEq"></a><span class='hs-definition'>checkTypeEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CanEqLHS</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CheckTyEqResult</span>
<a name="line-2336"></a><span class='hs-comment'>-- If cteHasNoProblem (checkTypeEq dflags lhs rhs), then lhs ~ rhs</span>
<a name="line-2337"></a><span class='hs-comment'>-- is a canonical CEqCan.</span>
<a name="line-2338"></a><span class='hs-comment'>--</span>
<a name="line-2339"></a><span class='hs-comment'>-- In particular, this looks for:</span>
<a name="line-2340"></a><span class='hs-comment'>--   (a) a forall type (forall a. blah)</span>
<a name="line-2341"></a><span class='hs-comment'>--   (b) a predicate type (c =&gt; ty)</span>
<a name="line-2342"></a><span class='hs-comment'>--   (c) a type family; see Note [Prevent unification with type families]</span>
<a name="line-2343"></a><span class='hs-comment'>--   (d) a blocking coercion hole</span>
<a name="line-2344"></a><span class='hs-comment'>--   (e) an occurrence of the LHS (occurs check)</span>
<a name="line-2345"></a><span class='hs-comment'>--</span>
<a name="line-2346"></a><span class='hs-comment'>-- Note that an occurs-check does not mean "definite error".  For example</span>
<a name="line-2347"></a><span class='hs-comment'>--   type family F a</span>
<a name="line-2348"></a><span class='hs-comment'>--   type instance F Int = Int</span>
<a name="line-2349"></a><span class='hs-comment'>-- consider</span>
<a name="line-2350"></a><span class='hs-comment'>--   b0 ~ F b0</span>
<a name="line-2351"></a><span class='hs-comment'>-- This is perfectly reasonable, if we later get b0 ~ Int.  But we</span>
<a name="line-2352"></a><span class='hs-comment'>-- certainly can't unify b0 := F b0</span>
<a name="line-2353"></a><span class='hs-comment'>--</span>
<a name="line-2354"></a><span class='hs-comment'>-- For (a), (b), and (c) we check only the top level of the type, NOT</span>
<a name="line-2355"></a><span class='hs-comment'>-- inside the kinds of variables it mentions.  For (d) we look deeply</span>
<a name="line-2356"></a><span class='hs-comment'>-- in coercions when the LHS is a tyvar (but skip coercions for type family</span>
<a name="line-2357"></a><span class='hs-comment'>-- LHSs), and for (e) see Note [CEqCan occurs check] in GHC.Tc.Types.Constraint.</span>
<a name="line-2358"></a><span class='hs-comment'>--</span>
<a name="line-2359"></a><span class='hs-comment'>-- checkTypeEq is called from</span>
<a name="line-2360"></a><span class='hs-comment'>--    * checkTyFamEq, checkTyVarEq (which inline it to specialise away the</span>
<a name="line-2361"></a><span class='hs-comment'>--      case-analysis on 'lhs')</span>
<a name="line-2362"></a><span class='hs-comment'>--    * checkEqCanLHSFinish, which does not know the form of 'lhs'</span>
<a name="line-2363"></a><span class='hs-definition'>checkTypeEq</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>lhs</span> <span class='hs-varid'>ty</span>
<a name="line-2364"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-2365"></a>  <span class='hs-keyword'>where</span>
<a name="line-2366"></a>    <span class='hs-varid'>impredicative</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cteProblem</span> <span class='hs-varid'>cteImpredicative</span>
<a name="line-2367"></a>    <span class='hs-varid'>type_family</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cteProblem</span> <span class='hs-varid'>cteTypeFamily</span>
<a name="line-2368"></a>    <span class='hs-varid'>hole_blocker</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cteProblem</span> <span class='hs-varid'>cteHoleBlocker</span>
<a name="line-2369"></a>    <span class='hs-varid'>insoluble_occurs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cteProblem</span> <span class='hs-varid'>cteInsolubleOccurs</span>
<a name="line-2370"></a>    <span class='hs-varid'>soluble_occurs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cteProblem</span> <span class='hs-varid'>cteSolubleOccurs</span>
<a name="line-2371"></a>
<a name="line-2372"></a>    <span class='hs-comment'>-- The GHCi runtime debugger does its type-matching with</span>
<a name="line-2373"></a>    <span class='hs-comment'>-- unification variables that can unify with a polytype</span>
<a name="line-2374"></a>    <span class='hs-comment'>-- or a TyCon that would usually be disallowed by bad_tc</span>
<a name="line-2375"></a>    <span class='hs-comment'>-- See Note [RuntimeUnkTv] in GHC.Runtime.Heap.Inspect</span>
<a name="line-2376"></a>    <span class='hs-varid'>ghci_tv</span>
<a name="line-2377"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyVarLHS</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lhs</span>
<a name="line-2378"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RuntimeUnkTv</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span>
<a name="line-2379"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2380"></a>
<a name="line-2381"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2382"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2383"></a>
<a name="line-2384"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CheckTyEqResult</span>
<a name="line-2385"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_tv</span> <span class='hs-varid'>tv'</span>
<a name="line-2386"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_tc</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-2387"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cteOK</span>
<a name="line-2388"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span><span class='hs-varid'>ft_af</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>af</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_mult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2389"></a>                               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>w</span> <span class='hs-conid'>S</span><span class='hs-varop'>.&lt;&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>a</span> <span class='hs-conid'>S</span><span class='hs-varop'>.&lt;&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-conid'>S</span><span class='hs-varop'>.&lt;&gt;</span>
<a name="line-2390"></a>                                 <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-varid'>ghci_tv</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>af</span> <span class='hs-varop'>==</span> <span class='hs-conid'>InvisArg</span>
<a name="line-2391"></a>                                   <span class='hs-keyword'>then</span> <span class='hs-varid'>impredicative</span>
<a name="line-2392"></a>                                   <span class='hs-keyword'>else</span> <span class='hs-varid'>cteOK</span>
<a name="line-2393"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>fun</span> <span class='hs-conid'>S</span><span class='hs-varop'>.&lt;&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span>
<a name="line-2394"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>  <span class='hs-conid'>S</span><span class='hs-varop'>.&lt;&gt;</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>co</span>
<a name="line-2395"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_co</span> <span class='hs-varid'>co</span>
<a name="line-2396"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv'</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>lhs</span> <span class='hs-keyword'>of</span>
<a name="line-2397"></a>      <span class='hs-conid'>TyVarLHS</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go_occ</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-conid'>S</span><span class='hs-varop'>.&lt;&gt;</span> <span class='hs-varid'>cterClearOccursCheck</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2398"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go_occ</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-conid'>S</span><span class='hs-varop'>.&lt;&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-2399"></a>      <span class='hs-keyword'>_</span>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2400"></a>      <span class='hs-conid'>S</span><span class='hs-varop'>.&lt;&gt;</span>
<a name="line-2401"></a>      <span class='hs-keyword'>if</span> <span class='hs-varid'>ghci_tv</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>cteOK</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>impredicative</span>
<a name="line-2402"></a>
<a name="line-2403"></a>    <span class='hs-varid'>go_tv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CheckTyEqResult</span>
<a name="line-2404"></a>      <span class='hs-comment'>-- this slightly peculiar way of defining this means</span>
<a name="line-2405"></a>      <span class='hs-comment'>-- we don't have to evaluate this `case` at every variable</span>
<a name="line-2406"></a>      <span class='hs-comment'>-- occurrence</span>
<a name="line-2407"></a>    <span class='hs-varid'>go_tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lhs</span> <span class='hs-keyword'>of</span>
<a name="line-2408"></a>      <span class='hs-conid'>TyVarLHS</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go_occ</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-conid'>S</span><span class='hs-varop'>.&lt;&gt;</span>
<a name="line-2409"></a>                              <span class='hs-keyword'>if</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tv'</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>insoluble_occurs</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>cteOK</span>
<a name="line-2410"></a>      <span class='hs-conid'>TyFamLHS</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>\</span> <span class='hs-sel'>_tv'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cteOK</span>
<a name="line-2411"></a>           <span class='hs-comment'>-- See Note [Occurrence checking: look inside kinds] in GHC.Core.Type</span>
<a name="line-2412"></a>
<a name="line-2413"></a>     <span class='hs-comment'>-- For kinds, we only do an occurs check; we do not worry</span>
<a name="line-2414"></a>     <span class='hs-comment'>-- about type families or foralls</span>
<a name="line-2415"></a>     <span class='hs-comment'>-- See Note [Checking for foralls]</span>
<a name="line-2416"></a>    <span class='hs-varid'>go_occ</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cterFromKind</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>k</span>
<a name="line-2417"></a>
<a name="line-2418"></a>    <span class='hs-varid'>go_tc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CheckTyEqResult</span>
<a name="line-2419"></a>      <span class='hs-comment'>-- this slightly peculiar way of defining this means</span>
<a name="line-2420"></a>      <span class='hs-comment'>-- we don't have to evaluate this `case` at every tyconapp</span>
<a name="line-2421"></a>    <span class='hs-varid'>go_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lhs</span> <span class='hs-keyword'>of</span>
<a name="line-2422"></a>      <span class='hs-conid'>TyVarLHS</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>check_tc</span> <span class='hs-varid'>tc</span> <span class='hs-conid'>S</span><span class='hs-varop'>.&lt;&gt;</span> <span class='hs-varid'>go_tc_args</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-2423"></a>      <span class='hs-conid'>TyFamLHS</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>fam_args</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2424"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>tcEqTyConApps</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>fam_args</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-2425"></a>          <span class='hs-keyword'>then</span> <span class='hs-varid'>insoluble_occurs</span>
<a name="line-2426"></a>          <span class='hs-keyword'>else</span> <span class='hs-varid'>check_tc</span> <span class='hs-varid'>tc</span> <span class='hs-conid'>S</span><span class='hs-varop'>.&lt;&gt;</span> <span class='hs-varid'>go_tc_args</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-2427"></a>
<a name="line-2428"></a>      <span class='hs-comment'>-- just look at arguments, not the tycon itself</span>
<a name="line-2429"></a>    <span class='hs-varid'>go_tc_args</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CheckTyEqResult</span>
<a name="line-2430"></a>    <span class='hs-varid'>go_tc_args</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGenerativeTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-conid'>Nominal</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldMap</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tys</span>
<a name="line-2431"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2432"></a>                      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tf_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>non_tf_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-keyword'>in</span>
<a name="line-2433"></a>                        <span class='hs-varid'>cterSetOccursCheckSoluble</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldMap</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tf_args</span><span class='hs-layout'>)</span> <span class='hs-conid'>S</span><span class='hs-varop'>.&lt;&gt;</span> <span class='hs-varid'>foldMap</span> <span class='hs-varid'>go</span> <span class='hs-varid'>non_tf_args</span>
<a name="line-2434"></a>
<a name="line-2435"></a>     <span class='hs-comment'>-- no bother about impredicativity in coercions, as they're</span>
<a name="line-2436"></a>     <span class='hs-comment'>-- inferred</span>
<a name="line-2437"></a>    <span class='hs-varid'>go_co</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyVarLHS</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lhs</span>
<a name="line-2438"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-2439"></a>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>soluble_occurs</span> <span class='hs-conid'>S</span><span class='hs-varop'>.&lt;&gt;</span> <span class='hs-varid'>maybe_hole_blocker</span>
<a name="line-2440"></a>
<a name="line-2441"></a>        <span class='hs-comment'>-- Don't check coercions for type families; see commentary at top of function</span>
<a name="line-2442"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2443"></a>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybe_hole_blocker</span>
<a name="line-2444"></a>      <span class='hs-keyword'>where</span>
<a name="line-2445"></a>        <span class='hs-comment'>-- See GHC.Tc.Solver.Canonical Note [Equalities with incompatible kinds]</span>
<a name="line-2446"></a>        <span class='hs-comment'>-- Wrinkle (2) about this case in general, Wrinkle (4b) about the check for</span>
<a name="line-2447"></a>        <span class='hs-comment'>-- deferred type errors</span>
<a name="line-2448"></a>        <span class='hs-varid'>maybe_hole_blocker</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_DeferTypeErrors</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-2449"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>hasCoercionHoleCo</span> <span class='hs-varid'>co</span>
<a name="line-2450"></a>                           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hole_blocker</span>
<a name="line-2451"></a>
<a name="line-2452"></a>                           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2453"></a>                           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cteOK</span>
<a name="line-2454"></a>
<a name="line-2455"></a>    <span class='hs-varid'>check_tc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CheckTyEqResult</span>
<a name="line-2456"></a>    <span class='hs-varid'>check_tc</span>
<a name="line-2457"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ghci_tv</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span> <span class='hs-sel'>_tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cteOK</span>
<a name="line-2458"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tc</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>isTauTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>cteOK</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>impredicative</span><span class='hs-layout'>)</span> <span class='hs-conid'>S</span><span class='hs-varop'>.&lt;&gt;</span>
<a name="line-2459"></a>                             <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>isFamFreeTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>cteOK</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>type_family</span><span class='hs-layout'>)</span>
</pre></body>
</html>
