<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Core/Tidy.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The University of Glasgow 2006
<a name="line-3"></a>(c) The AQUA Project, Glasgow University, 1996-1998
<a name="line-4"></a>
<a name="line-5"></a>
<a name="line-6"></a>This module contains "tidying" code for *nested* expressions, bindings, rules.
<a name="line-7"></a>The code for *top-level* bindings is in GHC.Iface.Tidy.
<a name="line-8"></a>-}</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-11"></a><span class='hs-comment'>{-# OPTIONS_GHC -Wno-incomplete-record-updates #-}</span>
<a name="line-12"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Core.Tidy</span> <span class='hs-layout'>(</span>
<a name="line-13"></a>        <span class='hs-varid'>tidyExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyRules</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyUnfolding</span>
<a name="line-14"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Seq</span> <span class='hs-layout'>(</span> <span class='hs-varid'>seqUnfolding</span> <span class='hs-layout'>)</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Id</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Id.Info</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Demand</span> <span class='hs-layout'>(</span> <span class='hs-varid'>zapDmdEnvSig</span> <span class='hs-layout'>)</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Type</span>     <span class='hs-layout'>(</span> <span class='hs-varid'>tidyType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyVarBndr</span> <span class='hs-layout'>)</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Coercion</span> <span class='hs-layout'>(</span> <span class='hs-varid'>tidyCo</span> <span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var.Env</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span><span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.FM</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyNameOcc</span><span class='hs-layout'>)</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SrcLoc</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Tickish</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Maybe</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapAccumL</span><span class='hs-layout'>)</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-comment'>{-
<a name="line-38"></a>************************************************************************
<a name="line-39"></a>*                                                                      *
<a name="line-40"></a>\subsection{Tidying expressions, rules}
<a name="line-41"></a>*                                                                      *
<a name="line-42"></a>************************************************************************
<a name="line-43"></a>-}</span>
<a name="line-44"></a>
<a name="line-45"></a><a name="tidyBind"></a><span class='hs-definition'>tidyBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span>
<a name="line-46"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreBind</span>
<a name="line-47"></a>         <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreBind</span><span class='hs-layout'>)</span>
<a name="line-48"></a>
<a name="line-49"></a><span class='hs-definition'>tidyBind</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyLetBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>=:</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-51"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>NonRec</span> <span class='hs-varid'>bndr'</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-definition'>tidyBind</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>
<a name="line-55"></a>       <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhss</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>prs</span>
<a name="line-56"></a>       <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyLetBndr</span> <span class='hs-varid'>env'</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndrs</span>
<a name="line-57"></a>    <span class='hs-keyword'>in</span>
<a name="line-58"></a>    <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env'</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhss</span> <span class='hs-varop'>=:</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>rhss'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-59"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-varid'>bndrs'</span> <span class='hs-varid'>rhss'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-60"></a>
<a name="line-61"></a>
<a name="line-62"></a><a name="tidyExpr"></a><span class='hs-comment'>------------  Expressions  --------------</span>
<a name="line-63"></a><span class='hs-definition'>tidyExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-64"></a><span class='hs-definition'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyVarOcc</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-65"></a><span class='hs-definition'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-66"></a><span class='hs-definition'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Coercion</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCo</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-67"></a><span class='hs-definition'>tidyExpr</span> <span class='hs-keyword'>_</span>   <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lit</span> <span class='hs-varid'>lit</span>
<a name="line-68"></a><span class='hs-definition'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>App</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-69"></a><span class='hs-definition'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Tick</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyTickish</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-70"></a><span class='hs-definition'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Cast</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCo</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-71"></a>
<a name="line-72"></a><span class='hs-definition'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyBind</span> <span class='hs-varid'>env</span> <span class='hs-varid'>b</span>      <span class='hs-varop'>=:</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>b'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-74"></a>    <span class='hs-conid'>Let</span> <span class='hs-varid'>b'</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-75"></a>
<a name="line-76"></a><span class='hs-definition'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>e</span> <span class='hs-varid'>b</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-77"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>b</span>  <span class='hs-varop'>=:</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-78"></a>    <span class='hs-conid'>Case</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-79"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyAlt</span> <span class='hs-varid'>env'</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-80"></a>
<a name="line-81"></a><span class='hs-definition'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-82"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>b</span>      <span class='hs-varop'>=:</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-83"></a>    <span class='hs-conid'>Lam</span> <span class='hs-varid'>b</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-84"></a>
<a name="line-85"></a><a name="tidyAlt"></a><span class='hs-comment'>------------  Case alternatives  --------------</span>
<a name="line-86"></a><span class='hs-definition'>tidyAlt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreAlt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreAlt</span>
<a name="line-87"></a><span class='hs-definition'>tidyAlt</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Alt</span> <span class='hs-varid'>con</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-88"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>vs</span>    <span class='hs-varop'>=:</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-89"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>Alt</span> <span class='hs-varid'>con</span> <span class='hs-varid'>vs</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-90"></a>
<a name="line-91"></a><a name="tidyTickish"></a><span class='hs-comment'>------------  Tickish  --------------</span>
<a name="line-92"></a><span class='hs-definition'>tidyTickish</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreTickish</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreTickish</span>
<a name="line-93"></a><span class='hs-definition'>tidyTickish</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Breakpoint</span> <span class='hs-varid'>ext</span> <span class='hs-varid'>ix</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span>
<a name="line-94"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Breakpoint</span> <span class='hs-varid'>ext</span> <span class='hs-varid'>ix</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyVarOcc</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span>
<a name="line-95"></a><span class='hs-definition'>tidyTickish</span> <span class='hs-keyword'>_</span>   <span class='hs-varid'>other_tickish</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>other_tickish</span>
<a name="line-96"></a>
<a name="line-97"></a><a name="tidyRules"></a><span class='hs-comment'>------------  Rules  --------------</span>
<a name="line-98"></a><span class='hs-definition'>tidyRules</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreRule</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreRule</span><span class='hs-keyglyph'>]</span>
<a name="line-99"></a><span class='hs-definition'>tidyRules</span> <span class='hs-keyword'>_</span>   <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-100"></a><span class='hs-definition'>tidyRules</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>rule</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rules</span><span class='hs-layout'>)</span>
<a name="line-101"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyRule</span> <span class='hs-varid'>env</span> <span class='hs-varid'>rule</span>           <span class='hs-varop'>=:</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>rule</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-102"></a>    <span class='hs-varid'>tidyRules</span> <span class='hs-varid'>env</span> <span class='hs-varid'>rules</span>         <span class='hs-varop'>=:</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>rules</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-103"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>rule</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rules</span><span class='hs-layout'>)</span>
<a name="line-104"></a>
<a name="line-105"></a><a name="tidyRule"></a><span class='hs-definition'>tidyRule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreRule</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreRule</span>
<a name="line-106"></a><span class='hs-definition'>tidyRule</span> <span class='hs-keyword'>_</span>   <span class='hs-varid'>rule</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>BuiltinRule</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rule</span>
<a name="line-107"></a><span class='hs-definition'>tidyRule</span> <span class='hs-varid'>env</span> <span class='hs-varid'>rule</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Rule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ru_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ru_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>ru_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span>
<a name="line-108"></a>                          <span class='hs-varid'>ru_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fn</span><span class='hs-layout'>,</span> <span class='hs-varid'>ru_rough</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_ns</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-109"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndrs</span>         <span class='hs-varop'>=:</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-110"></a>    <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env'</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>    <span class='hs-varop'>=:</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-111"></a>    <span class='hs-varid'>rule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ru_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ru_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span>
<a name="line-112"></a>           <span class='hs-varid'>ru_rhs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span>
<a name="line-113"></a>           <span class='hs-varid'>ru_fn</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyNameOcc</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fn</span><span class='hs-layout'>,</span>
<a name="line-114"></a>           <span class='hs-varid'>ru_rough</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyNameOcc</span> <span class='hs-varid'>env'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>mb_ns</span> <span class='hs-layout'>}</span>
<a name="line-115"></a>
<a name="line-116"></a><span class='hs-comment'>{-
<a name="line-117"></a>************************************************************************
<a name="line-118"></a>*                                                                      *
<a name="line-119"></a>\subsection{Tidying non-top-level binders}
<a name="line-120"></a>*                                                                      *
<a name="line-121"></a>************************************************************************
<a name="line-122"></a>-}</span>
<a name="line-123"></a>
<a name="line-124"></a><a name="tidyNameOcc"></a><span class='hs-definition'>tidyNameOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-125"></a><span class='hs-comment'>-- In rules and instances, we have Names, and we must tidy them too</span>
<a name="line-126"></a><span class='hs-comment'>-- Fortunately, we can lookup in the VarEnv with a name</span>
<a name="line-127"></a><span class='hs-definition'>tidyNameOcc</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupUFM_Directly</span> <span class='hs-varid'>var_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-128"></a>                                <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>n</span>
<a name="line-129"></a>                                <span class='hs-conid'>Just</span> <span class='hs-varid'>v</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>v</span>
<a name="line-130"></a>
<a name="line-131"></a><a name="tidyVarOcc"></a><span class='hs-definition'>tidyVarOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span>
<a name="line-132"></a><span class='hs-definition'>tidyVarOcc</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>var_env</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>v</span>
<a name="line-133"></a>
<a name="line-134"></a><a name="tidyBndr"></a><span class='hs-comment'>-- tidyBndr is used for lambda and case binders</span>
<a name="line-135"></a><span class='hs-definition'>tidyBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span><span class='hs-layout'>)</span>
<a name="line-136"></a><span class='hs-definition'>tidyBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>var</span>
<a name="line-137"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyCoVar</span> <span class='hs-varid'>var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyVarBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>var</span>
<a name="line-138"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyIdBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>var</span>
<a name="line-139"></a>
<a name="line-140"></a><a name="tidyBndrs"></a><span class='hs-definition'>tidyBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-141"></a><span class='hs-definition'>tidyBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>tidyBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>vars</span>
<a name="line-142"></a>
<a name="line-143"></a><a name="tidyIdBndr"></a><span class='hs-comment'>-- Non-top-level variables, not covars</span>
<a name="line-144"></a><span class='hs-definition'>tidyIdBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-145"></a><span class='hs-definition'>tidyIdBndr</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-146"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- Do this pattern match strictly, otherwise we end up holding on to</span>
<a name="line-147"></a>    <span class='hs-comment'>-- stuff in the OccName.</span>
<a name="line-148"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tidyOccName</span> <span class='hs-varid'>tidy_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>occ'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-149"></a>    <span class='hs-keyword'>let</span>
<a name="line-150"></a>        <span class='hs-comment'>-- Give the Id a fresh print-name, *and* rename its type</span>
<a name="line-151"></a>        <span class='hs-comment'>-- The SrcLoc isn't important now,</span>
<a name="line-152"></a>        <span class='hs-comment'>-- though we could extract it from the Id</span>
<a name="line-153"></a>        <span class='hs-comment'>--</span>
<a name="line-154"></a>        <span class='hs-varid'>ty'</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-155"></a>        <span class='hs-varid'>mult'</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>idMult</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-156"></a>        <span class='hs-varid'>name'</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInternalName</span> <span class='hs-layout'>(</span><span class='hs-varid'>idUnique</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-varid'>occ'</span> <span class='hs-varid'>noSrcSpan</span>
<a name="line-157"></a>        <span class='hs-varid'>id'</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalIdWithInfo</span> <span class='hs-varid'>name'</span> <span class='hs-varid'>mult'</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>new_info</span>
<a name="line-158"></a>        <span class='hs-varid'>var_env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>var_env</span> <span class='hs-varid'>id</span> <span class='hs-varid'>id'</span>
<a name="line-159"></a>
<a name="line-160"></a>        <span class='hs-comment'>-- Note [Tidy IdInfo]</span>
<a name="line-161"></a>        <span class='hs-varid'>new_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vanillaIdInfo</span> <span class='hs-varop'>`setOccInfo`</span> <span class='hs-varid'>occInfo</span> <span class='hs-varid'>old_info</span>
<a name="line-162"></a>                                 <span class='hs-varop'>`setUnfoldingInfo`</span> <span class='hs-varid'>new_unf</span>
<a name="line-163"></a>                                  <span class='hs-comment'>-- see Note [Preserve OneShotInfo]</span>
<a name="line-164"></a>                                 <span class='hs-varop'>`setOneShotInfo`</span> <span class='hs-varid'>oneShotInfo</span> <span class='hs-varid'>old_info</span>
<a name="line-165"></a>        <span class='hs-varid'>old_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span>
<a name="line-166"></a>        <span class='hs-varid'>old_unf</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unfoldingInfo</span> <span class='hs-varid'>old_info</span>
<a name="line-167"></a>        <span class='hs-varid'>new_unf</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zapUnfolding</span> <span class='hs-varid'>old_unf</span>  <span class='hs-comment'>-- See Note [Preserve evaluatedness]</span>
<a name="line-168"></a>    <span class='hs-keyword'>in</span>
<a name="line-169"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>tidy_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>id'</span><span class='hs-layout'>)</span>
<a name="line-170"></a>   <span class='hs-layout'>}</span>
<a name="line-171"></a>
<a name="line-172"></a><a name="tidyLetBndr"></a><span class='hs-definition'>tidyLetBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span>         <span class='hs-comment'>-- Knot-tied version for unfoldings</span>
<a name="line-173"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyEnv</span>         <span class='hs-comment'>-- The one to extend</span>
<a name="line-174"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-175"></a><span class='hs-comment'>-- Used for local (non-top-level) let(rec)s</span>
<a name="line-176"></a><span class='hs-comment'>-- Just like tidyIdBndr above, but with more IdInfo</span>
<a name="line-177"></a><span class='hs-definition'>tidyLetBndr</span> <span class='hs-varid'>rec_tidy_env</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-178"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tidyOccName</span> <span class='hs-varid'>tidy_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>occ'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-179"></a>    <span class='hs-keyword'>let</span>
<a name="line-180"></a>        <span class='hs-varid'>ty'</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-181"></a>        <span class='hs-varid'>mult'</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>idMult</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-182"></a>        <span class='hs-varid'>name'</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInternalName</span> <span class='hs-layout'>(</span><span class='hs-varid'>idUnique</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-varid'>occ'</span> <span class='hs-varid'>noSrcSpan</span>
<a name="line-183"></a>        <span class='hs-varid'>details</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span>
<a name="line-184"></a>        <span class='hs-varid'>id'</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalVar</span> <span class='hs-varid'>details</span> <span class='hs-varid'>name'</span> <span class='hs-varid'>mult'</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>new_info</span>
<a name="line-185"></a>        <span class='hs-varid'>var_env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>var_env</span> <span class='hs-varid'>id</span> <span class='hs-varid'>id'</span>
<a name="line-186"></a>
<a name="line-187"></a>        <span class='hs-comment'>-- Note [Tidy IdInfo]</span>
<a name="line-188"></a>        <span class='hs-comment'>-- We need to keep around any interesting strictness and</span>
<a name="line-189"></a>        <span class='hs-comment'>-- demand info because later on we may need to use it when</span>
<a name="line-190"></a>        <span class='hs-comment'>-- converting to A-normal form.</span>
<a name="line-191"></a>        <span class='hs-comment'>-- eg.</span>
<a name="line-192"></a>        <span class='hs-comment'>--      f (g x),  where f is strict in its argument, will be converted</span>
<a name="line-193"></a>        <span class='hs-comment'>--      into  case (g x) of z -&gt; f z  by CorePrep, but only if f still</span>
<a name="line-194"></a>        <span class='hs-comment'>--      has its strictness info.</span>
<a name="line-195"></a>        <span class='hs-comment'>--</span>
<a name="line-196"></a>        <span class='hs-comment'>-- Similarly for the demand info - on a let binder, this tells</span>
<a name="line-197"></a>        <span class='hs-comment'>-- CorePrep to turn the let into a case.</span>
<a name="line-198"></a>        <span class='hs-comment'>-- But: Remove the usage demand here</span>
<a name="line-199"></a>        <span class='hs-comment'>--      (See Note [Zapping DmdEnv after Demand Analyzer] in GHC.Core.Opt.WorkWrap)</span>
<a name="line-200"></a>        <span class='hs-comment'>--</span>
<a name="line-201"></a>        <span class='hs-comment'>-- Similarly arity info for eta expansion in CorePrep</span>
<a name="line-202"></a>        <span class='hs-comment'>-- Don't attempt to recompute arity here; this is just tidying!</span>
<a name="line-203"></a>        <span class='hs-comment'>-- Trying to do so led to #17294</span>
<a name="line-204"></a>        <span class='hs-comment'>--</span>
<a name="line-205"></a>        <span class='hs-comment'>-- Set inline-prag info so that we preserve it across</span>
<a name="line-206"></a>        <span class='hs-comment'>-- separate compilation boundaries</span>
<a name="line-207"></a>        <span class='hs-varid'>old_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span>
<a name="line-208"></a>        <span class='hs-varid'>new_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vanillaIdInfo</span>
<a name="line-209"></a>                    <span class='hs-varop'>`setOccInfo`</span>        <span class='hs-varid'>occInfo</span> <span class='hs-varid'>old_info</span>
<a name="line-210"></a>                    <span class='hs-varop'>`setArityInfo`</span>      <span class='hs-varid'>arityInfo</span> <span class='hs-varid'>old_info</span>
<a name="line-211"></a>                    <span class='hs-varop'>`setStrictnessInfo`</span> <span class='hs-varid'>zapDmdEnvSig</span> <span class='hs-layout'>(</span><span class='hs-varid'>strictnessInfo</span> <span class='hs-varid'>old_info</span><span class='hs-layout'>)</span>
<a name="line-212"></a>                    <span class='hs-varop'>`setDemandInfo`</span>     <span class='hs-varid'>demandInfo</span> <span class='hs-varid'>old_info</span>
<a name="line-213"></a>                    <span class='hs-varop'>`setInlinePragInfo`</span> <span class='hs-varid'>inlinePragInfo</span> <span class='hs-varid'>old_info</span>
<a name="line-214"></a>                    <span class='hs-varop'>`setUnfoldingInfo`</span>  <span class='hs-varid'>new_unf</span>
<a name="line-215"></a>
<a name="line-216"></a>        <span class='hs-varid'>old_unf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unfoldingInfo</span> <span class='hs-varid'>old_info</span>
<a name="line-217"></a>        <span class='hs-varid'>new_unf</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isStableUnfolding</span> <span class='hs-varid'>old_unf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyUnfolding</span> <span class='hs-varid'>rec_tidy_env</span> <span class='hs-varid'>old_unf</span> <span class='hs-varid'>old_unf</span>
<a name="line-218"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zapUnfolding</span> <span class='hs-varid'>old_unf</span>
<a name="line-219"></a>                                              <span class='hs-comment'>-- See Note [Preserve evaluatedness]</span>
<a name="line-220"></a>
<a name="line-221"></a>    <span class='hs-keyword'>in</span>
<a name="line-222"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>tidy_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>id'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-223"></a>
<a name="line-224"></a><a name="tidyUnfolding"></a><span class='hs-comment'>------------ Unfolding  --------------</span>
<a name="line-225"></a><span class='hs-definition'>tidyUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-226"></a><span class='hs-definition'>tidyUnfolding</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>df</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DFunUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>df_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>df_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>
<a name="line-227"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>df</span> <span class='hs-layout'>{</span> <span class='hs-varid'>df_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>df_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>tidy_env'</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-layout'>}</span>
<a name="line-228"></a>  <span class='hs-keyword'>where</span>
<a name="line-229"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyBndrs</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>bndrs</span>
<a name="line-230"></a>
<a name="line-231"></a><span class='hs-definition'>tidyUnfolding</span> <span class='hs-varid'>tidy_env</span>
<a name="line-232"></a>              <span class='hs-varid'>unf</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoreUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uf_tmpl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unf_rhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>uf_src</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-233"></a>              <span class='hs-varid'>unf_from_rhs</span>
<a name="line-234"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isStableSource</span> <span class='hs-varid'>src</span>
<a name="line-235"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqIt</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unf</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uf_tmpl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>unf_rhs</span> <span class='hs-layout'>}</span>    <span class='hs-comment'>-- Preserves OccInfo</span>
<a name="line-236"></a>    <span class='hs-comment'>-- This seqIt avoids a space leak: otherwise the uf_is_value,</span>
<a name="line-237"></a>    <span class='hs-comment'>-- uf_is_conlike, ... fields may retain a reference to the</span>
<a name="line-238"></a>    <span class='hs-comment'>-- pre-tidied expression forever (GHC.CoreToIface doesn't look at them)</span>
<a name="line-239"></a>
<a name="line-240"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-241"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unf_from_rhs</span>
<a name="line-242"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>seqIt</span> <span class='hs-varid'>unf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqUnfolding</span> <span class='hs-varid'>unf</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>unf</span>
<a name="line-243"></a><span class='hs-definition'>tidyUnfolding</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>unf</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unf</span>     <span class='hs-comment'>-- NoUnfolding or OtherCon</span>
<a name="line-244"></a>
<a name="line-245"></a><span class='hs-comment'>{-
<a name="line-246"></a>Note [Tidy IdInfo]
<a name="line-247"></a>~~~~~~~~~~~~~~~~~~
<a name="line-248"></a>All nested Ids now have the same IdInfo, namely vanillaIdInfo, which
<a name="line-249"></a>should save some space; except that we preserve occurrence info for
<a name="line-250"></a>two reasons:
<a name="line-251"></a>
<a name="line-252"></a>  (a) To make printing tidy core nicer
<a name="line-253"></a>
<a name="line-254"></a>  (b) Because we tidy RULES and InlineRules, which may then propagate
<a name="line-255"></a>      via --make into the compilation of the next module, and we want
<a name="line-256"></a>      the benefit of that occurrence analysis when we use the rule or
<a name="line-257"></a>      or inline the function.  In particular, it's vital not to lose
<a name="line-258"></a>      loop-breaker info, else we get an infinite inlining loop
<a name="line-259"></a>
<a name="line-260"></a>Note that tidyLetBndr puts more IdInfo back.
<a name="line-261"></a>
<a name="line-262"></a>Note [Preserve evaluatedness]
<a name="line-263"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-264"></a>Consider
<a name="line-265"></a>  data T = MkT !Bool
<a name="line-266"></a>  ....(case v of MkT y -&gt;
<a name="line-267"></a>       let z# = case y of
<a name="line-268"></a>                  True -&gt; 1#
<a name="line-269"></a>                  False -&gt; 2#
<a name="line-270"></a>       in ...)
<a name="line-271"></a>
<a name="line-272"></a>The z# binding is ok because the RHS is ok-for-speculation,
<a name="line-273"></a>but Lint will complain unless it can *see* that.  So we
<a name="line-274"></a>preserve the evaluated-ness on 'y' in tidyBndr.
<a name="line-275"></a>
<a name="line-276"></a>(Another alternative would be to tidy unboxed lets into cases,
<a name="line-277"></a>but that seems more indirect and surprising.)
<a name="line-278"></a>
<a name="line-279"></a>Note [Preserve OneShotInfo]
<a name="line-280"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-281"></a>We keep the OneShotInfo because we want it to propagate into the interface.
<a name="line-282"></a>Not all OneShotInfo is determined by a compiler analysis; some is added by a
<a name="line-283"></a>call of GHC.Exts.oneShot, which is then discarded before the end of the
<a name="line-284"></a>optimisation pipeline, leaving only the OneShotInfo on the lambda. Hence we
<a name="line-285"></a>must preserve this info in inlinings. See Note [The oneShot function] in GHC.Types.Id.Make.
<a name="line-286"></a>
<a name="line-287"></a>This applies to lambda binders only, hence it is stored in IfaceLamBndr.
<a name="line-288"></a>-}</span>
<a name="line-289"></a>
<a name="line-290"></a><a name="=:"></a><span class='hs-layout'>(</span><span class='hs-varop'>=:</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-291"></a><a name="m"></a><span class='hs-definition'>m</span> <span class='hs-varop'>=:</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>k</span> <span class='hs-varid'>m</span>
</pre></body>
</html>
