<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Tc/Gen/Splice.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP                    #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE FlexibleInstances      #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE FunctionalDependencies #-}</span>
<a name="line-4"></a><span class='hs-comment'>{-# LANGUAGE GADTs                  #-}</span>
<a name="line-5"></a><span class='hs-comment'>{-# LANGUAGE InstanceSigs           #-}</span>
<a name="line-6"></a><span class='hs-comment'>{-# LANGUAGE MultiWayIf             #-}</span>
<a name="line-7"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables    #-}</span>
<a name="line-8"></a><span class='hs-comment'>{-# LANGUAGE TupleSections          #-}</span>
<a name="line-9"></a><span class='hs-comment'>{-# LANGUAGE TypeFamilies           #-}</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-comment'>{-# OPTIONS_GHC -fno-warn-orphans #-}</span>
<a name="line-12"></a><span class='hs-comment'>{-# OPTIONS_GHC -Wno-incomplete-uni-patterns #-}</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-comment'>{-
<a name="line-15"></a>(c) The University of Glasgow 2006
<a name="line-16"></a>(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
<a name="line-17"></a>
<a name="line-18"></a>-}</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-comment'>-- | Template Haskell splices</span>
<a name="line-21"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Tc.Gen.Splice</span><span class='hs-layout'>(</span>
<a name="line-22"></a>     <span class='hs-varid'>tcSpliceExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcTypedBracket</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcUntypedBracket</span><span class='hs-layout'>,</span>
<a name="line-23"></a><span class='hs-comment'>--     runQuasiQuoteExpr, runQuasiQuotePat,</span>
<a name="line-24"></a><span class='hs-comment'>--     runQuasiQuoteDecl, runQuasiQuoteType,</span>
<a name="line-25"></a>     <span class='hs-varid'>runAnnotation</span><span class='hs-layout'>,</span>
<a name="line-26"></a>
<a name="line-27"></a>     <span class='hs-varid'>runMetaE</span><span class='hs-layout'>,</span> <span class='hs-varid'>runMetaP</span><span class='hs-layout'>,</span> <span class='hs-varid'>runMetaT</span><span class='hs-layout'>,</span> <span class='hs-varid'>runMetaD</span><span class='hs-layout'>,</span> <span class='hs-varid'>runQuasi</span><span class='hs-layout'>,</span>
<a name="line-28"></a>     <span class='hs-varid'>tcTopSpliceExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupThName_maybe</span><span class='hs-layout'>,</span>
<a name="line-29"></a>     <span class='hs-varid'>defaultRunMeta</span><span class='hs-layout'>,</span> <span class='hs-varid'>runMeta'</span><span class='hs-layout'>,</span> <span class='hs-varid'>runRemoteModFinalizers</span><span class='hs-layout'>,</span>
<a name="line-30"></a>     <span class='hs-varid'>finishTH</span><span class='hs-layout'>,</span> <span class='hs-varid'>runTopSplice</span>
<a name="line-31"></a>      <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-34"></a>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Plugins</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Main</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Session</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Env</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Hooks</span>
<a name="line-42"></a>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Hs</span>
<a name="line-44"></a>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Monad</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.TcType</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Gen.Expr</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Unify</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Env</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Types.Origin</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Types.Evidence</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Zonk</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Solver</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.TcMType</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Gen.HsType</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Instance.Family</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Instantiate</span>
<a name="line-58"></a>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Multiplicity</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Coercion</span><span class='hs-layout'>(</span> <span class='hs-varid'>etaExpandCoAxBranch</span> <span class='hs-layout'>)</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Type</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Type</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCo.Rep</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TyCoRep</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.FamInstEnv</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.InstEnv</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>InstEnv</span>
<a name="line-65"></a>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Names.TH</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Names</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Types</span>
<a name="line-69"></a>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.ThToHs</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.HsToCore.Docs</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.HsToCore.Expr</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.HsToCore.Monad</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IfaceToCore</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Iface.Load</span>
<a name="line-76"></a>
<a name="line-77"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHCi.Message</span>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHCi.RemoteTypes</span>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Runtime.Interpreter</span>
<a name="line-80"></a>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Rename.Splice</span><span class='hs-layout'>(</span> <span class='hs-varid'>traceSplice</span><span class='hs-layout'>,</span> <span class='hs-conid'>SpliceInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-82"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Rename.Expr</span>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Rename.Env</span>
<a name="line-84"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Rename.Utils</span>  <span class='hs-layout'>(</span> <span class='hs-conid'>HsDocContext</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-85"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Rename.Fixity</span> <span class='hs-layout'>(</span> <span class='hs-varid'>lookupFixityRn_help</span> <span class='hs-layout'>)</span>
<a name="line-86"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Rename.HsType</span>
<a name="line-87"></a>
<a name="line-88"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Class</span>
<a name="line-89"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCon</span>
<a name="line-90"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Coercion.Axiom</span>
<a name="line-91"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.PatSyn</span>
<a name="line-92"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.ConLike</span>
<a name="line-93"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.DataCon</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>DataCon</span>
<a name="line-94"></a>
<a name="line-95"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.FieldLabel</span>
<a name="line-96"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SrcLoc</span>
<a name="line-97"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Env</span>
<a name="line-98"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Set</span>
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Reader</span>
<a name="line-100"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Occurrence</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>OccName</span>
<a name="line-101"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var</span>
<a name="line-102"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Id</span>
<a name="line-103"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Id.Info</span>
<a name="line-104"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique</span>
<a name="line-105"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var.Set</span>
<a name="line-106"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Meta</span>
<a name="line-107"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Basic</span> <span class='hs-varid'>hiding</span><span class='hs-layout'>(</span> <span class='hs-conid'>SuccessFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-108"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Error</span>
<a name="line-109"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Fixity</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Hs</span>
<a name="line-110"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Annotations</span>
<a name="line-111"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name</span>
<a name="line-112"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Serialized</span>
<a name="line-113"></a>
<a name="line-114"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Finder</span>
<a name="line-115"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module</span>
<a name="line-116"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.ModIface</span>
<a name="line-117"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.Deps</span>
<a name="line-118"></a>
<a name="line-119"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-120"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Panic</span>
<a name="line-121"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Lexeme</span>
<a name="line-122"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-123"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Logger</span>
<a name="line-124"></a>
<a name="line-125"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.TmpFs</span> <span class='hs-layout'>(</span> <span class='hs-varid'>newTempName</span><span class='hs-layout'>,</span> <span class='hs-conid'>TempFileLifetime</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-126"></a>
<a name="line-127"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.FastString</span>
<a name="line-128"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Maybe</span><span class='hs-layout'>(</span> <span class='hs-conid'>MaybeErr</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-129"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.Data.EnumSet</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>EnumSet</span>
<a name="line-130"></a>
<a name="line-131"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Language.Haskell.TH</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TH</span>
<a name="line-132"></a><span class='hs-comment'>-- THSyntax gives access to internal functions and data types</span>
<a name="line-133"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Language.Haskell.TH.Syntax</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TH</span>
<a name="line-134"></a>
<a name="line-135"></a><span class='hs-cpp'>#if defined(HAVE_INTERNAL_INTERPRETER)</span>
<a name="line-136"></a><span class='hs-comment'>-- Because GHC.Desugar might not be in the base library of the bootstrapping compiler</span>
<a name="line-137"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Desugar</span>      <span class='hs-layout'>(</span> <span class='hs-conid'>AnnotationWrapper</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-138"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unsafe.Coerce</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>unsafeCoerce</span> <span class='hs-layout'>)</span>
<a name="line-139"></a><span class='hs-cpp'>#endif</span>
<a name="line-140"></a>
<a name="line-141"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad</span>
<a name="line-142"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Exception</span>
<a name="line-143"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Binary</span>
<a name="line-144"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Binary.Get</span>
<a name="line-145"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>find</span> <span class='hs-layout'>)</span>
<a name="line-146"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Maybe</span>
<a name="line-147"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.ByteString</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>B</span>
<a name="line-148"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.ByteString.Lazy</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>LB</span>
<a name="line-149"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Dynamic</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>fromDynamic</span><span class='hs-layout'>,</span> <span class='hs-varid'>toDyn</span> <span class='hs-layout'>)</span>
<a name="line-150"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.IntMap</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>IntMap</span>
<a name="line-151"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-152"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Typeable</span> <span class='hs-layout'>(</span> <span class='hs-varid'>typeOf</span><span class='hs-layout'>,</span> <span class='hs-conid'>Typeable</span><span class='hs-layout'>,</span> <span class='hs-conid'>TypeRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>typeRep</span> <span class='hs-layout'>)</span>
<a name="line-153"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Data</span> <span class='hs-layout'>(</span><span class='hs-conid'>Data</span><span class='hs-layout'>)</span>
<a name="line-154"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Proxy</span>    <span class='hs-layout'>(</span> <span class='hs-conid'>Proxy</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-155"></a>
<a name="line-156"></a><span class='hs-comment'>{-
<a name="line-157"></a>************************************************************************
<a name="line-158"></a>*                                                                      *
<a name="line-159"></a>\subsection{Main interface + stubs for the non-GHCI case
<a name="line-160"></a>*                                                                      *
<a name="line-161"></a>************************************************************************
<a name="line-162"></a>-}</span>
<a name="line-163"></a>
<a name="line-164"></a><a name="tcTypedBracket"></a><span class='hs-definition'>tcTypedBracket</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsBracket</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcTc</span><span class='hs-layout'>)</span>
<a name="line-165"></a><a name="tcUntypedBracket"></a><span class='hs-definition'>tcUntypedBracket</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsBracket</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PendingRnSplice</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span>
<a name="line-166"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcTc</span><span class='hs-layout'>)</span>
<a name="line-167"></a><a name="tcSpliceExpr"></a><span class='hs-definition'>tcSpliceExpr</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSplice</span> <span class='hs-conid'>GhcRn</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcTc</span><span class='hs-layout'>)</span>
<a name="line-168"></a>        <span class='hs-comment'>-- None of these functions add constraints to the LIE</span>
<a name="line-169"></a>
<a name="line-170"></a><span class='hs-comment'>-- runQuasiQuoteExpr :: HsQuasiQuote RdrName -&gt; RnM (LHsExpr RdrName)</span>
<a name="line-171"></a><span class='hs-comment'>-- runQuasiQuotePat  :: HsQuasiQuote RdrName -&gt; RnM (LPat RdrName)</span>
<a name="line-172"></a><span class='hs-comment'>-- runQuasiQuoteType :: HsQuasiQuote RdrName -&gt; RnM (LHsType RdrName)</span>
<a name="line-173"></a><span class='hs-comment'>-- runQuasiQuoteDecl :: HsQuasiQuote RdrName -&gt; RnM [LHsDecl RdrName]</span>
<a name="line-174"></a>
<a name="line-175"></a><a name="runAnnotation"></a><span class='hs-definition'>runAnnotation</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreAnnTarget</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Annotation</span>
<a name="line-176"></a><span class='hs-comment'>{-
<a name="line-177"></a>************************************************************************
<a name="line-178"></a>*                                                                      *
<a name="line-179"></a>\subsection{Quoting an expression}
<a name="line-180"></a>*                                                                      *
<a name="line-181"></a>************************************************************************
<a name="line-182"></a>-}</span>
<a name="line-183"></a>
<a name="line-184"></a><span class='hs-comment'>-- See Note [How brackets and nested splices are handled]</span>
<a name="line-185"></a><span class='hs-comment'>-- tcTypedBracket :: HsBracket Name -&gt; TcRhoType -&gt; TcM (HsExpr TcId)</span>
<a name="line-186"></a><span class='hs-definition'>tcTypedBracket</span> <span class='hs-varid'>rn_expr</span> <span class='hs-varid'>brack</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TExpBr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-187"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotationCtxtDoc</span> <span class='hs-varid'>brack</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-188"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cur_stage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getStage</span>
<a name="line-189"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ps_ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMutVar</span> <span class='hs-conid'>[]</span>
<a name="line-190"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lie_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getConstraintVar</span>   <span class='hs-comment'>-- Any constraints arising from nested splices</span>
<a name="line-191"></a>                                       <span class='hs-comment'>-- should get thrown into the constraint set</span>
<a name="line-192"></a>                                       <span class='hs-comment'>-- from outside the bracket</span>
<a name="line-193"></a>
<a name="line-194"></a>       <span class='hs-comment'>-- Make a new type variable for the type of the overall quote</span>
<a name="line-195"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>m_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>mkMetaTyVar</span>
<a name="line-196"></a>       <span class='hs-comment'>-- Make sure the type variable satisfies Quote</span>
<a name="line-197"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>emitQuoteWanted</span> <span class='hs-varid'>m_var</span>
<a name="line-198"></a>       <span class='hs-comment'>-- Bundle them together so they can be used in GHC.HsToCore.Quote for desugaring</span>
<a name="line-199"></a>       <span class='hs-comment'>-- brackets.</span>
<a name="line-200"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>wrapper</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>QuoteWrapper</span> <span class='hs-varid'>ev_var</span> <span class='hs-varid'>m_var</span>
<a name="line-201"></a>       <span class='hs-comment'>-- Typecheck expr to make sure it is valid,</span>
<a name="line-202"></a>       <span class='hs-comment'>-- Throw away the typechecked expression but return its type.</span>
<a name="line-203"></a>       <span class='hs-comment'>-- We'll typecheck it again when we splice it in somewhere</span>
<a name="line-204"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-sel'>_tc_expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setStage</span> <span class='hs-layout'>(</span><span class='hs-conid'>Brack</span> <span class='hs-varid'>cur_stage</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPending</span> <span class='hs-varid'>ps_ref</span> <span class='hs-varid'>lie_var</span> <span class='hs-varid'>wrapper</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-205"></a>                                <span class='hs-varid'>tcScalingUsage</span> <span class='hs-conid'>Many</span> <span class='hs-varop'>$</span>
<a name="line-206"></a>                                <span class='hs-comment'>-- Scale by Many, TH lifting is currently nonlinear (#18465)</span>
<a name="line-207"></a>                                <span class='hs-varid'>tcInferRhoNC</span> <span class='hs-varid'>expr</span>
<a name="line-208"></a>                                <span class='hs-comment'>-- NC for no context; tcBracket does that</span>
<a name="line-209"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getRuntimeRep</span> <span class='hs-varid'>expr_ty</span>
<a name="line-210"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>meta_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTExpTy</span> <span class='hs-varid'>m_var</span> <span class='hs-varid'>expr_ty</span>
<a name="line-211"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ps'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ps_ref</span>
<a name="line-212"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>texpco</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>unsafeCodeCoerceName</span>
<a name="line-213"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcWrapResultO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Shouldn'tHappenOrigin</span> <span class='hs-str'>"TExpBr"</span><span class='hs-layout'>)</span>
<a name="line-214"></a>                       <span class='hs-varid'>rn_expr</span>
<a name="line-215"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLHsWrap</span> <span class='hs-layout'>(</span><span class='hs-varid'>applyQuoteWrapper</span> <span class='hs-varid'>wrapper</span><span class='hs-layout'>)</span>
<a name="line-216"></a>                                                  <span class='hs-layout'>(</span><span class='hs-varid'>nlHsTyApp</span> <span class='hs-varid'>texpco</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>rep</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-217"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>noLocA</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTcBracketOut</span> <span class='hs-varid'>noExtField</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>wrapper</span><span class='hs-layout'>)</span> <span class='hs-varid'>brack</span> <span class='hs-varid'>ps'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-218"></a>                       <span class='hs-varid'>meta_ty</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span>
<a name="line-219"></a><span class='hs-definition'>tcTypedBracket</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>other_brack</span> <span class='hs-keyword'>_</span>
<a name="line-220"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcTypedBracket"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other_brack</span><span class='hs-layout'>)</span>
<a name="line-221"></a>
<a name="line-222"></a><span class='hs-comment'>-- tcUntypedBracket :: HsBracket Name -&gt; [PendingRnSplice] -&gt; ExpRhoType -&gt; TcM (HsExpr TcId)</span>
<a name="line-223"></a><span class='hs-comment'>-- See Note [Typechecking Overloaded Quotes]</span>
<a name="line-224"></a><span class='hs-definition'>tcUntypedBracket</span> <span class='hs-varid'>rn_expr</span> <span class='hs-varid'>brack</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>res_ty</span>
<a name="line-225"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_bracket untyped"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>brack</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-226"></a>
<a name="line-227"></a>
<a name="line-228"></a>       <span class='hs-comment'>-- Create the type m Exp for expression bracket, m Type for a type</span>
<a name="line-229"></a>       <span class='hs-comment'>-- bracket and so on. The brack_info is a Maybe because the</span>
<a name="line-230"></a>       <span class='hs-comment'>-- VarBracket ('a) isn't overloaded, but also shouldn't contain any</span>
<a name="line-231"></a>       <span class='hs-comment'>-- splices.</span>
<a name="line-232"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>brack_info</span><span class='hs-layout'>,</span> <span class='hs-varid'>expected_type</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>brackTy</span> <span class='hs-varid'>brack</span>
<a name="line-233"></a>
<a name="line-234"></a>       <span class='hs-comment'>-- Match the expected type with the type of all the internal</span>
<a name="line-235"></a>       <span class='hs-comment'>-- splices. They might have further constrained types and if they do</span>
<a name="line-236"></a>       <span class='hs-comment'>-- we want to reflect that in the overall type of the bracket.</span>
<a name="line-237"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ps'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>quoteWrapperTyVarTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>brack_info</span> <span class='hs-keyword'>of</span>
<a name="line-238"></a>                  <span class='hs-conid'>Just</span> <span class='hs-varid'>m_var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcPendingSplice</span> <span class='hs-varid'>m_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>ps</span>
<a name="line-239"></a>                  <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-240"></a>
<a name="line-241"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_bracket done untyped"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>expected_type</span><span class='hs-layout'>)</span>
<a name="line-242"></a>
<a name="line-243"></a>       <span class='hs-comment'>-- Unify the overall type of the bracket with the expected result</span>
<a name="line-244"></a>       <span class='hs-comment'>-- type</span>
<a name="line-245"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcWrapResultO</span> <span class='hs-conid'>BracketOrigin</span> <span class='hs-varid'>rn_expr</span>
<a name="line-246"></a>            <span class='hs-layout'>(</span><span class='hs-conid'>HsTcBracketOut</span> <span class='hs-varid'>noExtField</span> <span class='hs-varid'>brack_info</span> <span class='hs-varid'>brack</span> <span class='hs-varid'>ps'</span><span class='hs-layout'>)</span>
<a name="line-247"></a>            <span class='hs-varid'>expected_type</span> <span class='hs-varid'>res_ty</span>
<a name="line-248"></a>
<a name="line-249"></a>       <span class='hs-layout'>}</span>
<a name="line-250"></a>
<a name="line-251"></a><a name="mkMetaTyVar"></a><span class='hs-comment'>-- | A type variable with kind * -&gt; * named "m"</span>
<a name="line-252"></a><span class='hs-definition'>mkMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TyVar</span>
<a name="line-253"></a><span class='hs-definition'>mkMetaTyVar</span> <span class='hs-keyglyph'>=</span>
<a name="line-254"></a>  <span class='hs-varid'>newNamedFlexiTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"m"</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVisFunTyMany</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>liftedTypeKind</span><span class='hs-layout'>)</span>
<a name="line-255"></a>
<a name="line-256"></a>
<a name="line-257"></a><a name="emitQuoteWanted"></a><span class='hs-comment'>-- | For a type 'm', emit the constraint 'Quote m'.</span>
<a name="line-258"></a><span class='hs-definition'>emitQuoteWanted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>EvVar</span>
<a name="line-259"></a><span class='hs-definition'>emitQuoteWanted</span> <span class='hs-varid'>m_var</span> <span class='hs-keyglyph'>=</span>  <span class='hs-keyword'>do</span>
<a name="line-260"></a>        <span class='hs-varid'>quote_con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupTyCon</span> <span class='hs-varid'>quoteClassName</span>
<a name="line-261"></a>        <span class='hs-varid'>emitWantedEvVar</span> <span class='hs-conid'>BracketOrigin</span> <span class='hs-varop'>$</span>
<a name="line-262"></a>          <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>quote_con</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>m_var</span><span class='hs-keyglyph'>]</span>
<a name="line-263"></a>
<a name="line-264"></a><a name="brackTy"></a><span class='hs-comment'>---------------</span>
<a name="line-265"></a><span class='hs-comment'>-- | Compute the expected type of a quotation, and also the QuoteWrapper in</span>
<a name="line-266"></a><span class='hs-comment'>-- the case where it is an overloaded quotation. All quotation forms are</span>
<a name="line-267"></a><span class='hs-comment'>-- overloaded aprt from Variable quotations ('foo)</span>
<a name="line-268"></a><span class='hs-definition'>brackTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsBracket</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>QuoteWrapper</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-269"></a><span class='hs-definition'>brackTy</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span>
<a name="line-270"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>mkTy</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-271"></a>        <span class='hs-comment'>-- New polymorphic type variable for the bracket</span>
<a name="line-272"></a>        <span class='hs-varid'>m_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>mkMetaTyVar</span>
<a name="line-273"></a>        <span class='hs-comment'>-- Emit a Quote constraint for the bracket</span>
<a name="line-274"></a>        <span class='hs-varid'>ev_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>emitQuoteWanted</span> <span class='hs-varid'>m_var</span>
<a name="line-275"></a>        <span class='hs-comment'>-- Construct the final expected type of the quote, for example</span>
<a name="line-276"></a>        <span class='hs-comment'>-- m Exp or m Type</span>
<a name="line-277"></a>        <span class='hs-varid'>final_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>m_var</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>n</span>
<a name="line-278"></a>        <span class='hs-comment'>-- Return the evidence variable and metavariable to be used during</span>
<a name="line-279"></a>        <span class='hs-comment'>-- desugaring.</span>
<a name="line-280"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>wrapper</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>QuoteWrapper</span> <span class='hs-varid'>ev_var</span> <span class='hs-varid'>m_var</span>
<a name="line-281"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>wrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>final_ty</span><span class='hs-layout'>)</span>
<a name="line-282"></a>  <span class='hs-keyword'>in</span>
<a name="line-283"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>of</span>
<a name="line-284"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>VarBr</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>nameTyConName</span>
<a name="line-285"></a>                                           <span class='hs-comment'>-- Result type is Var (not Quote-monadic)</span>
<a name="line-286"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>ExpBr</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkTy</span> <span class='hs-varid'>expTyConName</span>  <span class='hs-comment'>-- Result type is m Exp</span>
<a name="line-287"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>TypBr</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkTy</span> <span class='hs-varid'>typeTyConName</span> <span class='hs-comment'>-- Result type is m Type</span>
<a name="line-288"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>DecBrG</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkTy</span> <span class='hs-varid'>decsTyConName</span> <span class='hs-comment'>-- Result type is m [Dec]</span>
<a name="line-289"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>PatBr</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkTy</span> <span class='hs-varid'>patTyConName</span>  <span class='hs-comment'>-- Result type is m Pat</span>
<a name="line-290"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>DecBrL</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcBrackTy: Unexpected DecBrL"</span>
<a name="line-291"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>TExpBr</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcUntypedBracket: Unexpected TExpBr"</span>
<a name="line-292"></a>
<a name="line-293"></a><a name="tcPendingSplice"></a><span class='hs-comment'>---------------</span>
<a name="line-294"></a><span class='hs-comment'>-- | Typechecking a pending splice from a untyped bracket</span>
<a name="line-295"></a><span class='hs-definition'>tcPendingSplice</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-comment'>-- Metavariable for the expected overall type of the</span>
<a name="line-296"></a>                          <span class='hs-comment'>-- quotation.</span>
<a name="line-297"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PendingRnSplice</span>
<a name="line-298"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>PendingTcSplice</span>
<a name="line-299"></a><span class='hs-definition'>tcPendingSplice</span> <span class='hs-varid'>m_var</span> <span class='hs-layout'>(</span><span class='hs-conid'>PendingRnSplice</span> <span class='hs-varid'>flavour</span> <span class='hs-varid'>splice_name</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-300"></a>  <span class='hs-comment'>-- See Note [Typechecking Overloaded Quotes]</span>
<a name="line-301"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>meta_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>meta_ty_name</span>
<a name="line-302"></a>         <span class='hs-comment'>-- Expected type of splice, e.g. m Exp</span>
<a name="line-303"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>expected_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>m_var</span> <span class='hs-varid'>meta_ty</span>
<a name="line-304"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcScalingUsage</span> <span class='hs-conid'>Many</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcCheckPolyExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>expected_type</span>
<a name="line-305"></a>                  <span class='hs-comment'>-- Scale by Many, TH lifting is currently nonlinear (#18465)</span>
<a name="line-306"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PendingTcSplice</span> <span class='hs-varid'>splice_name</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-307"></a>  <span class='hs-keyword'>where</span>
<a name="line-308"></a>     <span class='hs-varid'>meta_ty_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>flavour</span> <span class='hs-keyword'>of</span>
<a name="line-309"></a>                       <span class='hs-conid'>UntypedExpSplice</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>expTyConName</span>
<a name="line-310"></a>                       <span class='hs-conid'>UntypedPatSplice</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patTyConName</span>
<a name="line-311"></a>                       <span class='hs-conid'>UntypedTypeSplice</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>typeTyConName</span>
<a name="line-312"></a>                       <span class='hs-conid'>UntypedDeclSplice</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>decsTyConName</span>
<a name="line-313"></a>
<a name="line-314"></a><a name="tcTExpTy"></a><span class='hs-comment'>---------------</span>
<a name="line-315"></a><span class='hs-comment'>-- Takes a m and tau and returns the type m (TExp tau)</span>
<a name="line-316"></a><span class='hs-definition'>tcTExpTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-317"></a><span class='hs-definition'>tcTExpTy</span> <span class='hs-varid'>m_ty</span> <span class='hs-varid'>exp_ty</span>
<a name="line-318"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTauTy</span> <span class='hs-varid'>exp_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>err_msg</span> <span class='hs-varid'>exp_ty</span><span class='hs-layout'>)</span>
<a name="line-319"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>codeCon</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupTyCon</span> <span class='hs-varid'>codeTyConName</span>
<a name="line-320"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getRuntimeRep</span> <span class='hs-varid'>exp_ty</span>
<a name="line-321"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>codeCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>rep</span><span class='hs-layout'>,</span> <span class='hs-varid'>m_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>exp_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-322"></a>  <span class='hs-keyword'>where</span>
<a name="line-323"></a>    <span class='hs-varid'>err_msg</span> <span class='hs-varid'>ty</span>
<a name="line-324"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Illegal polytype:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-325"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"The type of a Typed Template Haskell expression must"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-326"></a>               <span class='hs-varid'>text</span> <span class='hs-str'>"not have any quantification."</span> <span class='hs-keyglyph'>]</span>
<a name="line-327"></a>
<a name="line-328"></a><a name="quotationCtxtDoc"></a><span class='hs-definition'>quotationCtxtDoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsBracket</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-329"></a><span class='hs-definition'>quotationCtxtDoc</span> <span class='hs-varid'>br_body</span>
<a name="line-330"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"In the Template Haskell quotation"</span><span class='hs-layout'>)</span>
<a name="line-331"></a>         <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>br_body</span><span class='hs-layout'>)</span>
<a name="line-332"></a>
<a name="line-333"></a>
<a name="line-334"></a>  <span class='hs-comment'>-- The whole of the rest of the file is the else-branch (ie stage2 only)</span>
<a name="line-335"></a>
<a name="line-336"></a><span class='hs-comment'>{-
<a name="line-337"></a>Note [How top-level splices are handled]
<a name="line-338"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-339"></a>Top-level splices (those not inside a [| .. |] quotation bracket) are handled
<a name="line-340"></a>very straightforwardly:
<a name="line-341"></a>
<a name="line-342"></a>  1. tcTopSpliceExpr: typecheck the body e of the splice $(e)
<a name="line-343"></a>
<a name="line-344"></a>  2. runMetaT: desugar, compile, run it, and convert result back to
<a name="line-345"></a>     GHC.Hs syntax RdrName (of the appropriate flavour, eg HsType RdrName,
<a name="line-346"></a>     HsExpr RdrName etc)
<a name="line-347"></a>
<a name="line-348"></a>  3. treat the result as if that's what you saw in the first place
<a name="line-349"></a>     e.g for HsType, rename and kind-check
<a name="line-350"></a>         for HsExpr, rename and type-check
<a name="line-351"></a>
<a name="line-352"></a>     (The last step is different for decls, because they can *only* be
<a name="line-353"></a>      top-level: we return the result of step 2.)
<a name="line-354"></a>
<a name="line-355"></a>Note [How brackets and nested splices are handled]
<a name="line-356"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-357"></a>Nested splices (those inside a [| .. |] quotation bracket),
<a name="line-358"></a>are treated quite differently.
<a name="line-359"></a>
<a name="line-360"></a>Remember, there are two forms of bracket
<a name="line-361"></a>         typed   [|| e ||]
<a name="line-362"></a>   and untyped   [|  e  |]
<a name="line-363"></a>
<a name="line-364"></a>The life cycle of a typed bracket:
<a name="line-365"></a>   * Starts as HsBracket
<a name="line-366"></a>
<a name="line-367"></a>   * When renaming:
<a name="line-368"></a>        * Set the ThStage to (Brack s RnPendingTyped)
<a name="line-369"></a>        * Rename the body
<a name="line-370"></a>        * Result is still a HsBracket
<a name="line-371"></a>
<a name="line-372"></a>   * When typechecking:
<a name="line-373"></a>        * Set the ThStage to (Brack s (TcPending ps_var lie_var))
<a name="line-374"></a>        * Typecheck the body, and throw away the elaborated result
<a name="line-375"></a>        * Nested splices (which must be typed) are typechecked, and
<a name="line-376"></a>          the results accumulated in ps_var; their constraints
<a name="line-377"></a>          accumulate in lie_var
<a name="line-378"></a>        * Result is a HsTcBracketOut rn_brack pending_splices
<a name="line-379"></a>          where rn_brack is the incoming renamed bracket
<a name="line-380"></a>
<a name="line-381"></a>The life cycle of a un-typed bracket:
<a name="line-382"></a>   * Starts as HsBracket
<a name="line-383"></a>
<a name="line-384"></a>   * When renaming:
<a name="line-385"></a>        * Set the ThStage to (Brack s (RnPendingUntyped ps_var))
<a name="line-386"></a>        * Rename the body
<a name="line-387"></a>        * Nested splices (which must be untyped) are renamed, and the
<a name="line-388"></a>          results accumulated in ps_var
<a name="line-389"></a>        * Result is still (HsRnBracketOut rn_body pending_splices)
<a name="line-390"></a>
<a name="line-391"></a>   * When typechecking a HsRnBracketOut
<a name="line-392"></a>        * Typecheck the pending_splices individually
<a name="line-393"></a>        * Ignore the body of the bracket; just check that the context
<a name="line-394"></a>          expects a bracket of that type (e.g. a [p| pat |] bracket should
<a name="line-395"></a>          be in a context needing a (Q Pat)
<a name="line-396"></a>        * Result is a HsTcBracketOut rn_brack pending_splices
<a name="line-397"></a>          where rn_brack is the incoming renamed bracket
<a name="line-398"></a>
<a name="line-399"></a>
<a name="line-400"></a>In both cases, desugaring happens like this:
<a name="line-401"></a>  * HsTcBracketOut is desugared by GHC.HsToCore.Quote.dsBracket.  It
<a name="line-402"></a>
<a name="line-403"></a>      a) Extends the ds_meta environment with the PendingSplices
<a name="line-404"></a>         attached to the bracket
<a name="line-405"></a>
<a name="line-406"></a>      b) Converts the quoted (HsExpr Name) to a CoreExpr that, when
<a name="line-407"></a>         run, will produce a suitable TH expression/type/decl.  This
<a name="line-408"></a>         is why we leave the *renamed* expression attached to the bracket:
<a name="line-409"></a>         the quoted expression should not be decorated with all the goop
<a name="line-410"></a>         added by the type checker
<a name="line-411"></a>
<a name="line-412"></a>  * Each splice carries a unique Name, called a "splice point", thus
<a name="line-413"></a>    ${n}(e).  The name is initialised to an (Unqual "splice") when the
<a name="line-414"></a>    splice is created; the renamer gives it a unique.
<a name="line-415"></a>
<a name="line-416"></a>  * When GHC.HsToCore.Quote (used to desugar the body of the bracket) comes across
<a name="line-417"></a>    a splice, it looks up the splice's Name, n, in the ds_meta envt,
<a name="line-418"></a>    to find an (HsExpr Id) that should be substituted for the splice;
<a name="line-419"></a>    it just desugars it to get a CoreExpr (GHC.HsToCore.Quote.repSplice).
<a name="line-420"></a>
<a name="line-421"></a>Example:
<a name="line-422"></a>    Source:       f = [| Just $(g 3) |]
<a name="line-423"></a>      The [| |] part is a HsBracket
<a name="line-424"></a>
<a name="line-425"></a>    Typechecked:  f = [| Just ${s7}(g 3) |]{s7 = g Int 3}
<a name="line-426"></a>      The [| |] part is a HsBracketOut, containing *renamed*
<a name="line-427"></a>        (not typechecked) expression
<a name="line-428"></a>      The "s7" is the "splice point"; the (g Int 3) part
<a name="line-429"></a>        is a typechecked expression
<a name="line-430"></a>
<a name="line-431"></a>    Desugared:    f = do { s7 &lt;- g Int 3
<a name="line-432"></a>                         ; return (ConE "Data.Maybe.Just" s7) }
<a name="line-433"></a>
<a name="line-434"></a>
<a name="line-435"></a>Note [Template Haskell state diagram]
<a name="line-436"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-437"></a>Here are the ThStages, s, their corresponding level numbers
<a name="line-438"></a>(the result of (thLevel s)), and their state transitions.
<a name="line-439"></a>The top level of the program is stage Comp:
<a name="line-440"></a>
<a name="line-441"></a>     Start here
<a name="line-442"></a>         |
<a name="line-443"></a>         V
<a name="line-444"></a>      -----------     $      ------------   $
<a name="line-445"></a>      |  Comp   | ---------&gt; |  Splice  | -----|
<a name="line-446"></a>      |   1     |            |    0     | &lt;----|
<a name="line-447"></a>      -----------            ------------
<a name="line-448"></a>        ^     |                ^      |
<a name="line-449"></a>      $ |     | [||]         $ |      | [||]
<a name="line-450"></a>        |     v                |      v
<a name="line-451"></a>   --------------          ----------------
<a name="line-452"></a>   | Brack Comp |          | Brack Splice |
<a name="line-453"></a>   |     2      |          |      1       |
<a name="line-454"></a>   --------------          ----------------
<a name="line-455"></a>
<a name="line-456"></a>* Normal top-level declarations start in state Comp
<a name="line-457"></a>       (which has level 1).
<a name="line-458"></a>  Annotations start in state Splice, since they are
<a name="line-459"></a>       treated very like a splice (only without a '$')
<a name="line-460"></a>
<a name="line-461"></a>* Code compiled in state Splice (and only such code)
<a name="line-462"></a>  will be *run at compile time*, with the result replacing
<a name="line-463"></a>  the splice
<a name="line-464"></a>
<a name="line-465"></a>* The original paper used level -1 instead of 0, etc.
<a name="line-466"></a>
<a name="line-467"></a>* The original paper did not allow a splice within a
<a name="line-468"></a>  splice, but there is no reason not to. This is the
<a name="line-469"></a>  $ transition in the top right.
<a name="line-470"></a>
<a name="line-471"></a>Note [Template Haskell levels]
<a name="line-472"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-473"></a>* Imported things are impLevel (= 0)
<a name="line-474"></a>
<a name="line-475"></a>* However things at level 0 are not *necessarily* imported.
<a name="line-476"></a>      eg  $( \b -&gt; ... )   here b is bound at level 0
<a name="line-477"></a>
<a name="line-478"></a>* In GHCi, variables bound by a previous command are treated
<a name="line-479"></a>  as impLevel, because we have bytecode for them.
<a name="line-480"></a>
<a name="line-481"></a>* Variables are bound at the "current level"
<a name="line-482"></a>
<a name="line-483"></a>* The current level starts off at outerLevel (= 1)
<a name="line-484"></a>
<a name="line-485"></a>* The level is decremented by splicing $(..)
<a name="line-486"></a>               incremented by brackets [| |]
<a name="line-487"></a>               incremented by name-quoting 'f
<a name="line-488"></a>
<a name="line-489"></a>* When a variable is used, checkWellStaged compares
<a name="line-490"></a>        bind:  binding level, and
<a name="line-491"></a>        use:   current level at usage site
<a name="line-492"></a>
<a name="line-493"></a>  Generally
<a name="line-494"></a>        bind &gt; use      Always error (bound later than used)
<a name="line-495"></a>                        [| \x -&gt; $(f x) |]
<a name="line-496"></a>
<a name="line-497"></a>        bind = use      Always OK (bound same stage as used)
<a name="line-498"></a>                        [| \x -&gt; $(f [| x |]) |]
<a name="line-499"></a>
<a name="line-500"></a>        bind &lt; use      Inside brackets, it depends
<a name="line-501"></a>                        Inside splice, OK
<a name="line-502"></a>                        Inside neither, OK
<a name="line-503"></a>
<a name="line-504"></a>  For (bind &lt; use) inside brackets, there are three cases:
<a name="line-505"></a>    - Imported things   OK      f = [| map |]
<a name="line-506"></a>    - Top-level things  OK      g = [| f |]
<a name="line-507"></a>    - Non-top-level     Only if there is a liftable instance
<a name="line-508"></a>                                h = \(x:Int) -&gt; [| x |]
<a name="line-509"></a>
<a name="line-510"></a>  To track top-level-ness we use the ThBindEnv in TcLclEnv
<a name="line-511"></a>
<a name="line-512"></a>  For example:
<a name="line-513"></a>           f = ...
<a name="line-514"></a>           g1 = $(map ...)         is OK
<a name="line-515"></a>           g2 = $(f ...)           is not OK; because we haven't compiled f yet
<a name="line-516"></a>
<a name="line-517"></a>Note [Typechecking Overloaded Quotes]
<a name="line-518"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-519"></a>
<a name="line-520"></a>The main function for typechecking untyped quotations is `tcUntypedBracket`.
<a name="line-521"></a>
<a name="line-522"></a>Consider an expression quote, `[| e |]`, its type is `forall m . Quote m =&gt; m Exp`.
<a name="line-523"></a>When we typecheck it we therefore create a template of a metavariable `m` applied to `Exp` and
<a name="line-524"></a>emit a constraint `Quote m`. All this is done in the `brackTy` function.
<a name="line-525"></a>`brackTy` also selects the correct contents type for the quotation (Exp, Type, Decs etc).
<a name="line-526"></a>
<a name="line-527"></a>The meta variable and the constraint evidence variable are
<a name="line-528"></a>returned together in a `QuoteWrapper` and then passed along to two further places
<a name="line-529"></a>during compilation:
<a name="line-530"></a>
<a name="line-531"></a>1. Typechecking nested splices (immediately in tcPendingSplice)
<a name="line-532"></a>2. Desugaring quotations (see GHC.HsToCore.Quote)
<a name="line-533"></a>
<a name="line-534"></a>`tcPendingSplice` takes the `m` type variable as an argument and checks
<a name="line-535"></a>each nested splice against this variable `m`. During this
<a name="line-536"></a>process the variable `m` can either be fixed to a specific value or further constrained by the
<a name="line-537"></a>nested splices.
<a name="line-538"></a>
<a name="line-539"></a>Once we have checked all the nested splices, the quote type is checked against
<a name="line-540"></a>the expected return type.
<a name="line-541"></a>
<a name="line-542"></a>The process is very simple and like typechecking a list where the quotation is
<a name="line-543"></a>like the container and the splices are the elements of the list which must have
<a name="line-544"></a>a specific type.
<a name="line-545"></a>
<a name="line-546"></a>After the typechecking process is completed, the evidence variable for `Quote m`
<a name="line-547"></a>and the type `m` is stored in a `QuoteWrapper` which is passed through the pipeline
<a name="line-548"></a>and used when desugaring quotations.
<a name="line-549"></a>
<a name="line-550"></a>Typechecking typed quotations is a similar idea but the `QuoteWrapper` is stored
<a name="line-551"></a>in the `PendingStuff` as the nested splices are gathered up in a different way
<a name="line-552"></a>to untyped splices. Untyped splices are found in the renamer but typed splices are
<a name="line-553"></a>not typechecked and extracted until during typechecking.
<a name="line-554"></a>
<a name="line-555"></a>-}</span>
<a name="line-556"></a>
<a name="line-557"></a><a name="getThSpliceOrigin"></a><span class='hs-comment'>-- | We only want to produce warnings for TH-splices if the user requests so.</span>
<a name="line-558"></a><span class='hs-comment'>-- See Note [Warnings for TH splices].</span>
<a name="line-559"></a><span class='hs-definition'>getThSpliceOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Origin</span>
<a name="line-560"></a><span class='hs-definition'>getThSpliceOrigin</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-561"></a>  <span class='hs-varid'>warn</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>goptM</span> <span class='hs-conid'>Opt_EnableThSpliceWarnings</span>
<a name="line-562"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>warn</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-conid'>FromSource</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Generated</span>
<a name="line-563"></a>
<a name="line-564"></a><span class='hs-comment'>{- Note [Warnings for TH splices]
<a name="line-565"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-566"></a>We only produce warnings for TH splices when the user requests so
<a name="line-567"></a>(-fenable-th-splice-warnings). There are multiple reasons:
<a name="line-568"></a>
<a name="line-569"></a>  * It's not clear that the user that compiles a splice is the author of the code
<a name="line-570"></a>    that produces the warning. Think of the situation where they just splice in
<a name="line-571"></a>    code from a third-party library that produces incomplete pattern matches.
<a name="line-572"></a>    In this scenario, the user isn't even able to fix that warning.
<a name="line-573"></a>  * Gathering information for producing the warnings (pattern-match check
<a name="line-574"></a>    warnings in particular) is costly. There's no point in doing so if the user
<a name="line-575"></a>    is not interested in those warnings.
<a name="line-576"></a>
<a name="line-577"></a>That's why we store Origin flags in the Haskell AST. The functions from ThToHs
<a name="line-578"></a>take such a flag and depending on whether TH splice warnings were enabled or
<a name="line-579"></a>not, we pass FromSource (if the user requests warnings) or Generated
<a name="line-580"></a>(otherwise). This is implemented in getThSpliceOrigin.
<a name="line-581"></a>
<a name="line-582"></a>For correct pattern-match warnings it's crucial that we annotate the Origin
<a name="line-583"></a>consistently (#17270). In the future we could offer the Origin as part of the
<a name="line-584"></a>TH AST. That would enable us to give quotes from the current module get
<a name="line-585"></a>FromSource origin, and/or third library authors to tag certain parts of
<a name="line-586"></a>generated code as FromSource to enable warnings.
<a name="line-587"></a>That effort is tracked in #14838.
<a name="line-588"></a>-}</span>
<a name="line-589"></a>
<a name="line-590"></a><span class='hs-comment'>{-
<a name="line-591"></a>************************************************************************
<a name="line-592"></a>*                                                                      *
<a name="line-593"></a>\subsection{Splicing an expression}
<a name="line-594"></a>*                                                                      *
<a name="line-595"></a>************************************************************************
<a name="line-596"></a>-}</span>
<a name="line-597"></a>
<a name="line-598"></a><span class='hs-definition'>tcSpliceExpr</span> <span class='hs-varid'>splice</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTypedSplice</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-599"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>spliceCtxtDoc</span> <span class='hs-varid'>splice</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-600"></a>    <span class='hs-varid'>setSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLocA</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>    <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-601"></a>    <span class='hs-layout'>{</span> <span class='hs-varid'>stage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getStage</span>
<a name="line-602"></a>    <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stage</span> <span class='hs-keyword'>of</span>
<a name="line-603"></a>          <span class='hs-conid'>Splice</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcTopSplice</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-604"></a>          <span class='hs-conid'>Brack</span> <span class='hs-varid'>pop_stage</span> <span class='hs-varid'>pend</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcNestedSplice</span> <span class='hs-varid'>pop_stage</span> <span class='hs-varid'>pend</span> <span class='hs-varid'>name</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-605"></a>          <span class='hs-conid'>RunSplice</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>-&gt;</span>
<a name="line-606"></a>            <span class='hs-comment'>-- See Note [RunSplice ThLevel] in "GHC.Tc.Types".</span>
<a name="line-607"></a>            <span class='hs-varid'>pprPanic</span> <span class='hs-layout'>(</span><span class='hs-str'>"tcSpliceExpr: attempted to typecheck a splice when "</span> <span class='hs-varop'>++</span>
<a name="line-608"></a>                      <span class='hs-str'>"running another splice"</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>splice</span><span class='hs-layout'>)</span>
<a name="line-609"></a>          <span class='hs-conid'>Comp</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcTopSplice</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-610"></a>    <span class='hs-layout'>}</span>
<a name="line-611"></a><span class='hs-definition'>tcSpliceExpr</span> <span class='hs-varid'>splice</span> <span class='hs-keyword'>_</span>
<a name="line-612"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcSpliceExpr"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>splice</span><span class='hs-layout'>)</span>
<a name="line-613"></a>
<a name="line-614"></a><span class='hs-comment'>{- Note [Collecting modFinalizers in typed splices]
<a name="line-615"></a>   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-616"></a>
<a name="line-617"></a>'qAddModFinalizer' of the @Quasi TcM@ instance adds finalizers in the local
<a name="line-618"></a>environment (see Note [Delaying modFinalizers in untyped splices] in
<a name="line-619"></a>GHC.Rename.Splice). Thus after executing the splice, we move the finalizers to the
<a name="line-620"></a>finalizer list in the global environment and set them to use the current local
<a name="line-621"></a>environment (with 'addModFinalizersWithLclEnv').
<a name="line-622"></a>
<a name="line-623"></a>-}</span>
<a name="line-624"></a>
<a name="line-625"></a><a name="tcNestedSplice"></a><span class='hs-definition'>tcNestedSplice</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThStage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PendingStuff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-626"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcTc</span><span class='hs-layout'>)</span>
<a name="line-627"></a>    <span class='hs-comment'>-- See Note [How brackets and nested splices are handled]</span>
<a name="line-628"></a>    <span class='hs-comment'>-- A splice inside brackets</span>
<a name="line-629"></a><span class='hs-definition'>tcNestedSplice</span> <span class='hs-varid'>pop_stage</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPending</span> <span class='hs-varid'>ps_var</span> <span class='hs-varid'>lie_var</span> <span class='hs-varid'>q</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>QuoteWrapper</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>m_var</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>splice_name</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-630"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>expTypeToType</span> <span class='hs-varid'>res_ty</span>
<a name="line-631"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getRuntimeRep</span> <span class='hs-varid'>res_ty</span>
<a name="line-632"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>meta_exp_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTExpTy</span> <span class='hs-varid'>m_var</span> <span class='hs-varid'>res_ty</span>
<a name="line-633"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setStage</span> <span class='hs-varid'>pop_stage</span> <span class='hs-varop'>$</span>
<a name="line-634"></a>                  <span class='hs-varid'>setConstraintVar</span> <span class='hs-varid'>lie_var</span> <span class='hs-varop'>$</span>
<a name="line-635"></a>                  <span class='hs-varid'>tcCheckMonoExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>meta_exp_ty</span>
<a name="line-636"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>untype_code</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>unTypeCodeName</span>
<a name="line-637"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>expr''</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHsApp</span>
<a name="line-638"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>mkLHsWrap</span> <span class='hs-layout'>(</span><span class='hs-varid'>applyQuoteWrapper</span> <span class='hs-varid'>q</span><span class='hs-layout'>)</span>
<a name="line-639"></a>                          <span class='hs-layout'>(</span><span class='hs-varid'>nlHsTyApp</span> <span class='hs-varid'>untype_code</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>rep</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr'</span>
<a name="line-640"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ps_var</span>
<a name="line-641"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>writeMutVar</span> <span class='hs-varid'>ps_var</span> <span class='hs-layout'>(</span><span class='hs-conid'>PendingTcSplice</span> <span class='hs-varid'>splice_name</span> <span class='hs-varid'>expr''</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-642"></a>
<a name="line-643"></a>       <span class='hs-comment'>-- The returned expression is ignored; it's in the pending splices</span>
<a name="line-644"></a>       <span class='hs-comment'>-- But we still return a plausible expression</span>
<a name="line-645"></a>       <span class='hs-comment'>--   (a) in case we print it in debug messages, and</span>
<a name="line-646"></a>       <span class='hs-comment'>--   (b) because we test whether it is tagToEnum in Tc.Gen.Expr.tcApp</span>
<a name="line-647"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceE</span> <span class='hs-varid'>noAnn</span> <span class='hs-varop'>$</span>
<a name="line-648"></a>                 <span class='hs-conid'>HsSpliced</span> <span class='hs-varid'>noExtField</span> <span class='hs-layout'>(</span><span class='hs-conid'>ThModFinalizers</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-649"></a>                 <span class='hs-conid'>HsSplicedExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>expr''</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-650"></a>
<a name="line-651"></a>
<a name="line-652"></a><span class='hs-definition'>tcNestedSplice</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>splice_name</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-653"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcNestedSplice: rename stage found"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>splice_name</span><span class='hs-layout'>)</span>
<a name="line-654"></a>
<a name="line-655"></a><a name="tcTopSplice"></a><span class='hs-definition'>tcTopSplice</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcTc</span><span class='hs-layout'>)</span>
<a name="line-656"></a><span class='hs-definition'>tcTopSplice</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-657"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Typecheck the expression,</span>
<a name="line-658"></a>         <span class='hs-comment'>-- making sure it has type Q (T res_ty)</span>
<a name="line-659"></a>         <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>expTypeToType</span> <span class='hs-varid'>res_ty</span>
<a name="line-660"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>q_type</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>qTyConName</span>
<a name="line-661"></a>       <span class='hs-comment'>-- Top level splices must still be of type Q (TExp a)</span>
<a name="line-662"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>meta_exp_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTExpTy</span> <span class='hs-varid'>q_type</span> <span class='hs-varid'>res_ty</span>
<a name="line-663"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>q_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTopSpliceExpr</span> <span class='hs-conid'>Typed</span> <span class='hs-varop'>$</span>
<a name="line-664"></a>                   <span class='hs-varid'>tcCheckMonoExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>meta_exp_ty</span>
<a name="line-665"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lcl_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLclEnv</span>
<a name="line-666"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>delayed_splice</span>
<a name="line-667"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DelayedSplice</span> <span class='hs-varid'>lcl_env</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>q_expr</span>
<a name="line-668"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceE</span> <span class='hs-varid'>noAnn</span> <span class='hs-layout'>(</span><span class='hs-conid'>XSplice</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSplicedT</span> <span class='hs-varid'>delayed_splice</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-669"></a>
<a name="line-670"></a>       <span class='hs-layout'>}</span>
<a name="line-671"></a>
<a name="line-672"></a>
<a name="line-673"></a><a name="runTopSplice"></a><span class='hs-comment'>-- This is called in the zonker</span>
<a name="line-674"></a><span class='hs-comment'>-- See Note [Running typed splices in the zonker]</span>
<a name="line-675"></a><span class='hs-definition'>runTopSplice</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DelayedSplice</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>GhcTc</span><span class='hs-layout'>)</span>
<a name="line-676"></a><span class='hs-definition'>runTopSplice</span> <span class='hs-layout'>(</span><span class='hs-conid'>DelayedSplice</span> <span class='hs-varid'>lcl_env</span> <span class='hs-varid'>orig_expr</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>q_expr</span><span class='hs-layout'>)</span>
<a name="line-677"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-678"></a>      <span class='hs-varid'>errs_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getErrsVar</span>
<a name="line-679"></a>      <span class='hs-varid'>setLclEnv</span> <span class='hs-varid'>lcl_env</span> <span class='hs-varop'>$</span> <span class='hs-varid'>setErrsVar</span> <span class='hs-varid'>errs_var</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-680"></a>         <span class='hs-comment'>-- Set the errs_var to the errs_var from the current context,</span>
<a name="line-681"></a>         <span class='hs-comment'>-- otherwise error messages can go missing in GHCi (#19470)</span>
<a name="line-682"></a>         <span class='hs-varid'>zonked_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>res_ty</span>
<a name="line-683"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>zonked_q_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTopLExpr</span> <span class='hs-varid'>q_expr</span>
<a name="line-684"></a>        <span class='hs-comment'>-- See Note [Collecting modFinalizers in typed splices].</span>
<a name="line-685"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>modfinalizers_ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTcRef</span> <span class='hs-conid'>[]</span>
<a name="line-686"></a>         <span class='hs-comment'>-- Run the expression</span>
<a name="line-687"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>expr2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setStage</span> <span class='hs-layout'>(</span><span class='hs-conid'>RunSplice</span> <span class='hs-varid'>modfinalizers_ref</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-688"></a>                    <span class='hs-varid'>runMetaE</span> <span class='hs-varid'>zonked_q_expr</span>
<a name="line-689"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mod_finalizers</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTcRef</span> <span class='hs-varid'>modfinalizers_ref</span>
<a name="line-690"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>addModFinalizersWithLclEnv</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ThModFinalizers</span> <span class='hs-varid'>mod_finalizers</span>
<a name="line-691"></a>       <span class='hs-comment'>-- We use orig_expr here and not q_expr when tracing as a call to</span>
<a name="line-692"></a>       <span class='hs-comment'>-- unsafeTExpCoerce is added to the original expression by the</span>
<a name="line-693"></a>       <span class='hs-comment'>-- typechecker when typed quotes are type checked.</span>
<a name="line-694"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceSplice</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpliceInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>spliceDescription</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"expression"</span>
<a name="line-695"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>spliceIsDecl</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-696"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>spliceSource</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>orig_expr</span>
<a name="line-697"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>spliceGenerated</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>expr2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-698"></a>        <span class='hs-comment'>-- Rename and typecheck the spliced-in expression,</span>
<a name="line-699"></a>        <span class='hs-comment'>-- making sure it has type res_ty</span>
<a name="line-700"></a>        <span class='hs-comment'>-- These steps should never fail; this is a *typed* splice</span>
<a name="line-701"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>wcs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-702"></a>            <span class='hs-varid'>captureConstraints</span> <span class='hs-varop'>$</span>
<a name="line-703"></a>              <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>spliceResultDoc</span> <span class='hs-varid'>zonked_q_expr</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-704"></a>                <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>exp3</span><span class='hs-layout'>,</span> <span class='hs-sel'>_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr2</span>
<a name="line-705"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>tcCheckMonoExpr</span> <span class='hs-varid'>exp3</span> <span class='hs-varid'>zonked_ty</span> <span class='hs-layout'>}</span>
<a name="line-706"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyTop</span> <span class='hs-varid'>wcs</span>
<a name="line-707"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsDictLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBinds</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-708"></a>       <span class='hs-layout'>}</span>
<a name="line-709"></a>
<a name="line-710"></a>
<a name="line-711"></a><span class='hs-comment'>{-
<a name="line-712"></a>************************************************************************
<a name="line-713"></a>*                                                                      *
<a name="line-714"></a>\subsection{Error messages}
<a name="line-715"></a>*                                                                      *
<a name="line-716"></a>************************************************************************
<a name="line-717"></a>-}</span>
<a name="line-718"></a>
<a name="line-719"></a><a name="spliceCtxtDoc"></a><span class='hs-definition'>spliceCtxtDoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSplice</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-720"></a><span class='hs-definition'>spliceCtxtDoc</span> <span class='hs-varid'>splice</span>
<a name="line-721"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"In the Template Haskell splice"</span><span class='hs-layout'>)</span>
<a name="line-722"></a>         <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprSplice</span> <span class='hs-varid'>splice</span><span class='hs-layout'>)</span>
<a name="line-723"></a>
<a name="line-724"></a><a name="spliceResultDoc"></a><span class='hs-definition'>spliceResultDoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>GhcTc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-725"></a><span class='hs-definition'>spliceResultDoc</span> <span class='hs-varid'>expr</span>
<a name="line-726"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"In the result of the splice:"</span>
<a name="line-727"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>char</span> <span class='hs-chr'>'$'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-728"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"To see what the splice expanded to, use -ddump-splices"</span><span class='hs-keyglyph'>]</span>
<a name="line-729"></a>
<a name="line-730"></a><a name="tcTopSpliceExpr"></a><span class='hs-comment'>-------------------</span>
<a name="line-731"></a><span class='hs-definition'>tcTopSpliceExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SpliceType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>GhcTc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>GhcTc</span><span class='hs-layout'>)</span>
<a name="line-732"></a><span class='hs-comment'>-- Note [How top-level splices are handled]</span>
<a name="line-733"></a><span class='hs-comment'>-- Type check an expression that is the body of a top-level splice</span>
<a name="line-734"></a><span class='hs-comment'>--   (the caller will compile and run it)</span>
<a name="line-735"></a><span class='hs-comment'>-- Note that set the level to Splice, regardless of the original level,</span>
<a name="line-736"></a><span class='hs-comment'>-- before typechecking the expression.  For example:</span>
<a name="line-737"></a><span class='hs-comment'>--      f x = $( ...$(g 3) ... )</span>
<a name="line-738"></a><span class='hs-comment'>-- The recursive call to tcCheckPolyExpr will simply expand the</span>
<a name="line-739"></a><span class='hs-comment'>-- inner escape before dealing with the outer one</span>
<a name="line-740"></a>
<a name="line-741"></a><span class='hs-definition'>tcTopSpliceExpr</span> <span class='hs-varid'>isTypedSplice</span> <span class='hs-varid'>tc_action</span>
<a name="line-742"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span>  <span class='hs-comment'>-- checkNoErrs: must not try to run the thing</span>
<a name="line-743"></a>                   <span class='hs-comment'>-- if the type checker fails!</span>
<a name="line-744"></a>    <span class='hs-varid'>unsetGOptM</span> <span class='hs-conid'>Opt_DeferTypeErrors</span> <span class='hs-varop'>$</span>
<a name="line-745"></a>                   <span class='hs-comment'>-- Don't defer type errors.  Not only are we</span>
<a name="line-746"></a>                   <span class='hs-comment'>-- going to run this code, but we do an unsafe</span>
<a name="line-747"></a>                   <span class='hs-comment'>-- coerce, so we get a seg-fault if, say we</span>
<a name="line-748"></a>                   <span class='hs-comment'>-- splice a type into a place where an expression</span>
<a name="line-749"></a>                   <span class='hs-comment'>-- is expected (#7276)</span>
<a name="line-750"></a>    <span class='hs-varid'>setStage</span> <span class='hs-layout'>(</span><span class='hs-conid'>Splice</span> <span class='hs-varid'>isTypedSplice</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-751"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>    <span class='hs-comment'>-- Typecheck the expression</span>
<a name="line-752"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>mb_expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tryCaptureConstraints</span> <span class='hs-varid'>tc_action</span>
<a name="line-753"></a>             <span class='hs-comment'>-- If tc_action fails (perhaps because of insoluble constraints)</span>
<a name="line-754"></a>             <span class='hs-comment'>-- we want to capture and report those constraints, else we may</span>
<a name="line-755"></a>             <span class='hs-comment'>-- just get a silent failure (#20179). Hence the 'try' part.</span>
<a name="line-756"></a>
<a name="line-757"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>const_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyTop</span> <span class='hs-varid'>wanted</span>
<a name="line-758"></a>
<a name="line-759"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_expr'</span> <span class='hs-keyword'>of</span>
<a name="line-760"></a>            <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failM</span>   <span class='hs-comment'>-- In this case simplifyTop should have</span>
<a name="line-761"></a>                                  <span class='hs-comment'>-- reported some errors</span>
<a name="line-762"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsDictLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBinds</span> <span class='hs-varid'>const_binds</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr'</span> <span class='hs-layout'>}</span>
<a name="line-763"></a>
<a name="line-764"></a><span class='hs-comment'>{-
<a name="line-765"></a>************************************************************************
<a name="line-766"></a>*                                                                      *
<a name="line-767"></a>        Annotations
<a name="line-768"></a>*                                                                      *
<a name="line-769"></a>************************************************************************
<a name="line-770"></a>-}</span>
<a name="line-771"></a>
<a name="line-772"></a><span class='hs-definition'>runAnnotation</span> <span class='hs-varid'>target</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-773"></a>    <span class='hs-comment'>-- Find the classes we want instances for in order to call toAnnotationWrapper</span>
<a name="line-774"></a>    <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-775"></a>    <span class='hs-varid'>data_class</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupClass</span> <span class='hs-varid'>dataClassName</span>
<a name="line-776"></a>    <span class='hs-varid'>to_annotation_wrapper_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>toAnnotationWrapperName</span>
<a name="line-777"></a>
<a name="line-778"></a>    <span class='hs-comment'>-- Check the instances we require live in another module (we want to execute it..)</span>
<a name="line-779"></a>    <span class='hs-comment'>-- and check identifiers live in other modules using TH stage checks. tcSimplifyStagedExpr</span>
<a name="line-780"></a>    <span class='hs-comment'>-- also resolves the LIE constraints to detect e.g. instance ambiguity</span>
<a name="line-781"></a>    <span class='hs-varid'>zonked_wrapped_expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTopLExpr</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>tcTopSpliceExpr</span> <span class='hs-conid'>Untyped</span> <span class='hs-layout'>(</span>
<a name="line-782"></a>           <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferRhoNC</span> <span class='hs-varid'>expr</span>
<a name="line-783"></a>                <span class='hs-comment'>-- We manually wrap the typechecked expression in a call to toAnnotationWrapper</span>
<a name="line-784"></a>                <span class='hs-comment'>-- By instantiating the call &gt;here&lt; it gets registered in the</span>
<a name="line-785"></a>                <span class='hs-comment'>-- LIE consulted by tcTopSpliceExpr</span>
<a name="line-786"></a>                <span class='hs-comment'>-- and hence ensures the appropriate dictionary is bound by const_binds</span>
<a name="line-787"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>wrapper</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instCall</span> <span class='hs-conid'>AnnOrigin</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>expr_ty</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>data_class</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>expr_ty</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-788"></a>              <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>loc'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noAnnSrcSpan</span> <span class='hs-varid'>loc</span>
<a name="line-789"></a>              <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>specialised_to_annotation_wrapper_expr</span>
<a name="line-790"></a>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc'</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrap</span> <span class='hs-varid'>wrapper</span>
<a name="line-791"></a>                                 <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>noExtField</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-layout'>(</span><span class='hs-varid'>noAnnSrcSpan</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>to_annotation_wrapper_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-792"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc'</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-varid'>noComments</span>
<a name="line-793"></a>                                <span class='hs-varid'>specialised_to_annotation_wrapper_expr</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-794"></a>                                <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-795"></a>
<a name="line-796"></a>    <span class='hs-comment'>-- Run the appropriately wrapped expression to get the value of</span>
<a name="line-797"></a>    <span class='hs-comment'>-- the annotation and its dictionaries. The return value is of</span>
<a name="line-798"></a>    <span class='hs-comment'>-- type AnnotationWrapper by construction, so this conversion is</span>
<a name="line-799"></a>    <span class='hs-comment'>-- safe</span>
<a name="line-800"></a>    <span class='hs-varid'>serialized</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runMetaAW</span> <span class='hs-varid'>zonked_wrapped_expr'</span>
<a name="line-801"></a>    <span class='hs-varid'>return</span> <span class='hs-conid'>Annotation</span> <span class='hs-layout'>{</span>
<a name="line-802"></a>               <span class='hs-varid'>ann_target</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>target</span><span class='hs-layout'>,</span>
<a name="line-803"></a>               <span class='hs-varid'>ann_value</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>serialized</span>
<a name="line-804"></a>           <span class='hs-layout'>}</span>
<a name="line-805"></a>
<a name="line-806"></a><a name="convertAnnotationWrapper"></a><span class='hs-definition'>convertAnnotationWrapper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignHValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-conid'>SDoc</span> <span class='hs-conid'>Serialized</span><span class='hs-layout'>)</span>
<a name="line-807"></a><span class='hs-definition'>convertAnnotationWrapper</span> <span class='hs-varid'>fhv</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-808"></a>  <span class='hs-varid'>interp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetInterp</span>
<a name="line-809"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>interpInstance</span> <span class='hs-varid'>interp</span> <span class='hs-keyword'>of</span>
<a name="line-810"></a>    <span class='hs-conid'>ExternalInterp</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>runTH</span> <span class='hs-conid'>THAnnWrapper</span> <span class='hs-varid'>fhv</span>
<a name="line-811"></a><span class='hs-cpp'>#if defined(HAVE_INTERNAL_INTERPRETER)</span>
<a name="line-812"></a>    <span class='hs-conid'>InternalInterp</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-813"></a>      <span class='hs-varid'>annotation_wrapper</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>wormhole</span> <span class='hs-varid'>interp</span> <span class='hs-varid'>fhv</span>
<a name="line-814"></a>      <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Right</span> <span class='hs-varop'>$</span>
<a name="line-815"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>unsafeCoerce</span> <span class='hs-varid'>annotation_wrapper</span> <span class='hs-keyword'>of</span>
<a name="line-816"></a>           <span class='hs-conid'>AnnotationWrapper</span> <span class='hs-varid'>value</span> <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>serialized</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toSerialized</span> <span class='hs-varid'>serializeWithData</span> <span class='hs-varid'>value</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-817"></a>               <span class='hs-comment'>-- Got the value and dictionaries: build the serialized value and</span>
<a name="line-818"></a>               <span class='hs-comment'>-- call it a day. We ensure that we seq the entire serialized value</span>
<a name="line-819"></a>               <span class='hs-comment'>-- in order that any errors in the user-written code for the</span>
<a name="line-820"></a>               <span class='hs-comment'>-- annotation are exposed at this point.  This is also why we are</span>
<a name="line-821"></a>               <span class='hs-comment'>-- doing all this stuff inside the context of runMeta: it has the</span>
<a name="line-822"></a>               <span class='hs-comment'>-- facilities to deal with user error in a meta-level expression</span>
<a name="line-823"></a>               <span class='hs-varid'>seqSerialized</span> <span class='hs-varid'>serialized</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>serialized</span>
<a name="line-824"></a>
<a name="line-825"></a><a name="seqSerialized"></a><span class='hs-comment'>-- | Force the contents of the Serialized value so weknow it doesn't contain any bottoms</span>
<a name="line-826"></a><span class='hs-definition'>seqSerialized</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Serialized</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-827"></a><span class='hs-definition'>seqSerialized</span> <span class='hs-layout'>(</span><span class='hs-conid'>Serialized</span> <span class='hs-varid'>the_type</span> <span class='hs-varid'>bytes</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>the_type</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>bytes</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>()</span>
<a name="line-828"></a>
<a name="line-829"></a><span class='hs-cpp'>#endif</span>
<a name="line-830"></a>
<a name="line-831"></a><span class='hs-comment'>{-
<a name="line-832"></a>************************************************************************
<a name="line-833"></a>*                                                                      *
<a name="line-834"></a>\subsection{Running an expression}
<a name="line-835"></a>*                                                                      *
<a name="line-836"></a>************************************************************************
<a name="line-837"></a>-}</span>
<a name="line-838"></a>
<a name="line-839"></a><a name="runQuasi"></a><span class='hs-definition'>runQuasi</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH.Q</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-840"></a><span class='hs-definition'>runQuasi</span> <span class='hs-varid'>act</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.runQ</span> <span class='hs-varid'>act</span>
<a name="line-841"></a>
<a name="line-842"></a><a name="runRemoteModFinalizers"></a><span class='hs-definition'>runRemoteModFinalizers</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThModFinalizers</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-843"></a><span class='hs-definition'>runRemoteModFinalizers</span> <span class='hs-layout'>(</span><span class='hs-conid'>ThModFinalizers</span> <span class='hs-varid'>finRefs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-844"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>withForeignRefs</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-conid'>[]</span>
<a name="line-845"></a>      <span class='hs-varid'>withForeignRefs</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span> <span class='hs-conop'>:</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withForeignRef</span> <span class='hs-varid'>x</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>r</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-846"></a>        <span class='hs-varid'>withForeignRefs</span> <span class='hs-varid'>xs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>rs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rs</span><span class='hs-layout'>)</span>
<a name="line-847"></a>  <span class='hs-varid'>interp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetInterp</span>
<a name="line-848"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>interpInstance</span> <span class='hs-varid'>interp</span> <span class='hs-keyword'>of</span>
<a name="line-849"></a><span class='hs-cpp'>#if defined(HAVE_INTERNAL_INTERPRETER)</span>
<a name="line-850"></a>    <span class='hs-conid'>InternalInterp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-851"></a>      <span class='hs-varid'>qs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>withForeignRefs</span> <span class='hs-varid'>finRefs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>localRef</span><span class='hs-layout'>)</span>
<a name="line-852"></a>      <span class='hs-varid'>runQuasi</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sequence_</span> <span class='hs-varid'>qs</span>
<a name="line-853"></a><span class='hs-cpp'>#endif</span>
<a name="line-854"></a>
<a name="line-855"></a>    <span class='hs-conid'>ExternalInterp</span> <span class='hs-varid'>conf</span> <span class='hs-varid'>iserv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>withIServ_</span> <span class='hs-varid'>conf</span> <span class='hs-varid'>iserv</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-856"></a>      <span class='hs-varid'>tcg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-857"></a>      <span class='hs-varid'>th_state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_th_remote_state</span> <span class='hs-varid'>tcg</span><span class='hs-layout'>)</span>
<a name="line-858"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>th_state</span> <span class='hs-keyword'>of</span>
<a name="line-859"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-comment'>-- TH was not started, nothing to do</span>
<a name="line-860"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>fhv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-861"></a>          <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>withForeignRef</span> <span class='hs-varid'>fhv</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>st</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-862"></a>            <span class='hs-varid'>withForeignRefs</span> <span class='hs-varid'>finRefs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>qrefs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-863"></a>              <span class='hs-varid'>writeIServ</span> <span class='hs-varid'>i</span> <span class='hs-layout'>(</span><span class='hs-varid'>putMessage</span> <span class='hs-layout'>(</span><span class='hs-conid'>RunModFinalizers</span> <span class='hs-varid'>st</span> <span class='hs-varid'>qrefs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-864"></a>          <span class='hs-conid'>()</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runRemoteTH</span> <span class='hs-varid'>i</span> <span class='hs-conid'>[]</span>
<a name="line-865"></a>          <span class='hs-varid'>readQResult</span> <span class='hs-varid'>i</span>
<a name="line-866"></a>
<a name="line-867"></a><a name="runQResult"></a><span class='hs-definition'>runQResult</span>
<a name="line-868"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-869"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Origin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-870"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignHValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-871"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-872"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ForeignHValue</span> <span class='hs-comment'>{- TH.Q a -}</span>
<a name="line-873"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>b</span>
<a name="line-874"></a><span class='hs-definition'>runQResult</span> <span class='hs-varid'>show_th</span> <span class='hs-varid'>f</span> <span class='hs-varid'>runQ</span> <span class='hs-varid'>expr_span</span> <span class='hs-varid'>hval</span>
<a name="line-875"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>th_result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runQ</span> <span class='hs-varid'>hval</span>
<a name="line-876"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>th_origin</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getThSpliceOrigin</span>
<a name="line-877"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Got TH result:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show_th</span> <span class='hs-varid'>th_result</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-878"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>th_origin</span> <span class='hs-varid'>expr_span</span> <span class='hs-varid'>th_result</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-879"></a>
<a name="line-880"></a>
<a name="line-881"></a><a name="runMeta"></a><span class='hs-comment'>-----------------</span>
<a name="line-882"></a><span class='hs-definition'>runMeta</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MetaHook</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>GhcTc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>hs_syn</span><span class='hs-layout'>)</span>
<a name="line-883"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>GhcTc</span>
<a name="line-884"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>hs_syn</span>
<a name="line-885"></a><span class='hs-definition'>runMeta</span> <span class='hs-varid'>unwrap</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-886"></a>    <span class='hs-varid'>hooks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHooks</span>
<a name="line-887"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>runMetaHook</span> <span class='hs-varid'>hooks</span> <span class='hs-keyword'>of</span>
<a name="line-888"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unwrap</span> <span class='hs-varid'>defaultRunMeta</span> <span class='hs-varid'>e</span>
<a name="line-889"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>h</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unwrap</span> <span class='hs-varid'>h</span> <span class='hs-varid'>e</span>
<a name="line-890"></a>
<a name="line-891"></a><a name="defaultRunMeta"></a><span class='hs-definition'>defaultRunMeta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MetaHook</span> <span class='hs-conid'>TcM</span>
<a name="line-892"></a><span class='hs-definition'>defaultRunMeta</span> <span class='hs-layout'>(</span><span class='hs-conid'>MetaE</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-893"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>r</span> <span class='hs-varop'>.</span> <span class='hs-varid'>runMeta'</span> <span class='hs-conid'>True</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>runQResult</span> <span class='hs-conid'>TH.pprint</span> <span class='hs-varid'>convertToHsExpr</span> <span class='hs-varid'>runTHExp</span><span class='hs-layout'>)</span>
<a name="line-894"></a><span class='hs-definition'>defaultRunMeta</span> <span class='hs-layout'>(</span><span class='hs-conid'>MetaP</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-895"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>r</span> <span class='hs-varop'>.</span> <span class='hs-varid'>runMeta'</span> <span class='hs-conid'>True</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>runQResult</span> <span class='hs-conid'>TH.pprint</span> <span class='hs-varid'>convertToPat</span> <span class='hs-varid'>runTHPat</span><span class='hs-layout'>)</span>
<a name="line-896"></a><span class='hs-definition'>defaultRunMeta</span> <span class='hs-layout'>(</span><span class='hs-conid'>MetaT</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-897"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>r</span> <span class='hs-varop'>.</span> <span class='hs-varid'>runMeta'</span> <span class='hs-conid'>True</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>runQResult</span> <span class='hs-conid'>TH.pprint</span> <span class='hs-varid'>convertToHsType</span> <span class='hs-varid'>runTHType</span><span class='hs-layout'>)</span>
<a name="line-898"></a><span class='hs-definition'>defaultRunMeta</span> <span class='hs-layout'>(</span><span class='hs-conid'>MetaD</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-899"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>r</span> <span class='hs-varop'>.</span> <span class='hs-varid'>runMeta'</span> <span class='hs-conid'>True</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>runQResult</span> <span class='hs-conid'>TH.pprint</span> <span class='hs-varid'>convertToHsDecls</span> <span class='hs-varid'>runTHDec</span><span class='hs-layout'>)</span>
<a name="line-900"></a><span class='hs-definition'>defaultRunMeta</span> <span class='hs-layout'>(</span><span class='hs-conid'>MetaAW</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-901"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>r</span> <span class='hs-varop'>.</span> <span class='hs-varid'>runMeta'</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>convertAnnotationWrapper</span><span class='hs-layout'>)</span>
<a name="line-902"></a>    <span class='hs-comment'>-- We turn off showing the code in meta-level exceptions because doing so exposes</span>
<a name="line-903"></a>    <span class='hs-comment'>-- the toAnnotationWrapper function that we slap around the user's code</span>
<a name="line-904"></a>
<a name="line-905"></a><a name="runMetaAW"></a><span class='hs-comment'>----------------</span>
<a name="line-906"></a><span class='hs-definition'>runMetaAW</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>GhcTc</span>         <span class='hs-comment'>-- Of type AnnotationWrapper</span>
<a name="line-907"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Serialized</span>
<a name="line-908"></a><span class='hs-definition'>runMetaAW</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runMeta</span> <span class='hs-varid'>metaRequestAW</span>
<a name="line-909"></a>
<a name="line-910"></a><a name="runMetaE"></a><span class='hs-definition'>runMetaE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>GhcTc</span>          <span class='hs-comment'>-- Of type (Q Exp)</span>
<a name="line-911"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-912"></a><span class='hs-definition'>runMetaE</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runMeta</span> <span class='hs-varid'>metaRequestE</span>
<a name="line-913"></a>
<a name="line-914"></a><a name="runMetaP"></a><span class='hs-definition'>runMetaP</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>GhcTc</span>          <span class='hs-comment'>-- Of type (Q Pat)</span>
<a name="line-915"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-916"></a><span class='hs-definition'>runMetaP</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runMeta</span> <span class='hs-varid'>metaRequestP</span>
<a name="line-917"></a>
<a name="line-918"></a><a name="runMetaT"></a><span class='hs-definition'>runMetaT</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>GhcTc</span>          <span class='hs-comment'>-- Of type (Q Type)</span>
<a name="line-919"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-920"></a><span class='hs-definition'>runMetaT</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runMeta</span> <span class='hs-varid'>metaRequestT</span>
<a name="line-921"></a>
<a name="line-922"></a><a name="runMetaD"></a><span class='hs-definition'>runMetaD</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>GhcTc</span>          <span class='hs-comment'>-- Of type Q [Dec]</span>
<a name="line-923"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span>
<a name="line-924"></a><span class='hs-definition'>runMetaD</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runMeta</span> <span class='hs-varid'>metaRequestD</span>
<a name="line-925"></a>
<a name="line-926"></a><a name="runMeta'"></a><span class='hs-comment'>---------------</span>
<a name="line-927"></a><span class='hs-definition'>runMeta'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>                 <span class='hs-comment'>-- Whether code should be printed in the exception message</span>
<a name="line-928"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>hs_syn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>                                    <span class='hs-comment'>-- how to print the code</span>
<a name="line-929"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ForeignHValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-conid'>SDoc</span> <span class='hs-varid'>hs_syn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- How to run x</span>
<a name="line-930"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>GhcTc</span>        <span class='hs-comment'>-- Of type x; typically x = Q TH.Exp, or</span>
<a name="line-931"></a>                                 <span class='hs-comment'>--    something like that</span>
<a name="line-932"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>hs_syn</span>           <span class='hs-comment'>-- Of type t</span>
<a name="line-933"></a><span class='hs-definition'>runMeta'</span> <span class='hs-varid'>show_code</span> <span class='hs-varid'>ppr_hs</span> <span class='hs-varid'>run_and_convert</span> <span class='hs-varid'>expr</span>
<a name="line-934"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"About to run"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-935"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>recordThSpliceUse</span> <span class='hs-comment'>-- seems to be the best place to do this,</span>
<a name="line-936"></a>                            <span class='hs-comment'>-- we catch all kinds of splices and annotations.</span>
<a name="line-937"></a>
<a name="line-938"></a>        <span class='hs-comment'>-- Check that we've had no errors of any sort so far.</span>
<a name="line-939"></a>        <span class='hs-comment'>-- For example, if we found an error in an earlier defn f, but</span>
<a name="line-940"></a>        <span class='hs-comment'>-- recovered giving it type f :: forall a.a, it'd be very dodgy</span>
<a name="line-941"></a>        <span class='hs-comment'>-- to carry ont.  Mind you, the staging restrictions mean we won't</span>
<a name="line-942"></a>        <span class='hs-comment'>-- actually run f, but it still seems wrong. And, more concretely,</span>
<a name="line-943"></a>        <span class='hs-comment'>-- see #5358 for an example that fell over when trying to</span>
<a name="line-944"></a>        <span class='hs-comment'>-- reify a function with a "?" kind in it.  (These don't occur</span>
<a name="line-945"></a>        <span class='hs-comment'>-- in type-correct programs.</span>
<a name="line-946"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>failIfErrsM</span>
<a name="line-947"></a>
<a name="line-948"></a>        <span class='hs-comment'>-- run plugins</span>
<a name="line-949"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTopEnv</span>
<a name="line-950"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>withPlugins</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>spliceRunAction</span> <span class='hs-varid'>expr</span>
<a name="line-951"></a>
<a name="line-952"></a>        <span class='hs-comment'>-- Desugar</span>
<a name="line-953"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ds_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initDsTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span>
<a name="line-954"></a>        <span class='hs-comment'>-- Compile and link it; might fail if linking fails</span>
<a name="line-955"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>src_span</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-956"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"About to run (desugared)"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ds_expr</span><span class='hs-layout'>)</span>
<a name="line-957"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>either_hval</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tryM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span>
<a name="line-958"></a>                         <span class='hs-conid'>GHC.Driver.Main.hscCompileCoreExpr</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>src_span</span> <span class='hs-varid'>ds_expr</span>
<a name="line-959"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>either_hval</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-960"></a>            <span class='hs-conid'>Left</span> <span class='hs-varid'>exn</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail_with_exn</span> <span class='hs-str'>"compile and link"</span> <span class='hs-varid'>exn</span> <span class='hs-layout'>;</span>
<a name="line-961"></a>            <span class='hs-conid'>Right</span> <span class='hs-varid'>hval</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-962"></a>
<a name="line-963"></a>        <span class='hs-layout'>{</span>       <span class='hs-comment'>-- Coerce it to Q t, and run it</span>
<a name="line-964"></a>
<a name="line-965"></a>                <span class='hs-comment'>-- Running might fail if it throws an exception of any kind (hence tryAllM)</span>
<a name="line-966"></a>                <span class='hs-comment'>-- including, say, a pattern-match exception in the code we are running</span>
<a name="line-967"></a>                <span class='hs-comment'>--</span>
<a name="line-968"></a>                <span class='hs-comment'>-- We also do the TH -&gt; HS syntax conversion inside the same</span>
<a name="line-969"></a>                <span class='hs-comment'>-- exception-catching thing so that if there are any lurking</span>
<a name="line-970"></a>                <span class='hs-comment'>-- exceptions in the data structure returned by hval, we'll</span>
<a name="line-971"></a>                <span class='hs-comment'>-- encounter them inside the try</span>
<a name="line-972"></a>                <span class='hs-comment'>--</span>
<a name="line-973"></a>                <span class='hs-comment'>-- See Note [Exceptions in TH]</span>
<a name="line-974"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>expr_span</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getLocA</span> <span class='hs-varid'>expr</span>
<a name="line-975"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>either_tval</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tryAllM</span> <span class='hs-varop'>$</span>
<a name="line-976"></a>                         <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>expr_span</span> <span class='hs-varop'>$</span> <span class='hs-comment'>-- Set the span so that qLocation can</span>
<a name="line-977"></a>                                                <span class='hs-comment'>-- see where this splice is</span>
<a name="line-978"></a>             <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>run_and_convert</span> <span class='hs-varid'>expr_span</span> <span class='hs-varid'>hval</span>
<a name="line-979"></a>                <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_result</span> <span class='hs-keyword'>of</span>
<a name="line-980"></a>                    <span class='hs-conid'>Left</span> <span class='hs-varid'>err</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>err</span>
<a name="line-981"></a>                    <span class='hs-conid'>Right</span> <span class='hs-varid'>result</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Got HsSyn result:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_hs</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-982"></a>                                       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>result</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-983"></a>
<a name="line-984"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>either_tval</span> <span class='hs-keyword'>of</span>
<a name="line-985"></a>            <span class='hs-conid'>Right</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-986"></a>            <span class='hs-conid'>Left</span> <span class='hs-varid'>se</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fromException</span> <span class='hs-varid'>se</span> <span class='hs-keyword'>of</span>
<a name="line-987"></a>                         <span class='hs-conid'>Just</span> <span class='hs-conid'>IOEnvFailure</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failM</span> <span class='hs-comment'>-- Error already in Tc monad</span>
<a name="line-988"></a>                         <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail_with_exn</span> <span class='hs-str'>"run"</span> <span class='hs-varid'>se</span> <span class='hs-comment'>-- Exception</span>
<a name="line-989"></a>        <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-990"></a>  <span class='hs-keyword'>where</span>
<a name="line-991"></a>    <span class='hs-comment'>-- see Note [Concealed TH exceptions]</span>
<a name="line-992"></a>    <span class='hs-varid'>fail_with_exn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Exception</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-993"></a>    <span class='hs-varid'>fail_with_exn</span> <span class='hs-varid'>phase</span> <span class='hs-varid'>exn</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-994"></a>        <span class='hs-varid'>exn_msg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Panic.safeShowException</span> <span class='hs-varid'>exn</span>
<a name="line-995"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"Exception when trying to"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>phase</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"compile-time code:"</span><span class='hs-layout'>,</span>
<a name="line-996"></a>                        <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>exn_msg</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-997"></a>                        <span class='hs-keyword'>if</span> <span class='hs-varid'>show_code</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Code:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span><span class='hs-keyglyph'>]</span>
<a name="line-998"></a>        <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>msg</span>
<a name="line-999"></a>
<a name="line-1000"></a><span class='hs-comment'>{-
<a name="line-1001"></a>Note [Running typed splices in the zonker]
<a name="line-1002"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1003"></a>
<a name="line-1004"></a>See #15471 for the full discussion.
<a name="line-1005"></a>
<a name="line-1006"></a>For many years typed splices were run immediately after they were type checked
<a name="line-1007"></a>however, this is too early as it means to zonk some type variables before
<a name="line-1008"></a>they can be unified with type variables in the surrounding context.
<a name="line-1009"></a>
<a name="line-1010"></a>For example,
<a name="line-1011"></a>
<a name="line-1012"></a>```
<a name="line-1013"></a>module A where
<a name="line-1014"></a>
<a name="line-1015"></a>test_foo :: forall a . Q (TExp (a -&gt; a))
<a name="line-1016"></a>test_foo = [|| id ||]
<a name="line-1017"></a>
<a name="line-1018"></a>module B where
<a name="line-1019"></a>
<a name="line-1020"></a>import A
<a name="line-1021"></a>
<a name="line-1022"></a>qux = $$(test_foo)
<a name="line-1023"></a>```
<a name="line-1024"></a>
<a name="line-1025"></a>We would expect `qux` to have inferred type `forall a . a -&gt; a` but if
<a name="line-1026"></a>we run the splices too early the unified variables are zonked to `Any`. The
<a name="line-1027"></a>inferred type is the unusable `Any -&gt; Any`.
<a name="line-1028"></a>
<a name="line-1029"></a>To run the splice, we must compile `test_foo` all the way to byte code.
<a name="line-1030"></a>But at the moment when the type checker is looking at the splice, test_foo
<a name="line-1031"></a>has type `Q (TExp (alpha -&gt; alpha))` and we
<a name="line-1032"></a>certainly can't compile code involving unification variables!
<a name="line-1033"></a>
<a name="line-1034"></a>We could default `alpha` to `Any` but then we infer `qux :: Any -&gt; Any`
<a name="line-1035"></a>which definitely is not what we want.  Moreover, if we had
<a name="line-1036"></a>  qux = [$$(test_foo), (\x -&gt; x +1::Int)]
<a name="line-1037"></a>then `alpha` would have to be `Int`.
<a name="line-1038"></a>
<a name="line-1039"></a>Conclusion: we must defer taking decisions about `alpha` until the
<a name="line-1040"></a>typechecker is done; and *then* we can run the splice.  It's fine to do it
<a name="line-1041"></a>later, because we know it'll produce type-correct code.
<a name="line-1042"></a>
<a name="line-1043"></a>Deferring running the splice until later, in the zonker, means that the
<a name="line-1044"></a>unification variables propagate upwards from the splice into the surrounding
<a name="line-1045"></a>context and are unified correctly.
<a name="line-1046"></a>
<a name="line-1047"></a>This is implemented by storing the arguments we need for running the splice
<a name="line-1048"></a>in a `DelayedSplice`. In the zonker, the arguments are passed to
<a name="line-1049"></a>`GHC.Tc.Gen.Splice.runTopSplice` and the expression inserted into the AST as normal.
<a name="line-1050"></a>
<a name="line-1051"></a>
<a name="line-1052"></a>
<a name="line-1053"></a>Note [Exceptions in TH]
<a name="line-1054"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1055"></a>Suppose we have something like this
<a name="line-1056"></a>        $( f 4 )
<a name="line-1057"></a>where
<a name="line-1058"></a>        f :: Int -&gt; Q [Dec]
<a name="line-1059"></a>        f n | n&gt;3       = fail "Too many declarations"
<a name="line-1060"></a>            | otherwise = ...
<a name="line-1061"></a>
<a name="line-1062"></a>The 'fail' is a user-generated failure, and should be displayed as a
<a name="line-1063"></a>perfectly ordinary compiler error message, not a panic or anything
<a name="line-1064"></a>like that.  Here's how it's processed:
<a name="line-1065"></a>
<a name="line-1066"></a>  * 'fail' is the monad fail.  The monad instance for Q in TH.Syntax
<a name="line-1067"></a>    effectively transforms (fail s) to
<a name="line-1068"></a>        qReport True s &gt;&gt; fail
<a name="line-1069"></a>    where 'qReport' comes from the Quasi class and fail from its monad
<a name="line-1070"></a>    superclass.
<a name="line-1071"></a>
<a name="line-1072"></a>  * The TcM monad is an instance of Quasi (see GHC.Tc.Gen.Splice), and it implements
<a name="line-1073"></a>    (qReport True s) by using addErr to add an error message to the bag of errors.
<a name="line-1074"></a>    The 'fail' in TcM raises an IOEnvFailure exception
<a name="line-1075"></a>
<a name="line-1076"></a> * 'qReport' forces the message to ensure any exception hidden in unevaluated
<a name="line-1077"></a>   thunk doesn't get into the bag of errors. Otherwise the following splice
<a name="line-1078"></a>   will trigger panic (#8987):
<a name="line-1079"></a>        $(fail undefined)
<a name="line-1080"></a>   See also Note [Concealed TH exceptions]
<a name="line-1081"></a>
<a name="line-1082"></a>  * So, when running a splice, we catch all exceptions; then for
<a name="line-1083"></a>        - an IOEnvFailure exception, we assume the error is already
<a name="line-1084"></a>                in the error-bag (above)
<a name="line-1085"></a>        - other errors, we add an error to the bag
<a name="line-1086"></a>    and then fail
<a name="line-1087"></a>
<a name="line-1088"></a>Note [Concealed TH exceptions]
<a name="line-1089"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1090"></a>When displaying the error message contained in an exception originated from TH
<a name="line-1091"></a>code, we need to make sure that the error message itself does not contain an
<a name="line-1092"></a>exception.  For example, when executing the following splice:
<a name="line-1093"></a>
<a name="line-1094"></a>    $( error ("foo " ++ error "bar") )
<a name="line-1095"></a>
<a name="line-1096"></a>the message for the outer exception is a thunk which will throw the inner
<a name="line-1097"></a>exception when evaluated.
<a name="line-1098"></a>
<a name="line-1099"></a>For this reason, we display the message of a TH exception using the
<a name="line-1100"></a>'safeShowException' function, which recursively catches any exception thrown
<a name="line-1101"></a>when showing an error message.
<a name="line-1102"></a>
<a name="line-1103"></a>
<a name="line-1104"></a>To call runQ in the Tc monad, we need to make TcM an instance of Quasi:
<a name="line-1105"></a>-}</span>
<a name="line-1106"></a>
<a name="line-1107"></a><a name="instance%20TH.Quasi%20TcM"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>TH.Quasi</span> <span class='hs-conid'>TcM</span> <span class='hs-keyword'>where</span>
<a name="line-1108"></a>  <span class='hs-varid'>qNewName</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>u</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-1109"></a>                  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toInteger</span> <span class='hs-layout'>(</span><span class='hs-varid'>getKey</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-1110"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.mkNameU</span> <span class='hs-varid'>s</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1111"></a>
<a name="line-1112"></a>  <span class='hs-comment'>-- 'msg' is forced to ensure exceptions don't escape,</span>
<a name="line-1113"></a>  <span class='hs-comment'>-- see Note [Exceptions in TH]</span>
<a name="line-1114"></a>  <span class='hs-varid'>qReport</span> <span class='hs-conid'>True</span> <span class='hs-varid'>msg</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqList</span> <span class='hs-varid'>msg</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addErr</span>  <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-1115"></a>  <span class='hs-varid'>qReport</span> <span class='hs-conid'>False</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqList</span> <span class='hs-varid'>msg</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addWarn</span> <span class='hs-conid'>NoReason</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-1116"></a>
<a name="line-1117"></a>  <span class='hs-varid'>qLocation</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-1118"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-1119"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>l</span> <span class='hs-keyword'>of</span>
<a name="line-1120"></a>                        <span class='hs-conid'>UnhelpfulSpan</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"qLocation: Unhelpful location"</span>
<a name="line-1121"></a>                                                    <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-1122"></a>                        <span class='hs-conid'>RealSrcSpan</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>s</span>
<a name="line-1123"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.Loc</span> <span class='hs-layout'>{</span> <span class='hs-conid'>TH.loc_filename</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unpackFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcSpanFile</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1124"></a>                                  <span class='hs-layout'>,</span> <span class='hs-conid'>TH.loc_module</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleNameString</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-1125"></a>                                  <span class='hs-layout'>,</span> <span class='hs-conid'>TH.loc_package</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitString</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleUnit</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-1126"></a>                                  <span class='hs-layout'>,</span> <span class='hs-conid'>TH.loc_start</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcSpanStartLine</span> <span class='hs-varid'>r</span><span class='hs-layout'>,</span> <span class='hs-varid'>srcSpanStartCol</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1127"></a>                                  <span class='hs-layout'>,</span> <span class='hs-conid'>TH.loc_end</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcSpanEndLine</span>   <span class='hs-varid'>r</span><span class='hs-layout'>,</span> <span class='hs-varid'>srcSpanEndCol</span>   <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1128"></a>
<a name="line-1129"></a>  <span class='hs-varid'>qLookupName</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupName</span>
<a name="line-1130"></a>  <span class='hs-varid'>qReify</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reify</span>
<a name="line-1131"></a>  <span class='hs-varid'>qReifyFixity</span> <span class='hs-varid'>nm</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupThName</span> <span class='hs-varid'>nm</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>reifyFixity</span>
<a name="line-1132"></a>  <span class='hs-varid'>qReifyType</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyTypeOfThing</span>
<a name="line-1133"></a>  <span class='hs-varid'>qReifyInstances</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyInstances</span>
<a name="line-1134"></a>  <span class='hs-varid'>qReifyRoles</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyRoles</span>
<a name="line-1135"></a>  <span class='hs-varid'>qReifyAnnotations</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyAnnotations</span>
<a name="line-1136"></a>  <span class='hs-varid'>qReifyModule</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyModule</span>
<a name="line-1137"></a>  <span class='hs-varid'>qReifyConStrictness</span> <span class='hs-varid'>nm</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>nm'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupThName</span> <span class='hs-varid'>nm</span>
<a name="line-1138"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>dc</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupDataCon</span> <span class='hs-varid'>nm'</span>
<a name="line-1139"></a>                              <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bangs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConImplBangs</span> <span class='hs-varid'>dc</span>
<a name="line-1140"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>reifyDecidedStrictness</span> <span class='hs-varid'>bangs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1141"></a>
<a name="line-1142"></a>        <span class='hs-comment'>-- For qRecover, discard error messages if</span>
<a name="line-1143"></a>        <span class='hs-comment'>-- the recovery action is chosen.  Otherwise</span>
<a name="line-1144"></a>        <span class='hs-comment'>-- we'll only fail higher up.</span>
<a name="line-1145"></a>  <span class='hs-varid'>qRecover</span> <span class='hs-varid'>recover</span> <span class='hs-varid'>main</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tryTcDiscardingErrs</span> <span class='hs-varid'>recover</span> <span class='hs-varid'>main</span>
<a name="line-1146"></a>
<a name="line-1147"></a>  <span class='hs-varid'>qAddDependentFile</span> <span class='hs-varid'>fp</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1148"></a>    <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tcg_dependent_files</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-1149"></a>    <span class='hs-varid'>dep_files</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTcRef</span> <span class='hs-varid'>ref</span>
<a name="line-1150"></a>    <span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-varid'>fp</span><span class='hs-conop'>:</span><span class='hs-varid'>dep_files</span><span class='hs-layout'>)</span>
<a name="line-1151"></a>
<a name="line-1152"></a>  <span class='hs-varid'>qAddTempFile</span> <span class='hs-varid'>suffix</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1153"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-1154"></a>    <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLogger</span>
<a name="line-1155"></a>    <span class='hs-varid'>tmpfs</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hsc_tmpfs</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getTopEnv</span>
<a name="line-1156"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>newTempName</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>tmpfs</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>TFL_GhcSession</span> <span class='hs-varid'>suffix</span>
<a name="line-1157"></a>
<a name="line-1158"></a>  <span class='hs-varid'>qAddTopDecls</span> <span class='hs-varid'>thds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1159"></a>      <span class='hs-varid'>l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-1160"></a>      <span class='hs-varid'>th_origin</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getThSpliceOrigin</span>
<a name="line-1161"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>either_hval</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>convertToHsDecls</span> <span class='hs-varid'>th_origin</span> <span class='hs-varid'>l</span> <span class='hs-varid'>thds</span>
<a name="line-1162"></a>      <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>either_hval</span> <span class='hs-keyword'>of</span>
<a name="line-1163"></a>              <span class='hs-conid'>Left</span> <span class='hs-varid'>exn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varop'>$</span>
<a name="line-1164"></a>                <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Error in a declaration passed to addTopDecls:"</span><span class='hs-layout'>)</span>
<a name="line-1165"></a>                   <span class='hs-num'>2</span> <span class='hs-varid'>exn</span>
<a name="line-1166"></a>              <span class='hs-conid'>Right</span> <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ds</span>
<a name="line-1167"></a>      <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkTopDecl</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span>
<a name="line-1168"></a>      <span class='hs-varid'>th_topdecls_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tcg_th_topdecls</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-1169"></a>      <span class='hs-varid'>updTcRef</span> <span class='hs-varid'>th_topdecls_var</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>topds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ds</span> <span class='hs-varop'>++</span> <span class='hs-varid'>topds</span><span class='hs-layout'>)</span>
<a name="line-1170"></a>    <span class='hs-keyword'>where</span>
<a name="line-1171"></a>      <span class='hs-varid'>checkTopDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDecl</span> <span class='hs-conid'>GhcPs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-1172"></a>      <span class='hs-varid'>checkTopDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValD</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-1173"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>bindName</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectHsBindBinders</span> <span class='hs-conid'>CollNoDictBinders</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-1174"></a>      <span class='hs-varid'>checkTopDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigD</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-1175"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1176"></a>      <span class='hs-varid'>checkTopDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnnD</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-1177"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1178"></a>      <span class='hs-varid'>checkTopDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForD</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignImport</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fd_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1179"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindName</span> <span class='hs-varid'>name</span>
<a name="line-1180"></a>      <span class='hs-varid'>checkTopDecl</span> <span class='hs-keyword'>_</span>
<a name="line-1181"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Only function, value, annotation, and foreign import declarations may be added with addTopDecl"</span>
<a name="line-1182"></a>
<a name="line-1183"></a>      <span class='hs-varid'>bindName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-1184"></a>      <span class='hs-varid'>bindName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Exact</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-1185"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>th_topnames_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tcg_th_topnames</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-1186"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>updTcRef</span> <span class='hs-varid'>th_topnames_var</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ns</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendNameSet</span> <span class='hs-varid'>ns</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-1187"></a>             <span class='hs-layout'>}</span>
<a name="line-1188"></a>
<a name="line-1189"></a>      <span class='hs-varid'>bindName</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span>
<a name="line-1190"></a>          <span class='hs-varid'>addErr</span> <span class='hs-varop'>$</span>
<a name="line-1191"></a>          <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"The binder"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is not a NameU."</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1192"></a>             <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Probable cause: you used mkName instead of newName to generate a binding."</span><span class='hs-layout'>)</span>
<a name="line-1193"></a>
<a name="line-1194"></a>  <span class='hs-varid'>qAddForeignFilePath</span> <span class='hs-varid'>lang</span> <span class='hs-varid'>fp</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1195"></a>    <span class='hs-varid'>var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tcg_th_foreign_files</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-1196"></a>    <span class='hs-varid'>updTcRef</span> <span class='hs-varid'>var</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>lang</span><span class='hs-layout'>,</span> <span class='hs-varid'>fp</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span><span class='hs-layout'>)</span>
<a name="line-1197"></a>
<a name="line-1198"></a>  <span class='hs-varid'>qAddModFinalizer</span> <span class='hs-varid'>fin</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1199"></a>      <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkRemoteRef</span> <span class='hs-varid'>fin</span>
<a name="line-1200"></a>      <span class='hs-varid'>fref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkForeignRef</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>freeRemoteRef</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1201"></a>      <span class='hs-varid'>addModFinalizerRef</span> <span class='hs-varid'>fref</span>
<a name="line-1202"></a>
<a name="line-1203"></a>  <span class='hs-varid'>qAddCorePlugin</span> <span class='hs-varid'>plugin</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1204"></a>      <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTopEnv</span>
<a name="line-1205"></a>      <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>findHomeModule</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkModuleName</span> <span class='hs-varid'>plugin</span><span class='hs-layout'>)</span>
<a name="line-1206"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span>
<a name="line-1207"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"addCorePlugin: invalid plugin module "</span>
<a name="line-1208"></a>               <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>plugin</span><span class='hs-layout'>)</span>
<a name="line-1209"></a>            <span class='hs-layout'>)</span>
<a name="line-1210"></a>            <span class='hs-num'>2</span>
<a name="line-1211"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Plugins in the current package can't be specified."</span><span class='hs-layout'>)</span>
<a name="line-1212"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>of</span>
<a name="line-1213"></a>        <span class='hs-conid'>Found</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>addErr</span> <span class='hs-varid'>err</span>
<a name="line-1214"></a>        <span class='hs-conid'>FoundMultiple</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>addErr</span> <span class='hs-varid'>err</span>
<a name="line-1215"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1216"></a>      <span class='hs-varid'>th_coreplugins_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcg_th_coreplugins</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-1217"></a>      <span class='hs-varid'>updTcRef</span> <span class='hs-varid'>th_coreplugins_var</span> <span class='hs-layout'>(</span><span class='hs-varid'>plugin</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span>
<a name="line-1218"></a>
<a name="line-1219"></a>  <span class='hs-varid'>qGetQ</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span><span class='hs-varop'>.</span> <span class='hs-conid'>Typeable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1220"></a>  <span class='hs-varid'>qGetQ</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1221"></a>      <span class='hs-varid'>th_state_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tcg_th_state</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-1222"></a>      <span class='hs-varid'>th_state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTcRef</span> <span class='hs-varid'>th_state_var</span>
<a name="line-1223"></a>      <span class='hs-comment'>-- See #10596 for why we use a scoped type variable here.</span>
<a name="line-1224"></a>      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map.lookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeRep</span> <span class='hs-layout'>(</span><span class='hs-conid'>Proxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>th_state</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>fromDynamic</span><span class='hs-layout'>)</span>
<a name="line-1225"></a>
<a name="line-1226"></a>  <span class='hs-varid'>qPutQ</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1227"></a>      <span class='hs-varid'>th_state_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tcg_th_state</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-1228"></a>      <span class='hs-varid'>updTcRef</span> <span class='hs-varid'>th_state_var</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Map.insert</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeOf</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>toDyn</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-1229"></a>
<a name="line-1230"></a>  <span class='hs-varid'>qIsExtEnabled</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xoptM</span>
<a name="line-1231"></a>
<a name="line-1232"></a>  <span class='hs-varid'>qExtsEnabled</span> <span class='hs-keyglyph'>=</span>
<a name="line-1233"></a>    <span class='hs-conid'>EnumSet.toList</span> <span class='hs-varop'>.</span> <span class='hs-varid'>extensionFlags</span> <span class='hs-varop'>.</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getTopEnv</span>
<a name="line-1234"></a>
<a name="line-1235"></a>  <span class='hs-varid'>qPutDoc</span> <span class='hs-varid'>doc_loc</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1236"></a>    <span class='hs-varid'>th_doc_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcg_th_docs</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-1237"></a>    <span class='hs-varid'>resolved_doc_loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>resolve_loc</span> <span class='hs-varid'>doc_loc</span>
<a name="line-1238"></a>    <span class='hs-varid'>is_local</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkLocalName</span> <span class='hs-varid'>resolved_doc_loc</span>
<a name="line-1239"></a>    <span class='hs-varid'>unless</span> <span class='hs-varid'>is_local</span> <span class='hs-varop'>$</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span>
<a name="line-1240"></a>      <span class='hs-str'>"Can't add documentation to"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_loc</span> <span class='hs-varid'>doc_loc</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-1241"></a>      <span class='hs-varid'>text</span> <span class='hs-str'>"as it isn't inside the current module"</span>
<a name="line-1242"></a>    <span class='hs-varid'>updTcRef</span> <span class='hs-varid'>th_doc_var</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map.insert</span> <span class='hs-varid'>resolved_doc_loc</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-1243"></a>    <span class='hs-keyword'>where</span>
<a name="line-1244"></a>      <span class='hs-varid'>resolve_loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.DeclDoc</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DeclDoc</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>lookupThName</span> <span class='hs-varid'>n</span>
<a name="line-1245"></a>      <span class='hs-varid'>resolve_loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.ArgDoc</span> <span class='hs-varid'>n</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ArgDoc</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>lookupThName</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>i</span>
<a name="line-1246"></a>      <span class='hs-varid'>resolve_loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.InstDoc</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InstDoc</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>getName</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupThInstName</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-1247"></a>      <span class='hs-varid'>resolve_loc</span> <span class='hs-conid'>TH.ModuleDoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pure</span> <span class='hs-conid'>ModuleDoc</span>
<a name="line-1248"></a>
<a name="line-1249"></a>      <span class='hs-varid'>ppr_loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.DeclDoc</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_th</span> <span class='hs-varid'>n</span>
<a name="line-1250"></a>      <span class='hs-varid'>ppr_loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.ArgDoc</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_th</span> <span class='hs-varid'>n</span>
<a name="line-1251"></a>      <span class='hs-varid'>ppr_loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.InstDoc</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_th</span> <span class='hs-varid'>t</span>
<a name="line-1252"></a>      <span class='hs-varid'>ppr_loc</span> <span class='hs-conid'>TH.ModuleDoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"the module header"</span>
<a name="line-1253"></a>
<a name="line-1254"></a>      <span class='hs-comment'>-- It doesn't make sense to add documentation to something not inside</span>
<a name="line-1255"></a>      <span class='hs-comment'>-- the current module. So check for it!</span>
<a name="line-1256"></a>      <span class='hs-varid'>checkLocalName</span> <span class='hs-layout'>(</span><span class='hs-conid'>DeclDoc</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getModule</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>n</span>
<a name="line-1257"></a>      <span class='hs-varid'>checkLocalName</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArgDoc</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getModule</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>n</span>
<a name="line-1258"></a>      <span class='hs-varid'>checkLocalName</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstDoc</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getModule</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>n</span>
<a name="line-1259"></a>      <span class='hs-varid'>checkLocalName</span> <span class='hs-conid'>ModuleDoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pure</span> <span class='hs-conid'>True</span>
<a name="line-1260"></a>
<a name="line-1261"></a>
<a name="line-1262"></a>  <span class='hs-varid'>qGetDoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.DeclDoc</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupThName</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>lookupDeclDoc</span>
<a name="line-1263"></a>  <span class='hs-varid'>qGetDoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.InstDoc</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupThInstName</span> <span class='hs-varid'>t</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>lookupDeclDoc</span>
<a name="line-1264"></a>  <span class='hs-varid'>qGetDoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.ArgDoc</span> <span class='hs-varid'>n</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupThName</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>lookupArgDoc</span> <span class='hs-varid'>i</span>
<a name="line-1265"></a>  <span class='hs-varid'>qGetDoc</span> <span class='hs-conid'>TH.ModuleDoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1266"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>moduleDoc</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>extractDocs</span>
<a name="line-1267"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>unpackHDS</span> <span class='hs-varid'>moduleDoc</span><span class='hs-layout'>)</span>
<a name="line-1268"></a>
<a name="line-1269"></a><a name="lookupDeclDoc"></a><span class='hs-comment'>-- | Looks up documentation for a declaration in first the current module,</span>
<a name="line-1270"></a><span class='hs-comment'>-- otherwise tries to find it in another module via 'hscGetModuleInterface'.</span>
<a name="line-1271"></a><span class='hs-definition'>lookupDeclDoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-1272"></a><span class='hs-definition'>lookupDeclDoc</span> <span class='hs-varid'>nm</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1273"></a>  <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>DeclDocMap</span> <span class='hs-varid'>declDocs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>extractDocs</span>
<a name="line-1274"></a>  <span class='hs-varid'>fam_insts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcg_fam_insts</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-1275"></a>  <span class='hs-varid'>traceTc</span> <span class='hs-str'>"lookupDeclDoc"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>nm</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>declDocs</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fam_insts</span><span class='hs-layout'>)</span>
<a name="line-1276"></a>  <span class='hs-keyword'>case</span> <span class='hs-conid'>Map.lookup</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>declDocs</span> <span class='hs-keyword'>of</span>
<a name="line-1277"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>unpackHDS</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>
<a name="line-1278"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1279"></a>      <span class='hs-comment'>-- Wasn't in the current module. Try searching other external ones!</span>
<a name="line-1280"></a>      <span class='hs-varid'>mIface</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getExternalModIface</span> <span class='hs-varid'>nm</span>
<a name="line-1281"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>mIface</span> <span class='hs-keyword'>of</span>
<a name="line-1282"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-conid'>Nothing</span>
<a name="line-1283"></a>        <span class='hs-conid'>Just</span> <span class='hs-conid'>ModIface</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mi_decl_docs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DeclDocMap</span> <span class='hs-varid'>dmap</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1284"></a>          <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unpackHDS</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-conid'>Map.lookup</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>dmap</span>
<a name="line-1285"></a>
<a name="line-1286"></a><a name="lookupArgDoc"></a><span class='hs-comment'>-- | Like 'lookupDeclDoc', looks up documentation for a function argument. If</span>
<a name="line-1287"></a><span class='hs-comment'>-- it can't find any documentation for a function in this module, it tries to</span>
<a name="line-1288"></a><span class='hs-comment'>-- find it in another module.</span>
<a name="line-1289"></a><span class='hs-definition'>lookupArgDoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-1290"></a><span class='hs-definition'>lookupArgDoc</span> <span class='hs-varid'>i</span> <span class='hs-varid'>nm</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1291"></a>  <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>ArgDocMap</span> <span class='hs-varid'>argDocs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>extractDocs</span>
<a name="line-1292"></a>  <span class='hs-keyword'>case</span> <span class='hs-conid'>Map.lookup</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>argDocs</span> <span class='hs-keyword'>of</span>
<a name="line-1293"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unpackHDS</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-conid'>IntMap.lookup</span> <span class='hs-varid'>i</span> <span class='hs-varid'>m</span>
<a name="line-1294"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1295"></a>      <span class='hs-varid'>mIface</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getExternalModIface</span> <span class='hs-varid'>nm</span>
<a name="line-1296"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>mIface</span> <span class='hs-keyword'>of</span>
<a name="line-1297"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-conid'>Nothing</span>
<a name="line-1298"></a>        <span class='hs-conid'>Just</span> <span class='hs-conid'>ModIface</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mi_arg_docs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ArgDocMap</span> <span class='hs-varid'>amap</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1299"></a>          <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unpackHDS</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map.lookup</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>amap</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-conid'>IntMap.lookup</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-1300"></a>
<a name="line-1301"></a><a name="getExternalModIface"></a><span class='hs-comment'>-- | Returns the module a Name belongs to, if it is isn't local.</span>
<a name="line-1302"></a><span class='hs-definition'>getExternalModIface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>ModIface</span><span class='hs-layout'>)</span>
<a name="line-1303"></a><span class='hs-definition'>getExternalModIface</span> <span class='hs-varid'>nm</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1304"></a>  <span class='hs-varid'>isLocal</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getModule</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>nm</span>
<a name="line-1305"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>isLocal</span>
<a name="line-1306"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>pure</span> <span class='hs-conid'>Nothing</span>
<a name="line-1307"></a>    <span class='hs-keyword'>else</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>nameModule_maybe</span> <span class='hs-varid'>nm</span> <span class='hs-keyword'>of</span>
<a name="line-1308"></a>          <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-conid'>Nothing</span>
<a name="line-1309"></a>          <span class='hs-conid'>Just</span> <span class='hs-varid'>modNm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1310"></a>            <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTopEnv</span>
<a name="line-1311"></a>            <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscGetModuleInterface</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>modNm</span>
<a name="line-1312"></a>            <span class='hs-varid'>pure</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-1313"></a>
<a name="line-1314"></a><a name="lookupThInstName"></a><span class='hs-comment'>-- | Find the GHC name of the first instance that matches the TH type</span>
<a name="line-1315"></a><span class='hs-definition'>lookupThInstName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH.Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Name</span>
<a name="line-1316"></a><span class='hs-definition'>lookupThInstName</span> <span class='hs-varid'>th_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1317"></a>  <span class='hs-varid'>cls_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>inst_cls_name</span> <span class='hs-varid'>th_type</span>
<a name="line-1318"></a>  <span class='hs-varid'>insts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyInstances'</span> <span class='hs-varid'>cls_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>inst_arg_types</span> <span class='hs-varid'>th_type</span><span class='hs-layout'>)</span>
<a name="line-1319"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>insts</span> <span class='hs-keyword'>of</span>   <span class='hs-comment'>-- This expands any type synonyms</span>
<a name="line-1320"></a>    <span class='hs-conid'>Left</span>  <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>inst</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>inst</span>
<a name="line-1321"></a>    <span class='hs-conid'>Left</span>  <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>noMatches</span>
<a name="line-1322"></a>    <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>inst</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>inst</span>
<a name="line-1323"></a>    <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>noMatches</span>
<a name="line-1324"></a>  <span class='hs-keyword'>where</span>
<a name="line-1325"></a>    <span class='hs-varid'>noMatches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varop'>$</span>
<a name="line-1326"></a>      <span class='hs-varid'>text</span> <span class='hs-str'>"Couldn't find any instances of"</span>
<a name="line-1327"></a>        <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_th</span> <span class='hs-varid'>th_type</span>
<a name="line-1328"></a>        <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"to add documentation to"</span>
<a name="line-1329"></a>
<a name="line-1330"></a>    <span class='hs-comment'>-- | Get the name of the class for the instance we are documenting</span>
<a name="line-1331"></a>    <span class='hs-comment'>-- &gt; inst_cls_name (Monad Maybe) == Monad</span>
<a name="line-1332"></a>    <span class='hs-comment'>-- &gt; inst_cls_name C = C</span>
<a name="line-1333"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH.Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH.Name</span>
<a name="line-1334"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.AppT</span> <span class='hs-varid'>t</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_cls_name</span> <span class='hs-varid'>t</span>
<a name="line-1335"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.SigT</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_cls_name</span> <span class='hs-varid'>n</span>
<a name="line-1336"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.VarT</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>n</span>
<a name="line-1337"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.ConT</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>n</span>
<a name="line-1338"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.PromotedT</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>n</span>
<a name="line-1339"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.InfixT</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>n</span>
<a name="line-1340"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.UInfixT</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>n</span>
<a name="line-1341"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.ParensT</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_cls_name</span> <span class='hs-varid'>t</span>
<a name="line-1342"></a>
<a name="line-1343"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.ForallT</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_cls_name_err</span>
<a name="line-1344"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.ForallVisT</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_cls_name_err</span>
<a name="line-1345"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.AppKindT</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_cls_name_err</span>
<a name="line-1346"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.TupleT</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_cls_name_err</span>
<a name="line-1347"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.UnboxedTupleT</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_cls_name_err</span>
<a name="line-1348"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.UnboxedSumT</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_cls_name_err</span>
<a name="line-1349"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-conid'>TH.ArrowT</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_cls_name_err</span>
<a name="line-1350"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-conid'>TH.MulArrowT</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_cls_name_err</span>
<a name="line-1351"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-conid'>TH.EqualityT</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_cls_name_err</span>
<a name="line-1352"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-conid'>TH.ListT</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_cls_name_err</span>
<a name="line-1353"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.PromotedTupleT</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_cls_name_err</span>
<a name="line-1354"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-conid'>TH.PromotedNilT</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_cls_name_err</span>
<a name="line-1355"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-conid'>TH.PromotedConsT</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_cls_name_err</span>
<a name="line-1356"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-conid'>TH.StarT</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_cls_name_err</span>
<a name="line-1357"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-conid'>TH.ConstraintT</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_cls_name_err</span>
<a name="line-1358"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.LitT</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_cls_name_err</span>
<a name="line-1359"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-conid'>TH.WildCardT</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_cls_name_err</span>
<a name="line-1360"></a>    <span class='hs-varid'>inst_cls_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.ImplicitParamT</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_cls_name_err</span>
<a name="line-1361"></a>
<a name="line-1362"></a>    <span class='hs-varid'>inst_cls_name_err</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varop'>$</span>
<a name="line-1363"></a>      <span class='hs-varid'>text</span> <span class='hs-str'>"Couldn't work out what instance"</span>
<a name="line-1364"></a>        <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_th</span> <span class='hs-varid'>th_type</span>
<a name="line-1365"></a>        <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"is supposed to be"</span>
<a name="line-1366"></a>
<a name="line-1367"></a>    <span class='hs-comment'>-- | Basically does the opposite of 'mkThAppTs'</span>
<a name="line-1368"></a>    <span class='hs-comment'>-- &gt; inst_arg_types (Monad Maybe) == [Maybe]</span>
<a name="line-1369"></a>    <span class='hs-comment'>-- &gt; inst_arg_types C == []</span>
<a name="line-1370"></a>    <span class='hs-varid'>inst_arg_types</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH.Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH.Type</span><span class='hs-keyglyph'>]</span>
<a name="line-1371"></a>    <span class='hs-varid'>inst_arg_types</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.AppT</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1372"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.AppT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span><span class='hs-conop'>:</span><span class='hs-varid'>go</span> <span class='hs-varid'>ts</span>
<a name="line-1373"></a>          <span class='hs-varid'>go</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>t</span><span class='hs-keyglyph'>]</span>
<a name="line-1374"></a>        <span class='hs-keyword'>in</span> <span class='hs-varid'>go</span> <span class='hs-varid'>args</span>
<a name="line-1375"></a>    <span class='hs-varid'>inst_arg_types</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-1376"></a>
<a name="line-1377"></a><a name="addModFinalizerRef"></a><span class='hs-comment'>-- | Adds a mod finalizer reference to the local environment.</span>
<a name="line-1378"></a><span class='hs-definition'>addModFinalizerRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.Q</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-1379"></a><span class='hs-definition'>addModFinalizerRef</span> <span class='hs-varid'>finRef</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1380"></a>    <span class='hs-varid'>th_stage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getStage</span>
<a name="line-1381"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>th_stage</span> <span class='hs-keyword'>of</span>
<a name="line-1382"></a>      <span class='hs-conid'>RunSplice</span> <span class='hs-varid'>th_modfinalizers_var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>updTcRef</span> <span class='hs-varid'>th_modfinalizers_var</span> <span class='hs-layout'>(</span><span class='hs-varid'>finRef</span> <span class='hs-conop'>:</span><span class='hs-layout'>)</span>
<a name="line-1383"></a>      <span class='hs-comment'>-- This case happens only if a splice is executed and the caller does</span>
<a name="line-1384"></a>      <span class='hs-comment'>-- not set the 'ThStage' to 'RunSplice' to collect finalizers.</span>
<a name="line-1385"></a>      <span class='hs-comment'>-- See Note [Delaying modFinalizers in untyped splices] in GHC.Rename.Splice.</span>
<a name="line-1386"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1387"></a>        <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"addModFinalizer was called when no finalizers were collected"</span>
<a name="line-1388"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>th_stage</span><span class='hs-layout'>)</span>
<a name="line-1389"></a>
<a name="line-1390"></a><a name="finishTH"></a><span class='hs-comment'>-- | Releases the external interpreter state.</span>
<a name="line-1391"></a><span class='hs-definition'>finishTH</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-1392"></a><span class='hs-definition'>finishTH</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1393"></a>  <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTopEnv</span>
<a name="line-1394"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>interpInstance</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>hsc_interp</span> <span class='hs-varid'>hsc_env</span> <span class='hs-keyword'>of</span>
<a name="line-1395"></a>    <span class='hs-conid'>Nothing</span>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-conid'>()</span>
<a name="line-1396"></a><span class='hs-cpp'>#if defined(HAVE_INTERNAL_INTERPRETER)</span>
<a name="line-1397"></a>    <span class='hs-conid'>Just</span> <span class='hs-conid'>InternalInterp</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-conid'>()</span>
<a name="line-1398"></a><span class='hs-cpp'>#endif</span>
<a name="line-1399"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExternalInterp</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1400"></a>      <span class='hs-varid'>tcg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-1401"></a>      <span class='hs-varid'>writeTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_th_remote_state</span> <span class='hs-varid'>tcg</span><span class='hs-layout'>)</span> <span class='hs-conid'>Nothing</span>
<a name="line-1402"></a>
<a name="line-1403"></a>
<a name="line-1404"></a><a name="runTHExp"></a><span class='hs-definition'>runTHExp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignHValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH.Exp</span>
<a name="line-1405"></a><span class='hs-definition'>runTHExp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTH</span> <span class='hs-conid'>THExp</span>
<a name="line-1406"></a>
<a name="line-1407"></a><a name="runTHPat"></a><span class='hs-definition'>runTHPat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignHValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH.Pat</span>
<a name="line-1408"></a><span class='hs-definition'>runTHPat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTH</span> <span class='hs-conid'>THPat</span>
<a name="line-1409"></a>
<a name="line-1410"></a><a name="runTHType"></a><span class='hs-definition'>runTHType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignHValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH.Type</span>
<a name="line-1411"></a><span class='hs-definition'>runTHType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTH</span> <span class='hs-conid'>THType</span>
<a name="line-1412"></a>
<a name="line-1413"></a><a name="runTHDec"></a><span class='hs-definition'>runTHDec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignHValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH.Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-1414"></a><span class='hs-definition'>runTHDec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTH</span> <span class='hs-conid'>THDec</span>
<a name="line-1415"></a>
<a name="line-1416"></a><a name="runTH"></a><span class='hs-definition'>runTH</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Binary</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>THResultType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ForeignHValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1417"></a><span class='hs-definition'>runTH</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>fhv</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1418"></a>  <span class='hs-varid'>interp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetInterp</span>
<a name="line-1419"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>interpInstance</span> <span class='hs-varid'>interp</span> <span class='hs-keyword'>of</span>
<a name="line-1420"></a><span class='hs-cpp'>#if defined(HAVE_INTERNAL_INTERPRETER)</span>
<a name="line-1421"></a>    <span class='hs-conid'>InternalInterp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1422"></a>       <span class='hs-comment'>-- Run it in the local TcM</span>
<a name="line-1423"></a>      <span class='hs-varid'>hv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>wormhole</span> <span class='hs-varid'>interp</span> <span class='hs-varid'>fhv</span>
<a name="line-1424"></a>      <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runQuasi</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsafeCoerce</span> <span class='hs-varid'>hv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH.Q</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1425"></a>      <span class='hs-varid'>return</span> <span class='hs-varid'>r</span>
<a name="line-1426"></a><span class='hs-cpp'>#endif</span>
<a name="line-1427"></a>
<a name="line-1428"></a>    <span class='hs-conid'>ExternalInterp</span> <span class='hs-varid'>conf</span> <span class='hs-varid'>iserv</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1429"></a>      <span class='hs-comment'>-- Run it on the server.  For an overview of how TH works with</span>
<a name="line-1430"></a>      <span class='hs-comment'>-- Remote GHCi, see Note [Remote Template Haskell] in</span>
<a name="line-1431"></a>      <span class='hs-comment'>-- libraries/ghci/GHCi/TH.hs.</span>
<a name="line-1432"></a>      <span class='hs-varid'>withIServ_</span> <span class='hs-varid'>conf</span> <span class='hs-varid'>iserv</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1433"></a>        <span class='hs-varid'>rstate</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTHState</span> <span class='hs-varid'>i</span>
<a name="line-1434"></a>        <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TH.qLocation</span>
<a name="line-1435"></a>        <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span>
<a name="line-1436"></a>          <span class='hs-varid'>withForeignRef</span> <span class='hs-varid'>rstate</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>state_hv</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1437"></a>          <span class='hs-varid'>withForeignRef</span> <span class='hs-varid'>fhv</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>q_hv</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1438"></a>            <span class='hs-varid'>writeIServ</span> <span class='hs-varid'>i</span> <span class='hs-layout'>(</span><span class='hs-varid'>putMessage</span> <span class='hs-layout'>(</span><span class='hs-conid'>RunTH</span> <span class='hs-varid'>state_hv</span> <span class='hs-varid'>q_hv</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1439"></a>        <span class='hs-varid'>runRemoteTH</span> <span class='hs-varid'>i</span> <span class='hs-conid'>[]</span>
<a name="line-1440"></a>        <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readQResult</span> <span class='hs-varid'>i</span>
<a name="line-1441"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>runGet</span> <span class='hs-varid'>get</span> <span class='hs-layout'>(</span><span class='hs-conid'>LB.fromStrict</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-1442"></a>
<a name="line-1443"></a>
<a name="line-1444"></a><a name="runRemoteTH"></a><span class='hs-comment'>-- | communicate with a remotely-running TH computation until it finishes.</span>
<a name="line-1445"></a><span class='hs-comment'>-- See Note [Remote Template Haskell] in libraries/ghci/GHCi/TH.hs.</span>
<a name="line-1446"></a><span class='hs-definition'>runRemoteTH</span>
<a name="line-1447"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IServInstance</span>
<a name="line-1448"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Messages</span> <span class='hs-conid'>DecoratedSDoc</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>--  saved from nested calls to qRecover</span>
<a name="line-1449"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-1450"></a><span class='hs-definition'>runRemoteTH</span> <span class='hs-varid'>iserv</span> <span class='hs-varid'>recovers</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1451"></a>  <span class='hs-conid'>THMsg</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>readIServ</span> <span class='hs-varid'>iserv</span> <span class='hs-varid'>getTHMessage</span>
<a name="line-1452"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>msg</span> <span class='hs-keyword'>of</span>
<a name="line-1453"></a>    <span class='hs-conid'>RunTHDone</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1454"></a>    <span class='hs-conid'>StartRecover</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-comment'>-- Note [TH recover with -fexternal-interpreter]</span>
<a name="line-1455"></a>      <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getErrsVar</span>
<a name="line-1456"></a>      <span class='hs-varid'>msgs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTcRef</span> <span class='hs-varid'>v</span>
<a name="line-1457"></a>      <span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>v</span> <span class='hs-varid'>emptyMessages</span>
<a name="line-1458"></a>      <span class='hs-varid'>runRemoteTH</span> <span class='hs-varid'>iserv</span> <span class='hs-layout'>(</span><span class='hs-varid'>msgs</span> <span class='hs-conop'>:</span> <span class='hs-varid'>recovers</span><span class='hs-layout'>)</span>
<a name="line-1459"></a>    <span class='hs-conid'>EndRecover</span> <span class='hs-varid'>caught_error</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1460"></a>      <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>prev_msgs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>recovers</span> <span class='hs-keyword'>of</span>
<a name="line-1461"></a>             <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"EndRecover"</span>
<a name="line-1462"></a>             <span class='hs-varid'>a</span> <span class='hs-conop'>:</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-1463"></a>      <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getErrsVar</span>
<a name="line-1464"></a>      <span class='hs-varid'>warn_msgs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getWarningMessages</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>readTcRef</span> <span class='hs-varid'>v</span>
<a name="line-1465"></a>      <span class='hs-comment'>-- keep the warnings only if there were no errors</span>
<a name="line-1466"></a>      <span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>v</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>caught_error</span>
<a name="line-1467"></a>        <span class='hs-keyword'>then</span> <span class='hs-varid'>prev_msgs</span>
<a name="line-1468"></a>        <span class='hs-keyword'>else</span> <span class='hs-varid'>mkMessages</span> <span class='hs-varid'>warn_msgs</span> <span class='hs-varop'>`unionMessages`</span> <span class='hs-varid'>prev_msgs</span>
<a name="line-1469"></a>      <span class='hs-varid'>runRemoteTH</span> <span class='hs-varid'>iserv</span> <span class='hs-varid'>rest</span>
<a name="line-1470"></a>    <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1471"></a>      <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>handleTHMessage</span> <span class='hs-varid'>msg</span>
<a name="line-1472"></a>      <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>writeIServ</span> <span class='hs-varid'>iserv</span> <span class='hs-layout'>(</span><span class='hs-varid'>put</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1473"></a>      <span class='hs-varid'>runRemoteTH</span> <span class='hs-varid'>iserv</span> <span class='hs-varid'>recovers</span>
<a name="line-1474"></a>
<a name="line-1475"></a><a name="readQResult"></a><span class='hs-comment'>-- | Read a value of type QResult from the iserv</span>
<a name="line-1476"></a><span class='hs-definition'>readQResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Binary</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>IServInstance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1477"></a><span class='hs-definition'>readQResult</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1478"></a>  <span class='hs-varid'>qr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>readIServ</span> <span class='hs-varid'>i</span> <span class='hs-varid'>get</span>
<a name="line-1479"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>qr</span> <span class='hs-keyword'>of</span>
<a name="line-1480"></a>    <span class='hs-conid'>QDone</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>a</span>
<a name="line-1481"></a>    <span class='hs-conid'>QException</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ErrorCall</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span>
<a name="line-1482"></a>    <span class='hs-conid'>QFail</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail</span> <span class='hs-varid'>str</span>
<a name="line-1483"></a>
<a name="line-1484"></a><span class='hs-comment'>{- Note [TH recover with -fexternal-interpreter]
<a name="line-1485"></a>
<a name="line-1486"></a>Recover is slightly tricky to implement.
<a name="line-1487"></a>
<a name="line-1488"></a>The meaning of "recover a b" is
<a name="line-1489"></a> - Do a
<a name="line-1490"></a>   - If it finished with no errors, then keep the warnings it generated
<a name="line-1491"></a>   - If it failed, discard any messages it generated, and do b
<a name="line-1492"></a>
<a name="line-1493"></a>Note that "failed" here can mean either
<a name="line-1494"></a>  (1) threw an exception (failTc)
<a name="line-1495"></a>  (2) generated an error message (addErrTcM)
<a name="line-1496"></a>
<a name="line-1497"></a>The messages are managed by GHC in the TcM monad, whereas the
<a name="line-1498"></a>exception-handling is done in the ghc-iserv process, so we have to
<a name="line-1499"></a>coordinate between the two.
<a name="line-1500"></a>
<a name="line-1501"></a>On the server:
<a name="line-1502"></a>  - emit a StartRecover message
<a name="line-1503"></a>  - run "a; FailIfErrs" inside a try
<a name="line-1504"></a>  - emit an (EndRecover x) message, where x = True if "a; FailIfErrs" failed
<a name="line-1505"></a>  - if "a; FailIfErrs" failed, run "b"
<a name="line-1506"></a>
<a name="line-1507"></a>Back in GHC, when we receive:
<a name="line-1508"></a>
<a name="line-1509"></a>  FailIfErrrs
<a name="line-1510"></a>    failTc if there are any error messages (= failIfErrsM)
<a name="line-1511"></a>  StartRecover
<a name="line-1512"></a>    save the current messages and start with an empty set.
<a name="line-1513"></a>  EndRecover caught_error
<a name="line-1514"></a>    Restore the previous messages,
<a name="line-1515"></a>    and merge in the new messages if caught_error is false.
<a name="line-1516"></a>-}</span>
<a name="line-1517"></a>
<a name="line-1518"></a><a name="getTHState"></a><span class='hs-comment'>-- | Retrieve (or create, if it hasn't been created already), the</span>
<a name="line-1519"></a><span class='hs-comment'>-- remote TH state.  The TH state is a remote reference to an IORef</span>
<a name="line-1520"></a><span class='hs-comment'>-- QState living on the server, and we have to pass this to each RunTH</span>
<a name="line-1521"></a><span class='hs-comment'>-- call we make.</span>
<a name="line-1522"></a><span class='hs-comment'>--</span>
<a name="line-1523"></a><span class='hs-comment'>-- The TH state is stored in tcg_th_remote_state in the TcGblEnv.</span>
<a name="line-1524"></a><span class='hs-comment'>--</span>
<a name="line-1525"></a><span class='hs-definition'>getTHState</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IServInstance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>QState</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1526"></a><span class='hs-definition'>getTHState</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1527"></a>  <span class='hs-varid'>tcg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-1528"></a>  <span class='hs-varid'>th_state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_th_remote_state</span> <span class='hs-varid'>tcg</span><span class='hs-layout'>)</span>
<a name="line-1529"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>th_state</span> <span class='hs-keyword'>of</span>
<a name="line-1530"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>rhv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>rhv</span>
<a name="line-1531"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1532"></a>      <span class='hs-varid'>interp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetInterp</span>
<a name="line-1533"></a>      <span class='hs-varid'>fhv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkFinalizedHValue</span> <span class='hs-varid'>interp</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>iservCall</span> <span class='hs-varid'>i</span> <span class='hs-conid'>StartTH</span>
<a name="line-1534"></a>      <span class='hs-varid'>writeTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_th_remote_state</span> <span class='hs-varid'>tcg</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>fhv</span><span class='hs-layout'>)</span>
<a name="line-1535"></a>      <span class='hs-varid'>return</span> <span class='hs-varid'>fhv</span>
<a name="line-1536"></a>
<a name="line-1537"></a><a name="wrapTHResult"></a><span class='hs-definition'>wrapTHResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>THResult</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1538"></a><span class='hs-definition'>wrapTHResult</span> <span class='hs-varid'>tcm</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1539"></a>  <span class='hs-varid'>e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tryM</span> <span class='hs-varid'>tcm</span>   <span class='hs-comment'>-- only catch 'fail', treat everything else as catastrophic</span>
<a name="line-1540"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>of</span>
<a name="line-1541"></a>    <span class='hs-conid'>Left</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>THException</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1542"></a>    <span class='hs-conid'>Right</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>THComplete</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1543"></a>
<a name="line-1544"></a><a name="handleTHMessage"></a><span class='hs-definition'>handleTHMessage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>THMessage</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1545"></a><span class='hs-definition'>handleTHMessage</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>msg</span> <span class='hs-keyword'>of</span>
<a name="line-1546"></a>  <span class='hs-conid'>NewName</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.qNewName</span> <span class='hs-varid'>a</span>
<a name="line-1547"></a>  <span class='hs-conid'>Report</span> <span class='hs-varid'>b</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.qReport</span> <span class='hs-varid'>b</span> <span class='hs-varid'>str</span>
<a name="line-1548"></a>  <span class='hs-conid'>LookupName</span> <span class='hs-varid'>b</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.qLookupName</span> <span class='hs-varid'>b</span> <span class='hs-varid'>str</span>
<a name="line-1549"></a>  <span class='hs-conid'>Reify</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.qReify</span> <span class='hs-varid'>n</span>
<a name="line-1550"></a>  <span class='hs-conid'>ReifyFixity</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.qReifyFixity</span> <span class='hs-varid'>n</span>
<a name="line-1551"></a>  <span class='hs-conid'>ReifyType</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.qReifyType</span> <span class='hs-varid'>n</span>
<a name="line-1552"></a>  <span class='hs-conid'>ReifyInstances</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.qReifyInstances</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ts</span>
<a name="line-1553"></a>  <span class='hs-conid'>ReifyRoles</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.qReifyRoles</span> <span class='hs-varid'>n</span>
<a name="line-1554"></a>  <span class='hs-conid'>ReifyAnnotations</span> <span class='hs-varid'>lookup</span> <span class='hs-varid'>tyrep</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1555"></a>    <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>B.pack</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getAnnotationsByTypeRep</span> <span class='hs-varid'>lookup</span> <span class='hs-varid'>tyrep</span><span class='hs-layout'>)</span>
<a name="line-1556"></a>  <span class='hs-conid'>ReifyModule</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.qReifyModule</span> <span class='hs-varid'>m</span>
<a name="line-1557"></a>  <span class='hs-conid'>ReifyConStrictness</span> <span class='hs-varid'>nm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.qReifyConStrictness</span> <span class='hs-varid'>nm</span>
<a name="line-1558"></a>  <span class='hs-conid'>AddDependentFile</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.qAddDependentFile</span> <span class='hs-varid'>f</span>
<a name="line-1559"></a>  <span class='hs-conid'>AddTempFile</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.qAddTempFile</span> <span class='hs-varid'>s</span>
<a name="line-1560"></a>  <span class='hs-conid'>AddModFinalizer</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1561"></a>    <span class='hs-varid'>interp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hscInterp</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getTopEnv</span>
<a name="line-1562"></a>    <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liftIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFinalizedHValue</span> <span class='hs-varid'>interp</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>addModFinalizerRef</span>
<a name="line-1563"></a>  <span class='hs-conid'>AddCorePlugin</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.qAddCorePlugin</span> <span class='hs-varid'>str</span>
<a name="line-1564"></a>  <span class='hs-conid'>AddTopDecls</span> <span class='hs-varid'>decs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.qAddTopDecls</span> <span class='hs-varid'>decs</span>
<a name="line-1565"></a>  <span class='hs-conid'>AddForeignFilePath</span> <span class='hs-varid'>lang</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.qAddForeignFilePath</span> <span class='hs-varid'>lang</span> <span class='hs-varid'>str</span>
<a name="line-1566"></a>  <span class='hs-conid'>IsExtEnabled</span> <span class='hs-varid'>ext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.qIsExtEnabled</span> <span class='hs-varid'>ext</span>
<a name="line-1567"></a>  <span class='hs-conid'>ExtsEnabled</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.qExtsEnabled</span>
<a name="line-1568"></a>  <span class='hs-conid'>PutDoc</span> <span class='hs-varid'>l</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.qPutDoc</span> <span class='hs-varid'>l</span> <span class='hs-varid'>s</span>
<a name="line-1569"></a>  <span class='hs-conid'>GetDoc</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.qGetDoc</span> <span class='hs-varid'>l</span>
<a name="line-1570"></a>  <span class='hs-conid'>FailIfErrs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varid'>failIfErrsM</span>
<a name="line-1571"></a>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"handleTHMessage: unexpected message "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-1572"></a>
<a name="line-1573"></a><a name="getAnnotationsByTypeRep"></a><span class='hs-definition'>getAnnotationsByTypeRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH.AnnLookup</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Word8</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-1574"></a><span class='hs-definition'>getAnnotationsByTypeRep</span> <span class='hs-varid'>th_name</span> <span class='hs-varid'>tyrep</span>
<a name="line-1575"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupThAnnLookup</span> <span class='hs-varid'>th_name</span>
<a name="line-1576"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>topEnv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTopEnv</span>
<a name="line-1577"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>epsHptAnns</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>prepareAnnotations</span> <span class='hs-varid'>topEnv</span> <span class='hs-conid'>Nothing</span>
<a name="line-1578"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-1579"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>selectedEpsHptAnns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findAnnsByTypeRep</span> <span class='hs-varid'>epsHptAnns</span> <span class='hs-varid'>name</span> <span class='hs-varid'>tyrep</span>
<a name="line-1580"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>selectedTcgAnns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findAnnsByTypeRep</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_ann_env</span> <span class='hs-varid'>tcg</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-varid'>tyrep</span>
<a name="line-1581"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>selectedEpsHptAnns</span> <span class='hs-varop'>++</span> <span class='hs-varid'>selectedTcgAnns</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1582"></a>
<a name="line-1583"></a><span class='hs-comment'>{-
<a name="line-1584"></a>************************************************************************
<a name="line-1585"></a>*                                                                      *
<a name="line-1586"></a>            Instance Testing
<a name="line-1587"></a>*                                                                      *
<a name="line-1588"></a>************************************************************************
<a name="line-1589"></a>-}</span>
<a name="line-1590"></a>
<a name="line-1591"></a><a name="reifyInstances"></a><span class='hs-definition'>reifyInstances</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH.Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH.Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH.Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-1592"></a><span class='hs-definition'>reifyInstances</span> <span class='hs-varid'>th_nm</span> <span class='hs-varid'>th_tys</span>
<a name="line-1593"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>insts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyInstances'</span> <span class='hs-varid'>th_nm</span> <span class='hs-varid'>th_tys</span>
<a name="line-1594"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>insts</span> <span class='hs-keyword'>of</span>
<a name="line-1595"></a>           <span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>cls_insts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1596"></a>             <span class='hs-varid'>reifyClassInstances</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_insts</span>
<a name="line-1597"></a>           <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>fam_insts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1598"></a>             <span class='hs-varid'>reifyFamilyInstances</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>fam_insts</span> <span class='hs-layout'>}</span>
<a name="line-1599"></a>
<a name="line-1600"></a><a name="reifyInstances'"></a><span class='hs-definition'>reifyInstances'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH.Name</span>
<a name="line-1601"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH.Type</span><span class='hs-keyglyph'>]</span>
<a name="line-1602"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-layout'>(</span><span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1603"></a>                <span class='hs-comment'>-- ^ Returns 'Left' in the case that the instances were found to</span>
<a name="line-1604"></a>                <span class='hs-comment'>-- be class instances, or 'Right' if they are family instances.</span>
<a name="line-1605"></a><span class='hs-definition'>reifyInstances'</span> <span class='hs-varid'>th_nm</span> <span class='hs-varid'>th_tys</span>
<a name="line-1606"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"In the argument of reifyInstances:"</span>
<a name="line-1607"></a>                 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_th</span> <span class='hs-varid'>th_nm</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr_th</span> <span class='hs-varid'>th_tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1608"></a>     <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-1609"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>th_origin</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getThSpliceOrigin</span>
<a name="line-1610"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rdr_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvt</span> <span class='hs-varid'>th_origin</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkThAppTs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.ConT</span> <span class='hs-varid'>th_nm</span><span class='hs-layout'>)</span> <span class='hs-varid'>th_tys</span><span class='hs-layout'>)</span>
<a name="line-1611"></a>          <span class='hs-comment'>-- #9262 says to bring vars into scope, like in HsForAllTy case</span>
<a name="line-1612"></a>          <span class='hs-comment'>-- of rnHsTyKi</span>
<a name="line-1613"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tv_rdrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extractHsTyRdrTyVars</span> <span class='hs-varid'>rdr_ty</span>
<a name="line-1614"></a>          <span class='hs-comment'>-- Rename  to HsType Name</span>
<a name="line-1615"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>tv_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>rn_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-sel'>_fvs</span><span class='hs-layout'>)</span>
<a name="line-1616"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span> <span class='hs-comment'>-- If there are out-of-scope Names here, then we</span>
<a name="line-1617"></a>                             <span class='hs-comment'>-- must error before proceeding to typecheck the</span>
<a name="line-1618"></a>                             <span class='hs-comment'>-- renamed type, as that will result in GHC</span>
<a name="line-1619"></a>                             <span class='hs-comment'>-- internal errors (#13837).</span>
<a name="line-1620"></a>               <span class='hs-varid'>rnImplicitTvOccs</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>tv_rdrs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tv_names</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1621"></a>               <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>rn_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>rdr_ty</span>
<a name="line-1622"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>tv_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>rn_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1623"></a>
<a name="line-1624"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tclvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1625"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pushLevelAndSolveEqualitiesX</span> <span class='hs-str'>"reifyInstances"</span>  <span class='hs-varop'>$</span>
<a name="line-1626"></a>               <span class='hs-varid'>bindImplicitTKBndrs_Skol</span> <span class='hs-varid'>tv_names</span>              <span class='hs-varop'>$</span>
<a name="line-1627"></a>               <span class='hs-varid'>tcInferLHsType</span> <span class='hs-varid'>rn_ty</span>
<a name="line-1628"></a>
<a name="line-1629"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkAndScopedSort</span> <span class='hs-varid'>tvs</span>
<a name="line-1630"></a>
<a name="line-1631"></a>        <span class='hs-comment'>-- Avoid error cascade if there are unsolved</span>
<a name="line-1632"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>reportUnsolvedEqualities</span> <span class='hs-conid'>ReifySkol</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>wanted</span>
<a name="line-1633"></a>
<a name="line-1634"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>ty</span>
<a name="line-1635"></a>                <span class='hs-comment'>-- Substitute out the meta type variables</span>
<a name="line-1636"></a>                <span class='hs-comment'>-- In particular, the type might have kind</span>
<a name="line-1637"></a>                <span class='hs-comment'>-- variables inside it (#7477)</span>
<a name="line-1638"></a>
<a name="line-1639"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reifyInstances'"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcTypeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1640"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>   <span class='hs-comment'>-- This expands any type synonyms</span>
<a name="line-1641"></a>            <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>                 <span class='hs-comment'>-- See #7910</span>
<a name="line-1642"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConClass_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-1643"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inst_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetInstEnvs</span>
<a name="line-1644"></a>                     <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifies</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupInstEnv</span> <span class='hs-conid'>False</span> <span class='hs-varid'>inst_envs</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-1645"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reifyInstances'1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-1646"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>matches</span> <span class='hs-varop'>++</span> <span class='hs-varid'>unifies</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1647"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isOpenFamilyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-1648"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inst_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetFamInstEnvs</span>
<a name="line-1649"></a>                     <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupFamInstEnv</span> <span class='hs-varid'>inst_envs</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-1650"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reifyInstances'2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-1651"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fim_instance</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1652"></a>            <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bale_out</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"reifyInstances:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1653"></a>                               <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"is not a class constraint or type family application"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1654"></a>  <span class='hs-keyword'>where</span>
<a name="line-1655"></a>    <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ClassInstanceCtx</span>
<a name="line-1656"></a>    <span class='hs-varid'>bale_out</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>msg</span>
<a name="line-1657"></a>
<a name="line-1658"></a>    <span class='hs-varid'>cvt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Origin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH.Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-1659"></a>    <span class='hs-varid'>cvt</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>th_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>convertToHsType</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>th_ty</span> <span class='hs-keyword'>of</span>
<a name="line-1660"></a>      <span class='hs-conid'>Left</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>msg</span>
<a name="line-1661"></a>      <span class='hs-conid'>Right</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>
<a name="line-1662"></a>
<a name="line-1663"></a><span class='hs-comment'>{-
<a name="line-1664"></a>************************************************************************
<a name="line-1665"></a>*                                                                      *
<a name="line-1666"></a>                        Reification
<a name="line-1667"></a>*                                                                      *
<a name="line-1668"></a>************************************************************************
<a name="line-1669"></a>-}</span>
<a name="line-1670"></a>
<a name="line-1671"></a><a name="lookupName"></a><span class='hs-definition'>lookupName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>      <span class='hs-comment'>-- True  &lt;=&gt; type namespace</span>
<a name="line-1672"></a>                        <span class='hs-comment'>-- False &lt;=&gt; value namespace</span>
<a name="line-1673"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>TH.Name</span><span class='hs-layout'>)</span>
<a name="line-1674"></a><span class='hs-definition'>lookupName</span> <span class='hs-varid'>is_type_name</span> <span class='hs-varid'>s</span>
<a name="line-1675"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_nm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupOccRn_maybe</span> <span class='hs-varid'>rdr_name</span>
<a name="line-1676"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>mb_nm</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1677"></a>  <span class='hs-keyword'>where</span>
<a name="line-1678"></a>    <span class='hs-varid'>th_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.mkName</span> <span class='hs-varid'>s</span>       <span class='hs-comment'>-- Parses M.x into a base of 'x' and a module of 'M'</span>
<a name="line-1679"></a>
<a name="line-1680"></a>    <span class='hs-varid'>occ_fs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span>
<a name="line-1681"></a>    <span class='hs-varid'>occ_fs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFastString</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.nameBase</span> <span class='hs-varid'>th_name</span><span class='hs-layout'>)</span>
<a name="line-1682"></a>
<a name="line-1683"></a>    <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccName</span>
<a name="line-1684"></a>    <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_type_name</span>
<a name="line-1685"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isLexVarSym</span> <span class='hs-varid'>occ_fs</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isLexCon</span> <span class='hs-varid'>occ_fs</span>
<a name="line-1686"></a>                             <span class='hs-keyword'>then</span> <span class='hs-varid'>mkTcOccFS</span>    <span class='hs-varid'>occ_fs</span>
<a name="line-1687"></a>                             <span class='hs-keyword'>else</span> <span class='hs-varid'>mkTyVarOccFS</span> <span class='hs-varid'>occ_fs</span>
<a name="line-1688"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1689"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isLexCon</span> <span class='hs-varid'>occ_fs</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>mkDataOccFS</span> <span class='hs-varid'>occ_fs</span>
<a name="line-1690"></a>                             <span class='hs-keyword'>else</span> <span class='hs-varid'>mkVarOccFS</span>  <span class='hs-varid'>occ_fs</span>
<a name="line-1691"></a>
<a name="line-1692"></a>    <span class='hs-varid'>rdr_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>TH.nameModule</span> <span class='hs-varid'>th_name</span> <span class='hs-keyword'>of</span>
<a name="line-1693"></a>                 <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRdrUnqual</span> <span class='hs-varid'>occ</span>
<a name="line-1694"></a>                 <span class='hs-conid'>Just</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRdrQual</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkModuleName</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>occ</span>
<a name="line-1695"></a>
<a name="line-1696"></a><a name="getThing"></a><span class='hs-definition'>getThing</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH.Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyThing</span>
<a name="line-1697"></a><span class='hs-definition'>getThing</span> <span class='hs-varid'>th_name</span>
<a name="line-1698"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupThName</span> <span class='hs-varid'>th_name</span>
<a name="line-1699"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceIf</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"reify"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>th_name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_ns</span> <span class='hs-varid'>th_name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-1700"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>tcLookupTh</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span>
<a name="line-1701"></a>        <span class='hs-comment'>-- ToDo: this tcLookup could fail, which would give a</span>
<a name="line-1702"></a>        <span class='hs-comment'>--       rather unhelpful error message</span>
<a name="line-1703"></a>  <span class='hs-keyword'>where</span>
<a name="line-1704"></a>    <span class='hs-varid'>ppr_ns</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.Name</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.NameG</span> <span class='hs-conid'>TH.DataName</span>  <span class='hs-sel'>_pkg</span> <span class='hs-sel'>_mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"data"</span>
<a name="line-1705"></a>    <span class='hs-varid'>ppr_ns</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.Name</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.NameG</span> <span class='hs-conid'>TH.TcClsName</span> <span class='hs-sel'>_pkg</span> <span class='hs-sel'>_mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tc"</span>
<a name="line-1706"></a>    <span class='hs-varid'>ppr_ns</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.Name</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.NameG</span> <span class='hs-conid'>TH.VarName</span>   <span class='hs-sel'>_pkg</span> <span class='hs-sel'>_mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"var"</span>
<a name="line-1707"></a>    <span class='hs-varid'>ppr_ns</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"reify/ppr_ns"</span>
<a name="line-1708"></a>
<a name="line-1709"></a><a name="reify"></a><span class='hs-definition'>reify</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH.Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH.Info</span>
<a name="line-1710"></a><span class='hs-definition'>reify</span> <span class='hs-varid'>th_name</span>
<a name="line-1711"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reify 1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.showName</span> <span class='hs-varid'>th_name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1712"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getThing</span> <span class='hs-varid'>th_name</span>
<a name="line-1713"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reify 2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-1714"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>reifyThing</span> <span class='hs-varid'>thing</span> <span class='hs-layout'>}</span>
<a name="line-1715"></a>
<a name="line-1716"></a><a name="lookupThName"></a><span class='hs-definition'>lookupThName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH.Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Name</span>
<a name="line-1717"></a><span class='hs-definition'>lookupThName</span> <span class='hs-varid'>th_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1718"></a>    <span class='hs-varid'>mb_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupThName_maybe</span> <span class='hs-varid'>th_name</span>
<a name="line-1719"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_name</span> <span class='hs-keyword'>of</span>
<a name="line-1720"></a>        <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>notInScope</span> <span class='hs-varid'>th_name</span><span class='hs-layout'>)</span>
<a name="line-1721"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>name</span>
<a name="line-1722"></a>
<a name="line-1723"></a><a name="lookupThName_maybe"></a><span class='hs-definition'>lookupThName_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH.Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-1724"></a><span class='hs-definition'>lookupThName_maybe</span> <span class='hs-varid'>th_name</span>
<a name="line-1725"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapMaybeM</span> <span class='hs-varid'>lookupOccRn_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>thRdrNameGuesses</span> <span class='hs-varid'>th_name</span><span class='hs-layout'>)</span>
<a name="line-1726"></a>          <span class='hs-comment'>-- Pick the first that works</span>
<a name="line-1727"></a>          <span class='hs-comment'>-- E.g. reify (mkName "A") will pick the class A in preference to the data constructor A</span>
<a name="line-1728"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>listToMaybe</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1729"></a>
<a name="line-1730"></a><a name="tcLookupTh"></a><span class='hs-definition'>tcLookupTh</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyThing</span>
<a name="line-1731"></a><span class='hs-comment'>-- This is a specialised version of GHC.Tc.Utils.Env.tcLookup; specialised mainly in that</span>
<a name="line-1732"></a><span class='hs-comment'>-- it gives a reify-related error message on failure, whereas in the normal</span>
<a name="line-1733"></a><span class='hs-comment'>-- tcLookup, failure is a bug.</span>
<a name="line-1734"></a><span class='hs-definition'>tcLookupTh</span> <span class='hs-varid'>name</span>
<a name="line-1735"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>gbl_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>lcl_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEnvs</span>
<a name="line-1736"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcl_env</span> <span class='hs-varid'>lcl_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-1737"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>thing</span><span class='hs-layout'>;</span>
<a name="line-1738"></a>                <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1739"></a>
<a name="line-1740"></a>          <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_type_env</span> <span class='hs-varid'>gbl_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-1741"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span>
<a name="line-1742"></a>                <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1743"></a>
<a name="line-1744"></a>          <span class='hs-comment'>-- EZY: I don't think this choice matters, no TH in signatures!</span>
<a name="line-1745"></a>          <span class='hs-keyword'>if</span> <span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_semantic_mod</span> <span class='hs-varid'>gbl_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span>
<a name="line-1746"></a>          <span class='hs-keyword'>then</span>  <span class='hs-comment'>-- It's defined in this module</span>
<a name="line-1747"></a>                <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>notInEnv</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-1748"></a>
<a name="line-1749"></a>          <span class='hs-keyword'>else</span>
<a name="line-1750"></a>     <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupImported_maybe</span> <span class='hs-varid'>name</span>
<a name="line-1751"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_thing</span> <span class='hs-keyword'>of</span>
<a name="line-1752"></a>            <span class='hs-conid'>Succeeded</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-1753"></a>            <span class='hs-conid'>Failed</span> <span class='hs-varid'>msg</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>msg</span>
<a name="line-1754"></a>    <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-1755"></a>
<a name="line-1756"></a><a name="notInScope"></a><span class='hs-definition'>notInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH.Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1757"></a><span class='hs-definition'>notInScope</span> <span class='hs-varid'>th_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.pprint</span> <span class='hs-varid'>th_name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-1758"></a>                     <span class='hs-varid'>text</span> <span class='hs-str'>"is not in scope at a reify"</span>
<a name="line-1759"></a>        <span class='hs-comment'>-- Ugh! Rather an indirect way to display the name</span>
<a name="line-1760"></a>
<a name="line-1761"></a><a name="notInEnv"></a><span class='hs-definition'>notInEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1762"></a><span class='hs-definition'>notInEnv</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-1763"></a>                     <span class='hs-varid'>text</span> <span class='hs-str'>"is not in the type environment at a reify"</span>
<a name="line-1764"></a>
<a name="line-1765"></a><a name="reifyRoles"></a><span class='hs-comment'>------------------------------</span>
<a name="line-1766"></a><span class='hs-definition'>reifyRoles</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH.Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH.Role</span><span class='hs-keyglyph'>]</span>
<a name="line-1767"></a><span class='hs-definition'>reifyRoles</span> <span class='hs-varid'>th_name</span>
<a name="line-1768"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getThing</span> <span class='hs-varid'>th_name</span>
<a name="line-1769"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-1770"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>reify_role</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRoles</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1771"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"No roles associated with"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1772"></a>       <span class='hs-layout'>}</span>
<a name="line-1773"></a>  <span class='hs-keyword'>where</span>
<a name="line-1774"></a>    <span class='hs-varid'>reify_role</span> <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.NominalR</span>
<a name="line-1775"></a>    <span class='hs-varid'>reify_role</span> <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.RepresentationalR</span>
<a name="line-1776"></a>    <span class='hs-varid'>reify_role</span> <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.PhantomR</span>
<a name="line-1777"></a>
<a name="line-1778"></a><a name="reifyThing"></a><span class='hs-comment'>------------------------------</span>
<a name="line-1779"></a><span class='hs-definition'>reifyThing</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH.Info</span>
<a name="line-1780"></a><span class='hs-comment'>-- The only reason this is monadic is for error reporting,</span>
<a name="line-1781"></a><span class='hs-comment'>-- which in turn is mainly for the case when TH can't express</span>
<a name="line-1782"></a><span class='hs-comment'>-- some random GHC extension</span>
<a name="line-1783"></a>
<a name="line-1784"></a><span class='hs-definition'>reifyThing</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnId</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1785"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-1786"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>id</span>
<a name="line-1787"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-1788"></a>            <span class='hs-conid'>ClassOpId</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.ClassOpI</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1789"></a>            <span class='hs-conid'>RecSelId</span><span class='hs-layout'>{</span><span class='hs-varid'>sel_tycon</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>RecSelData</span> <span class='hs-varid'>tc</span><span class='hs-layout'>}</span>
<a name="line-1790"></a>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.VarI</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifySelector</span> <span class='hs-varid'>id</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-1791"></a>            <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.VarI</span>     <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-1792"></a>    <span class='hs-layout'>}</span>
<a name="line-1793"></a>
<a name="line-1794"></a><span class='hs-definition'>reifyThing</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-1795"></a><span class='hs-definition'>reifyThing</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1796"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConName</span> <span class='hs-varid'>dc</span>
<a name="line-1797"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConWrapId</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1798"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.DataConI</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1799"></a>                              <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConOrigTyCon</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1800"></a>        <span class='hs-layout'>}</span>
<a name="line-1801"></a>
<a name="line-1802"></a><span class='hs-definition'>reifyThing</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynCon</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1803"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>ps</span>
<a name="line-1804"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyPatSynType</span> <span class='hs-layout'>(</span><span class='hs-varid'>patSynSigBndr</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-1805"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.PatSynI</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1806"></a>
<a name="line-1807"></a><span class='hs-definition'>reifyThing</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATcId</span> <span class='hs-layout'>{</span><span class='hs-varid'>tct_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1808"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Make use of all the info we have, even</span>
<a name="line-1809"></a>                                        <span class='hs-comment'>-- though it may be incomplete</span>
<a name="line-1810"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>ty1</span>
<a name="line-1811"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.VarI</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1812"></a>
<a name="line-1813"></a><span class='hs-definition'>reifyThing</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span>
<a name="line-1814"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTyVar</span> <span class='hs-varid'>tv1</span>
<a name="line-1815"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>ty1</span>
<a name="line-1816"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.TyVarI</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1817"></a>
<a name="line-1818"></a><span class='hs-definition'>reifyThing</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"reifyThing"</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprTcTyThingCategory</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-1819"></a>
<a name="line-1820"></a><a name="reifyAxBranch"></a><span class='hs-comment'>-------------------------------------------</span>
<a name="line-1821"></a><span class='hs-definition'>reifyAxBranch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH.TySynEqn</span>
<a name="line-1822"></a><span class='hs-definition'>reifyAxBranch</span> <span class='hs-varid'>fam_tc</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span>
<a name="line-1823"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span>
<a name="line-1824"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1825"></a>            <span class='hs-comment'>-- remove kind patterns (#8884)</span>
<a name="line-1826"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVarsToMaybe</span> <span class='hs-varid'>tvs</span>
<a name="line-1827"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>lhs_types_only</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOutInvisibleTypes</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>lhs</span>
<a name="line-1828"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lhs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-varid'>lhs_types_only</span>
<a name="line-1829"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>annot_th_lhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWith3M</span> <span class='hs-varid'>annotThType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArgsPolyKinded</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span>
<a name="line-1830"></a>                                   <span class='hs-varid'>lhs_types_only</span> <span class='hs-varid'>lhs'</span>
<a name="line-1831"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>lhs_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkThAppTs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.ConT</span> <span class='hs-varop'>$</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>annot_th_lhs</span>
<a name="line-1832"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rhs'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>rhs</span>
<a name="line-1833"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.TySynEqn</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>lhs_type</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1834"></a>
<a name="line-1835"></a><a name="reifyTyCon"></a><span class='hs-definition'>reifyTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH.Info</span>
<a name="line-1836"></a><span class='hs-definition'>reifyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-1837"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConClass_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-1838"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyClass</span> <span class='hs-varid'>cls</span>
<a name="line-1839"></a>
<a name="line-1840"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFunTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-1841"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.PrimTyConI</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span>                <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-1842"></a>
<a name="line-1843"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPrimTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-1844"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.PrimTyConI</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConVisibleTyVars</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1845"></a>                          <span class='hs-layout'>(</span><span class='hs-varid'>isUnliftedTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1846"></a>
<a name="line-1847"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTypeFamilyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-1848"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tvs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tc</span>
<a name="line-1849"></a>             <span class='hs-varid'>res_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConResKind</span> <span class='hs-varid'>tc</span>
<a name="line-1850"></a>             <span class='hs-varid'>resVar</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>famTcResVar</span> <span class='hs-varid'>tc</span>
<a name="line-1851"></a>
<a name="line-1852"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kind'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyKind</span> <span class='hs-varid'>res_kind</span>
<a name="line-1853"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>resultSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>injectivity</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1854"></a>                 <span class='hs-keyword'>case</span> <span class='hs-varid'>resVar</span> <span class='hs-keyword'>of</span>
<a name="line-1855"></a>                   <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.KindSig</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-1856"></a>                   <span class='hs-conid'>Just</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1857"></a>                     <span class='hs-keyword'>let</span> <span class='hs-varid'>thName</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>name</span>
<a name="line-1858"></a>                         <span class='hs-varid'>injAnnot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConInjectivityInfo</span> <span class='hs-varid'>tc</span>
<a name="line-1859"></a>                         <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.TyVarSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.KindedTV</span> <span class='hs-varid'>thName</span> <span class='hs-conid'>()</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>)</span>
<a name="line-1860"></a>                         <span class='hs-varid'>inj</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>injAnnot</span> <span class='hs-keyword'>of</span>
<a name="line-1861"></a>                                 <span class='hs-conid'>NotInjective</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1862"></a>                                 <span class='hs-conid'>Injective</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1863"></a>                                     <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.InjectivityAnn</span> <span class='hs-varid'>thName</span> <span class='hs-varid'>injRHS</span><span class='hs-layout'>)</span>
<a name="line-1864"></a>                                   <span class='hs-keyword'>where</span>
<a name="line-1865"></a>                                     <span class='hs-varid'>injRHS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyVarName</span><span class='hs-layout'>)</span>
<a name="line-1866"></a>                                                  <span class='hs-layout'>(</span><span class='hs-varid'>filterByList</span> <span class='hs-varid'>ms</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-1867"></a>                     <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig</span><span class='hs-layout'>,</span> <span class='hs-varid'>inj</span><span class='hs-layout'>)</span>
<a name="line-1868"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConVisibleTyVars</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1869"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tfHead</span> <span class='hs-keyglyph'>=</span>
<a name="line-1870"></a>               <span class='hs-conid'>TH.TypeFamilyHead</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>resultSig</span> <span class='hs-varid'>injectivity</span>
<a name="line-1871"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isOpenTypeFamilyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-1872"></a>         <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fam_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetFamInstEnvs</span>
<a name="line-1873"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>instances</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyFamilyInstances</span> <span class='hs-varid'>tc</span>
<a name="line-1874"></a>                                  <span class='hs-layout'>(</span><span class='hs-varid'>familyInstances</span> <span class='hs-varid'>fam_envs</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1875"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.FamilyI</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.OpenTypeFamilyD</span> <span class='hs-varid'>tfHead</span><span class='hs-layout'>)</span> <span class='hs-varid'>instances</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1876"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eqns</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-1877"></a>                     <span class='hs-keyword'>case</span> <span class='hs-varid'>isClosedSynFamilyTyConWithAxiom_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>of</span>
<a name="line-1878"></a>                       <span class='hs-conid'>Just</span> <span class='hs-varid'>ax</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyAxBranch</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1879"></a>                                  <span class='hs-varid'>fromBranches</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coAxiomBranches</span> <span class='hs-varid'>ax</span>
<a name="line-1880"></a>                       <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-1881"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.FamilyI</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.ClosedTypeFamilyD</span> <span class='hs-varid'>tfHead</span> <span class='hs-varid'>eqns</span><span class='hs-layout'>)</span>
<a name="line-1882"></a>                      <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1883"></a>
<a name="line-1884"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDataFamilyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-1885"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>res_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConResKind</span> <span class='hs-varid'>tc</span>
<a name="line-1886"></a>
<a name="line-1887"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kind'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyKind</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span>
<a name="line-1888"></a>
<a name="line-1889"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConVisibleTyVars</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1890"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fam_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetFamInstEnvs</span>
<a name="line-1891"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>instances</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyFamilyInstances</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>familyInstances</span> <span class='hs-varid'>fam_envs</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1892"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.FamilyI</span>
<a name="line-1893"></a>                       <span class='hs-layout'>(</span><span class='hs-conid'>TH.DataFamilyD</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>)</span> <span class='hs-varid'>instances</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1894"></a>
<a name="line-1895"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>synTyConDefn_maybe</span> <span class='hs-varid'>tc</span>  <span class='hs-comment'>-- Vanilla type synonym</span>
<a name="line-1896"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>rhs</span>
<a name="line-1897"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConVisibleTyVars</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1898"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.TyConI</span>
<a name="line-1899"></a>                   <span class='hs-layout'>(</span><span class='hs-conid'>TH.TySynD</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1900"></a>       <span class='hs-layout'>}</span>
<a name="line-1901"></a>
<a name="line-1902"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1903"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>cxt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyCxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConStupidTheta</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1904"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tvs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tc</span>
<a name="line-1905"></a>              <span class='hs-varid'>dataCons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>tc</span>
<a name="line-1906"></a>              <span class='hs-varid'>isGadt</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isGadtSyntaxTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-1907"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>cons</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyDataCon</span> <span class='hs-varid'>isGadt</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>dataCons</span>
<a name="line-1908"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>r_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConVisibleTyVars</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1909"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span>
<a name="line-1910"></a>              <span class='hs-varid'>deriv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>        <span class='hs-comment'>-- Don't know about deriving</span>
<a name="line-1911"></a>              <span class='hs-varid'>decl</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isNewTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span>
<a name="line-1912"></a>                       <span class='hs-conid'>TH.NewtypeD</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>name</span> <span class='hs-varid'>r_tvs</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>cons</span><span class='hs-layout'>)</span> <span class='hs-varid'>deriv</span>
<a name="line-1913"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span>
<a name="line-1914"></a>                       <span class='hs-conid'>TH.DataD</span>    <span class='hs-varid'>cxt</span> <span class='hs-varid'>name</span> <span class='hs-varid'>r_tvs</span> <span class='hs-conid'>Nothing</span>       <span class='hs-varid'>cons</span>  <span class='hs-varid'>deriv</span>
<a name="line-1915"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.TyConI</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1916"></a>
<a name="line-1917"></a><a name="reifyDataCon"></a><span class='hs-definition'>reifyDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH.Con</span>
<a name="line-1918"></a><span class='hs-definition'>reifyDataCon</span> <span class='hs-varid'>isGadtDataCon</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>dc</span>
<a name="line-1919"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-comment'>-- used for H98 data constructors</span>
<a name="line-1920"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span>
<a name="line-1921"></a>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConInstSig</span> <span class='hs-varid'>dc</span> <span class='hs-varid'>tys</span>
<a name="line-1922"></a>             <span class='hs-comment'>-- used for GADTs data constructors</span>
<a name="line-1923"></a>             <span class='hs-varid'>g_user_tvs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConUserTyVarBinders</span> <span class='hs-varid'>dc</span>
<a name="line-1924"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>g_univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>g_eq_spec</span><span class='hs-layout'>,</span> <span class='hs-varid'>g_theta'</span><span class='hs-layout'>,</span> <span class='hs-varid'>g_arg_tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>g_res_ty'</span><span class='hs-layout'>)</span>
<a name="line-1925"></a>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFullSig</span> <span class='hs-varid'>dc</span>
<a name="line-1926"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>srcUnpks</span><span class='hs-layout'>,</span> <span class='hs-varid'>srcStricts</span><span class='hs-layout'>)</span>
<a name="line-1927"></a>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAndUnzip</span> <span class='hs-varid'>reifySourceBang</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConSrcBangs</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span>
<a name="line-1928"></a>             <span class='hs-varid'>dcdBangs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-conid'>TH.Bang</span> <span class='hs-varid'>srcUnpks</span> <span class='hs-varid'>srcStricts</span>
<a name="line-1929"></a>             <span class='hs-varid'>fields</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFieldLabels</span> <span class='hs-varid'>dc</span>
<a name="line-1930"></a>             <span class='hs-varid'>name</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>dc</span>
<a name="line-1931"></a>             <span class='hs-comment'>-- Universal tvs present in eq_spec need to be filtered out, as</span>
<a name="line-1932"></a>             <span class='hs-comment'>-- they will not appear anywhere in the type.</span>
<a name="line-1933"></a>             <span class='hs-varid'>eq_spec_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>eqSpecTyVar</span> <span class='hs-varid'>g_eq_spec</span><span class='hs-layout'>)</span>
<a name="line-1934"></a>
<a name="line-1935"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>univ_subst</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-1936"></a>              <span class='hs-comment'>-- See Note [Freshen reified GADT constructors' universal tyvars]</span>
<a name="line-1937"></a>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>freshenTyVarBndrs</span> <span class='hs-varop'>$</span>
<a name="line-1938"></a>              <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>eq_spec_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>g_univ_tvs</span>
<a name="line-1939"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvb_subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>g_user_tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_tv_binders</span> <span class='hs-varid'>univ_subst</span> <span class='hs-varid'>g_user_tvs'</span>
<a name="line-1940"></a>             <span class='hs-varid'>g_theta</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTys</span> <span class='hs-varid'>tvb_subst</span> <span class='hs-varid'>g_theta'</span>
<a name="line-1941"></a>             <span class='hs-varid'>g_arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTys</span> <span class='hs-varid'>tvb_subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>scaledThing</span> <span class='hs-varid'>g_arg_tys'</span><span class='hs-layout'>)</span>
<a name="line-1942"></a>             <span class='hs-varid'>g_res_ty</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span>  <span class='hs-varid'>tvb_subst</span> <span class='hs-varid'>g_res_ty'</span>
<a name="line-1943"></a>
<a name="line-1944"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>r_arg_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>isGadtDataCon</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>g_arg_tys</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span>
<a name="line-1945"></a>
<a name="line-1946"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>main_con</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-1947"></a>           <span class='hs-keyword'>if</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>fields</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>isGadtDataCon</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1948"></a>                  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.RecC</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip3</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>reifyFieldLabel</span> <span class='hs-varid'>fields</span><span class='hs-layout'>)</span>
<a name="line-1949"></a>                                         <span class='hs-varid'>dcdBangs</span> <span class='hs-varid'>r_arg_tys</span><span class='hs-layout'>)</span>
<a name="line-1950"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>fields</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1951"></a>                  <span class='hs-layout'>{</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>g_res_ty</span>
<a name="line-1952"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.RecGadtC</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>name</span><span class='hs-keyglyph'>]</span>
<a name="line-1953"></a>                                     <span class='hs-layout'>(</span><span class='hs-varid'>zip3</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>flSelector</span><span class='hs-layout'>)</span> <span class='hs-varid'>fields</span><span class='hs-layout'>)</span>
<a name="line-1954"></a>                                      <span class='hs-varid'>dcdBangs</span> <span class='hs-varid'>r_arg_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span>
<a name="line-1955"></a>                <span class='hs-comment'>-- We need to check not isGadtDataCon here because GADT</span>
<a name="line-1956"></a>                <span class='hs-comment'>-- constructors can be declared infix.</span>
<a name="line-1957"></a>                <span class='hs-comment'>-- See Note [Infix GADT constructors] in GHC.Tc.TyCl.</span>
<a name="line-1958"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dataConIsInfix</span> <span class='hs-varid'>dc</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>isGadtDataCon</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1959"></a>                  <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>r_arg_tys</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-num'>2</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>do</span>
<a name="line-1960"></a>                  <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>r_a1</span><span class='hs-layout'>,</span> <span class='hs-varid'>r_a2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r_arg_tys</span>
<a name="line-1961"></a>                        <span class='hs-keyglyph'>[</span><span class='hs-varid'>s1</span><span class='hs-layout'>,</span>   <span class='hs-varid'>s2</span><span class='hs-keyglyph'>]</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dcdBangs</span>
<a name="line-1962"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.InfixC</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span><span class='hs-layout'>,</span><span class='hs-varid'>r_a1</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>s2</span><span class='hs-layout'>,</span><span class='hs-varid'>r_a2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1963"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGadtDataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1964"></a>                  <span class='hs-layout'>{</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>g_res_ty</span>
<a name="line-1965"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.GadtC</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>name</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-varid'>dcdBangs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>r_arg_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span>
<a name="line-1966"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1967"></a>                  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.NormalC</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>dcdBangs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>r_arg_tys</span><span class='hs-layout'>)</span>
<a name="line-1968"></a>
<a name="line-1969"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>ex_tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGadtDataCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>g_user_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>g_theta</span><span class='hs-layout'>)</span>
<a name="line-1970"></a>                               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>ex_tvs</span> <span class='hs-layout'>)</span>
<a name="line-1971"></a>                                                 <span class='hs-comment'>-- no covars for haskell syntax</span>
<a name="line-1972"></a>                                                 <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mk_specified</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span>
<a name="line-1973"></a>             <span class='hs-varid'>ret_con</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>ex_tvs'</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>theta'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>main_con</span>
<a name="line-1974"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1975"></a>                         <span class='hs-layout'>{</span> <span class='hs-varid'>cxt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyCxt</span> <span class='hs-varid'>theta'</span>
<a name="line-1976"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>ex_tvs''</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVarBndrs</span> <span class='hs-varid'>ex_tvs'</span>
<a name="line-1977"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.ForallC</span> <span class='hs-varid'>ex_tvs''</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>main_con</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1978"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>r_arg_tys</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>dcdBangs</span> <span class='hs-layout'>)</span>
<a name="line-1979"></a>         <span class='hs-varid'>ret_con</span> <span class='hs-layout'>}</span>
<a name="line-1980"></a>  <span class='hs-keyword'>where</span>
<a name="line-1981"></a>    <span class='hs-varid'>mk_specified</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-conid'>SpecifiedSpec</span>
<a name="line-1982"></a>
<a name="line-1983"></a>    <span class='hs-varid'>subst_tv_binders</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv_bndrs</span> <span class='hs-keyglyph'>=</span>
<a name="line-1984"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>tvs</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binderVars</span> <span class='hs-varid'>tv_bndrs</span>
<a name="line-1985"></a>          <span class='hs-varid'>flags</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>binderArgFlag</span> <span class='hs-varid'>tv_bndrs</span>
<a name="line-1986"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyVarBndrs</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span>
<a name="line-1987"></a>          <span class='hs-varid'>tv_bndrs'</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span><span class='hs-varid'>fl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>flags</span><span class='hs-layout'>)</span>
<a name="line-1988"></a>      <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv_bndrs'</span><span class='hs-layout'>)</span>
<a name="line-1989"></a>
<a name="line-1990"></a><span class='hs-comment'>{-
<a name="line-1991"></a>Note [Freshen reified GADT constructors' universal tyvars]
<a name="line-1992"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1993"></a>Suppose one were to reify this GADT:
<a name="line-1994"></a>
<a name="line-1995"></a>  data a :~: b where
<a name="line-1996"></a>    Refl :: forall a b. (a ~ b) =&gt; a :~: b
<a name="line-1997"></a>
<a name="line-1998"></a>We ought to be careful here about the uniques we give to the occurrences of `a`
<a name="line-1999"></a>and `b` in this definition. That is because in the original DataCon, all uses
<a name="line-2000"></a>of `a` and `b` have the same unique, since `a` and `b` are both universally
<a name="line-2001"></a>quantified type variables--that is, they are used in both the (:~:) tycon as
<a name="line-2002"></a>well as in the constructor type signature. But when we turn the DataCon
<a name="line-2003"></a>definition into the reified one, the `a` and `b` in the constructor type
<a name="line-2004"></a>signature becomes differently scoped than the `a` and `b` in `data a :~: b`.
<a name="line-2005"></a>
<a name="line-2006"></a>While it wouldn't technically be *wrong* per se to re-use the same uniques for
<a name="line-2007"></a>`a` and `b` across these two different scopes, it's somewhat annoying for end
<a name="line-2008"></a>users of Template Haskell, since they wouldn't be able to rely on the
<a name="line-2009"></a>assumption that all TH names have globally distinct uniques (#13885). For this
<a name="line-2010"></a>reason, we freshen the universally quantified tyvars that go into the reified
<a name="line-2011"></a>GADT constructor type signature to give them distinct uniques from their
<a name="line-2012"></a>counterparts in the tycon.
<a name="line-2013"></a>-}</span>
<a name="line-2014"></a>
<a name="line-2015"></a><a name="reifyClass"></a><span class='hs-comment'>------------------------------</span>
<a name="line-2016"></a><span class='hs-definition'>reifyClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH.Info</span>
<a name="line-2017"></a><span class='hs-definition'>reifyClass</span> <span class='hs-varid'>cls</span>
<a name="line-2018"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>cxt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyCxt</span> <span class='hs-varid'>theta</span>
<a name="line-2019"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>inst_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetInstEnvs</span>
<a name="line-2020"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>insts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyClassInstances</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstEnv.classInstances</span> <span class='hs-varid'>inst_envs</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-2021"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>assocTys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>concatMapM</span> <span class='hs-varid'>reifyAT</span> <span class='hs-varid'>ats</span>
<a name="line-2022"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ops</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>concatMapM</span> <span class='hs-varid'>reify_op</span> <span class='hs-varid'>op_stuff</span>
<a name="line-2023"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConVisibleTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2024"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>dec</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.ClassD</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>fds'</span> <span class='hs-layout'>(</span><span class='hs-varid'>assocTys</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ops</span><span class='hs-layout'>)</span>
<a name="line-2025"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.ClassI</span> <span class='hs-varid'>dec</span> <span class='hs-varid'>insts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2026"></a>  <span class='hs-keyword'>where</span>
<a name="line-2027"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>fds</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ats</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_stuff</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classExtraBigSig</span> <span class='hs-varid'>cls</span>
<a name="line-2028"></a>    <span class='hs-varid'>fds'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>reifyFunDep</span> <span class='hs-varid'>fds</span>
<a name="line-2029"></a>    <span class='hs-varid'>reify_op</span> <span class='hs-layout'>(</span><span class='hs-varid'>op</span><span class='hs-layout'>,</span> <span class='hs-varid'>def_meth</span><span class='hs-layout'>)</span>
<a name="line-2030"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitMethodTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-2031"></a>               <span class='hs-comment'>-- Use tcSplitMethodTy to get rid of the extraneous class</span>
<a name="line-2032"></a>               <span class='hs-comment'>-- variables and predicates at the beginning of op's type</span>
<a name="line-2033"></a>               <span class='hs-comment'>-- (see #15551).</span>
<a name="line-2034"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>ty</span>
<a name="line-2035"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nm'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>op</span>
<a name="line-2036"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>def_meth</span> <span class='hs-keyword'>of</span>
<a name="line-2037"></a>                <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>GenericDM</span> <span class='hs-varid'>gdm_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2038"></a>                  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gdm_ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>gdm_ty</span>
<a name="line-2039"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH.SigD</span> <span class='hs-varid'>nm'</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-conid'>TH.DefaultSigD</span> <span class='hs-varid'>nm'</span> <span class='hs-varid'>gdm_ty'</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-2040"></a>                <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH.SigD</span> <span class='hs-varid'>nm'</span> <span class='hs-varid'>ty'</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-2041"></a>
<a name="line-2042"></a>    <span class='hs-varid'>reifyAT</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClassATItem</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH.Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-2043"></a>    <span class='hs-varid'>reifyAT</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATI</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>def</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2044"></a>      <span class='hs-varid'>tycon'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-2045"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>tycon'</span> <span class='hs-keyword'>of</span>
<a name="line-2046"></a>        <span class='hs-conid'>TH.FamilyI</span> <span class='hs-varid'>dec</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-2047"></a>          <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyName</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyArgs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tfNames</span> <span class='hs-varid'>dec</span>
<a name="line-2048"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>dec</span> <span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-2049"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>reifyDefImpl</span> <span class='hs-varid'>tyName</span> <span class='hs-varid'>tyArgs</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span>
<a name="line-2050"></a>                            <span class='hs-varid'>def</span>
<a name="line-2051"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"reifyAT"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>tycon'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2052"></a>
<a name="line-2053"></a>    <span class='hs-varid'>reifyDefImpl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH.Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH.Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH.Dec</span>
<a name="line-2054"></a>    <span class='hs-varid'>reifyDefImpl</span> <span class='hs-varid'>n</span> <span class='hs-varid'>args</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span>
<a name="line-2055"></a>      <span class='hs-conid'>TH.TySynInstD</span> <span class='hs-varop'>.</span> <span class='hs-conid'>TH.TySynEqn</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkThAppTs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.ConT</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>TH.VarT</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2056"></a>                                  <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>ty</span>
<a name="line-2057"></a>
<a name="line-2058"></a>    <span class='hs-varid'>tfNames</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH.Dec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.Name</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH.Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2059"></a>    <span class='hs-varid'>tfNames</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.OpenTypeFamilyD</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.TypeFamilyHead</span> <span class='hs-varid'>n</span> <span class='hs-varid'>args</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2060"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>map</span> <span class='hs-varid'>bndrName</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-2061"></a>    <span class='hs-varid'>tfNames</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tfNames"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2062"></a>
<a name="line-2063"></a>    <span class='hs-varid'>bndrName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH.TyVarBndr</span> <span class='hs-varid'>flag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH.Name</span>
<a name="line-2064"></a>    <span class='hs-varid'>bndrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.PlainTV</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-2065"></a>    <span class='hs-varid'>bndrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.KindedTV</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-2066"></a>
<a name="line-2067"></a><a name="annotThType"></a><span class='hs-comment'>------------------------------</span>
<a name="line-2068"></a><span class='hs-comment'>-- | Annotate (with TH.SigT) a type if the first parameter is True</span>
<a name="line-2069"></a><span class='hs-comment'>-- and if the type contains a free variable.</span>
<a name="line-2070"></a><span class='hs-comment'>-- This is used to annotate type patterns for poly-kinded tyvars in</span>
<a name="line-2071"></a><span class='hs-comment'>-- reifying class and type instances.</span>
<a name="line-2072"></a><span class='hs-comment'>-- See @Note [Reified instances and explicit kind signatures]@.</span>
<a name="line-2073"></a><span class='hs-definition'>annotThType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>   <span class='hs-comment'>-- True &lt;=&gt; annotate</span>
<a name="line-2074"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoRep.Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH.Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH.Type</span>
<a name="line-2075"></a>  <span class='hs-comment'>-- tiny optimization: if the type is annotated, don't annotate again.</span>
<a name="line-2076"></a><span class='hs-definition'>annotThType</span> <span class='hs-keyword'>_</span>    <span class='hs-keyword'>_</span>  <span class='hs-varid'>th_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TH.SigT</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>th_ty</span>
<a name="line-2077"></a><span class='hs-definition'>annotThType</span> <span class='hs-conid'>True</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>th_ty</span>
<a name="line-2078"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>filterVarSet</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-2079"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ki</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTypeKind</span> <span class='hs-varid'>ty</span>
<a name="line-2080"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>th_ki</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyKind</span> <span class='hs-varid'>ki</span>
<a name="line-2081"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.SigT</span> <span class='hs-varid'>th_ty</span> <span class='hs-varid'>th_ki</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2082"></a><span class='hs-definition'>annotThType</span> <span class='hs-keyword'>_</span>    <span class='hs-keyword'>_</span> <span class='hs-varid'>th_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>th_ty</span>
<a name="line-2083"></a>
<a name="line-2084"></a><a name="tyConArgsPolyKinded"></a><span class='hs-comment'>-- | For every argument type that a type constructor accepts,</span>
<a name="line-2085"></a><span class='hs-comment'>-- report whether or not the argument is poly-kinded. This is used to</span>
<a name="line-2086"></a><span class='hs-comment'>-- eventually feed into 'annotThType'.</span>
<a name="line-2087"></a><span class='hs-comment'>-- See @Note [Reified instances and explicit kind signatures]@.</span>
<a name="line-2088"></a><span class='hs-definition'>tyConArgsPolyKinded</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Bool</span><span class='hs-keyglyph'>]</span>
<a name="line-2089"></a><span class='hs-definition'>tyConArgsPolyKinded</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span>
<a name="line-2090"></a>     <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_poly_ty</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyVarKind</span><span class='hs-layout'>)</span>      <span class='hs-varid'>tc_vis_tvs</span>
<a name="line-2091"></a>     <span class='hs-comment'>-- See "Wrinkle: Oversaturated data family instances" in</span>
<a name="line-2092"></a>     <span class='hs-comment'>-- @Note [Reified instances and explicit kind signatures]@</span>
<a name="line-2093"></a>  <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_poly_ty</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyCoBinderType</span><span class='hs-layout'>)</span> <span class='hs-varid'>tc_res_kind_vis_bndrs</span> <span class='hs-comment'>-- (1) in Wrinkle</span>
<a name="line-2094"></a>  <span class='hs-varop'>++</span> <span class='hs-varid'>repeat</span> <span class='hs-conid'>True</span>                                             <span class='hs-comment'>-- (2) in Wrinkle</span>
<a name="line-2095"></a>  <span class='hs-keyword'>where</span>
<a name="line-2096"></a>    <span class='hs-varid'>is_poly_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2097"></a>    <span class='hs-varid'>is_poly_ty</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span>
<a name="line-2098"></a>                    <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-varop'>$</span>
<a name="line-2099"></a>                    <span class='hs-varid'>filterVarSet</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varop'>$</span>
<a name="line-2100"></a>                    <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-2101"></a>
<a name="line-2102"></a>    <span class='hs-varid'>tc_vis_tvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-2103"></a>    <span class='hs-varid'>tc_vis_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConVisibleTyVars</span> <span class='hs-varid'>tc</span>
<a name="line-2104"></a>
<a name="line-2105"></a>    <span class='hs-varid'>tc_res_kind_vis_bndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoBinder</span><span class='hs-keyglyph'>]</span>
<a name="line-2106"></a>    <span class='hs-varid'>tc_res_kind_vis_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isVisibleBinder</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>splitPiTys</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyConResKind</span> <span class='hs-varid'>tc</span>
<a name="line-2107"></a>
<a name="line-2108"></a><span class='hs-comment'>{-
<a name="line-2109"></a>Note [Reified instances and explicit kind signatures]
<a name="line-2110"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2111"></a>Reified class instances and type family instances often include extra kind
<a name="line-2112"></a>information to disambiguate instances. Here is one such example that
<a name="line-2113"></a>illustrates this (#8953):
<a name="line-2114"></a>
<a name="line-2115"></a>    type family Poly (a :: k) :: Type
<a name="line-2116"></a>    type instance Poly (x :: Bool)    = Int
<a name="line-2117"></a>    type instance Poly (x :: Maybe k) = Double
<a name="line-2118"></a>
<a name="line-2119"></a>If you're not careful, reifying these instances might yield this:
<a name="line-2120"></a>
<a name="line-2121"></a>    type instance Poly x = Int
<a name="line-2122"></a>    type instance Poly x = Double
<a name="line-2123"></a>
<a name="line-2124"></a>To avoid this, we go through some care to annotate things with extra kind
<a name="line-2125"></a>information. Some functions which accomplish this feat include:
<a name="line-2126"></a>
<a name="line-2127"></a>* annotThType: This annotates a type with a kind signature if the type contains
<a name="line-2128"></a>  a free variable.
<a name="line-2129"></a>* tyConArgsPolyKinded: This checks every argument that a type constructor can
<a name="line-2130"></a>  accept and reports if the type of the argument is poly-kinded. This
<a name="line-2131"></a>  information is ultimately fed into annotThType.
<a name="line-2132"></a>
<a name="line-2133"></a>-----
<a name="line-2134"></a>-- Wrinkle: Oversaturated data family instances
<a name="line-2135"></a>-----
<a name="line-2136"></a>
<a name="line-2137"></a>What constitutes an argument to a type constructor in the definition of
<a name="line-2138"></a>tyConArgsPolyKinded? For most type constructors, it's simply the visible
<a name="line-2139"></a>type variable binders (i.e., tyConVisibleTyVars). There is one corner case
<a name="line-2140"></a>we must keep in mind, however: data family instances can appear oversaturated
<a name="line-2141"></a>(#17296). For instance:
<a name="line-2142"></a>
<a name="line-2143"></a>    data family   Foo :: Type -&gt; Type
<a name="line-2144"></a>    data instance Foo x
<a name="line-2145"></a>
<a name="line-2146"></a>    data family Bar :: k
<a name="line-2147"></a>    data family Bar x
<a name="line-2148"></a>
<a name="line-2149"></a>For these sorts of data family instances, tyConVisibleTyVars isn't enough,
<a name="line-2150"></a>as they won't give you the kinds of the oversaturated arguments. We must
<a name="line-2151"></a>also consult:
<a name="line-2152"></a>
<a name="line-2153"></a>1. The kinds of the arguments in the result kind (i.e., the tyConResKind).
<a name="line-2154"></a>   This will tell us, e.g., the kind of `x` in `Foo x` above.
<a name="line-2155"></a>2. If we go beyond the number of arguments in the result kind (like the
<a name="line-2156"></a>   `x` in `Bar x`), then we conservatively assume that the argument's
<a name="line-2157"></a>   kind is poly-kinded.
<a name="line-2158"></a>
<a name="line-2159"></a>-----
<a name="line-2160"></a>-- Wrinkle: data family instances with return kinds
<a name="line-2161"></a>-----
<a name="line-2162"></a>
<a name="line-2163"></a>Another squirrelly corner case is this:
<a name="line-2164"></a>
<a name="line-2165"></a>    data family Foo (a :: k)
<a name="line-2166"></a>    data instance Foo :: Bool -&gt; Type
<a name="line-2167"></a>    data instance Foo :: Char -&gt; Type
<a name="line-2168"></a>
<a name="line-2169"></a>If you're not careful, reifying these instances might yield this:
<a name="line-2170"></a>
<a name="line-2171"></a>    data instance Foo
<a name="line-2172"></a>    data instance Foo
<a name="line-2173"></a>
<a name="line-2174"></a>We can fix this ambiguity by reifying the instances' explicit return kinds. We
<a name="line-2175"></a>should only do this if necessary (see
<a name="line-2176"></a>Note [When does a tycon application need an explicit kind signature?] in GHC.Core.Type),
<a name="line-2177"></a>but more importantly, we *only* do this if either of the following are true:
<a name="line-2178"></a>
<a name="line-2179"></a>1. The data family instance has no constructors.
<a name="line-2180"></a>2. The data family instance is declared with GADT syntax.
<a name="line-2181"></a>
<a name="line-2182"></a>If neither of these are true, then reifying the return kind would yield
<a name="line-2183"></a>something like this:
<a name="line-2184"></a>
<a name="line-2185"></a>    data instance (Bar a :: Type) = MkBar a
<a name="line-2186"></a>
<a name="line-2187"></a>Which is not valid syntax.
<a name="line-2188"></a>-}</span>
<a name="line-2189"></a>
<a name="line-2190"></a><a name="reifyClassInstances"></a><span class='hs-comment'>------------------------------</span>
<a name="line-2191"></a><span class='hs-definition'>reifyClassInstances</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH.Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-2192"></a><span class='hs-definition'>reifyClassInstances</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>insts</span>
<a name="line-2193"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyClassInstance</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArgsPolyKinded</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>insts</span>
<a name="line-2194"></a>
<a name="line-2195"></a><a name="reifyClassInstance"></a><span class='hs-definition'>reifyClassInstance</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Bool</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- True &lt;=&gt; the corresponding tv is poly-kinded</span>
<a name="line-2196"></a>                              <span class='hs-comment'>-- includes only *visible* tvs</span>
<a name="line-2197"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ClsInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH.Dec</span>
<a name="line-2198"></a><span class='hs-definition'>reifyClassInstance</span> <span class='hs-varid'>is_poly_tvs</span> <span class='hs-varid'>i</span>
<a name="line-2199"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cxt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyCxt</span> <span class='hs-varid'>theta</span>
<a name="line-2200"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>vis_types</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOutInvisibleTypes</span> <span class='hs-varid'>cls_tc</span> <span class='hs-varid'>types</span>
<a name="line-2201"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thtypes</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-varid'>vis_types</span>
<a name="line-2202"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>annot_thtypes</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWith3M</span> <span class='hs-varid'>annotThType</span> <span class='hs-varid'>is_poly_tvs</span> <span class='hs-varid'>vis_types</span> <span class='hs-varid'>thtypes</span>
<a name="line-2203"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>head_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkThAppTs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.ConT</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>annot_thtypes</span>
<a name="line-2204"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.InstanceD</span> <span class='hs-varid'>over</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>head_ty</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2205"></a>  <span class='hs-keyword'>where</span>
<a name="line-2206"></a>     <span class='hs-layout'>(</span><span class='hs-sel'>_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>types</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitDFunTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>dfun</span><span class='hs-layout'>)</span>
<a name="line-2207"></a>     <span class='hs-varid'>cls_tc</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classTyCon</span> <span class='hs-varid'>cls</span>
<a name="line-2208"></a>     <span class='hs-varid'>dfun</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>instanceDFunId</span> <span class='hs-varid'>i</span>
<a name="line-2209"></a>     <span class='hs-varid'>over</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>overlapMode</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_flag</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-2210"></a>                  <span class='hs-conid'>NoOverlap</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-2211"></a>                  <span class='hs-conid'>Overlappable</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>TH.Overlappable</span>
<a name="line-2212"></a>                  <span class='hs-conid'>Overlapping</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>TH.Overlapping</span>
<a name="line-2213"></a>                  <span class='hs-conid'>Overlaps</span> <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>TH.Overlaps</span>
<a name="line-2214"></a>                  <span class='hs-conid'>Incoherent</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>TH.Incoherent</span>
<a name="line-2215"></a>
<a name="line-2216"></a><a name="reifyFamilyInstances"></a><span class='hs-comment'>------------------------------</span>
<a name="line-2217"></a><span class='hs-definition'>reifyFamilyInstances</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH.Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-2218"></a><span class='hs-definition'>reifyFamilyInstances</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>fam_insts</span>
<a name="line-2219"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyFamilyInstance</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArgsPolyKinded</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fam_insts</span>
<a name="line-2220"></a>
<a name="line-2221"></a><a name="reifyFamilyInstance"></a><span class='hs-definition'>reifyFamilyInstance</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Bool</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- True &lt;=&gt; the corresponding tv is poly-kinded</span>
<a name="line-2222"></a>                              <span class='hs-comment'>-- includes only *visible* tvs</span>
<a name="line-2223"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH.Dec</span>
<a name="line-2224"></a><span class='hs-definition'>reifyFamilyInstance</span> <span class='hs-varid'>is_poly_tvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fi_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flavor</span>
<a name="line-2225"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>fi_axiom</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ax</span>
<a name="line-2226"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>fi_fam</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2227"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fam_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomTyCon</span> <span class='hs-varid'>ax</span>
<a name="line-2228"></a>        <span class='hs-varid'>branch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomSingleBranch</span> <span class='hs-varid'>ax</span>
<a name="line-2229"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>branch</span>
<a name="line-2230"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>flavor</span> <span class='hs-keyword'>of</span>
<a name="line-2231"></a>      <span class='hs-conid'>SynFamilyInst</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2232"></a>               <span class='hs-comment'>-- remove kind patterns (#8884)</span>
<a name="line-2233"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>th_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVarsToMaybe</span> <span class='hs-varid'>tvs</span>
<a name="line-2234"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>lhs_types_only</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOutInvisibleTypes</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>lhs</span>
<a name="line-2235"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>th_lhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-varid'>lhs_types_only</span>
<a name="line-2236"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>annot_th_lhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWith3M</span> <span class='hs-varid'>annotThType</span> <span class='hs-varid'>is_poly_tvs</span> <span class='hs-varid'>lhs_types_only</span>
<a name="line-2237"></a>                                                   <span class='hs-varid'>th_lhs</span>
<a name="line-2238"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>lhs_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkThAppTs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.ConT</span> <span class='hs-varop'>$</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>fam</span><span class='hs-layout'>)</span> <span class='hs-varid'>annot_th_lhs</span>
<a name="line-2239"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>th_rhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>rhs</span>
<a name="line-2240"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.TySynInstD</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.TySynEqn</span> <span class='hs-varid'>th_tvs</span> <span class='hs-varid'>lhs_type</span> <span class='hs-varid'>th_rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2241"></a>
<a name="line-2242"></a>      <span class='hs-conid'>DataFamilyInst</span> <span class='hs-varid'>rep_tc</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2243"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-comment'>-- eta-expand lhs types, because sometimes data/newtype</span>
<a name="line-2244"></a>                 <span class='hs-comment'>-- instances are eta-reduced; See #9692</span>
<a name="line-2245"></a>                 <span class='hs-comment'>-- See Note [Eta reduction for data families] in GHC.Core.Coercion.Axiom</span>
<a name="line-2246"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>ee_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ee_lhs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>etaExpandCoAxBranch</span> <span class='hs-varid'>branch</span>
<a name="line-2247"></a>                 <span class='hs-varid'>fam'</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>fam</span>
<a name="line-2248"></a>                 <span class='hs-varid'>dataCons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>rep_tc</span>
<a name="line-2249"></a>                 <span class='hs-varid'>isGadt</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isGadtSyntaxTyCon</span> <span class='hs-varid'>rep_tc</span>
<a name="line-2250"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>th_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVarsToMaybe</span> <span class='hs-varid'>ee_tvs</span>
<a name="line-2251"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>cons</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyDataCon</span> <span class='hs-varid'>isGadt</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>ee_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>dataCons</span>
<a name="line-2252"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>types_only</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOutInvisibleTypes</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>ee_lhs</span>
<a name="line-2253"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>th_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-varid'>types_only</span>
<a name="line-2254"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>annot_th_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWith3M</span> <span class='hs-varid'>annotThType</span> <span class='hs-varid'>is_poly_tvs</span> <span class='hs-varid'>types_only</span> <span class='hs-varid'>th_tys</span>
<a name="line-2255"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>lhs_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkThAppTs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.ConT</span> <span class='hs-varid'>fam'</span><span class='hs-layout'>)</span> <span class='hs-varid'>annot_th_tys</span>
<a name="line-2256"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>mb_sig</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-2257"></a>               <span class='hs-comment'>-- See "Wrinkle: data family instances with return kinds" in</span>
<a name="line-2258"></a>               <span class='hs-comment'>-- Note [Reified instances and explicit kind signatures]</span>
<a name="line-2259"></a>               <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>cons</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isGadtSyntaxTyCon</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>)</span>
<a name="line-2260"></a>                     <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>tyConAppNeedsKindSig</span> <span class='hs-conid'>False</span> <span class='hs-varid'>fam_tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>ee_lhs</span><span class='hs-layout'>)</span>
<a name="line-2261"></a>               <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>full_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTypeKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>ee_lhs</span><span class='hs-layout'>)</span>
<a name="line-2262"></a>                       <span class='hs-layout'>;</span> <span class='hs-varid'>th_full_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyKind</span> <span class='hs-varid'>full_kind</span>
<a name="line-2263"></a>                       <span class='hs-layout'>;</span> <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>th_full_kind</span> <span class='hs-layout'>}</span>
<a name="line-2264"></a>               <span class='hs-keyword'>else</span> <span class='hs-varid'>pure</span> <span class='hs-conid'>Nothing</span>
<a name="line-2265"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span>
<a name="line-2266"></a>               <span class='hs-keyword'>if</span> <span class='hs-varid'>isNewTyCon</span> <span class='hs-varid'>rep_tc</span>
<a name="line-2267"></a>               <span class='hs-keyword'>then</span> <span class='hs-conid'>TH.NewtypeInstD</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>th_tvs</span> <span class='hs-varid'>lhs_type</span> <span class='hs-varid'>mb_sig</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>cons</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span>
<a name="line-2268"></a>               <span class='hs-keyword'>else</span> <span class='hs-conid'>TH.DataInstD</span>    <span class='hs-conid'>[]</span> <span class='hs-varid'>th_tvs</span> <span class='hs-varid'>lhs_type</span> <span class='hs-varid'>mb_sig</span>       <span class='hs-varid'>cons</span>  <span class='hs-conid'>[]</span>
<a name="line-2269"></a>           <span class='hs-layout'>}</span>
<a name="line-2270"></a>
<a name="line-2271"></a><a name="reifyType"></a><span class='hs-comment'>------------------------------</span>
<a name="line-2272"></a><span class='hs-definition'>reifyType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoRep.Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH.Type</span>
<a name="line-2273"></a><span class='hs-comment'>-- Monadic only because of failure</span>
<a name="line-2274"></a><span class='hs-definition'>reifyType</span> <span class='hs-varid'>ty</span>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tcIsLiftedTypeKind</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>TH.StarT</span>
<a name="line-2275"></a>  <span class='hs-comment'>-- Make sure to use tcIsLiftedTypeKind here, since we don't want to confuse it</span>
<a name="line-2276"></a>  <span class='hs-comment'>-- with Constraint (#14869).</span>
<a name="line-2277"></a><span class='hs-definition'>reifyType</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>argf</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-2278"></a>                            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reify_for_all</span> <span class='hs-varid'>argf</span> <span class='hs-varid'>ty</span>
<a name="line-2279"></a><span class='hs-definition'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyLit</span> <span class='hs-varid'>t</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.LitT</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2280"></a><span class='hs-definition'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.VarT</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2281"></a><span class='hs-definition'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reify_tc_app</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>   <span class='hs-comment'>-- Do not expand type synonyms here</span>
<a name="line-2282"></a><span class='hs-definition'>reifyType</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2283"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty_head</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAppTys</span> <span class='hs-varid'>ty</span>
<a name="line-2284"></a>  <span class='hs-varid'>ty_head'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>ty_head</span>
<a name="line-2285"></a>  <span class='hs-varid'>ty_args'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter_out_invisible_args</span> <span class='hs-varid'>ty_head</span> <span class='hs-varid'>ty_args</span><span class='hs-layout'>)</span>
<a name="line-2286"></a>  <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkThAppTs</span> <span class='hs-varid'>ty_head'</span> <span class='hs-varid'>ty_args'</span>
<a name="line-2287"></a>  <span class='hs-keyword'>where</span>
<a name="line-2288"></a>    <span class='hs-comment'>-- Make sure to filter out any invisible arguments. For instance, if you</span>
<a name="line-2289"></a>    <span class='hs-comment'>-- reify the following:</span>
<a name="line-2290"></a>    <span class='hs-comment'>--</span>
<a name="line-2291"></a>    <span class='hs-comment'>--   newtype T (f :: forall a. a -&gt; Type) = MkT (f Bool)</span>
<a name="line-2292"></a>    <span class='hs-comment'>--</span>
<a name="line-2293"></a>    <span class='hs-comment'>-- Then you should receive back `f Bool`, not `f Type Bool`, since the</span>
<a name="line-2294"></a>    <span class='hs-comment'>-- `Type` argument is invisible (#15792).</span>
<a name="line-2295"></a>    <span class='hs-varid'>filter_out_invisible_args</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-2296"></a>    <span class='hs-varid'>filter_out_invisible_args</span> <span class='hs-varid'>ty_head</span> <span class='hs-varid'>ty_args</span> <span class='hs-keyglyph'>=</span>
<a name="line-2297"></a>      <span class='hs-varid'>filterByList</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>isVisibleArgFlag</span> <span class='hs-varop'>$</span> <span class='hs-varid'>appTyArgFlags</span> <span class='hs-varid'>ty_head</span> <span class='hs-varid'>ty_args</span><span class='hs-layout'>)</span>
<a name="line-2298"></a>                   <span class='hs-varid'>ty_args</span>
<a name="line-2299"></a><span class='hs-definition'>reifyType</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_af</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>af</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_mult</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Many</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2300"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InvisArg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>af</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reify_for_all</span> <span class='hs-conid'>Inferred</span> <span class='hs-varid'>ty</span>  <span class='hs-comment'>-- Types like ((?x::Int) =&gt; Char -&gt; Char)</span>
<a name="line-2301"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>r1</span><span class='hs-layout'>,</span><span class='hs-varid'>r2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span><span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span>
<a name="line-2302"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.ArrowT</span> <span class='hs-varop'>`TH.AppT`</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>`TH.AppT`</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2303"></a><span class='hs-definition'>reifyType</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_af</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>af</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_mult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tm</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2304"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InvisArg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>af</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noTH</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"linear invisible argument"</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2305"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>rm</span><span class='hs-layout'>,</span><span class='hs-varid'>r1</span><span class='hs-layout'>,</span><span class='hs-varid'>r2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tm</span><span class='hs-layout'>,</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span><span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span>
<a name="line-2306"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.MulArrowT</span> <span class='hs-varop'>`TH.AppT`</span> <span class='hs-varid'>rm</span> <span class='hs-varop'>`TH.AppT`</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>`TH.AppT`</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2307"></a><span class='hs-definition'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>t</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>t</span> <span class='hs-comment'>-- Casts are ignored in TH</span>
<a name="line-2308"></a><span class='hs-definition'>reifyType</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>=</span> <span class='hs-varid'>noTH</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"coercions in types"</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2309"></a>
<a name="line-2310"></a><a name="reify_for_all"></a><span class='hs-definition'>reify_for_all</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoRep.ArgFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoRep.Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH.Type</span>
<a name="line-2311"></a><span class='hs-comment'>-- Arg of reify_for_all is always ForAllTy or a predicate FunTy</span>
<a name="line-2312"></a><span class='hs-definition'>reify_for_all</span> <span class='hs-varid'>argf</span> <span class='hs-varid'>ty</span>
<a name="line-2313"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isVisibleArgFlag</span> <span class='hs-varid'>argf</span>
<a name="line-2314"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>req_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>phi</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitForAllReqTVBinders</span> <span class='hs-varid'>ty</span>
<a name="line-2315"></a>       <span class='hs-varid'>tvbndrs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVarBndrs</span> <span class='hs-varid'>req_bndrs</span>
<a name="line-2316"></a>       <span class='hs-varid'>phi'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>phi</span>
<a name="line-2317"></a>       <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.ForallVisT</span> <span class='hs-varid'>tvbndrs'</span> <span class='hs-varid'>phi'</span>
<a name="line-2318"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2319"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>inv_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>phi</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitForAllInvisTVBinders</span> <span class='hs-varid'>ty</span>
<a name="line-2320"></a>       <span class='hs-varid'>tvbndrs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVarBndrs</span> <span class='hs-varid'>inv_bndrs</span>
<a name="line-2321"></a>       <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>cxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitPhiTy</span> <span class='hs-varid'>phi</span>
<a name="line-2322"></a>       <span class='hs-varid'>cxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyCxt</span> <span class='hs-varid'>cxt</span>
<a name="line-2323"></a>       <span class='hs-varid'>tau'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>tau</span>
<a name="line-2324"></a>       <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.ForallT</span> <span class='hs-varid'>tvbndrs'</span> <span class='hs-varid'>cxt'</span> <span class='hs-varid'>tau'</span>
<a name="line-2325"></a>
<a name="line-2326"></a><a name="reifyTyLit"></a><span class='hs-definition'>reifyTyLit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoRep.TyLit</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH.TyLit</span>
<a name="line-2327"></a><span class='hs-definition'>reifyTyLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>NumTyLit</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.NumTyLit</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-2328"></a><span class='hs-definition'>reifyTyLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrTyLit</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.StrTyLit</span> <span class='hs-layout'>(</span><span class='hs-varid'>unpackFS</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2329"></a><span class='hs-definition'>reifyTyLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CharTyLit</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.CharTyLit</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-2330"></a>
<a name="line-2331"></a><a name="reifyTypes"></a><span class='hs-definition'>reifyTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH.Type</span><span class='hs-keyglyph'>]</span>
<a name="line-2332"></a><span class='hs-definition'>reifyTypes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>reifyType</span>
<a name="line-2333"></a>
<a name="line-2334"></a><a name="reifyPatSynType"></a><span class='hs-definition'>reifyPatSynType</span>
<a name="line-2335"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>InvisTVBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InvisTVBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Scaled</span> <span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH.Type</span>
<a name="line-2336"></a><span class='hs-comment'>-- reifies a pattern synonym's type and returns its *complete* type</span>
<a name="line-2337"></a><span class='hs-comment'>-- signature; see NOTE [Pattern synonym signatures and Template</span>
<a name="line-2338"></a><span class='hs-comment'>-- Haskell]</span>
<a name="line-2339"></a><span class='hs-definition'>reifyPatSynType</span> <span class='hs-layout'>(</span><span class='hs-varid'>univTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>req</span><span class='hs-layout'>,</span> <span class='hs-varid'>exTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>prov</span><span class='hs-layout'>,</span> <span class='hs-varid'>argTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>resTy</span><span class='hs-layout'>)</span>
<a name="line-2340"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>univTyVars'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVarBndrs</span> <span class='hs-varid'>univTyVars</span>
<a name="line-2341"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>req'</span>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyCxt</span> <span class='hs-varid'>req</span>
<a name="line-2342"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>exTyVars'</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVarBndrs</span> <span class='hs-varid'>exTyVars</span>
<a name="line-2343"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>prov'</span>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyCxt</span> <span class='hs-varid'>prov</span>
<a name="line-2344"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tau'</span>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVisFunTys</span> <span class='hs-varid'>argTys</span> <span class='hs-varid'>resTy</span><span class='hs-layout'>)</span>
<a name="line-2345"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.ForallT</span> <span class='hs-varid'>univTyVars'</span> <span class='hs-varid'>req'</span>
<a name="line-2346"></a>                <span class='hs-varop'>$</span> <span class='hs-conid'>TH.ForallT</span> <span class='hs-varid'>exTyVars'</span> <span class='hs-varid'>prov'</span> <span class='hs-varid'>tau'</span> <span class='hs-layout'>}</span>
<a name="line-2347"></a>
<a name="line-2348"></a><a name="reifyKind"></a><span class='hs-definition'>reifyKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH.Kind</span>
<a name="line-2349"></a><span class='hs-definition'>reifyKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyType</span>
<a name="line-2350"></a>
<a name="line-2351"></a><a name="reifyCxt"></a><span class='hs-definition'>reifyCxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH.Pred</span><span class='hs-keyglyph'>]</span>
<a name="line-2352"></a><span class='hs-definition'>reifyCxt</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>reifyType</span>
<a name="line-2353"></a>
<a name="line-2354"></a><a name="reifyFunDep"></a><span class='hs-definition'>reifyFunDep</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH.FunDep</span>
<a name="line-2355"></a><span class='hs-definition'>reifyFunDep</span> <span class='hs-layout'>(</span><span class='hs-varid'>xs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.FunDep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span>
<a name="line-2356"></a>
<a name="line-2357"></a><a name="ReifyFlag"></a><span class='hs-keyword'>class</span> <span class='hs-conid'>ReifyFlag</span> <span class='hs-varid'>flag</span> <span class='hs-varid'>flag'</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>flag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>flag'</span> <span class='hs-keyword'>where</span>
<a name="line-2358"></a>    <span class='hs-varid'>reifyFlag</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>flag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>flag'</span>
<a name="line-2359"></a>
<a name="line-2360"></a><a name="instance%20ReifyFlag%20()%20()"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ReifyFlag</span> <span class='hs-conid'>()</span> <span class='hs-conid'>()</span> <span class='hs-keyword'>where</span>
<a name="line-2361"></a>    <span class='hs-varid'>reifyFlag</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-2362"></a>
<a name="line-2363"></a><a name="instance%20ReifyFlag%20Specificity%20TH.Specificity"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ReifyFlag</span> <span class='hs-conid'>Specificity</span> <span class='hs-conid'>TH.Specificity</span> <span class='hs-keyword'>where</span>
<a name="line-2364"></a>    <span class='hs-varid'>reifyFlag</span> <span class='hs-conid'>SpecifiedSpec</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.SpecifiedSpec</span>
<a name="line-2365"></a>    <span class='hs-varid'>reifyFlag</span> <span class='hs-conid'>InferredSpec</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.InferredSpec</span>
<a name="line-2366"></a>
<a name="line-2367"></a><a name="reifyTyVars"></a><span class='hs-definition'>reifyTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH.TyVarBndr</span> <span class='hs-conid'>()</span><span class='hs-keyglyph'>]</span>
<a name="line-2368"></a><span class='hs-definition'>reifyTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyTyVarBndrs</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-varid'>mk_bndr</span>
<a name="line-2369"></a>  <span class='hs-keyword'>where</span>
<a name="line-2370"></a>    <span class='hs-varid'>mk_bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-conid'>()</span>
<a name="line-2371"></a>
<a name="line-2372"></a><a name="reifyTyVarBndrs"></a><span class='hs-definition'>reifyTyVarBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReifyFlag</span> <span class='hs-varid'>flag</span> <span class='hs-varid'>flag'</span>
<a name="line-2373"></a>                <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>VarBndr</span> <span class='hs-conid'>TyVar</span> <span class='hs-varid'>flag</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH.TyVarBndr</span> <span class='hs-varid'>flag'</span><span class='hs-keyglyph'>]</span>
<a name="line-2374"></a><span class='hs-definition'>reifyTyVarBndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>reify_tvbndr</span>
<a name="line-2375"></a>  <span class='hs-keyword'>where</span>
<a name="line-2376"></a>    <span class='hs-comment'>-- even if the kind is *, we need to include a kind annotation,</span>
<a name="line-2377"></a>    <span class='hs-comment'>-- in case a poly-kind would be inferred without the annotation.</span>
<a name="line-2378"></a>    <span class='hs-comment'>-- See #8953 or test th/T8953</span>
<a name="line-2379"></a>    <span class='hs-varid'>reify_tvbndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.KindedTV</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-2380"></a>                                            <span class='hs-layout'>(</span><span class='hs-varid'>reifyFlag</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span>
<a name="line-2381"></a>                                            <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>reifyKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-2382"></a>
<a name="line-2383"></a><a name="reifyTyVarsToMaybe"></a><span class='hs-definition'>reifyTyVarsToMaybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH.TyVarBndr</span> <span class='hs-conid'>()</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2384"></a><span class='hs-definition'>reifyTyVarsToMaybe</span> <span class='hs-conid'>[]</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pure</span> <span class='hs-conid'>Nothing</span>
<a name="line-2385"></a><span class='hs-definition'>reifyTyVarsToMaybe</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>reifyTyVars</span> <span class='hs-varid'>tys</span>
<a name="line-2386"></a>
<a name="line-2387"></a><a name="reify_tc_app"></a><span class='hs-definition'>reify_tc_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type.Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH.Type</span>
<a name="line-2388"></a><span class='hs-definition'>reify_tc_app</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-2389"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>filterOutInvisibleTypes</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2390"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>maybe_sig_t</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkThAppTs</span> <span class='hs-varid'>r_tc</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2391"></a>  <span class='hs-keyword'>where</span>
<a name="line-2392"></a>    <span class='hs-varid'>arity</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span>
<a name="line-2393"></a>
<a name="line-2394"></a>    <span class='hs-varid'>r_tc</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnboxedSumTyCon</span> <span class='hs-varid'>tc</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.UnboxedSumT</span> <span class='hs-layout'>(</span><span class='hs-varid'>arity</span> <span class='hs-varop'>`div`</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-2395"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnboxedTupleTyCon</span> <span class='hs-varid'>tc</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.UnboxedTupleT</span> <span class='hs-layout'>(</span><span class='hs-varid'>arity</span> <span class='hs-varop'>`div`</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-2396"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPromotedTupleTyCon</span> <span class='hs-varid'>tc</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.PromotedTupleT</span> <span class='hs-layout'>(</span><span class='hs-varid'>arity</span> <span class='hs-varop'>`div`</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-2397"></a>             <span class='hs-comment'>-- See Note [Unboxed tuple RuntimeRep vars] in GHC.Core.TyCon</span>
<a name="line-2398"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTupleTyCon</span> <span class='hs-varid'>tc</span>                <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isPromotedDataCon</span> <span class='hs-varid'>tc</span>
<a name="line-2399"></a>                                            <span class='hs-keyword'>then</span> <span class='hs-conid'>TH.PromotedTupleT</span> <span class='hs-varid'>arity</span>
<a name="line-2400"></a>                                            <span class='hs-keyword'>else</span> <span class='hs-conid'>TH.TupleT</span> <span class='hs-varid'>arity</span>
<a name="line-2401"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>constraintKindTyConKey</span>
<a name="line-2402"></a>                                          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.ConstraintT</span>
<a name="line-2403"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>unrestrictedFunTyConKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.ArrowT</span>
<a name="line-2404"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>listTyConKey</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.ListT</span>
<a name="line-2405"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>nilDataConKey</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.PromotedNilT</span>
<a name="line-2406"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>consDataConKey</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.PromotedConsT</span>
<a name="line-2407"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>heqTyConKey</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.EqualityT</span>
<a name="line-2408"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqPrimTyConKey</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.EqualityT</span>
<a name="line-2409"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqReprPrimTyConKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.ConT</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>coercibleTyCon</span><span class='hs-layout'>)</span>
<a name="line-2410"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPromotedDataCon</span> <span class='hs-varid'>tc</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.PromotedT</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-2411"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.ConT</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-2412"></a>
<a name="line-2413"></a>    <span class='hs-comment'>-- See Note [When does a tycon application need an explicit kind</span>
<a name="line-2414"></a>    <span class='hs-comment'>-- signature?] in GHC.Core.TyCo.Rep</span>
<a name="line-2415"></a>    <span class='hs-varid'>maybe_sig_t</span> <span class='hs-varid'>th_type</span>
<a name="line-2416"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tyConAppNeedsKindSig</span>
<a name="line-2417"></a>          <span class='hs-conid'>False</span> <span class='hs-comment'>-- We don't reify types using visible kind applications, so</span>
<a name="line-2418"></a>                <span class='hs-comment'>-- don't count specified binders as contributing towards</span>
<a name="line-2419"></a>                <span class='hs-comment'>-- injective positions in the kind of the tycon.</span>
<a name="line-2420"></a>          <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2421"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>full_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTypeKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2422"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>th_full_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyKind</span> <span class='hs-varid'>full_kind</span>
<a name="line-2423"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.SigT</span> <span class='hs-varid'>th_type</span> <span class='hs-varid'>th_full_kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2424"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2425"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>th_type</span>
<a name="line-2426"></a>
<a name="line-2427"></a><a name="reifyName"></a><span class='hs-comment'>------------------------------</span>
<a name="line-2428"></a><span class='hs-definition'>reifyName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NamedThing</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH.Name</span>
<a name="line-2429"></a><span class='hs-definition'>reifyName</span> <span class='hs-varid'>thing</span>
<a name="line-2430"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span>
<a name="line-2431"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_varg</span> <span class='hs-varid'>pkg_str</span> <span class='hs-varid'>mod_str</span> <span class='hs-varid'>occ_str</span>
<a name="line-2432"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.mkNameU</span> <span class='hs-varid'>occ_str</span> <span class='hs-layout'>(</span><span class='hs-varid'>toInteger</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getKey</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2433"></a>        <span class='hs-comment'>-- Many of the things we reify have local bindings, and</span>
<a name="line-2434"></a>        <span class='hs-comment'>-- NameL's aren't supposed to appear in binding positions, so</span>
<a name="line-2435"></a>        <span class='hs-comment'>-- we use NameU.  When/if we start to reify nested things, that</span>
<a name="line-2436"></a>        <span class='hs-comment'>-- have free variables, we may need to generate NameL's for them.</span>
<a name="line-2437"></a>  <span class='hs-keyword'>where</span>
<a name="line-2438"></a>    <span class='hs-varid'>name</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>thing</span>
<a name="line-2439"></a>    <span class='hs-varid'>mod</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span> <span class='hs-layout'>)</span> <span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span>
<a name="line-2440"></a>    <span class='hs-varid'>pkg_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitString</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleUnit</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-2441"></a>    <span class='hs-varid'>mod_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleNameString</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-2442"></a>    <span class='hs-varid'>occ_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occNameString</span> <span class='hs-varid'>occ</span>
<a name="line-2443"></a>    <span class='hs-varid'>occ</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span>
<a name="line-2444"></a>    <span class='hs-varid'>mk_varg</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OccName.isDataOcc</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.mkNameG_d</span>
<a name="line-2445"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OccName.isVarOcc</span>  <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.mkNameG_v</span>
<a name="line-2446"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OccName.isTcOcc</span>   <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.mkNameG_tc</span>
<a name="line-2447"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"reifyName"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-2448"></a>
<a name="line-2449"></a><a name="reifyFieldLabel"></a><span class='hs-comment'>-- See Note [Reifying field labels]</span>
<a name="line-2450"></a><span class='hs-definition'>reifyFieldLabel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FieldLabel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH.Name</span>
<a name="line-2451"></a><span class='hs-definition'>reifyFieldLabel</span> <span class='hs-varid'>fl</span>
<a name="line-2452"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>flIsOverloaded</span> <span class='hs-varid'>fl</span>
<a name="line-2453"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.mkOccName</span> <span class='hs-varid'>occ_str</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.NameQ</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.mkModName</span> <span class='hs-varid'>mod_str</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2454"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.mkNameG_v</span> <span class='hs-varid'>pkg_str</span> <span class='hs-varid'>mod_str</span> <span class='hs-varid'>occ_str</span>
<a name="line-2455"></a>  <span class='hs-keyword'>where</span>
<a name="line-2456"></a>    <span class='hs-varid'>name</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flSelector</span> <span class='hs-varid'>fl</span>
<a name="line-2457"></a>    <span class='hs-varid'>mod</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span> <span class='hs-layout'>)</span> <span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span>
<a name="line-2458"></a>    <span class='hs-varid'>pkg_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitString</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleUnit</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-2459"></a>    <span class='hs-varid'>mod_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleNameString</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-2460"></a>    <span class='hs-varid'>occ_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unpackFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>flLabel</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span>
<a name="line-2461"></a>
<a name="line-2462"></a><a name="reifySelector"></a><span class='hs-definition'>reifySelector</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH.Name</span>
<a name="line-2463"></a><span class='hs-definition'>reifySelector</span> <span class='hs-varid'>id</span> <span class='hs-varid'>tc</span>
<a name="line-2464"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>find</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span> <span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>flSelector</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConFieldLabels</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-2465"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>fl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>reifyFieldLabel</span> <span class='hs-varid'>fl</span>
<a name="line-2466"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"reifySelector: missing field"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-2467"></a>
<a name="line-2468"></a><a name="reifyFixity"></a><span class='hs-comment'>------------------------------</span>
<a name="line-2469"></a><span class='hs-definition'>reifyFixity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>TH.Fixity</span><span class='hs-layout'>)</span>
<a name="line-2470"></a><span class='hs-definition'>reifyFixity</span> <span class='hs-varid'>name</span>
<a name="line-2471"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>found</span><span class='hs-layout'>,</span> <span class='hs-varid'>fix</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupFixityRn_help</span> <span class='hs-varid'>name</span>
<a name="line-2472"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>found</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>conv_fix</span> <span class='hs-varid'>fix</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2473"></a>    <span class='hs-keyword'>where</span>
<a name="line-2474"></a>      <span class='hs-varid'>conv_fix</span> <span class='hs-layout'>(</span><span class='hs-conid'>Hs.Fixity</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>i</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.Fixity</span> <span class='hs-varid'>i</span> <span class='hs-layout'>(</span><span class='hs-varid'>conv_dir</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>
<a name="line-2475"></a>      <span class='hs-varid'>conv_dir</span> <span class='hs-conid'>Hs.InfixR</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.InfixR</span>
<a name="line-2476"></a>      <span class='hs-varid'>conv_dir</span> <span class='hs-conid'>Hs.InfixL</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.InfixL</span>
<a name="line-2477"></a>      <span class='hs-varid'>conv_dir</span> <span class='hs-conid'>Hs.InfixN</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.InfixN</span>
<a name="line-2478"></a>
<a name="line-2479"></a><a name="reifyUnpackedness"></a><span class='hs-definition'>reifyUnpackedness</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon.SrcUnpackedness</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH.SourceUnpackedness</span>
<a name="line-2480"></a><span class='hs-definition'>reifyUnpackedness</span> <span class='hs-conid'>NoSrcUnpack</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.NoSourceUnpackedness</span>
<a name="line-2481"></a><span class='hs-definition'>reifyUnpackedness</span> <span class='hs-conid'>SrcNoUnpack</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.SourceNoUnpack</span>
<a name="line-2482"></a><span class='hs-definition'>reifyUnpackedness</span> <span class='hs-conid'>SrcUnpack</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.SourceUnpack</span>
<a name="line-2483"></a>
<a name="line-2484"></a><a name="reifyStrictness"></a><span class='hs-definition'>reifyStrictness</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon.SrcStrictness</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH.SourceStrictness</span>
<a name="line-2485"></a><span class='hs-definition'>reifyStrictness</span> <span class='hs-conid'>NoSrcStrict</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.NoSourceStrictness</span>
<a name="line-2486"></a><span class='hs-definition'>reifyStrictness</span> <span class='hs-conid'>SrcStrict</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.SourceStrict</span>
<a name="line-2487"></a><span class='hs-definition'>reifyStrictness</span> <span class='hs-conid'>SrcLazy</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.SourceLazy</span>
<a name="line-2488"></a>
<a name="line-2489"></a><a name="reifySourceBang"></a><span class='hs-definition'>reifySourceBang</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon.HsSrcBang</span>
<a name="line-2490"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.SourceUnpackedness</span><span class='hs-layout'>,</span> <span class='hs-conid'>TH.SourceStrictness</span><span class='hs-layout'>)</span>
<a name="line-2491"></a><span class='hs-definition'>reifySourceBang</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSrcBang</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>u</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyUnpackedness</span> <span class='hs-varid'>u</span><span class='hs-layout'>,</span> <span class='hs-varid'>reifyStrictness</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-2492"></a>
<a name="line-2493"></a><a name="reifyDecidedStrictness"></a><span class='hs-definition'>reifyDecidedStrictness</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon.HsImplBang</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH.DecidedStrictness</span>
<a name="line-2494"></a><span class='hs-definition'>reifyDecidedStrictness</span> <span class='hs-conid'>HsLazy</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.DecidedLazy</span>
<a name="line-2495"></a><span class='hs-definition'>reifyDecidedStrictness</span> <span class='hs-conid'>HsStrict</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.DecidedStrict</span>
<a name="line-2496"></a><span class='hs-definition'>reifyDecidedStrictness</span> <span class='hs-conid'>HsUnpack</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.DecidedUnpack</span>
<a name="line-2497"></a>
<a name="line-2498"></a><a name="reifyTypeOfThing"></a><span class='hs-definition'>reifyTypeOfThing</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH.Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH.Type</span>
<a name="line-2499"></a><span class='hs-definition'>reifyTypeOfThing</span> <span class='hs-varid'>th_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2500"></a>  <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getThing</span> <span class='hs-varid'>th_name</span>
<a name="line-2501"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-2502"></a>    <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnId</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-2503"></a>    <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>reifyKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-2504"></a>    <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2505"></a>      <span class='hs-varid'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConWrapId</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2506"></a>    <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynCon</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2507"></a>      <span class='hs-varid'>reifyPatSynType</span> <span class='hs-layout'>(</span><span class='hs-varid'>patSynSigBndr</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-2508"></a>    <span class='hs-conid'>ATcId</span><span class='hs-layout'>{</span><span class='hs-varid'>tct_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>reifyType</span>
<a name="line-2509"></a>    <span class='hs-conid'>ATyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tctv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>zonkTcTyVar</span> <span class='hs-varid'>tctv</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>reifyType</span>
<a name="line-2510"></a>    <span class='hs-comment'>-- Impossible cases, supposedly:</span>
<a name="line-2511"></a>    <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ACoAxiom</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"reifyTypeOfThing: ACoAxiom"</span>
<a name="line-2512"></a>    <span class='hs-conid'>ATcTyCon</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"reifyTypeOfThing: ATcTyCon"</span>
<a name="line-2513"></a>    <span class='hs-conid'>APromotionErr</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"reifyTypeOfThing: APromotionErr"</span>
<a name="line-2514"></a>
<a name="line-2515"></a><a name="lookupThAnnLookup"></a><span class='hs-comment'>------------------------------</span>
<a name="line-2516"></a><span class='hs-definition'>lookupThAnnLookup</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH.AnnLookup</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>CoreAnnTarget</span>
<a name="line-2517"></a><span class='hs-definition'>lookupThAnnLookup</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.AnnLookupName</span> <span class='hs-varid'>th_nm</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-conid'>NamedTarget</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupThName</span> <span class='hs-varid'>th_nm</span><span class='hs-layout'>)</span>
<a name="line-2518"></a><span class='hs-definition'>lookupThAnnLookup</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.AnnLookupModule</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.Module</span> <span class='hs-varid'>pn</span> <span class='hs-varid'>mn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2519"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ModuleTarget</span> <span class='hs-varop'>$</span>
<a name="line-2520"></a>    <span class='hs-varid'>mkModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>stringToUnit</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.pkgString</span> <span class='hs-varid'>pn</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkModuleName</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.modString</span> <span class='hs-varid'>mn</span><span class='hs-layout'>)</span>
<a name="line-2521"></a>
<a name="line-2522"></a><a name="reifyAnnotations"></a><span class='hs-definition'>reifyAnnotations</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Data</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TH.AnnLookup</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-2523"></a><span class='hs-definition'>reifyAnnotations</span> <span class='hs-varid'>th_name</span>
<a name="line-2524"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupThAnnLookup</span> <span class='hs-varid'>th_name</span>
<a name="line-2525"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>topEnv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTopEnv</span>
<a name="line-2526"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>epsHptAnns</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>prepareAnnotations</span> <span class='hs-varid'>topEnv</span> <span class='hs-conid'>Nothing</span>
<a name="line-2527"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-2528"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>selectedEpsHptAnns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findAnns</span> <span class='hs-varid'>deserializeWithData</span> <span class='hs-varid'>epsHptAnns</span> <span class='hs-varid'>name</span>
<a name="line-2529"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>selectedTcgAnns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findAnns</span> <span class='hs-varid'>deserializeWithData</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_ann_env</span> <span class='hs-varid'>tcg</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span>
<a name="line-2530"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>selectedEpsHptAnns</span> <span class='hs-varop'>++</span> <span class='hs-varid'>selectedTcgAnns</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2531"></a>
<a name="line-2532"></a><a name="modToTHMod"></a><span class='hs-comment'>------------------------------</span>
<a name="line-2533"></a><span class='hs-definition'>modToTHMod</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH.Module</span>
<a name="line-2534"></a><span class='hs-definition'>modToTHMod</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH.Module</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.PkgName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unitString</span>  <span class='hs-varop'>$</span> <span class='hs-varid'>moduleUnit</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-2535"></a>                         <span class='hs-layout'>(</span><span class='hs-conid'>TH.ModName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>moduleNameString</span> <span class='hs-varop'>$</span> <span class='hs-varid'>moduleName</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-2536"></a>
<a name="line-2537"></a><a name="reifyModule"></a><span class='hs-definition'>reifyModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH.Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH.ModuleInfo</span>
<a name="line-2538"></a><span class='hs-definition'>reifyModule</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.Module</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.PkgName</span> <span class='hs-varid'>pkgString</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.ModName</span> <span class='hs-varid'>mString</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2539"></a>  <span class='hs-varid'>this_mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-2540"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>reifMod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>stringToUnit</span> <span class='hs-varid'>pkgString</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkModuleName</span> <span class='hs-varid'>mString</span><span class='hs-layout'>)</span>
<a name="line-2541"></a>  <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifMod</span> <span class='hs-varop'>==</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>reifyThisModule</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>reifyFromIface</span> <span class='hs-varid'>reifMod</span>
<a name="line-2542"></a>    <span class='hs-keyword'>where</span>
<a name="line-2543"></a>      <span class='hs-varid'>reifyThisModule</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2544"></a>        <span class='hs-varid'>usages</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>modToTHMod</span> <span class='hs-varop'>.</span> <span class='hs-varid'>moduleEnvKeys</span> <span class='hs-varop'>.</span> <span class='hs-varid'>imp_mods</span><span class='hs-layout'>)</span> <span class='hs-varid'>getImports</span>
<a name="line-2545"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.ModuleInfo</span> <span class='hs-varid'>usages</span>
<a name="line-2546"></a>
<a name="line-2547"></a>      <span class='hs-varid'>reifyFromIface</span> <span class='hs-varid'>reifMod</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2548"></a>        <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loadInterfaceForModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"reifying module from TH for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>reifMod</span><span class='hs-layout'>)</span> <span class='hs-varid'>reifMod</span>
<a name="line-2549"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>usages</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>modToTHMod</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>usage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mi_usages</span> <span class='hs-varid'>iface</span><span class='hs-layout'>,</span>
<a name="line-2550"></a>                                     <span class='hs-conid'>Just</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>usageToModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleUnit</span> <span class='hs-varid'>reifMod</span><span class='hs-layout'>)</span> <span class='hs-varid'>usage</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-2551"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH.ModuleInfo</span> <span class='hs-varid'>usages</span>
<a name="line-2552"></a>
<a name="line-2553"></a>      <span class='hs-varid'>usageToModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unit</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Usage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Module</span>
<a name="line-2554"></a>      <span class='hs-varid'>usageToModule</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UsageFile</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-2555"></a>      <span class='hs-varid'>usageToModule</span> <span class='hs-varid'>this_pkg</span> <span class='hs-layout'>(</span><span class='hs-conid'>UsageHomeModule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>usg_mod_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mn</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkModule</span> <span class='hs-varid'>this_pkg</span> <span class='hs-varid'>mn</span>
<a name="line-2556"></a>      <span class='hs-varid'>usageToModule</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UsagePackageModule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>usg_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>m</span>
<a name="line-2557"></a>      <span class='hs-varid'>usageToModule</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UsageMergedRequirement</span> <span class='hs-layout'>{</span> <span class='hs-varid'>usg_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>m</span>
<a name="line-2558"></a>
<a name="line-2559"></a><a name="mkThAppTs"></a><span class='hs-comment'>------------------------------</span>
<a name="line-2560"></a><span class='hs-definition'>mkThAppTs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH.Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH.Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH.Type</span>
<a name="line-2561"></a><span class='hs-definition'>mkThAppTs</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl'</span> <span class='hs-conid'>TH.AppT</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>arg_tys</span>
<a name="line-2562"></a>
<a name="line-2563"></a><a name="noTH"></a><span class='hs-definition'>noTH</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PtrString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2564"></a><span class='hs-definition'>noTH</span> <span class='hs-varid'>s</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"Can't represent"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-varid'>s</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-2565"></a>                                <span class='hs-varid'>text</span> <span class='hs-str'>"in Template Haskell:"</span><span class='hs-layout'>,</span>
<a name="line-2566"></a>                             <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varid'>d</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2567"></a>
<a name="line-2568"></a><a name="ppr_th"></a><span class='hs-definition'>ppr_th</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH.Ppr</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2569"></a><span class='hs-definition'>ppr_th</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH.pprint</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-2570"></a>
<a name="line-2571"></a><span class='hs-comment'>{-
<a name="line-2572"></a>Note [Reifying field labels]
<a name="line-2573"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2574"></a>When reifying a datatype declared with DuplicateRecordFields enabled, we want
<a name="line-2575"></a>the reified names of the fields to be labels rather than selector functions.
<a name="line-2576"></a>That is, we want (reify ''T) and (reify 'foo) to produce
<a name="line-2577"></a>
<a name="line-2578"></a>    data T = MkT { foo :: Int }
<a name="line-2579"></a>    foo :: T -&gt; Int
<a name="line-2580"></a>
<a name="line-2581"></a>rather than
<a name="line-2582"></a>
<a name="line-2583"></a>    data T = MkT { $sel:foo:MkT :: Int }
<a name="line-2584"></a>    $sel:foo:MkT :: T -&gt; Int
<a name="line-2585"></a>
<a name="line-2586"></a>because otherwise TH code that uses the field names as strings will silently do
<a name="line-2587"></a>the wrong thing.  Thus we use the field label (e.g. foo) as the OccName, rather
<a name="line-2588"></a>than the selector (e.g. $sel:foo:MkT).  Since the Orig name M.foo isn't in the
<a name="line-2589"></a>environment, NameG can't be used to represent such fields.  Instead,
<a name="line-2590"></a>reifyFieldLabel uses NameQ.
<a name="line-2591"></a>
<a name="line-2592"></a>However, this means that extracting the field name from the output of reify, and
<a name="line-2593"></a>trying to reify it again, may fail with an ambiguity error if there are multiple
<a name="line-2594"></a>such fields defined in the module (see the test case
<a name="line-2595"></a>overloadedrecflds/should_fail/T11103.hs).  The "proper" fix requires changes to
<a name="line-2596"></a>the TH AST to make it able to represent duplicate record fields.
<a name="line-2597"></a>-}</span>
<a name="line-2598"></a>
<a name="line-2599"></a><a name="tcGetInterp"></a><span class='hs-definition'>tcGetInterp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Interp</span>
<a name="line-2600"></a><span class='hs-definition'>tcGetInterp</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2601"></a>   <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTopEnv</span>
<a name="line-2602"></a>   <span class='hs-keyword'>case</span> <span class='hs-varid'>hsc_interp</span> <span class='hs-varid'>hsc_env</span> <span class='hs-keyword'>of</span>
<a name="line-2603"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstallationError</span> <span class='hs-str'>"Template haskell requires a target code interpreter"</span><span class='hs-layout'>)</span>
<a name="line-2604"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>i</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>i</span>
</pre></body>
</html>
