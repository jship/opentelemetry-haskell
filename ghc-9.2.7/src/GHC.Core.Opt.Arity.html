<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998


        Arity and eta expansion
-}</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-incomplete-record-updates #-}</span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-comment">-- | Arity and eta expansion</span><span>
</span><span id="line-14"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.Core.Opt.Arity</span><span>
</span><span id="line-15"></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier">manifestArity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#joinRhsArity"><span class="hs-identifier">joinRhsArity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#exprArity"><span class="hs-identifier">exprArity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#typeArity"><span class="hs-identifier">typeArity</span></a></span><span>
</span><span id="line-16"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#exprEtaExpandArity"><span class="hs-identifier">exprEtaExpandArity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#findRhsArity"><span class="hs-identifier">findRhsArity</span></a></span><span>
</span><span id="line-17"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaExpand"><span class="hs-identifier">etaExpand</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaExpandAT"><span class="hs-identifier">etaExpandAT</span></a></span><span>
</span><span id="line-18"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#exprBotStrictness_maybe"><span class="hs-identifier">exprBotStrictness_maybe</span></a></span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span>   </span><span class="annot"><span class="hs-comment">-- ** ArityType</span></span><span>
</span><span id="line-21"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier">ArityType</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#mkBotArityType"><span class="hs-identifier">mkBotArityType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#mkManifestArityType"><span class="hs-identifier">mkManifestArityType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#expandableArityType"><span class="hs-identifier">expandableArityType</span></a></span><span>
</span><span id="line-22"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityTypeArity"><span class="hs-identifier">arityTypeArity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#maxWithArity"><span class="hs-identifier">maxWithArity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#idArityType"><span class="hs-identifier">idArityType</span></a></span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span>   </span><span class="annot"><span class="hs-comment">-- ** Join points</span></span><span>
</span><span id="line-25"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaExpandToJoinPoint"><span class="hs-identifier">etaExpandToJoinPoint</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaExpandToJoinPointRule"><span class="hs-identifier">etaExpandToJoinPointRule</span></a></span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span>   </span><span class="annot"><span class="hs-comment">-- ** Coercions and casts</span></span><span>
</span><span id="line-28"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoArg"><span class="hs-identifier">pushCoArg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoArgs"><span class="hs-identifier">pushCoArgs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoValArg"><span class="hs-identifier">pushCoValArg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoTyArg"><span class="hs-identifier">pushCoTyArg</span></a></span><span>
</span><span id="line-29"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoercionIntoLambda"><span class="hs-identifier">pushCoercionIntoLambda</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoDataCon"><span class="hs-identifier">pushCoDataCon</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#collectBindersPushingCo"><span class="hs-identifier">collectBindersPushingCo</span></a></span><span>
</span><span id="line-30"></span><span>   </span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">where</span><span class="hs-cpp">

#include &quot;HsVersions.h&quot;
</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Ppr.html"><span class="hs-identifier">GHC.Driver.Ppr</span></a></span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html"><span class="hs-identifier">GHC.Core.FVs</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html"><span class="hs-identifier">GHC.Core.Utils</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html"><span class="hs-identifier">GHC.Types.Demand</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span class="hs-comment">-- We have two sorts of substitution:</span><span>
</span><span id="line-48"></span><span class="hs-comment">--   GHC.Core.Subst.Subst, and GHC.Core.TyCo.TCvSubst</span><span>
</span><span id="line-49"></span><span class="hs-comment">-- Both have substTy, substCo  Hence need for qualification</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html"><span class="hs-identifier">GHC.Core.Subst</span></a></span><span>    </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Core</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>     </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Type</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Type</span></span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html"><span class="hs-identifier">GHC.Core.DataCon</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html"><span class="hs-identifier">GHC.Core.TyCon</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#tyConArity"><span class="hs-identifier">tyConArity</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.RecWalk.html"><span class="hs-identifier">GHC.Core.TyCon.RecWalk</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.RecWalk.html#initRecTc"><span class="hs-identifier">initRecTc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.RecWalk.html#checkRecTc"><span class="hs-identifier">checkRecTc</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html"><span class="hs-identifier">GHC.Core.Predicate</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#isDictTy"><span class="hs-identifier">isDictTy</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Multiplicity.html"><span class="hs-identifier">GHC.Core.Multiplicity</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html"><span class="hs-identifier">GHC.Types.Tickish</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Uniques.html"><span class="hs-identifier">GHC.Builtin.Uniques</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html"><span class="hs-identifier">GHC.Driver.Session</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html#DynFlags"><span class="hs-identifier">DynFlags</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Flags.html#GeneralFlag"><span class="hs-identifier">GeneralFlag</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html#gopt"><span class="hs-identifier">gopt</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html"><span class="hs-identifier">GHC.Data.FastString</span></a></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Pair.html"><span class="hs-identifier">GHC.Data.Pair</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
              manifestArity and exprArity
*                                                                      *
************************************************************************

exprArity is a cheap-and-cheerful version of exprEtaExpandArity.
It tells how many things the expression can be applied to before doing
any work.  It doesn't look inside cases, lets, etc.  The idea is that
exprEtaExpandArity will do the hard work, leaving something that's easy
for exprArity to grapple with.  In particular, Simplify uses exprArity to
compute the ArityInfo for the Id.

Originally I thought that it was enough just to look for top-level lambdas, but
it isn't.  I've seen this

        foo = PrelBase.timesInt

We want foo to get arity 2 even though the eta-expander will leave it
unchanged, in the expectation that it'll be inlined.  But occasionally it
isn't, because foo is blacklisted (used in a rule).

Similarly, see the ok_note check in exprEtaExpandArity.  So
        f = __inline_me (\x -&gt; e)
won't be eta-expanded.

And in any case it seems more robust to have exprArity be a bit more intelligent.
But note that   (\x y z -&gt; f x y z)
should have arity 3, regardless of f's arity.
-}</span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier hs-type">manifestArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span>
</span><span id="line-102"></span><span class="hs-comment">-- ^ manifestArity sees how many leading value lambdas there are,</span><span>
</span><span id="line-103"></span><span class="hs-comment">--   after looking through casts</span><span>
</span><span id="line-104"></span><span id="manifestArity"><span class="annot"><span class="annottext">manifestArity :: CoreExpr -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier hs-var hs-var">manifestArity</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621681063375"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063375"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621681063374"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063374"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063375"><span class="hs-identifier hs-var">v</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.16.4.0/src/GHC-Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier hs-var">manifestArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063374"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-105"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier hs-var">manifestArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063374"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-106"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier hs-var">manifestArity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621681063370"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681063370"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621681063369"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063369"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishIsCode"><span class="hs-identifier hs-var">tickishIsCode</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681063370"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier hs-var">manifestArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063369"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-107"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier hs-var">manifestArity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621681063365"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063365"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier hs-var">manifestArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063365"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-108"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier hs-var">manifestArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#joinRhsArity"><span class="hs-identifier hs-type">joinRhsArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#JoinArity"><span class="hs-identifier hs-type">JoinArity</span></a></span><span>
</span><span id="line-111"></span><span class="hs-comment">-- Join points are supposed to have manifestly-visible</span><span>
</span><span id="line-112"></span><span class="hs-comment">-- lambdas at the top: no ticks, no casts, nothing</span><span>
</span><span id="line-113"></span><span class="hs-comment">-- Moreover, type lambdas count in JoinArity</span><span>
</span><span id="line-114"></span><span id="joinRhsArity"><span class="annot"><span class="annottext">joinRhsArity :: CoreExpr -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#joinRhsArity"><span class="hs-identifier hs-var hs-var">joinRhsArity</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681063363"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063363"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.16.4.0/src/GHC-Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#joinRhsArity"><span class="hs-identifier hs-var">joinRhsArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063363"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-115"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#joinRhsArity"><span class="hs-identifier hs-var">joinRhsArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span>
</span><span id="line-118"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-119"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#exprArity"><span class="hs-identifier hs-type">exprArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span>
</span><span id="line-120"></span><span class="hs-comment">-- ^ An approximate, fast, version of 'exprEtaExpandArity'</span><span>
</span><span id="line-121"></span><span id="exprArity"><span class="annot"><span class="annottext">exprArity :: CoreExpr -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#exprArity"><span class="hs-identifier hs-var hs-var">exprArity</span></a></span></span><span> </span><span id="local-6989586621681063362"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063362"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="#local-6989586621681063361"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063362"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-123"></span><span>    </span><span id="local-6989586621681063361"><span class="annot"><span class="annottext">go :: CoreExpr -&gt; Int
</span><a href="#local-6989586621681063361"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681063352"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063352"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Int
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063352"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><a href="#local-6989586621681063361"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621681063350"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063350"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621681063349"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063349"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063350"><span class="hs-identifier hs-var">x</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="#local-6989586621681063361"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063349"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.16.4.0/src/GHC-Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-125"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="#local-6989586621681063361"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063349"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-126"></span><span>    </span><span class="annot"><a href="#local-6989586621681063361"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621681063348"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681063348"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621681063347"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063347"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishIsCode"><span class="hs-identifier hs-var">tickishIsCode</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681063348"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="#local-6989586621681063361"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063347"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-127"></span><span>    </span><span class="annot"><a href="#local-6989586621681063361"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621681063346"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063346"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621681063345"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681063345"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type -&gt; Int
</span><a href="#local-6989586621681063344"><span class="hs-identifier hs-var">trim_arity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="#local-6989586621681063361"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063346"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionRKind"><span class="hs-identifier hs-var">coercionRKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681063345"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span>                                        </span><span class="hs-comment">-- Note [exprArity invariant]</span><span>
</span><span id="line-129"></span><span>    </span><span class="annot"><a href="#local-6989586621681063361"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621681063341"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063341"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="#local-6989586621681063361"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063341"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-130"></span><span>    </span><span class="annot"><a href="#local-6989586621681063361"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621681063339"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063339"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621681063338"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063338"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063338"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="#local-6989586621681063361"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063339"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.16.4.0/src/GHC-Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`max`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-131"></span><span>        </span><span class="hs-comment">-- See Note [exprArity for applications]</span><span>
</span><span id="line-132"></span><span>        </span><span class="hs-comment">-- NB: coercions count as a value argument</span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span>    </span><span class="annot"><a href="#local-6989586621681063361"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span>                           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span>    </span><span class="annot"><a href="#local-6989586621681063344"><span class="hs-identifier hs-type">trim_arity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span>
</span><span id="line-137"></span><span>    </span><span id="local-6989586621681063344"><span class="annot"><span class="annottext">trim_arity :: Int -&gt; Type -&gt; Int
</span><a href="#local-6989586621681063344"><span class="hs-identifier hs-var hs-var">trim_arity</span></a></span></span><span> </span><span id="local-6989586621681063335"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063335"><span class="hs-identifier hs-var">arity</span></a></span></span><span> </span><span id="local-6989586621681063334"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681063334"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063335"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`min`</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../../base-4.16.4.0/src/Data-Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; [OneShotInfo]
</span><a href="GHC.Core.Opt.Arity.html#typeArity"><span class="hs-identifier hs-var">typeArity</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681063334"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-140"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#typeArity"><span class="hs-identifier hs-type">typeArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Basic.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-141"></span><span class="hs-comment">-- How many value arrows are visible in the type?</span><span>
</span><span id="line-142"></span><span class="hs-comment">-- We look through foralls, and newtypes</span><span>
</span><span id="line-143"></span><span class="hs-comment">-- See Note [exprArity invariant]</span><span>
</span><span id="line-144"></span><span id="typeArity"><span class="annot"><span class="annottext">typeArity :: Type -&gt; [OneShotInfo]
</span><a href="GHC.Core.Opt.Arity.html#typeArity"><span class="hs-identifier hs-var hs-var">typeArity</span></a></span></span><span> </span><span id="local-6989586621681063331"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681063331"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-145"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecTcChecker -&gt; Type -&gt; [OneShotInfo]
</span><a href="#local-6989586621681063330"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="GHC.Core.TyCon.RecWalk.html#initRecTc"><span class="hs-identifier hs-var">initRecTc</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681063331"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-147"></span><span>    </span><span id="local-6989586621681063330"><span class="annot"><span class="annottext">go :: RecTcChecker -&gt; Type -&gt; [OneShotInfo]
</span><a href="#local-6989586621681063330"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681063328"><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621681063328"><span class="hs-identifier hs-var">rec_nts</span></a></span></span><span> </span><span id="local-6989586621681063327"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681063327"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-148"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681063326"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681063326"><span class="hs-identifier hs-var">ty'</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (TyVar, Type)
</span><a href="GHC.Core.Type.html#splitForAllTyCoVar_maybe"><span class="hs-identifier hs-var">splitForAllTyCoVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681063327"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-149"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecTcChecker -&gt; Type -&gt; [OneShotInfo]
</span><a href="#local-6989586621681063330"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621681063328"><span class="hs-identifier hs-var">rec_nts</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681063326"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621681063324"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681063324"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681063323"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681063323"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (Type, Type, Type)
</span><a href="GHC.Core.Type.html#splitFunTy_maybe"><span class="hs-identifier hs-var">splitFunTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681063327"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-152"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; OneShotInfo
</span><a href="GHC.Types.Id.html#typeOneShot"><span class="hs-identifier hs-var">typeOneShot</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681063324"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">RecTcChecker -&gt; Type -&gt; [OneShotInfo]
</span><a href="#local-6989586621681063330"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621681063328"><span class="hs-identifier hs-var">rec_nts</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681063323"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681063320"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681063320"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681063319"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681063319"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Maybe (TyCon, [Type])
</span><a href="GHC.Core.Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681063327"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-155"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681063317"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681063317"><span class="hs-identifier hs-var">ty'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; Maybe (Type, Coercion)
</span><a href="GHC.Core.Coercion.html#instNewTyCon_maybe"><span class="hs-identifier hs-var">instNewTyCon_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681063320"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681063319"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-156"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681063315"><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621681063315"><span class="hs-identifier hs-var">rec_nts'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RecTcChecker -&gt; TyCon -&gt; Maybe RecTcChecker
</span><a href="GHC.Core.TyCon.RecWalk.html#checkRecTc"><span class="hs-identifier hs-var">checkRecTc</span></a></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621681063328"><span class="hs-identifier hs-var">rec_nts</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681063320"><span class="hs-identifier hs-var">tc</span></a></span><span>  </span><span class="hs-comment">-- See Note [Expanding newtypes]</span><span>
</span><span id="line-157"></span><span>                                                </span><span class="hs-comment">-- in GHC.Core.TyCon</span><span>
</span><span id="line-158"></span><span class="hs-comment">--   , not (isClassTyCon tc)    -- Do not eta-expand through newtype classes</span><span>
</span><span id="line-159"></span><span class="hs-comment">--                              -- See Note [Newtype classes and eta expansion]</span><span>
</span><span id="line-160"></span><span class="hs-comment">--                              (no longer required)</span><span>
</span><span id="line-161"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecTcChecker -&gt; Type -&gt; [OneShotInfo]
</span><a href="#local-6989586621681063330"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RecTcChecker
</span><a href="#local-6989586621681063315"><span class="hs-identifier hs-var">rec_nts'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681063317"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-162"></span><span>        </span><span class="hs-comment">-- Important to look through non-recursive newtypes, so that, eg</span><span>
</span><span id="line-163"></span><span>        </span><span class="hs-comment">--      (f x)   where f has arity 2, f :: Int -&gt; IO ()</span><span>
</span><span id="line-164"></span><span>        </span><span class="hs-comment">-- Here we want to get arity 1 for the result!</span><span>
</span><span id="line-165"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-166"></span><span>        </span><span class="hs-comment">-- AND through a layer of recursive newtypes</span><span>
</span><span id="line-167"></span><span>        </span><span class="hs-comment">-- e.g. newtype Stream m a b = Stream (m (Either b (a, Stream m a b)))</span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-170"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-171"></span><span>
</span><span id="line-172"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-173"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#exprBotStrictness_maybe"><span class="hs-identifier hs-type">exprBotStrictness_maybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span class="hs-comment">-- A cheap and cheerful function that identifies bottoming functions</span><span>
</span><span id="line-175"></span><span class="hs-comment">-- and gives them a suitable strictness signatures.  It's used during</span><span>
</span><span id="line-176"></span><span class="hs-comment">-- float-out</span><span>
</span><span id="line-177"></span><span id="exprBotStrictness_maybe"><span class="annot"><span class="annottext">exprBotStrictness_maybe :: CoreExpr -&gt; Maybe (Int, StrictSig)
</span><a href="GHC.Core.Opt.Arity.html#exprBotStrictness_maybe"><span class="hs-identifier hs-var hs-var">exprBotStrictness_maybe</span></a></span></span><span> </span><span id="local-6989586621681063314"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063314"><span class="hs-identifier hs-var">e</span></a></span></span><span>
</span><span id="line-178"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ArityType -&gt; Maybe Int
</span><a href="GHC.Core.Opt.Arity.html#getBotArity"><span class="hs-identifier hs-var">getBotArity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#botStrictnessArityEnv"><span class="hs-identifier hs-var">botStrictnessArityEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063314"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-179"></span><span>        </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-180"></span><span>        </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681063310"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063310"><span class="hs-identifier hs-var">ar</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063310"><span class="hs-identifier hs-var">ar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; StrictSig
</span><a href="#local-6989586621681063309"><span class="hs-identifier hs-var">sig</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063310"><span class="hs-identifier hs-var">ar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-182"></span><span>    </span><span id="local-6989586621681063309"><span class="annot"><span class="annottext">sig :: Int -&gt; StrictSig
</span><a href="#local-6989586621681063309"><span class="hs-identifier hs-var hs-var">sig</span></a></span></span><span> </span><span id="local-6989586621681063308"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063308"><span class="hs-identifier hs-var">ar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Demand] -&gt; Divergence -&gt; StrictSig
</span><a href="GHC.Types.Demand.html#mkClosedStrictSig"><span class="hs-identifier hs-var">mkClosedStrictSig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Int -&gt; a -&gt; [a]
</span><a href="../../base-4.16.4.0/src/GHC-List.html#replicate"><span class="hs-identifier hs-var">replicate</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063308"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#botDiv"><span class="hs-identifier hs-var">botDiv</span></a></span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span class="hs-comment">{-
Note [exprArity invariant]
~~~~~~~~~~~~~~~~~~~~~~~~~~
exprArity has the following invariants:

  (1) If typeArity (exprType e) = n,
      then manifestArity (etaExpand e n) = n

      That is, etaExpand can always expand as much as typeArity says
      So the case analysis in etaExpand and in typeArity must match

  (2) exprArity e &lt;= typeArity (exprType e)

  (3) Hence if (exprArity e) = n, then manifestArity (etaExpand e n) = n

      That is, if exprArity says &quot;the arity is n&quot; then etaExpand really
      can get &quot;n&quot; manifest lambdas to the top.

Why is this important?  Because
  - In GHC.Iface.Tidy we use exprArity to fix the *final arity* of
    each top-level Id, and in
  - In CorePrep we use etaExpand on each rhs, so that the visible lambdas
    actually match that arity, which in turn means
    that the StgRhs has the right number of lambdas

An alternative would be to do the eta-expansion in GHC.Iface.Tidy, at least
for top-level bindings, in which case we would not need the trim_arity
in exprArity.  That is a less local change, so I'm going to leave it for today!

Note [Newtype classes and eta expansion]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    NB: this nasty special case is no longer required, because
    for newtype classes we don't use the class-op rule mechanism
    at all.  See Note [Single-method classes] in GHC.Tc.TyCl.Instance. SLPJ May 2013

-------- Old out of date comments, just for interest -----------
We have to be careful when eta-expanding through newtypes.  In general
it's a good idea, but annoyingly it interacts badly with the class-op
rule mechanism.  Consider

   class C a where { op :: a -&gt; a }
   instance C b =&gt; C [b] where
     op x = ...

These translate to

   co :: forall a. (a-&gt;a) ~ C a

   $copList :: C b -&gt; [b] -&gt; [b]
   $copList d x = ...

   $dfList :: C b -&gt; C [b]
   {-# DFunUnfolding = [$copList] #-}
   $dfList d = $copList d |&gt; co@[b]

Now suppose we have:

   dCInt :: C Int

   blah :: [Int] -&gt; [Int]
   blah = op ($dfList dCInt)

Now we want the built-in op/$dfList rule will fire to give
   blah = $copList dCInt

But with eta-expansion 'blah' might (and in #3772, which is
slightly more complicated, does) turn into

   blah = op (\eta. ($dfList dCInt |&gt; sym co) eta)

and now it is *much* harder for the op/$dfList rule to fire, because
exprIsConApp_maybe won't hold of the argument to op.  I considered
trying to *make* it hold, but it's tricky and I gave up.

The test simplCore/should_compile/T3722 is an excellent example.
-------- End of old out of date comments, just for interest -----------


Note [exprArity for applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we come to an application we check that the arg is trivial.
   eg  f (fac x) does not have arity 2,
                 even if f has arity 3!

* We require that is trivial rather merely cheap.  Suppose f has arity 2.
  Then    f (Just y)
  has arity 0, because if we gave it arity 1 and then inlined f we'd get
          let v = Just y in \w. &lt;f-body&gt;
  which has arity 0.  And we try to maintain the invariant that we don't
  have arity decreases.

*  The `max 0` is important!  (\x y -&gt; f x) has arity 2, even if f is
   unknown, hence arity 0


************************************************************************
*                                                                      *
           Computing the &quot;arity&quot; of an expression
*                                                                      *
************************************************************************

Note [Definition of arity]
~~~~~~~~~~~~~~~~~~~~~~~~~~
The &quot;arity&quot; of an expression 'e' is n if
   applying 'e' to *fewer* than n *value* arguments
   converges rapidly

Or, to put it another way

   there is no work lost in duplicating the partial
   application (e x1 .. x(n-1))

In the divergent case, no work is lost by duplicating because if the thing
is evaluated once, that's the end of the program.

Or, to put it another way, in any context C

   C[ (\x1 .. xn. e x1 .. xn) ]
         is as efficient as
   C[ e ]

It's all a bit more subtle than it looks:

Note [One-shot lambdas]
~~~~~~~~~~~~~~~~~~~~~~~
Consider one-shot lambdas
                let x = expensive in \y z -&gt; E
We want this to have arity 1 if the \y-abstraction is a 1-shot lambda.

Note [Dealing with bottom]
~~~~~~~~~~~~~~~~~~~~~~~~~~
A Big Deal with computing arities is expressions like

   f = \x -&gt; case x of
               True  -&gt; \s -&gt; e1
               False -&gt; \s -&gt; e2

This happens all the time when f :: Bool -&gt; IO ()
In this case we do eta-expand, in order to get that \s to the
top, and give f arity 2.

This isn't really right in the presence of seq.  Consider
        (f bot) `seq` 1

This should diverge!  But if we eta-expand, it won't.  We ignore this
&quot;problem&quot; (unless -fpedantic-bottoms is on), because being scrupulous
would lose an important transformation for many programs. (See
#5587 for an example.)

Consider also
        f = \x -&gt; error &quot;foo&quot;
Here, arity 1 is fine.  But if it is
        f = \x -&gt; case x of
                        True  -&gt; error &quot;foo&quot;
                        False -&gt; \y -&gt; x+y
then we want to get arity 2.  Technically, this isn't quite right, because
        (f True) `seq` 1
should diverge, but it'll converge if we eta-expand f.  Nevertheless, we
do so; it improves some programs significantly, and increasing convergence
isn't a bad thing.  Hence the ABot/ATop in ArityType.

So these two transformations aren't always the Right Thing, and we
have several tickets reporting unexpected behaviour resulting from
this transformation.  So we try to limit it as much as possible:

 (1) Do NOT move a lambda outside a known-bottom case expression
       case undefined of { (a,b) -&gt; \y -&gt; e }
     This showed up in #5557

 (2) Do NOT move a lambda outside a case unless
     (a) The scrutinee is ok-for-speculation, or
     (b) more liberally: the scrutinee is cheap (e.g. a variable), and
         -fpedantic-bottoms is not enforced (see #2915 for an example)

Of course both (1) and (2) are readily defeated by disguising the bottoms.

4. Note [Newtype arity]
~~~~~~~~~~~~~~~~~~~~~~~~
Non-recursive newtypes are transparent, and should not get in the way.
We do (currently) eta-expand recursive newtypes too.  So if we have, say

        newtype T = MkT ([T] -&gt; Int)

Suppose we have
        e = coerce T f
where f has arity 1.  Then: etaExpandArity e = 1;
that is, etaExpandArity looks through the coerce.

When we eta-expand e to arity 1: eta_expand 1 e T
we want to get:                  coerce T (\x::[T] -&gt; (coerce ([T]-&gt;Int) e) x)

  HOWEVER, note that if you use coerce bogusly you can ge
        coerce Int negate
  And since negate has arity 2, you might try to eta expand.  But you can't
  decompose Int to a function type.   Hence the final case in eta_expand.

Note [The state-transformer hack]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have
        f = e
where e has arity n.  Then, if we know from the context that f has
a usage type like
        t1 -&gt; ... -&gt; tn -1-&gt; t(n+1) -1-&gt; ... -1-&gt; tm -&gt; ...
then we can expand the arity to m.  This usage type says that
any application (x e1 .. en) will be applied to uniquely to (m-n) more args
Consider f = \x. let y = &lt;expensive&gt;
                 in case x of
                      True  -&gt; foo
                      False -&gt; \(s:RealWorld) -&gt; e
where foo has arity 1.  Then we want the state hack to
apply to foo too, so we can eta expand the case.

Then we expect that if f is applied to one arg, it'll be applied to two
(that's the hack -- we don't really know, and sometimes it's false)
See also Id.isOneShotBndr.

Note [State hack and bottoming functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's a terrible idea to use the state hack on a bottoming function.
Here's what happens (#2861):

  f :: String -&gt; IO T
  f = \p. error &quot;...&quot;

Eta-expand, using the state hack:

  f = \p. (\s. ((error &quot;...&quot;) |&gt; g1) s) |&gt; g2
  g1 :: IO T ~ (S -&gt; (S,T))
  g2 :: (S -&gt; (S,T)) ~ IO T

Extrude the g2

  f' = \p. \s. ((error &quot;...&quot;) |&gt; g1) s
  f = f' |&gt; (String -&gt; g2)

Discard args for bottomming function

  f' = \p. \s. ((error &quot;...&quot;) |&gt; g1 |&gt; g3
  g3 :: (S -&gt; (S,T)) ~ (S,T)

Extrude g1.g3

  f'' = \p. \s. (error &quot;...&quot;)
  f' = f'' |&gt; (String -&gt; S -&gt; g1.g3)

And now we can repeat the whole loop.  Aargh!  The bug is in applying the
state hack to a function which then swallows the argument.

This arose in another guise in #3959.  Here we had

     catch# (throw exn &gt;&gt; return ())

Note that (throw :: forall a e. Exn e =&gt; e -&gt; a) is called with [a = IO ()].
After inlining (&gt;&gt;) we get

     catch# (\_. throw {IO ()} exn)

We must *not* eta-expand to

     catch# (\_ _. throw {...} exn)

because 'catch#' expects to get a (# _,_ #) after applying its argument to
a State#, not another function!

In short, we use the state hack to allow us to push let inside a lambda,
but not to introduce a new lambda.


Note [ArityType]
~~~~~~~~~~~~~~~~
ArityType is the result of a compositional analysis on expressions,
from which we can decide the real arity of the expression (extracted
with function exprEtaExpandArity).

We use the following notation:
  at  ::= \o1..on.div
  div ::= T | x | &#8869;
  o   ::= ? | 1
And omit the \. if n = 0. Examples:
  \?11.T stands for @AT [NoOneShotInfo,OneShotLam,OneShotLam] topDiv@
  &#8869;      stands for @AT [] botDiv@
See the 'Outputable' instance for more information. It's pretty simple.

Here is what the fields mean. If an arbitrary expression 'f' has
ArityType 'at', then

 * If @at = AT [o1,..,on] botDiv@ (notation: \o1..on.&#8869;), then @f x1..xn@
   definitely diverges. Partial applications to fewer than n args may *or
   may not* diverge.

   We allow ourselves to eta-expand bottoming functions, even
   if doing so may lose some `seq` sharing,
       let x = &lt;expensive&gt; in \y. error (g x y)
       ==&gt; \y. let x = &lt;expensive&gt; in error (g x y)

 * If @at = AT [o1,..,on] topDiv@ (notation: \o1..on.T), then expanding 'f'
   to @\x1..xn. f x1..xn@ loses no sharing, assuming the calls of f respect
   the one-shot-ness o1..on of its definition.

   NB 'f' is an arbitrary expression, eg @f = g e1 e2@.  This 'f' can have
   arity type @AT oss _@, with @length oss &gt; 0@, only if e1 e2 are themselves
   cheap.

 * In both cases, @f@, @f x1@, ... @f x1 ... x(n-1)@ are definitely
   really functions, or bottom, but *not* casts from a data type, in
   at least one case branch.  (If it's a function in one case branch but
   an unsafe cast from a data type in another, the program is bogus.)
   So eta expansion is dynamically ok; see Note [State hack and
   bottoming functions], the part about catch#

Example:
      f = \x\y. let v = &lt;expensive&gt; in
          \s(one-shot) \t(one-shot). blah
      'f' has arity type \??11.T
      The one-shot-ness means we can, in effect, push that
      'let' inside the \st.


Suppose f = \xy. x+y
Then  f             :: \??.T
      f v           :: \?.T
      f &lt;expensive&gt; :: T
-}</span><span>
</span><span id="line-507"></span><span>
</span><span id="line-508"></span><span>
</span><span id="line-509"></span><span class="hs-comment">-- | The analysis lattice of arity analysis. It is isomorphic to</span><span>
</span><span id="line-510"></span><span class="hs-comment">--</span><span>
</span><span id="line-511"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-512"></span><span class="hs-comment">--    data ArityType'</span><span>
</span><span id="line-513"></span><span class="hs-comment">--      = AEnd Divergence</span><span>
</span><span id="line-514"></span><span class="hs-comment">--      | ALam OneShotInfo ArityType'</span><span>
</span><span id="line-515"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-516"></span><span class="hs-comment">--</span><span>
</span><span id="line-517"></span><span class="hs-comment">-- Which is easier to display the Hasse diagram for:</span><span>
</span><span id="line-518"></span><span class="hs-comment">--</span><span>
</span><span id="line-519"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-520"></span><span class="hs-comment">--  ALam OneShotLam at</span><span>
</span><span id="line-521"></span><span class="hs-comment">--          |</span><span>
</span><span id="line-522"></span><span class="hs-comment">--      AEnd topDiv</span><span>
</span><span id="line-523"></span><span class="hs-comment">--          |</span><span>
</span><span id="line-524"></span><span class="hs-comment">--  ALam NoOneShotInfo at</span><span>
</span><span id="line-525"></span><span class="hs-comment">--          |</span><span>
</span><span id="line-526"></span><span class="hs-comment">--      AEnd exnDiv</span><span>
</span><span id="line-527"></span><span class="hs-comment">--          |</span><span>
</span><span id="line-528"></span><span class="hs-comment">--      AEnd botDiv</span><span>
</span><span id="line-529"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-530"></span><span class="hs-comment">--</span><span>
</span><span id="line-531"></span><span class="hs-comment">-- where the @at@ fields of @ALam@ are inductively subject to the same order.</span><span>
</span><span id="line-532"></span><span class="hs-comment">-- That is, @ALam os at1 &lt; ALam os at2@ iff @at1 &lt; at2@.</span><span>
</span><span id="line-533"></span><span class="hs-comment">--</span><span>
</span><span id="line-534"></span><span class="hs-comment">-- Why the strange Top element?</span><span>
</span><span id="line-535"></span><span class="hs-comment">--   See Note [Combining case branches: optimistic one-shot-ness]</span><span>
</span><span id="line-536"></span><span class="hs-comment">--</span><span>
</span><span id="line-537"></span><span class="hs-comment">-- We rely on this lattice structure for fixed-point iteration in</span><span>
</span><span id="line-538"></span><span class="hs-comment">-- 'findRhsArity'. For the semantics of 'ArityType', see Note [ArityType].</span><span>
</span><span id="line-539"></span><span class="hs-keyword">data</span><span> </span><span id="ArityType"><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-var">ArityType</span></a></span></span><span>
</span><span id="line-540"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="AT"><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Basic.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Types.Demand.html#Divergence"><span class="hs-identifier hs-type">Divergence</span></a></span><span>
</span><span id="line-541"></span><span>  </span><span class="hs-comment">-- ^ @AT oss div@ means this value can safely be eta-expanded @length oss@</span><span>
</span><span id="line-542"></span><span>  </span><span class="hs-comment">-- times, provided use sites respect the 'OneShotInfo's in @oss@.</span><span>
</span><span id="line-543"></span><span>  </span><span class="hs-comment">-- A 'OneShotLam' annotation can come from two sources:</span><span>
</span><span id="line-544"></span><span>  </span><span class="hs-comment">--     * The user annotated a lambda as one-shot with 'GHC.Exts.oneShot'</span><span>
</span><span id="line-545"></span><span>  </span><span class="hs-comment">--     * It's from a lambda binder of a type affected by `-fstate-hack`.</span><span>
</span><span id="line-546"></span><span>  </span><span class="hs-comment">--       See 'idStateHackOneShotInfo'.</span><span>
</span><span id="line-547"></span><span>  </span><span class="hs-comment">-- In both cases, 'OneShotLam' should win over 'NoOneShotInfo', see</span><span>
</span><span id="line-548"></span><span>  </span><span class="hs-comment">-- Note [Combining case branches].</span><span>
</span><span id="line-549"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-550"></span><span>  </span><span class="hs-comment">-- If @div@ is dead-ending ('isDeadEndDiv'), then application to</span><span>
</span><span id="line-551"></span><span>  </span><span class="hs-comment">-- @length os@ arguments will surely diverge, similar to the situation</span><span>
</span><span id="line-552"></span><span>  </span><span class="hs-comment">-- with 'DmdType'.</span><span>
</span><span id="line-553"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621681063294"><span id="local-6989586621681063301"><span class="annot"><span class="annottext">ArityType -&gt; ArityType -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: ArityType -&gt; ArityType -&gt; Bool
$c/= :: ArityType -&gt; ArityType -&gt; Bool
== :: ArityType -&gt; ArityType -&gt; Bool
$c== :: ArityType -&gt; ArityType -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span>
</span><span id="line-554"></span><span>
</span><span id="line-555"></span><span class="hs-comment">-- | This is the BNF of the generated output:</span><span>
</span><span id="line-556"></span><span class="hs-comment">--</span><span>
</span><span id="line-557"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-558"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-559"></span><span class="hs-comment">--</span><span>
</span><span id="line-560"></span><span class="hs-comment">-- We format</span><span>
</span><span id="line-561"></span><span class="hs-comment">-- @AT [o1,..,on] topDiv@ as @\o1..on.T@ and</span><span>
</span><span id="line-562"></span><span class="hs-comment">-- @AT [o1,..,on] botDiv@ as @\o1..on.&#8869;@, respectively.</span><span>
</span><span id="line-563"></span><span class="hs-comment">-- More concretely, @AT [NOI,OS,OS] topDiv@ is formatted as @\?11.T@.</span><span>
</span><span id="line-564"></span><span class="hs-comment">-- If the one-shot info is empty, we omit the leading @\.@.</span><span>
</span><span id="line-565"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-566"></span><span>  </span><span id="local-6989586621681063288"><span class="annot"><span class="annottext">ppr :: ArityType -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621681063286"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063286"><span class="hs-identifier hs-var">oss</span></a></span></span><span> </span><span id="local-6989586621681063285"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063285"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-567"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.16.4.0/src/Data-Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063286"><span class="hs-identifier hs-var">oss</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Divergence -&gt; SDoc
</span><a href="#local-6989586621681063283"><span class="hs-identifier hs-var">pp_div</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063285"><span class="hs-identifier hs-var">div</span></a></span><span>
</span><span id="line-568"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Char -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#char"><span class="hs-identifier hs-var">char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'\\'</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hcat"><span class="hs-identifier hs-var">hcat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">OneShotInfo -&gt; SDoc
</span><a href="#local-6989586621681063279"><span class="hs-identifier hs-var">pp_os</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063286"><span class="hs-identifier hs-var">oss</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="GHC.Utils.Outputable.html#dot"><span class="hs-identifier hs-var">dot</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence -&gt; SDoc
</span><a href="#local-6989586621681063283"><span class="hs-identifier hs-var">pp_div</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063285"><span class="hs-identifier hs-var">div</span></a></span><span>
</span><span id="line-569"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-570"></span><span>      </span><span id="local-6989586621681063283"><span class="annot"><span class="annottext">pp_div :: Divergence -&gt; SDoc
</span><a href="#local-6989586621681063283"><span class="hs-identifier hs-var hs-var">pp_div</span></a></span></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#Diverges"><span class="hs-identifier hs-var">Diverges</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Char -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#char"><span class="hs-identifier hs-var">char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'&#8869;'</span></span><span>
</span><span id="line-571"></span><span>      </span><span class="annot"><a href="#local-6989586621681063283"><span class="hs-identifier hs-var">pp_div</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#ExnOrDiv"><span class="hs-identifier hs-var">ExnOrDiv</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Char -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#char"><span class="hs-identifier hs-var">char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'x'</span></span><span>
</span><span id="line-572"></span><span>      </span><span class="annot"><a href="#local-6989586621681063283"><span class="hs-identifier hs-var">pp_div</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Char -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#char"><span class="hs-identifier hs-var">char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'T'</span></span><span>
</span><span id="line-573"></span><span>      </span><span id="local-6989586621681063279"><span class="annot"><span class="annottext">pp_os :: OneShotInfo -&gt; SDoc
</span><a href="#local-6989586621681063279"><span class="hs-identifier hs-var hs-var">pp_os</span></a></span></span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="GHC.Types.Basic.html#OneShotLam"><span class="hs-identifier hs-var">OneShotLam</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Char -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#char"><span class="hs-identifier hs-var">char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'1'</span></span><span>
</span><span id="line-574"></span><span>      </span><span class="annot"><a href="#local-6989586621681063279"><span class="hs-identifier hs-var">pp_os</span></a></span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="GHC.Types.Basic.html#NoOneShotInfo"><span class="hs-identifier hs-var">NoOneShotInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Char -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#char"><span class="hs-identifier hs-var">char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'?'</span></span><span>
</span><span id="line-575"></span><span>
</span><span id="line-576"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#mkBotArityType"><span class="hs-identifier hs-type">mkBotArityType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Basic.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-577"></span><span id="mkBotArityType"><span class="annot"><span class="annottext">mkBotArityType :: [OneShotInfo] -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#mkBotArityType"><span class="hs-identifier hs-var hs-var">mkBotArityType</span></a></span></span><span> </span><span id="local-6989586621681063272"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063272"><span class="hs-identifier hs-var">oss</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; Divergence -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063272"><span class="hs-identifier hs-var">oss</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#botDiv"><span class="hs-identifier hs-var">botDiv</span></a></span><span>
</span><span id="line-578"></span><span>
</span><span id="line-579"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#botArityType"><span class="hs-identifier hs-type">botArityType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-580"></span><span id="botArityType"><span class="annot"><span class="annottext">botArityType :: ArityType
</span><a href="GHC.Core.Opt.Arity.html#botArityType"><span class="hs-identifier hs-var hs-var">botArityType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#mkBotArityType"><span class="hs-identifier hs-var">mkBotArityType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-581"></span><span>
</span><span id="line-582"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#mkManifestArityType"><span class="hs-identifier hs-type">mkManifestArityType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-583"></span><span id="mkManifestArityType"><span class="annot"><span class="annottext">mkManifestArityType :: [TyVar] -&gt; CoreExpr -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#mkManifestArityType"><span class="hs-identifier hs-var hs-var">mkManifestArityType</span></a></span></span><span> </span><span id="local-6989586621681063269"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681063269"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621681063268"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063268"><span class="hs-identifier hs-var">body</span></a></span></span><span>
</span><span id="line-584"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; Divergence -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063267"><span class="hs-identifier hs-var">oss</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063266"><span class="hs-identifier hs-var">div</span></a></span><span>
</span><span id="line-585"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-586"></span><span>    </span><span id="local-6989586621681063267"><span class="annot"><span class="annottext">oss :: [OneShotInfo]
</span><a href="#local-6989586621681063267"><span class="hs-identifier hs-var hs-var">oss</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TyVar -&gt; OneShotInfo
</span><a href="GHC.Types.Id.html#idOneShotInfo"><span class="hs-identifier hs-var">idOneShotInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063264"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621681063264"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063264"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681063269"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063264"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-587"></span><span>    </span><span id="local-6989586621681063266"><span class="annot"><span class="annottext">div :: Divergence
</span><a href="#local-6989586621681063266"><span class="hs-identifier hs-var hs-var">div</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsDeadEnd"><span class="hs-identifier hs-var">exprIsDeadEnd</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063268"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#botDiv"><span class="hs-identifier hs-var">botDiv</span></a></span><span>
</span><span id="line-588"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#topDiv"><span class="hs-identifier hs-var">topDiv</span></a></span><span>
</span><span id="line-589"></span><span>
</span><span id="line-590"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#topArityType"><span class="hs-identifier hs-type">topArityType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-591"></span><span id="topArityType"><span class="annot"><span class="annottext">topArityType :: ArityType
</span><a href="GHC.Core.Opt.Arity.html#topArityType"><span class="hs-identifier hs-var hs-var">topArityType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; Divergence -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#topDiv"><span class="hs-identifier hs-var">topDiv</span></a></span><span>
</span><span id="line-592"></span><span>
</span><span id="line-593"></span><span class="hs-comment">-- | The number of value args for the arity type</span><span>
</span><span id="line-594"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityTypeArity"><span class="hs-identifier hs-type">arityTypeArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span>
</span><span id="line-595"></span><span id="arityTypeArity"><span class="annot"><span class="annottext">arityTypeArity :: ArityType -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#arityTypeArity"><span class="hs-identifier hs-var hs-var">arityTypeArity</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621681063260"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063260"><span class="hs-identifier hs-var">oss</span></a></span></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../../base-4.16.4.0/src/Data-Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063260"><span class="hs-identifier hs-var">oss</span></a></span><span>
</span><span id="line-596"></span><span>
</span><span id="line-597"></span><span class="hs-comment">-- | True &lt;=&gt; eta-expansion will add at least one lambda</span><span>
</span><span id="line-598"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#expandableArityType"><span class="hs-identifier hs-type">expandableArityType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-599"></span><span id="expandableArityType"><span class="annot"><span class="annottext">expandableArityType :: ArityType -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#expandableArityType"><span class="hs-identifier hs-var hs-var">expandableArityType</span></a></span></span><span> </span><span id="local-6989586621681063259"><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063259"><span class="hs-identifier hs-var">at</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityType -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#arityTypeArity"><span class="hs-identifier hs-var">arityTypeArity</span></a></span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063259"><span class="hs-identifier hs-var">at</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-600"></span><span>
</span><span id="line-601"></span><span class="hs-comment">-- | See Note [Dead ends] in &quot;GHC.Types.Demand&quot;.</span><span>
</span><span id="line-602"></span><span class="hs-comment">-- Bottom implies a dead end.</span><span>
</span><span id="line-603"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#isDeadEndArityType"><span class="hs-identifier hs-type">isDeadEndArityType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-604"></span><span id="isDeadEndArityType"><span class="annot"><span class="annottext">isDeadEndArityType :: ArityType -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#isDeadEndArityType"><span class="hs-identifier hs-var hs-var">isDeadEndArityType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681063256"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063256"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Divergence -&gt; Bool
</span><a href="GHC.Types.Demand.html#isDeadEndDiv"><span class="hs-identifier hs-var">isDeadEndDiv</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063256"><span class="hs-identifier hs-var">div</span></a></span><span>
</span><span id="line-605"></span><span>
</span><span id="line-606"></span><span class="hs-comment">-- | Expand a non-bottoming arity type so that it has at least the given arity.</span><span>
</span><span id="line-607"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#maxWithArity"><span class="hs-identifier hs-type">maxWithArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-608"></span><span id="maxWithArity"><span class="annot"><span class="annottext">maxWithArity :: ArityType -&gt; Int -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#maxWithArity"><span class="hs-identifier hs-var hs-var">maxWithArity</span></a></span></span><span> </span><span id="local-6989586621681063254"><span class="annot"><span class="annottext">at :: ArityType
</span><a href="#local-6989586621681063254"><span class="hs-identifier hs-var">at</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621681063253"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063253"><span class="hs-identifier hs-var">oss</span></a></span></span><span> </span><span id="local-6989586621681063252"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063252"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681063251"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063251"><span class="hs-identifier hs-var">ar</span></a></span></span><span>
</span><span id="line-609"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ArityType -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#isDeadEndArityType"><span class="hs-identifier hs-var">isDeadEndArityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063254"><span class="hs-identifier hs-var">at</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063254"><span class="hs-identifier hs-var">at</span></a></span><span>
</span><span id="line-610"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063253"><span class="hs-identifier hs-var">oss</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; Int -&gt; Bool
</span><a href="GHC.Utils.Misc.html#lengthAtLeast"><span class="hs-operator hs-var">`lengthAtLeast`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063251"><span class="hs-identifier hs-var">ar</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063254"><span class="hs-identifier hs-var">at</span></a></span><span>
</span><span id="line-611"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; Divergence -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Int -&gt; [a] -&gt; [a]
</span><a href="../../base-4.16.4.0/src/GHC-List.html#take"><span class="hs-identifier hs-var">take</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063251"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063253"><span class="hs-identifier hs-var">oss</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a]
</span><a href="../../base-4.16.4.0/src/GHC-List.html#repeat"><span class="hs-identifier hs-var">repeat</span></a></span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="GHC.Types.Basic.html#NoOneShotInfo"><span class="hs-identifier hs-var">NoOneShotInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063252"><span class="hs-identifier hs-var">div</span></a></span><span>
</span><span id="line-612"></span><span>
</span><span id="line-613"></span><span class="hs-comment">-- | Trim an arity type so that it has at most the given arity.</span><span>
</span><span id="line-614"></span><span class="hs-comment">-- Any excess 'OneShotInfo's are truncated to 'topDiv', even if they end in</span><span>
</span><span id="line-615"></span><span class="hs-comment">-- 'ABot'.</span><span>
</span><span id="line-616"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#minWithArity"><span class="hs-identifier hs-type">minWithArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-617"></span><span id="minWithArity"><span class="annot"><span class="annottext">minWithArity :: ArityType -&gt; Int -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#minWithArity"><span class="hs-identifier hs-var hs-var">minWithArity</span></a></span></span><span> </span><span id="local-6989586621681063246"><span class="annot"><span class="annottext">at :: ArityType
</span><a href="#local-6989586621681063246"><span class="hs-identifier hs-var">at</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621681063245"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063245"><span class="hs-identifier hs-var">oss</span></a></span></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681063244"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063244"><span class="hs-identifier hs-var">ar</span></a></span></span><span>
</span><span id="line-618"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063245"><span class="hs-identifier hs-var">oss</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; Int -&gt; Bool
</span><a href="GHC.Utils.Misc.html#lengthAtMost"><span class="hs-operator hs-var">`lengthAtMost`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063244"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063246"><span class="hs-identifier hs-var">at</span></a></span><span>
</span><span id="line-619"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; Divergence -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Int -&gt; [a] -&gt; [a]
</span><a href="../../base-4.16.4.0/src/GHC-List.html#take"><span class="hs-identifier hs-var">take</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063244"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063245"><span class="hs-identifier hs-var">oss</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#topDiv"><span class="hs-identifier hs-var">topDiv</span></a></span><span>
</span><span id="line-620"></span><span>
</span><span id="line-621"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#takeWhileOneShot"><span class="hs-identifier hs-type">takeWhileOneShot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-622"></span><span id="takeWhileOneShot"><span class="annot"><span class="annottext">takeWhileOneShot :: ArityType -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#takeWhileOneShot"><span class="hs-identifier hs-var hs-var">takeWhileOneShot</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621681063241"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063241"><span class="hs-identifier hs-var">oss</span></a></span></span><span> </span><span id="local-6989586621681063240"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063240"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-623"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Divergence -&gt; Bool
</span><a href="GHC.Types.Demand.html#isDeadEndDiv"><span class="hs-identifier hs-var">isDeadEndDiv</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063240"><span class="hs-identifier hs-var">div</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; Divergence -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../base-4.16.4.0/src/GHC-List.html#takeWhile"><span class="hs-identifier hs-var">takeWhile</span></a></span><span> </span><span class="annot"><span class="annottext">OneShotInfo -&gt; Bool
</span><a href="GHC.Types.Basic.html#isOneShotInfo"><span class="hs-identifier hs-var">isOneShotInfo</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063241"><span class="hs-identifier hs-var">oss</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#topDiv"><span class="hs-identifier hs-var">topDiv</span></a></span><span>
</span><span id="line-624"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; Divergence -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../base-4.16.4.0/src/GHC-List.html#takeWhile"><span class="hs-identifier hs-var">takeWhile</span></a></span><span> </span><span class="annot"><span class="annottext">OneShotInfo -&gt; Bool
</span><a href="GHC.Types.Basic.html#isOneShotInfo"><span class="hs-identifier hs-var">isOneShotInfo</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063241"><span class="hs-identifier hs-var">oss</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063240"><span class="hs-identifier hs-var">div</span></a></span><span>
</span><span id="line-625"></span><span>
</span><span id="line-626"></span><span class="hs-comment">-- | The Arity returned is the number of value args the</span><span>
</span><span id="line-627"></span><span class="hs-comment">-- expression can be applied to without doing much work</span><span>
</span><span id="line-628"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#exprEtaExpandArity"><span class="hs-identifier hs-type">exprEtaExpandArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-629"></span><span class="hs-comment">-- exprEtaExpandArity is used when eta expanding</span><span>
</span><span id="line-630"></span><span class="hs-comment">--      e  ==&gt;  \xy -&gt; e x y</span><span>
</span><span id="line-631"></span><span id="exprEtaExpandArity"><span class="annot"><span class="annottext">exprEtaExpandArity :: DynFlags -&gt; CoreExpr -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#exprEtaExpandArity"><span class="hs-identifier hs-var hs-var">exprEtaExpandArity</span></a></span></span><span> </span><span id="local-6989586621681063237"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681063237"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621681063236"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063236"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynFlags -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#findRhsArityEnv"><span class="hs-identifier hs-var">findRhsArityEnv</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681063237"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063236"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-632"></span><span>
</span><span id="line-633"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#getBotArity"><span class="hs-identifier hs-type">getBotArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span>
</span><span id="line-634"></span><span class="hs-comment">-- Arity of a divergent function</span><span>
</span><span id="line-635"></span><span id="getBotArity"><span class="annot"><span class="annottext">getBotArity :: ArityType -&gt; Maybe Int
</span><a href="GHC.Core.Opt.Arity.html#getBotArity"><span class="hs-identifier hs-var hs-var">getBotArity</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621681063234"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063234"><span class="hs-identifier hs-var">oss</span></a></span></span><span> </span><span id="local-6989586621681063233"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063233"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-636"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Divergence -&gt; Bool
</span><a href="GHC.Types.Demand.html#isDeadEndDiv"><span class="hs-identifier hs-var">isDeadEndDiv</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063233"><span class="hs-identifier hs-var">div</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../../base-4.16.4.0/src/Data-Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063234"><span class="hs-identifier hs-var">oss</span></a></span><span>
</span><span id="line-637"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-638"></span><span>
</span><span id="line-639"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-640"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#findRhsArity"><span class="hs-identifier hs-type">findRhsArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-641"></span><span class="hs-comment">-- This implements the fixpoint loop for arity analysis</span><span>
</span><span id="line-642"></span><span class="hs-comment">-- See Note [Arity analysis]</span><span>
</span><span id="line-643"></span><span class="hs-comment">-- If findRhsArity e = (n, is_bot) then</span><span>
</span><span id="line-644"></span><span class="hs-comment">--  (a) any application of e to &lt;n arguments will not do much work,</span><span>
</span><span id="line-645"></span><span class="hs-comment">--      so it is safe to expand e  ==&gt;  (\x1..xn. e x1 .. xn)</span><span>
</span><span id="line-646"></span><span class="hs-comment">--  (b) if is_bot=True, then e applied to n args is guaranteed bottom</span><span>
</span><span id="line-647"></span><span id="findRhsArity"><span class="annot"><span class="annottext">findRhsArity :: DynFlags -&gt; TyVar -&gt; CoreExpr -&gt; Int -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#findRhsArity"><span class="hs-identifier hs-var hs-var">findRhsArity</span></a></span></span><span> </span><span id="local-6989586621681063231"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681063231"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621681063230"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063230"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621681063229"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063229"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span id="local-6989586621681063228"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063228"><span class="hs-identifier hs-var">old_arity</span></a></span></span><span>
</span><span id="line-648"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ArityType -&gt; ArityType
</span><a href="#local-6989586621681063227"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="GHC.Core.Opt.Arity.html#botArityType"><span class="hs-identifier hs-var">botArityType</span></a></span><span>
</span><span id="line-649"></span><span>      </span><span class="hs-comment">-- We always do one step, but usually that produces a result equal to</span><span>
</span><span id="line-650"></span><span>      </span><span class="hs-comment">-- old_arity, and then we stop right away, because old_arity is assumed</span><span>
</span><span id="line-651"></span><span>      </span><span class="hs-comment">-- to be sound. In other words, arities should never decrease.</span><span>
</span><span id="line-652"></span><span>      </span><span class="hs-comment">-- Result: the common case is that there is just one iteration</span><span>
</span><span id="line-653"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-654"></span><span>    </span><span class="annot"><a href="#local-6989586621681063227"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-655"></span><span>    </span><span id="local-6989586621681063227"><span class="annot"><span class="annottext">go :: Int -&gt; ArityType -&gt; ArityType
</span><a href="#local-6989586621681063227"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681063226"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063226"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681063225"><span class="annot"><span class="annottext">cur_at :: ArityType
</span><a href="#local-6989586621681063225"><span class="hs-identifier hs-var">cur_at</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621681063224"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063224"><span class="hs-identifier hs-var">oss</span></a></span></span><span> </span><span id="local-6989586621681063223"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063223"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-656"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Divergence -&gt; Bool
</span><a href="GHC.Types.Demand.html#isDeadEndDiv"><span class="hs-identifier hs-var">isDeadEndDiv</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063223"><span class="hs-identifier hs-var">div</span></a></span><span class="hs-special">)</span><span>           </span><span class="hs-comment">-- the &quot;stop right away&quot; case</span><span>
</span><span id="line-657"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../../base-4.16.4.0/src/Data-Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063224"><span class="hs-identifier hs-var">oss</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063228"><span class="hs-identifier hs-var">old_arity</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063225"><span class="hs-identifier hs-var">cur_at</span></a></span><span> </span><span class="hs-comment">-- from above</span><span>
</span><span id="line-658"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063221"><span class="hs-identifier hs-var">next_at</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063225"><span class="hs-identifier hs-var">cur_at</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063225"><span class="hs-identifier hs-var">cur_at</span></a></span><span>
</span><span id="line-659"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>               </span><span class="hs-glyph">=</span><span>
</span><span id="line-660"></span><span>         </span><span class="hs-comment">-- Warn if more than 2 iterations. Why 2? See Note [Exciting arity]</span><span>
</span><span id="line-661"></span><span>         </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">debugIsOn</span><span> </span><span class="hs-operator">&amp;&amp;</span><span> </span><span class="hs-identifier">n</span><span> </span><span class="hs-operator">&gt;</span><span> </span><span class="hs-number">2</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;Exciting arity&quot;</span><span>
</span><span id="line-662"></span><span>                                   </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-663"></span><span>                                        </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">bndr</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">cur_at</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">next_at</span><span>
</span><span id="line-664"></span><span>                                        </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">rhs</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-665"></span><span>         </span><span class="annot"><span class="annottext">Int -&gt; ArityType -&gt; ArityType
</span><a href="#local-6989586621681063227"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063226"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.16.4.0/src/GHC-Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063221"><span class="hs-identifier hs-var">next_at</span></a></span><span>
</span><span id="line-666"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-667"></span><span>        </span><span id="local-6989586621681063221"><span class="annot"><span class="annottext">next_at :: ArityType
</span><a href="#local-6989586621681063221"><span class="hs-identifier hs-var hs-var">next_at</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityType -&gt; ArityType
</span><a href="#local-6989586621681063212"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063225"><span class="hs-identifier hs-var">cur_at</span></a></span><span>
</span><span id="line-668"></span><span>
</span><span id="line-669"></span><span>    </span><span class="annot"><a href="#local-6989586621681063212"><span class="hs-identifier hs-type">step</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-670"></span><span>    </span><span id="local-6989586621681063212"><span class="annot"><span class="annottext">step :: ArityType -&gt; ArityType
</span><a href="#local-6989586621681063212"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621681063211"><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063211"><span class="hs-identifier hs-var">at</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;step&quot; (ppr bndr &lt;+&gt; ppr at &lt;+&gt; ppr (arityType env rhs)) $</span><span>
</span><span id="line-671"></span><span>              </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063210"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063229"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-672"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-673"></span><span>        </span><span id="local-6989586621681063210"><span class="annot"><span class="annottext">env :: ArityEnv
</span><a href="#local-6989586621681063210"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; TyVar -&gt; ArityType -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#extendSigEnv"><span class="hs-identifier hs-var">extendSigEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynFlags -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#findRhsArityEnv"><span class="hs-identifier hs-var">findRhsArityEnv</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681063231"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063230"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063211"><span class="hs-identifier hs-var">at</span></a></span><span>
</span><span id="line-674"></span><span>
</span><span id="line-675"></span><span class="hs-comment">{-
Note [Arity analysis]
~~~~~~~~~~~~~~~~~~~~~
The motivating example for arity analysis is this:

  f = \x. let g = f (x+1)
          in \y. ...g...

What arity does f have?  Really it should have arity 2, but a naive
look at the RHS won't see that.  You need a fixpoint analysis which
says it has arity &quot;infinity&quot; the first time round.

This example happens a lot; it first showed up in Andy Gill's thesis,
fifteen years ago!  It also shows up in the code for 'rnf' on lists
in #4138.

We do the necessary, quite simple fixed-point iteration in 'findRhsArity',
which assumes for a single binding 'ABot' on the first run and iterates
until it finds a stable arity type. Two wrinkles

* We often have to ask (see the Case or Let case of 'arityType') whether some
  expression is cheap. In the case of an application, that depends on the arity
  of the application head! That's why we have our own version of 'exprIsCheap',
  'myExprIsCheap', that will integrate the optimistic arity types we have on
  f and g into the cheapness check.

* Consider this (#18793)

    go = \ds. case ds of
           []     -&gt; id
           (x:ys) -&gt; let acc = go ys in
                     case blah of
                       True  -&gt; acc
                       False -&gt; \ x1 -&gt; acc (negate x1)

  We must propagate go's optimistically large arity to @acc@, so that the
  tail call to @acc@ in the True branch has sufficient arity.  This is done
  by the 'am_sigs' field in 'FindRhsArity', and 'lookupSigEnv' in the Var case
  of 'arityType'.

Note [Exciting Arity]
~~~~~~~~~~~~~~~~~~~~~
The fixed-point iteration in 'findRhsArity' stabilises very quickly in almost
all cases. To get notified of cases where we need an usual number of iterations,
we emit a warning in debug mode, so that we can investigate and make sure that
we really can't do better. It's a gross hack, but catches real bugs (#18870).

Now, which number is &quot;unusual&quot;? We pick n &gt; 2. Here's a pretty common and
expected example that takes two iterations and would ruin the specificity
of the warning (from T18937):

  f :: [Int] -&gt; Int -&gt; Int
  f []     = id
  f (x:xs) = let y = sum [0..x]
             in \z -&gt; f xs (y + z)

Fixed-point iteration starts with arity type &#8869; for f. After the first
iteration, we get arity type \??.T, e.g. arity 2, because we unconditionally
'floatIn' the let-binding (see its bottom case).  After the second iteration,
we get arity type \?.T, e.g. arity 1, because now we are no longer allowed
to floatIn the non-cheap let-binding.  Which is all perfectly benign, but
means we do two iterations (well, actually 3 'step's to detect we are stable)
and don't want to emit the warning.

Note [Eta expanding through dictionaries]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If the experimental -fdicts-cheap flag is on, we eta-expand through
dictionary bindings.  This improves arities. Thereby, it also
means that full laziness is less prone to floating out the
application of a function to its dictionary arguments, which
can thereby lose opportunities for fusion.  Example:
        foo :: Ord a =&gt; a -&gt; ...
     foo = /\a \(d:Ord a). let d' = ...d... in \(x:a). ....
        -- So foo has arity 1

     f = \x. foo dInt $ bar x

The (foo DInt) is floated out, and makes ineffective a RULE
     foo (bar x) = ...

One could go further and make exprIsCheap reply True to any
dictionary-typed expression, but that's more work.
-}</span><span>
</span><span id="line-758"></span><span>
</span><span id="line-759"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityLam"><span class="hs-identifier hs-type">arityLam</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-760"></span><span id="arityLam"><span class="annot"><span class="annottext">arityLam :: TyVar -&gt; ArityType -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#arityLam"><span class="hs-identifier hs-var hs-var">arityLam</span></a></span></span><span> </span><span id="local-6989586621681063207"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063207"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621681063206"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063206"><span class="hs-identifier hs-var">oss</span></a></span></span><span> </span><span id="local-6989586621681063205"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063205"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; Divergence -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; OneShotInfo
</span><a href="GHC.Types.Id.html#idStateHackOneShotInfo"><span class="hs-identifier hs-var">idStateHackOneShotInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063207"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063206"><span class="hs-identifier hs-var">oss</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063205"><span class="hs-identifier hs-var">div</span></a></span><span>
</span><span id="line-761"></span><span>
</span><span id="line-762"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#floatIn"><span class="hs-identifier hs-type">floatIn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-763"></span><span class="hs-comment">-- We have something like (let x = E in b),</span><span>
</span><span id="line-764"></span><span class="hs-comment">-- where b has the given arity type.</span><span>
</span><span id="line-765"></span><span id="floatIn"><span class="annot"><span class="annottext">floatIn :: Bool -&gt; ArityType -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#floatIn"><span class="hs-identifier hs-var hs-var">floatIn</span></a></span></span><span> </span><span id="local-6989586621681063202"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681063202"><span class="hs-identifier hs-var">cheap</span></a></span></span><span> </span><span id="local-6989586621681063201"><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063201"><span class="hs-identifier hs-var">at</span></a></span></span><span>
</span><span id="line-766"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ArityType -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#isDeadEndArityType"><span class="hs-identifier hs-var">isDeadEndArityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063201"><span class="hs-identifier hs-var">at</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681063202"><span class="hs-identifier hs-var">cheap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063201"><span class="hs-identifier hs-var">at</span></a></span><span>
</span><span id="line-767"></span><span>  </span><span class="hs-comment">-- If E is not cheap, keep arity only for one-shots</span><span>
</span><span id="line-768"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityType -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#takeWhileOneShot"><span class="hs-identifier hs-var">takeWhileOneShot</span></a></span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063201"><span class="hs-identifier hs-var">at</span></a></span><span>
</span><span id="line-769"></span><span>
</span><span id="line-770"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityApp"><span class="hs-identifier hs-type">arityApp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-771"></span><span>
</span><span id="line-772"></span><span class="hs-comment">-- Processing (fun arg) where at is the ArityType of fun,</span><span>
</span><span id="line-773"></span><span class="hs-comment">-- Knock off an argument and behave like 'let'</span><span>
</span><span id="line-774"></span><span id="arityApp"><span class="annot"><span class="annottext">arityApp :: ArityType -&gt; Bool -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#arityApp"><span class="hs-identifier hs-var hs-var">arityApp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OneShotInfo
</span><span class="hs-identifier">_</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681063198"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063198"><span class="hs-identifier hs-var">oss</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681063197"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063197"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681063196"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681063196"><span class="hs-identifier hs-var">cheap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; ArityType -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#floatIn"><span class="hs-identifier hs-var">floatIn</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681063196"><span class="hs-identifier hs-var">cheap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; Divergence -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063198"><span class="hs-identifier hs-var">oss</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063197"><span class="hs-identifier hs-var">div</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-775"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityApp"><span class="hs-identifier hs-var">arityApp</span></a></span><span> </span><span id="local-6989586621681063195"><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063195"><span class="hs-identifier hs-var">at</span></a></span></span><span>               </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063195"><span class="hs-identifier hs-var">at</span></a></span><span>
</span><span id="line-776"></span><span>
</span><span id="line-777"></span><span class="hs-comment">-- | Least upper bound in the 'ArityType' lattice.</span><span>
</span><span id="line-778"></span><span class="hs-comment">-- See the haddocks on 'ArityType' for the lattice.</span><span>
</span><span id="line-779"></span><span class="hs-comment">--</span><span>
</span><span id="line-780"></span><span class="hs-comment">-- Used for branches of a @case@.</span><span>
</span><span id="line-781"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#andArityType"><span class="hs-identifier hs-type">andArityType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-782"></span><span id="andArityType"><span class="annot"><span class="annottext">andArityType :: ArityEnv -&gt; ArityType -&gt; ArityType -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#andArityType"><span class="hs-identifier hs-var hs-var">andArityType</span></a></span></span><span> </span><span id="local-6989586621681063193"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063193"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681063192"><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621681063192"><span class="hs-identifier hs-var">lam1</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681063191"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063191"><span class="hs-identifier hs-var">lams1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681063190"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063190"><span class="hs-identifier hs-var">div1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681063189"><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621681063189"><span class="hs-identifier hs-var">lam2</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681063188"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063188"><span class="hs-identifier hs-var">lams2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681063187"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063187"><span class="hs-identifier hs-var">div2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-783"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621681063186"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063186"><span class="hs-identifier hs-var">lams'</span></a></span></span><span> </span><span id="local-6989586621681063185"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063185"><span class="hs-identifier hs-var">div'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; ArityType -&gt; ArityType -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#andArityType"><span class="hs-identifier hs-var">andArityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063193"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; Divergence -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063191"><span class="hs-identifier hs-var">lams1</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063190"><span class="hs-identifier hs-var">div1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; Divergence -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063188"><span class="hs-identifier hs-var">lams2</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063187"><span class="hs-identifier hs-var">div2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-784"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; Divergence -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621681063192"><span class="hs-identifier hs-var">lam1</span></a></span><span> </span><span class="annot"><span class="annottext">OneShotInfo -&gt; OneShotInfo -&gt; OneShotInfo
</span><a href="#local-6989586621681063184"><span class="hs-operator hs-var">`and_lam`</span></a></span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621681063189"><span class="hs-identifier hs-var">lam2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063186"><span class="hs-identifier hs-var">lams'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063185"><span class="hs-identifier hs-var">div'</span></a></span><span>
</span><span id="line-785"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-786"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681063183"><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621681063183"><span class="hs-identifier hs-var">os1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681063184"><span class="annot"><span class="annottext">and_lam :: OneShotInfo -&gt; OneShotInfo -&gt; OneShotInfo
</span><a href="#local-6989586621681063184"><span class="hs-operator hs-var hs-var">`and_lam`</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681063182"><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621681063182"><span class="hs-identifier hs-var">os2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-787"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621681063183"><span class="hs-identifier hs-var">os1</span></a></span><span> </span><span class="annot"><span class="annottext">OneShotInfo -&gt; OneShotInfo -&gt; OneShotInfo
</span><a href="GHC.Types.Basic.html#bestOneShot"><span class="hs-operator hs-var">`bestOneShot`</span></a></span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621681063182"><span class="hs-identifier hs-var">os2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-788"></span><span>        </span><span class="hs-comment">-- bestOneShot: see Note [Combining case branches: optimistic one-shot-ness]</span><span>
</span><span id="line-789"></span><span>
</span><span id="line-790"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#andArityType"><span class="hs-identifier hs-var">andArityType</span></a></span><span> </span><span id="local-6989586621681063180"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063180"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621681063179"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063179"><span class="hs-identifier hs-var">div1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681063178"><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063178"><span class="hs-identifier hs-var">at2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; Divergence -&gt; ArityType -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#andWithTail"><span class="hs-identifier hs-var">andWithTail</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063180"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063179"><span class="hs-identifier hs-var">div1</span></a></span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063178"><span class="hs-identifier hs-var">at2</span></a></span><span>
</span><span id="line-791"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#andArityType"><span class="hs-identifier hs-var">andArityType</span></a></span><span> </span><span id="local-6989586621681063176"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063176"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681063175"><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063175"><span class="hs-identifier hs-var">at1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621681063174"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063174"><span class="hs-identifier hs-var">div2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; Divergence -&gt; ArityType -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#andWithTail"><span class="hs-identifier hs-var">andWithTail</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063176"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063174"><span class="hs-identifier hs-var">div2</span></a></span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063175"><span class="hs-identifier hs-var">at1</span></a></span><span>
</span><span id="line-792"></span><span>
</span><span id="line-793"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#andWithTail"><span class="hs-identifier hs-type">andWithTail</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Divergence"><span class="hs-identifier hs-type">Divergence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-794"></span><span id="andWithTail"><span class="annot"><span class="annottext">andWithTail :: ArityEnv -&gt; Divergence -&gt; ArityType -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#andWithTail"><span class="hs-identifier hs-var hs-var">andWithTail</span></a></span></span><span> </span><span id="local-6989586621681063173"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063173"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681063172"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063172"><span class="hs-identifier hs-var">div1</span></a></span></span><span> </span><span id="local-6989586621681063171"><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063171"><span class="hs-identifier hs-var">at2</span></a></span></span><span>
</span><span id="line-795"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Divergence -&gt; Bool
</span><a href="GHC.Types.Demand.html#isDeadEndDiv"><span class="hs-identifier hs-var">isDeadEndDiv</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063172"><span class="hs-identifier hs-var">div1</span></a></span><span>     </span><span class="hs-comment">-- case x of { T -&gt; error; F -&gt; \y.e }</span><span>
</span><span id="line-796"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063171"><span class="hs-identifier hs-var">at2</span></a></span><span>        </span><span class="hs-comment">-- Note [ABot branches: max arity wins]</span><span>
</span><span id="line-797"></span><span>
</span><span id="line-798"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#pedanticBottoms"><span class="hs-identifier hs-var">pedanticBottoms</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063173"><span class="hs-identifier hs-var">env</span></a></span><span>  </span><span class="hs-comment">-- Note [Combining case branches: andWithTail]</span><span>
</span><span id="line-799"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; Divergence -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#topDiv"><span class="hs-identifier hs-var">topDiv</span></a></span><span>
</span><span id="line-800"></span><span>
</span><span id="line-801"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>  </span><span class="hs-comment">-- case x of { T -&gt; plusInt &lt;expensive&gt;; F -&gt; \y.e }</span><span>
</span><span id="line-802"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityType -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#takeWhileOneShot"><span class="hs-identifier hs-var">takeWhileOneShot</span></a></span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063171"><span class="hs-identifier hs-var">at2</span></a></span><span>    </span><span class="hs-comment">-- We know div1 = topDiv</span><span>
</span><span id="line-803"></span><span>    </span><span class="hs-comment">-- See Note [Combining case branches: andWithTail]</span><span>
</span><span id="line-804"></span><span>
</span><span id="line-805"></span><span>
</span><span id="line-806"></span><span class="hs-comment">{- Note [ABot branches: max arity wins]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider   case x of
             True  -&gt; \x.  error &quot;urk&quot;
             False -&gt; \xy. error &quot;urk2&quot;

Remember: \o1..on.&#8869; means &quot;if you apply to n args, it'll definitely diverge&quot;.
So we need \??.&#8869; for the whole thing, the /max/ of both arities.

Note [Combining case branches: optimistic one-shot-ness]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When combining the ArityTypes for two case branches (with andArityType)
and both ArityTypes have ATLamInfo, then we just combine their
expensive-ness and one-shot info.  The tricky point is when we have
     case x of True -&gt; \x{one-shot). blah1
               Fale -&gt; \y.           blah2

Since one-shot-ness is about the /consumer/ not the /producer/, we
optimistically assume that if either branch is one-shot, we combine
the best of the two branches, on the (slightly dodgy) basis that if we
know one branch is one-shot, then they all must be.  Surprisingly,
this means that the one-shot arity type is effectively the top element
of the lattice.

Hence the call to `bestOneShot` in `andArityType`.

Note [Combining case branches: andWithTail]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When combining the ArityTypes for two case branches (with andArityType)
and one side or the other has run out of ATLamInfo; then we get
into `andWithTail`.

* If one branch is guaranteed bottom (isDeadEndDiv), we just take
  the other; see Note [ABot branches: max arity wins]

* Otherwise, if pedantic-bottoms is on, we just have to return
  AT [] topDiv.  E.g. if we have
    f x z = case x of True  -&gt; \y. blah
                      False -&gt; z
  then we can't eta-expand, because that would change the behaviour
  of (f False bottom().

* But if pedantic-bottoms is not on, we allow ourselves to push
  `z` under a lambda (much as we allow ourselves to put the `case x`
  under a lambda).  However we know nothing about the expensiveness
  or one-shot-ness of `z`, so we'd better assume it looks like
  (Expensive, NoOneShotInfo) all the way. Remembering
  Note [Combining case branches: optimistic one-shot-ness],
  we just add work to ever ATLamInfo, keeping the one-shot-ness.

Here's an example:
  go = \x. let z = go e0
               go2 = \x. case x of
                           True  -&gt; z
                           False -&gt; \s(one-shot). e1
           in go2 x
We *really* want to respect the one-shot annotation provided by the
user and eta-expand go and go2.
When combining the branches of the case we have
     T `andAT` \1.T
and we want to get \1.T.
But if the inner lambda wasn't one-shot (\?.T) we don't want to do this.
(We need a usage analysis to justify that.)

So we combine the best of the two branches, on the (slightly dodgy)
basis that if we know one branch is one-shot, then they all must be.
Surprisingly, this means that the one-shot arity type is effectively the top
element of the lattice.

Note [Arity trimming]
~~~~~~~~~~~~~~~~~~~~~
Consider ((\x y. blah) |&gt; co), where co :: (Int-&gt;Int-&gt;Int) ~ (Int -&gt; F a) , and
F is some type family.

Because of Note [exprArity invariant], item (2), we must return with arity at
most 1, because typeArity (Int -&gt; F a) = 1.  So we have to trim the result of
calling arityType on (\x y. blah).  Failing to do so, and hence breaking the
exprArity invariant, led to #5441.

How to trim?  If we end in topDiv, it's easy.  But we must take great care with
dead ends (i.e. botDiv). Suppose the expression was (\x y. error &quot;urk&quot;),
we'll get \??.&#8869;.  We absolutely must not trim that to \?.&#8869;, because that
claims that ((\x y. error &quot;urk&quot;) |&gt; co) diverges when given one argument,
which it absolutely does not. And Bad Things happen if we think something
returns bottom when it doesn't (#16066).

So, if we need to trim a dead-ending arity type, switch (conservatively) to
topDiv.

Historical note: long ago, we unconditionally switched to topDiv when we
encountered a cast, but that is far too conservative: see #5475
-}</span><span>
</span><span id="line-898"></span><span>
</span><span id="line-899"></span><span class="hs-comment">---------------------------</span><span>
</span><span id="line-900"></span><span>
</span><span id="line-901"></span><span class="hs-comment">-- | Each of the entry-points of the analyser ('arityType') has different</span><span>
</span><span id="line-902"></span><span class="hs-comment">-- requirements. The entry-points are</span><span>
</span><span id="line-903"></span><span class="hs-comment">--</span><span>
</span><span id="line-904"></span><span class="hs-comment">--   1. 'exprBotStrictness_maybe'</span><span>
</span><span id="line-905"></span><span class="hs-comment">--   2. 'exprEtaExpandArity'</span><span>
</span><span id="line-906"></span><span class="hs-comment">--   3. 'findRhsArity'</span><span>
</span><span id="line-907"></span><span class="hs-comment">--</span><span>
</span><span id="line-908"></span><span class="hs-comment">-- For each of the entry-points, there is a separate mode that governs</span><span>
</span><span id="line-909"></span><span class="hs-comment">--</span><span>
</span><span id="line-910"></span><span class="hs-comment">--   1. How pedantic we are wrt. &#8869;, in 'pedanticBottoms'.</span><span>
</span><span id="line-911"></span><span class="hs-comment">--   2. Whether we store arity signatures for non-recursive let-bindings,</span><span>
</span><span id="line-912"></span><span class="hs-comment">--      accessed in 'extendSigEnv'/'lookupSigEnv'.</span><span>
</span><span id="line-913"></span><span class="hs-comment">--      See Note [Arity analysis] why that's important.</span><span>
</span><span id="line-914"></span><span class="hs-comment">--   3. Which expressions we consider cheap to float inside a lambda,</span><span>
</span><span id="line-915"></span><span class="hs-comment">--      in 'myExprIsCheap'.</span><span>
</span><span id="line-916"></span><span class="hs-keyword">data</span><span> </span><span id="AnalysisMode"><span class="annot"><a href="GHC.Core.Opt.Arity.html#AnalysisMode"><span class="hs-identifier hs-var">AnalysisMode</span></a></span></span><span>
</span><span id="line-917"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="BotStrictness"><span class="annot"><a href="GHC.Core.Opt.Arity.html#BotStrictness"><span class="hs-identifier hs-var">BotStrictness</span></a></span></span><span>
</span><span id="line-918"></span><span>  </span><span class="hs-comment">-- ^ Used during 'exprBotStrictness_maybe'.</span><span>
</span><span id="line-919"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="EtaExpandArity"><span class="annot"><a href="GHC.Core.Opt.Arity.html#EtaExpandArity"><span class="hs-identifier hs-var">EtaExpandArity</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="am_ped_bot"><span class="annot"><span class="annottext">AnalysisMode -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#am_ped_bot"><span class="hs-identifier hs-var hs-var">am_ped_bot</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-920"></span><span>                   </span><span class="hs-special">,</span><span> </span><span id="am_dicts_cheap"><span class="annot"><span class="annottext">AnalysisMode -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#am_dicts_cheap"><span class="hs-identifier hs-var hs-var">am_dicts_cheap</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-921"></span><span>  </span><span class="hs-comment">-- ^ Used for finding an expression's eta-expanding arity quickly, without</span><span>
</span><span id="line-922"></span><span>  </span><span class="hs-comment">-- fixed-point iteration ('exprEtaExpandArity').</span><span>
</span><span id="line-923"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="FindRhsArity"><span class="annot"><a href="GHC.Core.Opt.Arity.html#FindRhsArity"><span class="hs-identifier hs-var">FindRhsArity</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="am_ped_bot"><span class="annot"><a href="GHC.Core.Opt.Arity.html#am_ped_bot"><span class="hs-identifier hs-var">am_ped_bot</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-924"></span><span>                 </span><span class="hs-special">,</span><span> </span><span id="am_dicts_cheap"><span class="annot"><a href="GHC.Core.Opt.Arity.html#am_dicts_cheap"><span class="hs-identifier hs-var">am_dicts_cheap</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-925"></span><span>                 </span><span class="hs-special">,</span><span> </span><span id="am_sigs"><span class="annot"><span class="annottext">AnalysisMode -&gt; IdEnv ArityType
</span><a href="GHC.Core.Opt.Arity.html#am_sigs"><span class="hs-identifier hs-var hs-var">am_sigs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.Env.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-926"></span><span>  </span><span class="hs-comment">-- ^ Used for regular, fixed-point arity analysis ('findRhsArity').</span><span>
</span><span id="line-927"></span><span>  </span><span class="hs-comment">--   See Note [Arity analysis] for details about fixed-point iteration.</span><span>
</span><span id="line-928"></span><span>  </span><span class="hs-comment">--   INVARIANT: Disjoint with 'ae_joins'.</span><span>
</span><span id="line-929"></span><span>
</span><span id="line-930"></span><span class="hs-keyword">data</span><span> </span><span id="ArityEnv"><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-var">ArityEnv</span></a></span></span><span>
</span><span id="line-931"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="AE"><span class="annot"><a href="GHC.Core.Opt.Arity.html#AE"><span class="hs-identifier hs-var">AE</span></a></span></span><span>
</span><span id="line-932"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="ae_mode"><span class="annot"><span class="annottext">ArityEnv -&gt; AnalysisMode
</span><a href="GHC.Core.Opt.Arity.html#ae_mode"><span class="hs-identifier hs-var hs-var">ae_mode</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AnalysisMode"><span class="hs-identifier hs-type">AnalysisMode</span></a></span><span>
</span><span id="line-933"></span><span>  </span><span class="hs-comment">-- ^ The analysis mode. See 'AnalysisMode'.</span><span>
</span><span id="line-934"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-935"></span><span>
</span><span id="line-936"></span><span class="hs-comment">-- | The @ArityEnv@ used by 'exprBotStrictness_maybe'. Pedantic about bottoms</span><span>
</span><span id="line-937"></span><span class="hs-comment">-- and no application is ever considered cheap.</span><span>
</span><span id="line-938"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#botStrictnessArityEnv"><span class="hs-identifier hs-type">botStrictnessArityEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span>
</span><span id="line-939"></span><span id="botStrictnessArityEnv"><span class="annot"><span class="annottext">botStrictnessArityEnv :: ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#botStrictnessArityEnv"><span class="hs-identifier hs-var hs-var">botStrictnessArityEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AE"><span class="hs-identifier hs-type">AE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ae_mode :: AnalysisMode
</span><a href="GHC.Core.Opt.Arity.html#ae_mode"><span class="hs-identifier hs-var">ae_mode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalysisMode
</span><a href="GHC.Core.Opt.Arity.html#BotStrictness"><span class="hs-identifier hs-var">BotStrictness</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-940"></span><span>
</span><span id="line-941"></span><span class="hs-comment">{-
-- | The @ArityEnv@ used by 'exprEtaExpandArity'.
etaExpandArityEnv :: DynFlags -&gt; ArityEnv
etaExpandArityEnv dflags
  = AE { ae_mode  = EtaExpandArity { am_ped_bot = gopt Opt_PedanticBottoms dflags
                                   , am_dicts_cheap = gopt Opt_DictsCheap dflags }
       , ae_joins = emptyVarSet }
-}</span><span>
</span><span id="line-949"></span><span>
</span><span id="line-950"></span><span class="hs-comment">-- | The @ArityEnv@ used by 'findRhsArity'.</span><span>
</span><span id="line-951"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#findRhsArityEnv"><span class="hs-identifier hs-type">findRhsArityEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span>
</span><span id="line-952"></span><span id="findRhsArityEnv"><span class="annot"><span class="annottext">findRhsArityEnv :: DynFlags -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#findRhsArityEnv"><span class="hs-identifier hs-var hs-var">findRhsArityEnv</span></a></span></span><span> </span><span id="local-6989586621681063161"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681063161"><span class="hs-identifier hs-var">dflags</span></a></span></span><span>
</span><span id="line-953"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AE"><span class="hs-identifier hs-type">AE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ae_mode :: AnalysisMode
</span><a href="GHC.Core.Opt.Arity.html#ae_mode"><span class="hs-identifier hs-var">ae_mode</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#FindRhsArity"><span class="hs-identifier hs-type">FindRhsArity</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">am_ped_bot :: Bool
</span><a href="GHC.Core.Opt.Arity.html#am_ped_bot"><span class="hs-identifier hs-var">am_ped_bot</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GeneralFlag -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.Session.html#gopt"><span class="hs-identifier hs-var">gopt</span></a></span><span> </span><span class="annot"><span class="annottext">GeneralFlag
</span><a href="GHC.Driver.Flags.html#Opt_PedanticBottoms"><span class="hs-identifier hs-var">Opt_PedanticBottoms</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681063161"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-954"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">am_dicts_cheap :: Bool
</span><a href="GHC.Core.Opt.Arity.html#am_dicts_cheap"><span class="hs-identifier hs-var">am_dicts_cheap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GeneralFlag -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.Session.html#gopt"><span class="hs-identifier hs-var">gopt</span></a></span><span> </span><span class="annot"><span class="annottext">GeneralFlag
</span><a href="GHC.Driver.Flags.html#Opt_DictsCheap"><span class="hs-identifier hs-var">Opt_DictsCheap</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681063161"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-955"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">am_sigs :: IdEnv ArityType
</span><a href="GHC.Core.Opt.Arity.html#am_sigs"><span class="hs-identifier hs-var">am_sigs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-956"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-957"></span><span>
</span><span id="line-958"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#isFindRhsArity"><span class="hs-identifier hs-type">isFindRhsArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-959"></span><span id="isFindRhsArity"><span class="annot"><span class="annottext">isFindRhsArity :: ArityEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#isFindRhsArity"><span class="hs-identifier hs-var hs-var">isFindRhsArity</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AE"><span class="hs-identifier hs-type">AE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ae_mode :: ArityEnv -&gt; AnalysisMode
</span><a href="GHC.Core.Opt.Arity.html#ae_mode"><span class="hs-identifier hs-var">ae_mode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#FindRhsArity"><span class="hs-identifier hs-type">FindRhsArity</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-960"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#isFindRhsArity"><span class="hs-identifier hs-var">isFindRhsArity</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><span class="hs-identifier">_</span></span><span>                                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-961"></span><span>
</span><span id="line-962"></span><span class="hs-comment">-- First some internal functions in snake_case for deleting in certain VarEnvs</span><span>
</span><span id="line-963"></span><span class="hs-comment">-- of the ArityType. Don't call these; call delInScope* instead!</span><span>
</span><span id="line-964"></span><span>
</span><span id="line-965"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#modifySigEnv"><span class="hs-identifier hs-type">modifySigEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.Env.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span>
</span><span id="line-966"></span><span id="modifySigEnv"><span class="annot"><span class="annottext">modifySigEnv :: (IdEnv ArityType -&gt; IdEnv ArityType) -&gt; ArityEnv -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#modifySigEnv"><span class="hs-identifier hs-var hs-var">modifySigEnv</span></a></span></span><span> </span><span id="local-6989586621681063155"><span class="annot"><span class="annottext">IdEnv ArityType -&gt; IdEnv ArityType
</span><a href="#local-6989586621681063155"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621681063154"><span class="annot"><span class="annottext">env :: ArityEnv
</span><a href="#local-6989586621681063154"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AE"><span class="hs-identifier hs-type">AE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ae_mode :: ArityEnv -&gt; AnalysisMode
</span><a href="GHC.Core.Opt.Arity.html#ae_mode"><span class="hs-identifier hs-var">ae_mode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681063153"><span class="annot"><span class="annottext">am :: AnalysisMode
</span><a href="#local-6989586621681063153"><span class="hs-identifier hs-var">am</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#FindRhsArity"><span class="hs-identifier hs-type">FindRhsArity</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">am_sigs :: AnalysisMode -&gt; IdEnv ArityType
</span><a href="GHC.Core.Opt.Arity.html#am_sigs"><span class="hs-identifier hs-var">am_sigs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681063152"><span class="annot"><span class="annottext">IdEnv ArityType
</span><a href="#local-6989586621681063152"><span class="hs-identifier hs-var">sigs</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-967"></span><span>  </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063154"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ae_mode :: AnalysisMode
</span><a href="GHC.Core.Opt.Arity.html#ae_mode"><span class="hs-identifier hs-var">ae_mode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalysisMode
</span><a href="#local-6989586621681063153"><span class="hs-identifier hs-var">am</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">am_sigs :: IdEnv ArityType
</span><a href="GHC.Core.Opt.Arity.html#am_sigs"><span class="hs-identifier hs-var">am_sigs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdEnv ArityType -&gt; IdEnv ArityType
</span><a href="#local-6989586621681063155"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv ArityType
</span><a href="#local-6989586621681063152"><span class="hs-identifier hs-var">sigs</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-968"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#modifySigEnv"><span class="hs-identifier hs-var">modifySigEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv ArityType -&gt; IdEnv ArityType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681063151"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063151"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063151"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-969"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#modifySigEnv"><span class="hs-pragma hs-type">modifySigEnv</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-970"></span><span>
</span><span id="line-971"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#del_sig_env"><span class="hs-identifier hs-type">del_sig_env</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-comment">-- internal!</span><span>
</span><span id="line-972"></span><span id="del_sig_env"><span class="annot"><span class="annottext">del_sig_env :: TyVar -&gt; ArityEnv -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#del_sig_env"><span class="hs-identifier hs-var hs-var">del_sig_env</span></a></span></span><span> </span><span id="local-6989586621681063149"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063149"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IdEnv ArityType -&gt; IdEnv ArityType) -&gt; ArityEnv -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#modifySigEnv"><span class="hs-identifier hs-var">modifySigEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681063148"><span class="annot"><span class="annottext">IdEnv ArityType
</span><a href="#local-6989586621681063148"><span class="hs-identifier hs-var">sigs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. VarEnv a -&gt; TyVar -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv ArityType
</span><a href="#local-6989586621681063148"><span class="hs-identifier hs-var">sigs</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063149"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-973"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#del_sig_env"><span class="hs-pragma hs-type">del_sig_env</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-974"></span><span>
</span><span id="line-975"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#del_sig_env_list"><span class="hs-identifier hs-type">del_sig_env_list</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-comment">-- internal!</span><span>
</span><span id="line-976"></span><span id="del_sig_env_list"><span class="annot"><span class="annottext">del_sig_env_list :: [TyVar] -&gt; ArityEnv -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#del_sig_env_list"><span class="hs-identifier hs-var hs-var">del_sig_env_list</span></a></span></span><span> </span><span id="local-6989586621681063145"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681063145"><span class="hs-identifier hs-var">ids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IdEnv ArityType -&gt; IdEnv ArityType) -&gt; ArityEnv -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#modifySigEnv"><span class="hs-identifier hs-var">modifySigEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681063144"><span class="annot"><span class="annottext">IdEnv ArityType
</span><a href="#local-6989586621681063144"><span class="hs-identifier hs-var">sigs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. VarEnv a -&gt; [TyVar] -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#delVarEnvList"><span class="hs-identifier hs-var">delVarEnvList</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv ArityType
</span><a href="#local-6989586621681063144"><span class="hs-identifier hs-var">sigs</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681063145"><span class="hs-identifier hs-var">ids</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-977"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#del_sig_env_list"><span class="hs-pragma hs-type">del_sig_env_list</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-978"></span><span>
</span><span id="line-979"></span><span class="hs-comment">-- end of internal deletion functions</span><span>
</span><span id="line-980"></span><span>
</span><span id="line-981"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#extendSigEnv"><span class="hs-identifier hs-type">extendSigEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span>
</span><span id="line-982"></span><span id="extendSigEnv"><span class="annot"><span class="annottext">extendSigEnv :: ArityEnv -&gt; TyVar -&gt; ArityType -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#extendSigEnv"><span class="hs-identifier hs-var hs-var">extendSigEnv</span></a></span></span><span> </span><span id="local-6989586621681063142"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063142"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681063141"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063141"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621681063140"><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063140"><span class="hs-identifier hs-var">ar_ty</span></a></span></span><span>
</span><span id="line-983"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IdEnv ArityType -&gt; IdEnv ArityType) -&gt; ArityEnv -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#modifySigEnv"><span class="hs-identifier hs-var">modifySigEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681063139"><span class="annot"><span class="annottext">IdEnv ArityType
</span><a href="#local-6989586621681063139"><span class="hs-identifier hs-var">sigs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. VarEnv a -&gt; TyVar -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv ArityType
</span><a href="#local-6989586621681063139"><span class="hs-identifier hs-var">sigs</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063141"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063140"><span class="hs-identifier hs-var">ar_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063142"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-984"></span><span>
</span><span id="line-985"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#delInScope"><span class="hs-identifier hs-type">delInScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span>
</span><span id="line-986"></span><span id="delInScope"><span class="annot"><span class="annottext">delInScope :: ArityEnv -&gt; TyVar -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#delInScope"><span class="hs-identifier hs-var hs-var">delInScope</span></a></span></span><span> </span><span id="local-6989586621681063136"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063136"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681063135"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063135"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; ArityEnv -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#del_sig_env"><span class="hs-identifier hs-var">del_sig_env</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063135"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063136"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-987"></span><span>
</span><span id="line-988"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#delInScopeList"><span class="hs-identifier hs-type">delInScopeList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span>
</span><span id="line-989"></span><span id="delInScopeList"><span class="annot"><span class="annottext">delInScopeList :: ArityEnv -&gt; [TyVar] -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#delInScopeList"><span class="hs-identifier hs-var hs-var">delInScopeList</span></a></span></span><span> </span><span id="local-6989586621681063133"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063133"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681063132"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681063132"><span class="hs-identifier hs-var">ids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; ArityEnv -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#del_sig_env_list"><span class="hs-identifier hs-var">del_sig_env_list</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681063132"><span class="hs-identifier hs-var">ids</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063133"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-990"></span><span>
</span><span id="line-991"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#lookupSigEnv"><span class="hs-identifier hs-type">lookupSigEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-992"></span><span id="lookupSigEnv"><span class="annot"><span class="annottext">lookupSigEnv :: ArityEnv -&gt; TyVar -&gt; Maybe ArityType
</span><a href="GHC.Core.Opt.Arity.html#lookupSigEnv"><span class="hs-identifier hs-var hs-var">lookupSigEnv</span></a></span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AE"><span class="hs-identifier hs-type">AE</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ae_mode :: ArityEnv -&gt; AnalysisMode
</span><a href="GHC.Core.Opt.Arity.html#ae_mode"><span class="hs-identifier hs-var">ae_mode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681063130"><span class="annot"><span class="annottext">AnalysisMode
</span><a href="#local-6989586621681063130"><span class="hs-identifier hs-var">mode</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621681063129"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063129"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AnalysisMode
</span><a href="#local-6989586621681063130"><span class="hs-identifier hs-var">mode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-993"></span><span>  </span><span class="annot"><span class="annottext">AnalysisMode
</span><a href="GHC.Core.Opt.Arity.html#BotStrictness"><span class="hs-identifier hs-var">BotStrictness</span></a></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-994"></span><span>  </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EtaExpandArity"><span class="hs-identifier hs-type">EtaExpandArity</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-995"></span><span>  </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#FindRhsArity"><span class="hs-identifier hs-type">FindRhsArity</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">am_sigs :: AnalysisMode -&gt; IdEnv ArityType
</span><a href="GHC.Core.Opt.Arity.html#am_sigs"><span class="hs-identifier hs-var">am_sigs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681063128"><span class="annot"><span class="annottext">IdEnv ArityType
</span><a href="#local-6989586621681063128"><span class="hs-identifier hs-var">sigs</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. VarEnv a -&gt; TyVar -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv ArityType
</span><a href="#local-6989586621681063128"><span class="hs-identifier hs-var">sigs</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063129"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-996"></span><span>
</span><span id="line-997"></span><span class="hs-comment">-- | Whether the analysis should be pedantic about bottoms.</span><span>
</span><span id="line-998"></span><span class="hs-comment">-- 'exprBotStrictness_maybe' always is.</span><span>
</span><span id="line-999"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pedanticBottoms"><span class="hs-identifier hs-type">pedanticBottoms</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1000"></span><span id="pedanticBottoms"><span class="annot"><span class="annottext">pedanticBottoms :: ArityEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#pedanticBottoms"><span class="hs-identifier hs-var hs-var">pedanticBottoms</span></a></span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AE"><span class="hs-identifier hs-type">AE</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ae_mode :: ArityEnv -&gt; AnalysisMode
</span><a href="GHC.Core.Opt.Arity.html#ae_mode"><span class="hs-identifier hs-var">ae_mode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681063126"><span class="annot"><span class="annottext">AnalysisMode
</span><a href="#local-6989586621681063126"><span class="hs-identifier hs-var">mode</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AnalysisMode
</span><a href="#local-6989586621681063126"><span class="hs-identifier hs-var">mode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1001"></span><span>  </span><span class="annot"><span class="annottext">AnalysisMode
</span><a href="GHC.Core.Opt.Arity.html#BotStrictness"><span class="hs-identifier hs-var">BotStrictness</span></a></span><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1002"></span><span>  </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EtaExpandArity"><span class="hs-identifier hs-type">EtaExpandArity</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">am_ped_bot :: AnalysisMode -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#am_ped_bot"><span class="hs-identifier hs-var">am_ped_bot</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681063125"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681063125"><span class="hs-identifier hs-var">ped_bot</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681063125"><span class="hs-identifier hs-var">ped_bot</span></a></span><span>
</span><span id="line-1003"></span><span>  </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#FindRhsArity"><span class="hs-identifier hs-type">FindRhsArity</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">am_ped_bot :: AnalysisMode -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#am_ped_bot"><span class="hs-identifier hs-var">am_ped_bot</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681063124"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681063124"><span class="hs-identifier hs-var">ped_bot</span></a></span></span><span> </span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681063124"><span class="hs-identifier hs-var">ped_bot</span></a></span><span>
</span><span id="line-1004"></span><span>
</span><span id="line-1005"></span><span class="hs-comment">-- | A version of 'exprIsCheap' that considers results from arity analysis</span><span>
</span><span id="line-1006"></span><span class="hs-comment">-- and optionally the expression's type.</span><span>
</span><span id="line-1007"></span><span class="hs-comment">-- Under 'exprBotStrictness_maybe', no expressions are cheap.</span><span>
</span><span id="line-1008"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#myExprIsCheap"><span class="hs-identifier hs-type">myExprIsCheap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1009"></span><span id="myExprIsCheap"><span class="annot"><span class="annottext">myExprIsCheap :: ArityEnv -&gt; CoreExpr -&gt; Maybe Type -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#myExprIsCheap"><span class="hs-identifier hs-var hs-var">myExprIsCheap</span></a></span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AE"><span class="hs-identifier hs-type">AE</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">ae_mode :: ArityEnv -&gt; AnalysisMode
</span><a href="GHC.Core.Opt.Arity.html#ae_mode"><span class="hs-identifier hs-var">ae_mode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681063122"><span class="annot"><span class="annottext">AnalysisMode
</span><a href="#local-6989586621681063122"><span class="hs-identifier hs-var">mode</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621681063121"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063121"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621681063120"><span class="annot"><span class="annottext">Maybe Type
</span><a href="#local-6989586621681063120"><span class="hs-identifier hs-var">mb_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AnalysisMode
</span><a href="#local-6989586621681063122"><span class="hs-identifier hs-var">mode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1010"></span><span>  </span><span class="annot"><span class="annottext">AnalysisMode
</span><a href="GHC.Core.Opt.Arity.html#BotStrictness"><span class="hs-identifier hs-var">BotStrictness</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1011"></span><span>  </span><span class="annot"><span class="annottext">AnalysisMode
</span><span class="hs-identifier">_</span></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681063119"><span class="hs-identifier hs-var">cheap_dict</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="#local-6989586621681063118"><span class="hs-identifier hs-var">cheap_fun</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063121"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1012"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1013"></span><span>      </span><span id="local-6989586621681063119"><span class="annot"><span class="annottext">cheap_dict :: Bool
</span><a href="#local-6989586621681063119"><span class="hs-identifier hs-var hs-var">cheap_dict</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalysisMode -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#am_dicts_cheap"><span class="hs-identifier hs-var">am_dicts_cheap</span></a></span><span> </span><span class="annot"><span class="annottext">AnalysisMode
</span><a href="#local-6989586621681063122"><span class="hs-identifier hs-var">mode</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Predicate.html#isDictTy"><span class="hs-identifier hs-var">isDictTy</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Type
</span><a href="#local-6989586621681063120"><span class="hs-identifier hs-var">mb_ty</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1014"></span><span>      </span><span id="local-6989586621681063118"><span class="annot"><span class="annottext">cheap_fun :: CoreExpr -&gt; Bool
</span><a href="#local-6989586621681063118"><span class="hs-identifier hs-var hs-var">cheap_fun</span></a></span></span><span> </span><span id="local-6989586621681063117"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063117"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AnalysisMode
</span><a href="#local-6989586621681063122"><span class="hs-identifier hs-var">mode</span></a></span><span> </span><span class="hs-keyword">of</span><span class="hs-cpp">
#if __GLASGOW_HASKELL__ &lt;= 900
</span><span>        </span><span class="hs-identifier">BotStrictness</span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">panic</span><span> </span><span class="hs-string">&quot;impossible&quot;</span><span class="hs-cpp">
#endif
</span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EtaExpandArity"><span class="hs-identifier hs-type">EtaExpandArity</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsCheap"><span class="hs-identifier hs-var">exprIsCheap</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063117"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1019"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#FindRhsArity"><span class="hs-identifier hs-type">FindRhsArity</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">am_sigs :: AnalysisMode -&gt; IdEnv ArityType
</span><a href="GHC.Core.Opt.Arity.html#am_sigs"><span class="hs-identifier hs-var">am_sigs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681063115"><span class="annot"><span class="annottext">IdEnv ArityType
</span><a href="#local-6989586621681063115"><span class="hs-identifier hs-var">sigs</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CheapAppFun -&gt; CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsCheapX"><span class="hs-identifier hs-var">exprIsCheapX</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdEnv ArityType -&gt; CheapAppFun
</span><a href="GHC.Core.Opt.Arity.html#myIsCheapApp"><span class="hs-identifier hs-var">myIsCheapApp</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv ArityType
</span><a href="#local-6989586621681063115"><span class="hs-identifier hs-var">sigs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063117"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1020"></span><span>
</span><span id="line-1021"></span><span class="hs-comment">-- | A version of 'isCheapApp' that considers results from arity analysis.</span><span>
</span><span id="line-1022"></span><span class="hs-comment">-- See Note [Arity analysis] for what's in the signature environment and why</span><span>
</span><span id="line-1023"></span><span class="hs-comment">-- it's important.</span><span>
</span><span id="line-1024"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#myIsCheapApp"><span class="hs-identifier hs-type">myIsCheapApp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#CheapAppFun"><span class="hs-identifier hs-type">CheapAppFun</span></a></span><span>
</span><span id="line-1025"></span><span id="myIsCheapApp"><span class="annot"><span class="annottext">myIsCheapApp :: IdEnv ArityType -&gt; CheapAppFun
</span><a href="GHC.Core.Opt.Arity.html#myIsCheapApp"><span class="hs-identifier hs-var hs-var">myIsCheapApp</span></a></span></span><span> </span><span id="local-6989586621681063112"><span class="annot"><span class="annottext">IdEnv ArityType
</span><a href="#local-6989586621681063112"><span class="hs-identifier hs-var">sigs</span></a></span></span><span> </span><span id="local-6989586621681063111"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063111"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621681063110"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063110"><span class="hs-identifier hs-var">n_val_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. VarEnv a -&gt; TyVar -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdEnv ArityType
</span><a href="#local-6989586621681063112"><span class="hs-identifier hs-var">sigs</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063111"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1026"></span><span>  </span><span class="hs-comment">-- Nothing means not a local function, fall back to regular</span><span>
</span><span id="line-1027"></span><span>  </span><span class="hs-comment">-- 'GHC.Core.Utils.isCheapApp'</span><span>
</span><span id="line-1028"></span><span>  </span><span class="annot"><span class="annottext">Maybe ArityType
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CheapAppFun
</span><a href="GHC.Core.Utils.html#isCheapApp"><span class="hs-identifier hs-var">isCheapApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063111"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063110"><span class="hs-identifier hs-var">n_val_args</span></a></span><span>
</span><span id="line-1029"></span><span>
</span><span id="line-1030"></span><span>  </span><span class="hs-comment">-- `Just at` means local function with `at` as current SafeArityType.</span><span>
</span><span id="line-1031"></span><span>  </span><span class="hs-comment">-- NB the SafeArityType bit: that means we can ignore the cost flags</span><span>
</span><span id="line-1032"></span><span>  </span><span class="hs-comment">--    in 'lams', and just consider the length</span><span>
</span><span id="line-1033"></span><span>  </span><span class="hs-comment">-- Roughly approximate what 'isCheapApp' is doing.</span><span>
</span><span id="line-1034"></span><span>  </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621681063108"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063108"><span class="hs-identifier hs-var">oss</span></a></span></span><span> </span><span id="local-6989586621681063107"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063107"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1035"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Divergence -&gt; Bool
</span><a href="GHC.Types.Demand.html#isDeadEndDiv"><span class="hs-identifier hs-var">isDeadEndDiv</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063107"><span class="hs-identifier hs-var">div</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- See Note [isCheapApp: bottoming functions] in GHC.Core.Utils</span><span>
</span><span id="line-1036"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063110"><span class="hs-identifier hs-var">n_val_args</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../../base-4.16.4.0/src/Data-Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063108"><span class="hs-identifier hs-var">oss</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- Essentially isWorkFreeApp</span><span>
</span><span id="line-1037"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1038"></span><span>
</span><span id="line-1039"></span><span class="hs-comment">----------------</span><span>
</span><span id="line-1040"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-type">arityType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-1041"></span><span class="hs-comment">-- Precondition: all the free join points of the expression</span><span>
</span><span id="line-1042"></span><span class="hs-comment">--               are bound by the ArityEnv</span><span>
</span><span id="line-1043"></span><span class="hs-comment">-- See Note [No free join points in arityType]</span><span>
</span><span id="line-1044"></span><span>
</span><span id="line-1045"></span><span id="arityType"><span class="annot"><span class="annottext">arityType :: HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var hs-var">arityType</span></a></span></span><span> </span><span id="local-6989586621681063086"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063086"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621681063085"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063085"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621681063084"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681063084"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1046"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityType -&gt; Int -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#minWithArity"><span class="hs-identifier hs-var">minWithArity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063086"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063085"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063083"><span class="hs-identifier hs-var">co_arity</span></a></span><span> </span><span class="hs-comment">-- See Note [Arity trimming]</span><span>
</span><span id="line-1047"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1048"></span><span>    </span><span id="local-6989586621681063083"><span class="annot"><span class="annottext">co_arity :: Int
</span><a href="#local-6989586621681063083"><span class="hs-identifier hs-var hs-var">co_arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../../base-4.16.4.0/src/Data-Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; [OneShotInfo]
</span><a href="GHC.Core.Opt.Arity.html#typeArity"><span class="hs-identifier hs-var">typeArity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionRKind"><span class="hs-identifier hs-var">coercionRKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681063084"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1049"></span><span>    </span><span class="hs-comment">-- See Note [exprArity invariant] (2); must be true of</span><span>
</span><span id="line-1050"></span><span>    </span><span class="hs-comment">-- arityType too, since that is how we compute the arity</span><span>
</span><span id="line-1051"></span><span>    </span><span class="hs-comment">-- of variables, and they in turn affect result of exprArity</span><span>
</span><span id="line-1052"></span><span>    </span><span class="hs-comment">-- #5441 is a nice demo</span><span>
</span><span id="line-1053"></span><span>
</span><span id="line-1054"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span id="local-6989586621681063082"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063082"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681063081"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063081"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1055"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681063080"><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063080"><span class="hs-identifier hs-var">at</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; TyVar -&gt; Maybe ArityType
</span><a href="GHC.Core.Opt.Arity.html#lookupSigEnv"><span class="hs-identifier hs-var">lookupSigEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063082"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063081"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-comment">-- Local binding</span><span>
</span><span id="line-1056"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063080"><span class="hs-identifier hs-var">at</span></a></span><span>
</span><span id="line-1057"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1058"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isFindRhsArity</span><span> </span><span class="hs-identifier">env</span><span> </span><span class="hs-operator">&amp;&amp;</span><span> </span><span class="hs-identifier">isJoinId</span><span> </span><span class="hs-identifier">v</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">v</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1059"></span><span>    </span><span class="hs-comment">-- All join-point should be in the ae_sigs</span><span>
</span><span id="line-1060"></span><span>    </span><span class="hs-comment">-- See Note [No free join points in arityType]</span><span>
</span><span id="line-1061"></span><span>    </span><span class="annot"><span class="annottext">TyVar -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#idArityType"><span class="hs-identifier hs-var">idArityType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063081"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1062"></span><span>
</span><span id="line-1063"></span><span>        </span><span class="hs-comment">-- Lambdas; increase arity</span><span>
</span><span id="line-1064"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span id="local-6989586621681063077"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063077"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621681063076"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063076"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621681063075"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063075"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1065"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063076"><span class="hs-identifier hs-var">x</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; ArityType -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#arityLam"><span class="hs-identifier hs-var">arityLam</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063076"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063074"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063075"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1066"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063074"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063075"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1067"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1068"></span><span>    </span><span id="local-6989586621681063074"><span class="annot"><span class="annottext">env' :: ArityEnv
</span><a href="#local-6989586621681063074"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; TyVar -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#delInScope"><span class="hs-identifier hs-var">delInScope</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063077"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063076"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1069"></span><span>
</span><span id="line-1070"></span><span>        </span><span class="hs-comment">-- Applications; decrease arity, except for types</span><span>
</span><span id="line-1071"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span id="local-6989586621681063073"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063073"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621681063072"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063072"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1072"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063073"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063072"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-1073"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span id="local-6989586621681063071"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063071"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621681063070"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063070"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621681063069"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063069"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1074"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityType -&gt; Bool -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#arityApp"><span class="hs-identifier hs-var">arityApp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063071"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063070"><span class="hs-identifier hs-var">fun</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArityEnv -&gt; CoreExpr -&gt; Maybe Type -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#myExprIsCheap"><span class="hs-identifier hs-var">myExprIsCheap</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063071"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063069"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1075"></span><span>
</span><span id="line-1076"></span><span>        </span><span class="hs-comment">-- Case/Let; keep arity if either the expression is cheap</span><span>
</span><span id="line-1077"></span><span>        </span><span class="hs-comment">-- or it's a 1-shot lambda</span><span>
</span><span id="line-1078"></span><span>        </span><span class="hs-comment">-- The former is not really right for Haskell</span><span>
</span><span id="line-1079"></span><span>        </span><span class="hs-comment">--      f x = case x of { (a,b) -&gt; \y. e }</span><span>
</span><span id="line-1080"></span><span>        </span><span class="hs-comment">--  ===&gt;</span><span>
</span><span id="line-1081"></span><span>        </span><span class="hs-comment">--      f x y = case x of { (a,b) -&gt; e }</span><span>
</span><span id="line-1082"></span><span>        </span><span class="hs-comment">-- The difference is observable using 'seq'</span><span>
</span><span id="line-1083"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-1084"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span id="local-6989586621681063068"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063068"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621681063066"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063066"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621681063065"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063065"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681063064"><span class="annot"><span class="annottext">[Alt TyVar]
</span><a href="#local-6989586621681063064"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1085"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsDeadEnd"><span class="hs-identifier hs-var">exprIsDeadEnd</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063066"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.16.4.0/src/Data-Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt TyVar]
</span><a href="#local-6989586621681063064"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-1086"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="GHC.Core.Opt.Arity.html#botArityType"><span class="hs-identifier hs-var">botArityType</span></a></span><span>    </span><span class="hs-comment">-- Do not eta expand. See Note [Dealing with bottom (1)]</span><span>
</span><span id="line-1087"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArityEnv -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#pedanticBottoms"><span class="hs-identifier hs-var">pedanticBottoms</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063068"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See Note [Dealing with bottom (2)]</span><span>
</span><span id="line-1088"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; CoreExpr -&gt; Maybe Type -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#myExprIsCheap"><span class="hs-identifier hs-var">myExprIsCheap</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063068"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063066"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063065"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1089"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063062"><span class="hs-identifier hs-var">alts_type</span></a></span><span>
</span><span id="line-1090"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprOkForSpeculation"><span class="hs-identifier hs-var">exprOkForSpeculation</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063066"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-1091"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063062"><span class="hs-identifier hs-var">alts_type</span></a></span><span>
</span><span id="line-1092"></span><span>
</span><span id="line-1093"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                  </span><span class="hs-comment">-- In the remaining cases we may not push</span><span>
</span><span id="line-1094"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityType -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#takeWhileOneShot"><span class="hs-identifier hs-var">takeWhileOneShot</span></a></span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="#local-6989586621681063062"><span class="hs-identifier hs-var">alts_type</span></a></span><span> </span><span class="hs-comment">-- evaluation of the scrutinee in</span><span>
</span><span id="line-1095"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1096"></span><span>    </span><span id="local-6989586621681063060"><span class="annot"><span class="annottext">env' :: ArityEnv
</span><a href="#local-6989586621681063060"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; TyVar -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#delInScope"><span class="hs-identifier hs-var">delInScope</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063068"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063065"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1097"></span><span>    </span><span id="local-6989586621681063059"><span class="annot"><span class="annottext">arity_type_alt :: Alt TyVar -&gt; ArityType
</span><a href="#local-6989586621681063059"><span class="hs-identifier hs-var hs-var">arity_type_alt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621681063057"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681063057"><span class="hs-identifier hs-var">_con</span></a></span></span><span> </span><span id="local-6989586621681063056"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681063056"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621681063055"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063055"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArityEnv -&gt; [TyVar] -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#delInScopeList"><span class="hs-identifier hs-var">delInScopeList</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063060"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681063056"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063055"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1098"></span><span>    </span><span id="local-6989586621681063062"><span class="annot"><span class="annottext">alts_type :: ArityType
</span><a href="#local-6989586621681063062"><span class="hs-identifier hs-var hs-var">alts_type</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; a -&gt; a) -&gt; t a -&gt; a
</span><a href="../../base-4.16.4.0/src/Data-Foldable.html#foldr1"><span class="hs-identifier hs-var">foldr1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArityEnv -&gt; ArityType -&gt; ArityType -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#andArityType"><span class="hs-identifier hs-var">andArityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063068"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Alt TyVar -&gt; ArityType
</span><a href="#local-6989586621681063059"><span class="hs-identifier hs-var">arity_type_alt</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt TyVar]
</span><a href="#local-6989586621681063064"><span class="hs-identifier hs-var">alts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1099"></span><span>
</span><span id="line-1100"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span id="local-6989586621681063053"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063053"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621681063050"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063050"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621681063049"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063049"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681063048"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063048"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1101"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- See Note [arityType for let-bindings]</span><span>
</span><span id="line-1102"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; ArityType -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#floatIn"><span class="hs-identifier hs-var">floatIn</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681063047"><span class="hs-identifier hs-var">cheap_rhs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063046"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063048"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1103"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1104"></span><span>    </span><span id="local-6989586621681063047"><span class="annot"><span class="annottext">cheap_rhs :: Bool
</span><a href="#local-6989586621681063047"><span class="hs-identifier hs-var hs-var">cheap_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; CoreExpr -&gt; Maybe Type -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#myExprIsCheap"><span class="hs-identifier hs-var">myExprIsCheap</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063053"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063049"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063050"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1105"></span><span>    </span><span id="local-6989586621681063046"><span class="annot"><span class="annottext">env' :: ArityEnv
</span><a href="#local-6989586621681063046"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; TyVar -&gt; ArityType -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#extendSigEnv"><span class="hs-identifier hs-var">extendSigEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063053"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063050"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063053"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063049"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1106"></span><span>
</span><span id="line-1107"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span id="local-6989586621681063045"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063045"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621681063043"><span class="annot"><span class="annottext">[(TyVar, CoreExpr)]
</span><a href="#local-6989586621681063043"><span class="hs-identifier hs-var">prs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681063042"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063042"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1108"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; ArityType -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#floatIn"><span class="hs-identifier hs-var">floatIn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../../base-4.16.4.0/src/Data-Foldable.html#all"><span class="hs-identifier hs-var">all</span></a></span><span> </span><span class="annot"><span class="annottext">(TyVar, CoreExpr) -&gt; Bool
</span><a href="#local-6989586621681063040"><span class="hs-identifier hs-var">is_cheap</span></a></span><span> </span><span class="annot"><span class="annottext">[(TyVar, CoreExpr)]
</span><a href="#local-6989586621681063043"><span class="hs-identifier hs-var">prs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063039"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063042"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1109"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1110"></span><span>    </span><span id="local-6989586621681063040"><span class="annot"><span class="annottext">is_cheap :: (TyVar, CoreExpr) -&gt; Bool
</span><a href="#local-6989586621681063040"><span class="hs-identifier hs-var hs-var">is_cheap</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681063038"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063038"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681063037"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063037"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; CoreExpr -&gt; Maybe Type -&gt; Bool
</span><a href="GHC.Core.Opt.Arity.html#myExprIsCheap"><span class="hs-identifier hs-var">myExprIsCheap</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063039"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063037"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063038"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1111"></span><span>    </span><span id="local-6989586621681063039"><span class="annot"><span class="annottext">env' :: ArityEnv
</span><a href="#local-6989586621681063039"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.16.4.0/src/Data-Foldable.html#foldl"><span class="hs-identifier hs-var">foldl</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; (TyVar, CoreExpr) -&gt; ArityEnv
</span><a href="#local-6989586621681063035"><span class="hs-identifier hs-var">extend_rec</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063045"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[(TyVar, CoreExpr)]
</span><a href="#local-6989586621681063043"><span class="hs-identifier hs-var">prs</span></a></span><span>
</span><span id="line-1112"></span><span>    </span><span class="annot"><a href="#local-6989586621681063035"><span class="hs-identifier hs-type">extend_rec</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityEnv"><span class="hs-identifier hs-type">ArityEnv</span></a></span><span>
</span><span id="line-1113"></span><span>    </span><span id="local-6989586621681063035"><span class="annot"><span class="annottext">extend_rec :: ArityEnv -&gt; (TyVar, CoreExpr) -&gt; ArityEnv
</span><a href="#local-6989586621681063035"><span class="hs-identifier hs-var hs-var">extend_rec</span></a></span></span><span> </span><span id="local-6989586621681063034"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063034"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681063033"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063033"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681063032"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063032"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityEnv -&gt; TyVar -&gt; ArityType -&gt; ArityEnv
</span><a href="GHC.Core.Opt.Arity.html#extendSigEnv"><span class="hs-identifier hs-var">extendSigEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063034"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063033"><span class="hs-identifier hs-var">b</span></a></span><span>  </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1114"></span><span>                           </span><span class="annot"><span class="annottext">[TyVar] -&gt; CoreExpr -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#mkManifestArityType"><span class="hs-identifier hs-var">mkManifestArityType</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681063031"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063030"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1115"></span><span>                         </span><span class="hs-keyword">where</span><span>
</span><span id="line-1116"></span><span>                           </span><span class="hs-special">(</span><span id="local-6989586621681063031"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681063031"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681063030"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063030"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b. Expr b -&gt; ([b], Expr b)
</span><a href="GHC.Core.html#collectBinders"><span class="hs-identifier hs-var">collectBinders</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063032"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1117"></span><span>      </span><span class="hs-comment">-- We can't call arityType on the RHS, because it might mention</span><span>
</span><span id="line-1118"></span><span>      </span><span class="hs-comment">-- join points bound in this very letrec, and we don't want to</span><span>
</span><span id="line-1119"></span><span>      </span><span class="hs-comment">-- do a fixpoint calculation here.  So we make do with the</span><span>
</span><span id="line-1120"></span><span>      </span><span class="hs-comment">-- manifest arity</span><span>
</span><span id="line-1121"></span><span>
</span><span id="line-1122"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span id="local-6989586621681063028"><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063028"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621681063027"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681063027"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621681063026"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063026"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1123"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishIsCode"><span class="hs-identifier hs-var">tickishIsCode</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681063027"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; ArityEnv -&gt; CoreExpr -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><a href="#local-6989586621681063028"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063026"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1124"></span><span>
</span><span id="line-1125"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#arityType"><span class="hs-identifier hs-var">arityType</span></a></span><span> </span><span class="annot"><span class="annottext">ArityEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityType
</span><a href="GHC.Core.Opt.Arity.html#topArityType"><span class="hs-identifier hs-var">topArityType</span></a></span><span>
</span><span id="line-1126"></span><span>
</span><span id="line-1127"></span><span>
</span><span id="line-1128"></span><span class="hs-comment">{- Note [No free join points in arityType]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we call arityType on this expression (EX1)
   \x . case x of True  -&gt; \y. e
                  False -&gt; $j 3
where $j is a join point.  It really makes no sense to talk of the arity
of this expression, because it has a free join point.  In particular, we
can't eta-expand the expression because we'd have do the same thing to the
binding of $j, and we can't see that binding.

If we had (EX2)
   \x. join $j y = blah
       case x of True  -&gt; \y. e
                 False -&gt; $j 3
then it would make perfect sense: we can determine $j's ArityType, and
propagate it to the usage site as usual.

But how can we get (EX1)?  It doesn't make much sense, because $j can't
be a join point under the \x anyway.  So we make it a precondition of
arityType that the argument has no free join-point Ids.  (This is checked
with an assesrt in the Var case of arityType.)

BUT the invariant risks being invalidated by one very narrow special case: runRW#
   join $j y = blah
   runRW# (\s. case x of True  -&gt; \y. e
                         False -&gt; $j x)

We have special magic in OccurAnal, and Simplify to allow continuations to
move into the body of a runRW# call.

So we are careful never to attempt to eta-expand the (\s.blah) in the
argument to runRW#, at least not when there is a literal lambda there,
so that OccurAnal has seen it and allowed join points bound outside.
See Note [No eta-expansion in runRW#] in GHC.Core.Opt.Simplify.Iteration.

Note [arityType for let-bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For non-recursive let-bindings, we just get the arityType of the RHS,
and extend the environment.  That works nicely for things like this
(#18793):
  go = \ ds. case ds_a2CF of {
               []     -&gt; id
               : y ys -&gt; case y of { GHC.Types.I# x -&gt;
                         let acc = go ys in
                         case x &gt;# 42# of {
                            __DEFAULT -&gt; acc
                            1# -&gt; \x1. acc (negate x2)

Here we want to get a good arity for `acc`, based on the ArityType
of `go`.

All this is particularly important for join points. Consider this (#18328)

  f x = join j y = case y of
                      True -&gt; \a. blah
                      False -&gt; \b. blah
        in case x of
              A -&gt; j True
              B -&gt; \c. blah
              C -&gt; j False

and suppose the join point is too big to inline.  Now, what is the
arity of f?  If we inlined the join point, we'd definitely say &quot;arity
2&quot; because we are prepared to push case-scrutinisation inside a
lambda. It's important that we extend the envt with j's ArityType,
so that we can use that information in the A/C branch of the case.

For /recursive/ bindings it's more difficult, to call arityType,
because we don't have an ArityType to put in the envt for the
recursively bound Ids.  So for non-join-point bindings we satisfy
ourselves with mkManifestArityType.  Typically we'll have eta-expanded
the binding (based on an earlier fixpoint calculation in
findRhsArity), so the manifest arity is good.

But for /recursive join points/ things are not so good.
See Note [Arity type for recursive join bindings]

See Note [Arity type for recursive join bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  f x = joinrec j 0 = \ a b c -&gt; (a,x,b)
                j n = j (n-1)
        in j 20

Obviously `f` should get arity 4.  But the manifest arity of `j`
is 1.  Remember, we don't eta-expand join points; see
GHC.Core.Opt.Simplify.Utils Note [Do not eta-expand join points].
And the ArityInfo on `j` will be just 1 too; see GHC.Core
Note [Invariants on join points], item (2b).  So using
Note [ArityType for let-bindings] won't work well.

We could do a fixpoint iteration, but that's a heavy hammer
to use in arityType.  So we take advantage of it being a join
point:

* Extend the ArityEnv to bind each of the recursive binders
  (all join points) to `botArityType`.  This means that any
  jump to the join point will return botArityType, which is
  unit for `andArityType`:
      botAritType `andArityType` at = at
  So it's almost as if those &quot;jump&quot; branches didn't exist.

* In this extended env, find the ArityType of each of the RHS, after
  stripping off the join-point binders.

* Use andArityType to combine all these RHS ArityTypes.

* Find the ArityType of the body, also in this strange extended
  environment

* And combine that into the result with andArityType.

In our example, the jump (j 20) will yield Bot, as will the jump
(j (n-1)). We'll 'and' those the ArityType of (\abc. blah).  Good!

In effect we are treating the RHSs as alternative bodies (like
in a case), and ignoring all jumps.  In this way we don't need
to take a fixpoint.  Tricky!

NB: we treat /non-recursive/ join points in the same way, but
actually it works fine to treat them uniformly with normal
let-bindings, and that takes less code.
-}</span><span>
</span><span id="line-1251"></span><span>
</span><span id="line-1252"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#idArityType"><span class="hs-identifier hs-type">idArityType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span>
</span><span id="line-1253"></span><span id="idArityType"><span class="annot"><span class="annottext">idArityType :: TyVar -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#idArityType"><span class="hs-identifier hs-var hs-var">idArityType</span></a></span></span><span> </span><span id="local-6989586621681063025"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063025"><span class="hs-identifier hs-var">v</span></a></span></span><span>
</span><span id="line-1254"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621681063024"><span class="annot"><span class="annottext">StrictSig
</span><a href="#local-6989586621681063024"><span class="hs-identifier hs-var">strict_sig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; StrictSig
</span><a href="GHC.Types.Id.html#idStrictness"><span class="hs-identifier hs-var">idStrictness</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063025"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1255"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSig -&gt; Bool
</span><a href="GHC.Types.Demand.html#isTopSig"><span class="hs-identifier hs-var">isTopSig</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSig
</span><a href="#local-6989586621681063024"><span class="hs-identifier hs-var">strict_sig</span></a></span><span>
</span><span id="line-1256"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681063021"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681063021"><span class="hs-identifier hs-var">ds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681063020"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063020"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictSig -&gt; ([Demand], Divergence)
</span><a href="GHC.Types.Demand.html#splitStrictSig"><span class="hs-identifier hs-var">splitStrictSig</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSig
</span><a href="#local-6989586621681063024"><span class="hs-identifier hs-var">strict_sig</span></a></span><span>
</span><span id="line-1257"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681063018"><span class="annot"><span class="annottext">arity :: Int
</span><a href="#local-6989586621681063018"><span class="hs-identifier hs-var hs-var">arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../../base-4.16.4.0/src/Data-Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681063021"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-1258"></span><span>  </span><span class="hs-comment">-- Every strictness signature admits an arity signature!</span><span>
</span><span id="line-1259"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; Divergence -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Int -&gt; [a] -&gt; [a]
</span><a href="../../base-4.16.4.0/src/GHC-List.html#take"><span class="hs-identifier hs-var">take</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063018"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063017"><span class="hs-identifier hs-var">one_shots</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681063020"><span class="hs-identifier hs-var">div</span></a></span><span>
</span><span id="line-1260"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1261"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; Divergence -&gt; ArityType
</span><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-var">AT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Int -&gt; [a] -&gt; [a]
</span><a href="../../base-4.16.4.0/src/GHC-List.html#take"><span class="hs-identifier hs-var">take</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Int
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063025"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063017"><span class="hs-identifier hs-var">one_shots</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#topDiv"><span class="hs-identifier hs-var">topDiv</span></a></span><span>
</span><span id="line-1262"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1263"></span><span>    </span><span class="annot"><a href="#local-6989586621681063017"><span class="hs-identifier hs-type">one_shots</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Basic.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a></span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- One-shot-ness derived from the type</span><span>
</span><span id="line-1264"></span><span>    </span><span id="local-6989586621681063017"><span class="annot"><span class="annottext">one_shots :: [OneShotInfo]
</span><a href="#local-6989586621681063017"><span class="hs-identifier hs-var hs-var">one_shots</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [OneShotInfo]
</span><a href="GHC.Core.Opt.Arity.html#typeArity"><span class="hs-identifier hs-var">typeArity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063025"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1265"></span><span>
</span><span id="line-1266"></span><span class="hs-comment">{-
%************************************************************************
%*                                                                      *
              The main eta-expander
%*                                                                      *
%************************************************************************

We go for:
   f = \x1..xn -&gt; N  ==&gt;   f = \x1..xn y1..ym -&gt; N y1..ym
                                 (n &gt;= 0)

where (in both cases)

        * The xi can include type variables

        * The yi are all value variables

        * N is a NORMAL FORM (i.e. no redexes anywhere)
          wanting a suitable number of extra args.

The biggest reason for doing this is for cases like

        f = \x -&gt; case x of
                    True  -&gt; \y -&gt; e1
                    False -&gt; \y -&gt; e2

Here we want to get the lambdas together.  A good example is the nofib
program fibheaps, which gets 25% more allocation if you don't do this
eta-expansion.

We may have to sandwich some coerces between the lambdas
to make the types work.   exprEtaExpandArity looks through coerces
when computing arity; and etaExpand adds the coerces as necessary when
actually computing the expansion.

Note [No crap in eta-expanded code]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The eta expander is careful not to introduce &quot;crap&quot;.  In particular,
given a CoreExpr satisfying the 'CpeRhs' invariant (in CorePrep), it
returns a CoreExpr satisfying the same invariant. See Note [Eta
expansion and the CorePrep invariants] in CorePrep.

This means the eta-expander has to do a bit of on-the-fly
simplification but it's not too hard.  The alternative, of relying on
a subsequent clean-up phase of the Simplifier to de-crapify the result,
means you can't really use it in CorePrep, which is painful.

Note [Eta expansion for join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The no-crap rule is very tiresome to guarantee when
we have join points. Consider eta-expanding
   let j :: Int -&gt; Int -&gt; Bool
       j x = e
   in b

The simple way is
  \(y::Int). (let j x = e in b) y

The no-crap way is
  \(y::Int). let j' :: Int -&gt; Bool
                 j' x = e y
             in b[j'/j] y
where I have written to stress that j's type has
changed.  Note that (of course!) we have to push the application
inside the RHS of the join as well as into the body.  AND if j
has an unfolding we have to push it into there too.  AND j might
be recursive...

So for now I'm abandoning the no-crap rule in this case. I think
that for the use in CorePrep it really doesn't matter; and if
it does, then CoreToStg.myCollectArgs will fall over.

(Moreover, I think that casts can make the no-crap rule fail too.)

Note [Eta expansion and SCCs]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Note that SCCs are not treated specially by etaExpand.  If we have
        etaExpand 2 (\x -&gt; scc &quot;foo&quot; e)
        = (\xy -&gt; (scc &quot;foo&quot; e) y)
So the costs of evaluating 'e' (not 'e y') are attributed to &quot;foo&quot;

Note [Eta expansion and source notes]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
CorePrep puts floatable ticks outside of value applications, but not
type applications. As a result we might be trying to eta-expand an
expression like

  (src&lt;...&gt; v) @a

which we want to lead to code like

  \x -&gt; src&lt;...&gt; v @a x

This means that we need to look through type applications and be ready
to re-add floats on the top.

Note [Eta expansion with ArityType]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The etaExpandAT function takes an ArityType (not just an Arity) to
guide eta-expansion.  Why? Because we want to preserve one-shot info.
Consider
  foo = \x. case x of
              True  -&gt; (\s{os}. blah) |&gt; co
              False -&gt; wubble
We'll get an ArityType for foo of \?1.T.

Then we want to eta-expand to
  foo = \x. (\eta{os}. (case x of ...as before...) eta) |&gt; some_co

That 'eta' binder is fresh, and we really want it to have the
one-shot flag from the inner \s{os}.  By expanding with the
ArityType gotten from analysing the RHS, we achieve this neatly.

This makes a big difference to the one-shot monad trick;
see Note [The one-shot state monad trick] in GHC.Utils.Monad.
-}</span><span>
</span><span id="line-1382"></span><span>
</span><span id="line-1383"></span><span class="hs-comment">-- | @etaExpand n e@ returns an expression with</span><span>
</span><span id="line-1384"></span><span class="hs-comment">-- the same meaning as @e@, but with arity @n@.</span><span>
</span><span id="line-1385"></span><span class="hs-comment">--</span><span>
</span><span id="line-1386"></span><span class="hs-comment">-- Given:</span><span>
</span><span id="line-1387"></span><span class="hs-comment">--</span><span>
</span><span id="line-1388"></span><span class="hs-comment">-- &gt; e' = etaExpand n e</span><span>
</span><span id="line-1389"></span><span class="hs-comment">--</span><span>
</span><span id="line-1390"></span><span class="hs-comment">-- We should have that:</span><span>
</span><span id="line-1391"></span><span class="hs-comment">--</span><span>
</span><span id="line-1392"></span><span class="hs-comment">-- &gt; ty = exprType e = exprType e'</span><span>
</span><span id="line-1393"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaExpand"><span class="hs-identifier hs-type">etaExpand</span></a></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-1394"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaExpandAT"><span class="hs-identifier hs-type">etaExpandAT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#ArityType"><span class="hs-identifier hs-type">ArityType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-1395"></span><span>
</span><span id="line-1396"></span><span id="etaExpand"><span class="annot"><span class="annottext">etaExpand :: Int -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Arity.html#etaExpand"><span class="hs-identifier hs-var hs-var">etaExpand</span></a></span></span><span>   </span><span id="local-6989586621681063016"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063016"><span class="hs-identifier hs-var">n</span></a></span></span><span>          </span><span id="local-6989586621681063015"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063015"><span class="hs-identifier hs-var">orig_expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Arity.html#eta_expand"><span class="hs-identifier hs-var">eta_expand</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Int -&gt; a -&gt; [a]
</span><a href="../../base-4.16.4.0/src/GHC-List.html#replicate"><span class="hs-identifier hs-var">replicate</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681063016"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="GHC.Types.Basic.html#NoOneShotInfo"><span class="hs-identifier hs-var">NoOneShotInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063015"><span class="hs-identifier hs-var">orig_expr</span></a></span><span>
</span><span id="line-1397"></span><span id="etaExpandAT"><span class="annot"><span class="annottext">etaExpandAT :: ArityType -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Arity.html#etaExpandAT"><span class="hs-identifier hs-var hs-var">etaExpandAT</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#AT"><span class="hs-identifier hs-type">AT</span></a></span><span> </span><span id="local-6989586621681063013"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063013"><span class="hs-identifier hs-var">oss</span></a></span></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681063012"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063012"><span class="hs-identifier hs-var">orig_expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Arity.html#eta_expand"><span class="hs-identifier hs-var">eta_expand</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063013"><span class="hs-identifier hs-var">oss</span></a></span><span>                         </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063012"><span class="hs-identifier hs-var">orig_expr</span></a></span><span>
</span><span id="line-1398"></span><span>                           </span><span class="hs-comment">-- See Note [Eta expansion with ArityType]</span><span>
</span><span id="line-1399"></span><span>
</span><span id="line-1400"></span><span class="hs-comment">-- etaExpand arity e = res</span><span>
</span><span id="line-1401"></span><span class="hs-comment">-- Then 'res' has at least 'arity' lambdas at the top</span><span>
</span><span id="line-1402"></span><span class="hs-comment">--    possibly with a cast wrapped around the outside</span><span>
</span><span id="line-1403"></span><span class="hs-comment">-- See Note [Eta expansion with ArityType]</span><span>
</span><span id="line-1404"></span><span class="hs-comment">--</span><span>
</span><span id="line-1405"></span><span class="hs-comment">-- etaExpand deals with for-alls. For example:</span><span>
</span><span id="line-1406"></span><span class="hs-comment">--              etaExpand 1 E</span><span>
</span><span id="line-1407"></span><span class="hs-comment">-- where  E :: forall a. a -&gt; a</span><span>
</span><span id="line-1408"></span><span class="hs-comment">-- would return</span><span>
</span><span id="line-1409"></span><span class="hs-comment">--      (/\b. \y::a -&gt; E b y)</span><span>
</span><span id="line-1410"></span><span>
</span><span id="line-1411"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#eta_expand"><span class="hs-identifier hs-type">eta_expand</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Basic.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-1412"></span><span id="eta_expand"><span class="annot"><span class="annottext">eta_expand :: [OneShotInfo] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Arity.html#eta_expand"><span class="hs-identifier hs-var hs-var">eta_expand</span></a></span></span><span> </span><span id="local-6989586621681063011"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063011"><span class="hs-identifier hs-var">one_shots</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621681063010"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063010"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621681063009"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681063009"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1413"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Coercion -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Arity.html#eta_expand"><span class="hs-identifier hs-var">eta_expand</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063011"><span class="hs-identifier hs-var">one_shots</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063010"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681063009"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1414"></span><span>
</span><span id="line-1415"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#eta_expand"><span class="hs-identifier hs-var">eta_expand</span></a></span><span> </span><span id="local-6989586621681063007"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063007"><span class="hs-identifier hs-var">one_shots</span></a></span></span><span> </span><span id="local-6989586621681063006"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063006"><span class="hs-identifier hs-var">orig_expr</span></a></span></span><span>
</span><span id="line-1416"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; [TyVar] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621681063005"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063007"><span class="hs-identifier hs-var">one_shots</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063006"><span class="hs-identifier hs-var">orig_expr</span></a></span><span>
</span><span id="line-1417"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1418"></span><span>      </span><span class="hs-comment">-- Strip off existing lambdas and casts before handing off to mkEtaWW</span><span>
</span><span id="line-1419"></span><span>      </span><span class="hs-comment">-- This is mainly to avoid spending time cloning binders and substituting</span><span>
</span><span id="line-1420"></span><span>      </span><span class="hs-comment">-- when there is actually nothing to do.  It's slightly awkward to deal</span><span>
</span><span id="line-1421"></span><span>      </span><span class="hs-comment">-- with casts here, apart from the topmost one, and they are rare, so</span><span>
</span><span id="line-1422"></span><span>      </span><span class="hs-comment">-- if we find one we just hand off to mkEtaWW anyway</span><span>
</span><span id="line-1423"></span><span>      </span><span class="hs-comment">-- Note [Eta expansion and SCCs]</span><span>
</span><span id="line-1424"></span><span>    </span><span id="local-6989586621681063005"><span class="annot"><span class="annottext">go :: [OneShotInfo] -&gt; [TyVar] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621681063005"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063006"><span class="hs-identifier hs-var">orig_expr</span></a></span><span>  </span><span class="hs-comment">-- Already has the specified arity; no-op</span><span>
</span><span id="line-1425"></span><span>
</span><span id="line-1426"></span><span>    </span><span class="annot"><a href="#local-6989586621681063005"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681063004"><span class="annot"><span class="annottext">oss :: [OneShotInfo]
</span><a href="#local-6989586621681063004"><span class="hs-identifier hs-var">oss</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">OneShotInfo
</span><span class="hs-identifier">_</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681063003"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063003"><span class="hs-identifier hs-var">oss1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681063002"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681063002"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621681063001"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063001"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621681063000"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063000"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1427"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063001"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; [TyVar] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621681063005"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063004"><span class="hs-identifier hs-var">oss</span></a></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063001"><span class="hs-identifier hs-var">v</span></a></span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681063002"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063000"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1428"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo] -&gt; [TyVar] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621681063005"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681063003"><span class="hs-identifier hs-var">oss1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681063001"><span class="hs-identifier hs-var">v</span></a></span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681063002"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063000"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1429"></span><span>
</span><span id="line-1430"></span><span>    </span><span class="annot"><a href="#local-6989586621681063005"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681062998"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681062998"><span class="hs-identifier hs-var">oss</span></a></span></span><span> </span><span id="local-6989586621681062997"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062997"><span class="hs-identifier hs-var">rev_vs</span></a></span></span><span> </span><span id="local-6989586621681062996"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062996"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-1431"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;ee&quot; (vcat [ppr orig_expr, ppr expr, pprEtaInfos etas]) $</span><span>
</span><span id="line-1432"></span><span>        </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621681062995"><span class="hs-identifier hs-var">retick</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">EtaInfo -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Arity.html#etaInfoAbs"><span class="hs-identifier hs-var">etaInfoAbs</span></a></span><span> </span><span class="annot"><span class="annottext">EtaInfo
</span><a href="#local-6989586621681062993"><span class="hs-identifier hs-var">top_eis</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1433"></span><span>                 </span><span class="annot"><span class="annottext">InScopeSet -&gt; CoreExpr -&gt; EtaInfo -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Arity.html#etaInfoApp"><span class="hs-identifier hs-var">etaInfoApp</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681062991"><span class="hs-identifier hs-var">in_scope'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062990"><span class="hs-identifier hs-var">sexpr</span></a></span><span> </span><span class="annot"><span class="annottext">EtaInfo
</span><a href="#local-6989586621681062989"><span class="hs-identifier hs-var">eis</span></a></span><span>
</span><span id="line-1434"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1435"></span><span>          </span><span id="local-6989586621681062988"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621681062988"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; VarSet
</span><a href="GHC.Core.FVs.html#exprFreeVars"><span class="hs-identifier hs-var">exprFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062996"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1436"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621681062991"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681062991"><span class="hs-identifier hs-var">in_scope'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062989"><span class="annot"><span class="annottext">eis :: EtaInfo
</span><a href="#local-6989586621681062989"><span class="hs-identifier hs-var">eis</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-type">EI</span></a></span><span> </span><span id="local-6989586621681062984"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062984"><span class="hs-identifier hs-var">eta_bndrs</span></a></span></span><span> </span><span id="local-6989586621681062983"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062983"><span class="hs-identifier hs-var">mco</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1437"></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
-&gt; SDoc -&gt; InScopeSet -&gt; Type -&gt; (InScopeSet, EtaInfo)
</span><a href="GHC.Core.Opt.Arity.html#mkEtaWW"><span class="hs-identifier hs-var">mkEtaWW</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681062998"><span class="hs-identifier hs-var">oss</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681063006"><span class="hs-identifier hs-var">orig_expr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681062988"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; Type
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062996"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1438"></span><span>          </span><span id="local-6989586621681062980"><span class="annot"><span class="annottext">top_bndrs :: [TyVar]
</span><a href="#local-6989586621681062980"><span class="hs-identifier hs-var hs-var">top_bndrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a]
</span><a href="../../base-4.16.4.0/src/GHC-List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062997"><span class="hs-identifier hs-var">rev_vs</span></a></span><span>
</span><span id="line-1439"></span><span>          </span><span id="local-6989586621681062993"><span class="annot"><span class="annottext">top_eis :: EtaInfo
</span><a href="#local-6989586621681062993"><span class="hs-identifier hs-var hs-var">top_eis</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; MCoercionR -&gt; EtaInfo
</span><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-var">EI</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062980"><span class="hs-identifier hs-var">top_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062984"><span class="hs-identifier hs-var">eta_bndrs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; MCoercionR -&gt; MCoercionR
</span><a href="GHC.Core.Coercion.html#mkPiMCos"><span class="hs-identifier hs-var">mkPiMCos</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062980"><span class="hs-identifier hs-var">top_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062983"><span class="hs-identifier hs-var">mco</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1440"></span><span>
</span><span id="line-1441"></span><span>          </span><span class="hs-comment">-- Find ticks behind type apps.</span><span>
</span><span id="line-1442"></span><span>          </span><span class="hs-comment">-- See Note [Eta expansion and source notes]</span><span>
</span><span id="line-1443"></span><span>          </span><span class="hs-comment">-- I don't really understand this code SLPJ May 21</span><span>
</span><span id="line-1444"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621681062977"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062977"><span class="hs-identifier hs-var">expr'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062976"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062976"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b. Expr b -&gt; (Expr b, [Expr b])
</span><a href="GHC.Core.html#collectArgs"><span class="hs-identifier hs-var">collectArgs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062996"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-1445"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621681062974"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681062974"><span class="hs-identifier hs-var">ticks</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062973"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062973"><span class="hs-identifier hs-var">expr''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b.
(CoreTickish -&gt; Bool) -&gt; Expr b -&gt; ([CoreTickish], Expr b)
</span><a href="GHC.Core.Utils.html#stripTicksTop"><span class="hs-identifier hs-var">stripTicksTop</span></a></span><span> </span><span class="annot"><span class="annottext">forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062977"><span class="hs-identifier hs-var">expr'</span></a></span><span>
</span><span id="line-1446"></span><span>          </span><span id="local-6989586621681062990"><span class="annot"><span class="annottext">sexpr :: CoreExpr
</span><a href="#local-6989586621681062990"><span class="hs-identifier hs-var hs-var">sexpr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062973"><span class="hs-identifier hs-var">expr''</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062976"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-1447"></span><span>          </span><span id="local-6989586621681062995"><span class="annot"><span class="annottext">retick :: CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621681062995"><span class="hs-identifier hs-var hs-var">retick</span></a></span></span><span> </span><span id="local-6989586621681062969"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062969"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.16.4.0/src/Data-Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062969"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681062974"><span class="hs-identifier hs-var">ticks</span></a></span><span>
</span><span id="line-1448"></span><span>
</span><span id="line-1449"></span><span class="hs-comment">{- *********************************************************************
*                                                                      *
              The EtaInfo mechanism
          mkEtaWW, etaInfoAbs, etaInfoApp
*                                                                      *
********************************************************************* -}</span><span>
</span><span id="line-1455"></span><span>
</span><span id="line-1456"></span><span class="hs-comment">{- Note [The EtaInfo mechanism]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have (e :: ty) and we want to eta-expand it to arity N.
This what eta_expand does.  We do it in two steps:

1.  mkEtaWW: from 'ty' and 'N' build a EtaInfo which describes
    the shape of the expansion necessary to expand to arity N.

2.  Build the term
       \ v1..vn.  e v1 .. vn
    where those abstractions and applications are described by
    the same EtaInfo.  Specifically we build the term

       etaInfoAbs etas (etaInfoApp in_scope e etas)

   where etas :: EtaInfo
         etaInfoAbs builds the lambdas
         etaInfoApp builds the applictions

   Note that the /same/ EtaInfo drives both etaInfoAbs and etaInfoApp

To a first approximation EtaInfo is just [Var].  But
casts complicate the question.  If we have
   newtype N a = MkN (S -&gt; a)
and
   ty = N (N Int)
then the eta-expansion must look like
        (\x (\y. ((e |&gt; co1) x) |&gt; co2) y)
           |&gt; sym co2)
        |&gt; sym co1
where
  co1 :: N (N Int) ~ S -&gt; N Int
  co2 :: N Int     ~ S -&gt; Int

Blimey!  Look at all those casts.  Moreover, if the type
is very deeply nested (as happens in #18223), the repetition
of types can make the overall term very large.  So there is a big
payoff in cancelling out casts aggressively wherever possible.
(See also Note [No crap in eta-expanded code].)

This matters a lot in etaEInfoApp, where we
* Do beta-reduction on the fly
* Use getArg_maybe to get a cast out of the way,
  so that we can do beta reduction
Together this makes a big difference.  Consider when e is
   case x of
      True  -&gt; (\x -&gt; e1) |&gt; c1
      False -&gt; (\p -&gt; e2) |&gt; c2

When we eta-expand this to arity 1, say, etaInfoAbs will wrap
a (\eta) around the outside and use etaInfoApp to apply each
alternative to 'eta'.  We want to beta-reduce all that junk
away.

#18223 was a dramatic example in which the intermediate term was
grotesquely huge, even though the next Simplifier iteration squashed
it.  Better to kill it at birth.
-}</span><span>
</span><span id="line-1514"></span><span>
</span><span id="line-1515"></span><span class="hs-comment">--------------</span><span>
</span><span id="line-1516"></span><span class="hs-keyword">data</span><span> </span><span id="EtaInfo"><span class="annot"><a href="GHC.Core.Opt.Arity.html#EtaInfo"><span class="hs-identifier hs-var">EtaInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="EI"><span class="annot"><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-var">EI</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercionR"><span class="hs-identifier hs-type">MCoercionR</span></a></span><span>
</span><span id="line-1517"></span><span>
</span><span id="line-1518"></span><span class="hs-comment">-- EI bs co</span><span>
</span><span id="line-1519"></span><span class="hs-comment">-- Abstraction:  (\b1 b2 .. bn. []) |&gt; sym co</span><span>
</span><span id="line-1520"></span><span class="hs-comment">-- Application:  ([] |&gt; co) b1 b2 .. bn</span><span>
</span><span id="line-1521"></span><span class="hs-comment">--</span><span>
</span><span id="line-1522"></span><span class="hs-comment">--    e :: T    co :: T ~ (t1 -&gt; t2 -&gt; .. -&gt; tn -&gt; tr)</span><span>
</span><span id="line-1523"></span><span class="hs-comment">--    e = (\b1 b2 ... bn. (e |&gt; co) b1 b2 .. bn) |&gt; sym co</span><span>
</span><span id="line-1524"></span><span>
</span><span id="line-1525"></span><span>
</span><span id="line-1526"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaInfoApp"><span class="hs-identifier hs-type">etaInfoApp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EtaInfo"><span class="hs-identifier hs-type">EtaInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-1527"></span><span class="hs-comment">-- (etaInfoApp s e eis) returns something equivalent to</span><span>
</span><span id="line-1528"></span><span class="hs-comment">--             (substExpr s e `appliedto` eis)</span><span>
</span><span id="line-1529"></span><span class="hs-comment">-- See Note [The EtaInfo mechanism]</span><span>
</span><span id="line-1530"></span><span>
</span><span id="line-1531"></span><span id="etaInfoApp"><span class="annot"><span class="annottext">etaInfoApp :: InScopeSet -&gt; CoreExpr -&gt; EtaInfo -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Arity.html#etaInfoApp"><span class="hs-identifier hs-var hs-var">etaInfoApp</span></a></span></span><span> </span><span id="local-6989586621681062966"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681062966"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621681062965"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062965"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621681062964"><span class="annot"><span class="annottext">EtaInfo
</span><a href="#local-6989586621681062964"><span class="hs-identifier hs-var">eis</span></a></span></span><span>
</span><span id="line-1532"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; CoreExpr -&gt; EtaInfo -&gt; CoreExpr
</span><a href="#local-6989586621681062963"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet -&gt; Subst
</span><a href="GHC.Core.Subst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681062966"><span class="hs-identifier hs-var">in_scope</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062965"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">EtaInfo
</span><a href="#local-6989586621681062964"><span class="hs-identifier hs-var">eis</span></a></span><span>
</span><span id="line-1533"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1534"></span><span>    </span><span class="annot"><a href="#local-6989586621681062963"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EtaInfo"><span class="hs-identifier hs-type">EtaInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-1535"></span><span>    </span><span class="hs-comment">-- 'go' pushed down the eta-infos into the branch of a case</span><span>
</span><span id="line-1536"></span><span>    </span><span class="hs-comment">-- and the body of a let; and does beta-reduction if possible</span><span>
</span><span id="line-1537"></span><span>    </span><span class="hs-comment">--   go subst fun co [b1,..,bn]  returns  (subst(fun) |&gt; co) b1 .. bn</span><span>
</span><span id="line-1538"></span><span>    </span><span id="local-6989586621681062963"><span class="annot"><span class="annottext">go :: Subst -&gt; CoreExpr -&gt; EtaInfo -&gt; CoreExpr
</span><a href="#local-6989586621681062963"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681062961"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062961"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621681062960"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681062960"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621681062959"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062959"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681062958"><span class="annot"><span class="annottext">EtaInfo
</span><a href="#local-6989586621681062958"><span class="hs-identifier hs-var">eis</span></a></span></span><span>
</span><span id="line-1539"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b. CoreTickish -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-var">Tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; CoreTickish -&gt; CoreTickish
</span><a href="GHC.Core.Subst.html#substTickish"><span class="hs-identifier hs-var">substTickish</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062961"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681062960"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; CoreExpr -&gt; EtaInfo -&gt; CoreExpr
</span><a href="#local-6989586621681062963"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062961"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062959"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">EtaInfo
</span><a href="#local-6989586621681062958"><span class="hs-identifier hs-var">eis</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1540"></span><span>
</span><span id="line-1541"></span><span>    </span><span class="annot"><a href="#local-6989586621681062963"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681062956"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062956"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621681062955"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062955"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621681062954"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062954"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-type">EI</span></a></span><span> </span><span id="local-6989586621681062953"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062953"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621681062952"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062952"><span class="hs-identifier hs-var">mco</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1542"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; CoreExpr -&gt; EtaInfo -&gt; CoreExpr
</span><a href="#local-6989586621681062963"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062956"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062955"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; MCoercionR -&gt; EtaInfo
</span><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-var">EI</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062953"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; Subst -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Subst.html#substCo"><span class="hs-identifier hs-var">Core.substCo</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062956"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062954"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; MCoercionR -&gt; MCoercionR
</span><a href="GHC.Core.Coercion.html#mkTransMCoR"><span class="hs-operator hs-var">`mkTransMCoR`</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062952"><span class="hs-identifier hs-var">mco</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1543"></span><span>
</span><span id="line-1544"></span><span>    </span><span class="annot"><a href="#local-6989586621681062963"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681062949"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062949"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621681062948"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062948"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621681062947"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062947"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621681062946"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062946"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681062945"><span class="annot"><span class="annottext">[Alt TyVar]
</span><a href="#local-6989586621681062945"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681062944"><span class="annot"><span class="annottext">EtaInfo
</span><a href="#local-6989586621681062944"><span class="hs-identifier hs-var">eis</span></a></span></span><span>
</span><span id="line-1545"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b. Expr b -&gt; b -&gt; Type -&gt; [Alt b] -&gt; Expr b
</span><a href="GHC.Core.html#Case"><span class="hs-identifier hs-var">Case</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#substExprSC"><span class="hs-identifier hs-var">Core.substExprSC</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062949"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062948"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062942"><span class="hs-identifier hs-var">b1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062941"><span class="hs-identifier hs-var">ty'</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt TyVar]
</span><a href="#local-6989586621681062940"><span class="hs-identifier hs-var">alts'</span></a></span><span>
</span><span id="line-1546"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1547"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621681062939"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062939"><span class="hs-identifier hs-var">subst1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062942"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062942"><span class="hs-identifier hs-var">b1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; TyVar -&gt; (Subst, TyVar)
</span><a href="GHC.Core.Subst.html#substBndr"><span class="hs-identifier hs-var">Core.substBndr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062949"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062947"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1548"></span><span>        </span><span id="local-6989586621681062940"><span class="annot"><span class="annottext">alts' :: [Alt TyVar]
</span><a href="#local-6989586621681062940"><span class="hs-identifier hs-var hs-var">alts'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Alt TyVar -&gt; Alt TyVar
</span><a href="#local-6989586621681062937"><span class="hs-identifier hs-var">subst_alt</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt TyVar]
</span><a href="#local-6989586621681062945"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-1549"></span><span>        </span><span id="local-6989586621681062941"><span class="annot"><span class="annottext">ty' :: Type
</span><a href="#local-6989586621681062941"><span class="hs-identifier hs-var hs-var">ty'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; EtaInfo -&gt; Type
</span><a href="GHC.Core.Opt.Arity.html#etaInfoAppTy"><span class="hs-identifier hs-var">etaInfoAppTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; Type -&gt; Type
</span><a href="GHC.Core.Subst.html#substTy"><span class="hs-identifier hs-var">Core.substTy</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062949"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062946"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EtaInfo
</span><a href="#local-6989586621681062944"><span class="hs-identifier hs-var">eis</span></a></span><span>
</span><span id="line-1550"></span><span>        </span><span id="local-6989586621681062937"><span class="annot"><span class="annottext">subst_alt :: Alt TyVar -&gt; Alt TyVar
</span><a href="#local-6989586621681062937"><span class="hs-identifier hs-var hs-var">subst_alt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621681062934"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681062934"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621681062933"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062933"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621681062932"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062932"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681062934"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062931"><span class="hs-identifier hs-var">bs'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; CoreExpr -&gt; EtaInfo -&gt; CoreExpr
</span><a href="#local-6989586621681062963"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062930"><span class="hs-identifier hs-var">subst2</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062932"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">EtaInfo
</span><a href="#local-6989586621681062944"><span class="hs-identifier hs-var">eis</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1551"></span><span>                 </span><span class="hs-keyword">where</span><span>
</span><span id="line-1552"></span><span>                  </span><span class="hs-special">(</span><span id="local-6989586621681062930"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062930"><span class="hs-identifier hs-var">subst2</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681062931"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062931"><span class="hs-identifier hs-var">bs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [TyVar] -&gt; (Subst, [TyVar])
</span><a href="GHC.Core.Subst.html#substBndrs"><span class="hs-identifier hs-var">Core.substBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062939"><span class="hs-identifier hs-var">subst1</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062933"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-1553"></span><span>
</span><span id="line-1554"></span><span>    </span><span class="annot"><a href="#local-6989586621681062963"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681062928"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062928"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621681062927"><span class="annot"><span class="annottext">Bind TyVar
</span><a href="#local-6989586621681062927"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621681062926"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062926"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681062925"><span class="annot"><span class="annottext">EtaInfo
</span><a href="#local-6989586621681062925"><span class="hs-identifier hs-var">eis</span></a></span></span><span>
</span><span id="line-1555"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bind TyVar -&gt; Bool
</span><a href="GHC.Core.Utils.html#isJoinBind"><span class="hs-identifier hs-var">isJoinBind</span></a></span><span> </span><span class="annot"><span class="annottext">Bind TyVar
</span><a href="#local-6989586621681062927"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [Eta expansion for join points]</span><span>
</span><span id="line-1556"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b. Bind b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Bind TyVar
</span><a href="#local-6989586621681062923"><span class="hs-identifier hs-var">b'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; CoreExpr -&gt; EtaInfo -&gt; CoreExpr
</span><a href="#local-6989586621681062963"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062922"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062926"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">EtaInfo
</span><a href="#local-6989586621681062925"><span class="hs-identifier hs-var">eis</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1557"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1558"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621681062922"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062922"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062923"><span class="annot"><span class="annottext">Bind TyVar
</span><a href="#local-6989586621681062923"><span class="hs-identifier hs-var">b'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; Bind TyVar -&gt; (Subst, Bind TyVar)
</span><a href="GHC.Core.Subst.html#substBindSC"><span class="hs-identifier hs-var">Core.substBindSC</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062928"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Bind TyVar
</span><a href="#local-6989586621681062927"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1559"></span><span>
</span><span id="line-1560"></span><span>    </span><span class="hs-comment">-- Beta-reduction if possible, pushing any intervening casts past</span><span>
</span><span id="line-1561"></span><span>    </span><span class="hs-comment">-- the argument. See Note [The EtaInfo mechansim]</span><span>
</span><span id="line-1562"></span><span>    </span><span class="annot"><a href="#local-6989586621681062963"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681062920"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062920"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621681062919"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062919"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621681062918"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062918"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-type">EI</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062917"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062917"><span class="hs-identifier hs-var">b</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681062916"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062916"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681062915"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062915"><span class="hs-identifier hs-var">mco</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1563"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062914"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062914"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681062913"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062913"><span class="hs-identifier hs-var">mco'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MCoercionR -&gt; CoreExpr -&gt; Maybe (CoreExpr, MCoercionR)
</span><a href="GHC.Core.Opt.Arity.html#pushMCoArg"><span class="hs-identifier hs-var">pushMCoArg</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062915"><span class="hs-identifier hs-var">mco</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall b. TyVar -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062917"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1564"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; CoreExpr -&gt; EtaInfo -&gt; CoreExpr
</span><a href="#local-6989586621681062963"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; TyVar -&gt; CoreExpr -&gt; Subst
</span><a href="GHC.Core.Subst.html#extendSubst"><span class="hs-identifier hs-var">Core.extendSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062920"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062919"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062914"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062918"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; MCoercionR -&gt; EtaInfo
</span><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-var">EI</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062916"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062913"><span class="hs-identifier hs-var">mco'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1565"></span><span>
</span><span id="line-1566"></span><span>    </span><span class="hs-comment">-- Stop pushing down; just wrap the expression up</span><span>
</span><span id="line-1567"></span><span>    </span><span class="annot"><a href="#local-6989586621681062963"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681062909"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062909"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621681062908"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062908"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-type">EI</span></a></span><span> </span><span id="local-6989586621681062907"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062907"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621681062906"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062906"><span class="hs-identifier hs-var">mco</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#substExprSC"><span class="hs-identifier hs-var">Core.substExprSC</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062909"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062908"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1568"></span><span>                             </span><span class="annot"><span class="annottext">CoreExpr -&gt; MCoercionR -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCastMCo"><span class="hs-operator hs-var">`mkCastMCo`</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062906"><span class="hs-identifier hs-var">mco</span></a></span><span>
</span><span id="line-1569"></span><span>                             </span><span class="annot"><span class="annottext">forall b. Expr b -&gt; [TyVar] -&gt; Expr b
</span><a href="GHC.Core.html#mkVarApps"><span class="hs-operator hs-var">`mkVarApps`</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062907"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-1570"></span><span>
</span><span id="line-1571"></span><span class="hs-comment">--------------</span><span>
</span><span id="line-1572"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaInfoAppTy"><span class="hs-identifier hs-type">etaInfoAppTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EtaInfo"><span class="hs-identifier hs-type">EtaInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-1573"></span><span class="hs-comment">-- If                    e :: ty</span><span>
</span><span id="line-1574"></span><span class="hs-comment">-- then   etaInfoApp e eis :: etaInfoApp ty eis</span><span>
</span><span id="line-1575"></span><span id="etaInfoAppTy"><span class="annot"><span class="annottext">etaInfoAppTy :: Type -&gt; EtaInfo -&gt; Type
</span><a href="GHC.Core.Opt.Arity.html#etaInfoAppTy"><span class="hs-identifier hs-var hs-var">etaInfoAppTy</span></a></span></span><span> </span><span id="local-6989586621681062903"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062903"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-type">EI</span></a></span><span> </span><span id="local-6989586621681062902"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062902"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621681062901"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062901"><span class="hs-identifier hs-var">mco</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1576"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; Type -&gt; [CoreExpr] -&gt; Type
</span><a href="GHC.Core.Utils.html#applyTypeToArgs"><span class="hs-identifier hs-var">applyTypeToArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;etaInfoAppTy&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062899"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">forall b. TyVar -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062902"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1577"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1578"></span><span>    </span><span id="local-6989586621681062899"><span class="annot"><span class="annottext">ty1 :: Type
</span><a href="#local-6989586621681062899"><span class="hs-identifier hs-var hs-var">ty1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062901"><span class="hs-identifier hs-var">mco</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1579"></span><span>             </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062903"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1580"></span><span>             </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-type">MCo</span></a></span><span> </span><span id="local-6989586621681062896"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062896"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionRKind"><span class="hs-identifier hs-var">coercionRKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062896"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1581"></span><span>
</span><span id="line-1582"></span><span class="hs-comment">--------------</span><span>
</span><span id="line-1583"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaInfoAbs"><span class="hs-identifier hs-type">etaInfoAbs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EtaInfo"><span class="hs-identifier hs-type">EtaInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-1584"></span><span class="hs-comment">-- See Note [The EtaInfo mechanism]</span><span>
</span><span id="line-1585"></span><span id="etaInfoAbs"><span class="annot"><span class="annottext">etaInfoAbs :: EtaInfo -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.Arity.html#etaInfoAbs"><span class="hs-identifier hs-var hs-var">etaInfoAbs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-type">EI</span></a></span><span> </span><span id="local-6989586621681062895"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062895"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621681062894"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062894"><span class="hs-identifier hs-var">mco</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681062893"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062893"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall b. [b] -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062895"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062893"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; MCoercionR -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCastMCo"><span class="hs-operator hs-var">`mkCastMCo`</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR -&gt; MCoercionR
</span><a href="GHC.Core.Coercion.html#mkSymMCo"><span class="hs-identifier hs-var">mkSymMCo</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062894"><span class="hs-identifier hs-var">mco</span></a></span><span>
</span><span id="line-1586"></span><span>
</span><span id="line-1587"></span><span class="hs-comment">--------------</span><span>
</span><span id="line-1588"></span><span class="hs-comment">-- | @mkEtaWW n _ fvs ty@ will compute the 'EtaInfo' necessary for eta-expanding</span><span>
</span><span id="line-1589"></span><span class="hs-comment">-- an expression @e :: ty@ to take @n@ value arguments, where @fvs@ are the</span><span>
</span><span id="line-1590"></span><span class="hs-comment">-- free variables of @e@.</span><span>
</span><span id="line-1591"></span><span class="hs-comment">--</span><span>
</span><span id="line-1592"></span><span class="hs-comment">-- Note that this function is entirely unconcerned about cost centres and other</span><span>
</span><span id="line-1593"></span><span class="hs-comment">-- semantically-irrelevant source annotations, so call sites must take care to</span><span>
</span><span id="line-1594"></span><span class="hs-comment">-- preserve that info. See Note [Eta expansion and SCCs].</span><span>
</span><span id="line-1595"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#mkEtaWW"><span class="hs-identifier hs-type">mkEtaWW</span></a></span><span>
</span><span id="line-1596"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Basic.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1597"></span><span>  </span><span class="hs-comment">-- ^ How many value arguments to eta-expand</span><span>
</span><span id="line-1598"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-1599"></span><span>  </span><span class="hs-comment">-- ^ The pretty-printed original expression, for warnings.</span><span>
</span><span id="line-1600"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span>
</span><span id="line-1601"></span><span>  </span><span class="hs-comment">-- ^ A super-set of the free vars of the expression to eta-expand.</span><span>
</span><span id="line-1602"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-1603"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EtaInfo"><span class="hs-identifier hs-type">EtaInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1604"></span><span>  </span><span class="hs-comment">-- ^ The variables in 'EtaInfo' are fresh wrt. to the incoming 'InScopeSet'.</span><span>
</span><span id="line-1605"></span><span>  </span><span class="hs-comment">-- The outgoing 'InScopeSet' extends the incoming 'InScopeSet' with the</span><span>
</span><span id="line-1606"></span><span>  </span><span class="hs-comment">-- fresh variables in 'EtaInfo'.</span><span>
</span><span id="line-1607"></span><span>
</span><span id="line-1608"></span><span id="mkEtaWW"><span class="annot"><span class="annottext">mkEtaWW :: [OneShotInfo]
-&gt; SDoc -&gt; InScopeSet -&gt; Type -&gt; (InScopeSet, EtaInfo)
</span><a href="GHC.Core.Opt.Arity.html#mkEtaWW"><span class="hs-identifier hs-var hs-var">mkEtaWW</span></a></span></span><span> </span><span id="local-6989586621681062890"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681062890"><span class="hs-identifier hs-var">orig_oss</span></a></span></span><span> </span><span id="local-6989586621681062889"><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621681062889"><span class="hs-identifier hs-var">ppr_orig_expr</span></a></span></span><span> </span><span id="local-6989586621681062888"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681062888"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621681062887"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062887"><span class="hs-identifier hs-var">orig_ty</span></a></span></span><span>
</span><span id="line-1609"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [OneShotInfo] -&gt; TCvSubst -&gt; Type -&gt; (InScopeSet, EtaInfo)
</span><a href="#local-6989586621681062886"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681062890"><span class="hs-identifier hs-var">orig_oss</span></a></span><span> </span><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062885"><span class="hs-identifier hs-var">empty_subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062887"><span class="hs-identifier hs-var">orig_ty</span></a></span><span>
</span><span id="line-1610"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1611"></span><span>    </span><span id="local-6989586621681062885"><span class="annot"><span class="annottext">empty_subst :: TCvSubst
</span><a href="#local-6989586621681062885"><span class="hs-identifier hs-var hs-var">empty_subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; TCvSubst
</span><a href="GHC.Core.TyCo.Subst.html#mkEmptyTCvSubst"><span class="hs-identifier hs-var">mkEmptyTCvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681062888"><span class="hs-identifier hs-var">in_scope</span></a></span><span>
</span><span id="line-1612"></span><span>
</span><span id="line-1613"></span><span>    </span><span class="annot"><a href="#local-6989586621681062886"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>                </span><span class="hs-comment">-- For fresh names</span><span>
</span><span id="line-1614"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Basic.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a></span><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- Number of value args to expand to</span><span>
</span><span id="line-1615"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>   </span><span class="hs-comment">-- We are really looking at subst(ty)</span><span>
</span><span id="line-1616"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EtaInfo"><span class="hs-identifier hs-type">EtaInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1617"></span><span>    </span><span class="hs-comment">-- (go [o1,..,on] subst ty) = (in_scope, EI [b1,..,bn] co)</span><span>
</span><span id="line-1618"></span><span>    </span><span class="hs-comment">--    co :: subst(ty) ~ b1_ty -&gt; ... -&gt; bn_ty -&gt; tr</span><span>
</span><span id="line-1619"></span><span>
</span><span id="line-1620"></span><span>    </span><span id="local-6989586621681062886"><span class="annot"><span class="annottext">go :: Int -&gt; [OneShotInfo] -&gt; TCvSubst -&gt; Type -&gt; (InScopeSet, EtaInfo)
</span><a href="#local-6989586621681062886"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621681062883"><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062883"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span>       </span><span class="hs-comment">-- See Note [exprArity invariant]</span><span>
</span><span id="line-1621"></span><span>       </span><span class="hs-comment">----------- Done!  No more expansion needed</span><span>
</span><span id="line-1622"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TCvSubst -&gt; InScopeSet
</span><a href="GHC.Core.TyCo.Subst.html#getTCvInScope"><span class="hs-identifier hs-var">getTCvInScope</span></a></span><span> </span><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062883"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; MCoercionR -&gt; EtaInfo
</span><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-var">EI</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1623"></span><span>
</span><span id="line-1624"></span><span>    </span><span class="annot"><a href="#local-6989586621681062886"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681062881"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062881"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681062880"><span class="annot"><span class="annottext">oss :: [OneShotInfo]
</span><a href="#local-6989586621681062880"><span class="hs-identifier hs-var">oss</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621681062879"><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621681062879"><span class="hs-identifier hs-var">one_shot</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681062878"><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681062878"><span class="hs-identifier hs-var">oss1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681062877"><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062877"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621681062876"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062876"><span class="hs-identifier hs-var">ty</span></a></span></span><span>       </span><span class="hs-comment">-- See Note [exprArity invariant]</span><span>
</span><span id="line-1625"></span><span>       </span><span class="hs-comment">----------- Forall types  (forall a. ty)</span><span>
</span><span id="line-1626"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062875"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062875"><span class="hs-identifier hs-var">tcv</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681062874"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062874"><span class="hs-identifier hs-var">ty'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (TyVar, Type)
</span><a href="GHC.Core.Type.html#splitForAllTyCoVar_maybe"><span class="hs-identifier hs-var">splitForAllTyCoVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062876"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1627"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062873"><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062873"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062872"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062872"><span class="hs-identifier hs-var">tcv'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; TCvSubst -&gt; TyVar -&gt; (TCvSubst, TyVar)
</span><a href="GHC.Core.TyCo.Subst.html#substVarBndr"><span class="hs-identifier hs-var">Type.substVarBndr</span></a></span><span> </span><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062877"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062875"><span class="hs-identifier hs-var">tcv</span></a></span><span>
</span><span id="line-1628"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681062870"><span class="annot"><span class="annottext">oss' :: [OneShotInfo]
</span><a href="#local-6989586621681062870"><span class="hs-identifier hs-var hs-var">oss'</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062875"><span class="hs-identifier hs-var">tcv</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681062880"><span class="hs-identifier hs-var">oss</span></a></span><span>
</span><span id="line-1629"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681062878"><span class="hs-identifier hs-var">oss1</span></a></span><span>
</span><span id="line-1630"></span><span>         </span><span class="hs-comment">-- A forall can bind a CoVar, in which case</span><span>
</span><span id="line-1631"></span><span>         </span><span class="hs-comment">-- we consume one of the [OneShotInfo]</span><span>
</span><span id="line-1632"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062869"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681062869"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-type">EI</span></a></span><span> </span><span id="local-6989586621681062868"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062868"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621681062867"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062867"><span class="hs-identifier hs-var">mco</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [OneShotInfo] -&gt; TCvSubst -&gt; Type -&gt; (InScopeSet, EtaInfo)
</span><a href="#local-6989586621681062886"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062881"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681062870"><span class="hs-identifier hs-var">oss'</span></a></span><span> </span><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062873"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062874"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-1633"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681062869"><span class="hs-identifier hs-var">in_scope</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; MCoercionR -&gt; EtaInfo
</span><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-var">EI</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062872"><span class="hs-identifier hs-var">tcv'</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062868"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; MCoercionR -&gt; MCoercionR
</span><a href="GHC.Core.Coercion.html#mkHomoForAllMCo"><span class="hs-identifier hs-var">mkHomoForAllMCo</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062872"><span class="hs-identifier hs-var">tcv'</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062867"><span class="hs-identifier hs-var">mco</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1634"></span><span>
</span><span id="line-1635"></span><span>       </span><span class="hs-comment">----------- Function types  (t1 -&gt; t2)</span><span>
</span><span id="line-1636"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062865"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062865"><span class="hs-identifier hs-var">mult</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062864"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062864"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062863"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062863"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (Type, Type, Type)
</span><a href="GHC.Core.Type.html#splitFunTy_maybe"><span class="hs-identifier hs-var">splitFunTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062876"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1637"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isTypeLevPoly"><span class="hs-identifier hs-var">isTypeLevPoly</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062864"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1638"></span><span>          </span><span class="hs-comment">-- See Note [Representation polymorphism invariants] in GHC.Core</span><span>
</span><span id="line-1639"></span><span>          </span><span class="hs-comment">-- See also test case typecheck/should_run/EtaExpandLevPoly</span><span>
</span><span id="line-1640"></span><span>
</span><span id="line-1641"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062861"><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062861"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062860"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062860"><span class="hs-identifier hs-var">eta_id</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; TCvSubst -&gt; Scaled Type -&gt; (TCvSubst, TyVar)
</span><a href="GHC.Core.Opt.Arity.html#freshEtaId"><span class="hs-identifier hs-var">freshEtaId</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062881"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062877"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Type -&gt; a -&gt; Scaled a
</span><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-var">Scaled</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062865"><span class="hs-identifier hs-var">mult</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062864"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1642"></span><span>          </span><span class="hs-comment">-- Avoid free vars of the original expression</span><span>
</span><span id="line-1643"></span><span>
</span><span id="line-1644"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681062857"><span class="annot"><span class="annottext">eta_id' :: TyVar
</span><a href="#local-6989586621681062857"><span class="hs-identifier hs-var hs-var">eta_id'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062860"><span class="hs-identifier hs-var">eta_id</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; OneShotInfo -&gt; TyVar
</span><a href="GHC.Types.Id.html#setIdOneShotInfo"><span class="hs-operator hs-var">`setIdOneShotInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">OneShotInfo
</span><a href="#local-6989586621681062879"><span class="hs-identifier hs-var">one_shot</span></a></span><span>
</span><span id="line-1645"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062855"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681062855"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-type">EI</span></a></span><span> </span><span id="local-6989586621681062854"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062854"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621681062853"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062853"><span class="hs-identifier hs-var">mco</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [OneShotInfo] -&gt; TCvSubst -&gt; Type -&gt; (InScopeSet, EtaInfo)
</span><a href="#local-6989586621681062886"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062881"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.16.4.0/src/GHC-Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681062878"><span class="hs-identifier hs-var">oss1</span></a></span><span> </span><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062861"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062863"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-1646"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681062855"><span class="hs-identifier hs-var">in_scope</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; MCoercionR -&gt; EtaInfo
</span><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-var">EI</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062857"><span class="hs-identifier hs-var">eta_id'</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062854"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scaled Type -&gt; MCoercionR -&gt; MCoercionR
</span><a href="GHC.Core.Coercion.html#mkFunResMCo"><span class="hs-identifier hs-var">mkFunResMCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Scaled Type
</span><a href="GHC.Types.Id.html#idScaledType"><span class="hs-identifier hs-var">idScaledType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062857"><span class="hs-identifier hs-var">eta_id'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062853"><span class="hs-identifier hs-var">mco</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1647"></span><span>
</span><span id="line-1648"></span><span>       </span><span class="hs-comment">----------- Newtypes</span><span>
</span><span id="line-1649"></span><span>       </span><span class="hs-comment">-- Given this:</span><span>
</span><span id="line-1650"></span><span>       </span><span class="hs-comment">--      newtype T = MkT ([T] -&gt; Int)</span><span>
</span><span id="line-1651"></span><span>       </span><span class="hs-comment">-- Consider eta-expanding this</span><span>
</span><span id="line-1652"></span><span>       </span><span class="hs-comment">--      eta_expand 1 e T</span><span>
</span><span id="line-1653"></span><span>       </span><span class="hs-comment">-- We want to get</span><span>
</span><span id="line-1654"></span><span>       </span><span class="hs-comment">--      coerce T (\x::[T] -&gt; (coerce ([T]-&gt;Int) e) x)</span><span>
</span><span id="line-1655"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062850"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062850"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062849"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062849"><span class="hs-identifier hs-var">ty'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (Coercion, Type)
</span><a href="GHC.Core.Coercion.html#topNormaliseNewType_maybe"><span class="hs-identifier hs-var">topNormaliseNewType_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062876"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1656"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- co :: ty ~ ty'</span><span>
</span><span id="line-1657"></span><span>         </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681062847"><span class="annot"><span class="annottext">co' :: Coercion
</span><a href="#local-6989586621681062847"><span class="hs-identifier hs-var hs-var">co'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; TCvSubst -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier hs-var">Type.substCo</span></a></span><span> </span><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062877"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062850"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1658"></span><span>             </span><span class="hs-comment">-- Remember to apply the substitution to co (#16979)</span><span>
</span><span id="line-1659"></span><span>             </span><span class="hs-comment">-- (or we could have applied to ty, but then</span><span>
</span><span id="line-1660"></span><span>             </span><span class="hs-comment">--  we'd have had to zap it for the recursive call)</span><span>
</span><span id="line-1661"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062845"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681062845"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-type">EI</span></a></span><span> </span><span id="local-6989586621681062844"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062844"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621681062843"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062843"><span class="hs-identifier hs-var">mco</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [OneShotInfo] -&gt; TCvSubst -&gt; Type -&gt; (InScopeSet, EtaInfo)
</span><a href="#local-6989586621681062886"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062881"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">[OneShotInfo]
</span><a href="#local-6989586621681062880"><span class="hs-identifier hs-var">oss</span></a></span><span> </span><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062877"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062849"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-1662"></span><span>         </span><span class="hs-comment">-- mco :: subst(ty') ~ b1_ty -&gt; ... -&gt; bn_ty -&gt; tr</span><span>
</span><span id="line-1663"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681062845"><span class="hs-identifier hs-var">in_scope</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; MCoercionR -&gt; EtaInfo
</span><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-var">EI</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062844"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; MCoercionR -&gt; MCoercionR
</span><a href="GHC.Core.Coercion.html#mkTransMCoR"><span class="hs-identifier hs-var">mkTransMCoR</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062847"><span class="hs-identifier hs-var">co'</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062843"><span class="hs-identifier hs-var">mco</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1664"></span><span>
</span><span id="line-1665"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>       </span><span class="hs-comment">-- We have an expression of arity &gt; 0,</span><span>
</span><span id="line-1666"></span><span>                         </span><span class="hs-comment">-- but its type isn't a function, or a binder</span><span>
</span><span id="line-1667"></span><span>                         </span><span class="hs-comment">-- is representation-polymorphic</span><span>
</span><span id="line-1668"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">True</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">orig_oss</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">orig_ty</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr_orig_expr</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1669"></span><span>         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TCvSubst -&gt; InScopeSet
</span><a href="GHC.Core.TyCo.Subst.html#getTCvInScope"><span class="hs-identifier hs-var">getTCvInScope</span></a></span><span> </span><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062877"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; MCoercionR -&gt; EtaInfo
</span><a href="GHC.Core.Opt.Arity.html#EI"><span class="hs-identifier hs-var">EI</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1670"></span><span>        </span><span class="hs-comment">-- This *can* legitimately happen:</span><span>
</span><span id="line-1671"></span><span>        </span><span class="hs-comment">-- e.g.  coerce Int (\x. x) Essentially the programmer is</span><span>
</span><span id="line-1672"></span><span>        </span><span class="hs-comment">-- playing fast and loose with types (Happy does this a lot).</span><span>
</span><span id="line-1673"></span><span>        </span><span class="hs-comment">-- So we simply decline to eta-expand.  Otherwise we'd end up</span><span>
</span><span id="line-1674"></span><span>        </span><span class="hs-comment">-- with an explicit lambda having a non-function type</span><span>
</span><span id="line-1675"></span><span>
</span><span id="line-1676"></span><span>
</span><span id="line-1677"></span><span class="hs-comment">{- *********************************************************************
*                                                                      *
              The &quot;push rules&quot;
*                                                                      *
************************************************************************

Here we implement the &quot;push rules&quot; from FC papers:

* The push-argument rules, where we can move a coercion past an argument.
  We have
      (fun |&gt; co) arg
  and we want to transform it to
    (fun arg') |&gt; co'
  for some suitable co' and transformed arg'.

* The PushK rule for data constructors.  We have
       (K e1 .. en) |&gt; co
  and we want to transform to
       (K e1' .. en')
  by pushing the coercion into the arguments
-}</span><span>
</span><span id="line-1698"></span><span>
</span><span id="line-1699"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoArgs"><span class="hs-identifier hs-type">pushCoArgs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1700"></span><span id="pushCoArgs"><span class="annot"><span class="annottext">pushCoArgs :: Coercion -&gt; [CoreExpr] -&gt; Maybe ([CoreExpr], MCoercionR)
</span><a href="GHC.Core.Opt.Arity.html#pushCoArgs"><span class="hs-identifier hs-var hs-var">pushCoArgs</span></a></span></span><span> </span><span id="local-6989586621681062839"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062839"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062839"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1701"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoArgs"><span class="hs-identifier hs-var">pushCoArgs</span></a></span><span> </span><span id="local-6989586621681062838"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062838"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062837"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062837"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681062836"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062836"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062835"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062835"><span class="hs-identifier hs-var">arg'</span></a></span></span><span class="hs-special">,</span><span>  </span><span id="local-6989586621681062834"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062834"><span class="hs-identifier hs-var">m_co1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; CoreExpr -&gt; Maybe (CoreExpr, MCoercionR)
</span><a href="GHC.Core.Opt.Arity.html#pushCoArg"><span class="hs-identifier hs-var">pushCoArg</span></a></span><span>  </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062838"><span class="hs-identifier hs-var">co</span></a></span><span>  </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062837"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-1702"></span><span>                              </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062834"><span class="hs-identifier hs-var">m_co1</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1703"></span><span>                                  </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-type">MCo</span></a></span><span> </span><span id="local-6989586621681062833"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062833"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062832"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062832"><span class="hs-identifier hs-var">args'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062831"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062831"><span class="hs-identifier hs-var">m_co2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; [CoreExpr] -&gt; Maybe ([CoreExpr], MCoercionR)
</span><a href="GHC.Core.Opt.Arity.html#pushCoArgs"><span class="hs-identifier hs-var">pushCoArgs</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062833"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062836"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-1704"></span><span>                                                 </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062835"><span class="hs-identifier hs-var">arg'</span></a></span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062832"><span class="hs-identifier hs-var">args'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062831"><span class="hs-identifier hs-var">m_co2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1705"></span><span>                                  </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062835"><span class="hs-identifier hs-var">arg'</span></a></span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062836"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1706"></span><span>
</span><span id="line-1707"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushMCoArg"><span class="hs-identifier hs-type">pushMCoArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercionR"><span class="hs-identifier hs-type">MCoercionR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1708"></span><span id="pushMCoArg"><span class="annot"><span class="annottext">pushMCoArg :: MCoercionR -&gt; CoreExpr -&gt; Maybe (CoreExpr, MCoercionR)
</span><a href="GHC.Core.Opt.Arity.html#pushMCoArg"><span class="hs-identifier hs-var hs-var">pushMCoArg</span></a></span></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span>    </span><span id="local-6989586621681062830"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062830"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062830"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1709"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushMCoArg"><span class="hs-identifier hs-var">pushMCoArg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-type">MCo</span></a></span><span> </span><span id="local-6989586621681062829"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062829"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681062828"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062828"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; CoreExpr -&gt; Maybe (CoreExpr, MCoercionR)
</span><a href="GHC.Core.Opt.Arity.html#pushCoArg"><span class="hs-identifier hs-var">pushCoArg</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062829"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062828"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-1710"></span><span>
</span><span id="line-1711"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoArg"><span class="hs-identifier hs-type">pushCoArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1712"></span><span class="hs-comment">-- We have (fun |&gt; co) arg, and we want to transform it to</span><span>
</span><span id="line-1713"></span><span class="hs-comment">--         (fun arg) |&gt; co</span><span>
</span><span id="line-1714"></span><span class="hs-comment">-- This may fail, e.g. if (fun :: N) where N is a newtype</span><span>
</span><span id="line-1715"></span><span class="hs-comment">-- C.f. simplCast in GHC.Core.Opt.Simplify</span><span>
</span><span id="line-1716"></span><span class="hs-comment">-- 'co' is always Representational</span><span>
</span><span id="line-1717"></span><span id="pushCoArg"><span class="annot"><span class="annottext">pushCoArg :: Coercion -&gt; CoreExpr -&gt; Maybe (CoreExpr, MCoercionR)
</span><a href="GHC.Core.Opt.Arity.html#pushCoArg"><span class="hs-identifier hs-var hs-var">pushCoArg</span></a></span></span><span> </span><span id="local-6989586621681062827"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062827"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621681062826"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062826"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062825"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062825"><span class="hs-identifier hs-var">ty'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062824"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062824"><span class="hs-identifier hs-var">m_co'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Type -&gt; Maybe (Type, MCoercionR)
</span><a href="GHC.Core.Opt.Arity.html#pushCoTyArg"><span class="hs-identifier hs-var">pushCoTyArg</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062827"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062826"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1718"></span><span>                            </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062825"><span class="hs-identifier hs-var">ty'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062824"><span class="hs-identifier hs-var">m_co'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1719"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoArg"><span class="hs-identifier hs-var">pushCoArg</span></a></span><span> </span><span id="local-6989586621681062823"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062823"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621681062822"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062822"><span class="hs-identifier hs-var">val_arg</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062821"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062821"><span class="hs-identifier hs-var">arg_co</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062820"><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062820"><span class="hs-identifier hs-var">m_co'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Maybe (MCoercionR, MCoercionR)
</span><a href="GHC.Core.Opt.Arity.html#pushCoValArg"><span class="hs-identifier hs-var">pushCoValArg</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062823"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1720"></span><span>                            </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062822"><span class="hs-identifier hs-var">val_arg</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; MCoercionR -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCastMCo"><span class="hs-operator hs-var">`mkCastMCo`</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062821"><span class="hs-identifier hs-var">arg_co</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="#local-6989586621681062820"><span class="hs-identifier hs-var">m_co'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1721"></span><span>
</span><span id="line-1722"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoTyArg"><span class="hs-identifier hs-type">pushCoTyArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercionR"><span class="hs-identifier hs-type">MCoercionR</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1723"></span><span class="hs-comment">-- We have (fun |&gt; co) @ty</span><span>
</span><span id="line-1724"></span><span class="hs-comment">-- Push the coercion through to return</span><span>
</span><span id="line-1725"></span><span class="hs-comment">--         (fun @ty') |&gt; co'</span><span>
</span><span id="line-1726"></span><span class="hs-comment">-- 'co' is always Representational</span><span>
</span><span id="line-1727"></span><span class="hs-comment">-- If the returned coercion is Nothing, then it would have been reflexive;</span><span>
</span><span id="line-1728"></span><span class="hs-comment">-- it's faster not to compute it, though.</span><span>
</span><span id="line-1729"></span><span id="pushCoTyArg"><span class="annot"><span class="annottext">pushCoTyArg :: Coercion -&gt; Type -&gt; Maybe (Type, MCoercionR)
</span><a href="GHC.Core.Opt.Arity.html#pushCoTyArg"><span class="hs-identifier hs-var hs-var">pushCoTyArg</span></a></span></span><span> </span><span id="local-6989586621681062819"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062819"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621681062818"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062818"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-1730"></span><span>  </span><span class="hs-comment">-- The following is inefficient - don't do `eqType` here, the coercion</span><span>
</span><span id="line-1731"></span><span>  </span><span class="hs-comment">-- optimizer will take care of it. See #14737.</span><span>
</span><span id="line-1732"></span><span>  </span><span class="hs-comment">-- -- | tyL `eqType` tyR</span><span>
</span><span id="line-1733"></span><span>  </span><span class="hs-comment">-- -- = Just (ty, Nothing)</span><span>
</span><span id="line-1734"></span><span>
</span><span id="line-1735"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062819"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1736"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062818"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1737"></span><span>
</span><span id="line-1738"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isForAllTy_ty"><span class="hs-identifier hs-var">isForAllTy_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062815"><span class="hs-identifier hs-var">tyL</span></a></span><span>
</span><span id="line-1739"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isForAllTy_ty</span><span> </span><span class="hs-identifier">tyR</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">co</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">ty</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1740"></span><span>    </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062818"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Coercion -&gt; Type
</span><a href="GHC.Core.Type.html#mkCastTy"><span class="hs-operator hs-var">`mkCastTy`</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062812"><span class="hs-identifier hs-var">co1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062811"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1741"></span><span>
</span><span id="line-1742"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1743"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1744"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1745"></span><span>    </span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621681062815"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062815"><span class="hs-identifier hs-var">tyL</span></a></span></span><span> </span><span id="local-6989586621681062814"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062814"><span class="hs-identifier hs-var">tyR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062819"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1746"></span><span>       </span><span class="hs-comment">-- co :: tyL ~ tyR</span><span>
</span><span id="line-1747"></span><span>       </span><span class="hs-comment">-- tyL = forall (a1 :: k1). ty1</span><span>
</span><span id="line-1748"></span><span>       </span><span class="hs-comment">-- tyR = forall (a2 :: k2). ty2</span><span>
</span><span id="line-1749"></span><span>
</span><span id="line-1750"></span><span>    </span><span id="local-6989586621681062812"><span class="annot"><span class="annottext">co1 :: Coercion
</span><a href="#local-6989586621681062812"><span class="hs-identifier hs-var hs-var">co1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Role -&gt; Int -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkNthCo"><span class="hs-identifier hs-var">mkNthCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="GHC.Core.Coercion.Axiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062819"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1751"></span><span>       </span><span class="hs-comment">-- co1 :: k2 ~N k1</span><span>
</span><span id="line-1752"></span><span>       </span><span class="hs-comment">-- Note that NthCo can extract a Nominal equality between the</span><span>
</span><span id="line-1753"></span><span>       </span><span class="hs-comment">-- kinds of the types related by a coercion between forall-types.</span><span>
</span><span id="line-1754"></span><span>       </span><span class="hs-comment">-- See the NthCo case in GHC.Core.Lint.</span><span>
</span><span id="line-1755"></span><span>
</span><span id="line-1756"></span><span>    </span><span id="local-6989586621681062811"><span class="annot"><span class="annottext">co2 :: Coercion
</span><a href="#local-6989586621681062811"><span class="hs-identifier hs-var hs-var">co2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkInstCo"><span class="hs-identifier hs-var">mkInstCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062819"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; Type -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkGReflLeftCo"><span class="hs-identifier hs-var">mkGReflLeftCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="GHC.Core.Coercion.Axiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062818"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062812"><span class="hs-identifier hs-var">co1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1757"></span><span>        </span><span class="hs-comment">-- co2 :: ty1[ (ty|&gt;co1)/a1 ] ~ ty2[ ty/a2 ]</span><span>
</span><span id="line-1758"></span><span>        </span><span class="hs-comment">-- Arg of mkInstCo is always nominal, hence mkNomReflCo</span><span>
</span><span id="line-1759"></span><span>
</span><span id="line-1760"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoValArg"><span class="hs-identifier hs-type">pushCoValArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercionR"><span class="hs-identifier hs-type">MCoercionR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCoercionR"><span class="hs-identifier hs-type">MCoercionR</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1761"></span><span class="hs-comment">-- We have (fun |&gt; co) arg</span><span>
</span><span id="line-1762"></span><span class="hs-comment">-- Push the coercion through to return</span><span>
</span><span id="line-1763"></span><span class="hs-comment">--         (fun (arg |&gt; co_arg)) |&gt; co_res</span><span>
</span><span id="line-1764"></span><span class="hs-comment">-- 'co' is always Representational</span><span>
</span><span id="line-1765"></span><span class="hs-comment">-- If the second returned Coercion is actually Nothing, then no cast is necessary;</span><span>
</span><span id="line-1766"></span><span class="hs-comment">-- the returned coercion would have been reflexive.</span><span>
</span><span id="line-1767"></span><span id="pushCoValArg"><span class="annot"><span class="annottext">pushCoValArg :: Coercion -&gt; Maybe (MCoercionR, MCoercionR)
</span><a href="GHC.Core.Opt.Arity.html#pushCoValArg"><span class="hs-identifier hs-var hs-var">pushCoValArg</span></a></span></span><span> </span><span id="local-6989586621681062803"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062803"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-1768"></span><span>  </span><span class="hs-comment">-- The following is inefficient - don't do `eqType` here, the coercion</span><span>
</span><span id="line-1769"></span><span>  </span><span class="hs-comment">-- optimizer will take care of it. See #14737.</span><span>
</span><span id="line-1770"></span><span>  </span><span class="hs-comment">-- -- | tyL `eqType` tyR</span><span>
</span><span id="line-1771"></span><span>  </span><span class="hs-comment">-- -- = Just (mkRepReflCo arg, Nothing)</span><span>
</span><span id="line-1772"></span><span>
</span><span id="line-1773"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062803"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1774"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MCoercionR
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1775"></span><span>
</span><span id="line-1776"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isFunTy"><span class="hs-identifier hs-var">isFunTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062801"><span class="hs-identifier hs-var">tyL</span></a></span><span>
</span><span id="line-1777"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062800"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062800"><span class="hs-identifier hs-var">co_mult</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062799"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062799"><span class="hs-identifier hs-var">co1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062798"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062798"><span class="hs-identifier hs-var">co2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
Role -&gt; Coercion -&gt; (Coercion, Coercion, Coercion)
</span><a href="GHC.Core.Coercion.html#decomposeFunCo"><span class="hs-identifier hs-var">decomposeFunCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="GHC.Core.Coercion.Axiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062803"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1778"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflexiveCo"><span class="hs-identifier hs-var">isReflexiveCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062800"><span class="hs-identifier hs-var">co_mult</span></a></span><span>
</span><span id="line-1779"></span><span>    </span><span class="hs-comment">-- We can't push the coercion in the case where co_mult isn't reflexivity:</span><span>
</span><span id="line-1780"></span><span>    </span><span class="hs-comment">-- it could be an unsafe axiom, and losing this information could yield</span><span>
</span><span id="line-1781"></span><span>    </span><span class="hs-comment">-- ill-typed terms. For instance (fun x ::(1) Int -&gt; (fun _ -&gt; () |&gt; co) x)</span><span>
</span><span id="line-1782"></span><span>    </span><span class="hs-comment">-- with co :: (Int -&gt; ()) ~ (Int %1 -&gt; ()), would reduce to (fun x ::(1) Int</span><span>
</span><span id="line-1783"></span><span>    </span><span class="hs-comment">-- -&gt; (fun _ ::(Many) Int -&gt; ()) x) which is ill-typed</span><span>
</span><span id="line-1784"></span><span>
</span><span id="line-1785"></span><span>              </span><span class="hs-comment">-- If   co  :: (tyL1 -&gt; tyL2) ~ (tyR1 -&gt; tyR2)</span><span>
</span><span id="line-1786"></span><span>              </span><span class="hs-comment">-- then co1 :: tyL1 ~ tyR1</span><span>
</span><span id="line-1787"></span><span>              </span><span class="hs-comment">--      co2 :: tyL2 ~ tyR2</span><span>
</span><span id="line-1788"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isFunTy</span><span> </span><span class="hs-identifier">tyR</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">co</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">arg</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1789"></span><span>    </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; MCoercionR
</span><a href="GHC.Core.Coercion.html#coToMCo"><span class="hs-identifier hs-var">coToMCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062799"><span class="hs-identifier hs-var">co1</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; MCoercionR
</span><a href="GHC.Core.Coercion.html#coToMCo"><span class="hs-identifier hs-var">coToMCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062798"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1790"></span><span>    </span><span class="hs-comment">-- Critically, coToMCo to checks for ReflCo; the whole coercion may not</span><span>
</span><span id="line-1791"></span><span>    </span><span class="hs-comment">-- be reflexive, but either of its components might be</span><span>
</span><span id="line-1792"></span><span>    </span><span class="hs-comment">-- We could use isReflexiveCo, but it's not clear if the benefit</span><span>
</span><span id="line-1793"></span><span>    </span><span class="hs-comment">-- is worth the cost, and it makes no difference in #18223</span><span>
</span><span id="line-1794"></span><span>
</span><span id="line-1795"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1796"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1797"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1798"></span><span>    </span><span id="local-6989586621681062793"><span class="annot"><span class="annottext">arg :: Type
</span><a href="#local-6989586621681062793"><span class="hs-identifier hs-var hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="GHC.Core.Type.html#funArgTy"><span class="hs-identifier hs-var">funArgTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062794"><span class="hs-identifier hs-var">tyR</span></a></span><span>
</span><span id="line-1799"></span><span>    </span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621681062801"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062801"><span class="hs-identifier hs-var">tyL</span></a></span></span><span> </span><span id="local-6989586621681062794"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062794"><span class="hs-identifier hs-var">tyR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062803"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1800"></span><span>
</span><span id="line-1801"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoercionIntoLambda"><span class="hs-identifier hs-type">pushCoercionIntoLambda</span></a></span><span>
</span><span id="line-1802"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1803"></span><span class="hs-comment">-- This implements the Push rule from the paper on coercions</span><span>
</span><span id="line-1804"></span><span class="hs-comment">--    (\x. e) |&gt; co</span><span>
</span><span id="line-1805"></span><span class="hs-comment">-- ===&gt;</span><span>
</span><span id="line-1806"></span><span class="hs-comment">--    (\x'. e |&gt; co')</span><span>
</span><span id="line-1807"></span><span id="pushCoercionIntoLambda"><span class="annot"><span class="annottext">pushCoercionIntoLambda :: HasDebugCallStack =&gt;
InScopeSet
-&gt; TyVar -&gt; CoreExpr -&gt; Coercion -&gt; Maybe (TyVar, CoreExpr)
</span><a href="GHC.Core.Opt.Arity.html#pushCoercionIntoLambda"><span class="hs-identifier hs-var hs-var">pushCoercionIntoLambda</span></a></span></span><span> </span><span id="local-6989586621681062787"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681062787"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621681062786"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062786"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621681062785"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062785"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621681062784"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062784"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-1808"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier">x</span><span class="hs-special">)</span><span> </span><span class="hs-operator">&amp;&amp;</span><span> </span><span class="hs-identifier">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier">x</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">True</span><span>
</span><span id="line-1809"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621681062781"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062781"><span class="hs-identifier hs-var">s1s2</span></a></span></span><span> </span><span id="local-6989586621681062780"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062780"><span class="hs-identifier hs-var">t1t2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062784"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1810"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062779"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062779"><span class="hs-identifier hs-var">_s1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681062778"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062778"><span class="hs-identifier hs-var">_s2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (Type, Type, Type)
</span><a href="GHC.Core.Type.html#splitFunTy_maybe"><span class="hs-identifier hs-var">splitFunTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062781"><span class="hs-identifier hs-var">s1s2</span></a></span><span>
</span><span id="line-1811"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062777"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062777"><span class="hs-identifier hs-var">w1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062776"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062776"><span class="hs-identifier hs-var">t1</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681062775"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062775"><span class="hs-identifier hs-var">_t2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (Type, Type, Type)
</span><a href="GHC.Core.Type.html#splitFunTy_maybe"><span class="hs-identifier hs-var">splitFunTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062780"><span class="hs-identifier hs-var">t1t2</span></a></span><span>
</span><span id="line-1812"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062774"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062774"><span class="hs-identifier hs-var">co_mult</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062773"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062773"><span class="hs-identifier hs-var">co1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062772"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062772"><span class="hs-identifier hs-var">co2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
Role -&gt; Coercion -&gt; (Coercion, Coercion, Coercion)
</span><a href="GHC.Core.Coercion.html#decomposeFunCo"><span class="hs-identifier hs-var">decomposeFunCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="GHC.Core.Coercion.Axiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062784"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1813"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflexiveCo"><span class="hs-identifier hs-var">isReflexiveCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062774"><span class="hs-identifier hs-var">co_mult</span></a></span><span>
</span><span id="line-1814"></span><span>      </span><span class="hs-comment">-- We can't push the coercion in the case where co_mult isn't</span><span>
</span><span id="line-1815"></span><span>      </span><span class="hs-comment">-- reflexivity. See pushCoValArg for more details.</span><span>
</span><span id="line-1816"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><span id="line-1817"></span><span>          </span><span class="hs-comment">-- Should we optimize the coercions here?</span><span>
</span><span id="line-1818"></span><span>          </span><span class="hs-comment">-- Otherwise they might not match too well</span><span>
</span><span id="line-1819"></span><span>          </span><span id="local-6989586621681062771"><span class="annot"><span class="annottext">x' :: TyVar
</span><a href="#local-6989586621681062771"><span class="hs-identifier hs-var hs-var">x'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062786"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Type -&gt; TyVar
</span><a href="GHC.Types.Id.html#setIdType"><span class="hs-operator hs-var">`setIdType`</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062776"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Type -&gt; TyVar
</span><a href="GHC.Types.Var.html#setIdMult"><span class="hs-operator hs-var">`setIdMult`</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062777"><span class="hs-identifier hs-var">w1</span></a></span><span>
</span><span id="line-1820"></span><span>          </span><span id="local-6989586621681062768"><span class="annot"><span class="annottext">in_scope' :: InScopeSet
</span><a href="#local-6989586621681062768"><span class="hs-identifier hs-var hs-var">in_scope'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681062787"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; TyVar -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#extendInScopeSet"><span class="hs-operator hs-var">`extendInScopeSet`</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062771"><span class="hs-identifier hs-var">x'</span></a></span><span>
</span><span id="line-1821"></span><span>          </span><span id="local-6989586621681062766"><span class="annot"><span class="annottext">subst :: Subst
</span><a href="#local-6989586621681062766"><span class="hs-identifier hs-var hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; TyVar -&gt; CoreExpr -&gt; Subst
</span><a href="GHC.Core.Subst.html#extendIdSubst"><span class="hs-identifier hs-var">extendIdSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet -&gt; Subst
</span><a href="GHC.Core.Subst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681062768"><span class="hs-identifier hs-var">in_scope'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1822"></span><span>                                </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062786"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1823"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; Coercion -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall b. TyVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062771"><span class="hs-identifier hs-var">x'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062773"><span class="hs-identifier hs-var">co1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1824"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062771"><span class="hs-identifier hs-var">x'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Subst -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Subst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681062766"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062785"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Coercion -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCast"><span class="hs-operator hs-var">`mkCast`</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062772"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1825"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1826"></span><span>      </span><span class="hs-comment">-- See #21555 / #21577 for a case where this trace fired but the cause was benign</span><span>
</span><span id="line-1827"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;exprIsLambda_maybe: Unexpected lambda in case&quot; (ppr (Lam x e))</span><span>
</span><span id="line-1828"></span><span>      </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1829"></span><span>
</span><span id="line-1830"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#pushCoDataCon"><span class="hs-identifier hs-type">pushCoDataCon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-1831"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span>
</span><span id="line-1832"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- Universal type args</span><span>
</span><span id="line-1833"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- All other args incl existentials</span><span>
</span><span id="line-1834"></span><span class="hs-comment">-- Implement the KPush reduction rule as described in &quot;Down with kinds&quot;</span><span>
</span><span id="line-1835"></span><span class="hs-comment">-- The transformation applies iff we have</span><span>
</span><span id="line-1836"></span><span class="hs-comment">--      (C e1 ... en) `cast` co</span><span>
</span><span id="line-1837"></span><span class="hs-comment">-- where co :: (T t1 .. tn) ~ to_ty</span><span>
</span><span id="line-1838"></span><span class="hs-comment">-- The left-hand one must be a T, because exprIsConApp returned True</span><span>
</span><span id="line-1839"></span><span class="hs-comment">-- but the right-hand one might not be.  (Though it usually will.)</span><span>
</span><span id="line-1840"></span><span id="pushCoDataCon"><span class="annot"><span class="annottext">pushCoDataCon :: DataCon
-&gt; [CoreExpr] -&gt; Coercion -&gt; Maybe (DataCon, [Type], [CoreExpr])
</span><a href="GHC.Core.Opt.Arity.html#pushCoDataCon"><span class="hs-identifier hs-var hs-var">pushCoDataCon</span></a></span></span><span> </span><span id="local-6989586621681062763"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681062763"><span class="hs-identifier hs-var">dc</span></a></span></span><span> </span><span id="local-6989586621681062762"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062762"><span class="hs-identifier hs-var">dc_args</span></a></span></span><span> </span><span id="local-6989586621681062761"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062761"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-1841"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062761"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062760"><span class="hs-identifier hs-var">from_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.Type.html#eqType"><span class="hs-operator hs-var">`eqType`</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062758"><span class="hs-identifier hs-var">to_ty</span></a></span><span>  </span><span class="hs-comment">-- try cheap test first</span><span>
</span><span id="line-1842"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062757"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062757"><span class="hs-identifier hs-var">univ_ty_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062756"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062756"><span class="hs-identifier hs-var">rest_args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b a. [b] -&gt; [a] -&gt; ([a], [a])
</span><a href="GHC.Utils.Misc.html#splitAtList"><span class="hs-identifier hs-var">splitAtList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; [TyVar]
</span><a href="GHC.Core.DataCon.html#dataConUnivTyVars"><span class="hs-identifier hs-var">dataConUnivTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681062763"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062762"><span class="hs-identifier hs-var">dc_args</span></a></span><span>
</span><span id="line-1843"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681062763"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Type
</span><a href="GHC.Core.html#exprToType"><span class="hs-identifier hs-var">exprToType</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062757"><span class="hs-identifier hs-var">univ_ty_args</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062756"><span class="hs-identifier hs-var">rest_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1844"></span><span>
</span><span id="line-1845"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062752"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681062752"><span class="hs-identifier hs-var">to_tc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062751"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681062751"><span class="hs-identifier hs-var">to_tc_arg_tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Type -&gt; Maybe (TyCon, [Type])
</span><a href="GHC.Core.Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062758"><span class="hs-identifier hs-var">to_ty</span></a></span><span>
</span><span id="line-1846"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681062752"><span class="hs-identifier hs-var">to_tc</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; TyCon
</span><a href="GHC.Core.DataCon.html#dataConTyCon"><span class="hs-identifier hs-var">dataConTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681062763"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-1847"></span><span>        </span><span class="hs-comment">-- These two tests can fail; we might see</span><span>
</span><span id="line-1848"></span><span>        </span><span class="hs-comment">--      (C x y) `cast` (g :: T a ~ S [a]),</span><span>
</span><span id="line-1849"></span><span>        </span><span class="hs-comment">-- where S is a type function.  In fact, exprIsConApp</span><span>
</span><span id="line-1850"></span><span>        </span><span class="hs-comment">-- will probably not be called in such circumstances,</span><span>
</span><span id="line-1851"></span><span>        </span><span class="hs-comment">-- but there's nothing wrong with it</span><span>
</span><span id="line-1852"></span><span>
</span><span id="line-1853"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><span id="line-1854"></span><span>        </span><span id="local-6989586621681062749"><span class="annot"><span class="annottext">tc_arity :: Int
</span><a href="#local-6989586621681062749"><span class="hs-identifier hs-var hs-var">tc_arity</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Int
</span><a href="GHC.Core.TyCon.html#tyConArity"><span class="hs-identifier hs-var">tyConArity</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681062752"><span class="hs-identifier hs-var">to_tc</span></a></span><span>
</span><span id="line-1855"></span><span>        </span><span id="local-6989586621681062748"><span class="annot"><span class="annottext">dc_univ_tyvars :: [TyVar]
</span><a href="#local-6989586621681062748"><span class="hs-identifier hs-var hs-var">dc_univ_tyvars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [TyVar]
</span><a href="GHC.Core.DataCon.html#dataConUnivTyVars"><span class="hs-identifier hs-var">dataConUnivTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681062763"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-1856"></span><span>        </span><span id="local-6989586621681062747"><span class="annot"><span class="annottext">dc_ex_tcvars :: [TyVar]
</span><a href="#local-6989586621681062747"><span class="hs-identifier hs-var hs-var">dc_ex_tcvars</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [TyVar]
</span><a href="GHC.Core.DataCon.html#dataConExTyCoVars"><span class="hs-identifier hs-var">dataConExTyCoVars</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681062763"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-1857"></span><span>        </span><span id="local-6989586621681062745"><span class="annot"><span class="annottext">arg_tys :: [Scaled Type]
</span><a href="#local-6989586621681062745"><span class="hs-identifier hs-var hs-var">arg_tys</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [Scaled Type]
</span><a href="GHC.Core.DataCon.html#dataConRepArgTys"><span class="hs-identifier hs-var">dataConRepArgTys</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681062763"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-1858"></span><span>
</span><span id="line-1859"></span><span>        </span><span id="local-6989586621681062743"><span class="annot"><span class="annottext">non_univ_args :: [CoreExpr]
</span><a href="#local-6989586621681062743"><span class="hs-identifier hs-var hs-var">non_univ_args</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b a. [b] -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#dropList"><span class="hs-identifier hs-var">dropList</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062748"><span class="hs-identifier hs-var">dc_univ_tyvars</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062762"><span class="hs-identifier hs-var">dc_args</span></a></span><span>
</span><span id="line-1860"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621681062741"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062741"><span class="hs-identifier hs-var">ex_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062740"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062740"><span class="hs-identifier hs-var">val_args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b a. [b] -&gt; [a] -&gt; ([a], [a])
</span><a href="GHC.Utils.Misc.html#splitAtList"><span class="hs-identifier hs-var">splitAtList</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062747"><span class="hs-identifier hs-var">dc_ex_tcvars</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062743"><span class="hs-identifier hs-var">non_univ_args</span></a></span><span>
</span><span id="line-1861"></span><span>
</span><span id="line-1862"></span><span>        </span><span class="hs-comment">-- Make the &quot;Psi&quot; from the paper</span><span>
</span><span id="line-1863"></span><span>        </span><span id="local-6989586621681062739"><span class="annot"><span class="annottext">omegas :: [Coercion]
</span><a href="#local-6989586621681062739"><span class="hs-identifier hs-var hs-var">omegas</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Coercion -&gt; [Role] -&gt; [Coercion]
</span><a href="GHC.Core.Coercion.html#decomposeCo"><span class="hs-identifier hs-var">decomposeCo</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062749"><span class="hs-identifier hs-var">tc_arity</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062761"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Role]
</span><a href="GHC.Core.Coercion.html#tyConRolesRepresentational"><span class="hs-identifier hs-var">tyConRolesRepresentational</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681062752"><span class="hs-identifier hs-var">to_tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1864"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621681062736"><span class="annot"><span class="annottext">Type -&gt; Coercion
</span><a href="#local-6989586621681062736"><span class="hs-identifier hs-var">psi_subst</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062735"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681062735"><span class="hs-identifier hs-var">to_ex_arg_tys</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1865"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role
-&gt; [TyVar]
-&gt; [Coercion]
-&gt; [TyVar]
-&gt; [Type]
-&gt; (Type -&gt; Coercion, [Type])
</span><a href="GHC.Core.Coercion.html#liftCoSubstWithEx"><span class="hs-identifier hs-var">liftCoSubstWithEx</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="GHC.Core.Coercion.Axiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span>
</span><span id="line-1866"></span><span>                              </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062748"><span class="hs-identifier hs-var">dc_univ_tyvars</span></a></span><span>
</span><span id="line-1867"></span><span>                              </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621681062739"><span class="hs-identifier hs-var">omegas</span></a></span><span>
</span><span id="line-1868"></span><span>                              </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062747"><span class="hs-identifier hs-var">dc_ex_tcvars</span></a></span><span>
</span><span id="line-1869"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Type
</span><a href="GHC.Core.html#exprToType"><span class="hs-identifier hs-var">exprToType</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062741"><span class="hs-identifier hs-var">ex_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1870"></span><span>
</span><span id="line-1871"></span><span>          </span><span class="hs-comment">-- Cast the value arguments (which include dictionaries)</span><span>
</span><span id="line-1872"></span><span>        </span><span id="local-6989586621681062733"><span class="annot"><span class="annottext">new_val_args :: [CoreExpr]
</span><a href="#local-6989586621681062733"><span class="hs-identifier hs-var hs-var">new_val_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><a href="../../base-4.16.4.0/src/GHC-List.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621681062731"><span class="hs-identifier hs-var">cast_arg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Scaled a -&gt; a
</span><a href="GHC.Core.TyCo.Rep.html#scaledThing"><span class="hs-identifier hs-var">scaledThing</span></a></span><span> </span><span class="annot"><span class="annottext">[Scaled Type]
</span><a href="#local-6989586621681062745"><span class="hs-identifier hs-var">arg_tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062740"><span class="hs-identifier hs-var">val_args</span></a></span><span>
</span><span id="line-1873"></span><span>        </span><span id="local-6989586621681062731"><span class="annot"><span class="annottext">cast_arg :: Type -&gt; CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621681062731"><span class="hs-identifier hs-var hs-var">cast_arg</span></a></span></span><span> </span><span id="local-6989586621681062729"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062729"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span> </span><span id="local-6989586621681062728"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062728"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Coercion -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062728"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Coercion
</span><a href="#local-6989586621681062736"><span class="hs-identifier hs-var">psi_subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062729"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1874"></span><span>
</span><span id="line-1875"></span><span>        </span><span id="local-6989586621681062727"><span class="annot"><span class="annottext">to_ex_args :: [CoreExpr]
</span><a href="#local-6989586621681062727"><span class="hs-identifier hs-var hs-var">to_ex_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681062735"><span class="hs-identifier hs-var">to_ex_arg_tys</span></a></span><span>
</span><span id="line-1876"></span><span>
</span><span id="line-1877"></span><span>        </span><span id="local-6989586621681062726"><span class="annot"><span class="annottext">dump_doc :: SDoc
</span><a href="#local-6989586621681062726"><span class="hs-identifier hs-var hs-var">dump_doc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681062763"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">,</span><span>      </span><span class="annot"><span class="annottext">forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062748"><span class="hs-identifier hs-var">dc_univ_tyvars</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062747"><span class="hs-identifier hs-var">dc_ex_tcvars</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1878"></span><span>                         </span><span class="annot"><span class="annottext">forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Scaled Type]
</span><a href="#local-6989586621681062745"><span class="hs-identifier hs-var">arg_tys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062762"><span class="hs-identifier hs-var">dc_args</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1879"></span><span>                         </span><span class="annot"><span class="annottext">forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062741"><span class="hs-identifier hs-var">ex_args</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062740"><span class="hs-identifier hs-var">val_args</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062761"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062760"><span class="hs-identifier hs-var">from_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062758"><span class="hs-identifier hs-var">to_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681062752"><span class="hs-identifier hs-var">to_tc</span></a></span><span>
</span><span id="line-1880"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681062752"><span class="hs-identifier hs-var">to_tc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Type
</span><a href="GHC.Core.html#exprToType"><span class="hs-identifier hs-var">exprToType</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall b a. [b] -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#takeList"><span class="hs-identifier hs-var">takeList</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062748"><span class="hs-identifier hs-var">dc_univ_tyvars</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062762"><span class="hs-identifier hs-var">dc_args</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1881"></span><span>    </span><span class="hs-keyword">in</span><span>
</span><span id="line-1882"></span><span>    </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">eqType</span><span> </span><span class="hs-identifier">from_ty</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mkTyConApp</span><span> </span><span class="hs-identifier">to_tc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">map</span><span> </span><span class="hs-identifier">exprToType</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">takeList</span><span> </span><span class="hs-identifier">dc_univ_tyvars</span><span> </span><span class="hs-identifier">dc_args</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dump_doc</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1883"></span><span>    </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">equalLength</span><span> </span><span class="hs-identifier">val_args</span><span> </span><span class="hs-identifier">arg_tys</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dump_doc</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1884"></span><span>    </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681062763"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681062751"><span class="hs-identifier hs-var">to_tc_arg_tys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062727"><span class="hs-identifier hs-var">to_ex_args</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062733"><span class="hs-identifier hs-var">new_val_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1885"></span><span>
</span><span id="line-1886"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1887"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1888"></span><span>
</span><span id="line-1889"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1890"></span><span>    </span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621681062760"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062760"><span class="hs-identifier hs-var">from_ty</span></a></span></span><span> </span><span id="local-6989586621681062758"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062758"><span class="hs-identifier hs-var">to_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062761"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1891"></span><span>
</span><span id="line-1892"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#collectBindersPushingCo"><span class="hs-identifier hs-type">collectBindersPushingCo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1893"></span><span class="hs-comment">-- Collect lambda binders, pushing coercions inside if possible</span><span>
</span><span id="line-1894"></span><span class="hs-comment">-- E.g.   (\x.e) |&gt; g         g :: &lt;Int&gt; -&gt; blah</span><span>
</span><span id="line-1895"></span><span class="hs-comment">--        = (\x. e |&gt; Nth 1 g)</span><span>
</span><span id="line-1896"></span><span class="hs-comment">--</span><span>
</span><span id="line-1897"></span><span class="hs-comment">-- That is,</span><span>
</span><span id="line-1898"></span><span class="hs-comment">--</span><span>
</span><span id="line-1899"></span><span class="hs-comment">-- collectBindersPushingCo ((\x.e) |&gt; g) === ([x], e |&gt; Nth 1 g)</span><span>
</span><span id="line-1900"></span><span id="collectBindersPushingCo"><span class="annot"><span class="annottext">collectBindersPushingCo :: CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="GHC.Core.Opt.Arity.html#collectBindersPushingCo"><span class="hs-identifier hs-var hs-var">collectBindersPushingCo</span></a></span></span><span> </span><span id="local-6989586621681062721"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062721"><span class="hs-identifier hs-var">e</span></a></span></span><span>
</span><span id="line-1901"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621681062720"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062721"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1902"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1903"></span><span>    </span><span class="hs-comment">-- Peel off lambdas until we hit a cast.</span><span>
</span><span id="line-1904"></span><span>    </span><span class="annot"><a href="#local-6989586621681062720"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1905"></span><span>    </span><span class="hs-comment">-- The accumulator is in reverse order</span><span>
</span><span id="line-1906"></span><span>    </span><span id="local-6989586621681062720"><span class="annot"><span class="annottext">go :: [TyVar] -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621681062720"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681062719"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062719"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621681062718"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062718"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621681062717"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062717"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621681062720"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062718"><span class="hs-identifier hs-var">b</span></a></span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062719"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062717"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1907"></span><span>    </span><span class="annot"><a href="#local-6989586621681062720"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681062716"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062716"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621681062715"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062715"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621681062714"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062714"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; CoreExpr -&gt; Coercion -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621681062713"><span class="hs-identifier hs-var">go_c</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062716"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062715"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062714"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1908"></span><span>    </span><span class="annot"><a href="#local-6989586621681062720"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681062712"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062712"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621681062711"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062711"><span class="hs-identifier hs-var">e</span></a></span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a]
</span><a href="../../base-4.16.4.0/src/GHC-List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062712"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062711"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1909"></span><span>
</span><span id="line-1910"></span><span>    </span><span class="hs-comment">-- We are in a cast; peel off casts until we hit a lambda.</span><span>
</span><span id="line-1911"></span><span>    </span><span class="annot"><a href="#local-6989586621681062713"><span class="hs-identifier hs-type">go_c</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1912"></span><span>    </span><span class="hs-comment">-- (go_c bs e c) is same as (go bs e (e |&gt; c))</span><span>
</span><span id="line-1913"></span><span>    </span><span id="local-6989586621681062713"><span class="annot"><span class="annottext">go_c :: [TyVar] -&gt; CoreExpr -&gt; Coercion -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621681062713"><span class="hs-identifier hs-var hs-var">go_c</span></a></span></span><span> </span><span id="local-6989586621681062710"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062710"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621681062709"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062709"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621681062708"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062708"><span class="hs-identifier hs-var">co1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681062707"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062707"><span class="hs-identifier hs-var">co2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; CoreExpr -&gt; Coercion -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621681062713"><span class="hs-identifier hs-var">go_c</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062710"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062709"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062708"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-operator hs-var">`mkTransCo`</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062707"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1914"></span><span>    </span><span class="annot"><a href="#local-6989586621681062713"><span class="hs-identifier hs-var">go_c</span></a></span><span> </span><span id="local-6989586621681062705"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062705"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621681062704"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062704"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621681062703"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062703"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>    </span><span id="local-6989586621681062702"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062702"><span class="hs-identifier hs-var">co</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; TyVar -&gt; CoreExpr -&gt; Coercion -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621681062701"><span class="hs-identifier hs-var">go_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062705"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062704"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062703"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062702"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1915"></span><span>    </span><span class="annot"><a href="#local-6989586621681062713"><span class="hs-identifier hs-var">go_c</span></a></span><span> </span><span id="local-6989586621681062700"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062700"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621681062699"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062699"><span class="hs-identifier hs-var">e</span></a></span></span><span>            </span><span id="local-6989586621681062698"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062698"><span class="hs-identifier hs-var">co</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a]
</span><a href="../../base-4.16.4.0/src/GHC-List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062700"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Coercion -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062699"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062698"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1916"></span><span>
</span><span id="line-1917"></span><span>    </span><span class="hs-comment">-- We are in a lambda under a cast; peel off lambdas and build a</span><span>
</span><span id="line-1918"></span><span>    </span><span class="hs-comment">-- new coercion for the body.</span><span>
</span><span id="line-1919"></span><span>    </span><span class="annot"><a href="#local-6989586621681062701"><span class="hs-identifier hs-type">go_lam</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1920"></span><span>    </span><span class="hs-comment">-- (go_lam bs b e c) is same as (go_c bs (\b.e) c)</span><span>
</span><span id="line-1921"></span><span>    </span><span id="local-6989586621681062701"><span class="annot"><span class="annottext">go_lam :: [TyVar] -&gt; TyVar -&gt; CoreExpr -&gt; Coercion -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621681062701"><span class="hs-identifier hs-var hs-var">go_lam</span></a></span></span><span> </span><span id="local-6989586621681062697"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062697"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621681062696"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062696"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621681062695"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062695"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621681062694"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062694"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-1922"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062696"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1923"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621681062693"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062693"><span class="hs-identifier hs-var">tyL</span></a></span></span><span> </span><span id="local-6989586621681062692"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062692"><span class="hs-identifier hs-var">tyR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062694"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1924"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isForAllTy_ty</span><span> </span><span class="hs-identifier">tyL</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1925"></span><span>        </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isForAllTy_ty"><span class="hs-identifier hs-var">isForAllTy_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062692"><span class="hs-identifier hs-var">tyR</span></a></span><span>
</span><span id="line-1926"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Role -&gt; Int -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkNthCo"><span class="hs-identifier hs-var">mkNthCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="GHC.Core.Coercion.Axiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062694"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See Note [collectBindersPushingCo]</span><span>
</span><span id="line-1927"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; CoreExpr -&gt; Coercion -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621681062713"><span class="hs-identifier hs-var">go_c</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062696"><span class="hs-identifier hs-var">b</span></a></span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062697"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062695"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkInstCo"><span class="hs-identifier hs-var">mkInstCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062694"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062696"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1928"></span><span>
</span><span id="line-1929"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062696"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1930"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621681062689"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062689"><span class="hs-identifier hs-var">tyL</span></a></span></span><span> </span><span id="local-6989586621681062688"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062688"><span class="hs-identifier hs-var">tyR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062694"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1931"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isForAllTy_co</span><span> </span><span class="hs-identifier">tyL</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1932"></span><span>        </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isForAllTy_co"><span class="hs-identifier hs-var">isForAllTy_co</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062688"><span class="hs-identifier hs-var">tyR</span></a></span><span>
</span><span id="line-1933"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Role -&gt; Int -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkNthCo"><span class="hs-identifier hs-var">mkNthCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="GHC.Core.Coercion.Axiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062694"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See Note [collectBindersPushingCo]</span><span>
</span><span id="line-1934"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681062686"><span class="annot"><span class="annottext">cov :: Coercion
</span><a href="#local-6989586621681062686"><span class="hs-identifier hs-var hs-var">cov</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062696"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1935"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; CoreExpr -&gt; Coercion -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621681062713"><span class="hs-identifier hs-var">go_c</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062696"><span class="hs-identifier hs-var">b</span></a></span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062697"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062695"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkInstCo"><span class="hs-identifier hs-var">mkInstCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062694"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Type
</span><a href="GHC.Core.Type.html#mkCoercionTy"><span class="hs-identifier hs-var">mkCoercionTy</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062686"><span class="hs-identifier hs-var">cov</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1936"></span><span>
</span><span id="line-1937"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062696"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1938"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621681062683"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062683"><span class="hs-identifier hs-var">tyL</span></a></span></span><span> </span><span id="local-6989586621681062682"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062682"><span class="hs-identifier hs-var">tyR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062694"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1939"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isFunTy</span><span> </span><span class="hs-identifier">tyL</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">isFunTy</span><span> </span><span class="hs-identifier">tyR</span><span>
</span><span id="line-1940"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062681"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062681"><span class="hs-identifier hs-var">co_mult</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062680"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062680"><span class="hs-identifier hs-var">co_arg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062679"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062679"><span class="hs-identifier hs-var">co_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt;
Role -&gt; Coercion -&gt; (Coercion, Coercion, Coercion)
</span><a href="GHC.Core.Coercion.html#decomposeFunCo"><span class="hs-identifier hs-var">decomposeFunCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="GHC.Core.Coercion.Axiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062694"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1941"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062681"><span class="hs-identifier hs-var">co_mult</span></a></span><span> </span><span class="hs-comment">-- See Note [collectBindersPushingCo]</span><span>
</span><span id="line-1942"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062680"><span class="hs-identifier hs-var">co_arg</span></a></span><span>  </span><span class="hs-comment">-- See Note [collectBindersPushingCo]</span><span>
</span><span id="line-1943"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; CoreExpr -&gt; Coercion -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621681062713"><span class="hs-identifier hs-var">go_c</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062696"><span class="hs-identifier hs-var">b</span></a></span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062697"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062695"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062679"><span class="hs-identifier hs-var">co_res</span></a></span><span>
</span><span id="line-1944"></span><span>
</span><span id="line-1945"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a]
</span><a href="../../base-4.16.4.0/src/GHC-List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062697"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Coercion -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall b. b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-var">Lam</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062696"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062695"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681062694"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1946"></span><span>
</span><span id="line-1947"></span><span class="hs-comment">{-

Note [collectBindersPushingCo]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We just look for coercions of form
   &lt;type&gt; # w -&gt; blah
(and similarly for foralls) to keep this function simple.  We could do
more elaborate stuff, but it'd involve substitution etc.

-}</span><span>
</span><span id="line-1957"></span><span>
</span><span id="line-1958"></span><span class="hs-comment">{- *********************************************************************
*                                                                      *
                Join points
*                                                                      *
********************************************************************* -}</span><span>
</span><span id="line-1963"></span><span>
</span><span id="line-1964"></span><span class="hs-comment">-------------------</span><span>
</span><span id="line-1965"></span><span class="hs-comment">-- | Split an expression into the given number of binders and a body,</span><span>
</span><span id="line-1966"></span><span class="hs-comment">-- eta-expanding if necessary. Counts value *and* type binders.</span><span>
</span><span id="line-1967"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaExpandToJoinPoint"><span class="hs-identifier hs-type">etaExpandToJoinPoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#JoinArity"><span class="hs-identifier hs-type">JoinArity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1968"></span><span id="etaExpandToJoinPoint"><span class="annot"><span class="annottext">etaExpandToJoinPoint :: Int -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="GHC.Core.Opt.Arity.html#etaExpandToJoinPoint"><span class="hs-identifier hs-var hs-var">etaExpandToJoinPoint</span></a></span></span><span> </span><span id="local-6989586621681062677"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062677"><span class="hs-identifier hs-var">join_arity</span></a></span></span><span> </span><span id="local-6989586621681062676"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062676"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-1969"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [TyVar] -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621681062675"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062677"><span class="hs-identifier hs-var">join_arity</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062676"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-1970"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1971"></span><span>    </span><span id="local-6989586621681062675"><span class="annot"><span class="annottext">go :: Int -&gt; [TyVar] -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621681062675"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621681062670"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062670"><span class="hs-identifier hs-var">rev_bs</span></a></span></span><span> </span><span id="local-6989586621681062669"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062669"><span class="hs-identifier hs-var">e</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a]
</span><a href="../../base-4.16.4.0/src/GHC-List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062670"><span class="hs-identifier hs-var">rev_bs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062669"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1972"></span><span>    </span><span class="annot"><a href="#local-6989586621681062675"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681062668"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062668"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681062667"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062667"><span class="hs-identifier hs-var">rev_bs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621681062666"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062666"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621681062665"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062665"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [TyVar] -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621681062675"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062668"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.16.4.0/src/GHC-Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062666"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062667"><span class="hs-identifier hs-var">rev_bs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062665"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1973"></span><span>    </span><span class="annot"><a href="#local-6989586621681062675"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681062664"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062664"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681062663"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062663"><span class="hs-identifier hs-var">rev_bs</span></a></span></span><span> </span><span id="local-6989586621681062662"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062662"><span class="hs-identifier hs-var">e</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="GHC.Core.Opt.Arity.html#etaBodyForJoinPoint"><span class="hs-identifier hs-var">etaBodyForJoinPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062664"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062662"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1974"></span><span>                              </span><span class="hs-special">(</span><span id="local-6989586621681062660"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062660"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062659"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062659"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a]
</span><a href="../../base-4.16.4.0/src/GHC-List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062663"><span class="hs-identifier hs-var">rev_bs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062660"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062659"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1975"></span><span>
</span><span id="line-1976"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaExpandToJoinPointRule"><span class="hs-identifier hs-type">etaExpandToJoinPointRule</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#JoinArity"><span class="hs-identifier hs-type">JoinArity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span>
</span><span id="line-1977"></span><span id="etaExpandToJoinPointRule"><span class="annot"><span class="annottext">etaExpandToJoinPointRule :: Int -&gt; CoreRule -&gt; CoreRule
</span><a href="GHC.Core.Opt.Arity.html#etaExpandToJoinPointRule"><span class="hs-identifier hs-var hs-var">etaExpandToJoinPointRule</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681062658"><span class="annot"><span class="annottext">rule :: CoreRule
</span><a href="#local-6989586621681062658"><span class="hs-identifier hs-var">rule</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#BuiltinRule"><span class="hs-identifier hs-type">BuiltinRule</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1978"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span class="hs-identifier">True</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;Can't eta-expand built-in rule:&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">rule</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1979"></span><span>      </span><span class="hs-comment">-- How did a local binding get a built-in rule anyway? Probably a plugin.</span><span>
</span><span id="line-1980"></span><span>    </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621681062658"><span class="hs-identifier hs-var">rule</span></a></span><span>
</span><span id="line-1981"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaExpandToJoinPointRule"><span class="hs-identifier hs-var">etaExpandToJoinPointRule</span></a></span><span> </span><span id="local-6989586621681062655"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062655"><span class="hs-identifier hs-var">join_arity</span></a></span></span><span> </span><span id="local-6989586621681062654"><span class="annot"><span class="annottext">rule :: CoreRule
</span><a href="#local-6989586621681062654"><span class="hs-identifier hs-var">rule</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rule"><span class="hs-identifier hs-type">Rule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ru_bndrs :: CoreRule -&gt; [TyVar]
</span><a href="GHC.Core.html#ru_bndrs"><span class="hs-identifier hs-var">ru_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681062651"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062651"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_rhs :: CoreRule -&gt; CoreExpr
</span><a href="GHC.Core.html#ru_rhs"><span class="hs-identifier hs-var">ru_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681062649"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062649"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-1982"></span><span>                                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_args :: CoreRule -&gt; [CoreExpr]
</span><a href="GHC.Core.html#ru_args"><span class="hs-identifier hs-var">ru_args</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681062647"><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062647"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1983"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062646"><span class="hs-identifier hs-var">need_args</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1984"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621681062654"><span class="hs-identifier hs-var">rule</span></a></span><span>
</span><span id="line-1985"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062646"><span class="hs-identifier hs-var">need_args</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1986"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;etaExpandToJoinPointRule&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062655"><span class="hs-identifier hs-var">join_arity</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621681062654"><span class="hs-identifier hs-var">rule</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1987"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1988"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621681062654"><span class="hs-identifier hs-var">rule</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ru_bndrs :: [TyVar]
</span><a href="GHC.Core.html#ru_bndrs"><span class="hs-identifier hs-var">ru_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062651"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062644"><span class="hs-identifier hs-var">new_bndrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_args :: [CoreExpr]
</span><a href="GHC.Core.html#ru_args"><span class="hs-identifier hs-var">ru_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062647"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062643"><span class="hs-identifier hs-var">new_args</span></a></span><span>
</span><span id="line-1989"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ru_rhs :: CoreExpr
</span><a href="GHC.Core.html#ru_rhs"><span class="hs-identifier hs-var">ru_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062642"><span class="hs-identifier hs-var">new_rhs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1990"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1991"></span><span>    </span><span id="local-6989586621681062646"><span class="annot"><span class="annottext">need_args :: Int
</span><a href="#local-6989586621681062646"><span class="hs-identifier hs-var hs-var">need_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062655"><span class="hs-identifier hs-var">join_arity</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.16.4.0/src/GHC-Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../../base-4.16.4.0/src/Data-Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><a href="#local-6989586621681062647"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-1992"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681062644"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062644"><span class="hs-identifier hs-var">new_bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062642"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062642"><span class="hs-identifier hs-var">new_rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="GHC.Core.Opt.Arity.html#etaBodyForJoinPoint"><span class="hs-identifier hs-var">etaBodyForJoinPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062646"><span class="hs-identifier hs-var">need_args</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062649"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1993"></span><span>    </span><span id="local-6989586621681062643"><span class="annot"><span class="annottext">new_args :: [CoreExpr]
</span><a href="#local-6989586621681062643"><span class="hs-identifier hs-var hs-var">new_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b. [TyVar] -&gt; [Expr b]
</span><a href="GHC.Core.html#varsToCoreExprs"><span class="hs-identifier hs-var">varsToCoreExprs</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062644"><span class="hs-identifier hs-var">new_bndrs</span></a></span><span>
</span><span id="line-1994"></span><span>
</span><span id="line-1995"></span><span class="hs-comment">-- Adds as many binders as asked for; assumes expr is not a lambda</span><span>
</span><span id="line-1996"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#etaBodyForJoinPoint"><span class="hs-identifier hs-type">etaBodyForJoinPoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1997"></span><span id="etaBodyForJoinPoint"><span class="annot"><span class="annottext">etaBodyForJoinPoint :: Int -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="GHC.Core.Opt.Arity.html#etaBodyForJoinPoint"><span class="hs-identifier hs-var hs-var">etaBodyForJoinPoint</span></a></span></span><span> </span><span id="local-6989586621681062640"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062640"><span class="hs-identifier hs-var">need_args</span></a></span></span><span> </span><span id="local-6989586621681062639"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062639"><span class="hs-identifier hs-var">body</span></a></span></span><span>
</span><span id="line-1998"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Type -&gt; TCvSubst -&gt; [TyVar] -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621681062638"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062640"><span class="hs-identifier hs-var">need_args</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; Type
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062639"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; TCvSubst
</span><a href="#local-6989586621681062637"><span class="hs-identifier hs-var">init_subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062639"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062639"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1999"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2000"></span><span>    </span><span id="local-6989586621681062638"><span class="annot"><span class="annottext">go :: Int
-&gt; Type -&gt; TCvSubst -&gt; [TyVar] -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621681062638"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span>  </span><span class="annot"><span class="annottext">TCvSubst
</span><span class="hs-identifier">_</span></span><span>     </span><span id="local-6989586621681062636"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062636"><span class="hs-identifier hs-var">rev_bs</span></a></span></span><span> </span><span id="local-6989586621681062635"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062635"><span class="hs-identifier hs-var">e</span></a></span></span><span>
</span><span id="line-2001"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a]
</span><a href="../../base-4.16.4.0/src/GHC-List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062636"><span class="hs-identifier hs-var">rev_bs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062635"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2002"></span><span>    </span><span class="annot"><a href="#local-6989586621681062638"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681062634"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062634"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681062633"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062633"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681062632"><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062632"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621681062631"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062631"><span class="hs-identifier hs-var">rev_bs</span></a></span></span><span> </span><span id="local-6989586621681062630"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062630"><span class="hs-identifier hs-var">e</span></a></span></span><span>
</span><span id="line-2003"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062629"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062629"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062628"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062628"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (TyVar, Type)
</span><a href="GHC.Core.Type.html#splitForAllTyCoVar_maybe"><span class="hs-identifier hs-var">splitForAllTyCoVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062633"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2004"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062627"><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062627"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062626"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062626"><span class="hs-identifier hs-var">tv'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; TCvSubst -&gt; TyVar -&gt; (TCvSubst, TyVar)
</span><a href="GHC.Core.TyCo.Subst.html#substVarBndr"><span class="hs-identifier hs-var">substVarBndr</span></a></span><span> </span><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062632"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062629"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-2005"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Type -&gt; TCvSubst -&gt; [TyVar] -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621681062638"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062634"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.16.4.0/src/GHC-Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062628"><span class="hs-identifier hs-var">res_ty</span></a></span><span> </span><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062627"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062626"><span class="hs-identifier hs-var">tv'</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062631"><span class="hs-identifier hs-var">rev_bs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062630"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-operator hs-var">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">forall b. TyVar -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062626"><span class="hs-identifier hs-var">tv'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2006"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062625"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062625"><span class="hs-identifier hs-var">mult</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062624"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062624"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062623"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062623"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (Type, Type, Type)
</span><a href="GHC.Core.Type.html#splitFunTy_maybe"><span class="hs-identifier hs-var">splitFunTy_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062633"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2007"></span><span>        </span><span class="hs-comment">-- The varToCoreExpr is important: `tv` might be a coercion variable</span><span>
</span><span id="line-2008"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681062622"><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062622"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681062621"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062621"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; TCvSubst -&gt; Scaled Type -&gt; (TCvSubst, TyVar)
</span><a href="GHC.Core.Opt.Arity.html#freshEtaId"><span class="hs-identifier hs-var">freshEtaId</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062634"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062632"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Type -&gt; a -&gt; Scaled a
</span><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-var">Scaled</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062625"><span class="hs-identifier hs-var">mult</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062624"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2009"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Type -&gt; TCvSubst -&gt; [TyVar] -&gt; CoreExpr -&gt; ([TyVar], CoreExpr)
</span><a href="#local-6989586621681062638"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062634"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.16.4.0/src/GHC-Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062623"><span class="hs-identifier hs-var">res_ty</span></a></span><span> </span><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062622"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062621"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681062631"><span class="hs-identifier hs-var">rev_bs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062630"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-operator hs-var">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">forall b. TyVar -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062621"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2010"></span><span>        </span><span class="hs-comment">-- The varToCoreExpr is important: `b` might be a coercion variable</span><span>
</span><span id="line-2011"></span><span>
</span><span id="line-2012"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-2013"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;etaBodyForJoinPoint&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062640"><span class="hs-identifier hs-var">need_args</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-2014"></span><span>                                         </span><span class="annot"><span class="annottext">forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062639"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; Type
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062639"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2015"></span><span>
</span><span id="line-2016"></span><span>    </span><span id="local-6989586621681062637"><span class="annot"><span class="annottext">init_subst :: CoreExpr -&gt; TCvSubst
</span><a href="#local-6989586621681062637"><span class="hs-identifier hs-var hs-var">init_subst</span></a></span></span><span> </span><span id="local-6989586621681062619"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062619"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; TCvSubst
</span><a href="GHC.Core.TyCo.Subst.html#mkEmptyTCvSubst"><span class="hs-identifier hs-var">mkEmptyTCvSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; VarSet
</span><a href="GHC.Core.FVs.html#exprFreeVars"><span class="hs-identifier hs-var">exprFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681062619"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2017"></span><span>
</span><span id="line-2018"></span><span>
</span><span id="line-2019"></span><span>
</span><span id="line-2020"></span><span class="hs-comment">--------------</span><span>
</span><span id="line-2021"></span><span class="annot"><a href="GHC.Core.Opt.Arity.html#freshEtaId"><span class="hs-identifier hs-type">freshEtaId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-type">Scaled</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2022"></span><span class="hs-comment">-- Make a fresh Id, with specified type (after applying substitution)</span><span>
</span><span id="line-2023"></span><span class="hs-comment">-- It should be &quot;fresh&quot; in the sense that it's not in the in-scope set</span><span>
</span><span id="line-2024"></span><span class="hs-comment">-- of the TvSubstEnv; and it should itself then be added to the in-scope</span><span>
</span><span id="line-2025"></span><span class="hs-comment">-- set of the TvSubstEnv</span><span>
</span><span id="line-2026"></span><span class="hs-comment">--</span><span>
</span><span id="line-2027"></span><span class="hs-comment">-- The Int is just a reasonable starting point for generating a unique;</span><span>
</span><span id="line-2028"></span><span class="hs-comment">-- it does not necessarily have to be unique itself.</span><span>
</span><span id="line-2029"></span><span id="freshEtaId"><span class="annot"><span class="annottext">freshEtaId :: Int -&gt; TCvSubst -&gt; Scaled Type -&gt; (TCvSubst, TyVar)
</span><a href="GHC.Core.Opt.Arity.html#freshEtaId"><span class="hs-identifier hs-var hs-var">freshEtaId</span></a></span></span><span> </span><span id="local-6989586621681062618"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062618"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681062617"><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062617"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621681062616"><span class="annot"><span class="annottext">Scaled Type
</span><a href="#local-6989586621681062616"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-2030"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062615"><span class="hs-identifier hs-var">subst'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062614"><span class="hs-identifier hs-var">eta_id'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2031"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-2032"></span><span>        </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Scaled"><span class="hs-identifier hs-type">Scaled</span></a></span><span> </span><span id="local-6989586621681062613"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062613"><span class="hs-identifier hs-var">mult'</span></a></span></span><span> </span><span id="local-6989586621681062612"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062612"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; TCvSubst -&gt; Scaled Type -&gt; Scaled Type
</span><a href="GHC.Core.TyCo.Subst.html#substScaledTyUnchecked"><span class="hs-identifier hs-var">Type.substScaledTyUnchecked</span></a></span><span> </span><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062617"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Scaled Type
</span><a href="#local-6989586621681062616"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2033"></span><span>        </span><span id="local-6989586621681062614"><span class="annot"><span class="annottext">eta_id' :: TyVar
</span><a href="#local-6989586621681062614"><span class="hs-identifier hs-var hs-var">eta_id'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; TyVar -&gt; TyVar
</span><a href="GHC.Types.Var.Env.html#uniqAway"><span class="hs-identifier hs-var">uniqAway</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TCvSubst -&gt; InScopeSet
</span><a href="GHC.Core.TyCo.Subst.html#getTCvInScope"><span class="hs-identifier hs-var">getTCvInScope</span></a></span><span> </span><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062617"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-2034"></span><span>                  </span><span class="annot"><span class="annottext">FastString -&gt; Unique -&gt; Type -&gt; Type -&gt; TyVar
</span><a href="GHC.Types.Id.html#mkSysLocalOrCoVar"><span class="hs-identifier hs-var">mkSysLocalOrCoVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;eta&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Unique
</span><a href="GHC.Builtin.Uniques.html#mkBuiltinUnique"><span class="hs-identifier hs-var">mkBuiltinUnique</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681062618"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062613"><span class="hs-identifier hs-var">mult'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681062612"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-2035"></span><span>                  </span><span class="hs-comment">-- &quot;OrCoVar&quot; since this can be used to eta-expand</span><span>
</span><span id="line-2036"></span><span>                  </span><span class="hs-comment">-- coercion abstractions</span><span>
</span><span id="line-2037"></span><span>        </span><span id="local-6989586621681062615"><span class="annot"><span class="annottext">subst' :: TCvSubst
</span><a href="#local-6989586621681062615"><span class="hs-identifier hs-var hs-var">subst'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TCvSubst -&gt; TyVar -&gt; TCvSubst
</span><a href="GHC.Core.TyCo.Subst.html#extendTCvInScope"><span class="hs-identifier hs-var">extendTCvInScope</span></a></span><span> </span><span class="annot"><span class="annottext">TCvSubst
</span><a href="#local-6989586621681062617"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681062614"><span class="hs-identifier hs-var">eta_id'</span></a></span><span>
</span><span id="line-2038"></span></pre></body></html>