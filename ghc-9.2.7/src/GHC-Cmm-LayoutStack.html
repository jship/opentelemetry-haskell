<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Cmm/LayoutStack.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE BangPatterns, RecordWildCards, GADTs #-}</span>
<a name="line-2"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Cmm.LayoutStack</span> <span class='hs-layout'>(</span>
<a name="line-3"></a>       <span class='hs-varid'>cmmLayoutStack</span><span class='hs-layout'>,</span> <span class='hs-varid'>setInfoTableStackMap</span>
<a name="line-4"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>&lt;*&gt;</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Platform</span>
<a name="line-9"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Platform.Profile</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.StgToCmm.Monad</span>      <span class='hs-layout'>(</span> <span class='hs-varid'>newTemp</span>  <span class='hs-layout'>)</span> <span class='hs-comment'>-- XXX layering violation</span>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.StgToCmm.Utils</span>      <span class='hs-layout'>(</span> <span class='hs-varid'>callerSaveVolatileRegs</span>  <span class='hs-layout'>)</span> <span class='hs-comment'>-- XXX layering violation</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.StgToCmm.Foreign</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>saveThreadState</span><span class='hs-layout'>,</span> <span class='hs-varid'>loadThreadState</span> <span class='hs-layout'>)</span> <span class='hs-comment'>-- XXX layering violation</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Basic</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.Info</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.BlockId</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.CLabel</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.Utils</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.Graph</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.ForeignCall</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.Liveness</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.ProcPoint</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Runtime.Heap.Layout</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.Dataflow.Block</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.Dataflow.Collections</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.Dataflow</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.Dataflow.Graph</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.Dataflow.Label</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.Supply</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Maybe</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.FM</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-35"></a>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Session</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.FastString</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-varid'>isEmpty</span> <span class='hs-layout'>)</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.Set</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Set</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad.Fix</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Array</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Array</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List</span> <span class='hs-layout'>(</span><span class='hs-varid'>nub</span><span class='hs-layout'>)</span>
<a name="line-44"></a>
<a name="line-45"></a><span class='hs-comment'>{- Note [Stack Layout]
<a name="line-46"></a>
<a name="line-47"></a>The job of this pass is to
<a name="line-48"></a>
<a name="line-49"></a> - replace references to abstract stack Areas with fixed offsets from Sp.
<a name="line-50"></a>
<a name="line-51"></a> - replace the CmmHighStackMark constant used in the stack check with
<a name="line-52"></a>   the maximum stack usage of the proc.
<a name="line-53"></a>
<a name="line-54"></a> - save any variables that are live across a call, and reload them as
<a name="line-55"></a>   necessary.
<a name="line-56"></a>
<a name="line-57"></a>Before stack allocation, local variables remain live across native
<a name="line-58"></a>calls (CmmCall{ cmm_cont = Just _ }), and after stack allocation local
<a name="line-59"></a>variables are clobbered by native calls.
<a name="line-60"></a>
<a name="line-61"></a>We want to do stack allocation so that as far as possible
<a name="line-62"></a> - stack use is minimized, and
<a name="line-63"></a> - unnecessary stack saves and loads are avoided.
<a name="line-64"></a>
<a name="line-65"></a>The algorithm we use is a variant of linear-scan register allocation,
<a name="line-66"></a>where the stack is our register file.
<a name="line-67"></a>
<a name="line-68"></a>We proceed in two passes, see Note [Two pass approach] for why they are not easy
<a name="line-69"></a>to merge into one.
<a name="line-70"></a>
<a name="line-71"></a>Pass 1:
<a name="line-72"></a>
<a name="line-73"></a> - First, we do a liveness analysis, which annotates every block with
<a name="line-74"></a>   the variables live on entry to the block.
<a name="line-75"></a>
<a name="line-76"></a> - We traverse blocks in reverse postorder DFS; that is, we visit at
<a name="line-77"></a>   least one predecessor of a block before the block itself.  The
<a name="line-78"></a>   stack layout flowing from the predecessor of the block will
<a name="line-79"></a>   determine the stack layout on entry to the block.
<a name="line-80"></a>
<a name="line-81"></a> - We maintain a data structure
<a name="line-82"></a>
<a name="line-83"></a>     Map Label StackMap
<a name="line-84"></a>
<a name="line-85"></a>   which describes the contents of the stack and the stack pointer on
<a name="line-86"></a>   entry to each block that is a successor of a block that we have
<a name="line-87"></a>   visited.
<a name="line-88"></a>
<a name="line-89"></a> - For each block we visit:
<a name="line-90"></a>
<a name="line-91"></a>    - Look up the StackMap for this block.
<a name="line-92"></a>
<a name="line-93"></a>    - If this block is a proc point (or a call continuation, if we aren't
<a name="line-94"></a>      splitting proc points), we need to reload all the live variables from the
<a name="line-95"></a>      stack - but this is done in Pass 2, which calculates more precise liveness
<a name="line-96"></a>      information (see description of Pass 2).
<a name="line-97"></a>
<a name="line-98"></a>    - Walk forwards through the instructions:
<a name="line-99"></a>      - At an assignment  x = Sp[loc]
<a name="line-100"></a>        - Record the fact that Sp[loc] contains x, so that we won't
<a name="line-101"></a>          need to save x if it ever needs to be spilled.
<a name="line-102"></a>      - At an assignment  x = E
<a name="line-103"></a>        - If x was previously on the stack, it isn't any more
<a name="line-104"></a>      - At the last node, if it is a call or a jump to a proc point
<a name="line-105"></a>        - Lay out the stack frame for the call (see setupStackFrame)
<a name="line-106"></a>        - emit instructions to save all the live variables
<a name="line-107"></a>        - Remember the StackMaps for all the successors
<a name="line-108"></a>        - emit an instruction to adjust Sp
<a name="line-109"></a>      - If the last node is a branch, then the current StackMap is the
<a name="line-110"></a>        StackMap for the successors.
<a name="line-111"></a>
<a name="line-112"></a>    - Manifest Sp: replace references to stack areas in this block
<a name="line-113"></a>      with real Sp offsets. We cannot do this until we have laid out
<a name="line-114"></a>      the stack area for the successors above.
<a name="line-115"></a>
<a name="line-116"></a>      In this phase we also eliminate redundant stores to the stack;
<a name="line-117"></a>      see elimStackStores.
<a name="line-118"></a>
<a name="line-119"></a>  - There is one important gotcha: sometimes we'll encounter a control
<a name="line-120"></a>    transfer to a block that we've already processed (a join point),
<a name="line-121"></a>    and in that case we might need to rearrange the stack to match
<a name="line-122"></a>    what the block is expecting. (exactly the same as in linear-scan
<a name="line-123"></a>    register allocation, except here we have the luxury of an infinite
<a name="line-124"></a>    supply of temporary variables).
<a name="line-125"></a>
<a name="line-126"></a>  - Finally, we update the magic CmmHighStackMark constant with the
<a name="line-127"></a>    stack usage of the function, and eliminate the whole stack check
<a name="line-128"></a>    if there was no stack use. (in fact this is done as part of the
<a name="line-129"></a>    main traversal, by feeding the high-water-mark output back in as
<a name="line-130"></a>    an input. I hate cyclic programming, but it's just too convenient
<a name="line-131"></a>    sometimes.)
<a name="line-132"></a>
<a name="line-133"></a>  There are plenty of tricky details: update frames, proc points, return
<a name="line-134"></a>  addresses, foreign calls, and some ad-hoc optimisations that are
<a name="line-135"></a>  convenient to do here and effective in common cases.  Comments in the
<a name="line-136"></a>  code below explain these.
<a name="line-137"></a>
<a name="line-138"></a>Pass 2:
<a name="line-139"></a>
<a name="line-140"></a>- Calculate live registers, but taking into account that nothing is live at the
<a name="line-141"></a>  entry to a proc point.
<a name="line-142"></a>
<a name="line-143"></a>- At each proc point and call continuation insert reloads of live registers from
<a name="line-144"></a>  the stack (they were saved by Pass 1).
<a name="line-145"></a>
<a name="line-146"></a>
<a name="line-147"></a>Note [Two pass approach]
<a name="line-148"></a>
<a name="line-149"></a>The main reason for Pass 2 is being able to insert only the reloads that are
<a name="line-150"></a>needed and the fact that the two passes need different liveness information.
<a name="line-151"></a>Let's consider an example:
<a name="line-152"></a>
<a name="line-153"></a>  .....
<a name="line-154"></a>   \ /
<a name="line-155"></a>    D   &lt;- proc point
<a name="line-156"></a>   / \
<a name="line-157"></a>  E   F
<a name="line-158"></a>   \ /
<a name="line-159"></a>    G   &lt;- proc point
<a name="line-160"></a>    |
<a name="line-161"></a>    X
<a name="line-162"></a>
<a name="line-163"></a>Pass 1 needs liveness assuming that local variables are preserved across calls.
<a name="line-164"></a>This is important because it needs to save any local registers to the stack
<a name="line-165"></a>(e.g., if register a is used in block X, it must be saved before any native
<a name="line-166"></a>call).
<a name="line-167"></a>However, for Pass 2, where we want to reload registers from stack (in a proc
<a name="line-168"></a>point), this is overly conservative and would lead us to generate reloads in D
<a name="line-169"></a>for things used in X, even though we're going to generate reloads in G anyway
<a name="line-170"></a>(since it's also a proc point).
<a name="line-171"></a>So Pass 2 calculates liveness knowing that nothing is live at the entry to a
<a name="line-172"></a>proc point. This means that in D we only need to reload things used in E or F.
<a name="line-173"></a>This can be quite important, for an extreme example see testcase for #3294.
<a name="line-174"></a>
<a name="line-175"></a>Merging the two passes is not trivial - Pass 2 is a backward rewrite and Pass 1
<a name="line-176"></a>is a forward one. Furthermore, Pass 1 is creating code that uses local registers
<a name="line-177"></a>(saving them before a call), which the liveness analysis for Pass 2 must see to
<a name="line-178"></a>be correct.
<a name="line-179"></a>
<a name="line-180"></a>-}</span>
<a name="line-181"></a>
<a name="line-182"></a>
<a name="line-183"></a><a name="StackLoc"></a><span class='hs-comment'>-- All stack locations are expressed as positive byte offsets from the</span>
<a name="line-184"></a><a name="StackLoc"></a><span class='hs-comment'>-- "base", which is defined to be the address above the return address</span>
<a name="line-185"></a><a name="StackLoc"></a><span class='hs-comment'>-- on the stack on entry to this CmmProc.</span>
<a name="line-186"></a><a name="StackLoc"></a><span class='hs-comment'>--</span>
<a name="line-187"></a><a name="StackLoc"></a><span class='hs-comment'>-- Lower addresses have higher StackLocs.</span>
<a name="line-188"></a><a name="StackLoc"></a><span class='hs-comment'>--</span>
<a name="line-189"></a><a name="StackLoc"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>StackLoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ByteOff</span>
<a name="line-190"></a>
<a name="line-191"></a><span class='hs-comment'>{-
<a name="line-192"></a> A StackMap describes the stack at any given point.  At a continuation
<a name="line-193"></a> it has a particular layout, like this:
<a name="line-194"></a>
<a name="line-195"></a>         |             | &lt;- base
<a name="line-196"></a>         |-------------|
<a name="line-197"></a>         |     ret0    | &lt;- base + 8
<a name="line-198"></a>         |-------------|
<a name="line-199"></a>         .  upd frame  . &lt;- base + sm_ret_off
<a name="line-200"></a>         |-------------|
<a name="line-201"></a>         |             |
<a name="line-202"></a>         .    vars     .
<a name="line-203"></a>         . (live/dead) .
<a name="line-204"></a>         |             | &lt;- base + sm_sp - sm_args
<a name="line-205"></a>         |-------------|
<a name="line-206"></a>         |    ret1     |
<a name="line-207"></a>         .  ret vals   . &lt;- base + sm_sp    (&lt;--- Sp points here)
<a name="line-208"></a>         |-------------|
<a name="line-209"></a>
<a name="line-210"></a>Why do we include the final return address (ret0) in our stack map?  I
<a name="line-211"></a>have absolutely no idea, but it seems to be done that way consistently
<a name="line-212"></a>in the rest of the code generator, so I played along here. --SDM
<a name="line-213"></a>
<a name="line-214"></a>Note that we will be constructing an info table for the continuation
<a name="line-215"></a>(ret1), which needs to describe the stack down to, but not including,
<a name="line-216"></a>the update frame (or ret0, if there is no update frame).
<a name="line-217"></a>-}</span>
<a name="line-218"></a>
<a name="line-219"></a><a name="StackMap"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>StackMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StackMap</span>
<a name="line-220"></a> <span class='hs-layout'>{</span>  <span class='hs-varid'>sm_sp</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StackLoc</span>
<a name="line-221"></a>       <span class='hs-comment'>-- ^ the offset of Sp relative to the base on entry</span>
<a name="line-222"></a>       <span class='hs-comment'>-- to this block.</span>
<a name="line-223"></a> <span class='hs-layout'>,</span>  <span class='hs-varid'>sm_args</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteOff</span>
<a name="line-224"></a>       <span class='hs-comment'>-- ^ the number of bytes of arguments in the area for this block</span>
<a name="line-225"></a>       <span class='hs-comment'>-- Defn: the offset of young(L) relative to the base is given by</span>
<a name="line-226"></a>       <span class='hs-comment'>-- (sm_sp - sm_args) of the StackMap for block L.</span>
<a name="line-227"></a> <span class='hs-layout'>,</span>  <span class='hs-varid'>sm_ret_off</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteOff</span>
<a name="line-228"></a>       <span class='hs-comment'>-- ^ Number of words of stack that we do not describe with an info</span>
<a name="line-229"></a>       <span class='hs-comment'>-- table, because it contains an update frame.</span>
<a name="line-230"></a> <span class='hs-layout'>,</span>  <span class='hs-varid'>sm_regs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqFM</span> <span class='hs-conid'>LocalReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocalReg</span><span class='hs-layout'>,</span><span class='hs-conid'>StackLoc</span><span class='hs-layout'>)</span>
<a name="line-231"></a>       <span class='hs-comment'>-- ^ regs on the stack</span>
<a name="line-232"></a> <span class='hs-layout'>}</span>
<a name="line-233"></a>
<a name="line-234"></a><a name="instance%20Outputable%20StackMap"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>StackMap</span> <span class='hs-keyword'>where</span>
<a name="line-235"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>StackMap</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span>
<a name="line-236"></a>     <span class='hs-varid'>text</span> <span class='hs-str'>"Sp = "</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>sm_sp</span> <span class='hs-varop'>$$</span>
<a name="line-237"></a>     <span class='hs-varid'>text</span> <span class='hs-str'>"sm_args = "</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>sm_args</span> <span class='hs-varop'>$$</span>
<a name="line-238"></a>     <span class='hs-varid'>text</span> <span class='hs-str'>"sm_ret_off = "</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>sm_ret_off</span> <span class='hs-varop'>$$</span>
<a name="line-239"></a>     <span class='hs-varid'>text</span> <span class='hs-str'>"sm_regs = "</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>pprUFM</span> <span class='hs-varid'>sm_regs</span> <span class='hs-varid'>ppr</span>
<a name="line-240"></a>
<a name="line-241"></a>
<a name="line-242"></a><a name="cmmLayoutStack"></a><span class='hs-definition'>cmmLayoutStack</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ProcPointSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmGraph</span>
<a name="line-243"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGraph</span><span class='hs-layout'>,</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>StackMap</span><span class='hs-layout'>)</span>
<a name="line-244"></a><span class='hs-definition'>cmmLayoutStack</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>procpoints</span> <span class='hs-varid'>entry_args</span>
<a name="line-245"></a>               <span class='hs-varid'>graph</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CmmGraph</span> <span class='hs-layout'>{</span> <span class='hs-varid'>g_entry</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>entry</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-246"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-247"></a>    <span class='hs-comment'>-- We need liveness info. Dead assignments are removed later</span>
<a name="line-248"></a>    <span class='hs-comment'>-- by the sinking pass.</span>
<a name="line-249"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>liveness</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmLocalLiveness</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>graph</span>
<a name="line-250"></a>        <span class='hs-varid'>blocks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>revPostorder</span> <span class='hs-varid'>graph</span>
<a name="line-251"></a>        <span class='hs-varid'>profile</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetProfile</span> <span class='hs-varid'>dflags</span>
<a name="line-252"></a>        <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>profilePlatform</span> <span class='hs-varid'>profile</span>
<a name="line-253"></a>
<a name="line-254"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>final_stackmaps</span><span class='hs-layout'>,</span> <span class='hs-sel'>_final_high_sp</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_blocks</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-255"></a>          <span class='hs-varid'>mfix</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyglyph'>~</span><span class='hs-layout'>(</span><span class='hs-varid'>rec_stackmaps</span><span class='hs-layout'>,</span> <span class='hs-varid'>rec_high_sp</span><span class='hs-layout'>,</span> <span class='hs-sel'>_new_blocks</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-256"></a>            <span class='hs-varid'>layout</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>procpoints</span> <span class='hs-varid'>liveness</span> <span class='hs-varid'>entry</span> <span class='hs-varid'>entry_args</span>
<a name="line-257"></a>                   <span class='hs-varid'>rec_stackmaps</span> <span class='hs-varid'>rec_high_sp</span> <span class='hs-varid'>blocks</span>
<a name="line-258"></a>
<a name="line-259"></a>    <span class='hs-varid'>blocks_with_reloads</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-260"></a>        <span class='hs-varid'>insertReloadsAsNeeded</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>procpoints</span> <span class='hs-varid'>final_stackmaps</span> <span class='hs-varid'>entry</span> <span class='hs-varid'>new_blocks</span>
<a name="line-261"></a>    <span class='hs-varid'>new_blocks'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>lowerSafeForeignCall</span> <span class='hs-varid'>profile</span><span class='hs-layout'>)</span> <span class='hs-varid'>blocks_with_reloads</span>
<a name="line-262"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ofBlockList</span> <span class='hs-varid'>entry</span> <span class='hs-varid'>new_blocks'</span><span class='hs-layout'>,</span> <span class='hs-varid'>final_stackmaps</span><span class='hs-layout'>)</span>
<a name="line-263"></a>
<a name="line-264"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-265"></a><span class='hs-comment'>-- Pass 1</span>
<a name="line-266"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-267"></a>
<a name="line-268"></a><a name="layout"></a><span class='hs-definition'>layout</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-269"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LabelSet</span>                      <span class='hs-comment'>-- proc points</span>
<a name="line-270"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>CmmLocalLive</span>         <span class='hs-comment'>-- liveness</span>
<a name="line-271"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockId</span>                       <span class='hs-comment'>-- entry</span>
<a name="line-272"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>                       <span class='hs-comment'>-- stack args on entry</span>
<a name="line-273"></a>
<a name="line-274"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>StackMap</span>             <span class='hs-comment'>-- [final] stack maps</span>
<a name="line-275"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>                       <span class='hs-comment'>-- [final] Sp high water mark</span>
<a name="line-276"></a>
<a name="line-277"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmBlock</span><span class='hs-keyglyph'>]</span>                    <span class='hs-comment'>-- [in] blocks</span>
<a name="line-278"></a>
<a name="line-279"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span>
<a name="line-280"></a>          <span class='hs-layout'>(</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>StackMap</span>           <span class='hs-comment'>-- [out] stack maps</span>
<a name="line-281"></a>          <span class='hs-layout'>,</span> <span class='hs-conid'>ByteOff</span>                     <span class='hs-comment'>-- [out] Sp high water mark</span>
<a name="line-282"></a>          <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmBlock</span><span class='hs-keyglyph'>]</span>                  <span class='hs-comment'>-- [out] new blocks</span>
<a name="line-283"></a>          <span class='hs-layout'>)</span>
<a name="line-284"></a>
<a name="line-285"></a><span class='hs-definition'>layout</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>procpoints</span> <span class='hs-varid'>liveness</span> <span class='hs-varid'>entry</span> <span class='hs-varid'>entry_args</span> <span class='hs-varid'>final_stackmaps</span> <span class='hs-varid'>final_sp_high</span> <span class='hs-varid'>blocks</span>
<a name="line-286"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>blocks</span> <span class='hs-varid'>init_stackmap</span> <span class='hs-varid'>entry_args</span> <span class='hs-conid'>[]</span>
<a name="line-287"></a>  <span class='hs-keyword'>where</span>
<a name="line-288"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>updfr</span><span class='hs-layout'>,</span> <span class='hs-varid'>cont_info</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectContInfo</span> <span class='hs-varid'>blocks</span>
<a name="line-289"></a>
<a name="line-290"></a>    <span class='hs-varid'>init_stackmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapSingleton</span> <span class='hs-varid'>entry</span> <span class='hs-conid'>StackMap</span><span class='hs-layout'>{</span> <span class='hs-varid'>sm_sp</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>entry_args</span>
<a name="line-291"></a>                                               <span class='hs-layout'>,</span> <span class='hs-varid'>sm_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>entry_args</span>
<a name="line-292"></a>                                               <span class='hs-layout'>,</span> <span class='hs-varid'>sm_ret_off</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updfr</span>
<a name="line-293"></a>                                               <span class='hs-layout'>,</span> <span class='hs-varid'>sm_regs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUFM</span>
<a name="line-294"></a>                                               <span class='hs-layout'>}</span>
<a name="line-295"></a>
<a name="line-296"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>acc_stackmaps</span> <span class='hs-varid'>acc_hwm</span> <span class='hs-varid'>acc_blocks</span>
<a name="line-297"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>acc_stackmaps</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc_hwm</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc_blocks</span><span class='hs-layout'>)</span>
<a name="line-298"></a>
<a name="line-299"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>b0</span> <span class='hs-conop'>:</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc_stackmaps</span> <span class='hs-varid'>acc_hwm</span> <span class='hs-varid'>acc_blocks</span>
<a name="line-300"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-301"></a>       <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>entry0</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CmmEntry</span> <span class='hs-varid'>entry_lbl</span> <span class='hs-varid'>tscope</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>middle0</span><span class='hs-layout'>,</span> <span class='hs-varid'>last0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>blockSplit</span> <span class='hs-varid'>b0</span>
<a name="line-302"></a>
<a name="line-303"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>stack0</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>StackMap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_sp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sp0</span> <span class='hs-layout'>}</span>
<a name="line-304"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapFindWithDefault</span>
<a name="line-305"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>pprPanic</span> <span class='hs-str'>"no stack map for"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>entry_lbl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-306"></a>                     <span class='hs-varid'>entry_lbl</span> <span class='hs-varid'>acc_stackmaps</span>
<a name="line-307"></a>
<a name="line-308"></a>       <span class='hs-comment'>-- (a) Update the stack map to include the effects of</span>
<a name="line-309"></a>       <span class='hs-comment'>--     assignments in this block</span>
<a name="line-310"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>stack1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldBlockNodesF</span> <span class='hs-layout'>(</span><span class='hs-varid'>procMiddle</span> <span class='hs-varid'>acc_stackmaps</span><span class='hs-layout'>)</span> <span class='hs-varid'>middle0</span> <span class='hs-varid'>stack0</span>
<a name="line-311"></a>
<a name="line-312"></a>       <span class='hs-comment'>-- (b) Look at the last node and if we are making a call or</span>
<a name="line-313"></a>       <span class='hs-comment'>--     jumping to a proc point, we must save the live</span>
<a name="line-314"></a>       <span class='hs-comment'>--     variables, adjust Sp, and construct the StackMaps for</span>
<a name="line-315"></a>       <span class='hs-comment'>--     each of the successor blocks.  See handleLastNode for</span>
<a name="line-316"></a>       <span class='hs-comment'>--     details.</span>
<a name="line-317"></a>       <span class='hs-layout'>(</span><span class='hs-varid'>middle1</span><span class='hs-layout'>,</span> <span class='hs-varid'>sp_off</span><span class='hs-layout'>,</span> <span class='hs-varid'>last1</span><span class='hs-layout'>,</span> <span class='hs-varid'>fixup_blocks</span><span class='hs-layout'>,</span> <span class='hs-varid'>out</span><span class='hs-layout'>)</span>
<a name="line-318"></a>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>handleLastNode</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>procpoints</span> <span class='hs-varid'>liveness</span> <span class='hs-varid'>cont_info</span>
<a name="line-319"></a>                             <span class='hs-varid'>acc_stackmaps</span> <span class='hs-varid'>stack1</span> <span class='hs-varid'>tscope</span> <span class='hs-varid'>middle0</span> <span class='hs-varid'>last0</span>
<a name="line-320"></a>
<a name="line-321"></a>       <span class='hs-comment'>-- (c) Manifest Sp: run over the nodes in the block and replace</span>
<a name="line-322"></a>       <span class='hs-comment'>--     CmmStackSlot with CmmLoad from Sp with a concrete offset.</span>
<a name="line-323"></a>       <span class='hs-comment'>--</span>
<a name="line-324"></a>       <span class='hs-comment'>-- our block:</span>
<a name="line-325"></a>       <span class='hs-comment'>--    middle0          -- the original middle nodes</span>
<a name="line-326"></a>       <span class='hs-comment'>--    middle1          -- live variable saves from handleLastNode</span>
<a name="line-327"></a>       <span class='hs-comment'>--    Sp = Sp + sp_off -- Sp adjustment goes here</span>
<a name="line-328"></a>       <span class='hs-comment'>--    last1            -- the last node</span>
<a name="line-329"></a>       <span class='hs-comment'>--</span>
<a name="line-330"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>middle_pre</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>blockToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>foldl'</span> <span class='hs-varid'>blockSnoc</span> <span class='hs-varid'>middle0</span> <span class='hs-varid'>middle1</span>
<a name="line-331"></a>
<a name="line-332"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>final_blocks</span> <span class='hs-keyglyph'>=</span>
<a name="line-333"></a>               <span class='hs-varid'>manifestSp</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>final_stackmaps</span> <span class='hs-varid'>stack0</span> <span class='hs-varid'>sp0</span> <span class='hs-varid'>final_sp_high</span>
<a name="line-334"></a>                          <span class='hs-varid'>entry0</span> <span class='hs-varid'>middle_pre</span> <span class='hs-varid'>sp_off</span> <span class='hs-varid'>last1</span> <span class='hs-varid'>fixup_blocks</span>
<a name="line-335"></a>
<a name="line-336"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>acc_stackmaps'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapUnion</span> <span class='hs-varid'>acc_stackmaps</span> <span class='hs-varid'>out</span>
<a name="line-337"></a>
<a name="line-338"></a>           <span class='hs-comment'>-- If this block jumps to the GC, then we do not take its</span>
<a name="line-339"></a>           <span class='hs-comment'>-- stack usage into account for the high-water mark.</span>
<a name="line-340"></a>           <span class='hs-comment'>-- Otherwise, if the only stack usage is in the stack-check</span>
<a name="line-341"></a>           <span class='hs-comment'>-- failure block itself, we will do a redundant stack</span>
<a name="line-342"></a>           <span class='hs-comment'>-- check.  The stack has a buffer designed to accommodate</span>
<a name="line-343"></a>           <span class='hs-comment'>-- the largest amount of stack needed for calling the GC.</span>
<a name="line-344"></a>           <span class='hs-comment'>--</span>
<a name="line-345"></a>           <span class='hs-varid'>this_sp_hwm</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGcJump</span> <span class='hs-varid'>last0</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-346"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sp0</span> <span class='hs-comment'>-</span> <span class='hs-varid'>sp_off</span>
<a name="line-347"></a>
<a name="line-348"></a>           <span class='hs-varid'>hwm'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maximum</span> <span class='hs-layout'>(</span><span class='hs-varid'>acc_hwm</span> <span class='hs-conop'>:</span> <span class='hs-varid'>this_sp_hwm</span> <span class='hs-conop'>:</span> <span class='hs-varid'>map</span> <span class='hs-varid'>sm_sp</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapElems</span> <span class='hs-varid'>out</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-349"></a>
<a name="line-350"></a>       <span class='hs-varid'>go</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>acc_stackmaps'</span> <span class='hs-varid'>hwm'</span> <span class='hs-layout'>(</span><span class='hs-varid'>final_blocks</span> <span class='hs-varop'>++</span> <span class='hs-varid'>acc_blocks</span><span class='hs-layout'>)</span>
<a name="line-351"></a>
<a name="line-352"></a>
<a name="line-353"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-354"></a>
<a name="line-355"></a><a name="isGcJump"></a><span class='hs-comment'>-- Not foolproof, but GCFun is the culprit we most want to catch</span>
<a name="line-356"></a><span class='hs-definition'>isGcJump</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>C</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-357"></a><span class='hs-definition'>isGcJump</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmCall</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cml_target</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-358"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l</span> <span class='hs-varop'>==</span> <span class='hs-conid'>GCFun</span> <span class='hs-varop'>||</span> <span class='hs-varid'>l</span> <span class='hs-varop'>==</span> <span class='hs-conid'>GCEnter1</span>
<a name="line-359"></a><span class='hs-definition'>isGcJump</span> <span class='hs-sel'>_something_else</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-360"></a>
<a name="line-361"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-362"></a>
<a name="line-363"></a><span class='hs-comment'>-- This doesn't seem right somehow.  We need to find out whether this</span>
<a name="line-364"></a><span class='hs-comment'>-- proc will push some update frame material at some point, so that we</span>
<a name="line-365"></a><span class='hs-comment'>-- can avoid using that area of the stack for spilling. Ideally we would</span>
<a name="line-366"></a><span class='hs-comment'>-- capture this information in the CmmProc (e.g. in CmmStackInfo; see #18232</span>
<a name="line-367"></a><span class='hs-comment'>-- for details on one ill-fated attempt at this).</span>
<a name="line-368"></a><span class='hs-comment'>--</span>
<a name="line-369"></a><span class='hs-comment'>-- So we'll just take the max of all the cml_ret_offs.  This could be</span>
<a name="line-370"></a><span class='hs-comment'>-- unnecessarily pessimistic, but probably not in the code we</span>
<a name="line-371"></a><span class='hs-comment'>-- generate.</span>
<a name="line-372"></a>
<a name="line-373"></a><a name="collectContInfo"></a><span class='hs-definition'>collectContInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmBlock</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteOff</span><span class='hs-layout'>,</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>ByteOff</span><span class='hs-layout'>)</span>
<a name="line-374"></a><span class='hs-definition'>collectContInfo</span> <span class='hs-varid'>blocks</span>
<a name="line-375"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>maximum</span> <span class='hs-varid'>ret_offs</span><span class='hs-layout'>,</span> <span class='hs-varid'>mapFromList</span> <span class='hs-layout'>(</span><span class='hs-varid'>catMaybes</span> <span class='hs-varid'>mb_argss</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-376"></a> <span class='hs-keyword'>where</span>
<a name="line-377"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>mb_argss</span><span class='hs-layout'>,</span> <span class='hs-varid'>ret_offs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAndUnzip</span> <span class='hs-varid'>get_cont</span> <span class='hs-varid'>blocks</span>
<a name="line-378"></a>
<a name="line-379"></a>  <span class='hs-varid'>get_cont</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Block</span> <span class='hs-conid'>CmmNode</span> <span class='hs-varid'>x</span> <span class='hs-conid'>C</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Label</span><span class='hs-layout'>,</span> <span class='hs-conid'>ByteOff</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>ByteOff</span><span class='hs-layout'>)</span>
<a name="line-380"></a>  <span class='hs-varid'>get_cont</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span>
<a name="line-381"></a>     <span class='hs-keyword'>case</span> <span class='hs-varid'>lastNode</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>of</span>
<a name="line-382"></a>        <span class='hs-conid'>CmmCall</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cml_cont</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>..</span> <span class='hs-layout'>}</span>
<a name="line-383"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-varid'>cml_ret_args</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>cml_ret_off</span><span class='hs-layout'>)</span>
<a name="line-384"></a>        <span class='hs-conid'>CmmForeignCall</span> <span class='hs-layout'>{</span> <span class='hs-keyglyph'>..</span> <span class='hs-layout'>}</span>
<a name="line-385"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>succ</span><span class='hs-layout'>,</span> <span class='hs-varid'>ret_args</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ret_off</span><span class='hs-layout'>)</span>
<a name="line-386"></a>        <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-387"></a>
<a name="line-388"></a>
<a name="line-389"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-390"></a><span class='hs-comment'>-- Updating the StackMap from middle nodes</span>
<a name="line-391"></a>
<a name="line-392"></a><a name="procMiddle"></a><span class='hs-comment'>-- Look for loads from stack slots, and update the StackMap.  This is</span>
<a name="line-393"></a><span class='hs-comment'>-- purely for optimisation reasons, so that we can avoid saving a</span>
<a name="line-394"></a><span class='hs-comment'>-- variable back to a different stack slot if it is already on the</span>
<a name="line-395"></a><span class='hs-comment'>-- stack.</span>
<a name="line-396"></a><span class='hs-comment'>--</span>
<a name="line-397"></a><span class='hs-comment'>-- This happens a lot: for example when function arguments are passed</span>
<a name="line-398"></a><span class='hs-comment'>-- on the stack and need to be immediately saved across a call, we</span>
<a name="line-399"></a><span class='hs-comment'>-- want to just leave them where they are on the stack.</span>
<a name="line-400"></a><span class='hs-comment'>--</span>
<a name="line-401"></a><span class='hs-definition'>procMiddle</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>StackMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmNode</span> <span class='hs-varid'>e</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StackMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StackMap</span>
<a name="line-402"></a><span class='hs-definition'>procMiddle</span> <span class='hs-varid'>stackmaps</span> <span class='hs-varid'>node</span> <span class='hs-varid'>sm</span>
<a name="line-403"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>node</span> <span class='hs-keyword'>of</span>
<a name="line-404"></a>     <span class='hs-conid'>CmmAssign</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLoad</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmStackSlot</span> <span class='hs-varid'>area</span> <span class='hs-varid'>off</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-405"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sm</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_regs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>sm_regs</span> <span class='hs-varid'>sm</span><span class='hs-layout'>)</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span><span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-406"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getStackLoc</span> <span class='hs-varid'>area</span> <span class='hs-varid'>off</span> <span class='hs-varid'>stackmaps</span>
<a name="line-407"></a>     <span class='hs-conid'>CmmAssign</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-sel'>_other</span>
<a name="line-408"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sm</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_regs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delFromUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>sm_regs</span> <span class='hs-varid'>sm</span><span class='hs-layout'>)</span> <span class='hs-varid'>r</span> <span class='hs-layout'>}</span>
<a name="line-409"></a>     <span class='hs-sel'>_other</span>
<a name="line-410"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sm</span>
<a name="line-411"></a>
<a name="line-412"></a><a name="getStackLoc"></a><span class='hs-definition'>getStackLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Area</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>StackMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StackLoc</span>
<a name="line-413"></a><span class='hs-definition'>getStackLoc</span> <span class='hs-conid'>Old</span>       <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-414"></a><span class='hs-definition'>getStackLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Young</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-varid'>stackmaps</span> <span class='hs-keyglyph'>=</span>
<a name="line-415"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>mapLookup</span> <span class='hs-varid'>l</span> <span class='hs-varid'>stackmaps</span> <span class='hs-keyword'>of</span>
<a name="line-416"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"getStackLoc"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-417"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>sm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sm_sp</span> <span class='hs-varid'>sm</span> <span class='hs-comment'>-</span> <span class='hs-varid'>sm_args</span> <span class='hs-varid'>sm</span> <span class='hs-varop'>+</span> <span class='hs-varid'>n</span>
<a name="line-418"></a>
<a name="line-419"></a>
<a name="line-420"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-421"></a><span class='hs-comment'>-- Handling stack allocation for a last node</span>
<a name="line-422"></a>
<a name="line-423"></a><span class='hs-comment'>-- We take a single last node and turn it into:</span>
<a name="line-424"></a><span class='hs-comment'>--</span>
<a name="line-425"></a><span class='hs-comment'>--    C1 (some statements)</span>
<a name="line-426"></a><span class='hs-comment'>--    Sp = Sp + N</span>
<a name="line-427"></a><span class='hs-comment'>--    C2 (some more statements)</span>
<a name="line-428"></a><span class='hs-comment'>--    call f()          -- the actual last node</span>
<a name="line-429"></a><span class='hs-comment'>--</span>
<a name="line-430"></a><span class='hs-comment'>-- plus possibly some more blocks (we may have to add some fixup code</span>
<a name="line-431"></a><span class='hs-comment'>-- between the last node and the continuation).</span>
<a name="line-432"></a><span class='hs-comment'>--</span>
<a name="line-433"></a><span class='hs-comment'>-- C1: is the code for saving the variables across this last node onto</span>
<a name="line-434"></a><span class='hs-comment'>-- the stack, if the continuation is a call or jumps to a proc point.</span>
<a name="line-435"></a><span class='hs-comment'>--</span>
<a name="line-436"></a><span class='hs-comment'>-- C2: if the last node is a safe foreign call, we have to inject some</span>
<a name="line-437"></a><span class='hs-comment'>-- extra code that goes *after* the Sp adjustment.</span>
<a name="line-438"></a>
<a name="line-439"></a><a name="handleLastNode"></a><span class='hs-definition'>handleLastNode</span>
<a name="line-440"></a>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ProcPointSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>CmmLocalLive</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>ByteOff</span>
<a name="line-441"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>StackMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StackMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmTickScope</span>
<a name="line-442"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Block</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>O</span>
<a name="line-443"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>C</span>
<a name="line-444"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span>
<a name="line-445"></a>      <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>O</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- nodes to go *before* the Sp adjustment</span>
<a name="line-446"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>ByteOff</span>            <span class='hs-comment'>-- amount to adjust Sp</span>
<a name="line-447"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>C</span>        <span class='hs-comment'>-- new last node</span>
<a name="line-448"></a>      <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmBlock</span><span class='hs-keyglyph'>]</span>         <span class='hs-comment'>-- new blocks</span>
<a name="line-449"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>StackMap</span>  <span class='hs-comment'>-- stackmaps for the continuations</span>
<a name="line-450"></a>      <span class='hs-layout'>)</span>
<a name="line-451"></a>
<a name="line-452"></a><span class='hs-definition'>handleLastNode</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>procpoints</span> <span class='hs-varid'>liveness</span> <span class='hs-varid'>cont_info</span> <span class='hs-varid'>stackmaps</span>
<a name="line-453"></a>               <span class='hs-varid'>stack0</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>StackMap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_sp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sp0</span> <span class='hs-layout'>}</span> <span class='hs-varid'>tscp</span> <span class='hs-varid'>middle</span> <span class='hs-varid'>last</span>
<a name="line-454"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>last</span> <span class='hs-keyword'>of</span>
<a name="line-455"></a>      <span class='hs-comment'>--  At each return / tail call,</span>
<a name="line-456"></a>      <span class='hs-comment'>--  adjust Sp to point to the last argument pushed, which</span>
<a name="line-457"></a>      <span class='hs-comment'>--  is cml_args, after popping any other junk from the stack.</span>
<a name="line-458"></a>      <span class='hs-conid'>CmmCall</span><span class='hs-layout'>{</span> <span class='hs-varid'>cml_cont</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>..</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-459"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>sp_off</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sp0</span> <span class='hs-comment'>-</span> <span class='hs-varid'>cml_args</span>
<a name="line-460"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>sp_off</span><span class='hs-layout'>,</span> <span class='hs-varid'>last</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>mapEmpty</span><span class='hs-layout'>)</span>
<a name="line-461"></a>
<a name="line-462"></a>      <span class='hs-comment'>--  At each CmmCall with a continuation:</span>
<a name="line-463"></a>      <span class='hs-conid'>CmmCall</span><span class='hs-layout'>{</span> <span class='hs-varid'>cml_cont</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cont_lbl</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>..</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-464"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lastCall</span> <span class='hs-varid'>cont_lbl</span> <span class='hs-varid'>cml_args</span> <span class='hs-varid'>cml_ret_args</span> <span class='hs-varid'>cml_ret_off</span>
<a name="line-465"></a>
<a name="line-466"></a>      <span class='hs-conid'>CmmForeignCall</span><span class='hs-layout'>{</span> <span class='hs-varid'>succ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cont_lbl</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>..</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-467"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lastCall</span> <span class='hs-varid'>cont_lbl</span> <span class='hs-layout'>(</span><span class='hs-varid'>platformWordSizeInBytes</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span> <span class='hs-varid'>ret_args</span> <span class='hs-varid'>ret_off</span>
<a name="line-468"></a>              <span class='hs-comment'>-- one word of args: the return address</span>
<a name="line-469"></a>
<a name="line-470"></a>      <span class='hs-conid'>CmmBranch</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-varid'>handleBranches</span>
<a name="line-471"></a>      <span class='hs-conid'>CmmCondBranch</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-varid'>handleBranches</span>
<a name="line-472"></a>      <span class='hs-conid'>CmmSwitch</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-varid'>handleBranches</span>
<a name="line-473"></a>  <span class='hs-keyword'>where</span>
<a name="line-474"></a>     <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-475"></a>     <span class='hs-comment'>-- Calls and ForeignCalls are handled the same way:</span>
<a name="line-476"></a>     <span class='hs-varid'>lastCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>
<a name="line-477"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>O</span><span class='hs-keyglyph'>]</span>
<a name="line-478"></a>                 <span class='hs-layout'>,</span> <span class='hs-conid'>ByteOff</span>
<a name="line-479"></a>                 <span class='hs-layout'>,</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>C</span>
<a name="line-480"></a>                 <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmBlock</span><span class='hs-keyglyph'>]</span>
<a name="line-481"></a>                 <span class='hs-layout'>,</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>StackMap</span>
<a name="line-482"></a>                 <span class='hs-layout'>)</span>
<a name="line-483"></a>     <span class='hs-varid'>lastCall</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>cml_args</span> <span class='hs-varid'>cml_ret_args</span> <span class='hs-varid'>cml_ret_off</span>
<a name="line-484"></a>      <span class='hs-keyglyph'>=</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>assignments</span>
<a name="line-485"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>spOffsetForCall</span> <span class='hs-varid'>sp0</span> <span class='hs-varid'>cont_stack</span> <span class='hs-varid'>cml_args</span>
<a name="line-486"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>last</span>
<a name="line-487"></a>         <span class='hs-layout'>,</span> <span class='hs-conid'>[]</span> <span class='hs-comment'>-- no new blocks</span>
<a name="line-488"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>mapSingleton</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>cont_stack</span> <span class='hs-layout'>)</span>
<a name="line-489"></a>      <span class='hs-keyword'>where</span>
<a name="line-490"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>assignments</span><span class='hs-layout'>,</span> <span class='hs-varid'>cont_stack</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prepareStack</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>cml_ret_args</span> <span class='hs-varid'>cml_ret_off</span>
<a name="line-491"></a>
<a name="line-492"></a>
<a name="line-493"></a>     <span class='hs-varid'>prepareStack</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>cml_ret_args</span> <span class='hs-varid'>cml_ret_off</span>
<a name="line-494"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cont_stack</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapLookup</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>stackmaps</span>
<a name="line-495"></a>             <span class='hs-comment'>-- If we have already seen this continuation before, then</span>
<a name="line-496"></a>             <span class='hs-comment'>-- we just have to make the stack look the same:</span>
<a name="line-497"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>fixupStack</span> <span class='hs-varid'>stack0</span> <span class='hs-varid'>cont_stack</span><span class='hs-layout'>,</span> <span class='hs-varid'>cont_stack</span><span class='hs-layout'>)</span>
<a name="line-498"></a>             <span class='hs-comment'>-- Otherwise, we have to allocate the stack frame</span>
<a name="line-499"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-500"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>save_assignments</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_cont_stack</span><span class='hs-layout'>)</span>
<a name="line-501"></a>       <span class='hs-keyword'>where</span>
<a name="line-502"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>new_cont_stack</span><span class='hs-layout'>,</span> <span class='hs-varid'>save_assignments</span><span class='hs-layout'>)</span>
<a name="line-503"></a>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setupStackFrame</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>liveness</span> <span class='hs-varid'>cml_ret_off</span> <span class='hs-varid'>cml_ret_args</span> <span class='hs-varid'>stack0</span>
<a name="line-504"></a>
<a name="line-505"></a>
<a name="line-506"></a>     <span class='hs-comment'>-- For other last nodes (branches), if any of the targets is a</span>
<a name="line-507"></a>     <span class='hs-comment'>-- proc point, we have to set up the stack to match what the proc</span>
<a name="line-508"></a>     <span class='hs-comment'>-- point is expecting.</span>
<a name="line-509"></a>     <span class='hs-comment'>--</span>
<a name="line-510"></a>     <span class='hs-varid'>handleBranches</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>O</span><span class='hs-keyglyph'>]</span>
<a name="line-511"></a>                                <span class='hs-layout'>,</span> <span class='hs-conid'>ByteOff</span>
<a name="line-512"></a>                                <span class='hs-layout'>,</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>C</span>
<a name="line-513"></a>                                <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmBlock</span><span class='hs-keyglyph'>]</span>
<a name="line-514"></a>                                <span class='hs-layout'>,</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>StackMap</span> <span class='hs-layout'>)</span>
<a name="line-515"></a>
<a name="line-516"></a>     <span class='hs-varid'>handleBranches</span>
<a name="line-517"></a>         <span class='hs-comment'>-- Note [diamond proc point]</span>
<a name="line-518"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>futureContinuation</span> <span class='hs-varid'>middle</span>
<a name="line-519"></a>       <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>nub</span> <span class='hs-varop'>$</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>`setMember`</span> <span class='hs-varid'>procpoints</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>successors</span> <span class='hs-varid'>last</span><span class='hs-layout'>)</span> <span class='hs-varop'>==</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>l</span><span class='hs-keyglyph'>]</span>
<a name="line-520"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-521"></a>         <span class='hs-keyword'>let</span> <span class='hs-varid'>cont_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapFindWithDefault</span> <span class='hs-num'>0</span> <span class='hs-varid'>l</span> <span class='hs-varid'>cont_info</span>
<a name="line-522"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>assigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cont_stack</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prepareStack</span> <span class='hs-varid'>l</span> <span class='hs-varid'>cont_args</span> <span class='hs-layout'>(</span><span class='hs-varid'>sm_ret_off</span> <span class='hs-varid'>stack0</span><span class='hs-layout'>)</span>
<a name="line-523"></a>             <span class='hs-varid'>out</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapFromList</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>l'</span><span class='hs-layout'>,</span> <span class='hs-varid'>cont_stack</span><span class='hs-layout'>)</span>
<a name="line-524"></a>                               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>l'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>successors</span> <span class='hs-varid'>last</span> <span class='hs-keyglyph'>]</span>
<a name="line-525"></a>         <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>assigs</span>
<a name="line-526"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>spOffsetForCall</span> <span class='hs-varid'>sp0</span> <span class='hs-varid'>cont_stack</span> <span class='hs-layout'>(</span><span class='hs-varid'>platformWordSizeInBytes</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-527"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>last</span>
<a name="line-528"></a>                <span class='hs-layout'>,</span> <span class='hs-conid'>[]</span>
<a name="line-529"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>out</span><span class='hs-layout'>)</span>
<a name="line-530"></a>
<a name="line-531"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-532"></a>          <span class='hs-varid'>pps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>handleBranch</span> <span class='hs-layout'>(</span><span class='hs-varid'>successors</span> <span class='hs-varid'>last</span><span class='hs-layout'>)</span>
<a name="line-533"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>lbl_map</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>Label</span>
<a name="line-534"></a>              <span class='hs-varid'>lbl_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapFromList</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>tmp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>tmp</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pps</span> <span class='hs-keyglyph'>]</span>
<a name="line-535"></a>              <span class='hs-varid'>fix_lbl</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapFindWithDefault</span> <span class='hs-varid'>l</span> <span class='hs-varid'>l</span> <span class='hs-varid'>lbl_map</span>
<a name="line-536"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-conid'>[]</span>
<a name="line-537"></a>                 <span class='hs-layout'>,</span> <span class='hs-num'>0</span>
<a name="line-538"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>mapSuccessors</span> <span class='hs-varid'>fix_lbl</span> <span class='hs-varid'>last</span>
<a name="line-539"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>concat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>blk</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>blk</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pps</span> <span class='hs-keyglyph'>]</span>
<a name="line-540"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>mapFromList</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-varid'>sm</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>sm</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pps</span> <span class='hs-keyglyph'>]</span> <span class='hs-layout'>)</span>
<a name="line-541"></a>
<a name="line-542"></a>     <span class='hs-comment'>-- For each successor of this block</span>
<a name="line-543"></a>     <span class='hs-varid'>handleBranch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockId</span><span class='hs-layout'>,</span> <span class='hs-conid'>BlockId</span><span class='hs-layout'>,</span> <span class='hs-conid'>StackMap</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmBlock</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-544"></a>     <span class='hs-varid'>handleBranch</span> <span class='hs-varid'>l</span>
<a name="line-545"></a>        <span class='hs-comment'>--   (a) if the successor already has a stackmap, we need to</span>
<a name="line-546"></a>        <span class='hs-comment'>--       shuffle the current stack to make it look the same.</span>
<a name="line-547"></a>        <span class='hs-comment'>--       We have to insert a new block to make this happen.</span>
<a name="line-548"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>stack2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapLookup</span> <span class='hs-varid'>l</span> <span class='hs-varid'>stackmaps</span>
<a name="line-549"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-550"></a>             <span class='hs-keyword'>let</span> <span class='hs-varid'>assigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fixupStack</span> <span class='hs-varid'>stack0</span> <span class='hs-varid'>stack2</span>
<a name="line-551"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>tmp_lbl</span><span class='hs-layout'>,</span> <span class='hs-varid'>block</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>makeFixupBlock</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>sp0</span> <span class='hs-varid'>l</span> <span class='hs-varid'>stack2</span> <span class='hs-varid'>tscp</span> <span class='hs-varid'>assigs</span>
<a name="line-552"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-varid'>tmp_lbl</span><span class='hs-layout'>,</span> <span class='hs-varid'>stack2</span><span class='hs-layout'>,</span> <span class='hs-varid'>block</span><span class='hs-layout'>)</span>
<a name="line-553"></a>
<a name="line-554"></a>        <span class='hs-comment'>--   (b) if the successor is a proc point, save everything</span>
<a name="line-555"></a>        <span class='hs-comment'>--       on the stack.</span>
<a name="line-556"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>l</span> <span class='hs-varop'>`setMember`</span> <span class='hs-varid'>procpoints</span>
<a name="line-557"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-558"></a>             <span class='hs-keyword'>let</span> <span class='hs-varid'>cont_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapFindWithDefault</span> <span class='hs-num'>0</span> <span class='hs-varid'>l</span> <span class='hs-varid'>cont_info</span>
<a name="line-559"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>stack2</span><span class='hs-layout'>,</span> <span class='hs-varid'>assigs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-560"></a>                      <span class='hs-varid'>setupStackFrame</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>l</span> <span class='hs-varid'>liveness</span> <span class='hs-layout'>(</span><span class='hs-varid'>sm_ret_off</span> <span class='hs-varid'>stack0</span><span class='hs-layout'>)</span>
<a name="line-561"></a>                                                        <span class='hs-varid'>cont_args</span> <span class='hs-varid'>stack0</span>
<a name="line-562"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>tmp_lbl</span><span class='hs-layout'>,</span> <span class='hs-varid'>block</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>makeFixupBlock</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>sp0</span> <span class='hs-varid'>l</span> <span class='hs-varid'>stack2</span> <span class='hs-varid'>tscp</span> <span class='hs-varid'>assigs</span>
<a name="line-563"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-varid'>tmp_lbl</span><span class='hs-layout'>,</span> <span class='hs-varid'>stack2</span><span class='hs-layout'>,</span> <span class='hs-varid'>block</span><span class='hs-layout'>)</span>
<a name="line-564"></a>
<a name="line-565"></a>        <span class='hs-comment'>--   (c) otherwise, the current StackMap is the StackMap for</span>
<a name="line-566"></a>        <span class='hs-comment'>--       the continuation.  But we must remember to remove any</span>
<a name="line-567"></a>        <span class='hs-comment'>--       variables from the StackMap that are *not* live at</span>
<a name="line-568"></a>        <span class='hs-comment'>--       the destination, because this StackMap might be used</span>
<a name="line-569"></a>        <span class='hs-comment'>--       by fixupStack if this is a join point.</span>
<a name="line-570"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-varid'>stack1</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-571"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>live</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapFindWithDefault</span> <span class='hs-layout'>(</span><span class='hs-varid'>panic</span> <span class='hs-str'>"handleBranch"</span><span class='hs-layout'>)</span> <span class='hs-varid'>l</span> <span class='hs-varid'>liveness</span>
<a name="line-572"></a>              <span class='hs-varid'>stack1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stack0</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_regs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterUFM</span> <span class='hs-varid'>is_live</span> <span class='hs-layout'>(</span><span class='hs-varid'>sm_regs</span> <span class='hs-varid'>stack0</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-573"></a>              <span class='hs-varid'>is_live</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span> <span class='hs-varop'>`elemRegSet`</span> <span class='hs-varid'>live</span>
<a name="line-574"></a>
<a name="line-575"></a>
<a name="line-576"></a><a name="makeFixupBlock"></a><span class='hs-definition'>makeFixupBlock</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Label</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StackMap</span>
<a name="line-577"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmTickScope</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>O</span><span class='hs-keyglyph'>]</span>
<a name="line-578"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Label</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmBlock</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-579"></a><span class='hs-definition'>makeFixupBlock</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>sp0</span> <span class='hs-varid'>l</span> <span class='hs-varid'>stack</span> <span class='hs-varid'>tscope</span> <span class='hs-varid'>assigs</span>
<a name="line-580"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>assigs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>sp0</span> <span class='hs-varop'>==</span> <span class='hs-varid'>sm_sp</span> <span class='hs-varid'>stack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-581"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-582"></a>    <span class='hs-varid'>tmp_lbl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newBlockId</span>
<a name="line-583"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>sp_off</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sp0</span> <span class='hs-comment'>-</span> <span class='hs-varid'>sm_sp</span> <span class='hs-varid'>stack</span>
<a name="line-584"></a>        <span class='hs-varid'>block</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>blockJoin</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmEntry</span> <span class='hs-varid'>tmp_lbl</span> <span class='hs-varid'>tscope</span><span class='hs-layout'>)</span>
<a name="line-585"></a>                          <span class='hs-layout'>(</span> <span class='hs-varid'>maybeAddSpAdj</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>sp0</span> <span class='hs-varid'>sp_off</span>
<a name="line-586"></a>                           <span class='hs-varop'>$</span> <span class='hs-varid'>blockFromList</span> <span class='hs-varid'>assigs</span> <span class='hs-layout'>)</span>
<a name="line-587"></a>                          <span class='hs-layout'>(</span><span class='hs-conid'>CmmBranch</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-588"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tmp_lbl</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>block</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-589"></a>
<a name="line-590"></a>
<a name="line-591"></a><a name="spOffsetForCall"></a><span class='hs-comment'>-- Sp is currently pointing to current_sp,</span>
<a name="line-592"></a><span class='hs-comment'>-- we want it to point to</span>
<a name="line-593"></a><span class='hs-comment'>--    (sm_sp cont_stack - sm_args cont_stack + args)</span>
<a name="line-594"></a><span class='hs-comment'>-- so the difference is</span>
<a name="line-595"></a><span class='hs-comment'>--    sp0 - (sm_sp cont_stack - sm_args cont_stack + args)</span>
<a name="line-596"></a><span class='hs-definition'>spOffsetForCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StackMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>
<a name="line-597"></a><span class='hs-definition'>spOffsetForCall</span> <span class='hs-varid'>current_sp</span> <span class='hs-varid'>cont_stack</span> <span class='hs-varid'>args</span>
<a name="line-598"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>current_sp</span> <span class='hs-comment'>-</span> <span class='hs-layout'>(</span><span class='hs-varid'>sm_sp</span> <span class='hs-varid'>cont_stack</span> <span class='hs-comment'>-</span> <span class='hs-varid'>sm_args</span> <span class='hs-varid'>cont_stack</span> <span class='hs-varop'>+</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-599"></a>
<a name="line-600"></a>
<a name="line-601"></a><a name="fixupStack"></a><span class='hs-comment'>-- | create a sequence of assignments to establish the new StackMap,</span>
<a name="line-602"></a><span class='hs-comment'>-- given the old StackMap.</span>
<a name="line-603"></a><span class='hs-definition'>fixupStack</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StackMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StackMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>O</span><span class='hs-keyglyph'>]</span>
<a name="line-604"></a><span class='hs-definition'>fixupStack</span> <span class='hs-varid'>old_stack</span> <span class='hs-varid'>new_stack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>move</span> <span class='hs-varid'>new_locs</span>
<a name="line-605"></a> <span class='hs-keyword'>where</span>
<a name="line-606"></a>     <span class='hs-varid'>old_map</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sm_regs</span> <span class='hs-varid'>old_stack</span>
<a name="line-607"></a>     <span class='hs-varid'>new_locs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stackSlotRegs</span> <span class='hs-varid'>new_stack</span>
<a name="line-608"></a>
<a name="line-609"></a>     <span class='hs-varid'>move</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-610"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-varid'>old_map</span> <span class='hs-varid'>r</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-611"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmStore</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmStackSlot</span> <span class='hs-conid'>Old</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-612"></a>                               <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-613"></a>                               <span class='hs-conid'>NaturallyAligned</span><span class='hs-keyglyph'>]</span>
<a name="line-614"></a>
<a name="line-615"></a>
<a name="line-616"></a>
<a name="line-617"></a><a name="setupStackFrame"></a><span class='hs-definition'>setupStackFrame</span>
<a name="line-618"></a>             <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span>
<a name="line-619"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockId</span>                 <span class='hs-comment'>-- label of continuation</span>
<a name="line-620"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>CmmLocalLive</span>   <span class='hs-comment'>-- liveness</span>
<a name="line-621"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>      <span class='hs-comment'>-- updfr</span>
<a name="line-622"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>      <span class='hs-comment'>-- bytes of return values on stack</span>
<a name="line-623"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StackMap</span>     <span class='hs-comment'>-- current StackMap</span>
<a name="line-624"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>StackMap</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>O</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-625"></a>
<a name="line-626"></a><span class='hs-definition'>setupStackFrame</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>liveness</span> <span class='hs-varid'>updfr_off</span> <span class='hs-varid'>ret_args</span> <span class='hs-varid'>stack0</span>
<a name="line-627"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>cont_stack</span><span class='hs-layout'>,</span> <span class='hs-varid'>assignments</span><span class='hs-layout'>)</span>
<a name="line-628"></a>  <span class='hs-keyword'>where</span>
<a name="line-629"></a>      <span class='hs-comment'>-- get the set of LocalRegs live in the continuation</span>
<a name="line-630"></a>      <span class='hs-varid'>live</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapFindWithDefault</span> <span class='hs-conid'>Set.empty</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>liveness</span>
<a name="line-631"></a>
<a name="line-632"></a>      <span class='hs-comment'>-- the stack from the base to updfr_off is off-limits.</span>
<a name="line-633"></a>      <span class='hs-comment'>-- our new stack frame contains:</span>
<a name="line-634"></a>      <span class='hs-comment'>--   * saved live variables</span>
<a name="line-635"></a>      <span class='hs-comment'>--   * the return address [young(C) + 8]</span>
<a name="line-636"></a>      <span class='hs-comment'>--   * the args for the call,</span>
<a name="line-637"></a>      <span class='hs-comment'>--     which are replaced by the return values at the return</span>
<a name="line-638"></a>      <span class='hs-comment'>--     point.</span>
<a name="line-639"></a>
<a name="line-640"></a>      <span class='hs-comment'>-- everything up to updfr_off is off-limits</span>
<a name="line-641"></a>      <span class='hs-comment'>-- stack1 contains updfr_off, plus everything we need to save</span>
<a name="line-642"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>stack1</span><span class='hs-layout'>,</span> <span class='hs-varid'>assignments</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>allocate</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>updfr_off</span> <span class='hs-varid'>live</span> <span class='hs-varid'>stack0</span>
<a name="line-643"></a>
<a name="line-644"></a>      <span class='hs-comment'>-- And the Sp at the continuation is:</span>
<a name="line-645"></a>      <span class='hs-comment'>--   sm_sp stack1 + ret_args</span>
<a name="line-646"></a>      <span class='hs-varid'>cont_stack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stack1</span><span class='hs-layout'>{</span> <span class='hs-varid'>sm_sp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sm_sp</span> <span class='hs-varid'>stack1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>ret_args</span>
<a name="line-647"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>sm_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ret_args</span>
<a name="line-648"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>sm_ret_off</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updfr_off</span>
<a name="line-649"></a>                         <span class='hs-layout'>}</span>
<a name="line-650"></a>
<a name="line-651"></a>
<a name="line-652"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-653"></a><span class='hs-comment'>-- Note [diamond proc point]</span>
<a name="line-654"></a><span class='hs-comment'>--</span>
<a name="line-655"></a><span class='hs-comment'>-- This special case looks for the pattern we get from a typical</span>
<a name="line-656"></a><span class='hs-comment'>-- tagged case expression:</span>
<a name="line-657"></a><span class='hs-comment'>--</span>
<a name="line-658"></a><span class='hs-comment'>--    Sp[young(L1)] = L1</span>
<a name="line-659"></a><span class='hs-comment'>--    if (R1 &amp; 7) != 0 goto L1 else goto L2</span>
<a name="line-660"></a><span class='hs-comment'>--  L2:</span>
<a name="line-661"></a><span class='hs-comment'>--    call [R1] returns to L1</span>
<a name="line-662"></a><span class='hs-comment'>--  L1: live: {y}</span>
<a name="line-663"></a><span class='hs-comment'>--    x = R1</span>
<a name="line-664"></a><span class='hs-comment'>--</span>
<a name="line-665"></a><span class='hs-comment'>-- If we let the generic case handle this, we get</span>
<a name="line-666"></a><span class='hs-comment'>--</span>
<a name="line-667"></a><span class='hs-comment'>--    Sp[-16] = L1</span>
<a name="line-668"></a><span class='hs-comment'>--    if (R1 &amp; 7) != 0 goto L1a else goto L2</span>
<a name="line-669"></a><span class='hs-comment'>--  L2:</span>
<a name="line-670"></a><span class='hs-comment'>--    Sp[-8] = y</span>
<a name="line-671"></a><span class='hs-comment'>--    Sp = Sp - 16</span>
<a name="line-672"></a><span class='hs-comment'>--    call [R1] returns to L1</span>
<a name="line-673"></a><span class='hs-comment'>--  L1a:</span>
<a name="line-674"></a><span class='hs-comment'>--    Sp[-8] = y</span>
<a name="line-675"></a><span class='hs-comment'>--    Sp = Sp - 16</span>
<a name="line-676"></a><span class='hs-comment'>--    goto L1</span>
<a name="line-677"></a><span class='hs-comment'>--  L1:</span>
<a name="line-678"></a><span class='hs-comment'>--    x = R1</span>
<a name="line-679"></a><span class='hs-comment'>--</span>
<a name="line-680"></a><span class='hs-comment'>-- The code for saving the live vars is duplicated in each branch, and</span>
<a name="line-681"></a><span class='hs-comment'>-- furthermore there is an extra jump in the fast path (assuming L1 is</span>
<a name="line-682"></a><span class='hs-comment'>-- a proc point, which it probably is if there is a heap check).</span>
<a name="line-683"></a><span class='hs-comment'>--</span>
<a name="line-684"></a><span class='hs-comment'>-- So to fix this we want to set up the stack frame before the</span>
<a name="line-685"></a><span class='hs-comment'>-- conditional jump.  How do we know when to do this, and when it is</span>
<a name="line-686"></a><span class='hs-comment'>-- safe?  The basic idea is, when we see the assignment</span>
<a name="line-687"></a><span class='hs-comment'>--</span>
<a name="line-688"></a><span class='hs-comment'>--   Sp[young(L)] = L</span>
<a name="line-689"></a><span class='hs-comment'>--</span>
<a name="line-690"></a><span class='hs-comment'>-- we know that</span>
<a name="line-691"></a><span class='hs-comment'>--   * we are definitely heading for L</span>
<a name="line-692"></a><span class='hs-comment'>--   * there can be no more reads from another stack area, because young(L)</span>
<a name="line-693"></a><span class='hs-comment'>--     overlaps with it.</span>
<a name="line-694"></a><span class='hs-comment'>--</span>
<a name="line-695"></a><span class='hs-comment'>-- We don't necessarily know that everything live at L is live now</span>
<a name="line-696"></a><span class='hs-comment'>-- (some might be assigned between here and the jump to L).  So we</span>
<a name="line-697"></a><span class='hs-comment'>-- simplify and only do the optimisation when we see</span>
<a name="line-698"></a><span class='hs-comment'>--</span>
<a name="line-699"></a><span class='hs-comment'>--   (1) a block containing an assignment of a return address L</span>
<a name="line-700"></a><span class='hs-comment'>--   (2) ending in a branch where one (and only) continuation goes to L,</span>
<a name="line-701"></a><span class='hs-comment'>--       and no other continuations go to proc points.</span>
<a name="line-702"></a><span class='hs-comment'>--</span>
<a name="line-703"></a><span class='hs-comment'>-- then we allocate the stack frame for L at the end of the block,</span>
<a name="line-704"></a><span class='hs-comment'>-- before the branch.</span>
<a name="line-705"></a><span class='hs-comment'>--</span>
<a name="line-706"></a><span class='hs-comment'>-- We could generalise (2), but that would make it a bit more</span>
<a name="line-707"></a><span class='hs-comment'>-- complicated to handle, and this currently catches the common case.</span>
<a name="line-708"></a>
<a name="line-709"></a><a name="futureContinuation"></a><span class='hs-definition'>futureContinuation</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Block</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>O</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>BlockId</span>
<a name="line-710"></a><span class='hs-definition'>futureContinuation</span> <span class='hs-varid'>middle</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldBlockNodesB</span> <span class='hs-varid'>f</span> <span class='hs-varid'>middle</span> <span class='hs-conid'>Nothing</span>
<a name="line-711"></a>   <span class='hs-keyword'>where</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmNode</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>BlockId</span>
<a name="line-712"></a>         <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmStore</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmStackSlot</span> <span class='hs-layout'>(</span><span class='hs-conid'>Young</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmBlock</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>
<a name="line-713"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>l</span>
<a name="line-714"></a>         <span class='hs-varid'>f</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-715"></a>
<a name="line-716"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-717"></a><span class='hs-comment'>-- Saving live registers</span>
<a name="line-718"></a>
<a name="line-719"></a><a name="allocate"></a><span class='hs-comment'>-- | Given a set of live registers and a StackMap, save all the registers</span>
<a name="line-720"></a><span class='hs-comment'>-- on the stack and return the new StackMap and the assignments to do</span>
<a name="line-721"></a><span class='hs-comment'>-- the saving.</span>
<a name="line-722"></a><span class='hs-comment'>--</span>
<a name="line-723"></a><span class='hs-definition'>allocate</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LocalRegSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StackMap</span>
<a name="line-724"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>StackMap</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>O</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-725"></a><span class='hs-definition'>allocate</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>ret_off</span> <span class='hs-varid'>live</span> <span class='hs-varid'>stackmap</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>StackMap</span><span class='hs-layout'>{</span> <span class='hs-varid'>sm_sp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sp0</span>
<a name="line-726"></a>                                              <span class='hs-layout'>,</span> <span class='hs-varid'>sm_regs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>regs0</span> <span class='hs-layout'>}</span>
<a name="line-727"></a> <span class='hs-keyglyph'>=</span>
<a name="line-728"></a>   <span class='hs-comment'>-- we only have to save regs that are not already in a slot</span>
<a name="line-729"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>to_save</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemUFM`</span> <span class='hs-varid'>regs0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Set.elems</span> <span class='hs-varid'>live</span><span class='hs-layout'>)</span>
<a name="line-730"></a>       <span class='hs-varid'>regs1</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterUFM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>elemRegSet</span> <span class='hs-varid'>r</span> <span class='hs-varid'>live</span><span class='hs-layout'>)</span> <span class='hs-varid'>regs0</span>
<a name="line-731"></a>   <span class='hs-keyword'>in</span>
<a name="line-732"></a>
<a name="line-733"></a>   <span class='hs-comment'>-- make a map of the stack</span>
<a name="line-734"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>stack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverse</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Array.elems</span> <span class='hs-varop'>$</span>
<a name="line-735"></a>               <span class='hs-varid'>accumArray</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-conid'>Empty</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-varid'>toWords</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-varid'>max</span> <span class='hs-varid'>sp0</span> <span class='hs-varid'>ret_off</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-736"></a>                 <span class='hs-varid'>ret_words</span> <span class='hs-varop'>++</span> <span class='hs-varid'>live_words</span>
<a name="line-737"></a>            <span class='hs-keyword'>where</span> <span class='hs-varid'>ret_words</span> <span class='hs-keyglyph'>=</span>
<a name="line-738"></a>                   <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-conid'>Occupied</span><span class='hs-layout'>)</span>
<a name="line-739"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span> <span class='hs-num'>1</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>toWords</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>ret_off</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-740"></a>                  <span class='hs-varid'>live_words</span> <span class='hs-keyglyph'>=</span>
<a name="line-741"></a>                   <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>toWords</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-conid'>Occupied</span><span class='hs-layout'>)</span>
<a name="line-742"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span><span class='hs-varid'>off</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nonDetEltsUFM</span> <span class='hs-varid'>regs1</span><span class='hs-layout'>,</span>
<a name="line-743"></a>                   <span class='hs-comment'>-- See Note [Unique Determinism and code generation]</span>
<a name="line-744"></a>                     <span class='hs-keyword'>let</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>localRegBytes</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>r</span><span class='hs-layout'>,</span>
<a name="line-745"></a>                     <span class='hs-varid'>x</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>off</span><span class='hs-layout'>,</span> <span class='hs-varid'>off</span> <span class='hs-comment'>-</span> <span class='hs-varid'>platformWordSizeInBytes</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>off</span> <span class='hs-comment'>-</span> <span class='hs-varid'>w</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-746"></a>   <span class='hs-keyword'>in</span>
<a name="line-747"></a>
<a name="line-748"></a>   <span class='hs-comment'>-- Pass over the stack: find slots to save all the new live variables,</span>
<a name="line-749"></a>   <span class='hs-comment'>-- choosing the oldest slots first (hence a foldr).</span>
<a name="line-750"></a>   <span class='hs-keyword'>let</span>
<a name="line-751"></a>       <span class='hs-varid'>save</span> <span class='hs-varid'>slot</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>stack</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>assigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>regs</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- no more regs to save</span>
<a name="line-752"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>slot</span><span class='hs-conop'>:</span><span class='hs-varid'>stack</span><span class='hs-layout'>,</span> <span class='hs-varid'>plusW</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>n</span> <span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-varid'>assigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>regs</span><span class='hs-layout'>)</span>
<a name="line-753"></a>       <span class='hs-varid'>save</span> <span class='hs-varid'>slot</span> <span class='hs-layout'>(</span><span class='hs-varid'>to_save</span><span class='hs-layout'>,</span> <span class='hs-varid'>stack</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>assigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>regs</span><span class='hs-layout'>)</span>
<a name="line-754"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>slot</span> <span class='hs-keyword'>of</span>
<a name="line-755"></a>               <span class='hs-conid'>Occupied</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-layout'>(</span><span class='hs-varid'>to_save</span><span class='hs-layout'>,</span> <span class='hs-conid'>Occupied</span><span class='hs-conop'>:</span><span class='hs-varid'>stack</span><span class='hs-layout'>,</span> <span class='hs-varid'>plusW</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>n</span> <span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-varid'>assigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>regs</span><span class='hs-layout'>)</span>
<a name="line-756"></a>               <span class='hs-conid'>Empty</span>
<a name="line-757"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>stack'</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>,</span> <span class='hs-varid'>to_save'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-758"></a>                       <span class='hs-varid'>select_save</span> <span class='hs-varid'>to_save</span> <span class='hs-layout'>(</span><span class='hs-varid'>slot</span><span class='hs-conop'>:</span><span class='hs-varid'>stack</span><span class='hs-layout'>)</span>
<a name="line-759"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>assig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmStore</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmStackSlot</span> <span class='hs-conid'>Old</span> <span class='hs-varid'>n'</span><span class='hs-layout'>)</span>
<a name="line-760"></a>                                         <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-761"></a>                                         <span class='hs-conid'>NaturallyAligned</span>
<a name="line-762"></a>                        <span class='hs-varid'>n'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusW</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>n</span> <span class='hs-num'>1</span>
<a name="line-763"></a>                   <span class='hs-keyword'>in</span>
<a name="line-764"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>to_save'</span><span class='hs-layout'>,</span> <span class='hs-varid'>stack'</span><span class='hs-layout'>,</span> <span class='hs-varid'>n'</span><span class='hs-layout'>,</span> <span class='hs-varid'>assig</span> <span class='hs-conop'>:</span> <span class='hs-varid'>assigs</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span><span class='hs-varid'>n'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>regs</span><span class='hs-layout'>)</span>
<a name="line-765"></a>
<a name="line-766"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-767"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>to_save</span><span class='hs-layout'>,</span> <span class='hs-varid'>slot</span><span class='hs-conop'>:</span><span class='hs-varid'>stack</span><span class='hs-layout'>,</span> <span class='hs-varid'>plusW</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>n</span> <span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-varid'>assigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>regs</span><span class='hs-layout'>)</span>
<a name="line-768"></a>
<a name="line-769"></a>       <span class='hs-comment'>-- we should do better here: right now we'll fit the smallest first,</span>
<a name="line-770"></a>       <span class='hs-comment'>-- but it would make more sense to fit the biggest first.</span>
<a name="line-771"></a>       <span class='hs-varid'>select_save</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LocalReg</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StackSlot</span><span class='hs-keyglyph'>]</span>
<a name="line-772"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>StackSlot</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>LocalReg</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LocalReg</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-773"></a>       <span class='hs-varid'>select_save</span> <span class='hs-varid'>regs</span> <span class='hs-varid'>stack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>regs</span> <span class='hs-conid'>[]</span>
<a name="line-774"></a>         <span class='hs-keyword'>where</span> <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span>     <span class='hs-sel'>_no_fit</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-775"></a>               <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-conop'>:</span><span class='hs-varid'>rs</span><span class='hs-layout'>)</span> <span class='hs-varid'>no_fit</span>
<a name="line-776"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>rest</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dropEmpty</span> <span class='hs-varid'>words</span> <span class='hs-varid'>stack</span>
<a name="line-777"></a>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>replicate</span> <span class='hs-varid'>words</span> <span class='hs-conid'>Occupied</span> <span class='hs-varop'>++</span> <span class='hs-varid'>rest</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>,</span> <span class='hs-varid'>rs</span><span class='hs-varop'>++</span><span class='hs-varid'>no_fit</span><span class='hs-layout'>)</span>
<a name="line-778"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-779"></a>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rs</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-conop'>:</span><span class='hs-varid'>no_fit</span><span class='hs-layout'>)</span>
<a name="line-780"></a>                 <span class='hs-keyword'>where</span> <span class='hs-varid'>words</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>localRegWords</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>r</span>
<a name="line-781"></a>
<a name="line-782"></a>       <span class='hs-comment'>-- fill in empty slots as much as possible</span>
<a name="line-783"></a>       <span class='hs-layout'>(</span><span class='hs-varid'>still_to_save</span><span class='hs-layout'>,</span> <span class='hs-varid'>save_stack</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>save_assigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>save_regs</span><span class='hs-layout'>)</span>
<a name="line-784"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>save</span> <span class='hs-layout'>(</span><span class='hs-varid'>to_save</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>stack</span>
<a name="line-785"></a>
<a name="line-786"></a>       <span class='hs-comment'>-- push any remaining live vars on the stack</span>
<a name="line-787"></a>       <span class='hs-layout'>(</span><span class='hs-varid'>push_sp</span><span class='hs-layout'>,</span> <span class='hs-varid'>push_assigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>push_regs</span><span class='hs-layout'>)</span>
<a name="line-788"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>push</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>still_to_save</span>
<a name="line-789"></a>          <span class='hs-keyword'>where</span>
<a name="line-790"></a>              <span class='hs-varid'>push</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>assigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>regs</span><span class='hs-layout'>)</span>
<a name="line-791"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>n'</span><span class='hs-layout'>,</span> <span class='hs-varid'>assig</span> <span class='hs-conop'>:</span> <span class='hs-varid'>assigs</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span><span class='hs-varid'>n'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>regs</span><span class='hs-layout'>)</span>
<a name="line-792"></a>                <span class='hs-keyword'>where</span>
<a name="line-793"></a>                  <span class='hs-varid'>n'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-varop'>+</span> <span class='hs-varid'>localRegBytes</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>r</span>
<a name="line-794"></a>                  <span class='hs-varid'>assig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmStore</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmStackSlot</span> <span class='hs-conid'>Old</span> <span class='hs-varid'>n'</span><span class='hs-layout'>)</span>
<a name="line-795"></a>                                   <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-796"></a>                                   <span class='hs-conid'>NaturallyAligned</span>
<a name="line-797"></a>
<a name="line-798"></a>       <span class='hs-varid'>trim_sp</span>
<a name="line-799"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>push_regs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>push_sp</span>
<a name="line-800"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-801"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusW</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span> <span class='hs-varid'>length</span> <span class='hs-layout'>(</span><span class='hs-varid'>takeWhile</span> <span class='hs-varid'>isEmpty</span> <span class='hs-varid'>save_stack</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-802"></a>
<a name="line-803"></a>       <span class='hs-varid'>final_regs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>regs1</span> <span class='hs-varop'>`addListToUFM`</span> <span class='hs-varid'>push_regs</span>
<a name="line-804"></a>                          <span class='hs-varop'>`addListToUFM`</span> <span class='hs-varid'>save_regs</span>
<a name="line-805"></a>
<a name="line-806"></a>   <span class='hs-keyword'>in</span>
<a name="line-807"></a>  <span class='hs-comment'>-- XXX should be an assert</span>
<a name="line-808"></a>   <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span> <span class='hs-varid'>n</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>max</span> <span class='hs-varid'>sp0</span> <span class='hs-varid'>ret_off</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"allocate"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sp0</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ret_off</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span>
<a name="line-809"></a>
<a name="line-810"></a>   <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>trim_sp</span> <span class='hs-varop'>.&amp;.</span> <span class='hs-layout'>(</span><span class='hs-varid'>platformWordSizeInBytes</span> <span class='hs-varid'>platform</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>/=</span> <span class='hs-num'>0</span>  <span class='hs-keyword'>then</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"allocate2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>trim_sp</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>final_regs</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>push_sp</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span>
<a name="line-811"></a>
<a name="line-812"></a>   <span class='hs-layout'>(</span> <span class='hs-varid'>stackmap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_regs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>final_regs</span> <span class='hs-layout'>,</span> <span class='hs-varid'>sm_sp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>trim_sp</span> <span class='hs-layout'>}</span>
<a name="line-813"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>push_assigs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>save_assigs</span> <span class='hs-layout'>)</span>
<a name="line-814"></a>
<a name="line-815"></a>
<a name="line-816"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-817"></a><span class='hs-comment'>-- Manifesting Sp</span>
<a name="line-818"></a>
<a name="line-819"></a><a name="manifestSp"></a><span class='hs-comment'>-- | Manifest Sp: turn all the CmmStackSlots into CmmLoads from Sp.  The</span>
<a name="line-820"></a><span class='hs-comment'>-- block looks like this:</span>
<a name="line-821"></a><span class='hs-comment'>--</span>
<a name="line-822"></a><span class='hs-comment'>--    middle_pre       -- the middle nodes</span>
<a name="line-823"></a><span class='hs-comment'>--    Sp = Sp + sp_off -- Sp adjustment goes here</span>
<a name="line-824"></a><span class='hs-comment'>--    last             -- the last node</span>
<a name="line-825"></a><span class='hs-comment'>--</span>
<a name="line-826"></a><span class='hs-comment'>-- And we have some extra blocks too (that don't contain Sp adjustments)</span>
<a name="line-827"></a><span class='hs-comment'>--</span>
<a name="line-828"></a><span class='hs-comment'>-- The adjustment for middle_pre will be different from that for</span>
<a name="line-829"></a><span class='hs-comment'>-- middle_post, because the Sp adjustment intervenes.</span>
<a name="line-830"></a><span class='hs-comment'>--</span>
<a name="line-831"></a><span class='hs-definition'>manifestSp</span>
<a name="line-832"></a>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-833"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>StackMap</span>  <span class='hs-comment'>-- StackMaps for other blocks</span>
<a name="line-834"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StackMap</span>           <span class='hs-comment'>-- StackMap for this block</span>
<a name="line-835"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>            <span class='hs-comment'>-- Sp on entry to the block</span>
<a name="line-836"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>            <span class='hs-comment'>-- SpHigh</span>
<a name="line-837"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>C</span> <span class='hs-conid'>O</span>        <span class='hs-comment'>-- first node</span>
<a name="line-838"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>O</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- middle</span>
<a name="line-839"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>            <span class='hs-comment'>-- sp_off</span>
<a name="line-840"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>C</span>        <span class='hs-comment'>-- last node</span>
<a name="line-841"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmBlock</span><span class='hs-keyglyph'>]</span>         <span class='hs-comment'>-- new blocks</span>
<a name="line-842"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmBlock</span><span class='hs-keyglyph'>]</span>         <span class='hs-comment'>-- final blocks with Sp manifest</span>
<a name="line-843"></a>
<a name="line-844"></a><span class='hs-definition'>manifestSp</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>stackmaps</span> <span class='hs-varid'>stack0</span> <span class='hs-varid'>sp0</span> <span class='hs-varid'>sp_high</span>
<a name="line-845"></a>           <span class='hs-varid'>first</span> <span class='hs-varid'>middle_pre</span> <span class='hs-varid'>sp_off</span> <span class='hs-varid'>last</span> <span class='hs-varid'>fixup_blocks</span>
<a name="line-846"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>final_block</span> <span class='hs-conop'>:</span> <span class='hs-varid'>fixup_blocks'</span>
<a name="line-847"></a>  <span class='hs-keyword'>where</span>
<a name="line-848"></a>    <span class='hs-varid'>area_off</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getAreaOff</span> <span class='hs-varid'>stackmaps</span>
<a name="line-849"></a>    <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-850"></a>
<a name="line-851"></a>    <span class='hs-varid'>adj_pre_sp</span><span class='hs-layout'>,</span> <span class='hs-varid'>adj_post_sp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmNode</span> <span class='hs-varid'>e</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmNode</span> <span class='hs-varid'>e</span> <span class='hs-varid'>x</span>
<a name="line-852"></a>    <span class='hs-varid'>adj_pre_sp</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapExpDeep</span> <span class='hs-layout'>(</span><span class='hs-varid'>areaToSp</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>sp0</span>            <span class='hs-varid'>sp_high</span> <span class='hs-varid'>area_off</span><span class='hs-layout'>)</span>
<a name="line-853"></a>    <span class='hs-varid'>adj_post_sp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapExpDeep</span> <span class='hs-layout'>(</span><span class='hs-varid'>areaToSp</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-varid'>sp0</span> <span class='hs-comment'>-</span> <span class='hs-varid'>sp_off</span><span class='hs-layout'>)</span> <span class='hs-varid'>sp_high</span> <span class='hs-varid'>area_off</span><span class='hs-layout'>)</span>
<a name="line-854"></a>
<a name="line-855"></a>    <span class='hs-varid'>final_middle</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeAddSpAdj</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>sp0</span> <span class='hs-varid'>sp_off</span>
<a name="line-856"></a>                 <span class='hs-varop'>.</span> <span class='hs-varid'>blockFromList</span>
<a name="line-857"></a>                 <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-varid'>adj_pre_sp</span>
<a name="line-858"></a>                 <span class='hs-varop'>.</span> <span class='hs-varid'>elimStackStores</span> <span class='hs-varid'>stack0</span> <span class='hs-varid'>stackmaps</span> <span class='hs-varid'>area_off</span>
<a name="line-859"></a>                 <span class='hs-varop'>$</span> <span class='hs-varid'>middle_pre</span>
<a name="line-860"></a>    <span class='hs-varid'>final_last</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>optStackCheck</span> <span class='hs-layout'>(</span><span class='hs-varid'>adj_post_sp</span> <span class='hs-varid'>last</span><span class='hs-layout'>)</span>
<a name="line-861"></a>
<a name="line-862"></a>    <span class='hs-varid'>final_block</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>blockJoin</span> <span class='hs-varid'>first</span> <span class='hs-varid'>final_middle</span> <span class='hs-varid'>final_last</span>
<a name="line-863"></a>
<a name="line-864"></a>    <span class='hs-varid'>fixup_blocks'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapBlock3'</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>adj_post_sp</span><span class='hs-layout'>,</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fixup_blocks</span>
<a name="line-865"></a>
<a name="line-866"></a><a name="getAreaOff"></a><span class='hs-definition'>getAreaOff</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>StackMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Area</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StackLoc</span><span class='hs-layout'>)</span>
<a name="line-867"></a><span class='hs-definition'>getAreaOff</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Old</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-868"></a><span class='hs-definition'>getAreaOff</span> <span class='hs-varid'>stackmaps</span> <span class='hs-layout'>(</span><span class='hs-conid'>Young</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-869"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>mapLookup</span> <span class='hs-varid'>l</span> <span class='hs-varid'>stackmaps</span> <span class='hs-keyword'>of</span>
<a name="line-870"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>sm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sm_sp</span> <span class='hs-varid'>sm</span> <span class='hs-comment'>-</span> <span class='hs-varid'>sm_args</span> <span class='hs-varid'>sm</span>
<a name="line-871"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"getAreaOff"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-872"></a>
<a name="line-873"></a>
<a name="line-874"></a><a name="maybeAddSpAdj"></a><span class='hs-definition'>maybeAddSpAdj</span>
<a name="line-875"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Block</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>O</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Block</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>O</span>
<a name="line-876"></a><span class='hs-definition'>maybeAddSpAdj</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>sp0</span> <span class='hs-varid'>sp_off</span> <span class='hs-varid'>block</span> <span class='hs-keyglyph'>=</span>
<a name="line-877"></a>  <span class='hs-varid'>add_initial_unwind</span> <span class='hs-varop'>$</span> <span class='hs-varid'>add_adj_unwind</span> <span class='hs-varop'>$</span> <span class='hs-varid'>adj</span> <span class='hs-varid'>block</span>
<a name="line-878"></a>  <span class='hs-keyword'>where</span>
<a name="line-879"></a>    <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-880"></a>    <span class='hs-varid'>adj</span> <span class='hs-varid'>block</span>
<a name="line-881"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>sp_off</span> <span class='hs-varop'>/=</span> <span class='hs-num'>0</span>
<a name="line-882"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>block</span> <span class='hs-varop'>`blockSnoc`</span> <span class='hs-conid'>CmmAssign</span> <span class='hs-varid'>spReg</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmOffset</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>spExpr</span> <span class='hs-varid'>sp_off</span><span class='hs-layout'>)</span>
<a name="line-883"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>block</span>
<a name="line-884"></a>    <span class='hs-comment'>-- Add unwind pseudo-instruction at the beginning of each block to</span>
<a name="line-885"></a>    <span class='hs-comment'>-- document Sp level for debugging</span>
<a name="line-886"></a>    <span class='hs-varid'>add_initial_unwind</span> <span class='hs-varid'>block</span>
<a name="line-887"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>debugLevel</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>
<a name="line-888"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmUnwind</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Sp</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>sp_unwind</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>`blockCons`</span> <span class='hs-varid'>block</span>
<a name="line-889"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-890"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>block</span>
<a name="line-891"></a>      <span class='hs-keyword'>where</span> <span class='hs-varid'>sp_unwind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmRegOff</span> <span class='hs-varid'>spReg</span> <span class='hs-layout'>(</span><span class='hs-varid'>sp0</span> <span class='hs-comment'>-</span> <span class='hs-varid'>platformWordSizeInBytes</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-892"></a>
<a name="line-893"></a>    <span class='hs-comment'>-- Add unwind pseudo-instruction right after the Sp adjustment</span>
<a name="line-894"></a>    <span class='hs-comment'>-- if there is one.</span>
<a name="line-895"></a>    <span class='hs-varid'>add_adj_unwind</span> <span class='hs-varid'>block</span>
<a name="line-896"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>debugLevel</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>
<a name="line-897"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>sp_off</span> <span class='hs-varop'>/=</span> <span class='hs-num'>0</span>
<a name="line-898"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>block</span> <span class='hs-varop'>`blockSnoc`</span> <span class='hs-conid'>CmmUnwind</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Sp</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>sp_unwind</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-899"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-900"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>block</span>
<a name="line-901"></a>      <span class='hs-keyword'>where</span> <span class='hs-varid'>sp_unwind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmRegOff</span> <span class='hs-varid'>spReg</span> <span class='hs-layout'>(</span><span class='hs-varid'>sp0</span> <span class='hs-comment'>-</span> <span class='hs-varid'>platformWordSizeInBytes</span> <span class='hs-varid'>platform</span> <span class='hs-comment'>-</span> <span class='hs-varid'>sp_off</span><span class='hs-layout'>)</span>
<a name="line-902"></a>
<a name="line-903"></a><span class='hs-comment'>{- Note [SP old/young offsets]
<a name="line-904"></a>
<a name="line-905"></a>Sp(L) is the Sp offset on entry to block L relative to the base of the
<a name="line-906"></a>OLD area.
<a name="line-907"></a>
<a name="line-908"></a>SpArgs(L) is the size of the young area for L, i.e. the number of
<a name="line-909"></a>arguments.
<a name="line-910"></a>
<a name="line-911"></a> - in block L, each reference to [old + N] turns into
<a name="line-912"></a>   [Sp + Sp(L) - N]
<a name="line-913"></a>
<a name="line-914"></a> - in block L, each reference to [young(L') + N] turns into
<a name="line-915"></a>   [Sp + Sp(L) - Sp(L') + SpArgs(L') - N]
<a name="line-916"></a>
<a name="line-917"></a> - be careful with the last node of each block: Sp has already been adjusted
<a name="line-918"></a>   to be Sp + Sp(L) - Sp(L')
<a name="line-919"></a>-}</span>
<a name="line-920"></a>
<a name="line-921"></a><a name="areaToSp"></a><span class='hs-definition'>areaToSp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Area</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StackLoc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span>
<a name="line-922"></a>
<a name="line-923"></a><span class='hs-definition'>areaToSp</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>sp_old</span> <span class='hs-sel'>_sp_hwm</span> <span class='hs-varid'>area_off</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmStackSlot</span> <span class='hs-varid'>area</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-924"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmOffset</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>spExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>sp_old</span> <span class='hs-comment'>-</span> <span class='hs-varid'>area_off</span> <span class='hs-varid'>area</span> <span class='hs-comment'>-</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-925"></a>    <span class='hs-comment'>-- Replace (CmmStackSlot area n) with an offset from Sp</span>
<a name="line-926"></a>
<a name="line-927"></a><span class='hs-definition'>areaToSp</span> <span class='hs-varid'>platform</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>sp_hwm</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLit</span> <span class='hs-conid'>CmmHighStackMark</span><span class='hs-layout'>)</span>
<a name="line-928"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkIntExpr</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>sp_hwm</span>
<a name="line-929"></a>    <span class='hs-comment'>-- Replace CmmHighStackMark with the number of bytes of stack used,</span>
<a name="line-930"></a>    <span class='hs-comment'>-- the sp_hwm.   See Note [Stack usage] in GHC.StgToCmm.Heap</span>
<a name="line-931"></a>
<a name="line-932"></a><span class='hs-definition'>areaToSp</span> <span class='hs-varid'>platform</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmMachOp</span> <span class='hs-layout'>(</span><span class='hs-conid'>MO_U_Lt</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-933"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>falseStackCheck</span> <span class='hs-varid'>args</span>
<a name="line-934"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zeroExpr</span> <span class='hs-varid'>platform</span>
<a name="line-935"></a><span class='hs-definition'>areaToSp</span> <span class='hs-varid'>platform</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmMachOp</span> <span class='hs-layout'>(</span><span class='hs-conid'>MO_U_Ge</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-936"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>falseStackCheck</span> <span class='hs-varid'>args</span>
<a name="line-937"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkIntExpr</span> <span class='hs-varid'>platform</span> <span class='hs-num'>1</span>
<a name="line-938"></a>    <span class='hs-comment'>-- Replace a stack-overflow test that cannot fail with a no-op</span>
<a name="line-939"></a>    <span class='hs-comment'>-- See Note [Always false stack check]</span>
<a name="line-940"></a>
<a name="line-941"></a><span class='hs-definition'>areaToSp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>other</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>other</span>
<a name="line-942"></a>
<a name="line-943"></a><a name="falseStackCheck"></a><span class='hs-comment'>-- | Determine whether a stack check cannot fail.</span>
<a name="line-944"></a><span class='hs-definition'>falseStackCheck</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmExpr</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-945"></a><span class='hs-definition'>falseStackCheck</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>CmmMachOp</span> <span class='hs-layout'>(</span><span class='hs-conid'>MO_Sub</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-946"></a>                      <span class='hs-keyglyph'>[</span> <span class='hs-conid'>CmmRegOff</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-conid'>Sp</span><span class='hs-layout'>)</span> <span class='hs-varid'>x_off</span>
<a name="line-947"></a>                      <span class='hs-layout'>,</span> <span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmInt</span> <span class='hs-varid'>y_lit</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-948"></a>                <span class='hs-layout'>,</span> <span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-conid'>SpLim</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-949"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>x_off</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>y_lit</span>
<a name="line-950"></a><span class='hs-definition'>falseStackCheck</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-951"></a>
<a name="line-952"></a><span class='hs-comment'>-- Note [Always false stack check]</span>
<a name="line-953"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-954"></a><span class='hs-comment'>-- We can optimise stack checks of the form</span>
<a name="line-955"></a><span class='hs-comment'>--</span>
<a name="line-956"></a><span class='hs-comment'>--   if ((Sp + x) - y &lt; SpLim) then .. else ..</span>
<a name="line-957"></a><span class='hs-comment'>--</span>
<a name="line-958"></a><span class='hs-comment'>-- where are non-negative integer byte offsets.  Since we know that</span>
<a name="line-959"></a><span class='hs-comment'>-- SpLim &lt;= Sp (remember the stack grows downwards), this test must</span>
<a name="line-960"></a><span class='hs-comment'>-- yield False if (x &gt;= y), so we can rewrite the comparison to False.</span>
<a name="line-961"></a><span class='hs-comment'>-- A subsequent sinking pass will later drop the dead code.</span>
<a name="line-962"></a><span class='hs-comment'>-- Optimising this away depends on knowing that SpLim &lt;= Sp, so it is</span>
<a name="line-963"></a><span class='hs-comment'>-- really the job of the stack layout algorithm, hence we do it now.</span>
<a name="line-964"></a><span class='hs-comment'>--</span>
<a name="line-965"></a><span class='hs-comment'>-- The control flow optimiser may negate a conditional to increase</span>
<a name="line-966"></a><span class='hs-comment'>-- the likelihood of a fallthrough if the branch is not taken.  But</span>
<a name="line-967"></a><span class='hs-comment'>-- not every conditional is inverted as the control flow optimiser</span>
<a name="line-968"></a><span class='hs-comment'>-- places some requirements on the predecessors of both branch targets.</span>
<a name="line-969"></a><span class='hs-comment'>-- So we better look for the inverted comparison too.</span>
<a name="line-970"></a>
<a name="line-971"></a><a name="optStackCheck"></a><span class='hs-definition'>optStackCheck</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>C</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>C</span>
<a name="line-972"></a><span class='hs-definition'>optStackCheck</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- Note [Always false stack check]</span>
<a name="line-973"></a> <span class='hs-keyword'>case</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>of</span>
<a name="line-974"></a>   <span class='hs-conid'>CmmCondBranch</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmInt</span> <span class='hs-num'>0</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-sel'>_true</span> <span class='hs-varid'>false</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmBranch</span> <span class='hs-varid'>false</span>
<a name="line-975"></a>   <span class='hs-conid'>CmmCondBranch</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmInt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>true</span> <span class='hs-sel'>_false</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmBranch</span> <span class='hs-varid'>true</span>
<a name="line-976"></a>   <span class='hs-varid'>other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>other</span>
<a name="line-977"></a>
<a name="line-978"></a>
<a name="line-979"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-980"></a>
<a name="line-981"></a><a name="elimStackStores"></a><span class='hs-comment'>-- | Eliminate stores of the form</span>
<a name="line-982"></a><span class='hs-comment'>--</span>
<a name="line-983"></a><span class='hs-comment'>--    Sp[area+n] = r</span>
<a name="line-984"></a><span class='hs-comment'>--</span>
<a name="line-985"></a><span class='hs-comment'>-- when we know that r is already in the same slot as Sp[area+n].  We</span>
<a name="line-986"></a><span class='hs-comment'>-- could do this in a later optimisation pass, but that would involve</span>
<a name="line-987"></a><span class='hs-comment'>-- a separate analysis and we already have the information to hand</span>
<a name="line-988"></a><span class='hs-comment'>-- here.  It helps clean up some extra stack stores in common cases.</span>
<a name="line-989"></a><span class='hs-comment'>--</span>
<a name="line-990"></a><span class='hs-comment'>-- Note that we may have to modify the StackMap as we walk through the</span>
<a name="line-991"></a><span class='hs-comment'>-- code using procMiddle, since an assignment to a variable in the</span>
<a name="line-992"></a><span class='hs-comment'>-- StackMap will invalidate its mapping there.</span>
<a name="line-993"></a><span class='hs-comment'>--</span>
<a name="line-994"></a><span class='hs-definition'>elimStackStores</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StackMap</span>
<a name="line-995"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>StackMap</span>
<a name="line-996"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Area</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span><span class='hs-layout'>)</span>
<a name="line-997"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>O</span><span class='hs-keyglyph'>]</span>
<a name="line-998"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>O</span><span class='hs-keyglyph'>]</span>
<a name="line-999"></a><span class='hs-definition'>elimStackStores</span> <span class='hs-varid'>stackmap</span> <span class='hs-varid'>stackmaps</span> <span class='hs-varid'>area_off</span> <span class='hs-varid'>nodes</span>
<a name="line-1000"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>stackmap</span> <span class='hs-varid'>nodes</span>
<a name="line-1001"></a>  <span class='hs-keyword'>where</span>
<a name="line-1002"></a>    <span class='hs-varid'>go</span> <span class='hs-sel'>_stackmap</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-1003"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>stackmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-conop'>:</span><span class='hs-varid'>ns</span><span class='hs-layout'>)</span>
<a name="line-1004"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>of</span>
<a name="line-1005"></a>         <span class='hs-conid'>CmmStore</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmStackSlot</span> <span class='hs-varid'>area</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>
<a name="line-1006"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>off</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>sm_regs</span> <span class='hs-varid'>stackmap</span><span class='hs-layout'>)</span> <span class='hs-varid'>r</span>
<a name="line-1007"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>area_off</span> <span class='hs-varid'>area</span> <span class='hs-varop'>+</span> <span class='hs-varid'>m</span> <span class='hs-varop'>==</span> <span class='hs-varid'>off</span>
<a name="line-1008"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>stackmap</span> <span class='hs-varid'>ns</span>
<a name="line-1009"></a>         <span class='hs-sel'>_otherwise</span>
<a name="line-1010"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>n</span> <span class='hs-conop'>:</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>procMiddle</span> <span class='hs-varid'>stackmaps</span> <span class='hs-varid'>n</span> <span class='hs-varid'>stackmap</span><span class='hs-layout'>)</span> <span class='hs-varid'>ns</span>
<a name="line-1011"></a>
<a name="line-1012"></a>
<a name="line-1013"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-1014"></a><span class='hs-comment'>-- Update info tables to include stack liveness</span>
<a name="line-1015"></a>
<a name="line-1016"></a>
<a name="line-1017"></a><a name="setInfoTableStackMap"></a><span class='hs-definition'>setInfoTableStackMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>StackMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmDecl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmDecl</span>
<a name="line-1018"></a><span class='hs-definition'>setInfoTableStackMap</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>stackmaps</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmProc</span> <span class='hs-varid'>top_info</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>TopInfo</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-varid'>l</span> <span class='hs-varid'>v</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>
<a name="line-1019"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmProc</span> <span class='hs-varid'>top_info</span><span class='hs-layout'>{</span> <span class='hs-varid'>info_tbls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapMapWithKey</span> <span class='hs-varid'>fix_info</span> <span class='hs-varid'>info_tbls</span> <span class='hs-layout'>}</span> <span class='hs-varid'>l</span> <span class='hs-varid'>v</span> <span class='hs-varid'>g</span>
<a name="line-1020"></a>  <span class='hs-keyword'>where</span>
<a name="line-1021"></a>    <span class='hs-varid'>fix_info</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>info_tbl</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>CmmInfoTable</span><span class='hs-layout'>{</span> <span class='hs-varid'>cit_rep</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StackRep</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span>
<a name="line-1022"></a>       <span class='hs-varid'>info_tbl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cit_rep</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StackRep</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_liveness</span> <span class='hs-varid'>lbl</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1023"></a>    <span class='hs-varid'>fix_info</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>other</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>other</span>
<a name="line-1024"></a>
<a name="line-1025"></a>    <span class='hs-varid'>get_liveness</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Liveness</span>
<a name="line-1026"></a>    <span class='hs-varid'>get_liveness</span> <span class='hs-varid'>lbl</span>
<a name="line-1027"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mapLookup</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>stackmaps</span> <span class='hs-keyword'>of</span>
<a name="line-1028"></a>          <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"setInfoTableStackMap"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>lbl</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pdoc</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>info_tbls</span><span class='hs-layout'>)</span>
<a name="line-1029"></a>          <span class='hs-conid'>Just</span> <span class='hs-varid'>sm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>stackMapToLiveness</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>sm</span>
<a name="line-1030"></a>
<a name="line-1031"></a><span class='hs-definition'>setInfoTableStackMap</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span>
<a name="line-1032"></a>
<a name="line-1033"></a>
<a name="line-1034"></a><a name="stackMapToLiveness"></a><span class='hs-definition'>stackMapToLiveness</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StackMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Liveness</span>
<a name="line-1035"></a><span class='hs-definition'>stackMapToLiveness</span> <span class='hs-varid'>platform</span> <span class='hs-conid'>StackMap</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span>
<a name="line-1036"></a>   <span class='hs-varid'>reverse</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Array.elems</span> <span class='hs-varop'>$</span>
<a name="line-1037"></a>        <span class='hs-varid'>accumArray</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-conid'>True</span> <span class='hs-layout'>(</span><span class='hs-varid'>toWords</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>sm_ret_off</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>,</span>
<a name="line-1038"></a>                                     <span class='hs-varid'>toWords</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-varid'>sm_sp</span> <span class='hs-comment'>-</span> <span class='hs-varid'>sm_args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>live_words</span>
<a name="line-1039"></a>   <span class='hs-keyword'>where</span>
<a name="line-1040"></a>     <span class='hs-varid'>live_words</span> <span class='hs-keyglyph'>=</span>  <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>toWords</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>off</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-1041"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span><span class='hs-varid'>off</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nonDetEltsUFM</span> <span class='hs-varid'>sm_regs</span>
<a name="line-1042"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>isGcPtrType</span> <span class='hs-layout'>(</span><span class='hs-varid'>localRegType</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-1043"></a>                   <span class='hs-comment'>-- See Note [Unique Determinism and code generation]</span>
<a name="line-1044"></a>
<a name="line-1045"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-1046"></a><span class='hs-comment'>-- Pass 2</span>
<a name="line-1047"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-1048"></a>
<a name="line-1049"></a><a name="insertReloadsAsNeeded"></a><span class='hs-definition'>insertReloadsAsNeeded</span>
<a name="line-1050"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span>
<a name="line-1051"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ProcPointSet</span>
<a name="line-1052"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>StackMap</span>
<a name="line-1053"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockId</span>
<a name="line-1054"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmBlock</span><span class='hs-keyglyph'>]</span>
<a name="line-1055"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmBlock</span><span class='hs-keyglyph'>]</span>
<a name="line-1056"></a><span class='hs-definition'>insertReloadsAsNeeded</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>procpoints</span> <span class='hs-varid'>final_stackmaps</span> <span class='hs-varid'>entry</span> <span class='hs-varid'>blocks</span> <span class='hs-keyglyph'>=</span>
<a name="line-1057"></a>    <span class='hs-varid'>toBlockList</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>&lt;$&gt;</span>
<a name="line-1058"></a>        <span class='hs-varid'>rewriteCmmBwd</span> <span class='hs-varid'>liveLattice</span> <span class='hs-varid'>rewriteCC</span> <span class='hs-layout'>(</span><span class='hs-varid'>ofBlockList</span> <span class='hs-varid'>entry</span> <span class='hs-varid'>blocks</span><span class='hs-layout'>)</span> <span class='hs-varid'>mapEmpty</span>
<a name="line-1059"></a>  <span class='hs-keyword'>where</span>
<a name="line-1060"></a>    <span class='hs-varid'>rewriteCC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RewriteFun</span> <span class='hs-conid'>CmmLocalLive</span>
<a name="line-1061"></a>    <span class='hs-varid'>rewriteCC</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockCC</span> <span class='hs-varid'>e_node</span> <span class='hs-varid'>middle0</span> <span class='hs-varid'>x_node</span><span class='hs-layout'>)</span> <span class='hs-varid'>fact_base0</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1062"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>entry_label</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>entryLabel</span> <span class='hs-varid'>e_node</span>
<a name="line-1063"></a>            <span class='hs-varid'>stackmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mapLookup</span> <span class='hs-varid'>entry_label</span> <span class='hs-varid'>final_stackmaps</span> <span class='hs-keyword'>of</span>
<a name="line-1064"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>sm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sm</span>
<a name="line-1065"></a>                <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"insertReloadsAsNeeded: rewriteCC: stackmap"</span>
<a name="line-1066"></a>
<a name="line-1067"></a>            <span class='hs-comment'>-- Merge the liveness from successor blocks and analyse the last</span>
<a name="line-1068"></a>            <span class='hs-comment'>-- node.</span>
<a name="line-1069"></a>            <span class='hs-varid'>joined</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gen_kill</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>x_node</span> <span class='hs-varop'>$!</span>
<a name="line-1070"></a>                         <span class='hs-varid'>joinOutFacts</span> <span class='hs-varid'>liveLattice</span> <span class='hs-varid'>x_node</span> <span class='hs-varid'>fact_base0</span>
<a name="line-1071"></a>            <span class='hs-comment'>-- What is live at the start of middle0.</span>
<a name="line-1072"></a>            <span class='hs-varid'>live_at_middle0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldNodesBwdOO</span> <span class='hs-layout'>(</span><span class='hs-varid'>gen_kill</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span> <span class='hs-varid'>middle0</span> <span class='hs-varid'>joined</span>
<a name="line-1073"></a>
<a name="line-1074"></a>            <span class='hs-comment'>-- If this is a procpoint we need to add the reloads, but only if</span>
<a name="line-1075"></a>            <span class='hs-comment'>-- they're actually live. Furthermore, nothing is live at the entry</span>
<a name="line-1076"></a>            <span class='hs-comment'>-- to a proc point.</span>
<a name="line-1077"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>middle1</span><span class='hs-layout'>,</span> <span class='hs-varid'>live_with_reloads</span><span class='hs-layout'>)</span>
<a name="line-1078"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>entry_label</span> <span class='hs-varop'>`setMember`</span> <span class='hs-varid'>procpoints</span>
<a name="line-1079"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>reloads</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertReloads</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>stackmap</span> <span class='hs-varid'>live_at_middle0</span>
<a name="line-1080"></a>                  <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-varid'>blockCons</span> <span class='hs-varid'>middle0</span> <span class='hs-varid'>reloads</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyRegSet</span><span class='hs-layout'>)</span>
<a name="line-1081"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1082"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>middle0</span><span class='hs-layout'>,</span> <span class='hs-varid'>live_at_middle0</span><span class='hs-layout'>)</span>
<a name="line-1083"></a>
<a name="line-1084"></a>            <span class='hs-comment'>-- Final liveness for this block.</span>
<a name="line-1085"></a>            <span class='hs-varop'>!</span><span class='hs-varid'>fact_base2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapSingleton</span> <span class='hs-varid'>entry_label</span> <span class='hs-varid'>live_with_reloads</span>
<a name="line-1086"></a>
<a name="line-1087"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockCC</span> <span class='hs-varid'>e_node</span> <span class='hs-varid'>middle1</span> <span class='hs-varid'>x_node</span><span class='hs-layout'>,</span> <span class='hs-varid'>fact_base2</span><span class='hs-layout'>)</span>
<a name="line-1088"></a>
<a name="line-1089"></a><a name="insertReloads"></a><span class='hs-definition'>insertReloads</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StackMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmLocalLive</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>O</span><span class='hs-keyglyph'>]</span>
<a name="line-1090"></a><span class='hs-definition'>insertReloads</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>stackmap</span> <span class='hs-varid'>live</span> <span class='hs-keyglyph'>=</span>
<a name="line-1091"></a>     <span class='hs-keyglyph'>[</span> <span class='hs-conid'>CmmAssign</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span>
<a name="line-1092"></a>                 <span class='hs-comment'>-- This cmmOffset basically corresponds to manifesting</span>
<a name="line-1093"></a>                 <span class='hs-comment'>-- @CmmStackSlot Old sp_off@, see Note [SP old/young offsets]</span>
<a name="line-1094"></a>                 <span class='hs-layout'>(</span><span class='hs-conid'>CmmLoad</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmOffset</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>spExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>sp_off</span> <span class='hs-comment'>-</span> <span class='hs-varid'>reg_off</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1095"></a>                          <span class='hs-layout'>(</span><span class='hs-varid'>localRegType</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span>
<a name="line-1096"></a>                          <span class='hs-conid'>NaturallyAligned</span><span class='hs-layout'>)</span>
<a name="line-1097"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>reg</span><span class='hs-layout'>,</span> <span class='hs-varid'>reg_off</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stackSlotRegs</span> <span class='hs-varid'>stackmap</span>
<a name="line-1098"></a>     <span class='hs-layout'>,</span> <span class='hs-varid'>reg</span> <span class='hs-varop'>`elemRegSet`</span> <span class='hs-varid'>live</span>
<a name="line-1099"></a>     <span class='hs-keyglyph'>]</span>
<a name="line-1100"></a>   <span class='hs-keyword'>where</span>
<a name="line-1101"></a>     <span class='hs-varid'>sp_off</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sm_sp</span> <span class='hs-varid'>stackmap</span>
<a name="line-1102"></a>
<a name="line-1103"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-1104"></a><span class='hs-comment'>-- Lowering safe foreign calls</span>
<a name="line-1105"></a>
<a name="line-1106"></a><span class='hs-comment'>{-
<a name="line-1107"></a>Note [Lower safe foreign calls]
<a name="line-1108"></a>
<a name="line-1109"></a>We start with
<a name="line-1110"></a>
<a name="line-1111"></a>   Sp[young(L1)] = L1
<a name="line-1112"></a> ,-----------------------
<a name="line-1113"></a> | r1 = foo(x,y,z) returns to L1
<a name="line-1114"></a> '-----------------------
<a name="line-1115"></a> L1:
<a name="line-1116"></a>   R1 = r1 -- copyIn, inserted by mkSafeCall
<a name="line-1117"></a>   ...
<a name="line-1118"></a>
<a name="line-1119"></a>the stack layout algorithm will arrange to save and reload everything
<a name="line-1120"></a>live across the call.  Our job now is to expand the call so we get
<a name="line-1121"></a>
<a name="line-1122"></a>   Sp[young(L1)] = L1
<a name="line-1123"></a> ,-----------------------
<a name="line-1124"></a> | SAVE_THREAD_STATE()
<a name="line-1125"></a> | token = suspendThread(BaseReg, interruptible)
<a name="line-1126"></a> | r = foo(x,y,z)
<a name="line-1127"></a> | BaseReg = resumeThread(token)
<a name="line-1128"></a> | LOAD_THREAD_STATE()
<a name="line-1129"></a> | R1 = r  -- copyOut
<a name="line-1130"></a> | jump Sp[0]
<a name="line-1131"></a> '-----------------------
<a name="line-1132"></a> L1:
<a name="line-1133"></a>   r = R1 -- copyIn, inserted by mkSafeCall
<a name="line-1134"></a>   ...
<a name="line-1135"></a>
<a name="line-1136"></a>Note the copyOut, which saves the results in the places that L1 is
<a name="line-1137"></a>expecting them (see Note [safe foreign call convention]). Note also
<a name="line-1138"></a>that safe foreign call is replace by an unsafe one in the Cmm graph.
<a name="line-1139"></a>-}</span>
<a name="line-1140"></a>
<a name="line-1141"></a><a name="lowerSafeForeignCall"></a><span class='hs-definition'>lowerSafeForeignCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Profile</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmBlock</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-conid'>CmmBlock</span>
<a name="line-1142"></a><span class='hs-definition'>lowerSafeForeignCall</span> <span class='hs-varid'>profile</span> <span class='hs-varid'>block</span>
<a name="line-1143"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>entry</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CmmEntry</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tscp</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>middle</span><span class='hs-layout'>,</span> <span class='hs-conid'>CmmForeignCall</span> <span class='hs-layout'>{</span> <span class='hs-keyglyph'>..</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>blockSplit</span> <span class='hs-varid'>block</span>
<a name="line-1144"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1145"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>profilePlatform</span> <span class='hs-varid'>profile</span>
<a name="line-1146"></a>    <span class='hs-comment'>-- Both 'id' and 'new_base' are KindNonPtr because they're</span>
<a name="line-1147"></a>    <span class='hs-comment'>-- RTS-only objects and are not subject to garbage collection</span>
<a name="line-1148"></a>    <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTemp</span> <span class='hs-layout'>(</span><span class='hs-varid'>bWord</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-1149"></a>    <span class='hs-varid'>new_base</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTemp</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmRegType</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>baseReg</span><span class='hs-layout'>)</span>
<a name="line-1150"></a>    <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>caller_save</span><span class='hs-layout'>,</span> <span class='hs-varid'>caller_load</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>callerSaveVolatileRegs</span> <span class='hs-varid'>platform</span>
<a name="line-1151"></a>    <span class='hs-varid'>save_state_code</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>saveThreadState</span> <span class='hs-varid'>profile</span>
<a name="line-1152"></a>    <span class='hs-varid'>load_state_code</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loadThreadState</span> <span class='hs-varid'>profile</span>
<a name="line-1153"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>suspend</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>save_state_code</span>  <span class='hs-varop'>&lt;*&gt;</span>
<a name="line-1154"></a>                  <span class='hs-varid'>caller_save</span> <span class='hs-varop'>&lt;*&gt;</span>
<a name="line-1155"></a>                  <span class='hs-varid'>mkMiddle</span> <span class='hs-layout'>(</span><span class='hs-varid'>callSuspendThread</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>id</span> <span class='hs-varid'>intrbl</span><span class='hs-layout'>)</span>
<a name="line-1156"></a>        <span class='hs-varid'>midCall</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnsafeCall</span> <span class='hs-varid'>tgt</span> <span class='hs-varid'>res</span> <span class='hs-varid'>args</span>
<a name="line-1157"></a>        <span class='hs-varid'>resume</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkMiddle</span> <span class='hs-layout'>(</span><span class='hs-varid'>callResumeThread</span> <span class='hs-varid'>new_base</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;*&gt;</span>
<a name="line-1158"></a>                  <span class='hs-comment'>-- Assign the result to BaseReg: we</span>
<a name="line-1159"></a>                  <span class='hs-comment'>-- might now have a different Capability!</span>
<a name="line-1160"></a>                  <span class='hs-varid'>mkAssign</span> <span class='hs-varid'>baseReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>new_base</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;*&gt;</span>
<a name="line-1161"></a>                  <span class='hs-varid'>caller_load</span> <span class='hs-varop'>&lt;*&gt;</span>
<a name="line-1162"></a>                  <span class='hs-varid'>load_state_code</span>
<a name="line-1163"></a>
<a name="line-1164"></a>        <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>regs</span><span class='hs-layout'>,</span> <span class='hs-varid'>copyout</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1165"></a>             <span class='hs-varid'>copyOutOflow</span> <span class='hs-varid'>profile</span> <span class='hs-conid'>NativeReturn</span> <span class='hs-conid'>Jump</span> <span class='hs-layout'>(</span><span class='hs-conid'>Young</span> <span class='hs-varid'>succ</span><span class='hs-layout'>)</span>
<a name="line-1166"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varop'>.</span> <span class='hs-conid'>CmmLocal</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-1167"></a>                            <span class='hs-varid'>ret_off</span> <span class='hs-conid'>[]</span>
<a name="line-1168"></a>
<a name="line-1169"></a>        <span class='hs-comment'>-- NB. after resumeThread returns, the top-of-stack probably contains</span>
<a name="line-1170"></a>        <span class='hs-comment'>-- the stack frame for succ, but it might not: if the current thread</span>
<a name="line-1171"></a>        <span class='hs-comment'>-- received an exception during the call, then the stack might be</span>
<a name="line-1172"></a>        <span class='hs-comment'>-- different.  Hence we continue by jumping to the top stack frame,</span>
<a name="line-1173"></a>        <span class='hs-comment'>-- not by jumping to succ.</span>
<a name="line-1174"></a>        <span class='hs-varid'>jump</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmCall</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cml_target</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>entryCode</span> <span class='hs-varid'>platform</span> <span class='hs-varop'>$</span>
<a name="line-1175"></a>                                         <span class='hs-varid'>cmmLoadBWord</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>spExpr</span>
<a name="line-1176"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>cml_cont</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>succ</span>
<a name="line-1177"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>cml_args_regs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>regs</span>
<a name="line-1178"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>cml_args</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>widthInBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>wordWidth</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-1179"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>cml_ret_args</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ret_args</span>
<a name="line-1180"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>cml_ret_off</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ret_off</span> <span class='hs-layout'>}</span>
<a name="line-1181"></a>
<a name="line-1182"></a>    <span class='hs-varid'>graph'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lgraphOfAGraph</span> <span class='hs-layout'>(</span> <span class='hs-varid'>suspend</span> <span class='hs-varop'>&lt;*&gt;</span>
<a name="line-1183"></a>                               <span class='hs-varid'>midCall</span> <span class='hs-varop'>&lt;*&gt;</span>
<a name="line-1184"></a>                               <span class='hs-varid'>resume</span>  <span class='hs-varop'>&lt;*&gt;</span>
<a name="line-1185"></a>                               <span class='hs-varid'>copyout</span> <span class='hs-varop'>&lt;*&gt;</span>
<a name="line-1186"></a>                               <span class='hs-varid'>mkLast</span> <span class='hs-varid'>jump</span><span class='hs-layout'>,</span> <span class='hs-varid'>tscp</span><span class='hs-layout'>)</span>
<a name="line-1187"></a>
<a name="line-1188"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>toBlockList</span> <span class='hs-varid'>graph'</span> <span class='hs-keyword'>of</span>
<a name="line-1189"></a>      <span class='hs-keyglyph'>[</span><span class='hs-varid'>one</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>middle'</span><span class='hs-layout'>,</span> <span class='hs-varid'>last</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>blockSplit</span> <span class='hs-varid'>one</span>
<a name="line-1190"></a>               <span class='hs-keyword'>in</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>blockJoin</span> <span class='hs-varid'>entry</span> <span class='hs-layout'>(</span><span class='hs-varid'>middle</span> <span class='hs-varop'>`blockAppend`</span> <span class='hs-varid'>middle'</span><span class='hs-layout'>)</span> <span class='hs-varid'>last</span><span class='hs-layout'>)</span>
<a name="line-1191"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"lowerSafeForeignCall0"</span>
<a name="line-1192"></a>
<a name="line-1193"></a>  <span class='hs-comment'>-- Block doesn't end in a safe foreign call:</span>
<a name="line-1194"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>block</span>
<a name="line-1195"></a>
<a name="line-1196"></a>
<a name="line-1197"></a><a name="foreignLbl"></a><span class='hs-definition'>foreignLbl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span>
<a name="line-1198"></a><span class='hs-definition'>foreignLbl</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLabel</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkForeignLabel</span> <span class='hs-varid'>name</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>ForeignLabelInExternalPackage</span> <span class='hs-conid'>IsFunction</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1199"></a>
<a name="line-1200"></a><a name="callSuspendThread"></a><span class='hs-definition'>callSuspendThread</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LocalReg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>O</span>
<a name="line-1201"></a><span class='hs-definition'>callSuspendThread</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>id</span> <span class='hs-varid'>intrbl</span> <span class='hs-keyglyph'>=</span>
<a name="line-1202"></a>  <span class='hs-conid'>CmmUnsafeForeignCall</span>
<a name="line-1203"></a>       <span class='hs-layout'>(</span><span class='hs-conid'>ForeignTarget</span> <span class='hs-layout'>(</span><span class='hs-varid'>foreignLbl</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"suspendThread"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1204"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>ForeignConvention</span> <span class='hs-conid'>CCallConv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AddrHint</span><span class='hs-layout'>,</span> <span class='hs-conid'>NoHint</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AddrHint</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>CmmMayReturn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1205"></a>       <span class='hs-keyglyph'>[</span><span class='hs-varid'>id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>baseExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkIntExpr</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromEnum</span> <span class='hs-varid'>intrbl</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1206"></a>
<a name="line-1207"></a><a name="callResumeThread"></a><span class='hs-definition'>callResumeThread</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LocalReg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LocalReg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>O</span>
<a name="line-1208"></a><span class='hs-definition'>callResumeThread</span> <span class='hs-varid'>new_base</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span>
<a name="line-1209"></a>  <span class='hs-conid'>CmmUnsafeForeignCall</span>
<a name="line-1210"></a>       <span class='hs-layout'>(</span><span class='hs-conid'>ForeignTarget</span> <span class='hs-layout'>(</span><span class='hs-varid'>foreignLbl</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"resumeThread"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1211"></a>            <span class='hs-layout'>(</span><span class='hs-conid'>ForeignConvention</span> <span class='hs-conid'>CCallConv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AddrHint</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AddrHint</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>CmmMayReturn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1212"></a>       <span class='hs-keyglyph'>[</span><span class='hs-varid'>new_base</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1213"></a>
<a name="line-1214"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-1215"></a>
<a name="line-1216"></a><a name="plusW"></a><span class='hs-definition'>plusW</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>
<a name="line-1217"></a><span class='hs-definition'>plusW</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>b</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span> <span class='hs-varop'>+</span> <span class='hs-varid'>w</span> <span class='hs-varop'>*</span> <span class='hs-varid'>platformWordSizeInBytes</span> <span class='hs-varid'>platform</span>
<a name="line-1218"></a>
<a name="line-1219"></a><a name="StackSlot"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>StackSlot</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Occupied</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Empty</span>
<a name="line-1220"></a>     <span class='hs-comment'>-- Occupied: a return address or part of an update frame</span>
<a name="line-1221"></a>
<a name="line-1222"></a><a name="instance%20Outputable%20StackSlot"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>StackSlot</span> <span class='hs-keyword'>where</span>
<a name="line-1223"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Occupied</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"XXX"</span>
<a name="line-1224"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Empty</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"---"</span>
<a name="line-1225"></a>
<a name="line-1226"></a><a name="dropEmpty"></a><span class='hs-definition'>dropEmpty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WordOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StackSlot</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StackSlot</span><span class='hs-keyglyph'>]</span>
<a name="line-1227"></a><span class='hs-definition'>dropEmpty</span> <span class='hs-num'>0</span> <span class='hs-varid'>ss</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ss</span>
<a name="line-1228"></a><span class='hs-definition'>dropEmpty</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>Empty</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dropEmpty</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ss</span>
<a name="line-1229"></a><span class='hs-definition'>dropEmpty</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1230"></a>
<a name="line-1231"></a><a name="isEmpty"></a><span class='hs-definition'>isEmpty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StackSlot</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1232"></a><span class='hs-definition'>isEmpty</span> <span class='hs-conid'>Empty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1233"></a><span class='hs-definition'>isEmpty</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1234"></a>
<a name="line-1235"></a><a name="localRegBytes"></a><span class='hs-definition'>localRegBytes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LocalReg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>
<a name="line-1236"></a><span class='hs-definition'>localRegBytes</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>r</span>
<a name="line-1237"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>roundUpToWords</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-varid'>widthInBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeWidth</span> <span class='hs-layout'>(</span><span class='hs-varid'>localRegType</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1238"></a>
<a name="line-1239"></a><a name="localRegWords"></a><span class='hs-definition'>localRegWords</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LocalReg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span>
<a name="line-1240"></a><span class='hs-definition'>localRegWords</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toWords</span> <span class='hs-varid'>platform</span> <span class='hs-varop'>.</span> <span class='hs-varid'>localRegBytes</span> <span class='hs-varid'>platform</span>
<a name="line-1241"></a>
<a name="line-1242"></a><a name="toWords"></a><span class='hs-definition'>toWords</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span>
<a name="line-1243"></a><span class='hs-definition'>toWords</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span> <span class='hs-varop'>`quot`</span> <span class='hs-varid'>platformWordSizeInBytes</span> <span class='hs-varid'>platform</span>
<a name="line-1244"></a>
<a name="line-1245"></a>
<a name="line-1246"></a><a name="stackSlotRegs"></a><span class='hs-definition'>stackSlotRegs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StackMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LocalReg</span><span class='hs-layout'>,</span> <span class='hs-conid'>StackLoc</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1247"></a><span class='hs-definition'>stackSlotRegs</span> <span class='hs-varid'>sm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nonDetEltsUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>sm_regs</span> <span class='hs-varid'>sm</span><span class='hs-layout'>)</span>
<a name="line-1248"></a>  <span class='hs-comment'>-- See Note [Unique Determinism and code generation]</span>
</pre></body>
</html>
