<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/StgToCmm/CgUtils.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE GADTs #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE BangPatterns #-}</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-5"></a><span class='hs-comment'>--</span>
<a name="line-6"></a><span class='hs-comment'>-- Code generator utilities; mostly monadic</span>
<a name="line-7"></a><span class='hs-comment'>--</span>
<a name="line-8"></a><span class='hs-comment'>-- (c) The University of Glasgow 2004-2006</span>
<a name="line-9"></a><span class='hs-comment'>--</span>
<a name="line-10"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.StgToCmm.CgUtils</span> <span class='hs-layout'>(</span>
<a name="line-13"></a>        <span class='hs-varid'>fixStgRegisters</span><span class='hs-layout'>,</span>
<a name="line-14"></a>        <span class='hs-varid'>baseRegOffset</span><span class='hs-layout'>,</span>
<a name="line-15"></a>        <span class='hs-varid'>get_Regtable_addr_from_offset</span><span class='hs-layout'>,</span>
<a name="line-16"></a>        <span class='hs-varid'>regTableOffset</span><span class='hs-layout'>,</span>
<a name="line-17"></a>        <span class='hs-varid'>get_GlobalReg_addr</span><span class='hs-layout'>,</span>
<a name="line-18"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Platform.Regs</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Platform</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.Dataflow.Block</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.Dataflow.Graph</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.Utils</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.CLabel</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-32"></a><span class='hs-comment'>-- Information about global registers</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="baseRegOffset"></a><span class='hs-definition'>baseRegOffset</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalReg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-35"></a><span class='hs-definition'>baseRegOffset</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>reg</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>reg</span> <span class='hs-keyword'>of</span>
<a name="line-36"></a>   <span class='hs-conid'>VanillaReg</span> <span class='hs-num'>1</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rR1</span>  <span class='hs-varid'>constants</span>
<a name="line-37"></a>   <span class='hs-conid'>VanillaReg</span> <span class='hs-num'>2</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rR2</span>  <span class='hs-varid'>constants</span>
<a name="line-38"></a>   <span class='hs-conid'>VanillaReg</span> <span class='hs-num'>3</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rR3</span>  <span class='hs-varid'>constants</span>
<a name="line-39"></a>   <span class='hs-conid'>VanillaReg</span> <span class='hs-num'>4</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rR4</span>  <span class='hs-varid'>constants</span>
<a name="line-40"></a>   <span class='hs-conid'>VanillaReg</span> <span class='hs-num'>5</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rR5</span>  <span class='hs-varid'>constants</span>
<a name="line-41"></a>   <span class='hs-conid'>VanillaReg</span> <span class='hs-num'>6</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rR6</span>  <span class='hs-varid'>constants</span>
<a name="line-42"></a>   <span class='hs-conid'>VanillaReg</span> <span class='hs-num'>7</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rR7</span>  <span class='hs-varid'>constants</span>
<a name="line-43"></a>   <span class='hs-conid'>VanillaReg</span> <span class='hs-num'>8</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rR8</span>  <span class='hs-varid'>constants</span>
<a name="line-44"></a>   <span class='hs-conid'>VanillaReg</span> <span class='hs-num'>9</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rR9</span>  <span class='hs-varid'>constants</span>
<a name="line-45"></a>   <span class='hs-conid'>VanillaReg</span> <span class='hs-num'>10</span> <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rR10</span> <span class='hs-varid'>constants</span>
<a name="line-46"></a>   <span class='hs-conid'>VanillaReg</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"Registers above R10 are not supported (tried to use R"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span> <span class='hs-varop'>++</span> <span class='hs-str'>")"</span><span class='hs-layout'>)</span>
<a name="line-47"></a>   <span class='hs-conid'>FloatReg</span>  <span class='hs-num'>1</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rF1</span> <span class='hs-varid'>constants</span>
<a name="line-48"></a>   <span class='hs-conid'>FloatReg</span>  <span class='hs-num'>2</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rF2</span> <span class='hs-varid'>constants</span>
<a name="line-49"></a>   <span class='hs-conid'>FloatReg</span>  <span class='hs-num'>3</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rF3</span> <span class='hs-varid'>constants</span>
<a name="line-50"></a>   <span class='hs-conid'>FloatReg</span>  <span class='hs-num'>4</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rF4</span> <span class='hs-varid'>constants</span>
<a name="line-51"></a>   <span class='hs-conid'>FloatReg</span>  <span class='hs-num'>5</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rF5</span> <span class='hs-varid'>constants</span>
<a name="line-52"></a>   <span class='hs-conid'>FloatReg</span>  <span class='hs-num'>6</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rF6</span> <span class='hs-varid'>constants</span>
<a name="line-53"></a>   <span class='hs-conid'>FloatReg</span>  <span class='hs-varid'>n</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"Registers above F6 are not supported (tried to use F"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span> <span class='hs-varop'>++</span> <span class='hs-str'>")"</span><span class='hs-layout'>)</span>
<a name="line-54"></a>   <span class='hs-conid'>DoubleReg</span> <span class='hs-num'>1</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rD1</span> <span class='hs-varid'>constants</span>
<a name="line-55"></a>   <span class='hs-conid'>DoubleReg</span> <span class='hs-num'>2</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rD2</span> <span class='hs-varid'>constants</span>
<a name="line-56"></a>   <span class='hs-conid'>DoubleReg</span> <span class='hs-num'>3</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rD3</span> <span class='hs-varid'>constants</span>
<a name="line-57"></a>   <span class='hs-conid'>DoubleReg</span> <span class='hs-num'>4</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rD4</span> <span class='hs-varid'>constants</span>
<a name="line-58"></a>   <span class='hs-conid'>DoubleReg</span> <span class='hs-num'>5</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rD5</span> <span class='hs-varid'>constants</span>
<a name="line-59"></a>   <span class='hs-conid'>DoubleReg</span> <span class='hs-num'>6</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rD6</span> <span class='hs-varid'>constants</span>
<a name="line-60"></a>   <span class='hs-conid'>DoubleReg</span> <span class='hs-varid'>n</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"Registers above D6 are not supported (tried to use D"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span> <span class='hs-varop'>++</span> <span class='hs-str'>")"</span><span class='hs-layout'>)</span>
<a name="line-61"></a>   <span class='hs-conid'>XmmReg</span> <span class='hs-num'>1</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rXMM1</span> <span class='hs-varid'>constants</span>
<a name="line-62"></a>   <span class='hs-conid'>XmmReg</span> <span class='hs-num'>2</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rXMM2</span> <span class='hs-varid'>constants</span>
<a name="line-63"></a>   <span class='hs-conid'>XmmReg</span> <span class='hs-num'>3</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rXMM3</span> <span class='hs-varid'>constants</span>
<a name="line-64"></a>   <span class='hs-conid'>XmmReg</span> <span class='hs-num'>4</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rXMM4</span> <span class='hs-varid'>constants</span>
<a name="line-65"></a>   <span class='hs-conid'>XmmReg</span> <span class='hs-num'>5</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rXMM5</span> <span class='hs-varid'>constants</span>
<a name="line-66"></a>   <span class='hs-conid'>XmmReg</span> <span class='hs-num'>6</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rXMM6</span> <span class='hs-varid'>constants</span>
<a name="line-67"></a>   <span class='hs-conid'>XmmReg</span> <span class='hs-varid'>n</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"Registers above XMM6 are not supported (tried to use XMM"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span> <span class='hs-varop'>++</span> <span class='hs-str'>")"</span><span class='hs-layout'>)</span>
<a name="line-68"></a>   <span class='hs-conid'>YmmReg</span> <span class='hs-num'>1</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rYMM1</span> <span class='hs-varid'>constants</span>
<a name="line-69"></a>   <span class='hs-conid'>YmmReg</span> <span class='hs-num'>2</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rYMM2</span> <span class='hs-varid'>constants</span>
<a name="line-70"></a>   <span class='hs-conid'>YmmReg</span> <span class='hs-num'>3</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rYMM3</span> <span class='hs-varid'>constants</span>
<a name="line-71"></a>   <span class='hs-conid'>YmmReg</span> <span class='hs-num'>4</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rYMM4</span> <span class='hs-varid'>constants</span>
<a name="line-72"></a>   <span class='hs-conid'>YmmReg</span> <span class='hs-num'>5</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rYMM5</span> <span class='hs-varid'>constants</span>
<a name="line-73"></a>   <span class='hs-conid'>YmmReg</span> <span class='hs-num'>6</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rYMM6</span> <span class='hs-varid'>constants</span>
<a name="line-74"></a>   <span class='hs-conid'>YmmReg</span> <span class='hs-varid'>n</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"Registers above YMM6 are not supported (tried to use YMM"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span> <span class='hs-varop'>++</span> <span class='hs-str'>")"</span><span class='hs-layout'>)</span>
<a name="line-75"></a>   <span class='hs-conid'>ZmmReg</span> <span class='hs-num'>1</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rZMM1</span> <span class='hs-varid'>constants</span>
<a name="line-76"></a>   <span class='hs-conid'>ZmmReg</span> <span class='hs-num'>2</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rZMM2</span> <span class='hs-varid'>constants</span>
<a name="line-77"></a>   <span class='hs-conid'>ZmmReg</span> <span class='hs-num'>3</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rZMM3</span> <span class='hs-varid'>constants</span>
<a name="line-78"></a>   <span class='hs-conid'>ZmmReg</span> <span class='hs-num'>4</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rZMM4</span> <span class='hs-varid'>constants</span>
<a name="line-79"></a>   <span class='hs-conid'>ZmmReg</span> <span class='hs-num'>5</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rZMM5</span> <span class='hs-varid'>constants</span>
<a name="line-80"></a>   <span class='hs-conid'>ZmmReg</span> <span class='hs-num'>6</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rZMM6</span> <span class='hs-varid'>constants</span>
<a name="line-81"></a>   <span class='hs-conid'>ZmmReg</span> <span class='hs-varid'>n</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"Registers above ZMM6 are not supported (tried to use ZMM"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span> <span class='hs-varop'>++</span> <span class='hs-str'>")"</span><span class='hs-layout'>)</span>
<a name="line-82"></a>   <span class='hs-conid'>Sp</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rSp</span>    <span class='hs-varid'>constants</span>
<a name="line-83"></a>   <span class='hs-conid'>SpLim</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rSpLim</span> <span class='hs-varid'>constants</span>
<a name="line-84"></a>   <span class='hs-conid'>LongReg</span> <span class='hs-num'>1</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rL1</span>    <span class='hs-varid'>constants</span>
<a name="line-85"></a>   <span class='hs-conid'>LongReg</span> <span class='hs-varid'>n</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"Registers above L1 are not supported (tried to use L"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span> <span class='hs-varop'>++</span> <span class='hs-str'>")"</span><span class='hs-layout'>)</span>
<a name="line-86"></a>   <span class='hs-conid'>Hp</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rHp</span>             <span class='hs-varid'>constants</span>
<a name="line-87"></a>   <span class='hs-conid'>HpLim</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rHpLim</span>          <span class='hs-varid'>constants</span>
<a name="line-88"></a>   <span class='hs-conid'>CCCS</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rCCCS</span>           <span class='hs-varid'>constants</span>
<a name="line-89"></a>   <span class='hs-conid'>CurrentTSO</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rCurrentTSO</span>     <span class='hs-varid'>constants</span>
<a name="line-90"></a>   <span class='hs-conid'>CurrentNursery</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rCurrentNursery</span> <span class='hs-varid'>constants</span>
<a name="line-91"></a>   <span class='hs-conid'>HpAlloc</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_StgRegTable_rHpAlloc</span>        <span class='hs-varid'>constants</span>
<a name="line-92"></a>   <span class='hs-conid'>EagerBlackholeInfo</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_stgEagerBlackholeInfo</span>       <span class='hs-varid'>constants</span>
<a name="line-93"></a>   <span class='hs-conid'>GCEnter1</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_stgGCEnter1</span>                 <span class='hs-varid'>constants</span>
<a name="line-94"></a>   <span class='hs-conid'>GCFun</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pc_OFFSET_stgGCFun</span>                    <span class='hs-varid'>constants</span>
<a name="line-95"></a>   <span class='hs-conid'>BaseReg</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"GHC.StgToCmm.CgUtils.baseRegOffset:BaseReg"</span>
<a name="line-96"></a>   <span class='hs-conid'>PicBaseReg</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"GHC.StgToCmm.CgUtils.baseRegOffset:PicBaseReg"</span>
<a name="line-97"></a>   <span class='hs-conid'>MachSp</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"GHC.StgToCmm.CgUtils.baseRegOffset:MachSp"</span>
<a name="line-98"></a>   <span class='hs-conid'>UnwindReturnReg</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"GHC.StgToCmm.CgUtils.baseRegOffset:UnwindReturnReg"</span>
<a name="line-99"></a> <span class='hs-keyword'>where</span>
<a name="line-100"></a>   <span class='hs-varop'>!</span><span class='hs-varid'>constants</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>platformConstants</span> <span class='hs-varid'>platform</span>
<a name="line-101"></a>
<a name="line-102"></a>
<a name="line-103"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-104"></a><span class='hs-comment'>--</span>
<a name="line-105"></a><span class='hs-comment'>-- STG/Cmm GlobalReg</span>
<a name="line-106"></a><span class='hs-comment'>--</span>
<a name="line-107"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-108"></a>
<a name="line-109"></a><a name="get_GlobalReg_addr"></a><span class='hs-comment'>-- | We map STG registers onto appropriate CmmExprs.  Either they map</span>
<a name="line-110"></a><span class='hs-comment'>-- to real machine registers or stored as offsets from BaseReg.  Given</span>
<a name="line-111"></a><span class='hs-comment'>-- a GlobalReg, get_GlobalReg_addr always produces the</span>
<a name="line-112"></a><span class='hs-comment'>-- register table address for it.</span>
<a name="line-113"></a><span class='hs-definition'>get_GlobalReg_addr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalReg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span>
<a name="line-114"></a><span class='hs-definition'>get_GlobalReg_addr</span> <span class='hs-varid'>platform</span> <span class='hs-conid'>BaseReg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>regTableOffset</span> <span class='hs-varid'>platform</span> <span class='hs-num'>0</span>
<a name="line-115"></a><span class='hs-definition'>get_GlobalReg_addr</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>mid</span>
<a name="line-116"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>get_Regtable_addr_from_offset</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-varid'>baseRegOffset</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>mid</span><span class='hs-layout'>)</span>
<a name="line-117"></a>
<a name="line-118"></a><a name="regTableOffset"></a><span class='hs-comment'>-- Calculate a literal representing an offset into the register table.</span>
<a name="line-119"></a><span class='hs-comment'>-- Used when we don't have an actual BaseReg to offset from.</span>
<a name="line-120"></a><span class='hs-definition'>regTableOffset</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span>
<a name="line-121"></a><span class='hs-definition'>regTableOffset</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span>
<a name="line-122"></a>  <span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLabelOff</span> <span class='hs-varid'>mkMainCapabilityLabel</span> <span class='hs-layout'>(</span><span class='hs-varid'>pc_OFFSET_Capability_r</span> <span class='hs-layout'>(</span><span class='hs-varid'>platformConstants</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-123"></a>
<a name="line-124"></a><a name="get_Regtable_addr_from_offset"></a><span class='hs-definition'>get_Regtable_addr_from_offset</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span>
<a name="line-125"></a><span class='hs-definition'>get_Regtable_addr_from_offset</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>offset</span> <span class='hs-keyglyph'>=</span>
<a name="line-126"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>haveRegBase</span> <span class='hs-varid'>platform</span>
<a name="line-127"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>cmmRegOff</span> <span class='hs-varid'>baseReg</span> <span class='hs-varid'>offset</span>
<a name="line-128"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>regTableOffset</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>offset</span>
<a name="line-129"></a>
<a name="line-130"></a><a name="fixStgRegisters"></a><span class='hs-comment'>-- | Fixup global registers so that they assign to locations within the</span>
<a name="line-131"></a><span class='hs-comment'>-- RegTable if they aren't pinned for the current target.</span>
<a name="line-132"></a><span class='hs-definition'>fixStgRegisters</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RawCmmDecl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RawCmmDecl</span>
<a name="line-133"></a><span class='hs-definition'>fixStgRegisters</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>top</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CmmData</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>top</span>
<a name="line-134"></a>
<a name="line-135"></a><span class='hs-definition'>fixStgRegisters</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmProc</span> <span class='hs-varid'>info</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>live</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-136"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>graph'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyGraph</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapGraphBlocks</span> <span class='hs-layout'>(</span><span class='hs-varid'>fixStgRegBlock</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>graph</span>
<a name="line-137"></a>  <span class='hs-keyword'>in</span> <span class='hs-conid'>CmmProc</span> <span class='hs-varid'>info</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>live</span> <span class='hs-varid'>graph'</span>
<a name="line-138"></a>
<a name="line-139"></a><a name="fixStgRegBlock"></a><span class='hs-definition'>fixStgRegBlock</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Block</span> <span class='hs-conid'>CmmNode</span> <span class='hs-varid'>e</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Block</span> <span class='hs-conid'>CmmNode</span> <span class='hs-varid'>e</span> <span class='hs-varid'>x</span>
<a name="line-140"></a><span class='hs-definition'>fixStgRegBlock</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>block</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapBlock</span> <span class='hs-layout'>(</span><span class='hs-varid'>fixStgRegStmt</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span> <span class='hs-varid'>block</span>
<a name="line-141"></a>
<a name="line-142"></a><a name="fixStgRegStmt"></a><span class='hs-definition'>fixStgRegStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmNode</span> <span class='hs-varid'>e</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmNode</span> <span class='hs-varid'>e</span> <span class='hs-varid'>x</span>
<a name="line-143"></a><span class='hs-definition'>fixStgRegStmt</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>stmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fixAssign</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapExpDeep</span> <span class='hs-varid'>fixExpr</span> <span class='hs-varid'>stmt</span>
<a name="line-144"></a>  <span class='hs-keyword'>where</span>
<a name="line-145"></a>    <span class='hs-varid'>fixAssign</span> <span class='hs-varid'>stmt</span> <span class='hs-keyglyph'>=</span>
<a name="line-146"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>of</span>
<a name="line-147"></a>        <span class='hs-conid'>CmmAssign</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span>
<a name="line-148"></a>          <span class='hs-comment'>-- MachSp isn't an STG register; it's merely here for tracking unwind</span>
<a name="line-149"></a>          <span class='hs-comment'>-- information</span>
<a name="line-150"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>reg</span> <span class='hs-varop'>==</span> <span class='hs-conid'>MachSp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>stmt</span>
<a name="line-151"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-152"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>baseAddr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>get_GlobalReg_addr</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>reg</span>
<a name="line-153"></a>            <span class='hs-keyword'>in</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>reg</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>activeStgRegs</span> <span class='hs-varid'>platform</span> <span class='hs-keyword'>of</span>
<a name="line-154"></a>                <span class='hs-conid'>True</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmAssign</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-varid'>src</span>
<a name="line-155"></a>                <span class='hs-conid'>False</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmStore</span> <span class='hs-varid'>baseAddr</span> <span class='hs-varid'>src</span> <span class='hs-conid'>NaturallyAligned</span>
<a name="line-156"></a>        <span class='hs-varid'>other_stmt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>other_stmt</span>
<a name="line-157"></a>
<a name="line-158"></a>    <span class='hs-varid'>fixExpr</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>expr</span> <span class='hs-keyword'>of</span>
<a name="line-159"></a>        <span class='hs-comment'>-- MachSp isn't an STG; it's merely here for tracking unwind information</span>
<a name="line-160"></a>        <span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-conid'>MachSp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>expr</span>
<a name="line-161"></a>        <span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-162"></a>            <span class='hs-comment'>-- Replace register leaves with appropriate StixTrees for</span>
<a name="line-163"></a>            <span class='hs-comment'>-- the given target.  MagicIds which map to a reg on this</span>
<a name="line-164"></a>            <span class='hs-comment'>-- arch are left unchanged.  For the rest, BaseReg is taken</span>
<a name="line-165"></a>            <span class='hs-comment'>-- to mean the address of the reg table in MainCapability,</span>
<a name="line-166"></a>            <span class='hs-comment'>-- and for all others we generate an indirection to its</span>
<a name="line-167"></a>            <span class='hs-comment'>-- location in the register table.</span>
<a name="line-168"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>reg</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>activeStgRegs</span> <span class='hs-varid'>platform</span> <span class='hs-keyword'>of</span>
<a name="line-169"></a>                <span class='hs-conid'>True</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>expr</span>
<a name="line-170"></a>                <span class='hs-conid'>False</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-171"></a>                    <span class='hs-keyword'>let</span> <span class='hs-varid'>baseAddr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>get_GlobalReg_addr</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>reg</span>
<a name="line-172"></a>                    <span class='hs-keyword'>in</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>reg</span> <span class='hs-keyword'>of</span>
<a name="line-173"></a>                        <span class='hs-conid'>BaseReg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>baseAddr</span>
<a name="line-174"></a>                        <span class='hs-sel'>_other</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmLoad</span> <span class='hs-varid'>baseAddr</span> <span class='hs-layout'>(</span><span class='hs-varid'>globalRegType</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-conid'>NaturallyAligned</span>
<a name="line-175"></a>
<a name="line-176"></a>        <span class='hs-conid'>CmmRegOff</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-varid'>offset</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-177"></a>            <span class='hs-comment'>-- RegOf leaves are just a shorthand form. If the reg maps</span>
<a name="line-178"></a>            <span class='hs-comment'>-- to a real reg, we keep the shorthand, otherwise, we just</span>
<a name="line-179"></a>            <span class='hs-comment'>-- expand it and defer to the above code.</span>
<a name="line-180"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>reg</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>activeStgRegs</span> <span class='hs-varid'>platform</span> <span class='hs-keyword'>of</span>
<a name="line-181"></a>                <span class='hs-conid'>True</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>expr</span>
<a name="line-182"></a>                <span class='hs-conid'>False</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmMachOp</span> <span class='hs-layout'>(</span><span class='hs-conid'>MO_Add</span> <span class='hs-layout'>(</span><span class='hs-varid'>wordWidth</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span>
<a name="line-183"></a>                                    <span class='hs-varid'>fixExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-184"></a>                                    <span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmInt</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>offset</span><span class='hs-layout'>)</span>
<a name="line-185"></a>                                                   <span class='hs-layout'>(</span><span class='hs-varid'>wordWidth</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-186"></a>
<a name="line-187"></a>        <span class='hs-varid'>other_expr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>other_expr</span>
</pre></body>
</html>
