<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Types/Demand.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP          #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE ViewPatterns #-}</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-comment'>{-# OPTIONS_GHC -Wno-incomplete-uni-patterns #-}</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-comment'>{-
<a name="line-7"></a>(c) The University of Glasgow 2006
<a name="line-8"></a>(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
<a name="line-9"></a>-}</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-comment'>-- | A language to express the evaluation context of an expression as a</span>
<a name="line-12"></a><span class='hs-comment'>-- 'Demand' and track how an expression evaluates free variables and arguments</span>
<a name="line-13"></a><span class='hs-comment'>-- in turn as a 'DmdType'.</span>
<a name="line-14"></a><span class='hs-comment'>--</span>
<a name="line-15"></a><span class='hs-comment'>-- Lays out the abstract domain for "GHC.Core.Opt.DmdAnal".</span>
<a name="line-16"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Types.Demand</span> <span class='hs-layout'>(</span>
<a name="line-17"></a>    <span class='hs-comment'>-- * Demands</span>
<a name="line-18"></a>    <span class='hs-conid'>Card</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Demand</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>SubDemand</span><span class='hs-layout'>(</span><span class='hs-conid'>Prod</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkProd</span><span class='hs-layout'>,</span> <span class='hs-varid'>viewProd</span><span class='hs-layout'>,</span>
<a name="line-19"></a>    <span class='hs-comment'>-- ** Algebra</span>
<a name="line-20"></a>    <span class='hs-varid'>absDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>topDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>botDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>seqDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>topSubDmd</span><span class='hs-layout'>,</span>
<a name="line-21"></a>    <span class='hs-comment'>-- *** Least upper bound</span>
<a name="line-22"></a>    <span class='hs-varid'>lubCard</span><span class='hs-layout'>,</span> <span class='hs-varid'>lubDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>lubSubDmd</span><span class='hs-layout'>,</span>
<a name="line-23"></a>    <span class='hs-comment'>-- *** Plus</span>
<a name="line-24"></a>    <span class='hs-varid'>plusCard</span><span class='hs-layout'>,</span> <span class='hs-varid'>plusDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>plusSubDmd</span><span class='hs-layout'>,</span>
<a name="line-25"></a>    <span class='hs-comment'>-- *** Multiply</span>
<a name="line-26"></a>    <span class='hs-varid'>multCard</span><span class='hs-layout'>,</span> <span class='hs-varid'>multDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>multSubDmd</span><span class='hs-layout'>,</span>
<a name="line-27"></a>    <span class='hs-comment'>-- ** Predicates on @Card@inalities and @Demand@s</span>
<a name="line-28"></a>    <span class='hs-varid'>isAbs</span><span class='hs-layout'>,</span> <span class='hs-varid'>isUsedOnce</span><span class='hs-layout'>,</span> <span class='hs-varid'>isStrict</span><span class='hs-layout'>,</span>
<a name="line-29"></a>    <span class='hs-varid'>isAbsDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>isUsedOnceDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>isStrUsedDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>isStrictDmd</span><span class='hs-layout'>,</span>
<a name="line-30"></a>    <span class='hs-varid'>isTopDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSeqDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>isWeakDmd</span><span class='hs-layout'>,</span>
<a name="line-31"></a>    <span class='hs-comment'>-- ** Special demands</span>
<a name="line-32"></a>    <span class='hs-varid'>evalDmd</span><span class='hs-layout'>,</span>
<a name="line-33"></a>    <span class='hs-comment'>-- *** Demands used in PrimOp signatures</span>
<a name="line-34"></a>    <span class='hs-varid'>lazyApply1Dmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>lazyApply2Dmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>strictOnceApply1Dmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>strictManyApply1Dmd</span><span class='hs-layout'>,</span>
<a name="line-35"></a>    <span class='hs-comment'>-- ** Other @Demand@ operations</span>
<a name="line-36"></a>    <span class='hs-varid'>oneifyCard</span><span class='hs-layout'>,</span> <span class='hs-varid'>oneifyDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>strictifyDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>strictifyDictDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWorkerDemand</span><span class='hs-layout'>,</span>
<a name="line-37"></a>    <span class='hs-varid'>peelCallDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>peelManyCalls</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCalledOnceDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCalledOnceDmds</span><span class='hs-layout'>,</span>
<a name="line-38"></a>    <span class='hs-varid'>addCaseBndrDmd</span><span class='hs-layout'>,</span>
<a name="line-39"></a>    <span class='hs-comment'>-- ** Extracting one-shot information</span>
<a name="line-40"></a>    <span class='hs-varid'>argOneShots</span><span class='hs-layout'>,</span> <span class='hs-varid'>argsOneShots</span><span class='hs-layout'>,</span> <span class='hs-varid'>saturatedByOneShots</span><span class='hs-layout'>,</span>
<a name="line-41"></a>
<a name="line-42"></a>    <span class='hs-comment'>-- * Demand environments</span>
<a name="line-43"></a>    <span class='hs-conid'>DmdEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyDmdEnv</span><span class='hs-layout'>,</span>
<a name="line-44"></a>    <span class='hs-varid'>keepAliveDmdEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>reuseEnv</span><span class='hs-layout'>,</span>
<a name="line-45"></a>
<a name="line-46"></a>    <span class='hs-comment'>-- * Divergence</span>
<a name="line-47"></a>    <span class='hs-conid'>Divergence</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>topDiv</span><span class='hs-layout'>,</span> <span class='hs-varid'>botDiv</span><span class='hs-layout'>,</span> <span class='hs-varid'>exnDiv</span><span class='hs-layout'>,</span> <span class='hs-varid'>lubDivergence</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDeadEndDiv</span><span class='hs-layout'>,</span>
<a name="line-48"></a>
<a name="line-49"></a>    <span class='hs-comment'>-- * Demand types</span>
<a name="line-50"></a>    <span class='hs-conid'>DmdType</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>dmdTypeDepth</span><span class='hs-layout'>,</span>
<a name="line-51"></a>    <span class='hs-comment'>-- ** Algebra</span>
<a name="line-52"></a>    <span class='hs-varid'>nopDmdType</span><span class='hs-layout'>,</span> <span class='hs-varid'>botDmdType</span><span class='hs-layout'>,</span>
<a name="line-53"></a>    <span class='hs-varid'>lubDmdType</span><span class='hs-layout'>,</span> <span class='hs-varid'>plusDmdType</span><span class='hs-layout'>,</span> <span class='hs-varid'>multDmdType</span><span class='hs-layout'>,</span>
<a name="line-54"></a>    <span class='hs-comment'>-- *** PlusDmdArg</span>
<a name="line-55"></a>    <span class='hs-conid'>PlusDmdArg</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkPlusDmdArg</span><span class='hs-layout'>,</span> <span class='hs-varid'>toPlusDmdArg</span><span class='hs-layout'>,</span>
<a name="line-56"></a>    <span class='hs-comment'>-- ** Other operations</span>
<a name="line-57"></a>    <span class='hs-varid'>peelFV</span><span class='hs-layout'>,</span> <span class='hs-varid'>findIdDemand</span><span class='hs-layout'>,</span> <span class='hs-varid'>addDemand</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitDmdTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>deferAfterPreciseException</span><span class='hs-layout'>,</span>
<a name="line-58"></a>    <span class='hs-varid'>keepAliveDmdType</span><span class='hs-layout'>,</span>
<a name="line-59"></a>
<a name="line-60"></a>    <span class='hs-comment'>-- * Demand signatures</span>
<a name="line-61"></a>    <span class='hs-conid'>StrictSig</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkStrictSigForArity</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkClosedStrictSig</span><span class='hs-layout'>,</span>
<a name="line-62"></a>    <span class='hs-varid'>splitStrictSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>strictSigDmdEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>hasDemandEnvSig</span><span class='hs-layout'>,</span>
<a name="line-63"></a>    <span class='hs-varid'>nopSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>botSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTopSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDeadEndSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDeadEndAppSig</span><span class='hs-layout'>,</span>
<a name="line-64"></a>    <span class='hs-comment'>-- ** Handling arity adjustments</span>
<a name="line-65"></a>    <span class='hs-varid'>prependArgsStrictSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>etaConvertStrictSig</span><span class='hs-layout'>,</span>
<a name="line-66"></a>
<a name="line-67"></a>    <span class='hs-comment'>-- * Demand transformers from demand signatures</span>
<a name="line-68"></a>    <span class='hs-conid'>DmdTransformer</span><span class='hs-layout'>,</span> <span class='hs-varid'>dmdTransformSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>dmdTransformDataConSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>dmdTransformDictSelSig</span><span class='hs-layout'>,</span>
<a name="line-69"></a>
<a name="line-70"></a>    <span class='hs-comment'>-- * Trim to a type shape</span>
<a name="line-71"></a>    <span class='hs-conid'>TypeShape</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>trimToType</span><span class='hs-layout'>,</span>
<a name="line-72"></a>
<a name="line-73"></a>    <span class='hs-comment'>-- * @seq@ing stuff</span>
<a name="line-74"></a>    <span class='hs-varid'>seqDemand</span><span class='hs-layout'>,</span> <span class='hs-varid'>seqDemandList</span><span class='hs-layout'>,</span> <span class='hs-varid'>seqDmdType</span><span class='hs-layout'>,</span> <span class='hs-varid'>seqStrictSig</span><span class='hs-layout'>,</span>
<a name="line-75"></a>
<a name="line-76"></a>    <span class='hs-comment'>-- * Zapping usage information</span>
<a name="line-77"></a>    <span class='hs-varid'>zapUsageDemand</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapDmdEnvSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapUsedOnceDemand</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapUsedOnceSig</span>
<a name="line-78"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-79"></a>
<a name="line-80"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-81"></a>
<a name="line-82"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-83"></a>
<a name="line-84"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Var</span><span class='hs-layout'>,</span> <span class='hs-conid'>Id</span> <span class='hs-layout'>)</span>
<a name="line-85"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var.Env</span>
<a name="line-86"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var.Set</span>
<a name="line-87"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.FM</span>
<a name="line-88"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Basic</span>
<a name="line-89"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Maybe</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>orElse</span> <span class='hs-layout'>)</span>
<a name="line-90"></a>
<a name="line-91"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Type</span>    <span class='hs-layout'>(</span> <span class='hs-conid'>Type</span> <span class='hs-layout'>)</span>
<a name="line-92"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCon</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>isNewTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>isClassTyCon</span> <span class='hs-layout'>)</span>
<a name="line-93"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.DataCon</span> <span class='hs-layout'>(</span> <span class='hs-varid'>splitDataProductType_maybe</span> <span class='hs-layout'>)</span>
<a name="line-94"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Multiplicity</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>scaledThing</span> <span class='hs-layout'>)</span>
<a name="line-95"></a>
<a name="line-96"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Binary</span>
<a name="line-97"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-98"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-100"></a>
<a name="line-101"></a><span class='hs-comment'>{-
<a name="line-102"></a>************************************************************************
<a name="line-103"></a>*                                                                      *
<a name="line-104"></a>           Card: Combining Strictness and Usage
<a name="line-105"></a>*                                                                      *
<a name="line-106"></a>************************************************************************
<a name="line-107"></a>-}</span>
<a name="line-108"></a>
<a name="line-109"></a><span class='hs-comment'>{- Note [Evaluation cardinalities]
<a name="line-110"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-111"></a>The demand analyser uses an /evaluation cardinality/ of type Card,
<a name="line-112"></a>to specify how many times a term is evaluated.  A cardinality C_lu
<a name="line-113"></a>represents an /interval/ [l..u], meaning
<a name="line-114"></a>    C_lu means evaluated /at least/ 'l' times and
<a name="line-115"></a>                         /at most/  'u' times
<a name="line-116"></a>
<a name="line-117"></a>* The lower bound corresponds to /strictness/
<a name="line-118"></a>  Hence 'l' is either 0 (lazy)
<a name="line-119"></a>                   or 1 (strict)
<a name="line-120"></a>
<a name="line-121"></a>* The upper bound corresponds to /usage/
<a name="line-122"></a>  Hence 'u' is either 0 (not used at all),
<a name="line-123"></a>                   or 1 (used at most once)
<a name="line-124"></a>                   or n (no information)
<a name="line-125"></a>
<a name="line-126"></a>Intervals describe sets, so the underlying lattice is the powerset lattice.
<a name="line-127"></a>
<a name="line-128"></a>Usually l&lt;=u, but we also have C_10, the interval [1,0], the empty interval,
<a name="line-129"></a>denoting the empty set.   This is the bottom element of the lattice.
<a name="line-130"></a>
<a name="line-131"></a>See Note [Demand notation] for the notation we use for each of the constructors.
<a name="line-132"></a>-}</span>
<a name="line-133"></a>
<a name="line-134"></a>
<a name="line-135"></a><a name="Card"></a><span class='hs-comment'>-- | Describes an interval of /evaluation cardinalities/.</span>
<a name="line-136"></a><a name="Card"></a><span class='hs-comment'>-- See Note [Evaluation cardinalities]</span>
<a name="line-137"></a><a name="Card"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Card</span>
<a name="line-138"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_00</span> <span class='hs-comment'>-- ^ {0}     Absent.</span>
<a name="line-139"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>C_01</span> <span class='hs-comment'>-- ^ {0,1}   Used at most once.</span>
<a name="line-140"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>C_0N</span> <span class='hs-comment'>-- ^ {0,1,n} Every possible cardinality; the top element.</span>
<a name="line-141"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>C_11</span> <span class='hs-comment'>-- ^ {1}     Strict and used once.</span>
<a name="line-142"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>C_1N</span> <span class='hs-comment'>-- ^ {1,n}   Strict and used (possibly) many times.</span>
<a name="line-143"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>C_10</span> <span class='hs-comment'>-- ^ {}      The empty interval; the bottom element of the lattice.</span>
<a name="line-144"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Eq</span>
<a name="line-145"></a>
<a name="line-146"></a><span class='hs-sel'>_botCard</span><span class='hs-layout'>,</span> <span class='hs-varid'>topCard</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Card</span>
<a name="line-147"></a><span class='hs-sel'>_botCard</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_10</span>
<a name="line-148"></a><a name="topCard"></a><span class='hs-definition'>topCard</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_0N</span>
<a name="line-149"></a>
<a name="line-150"></a><a name="isStrict"></a><span class='hs-comment'>-- | True &lt;=&gt; lower bound is 1.</span>
<a name="line-151"></a><span class='hs-definition'>isStrict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Card</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-152"></a><span class='hs-definition'>isStrict</span> <span class='hs-conid'>C_10</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-153"></a><span class='hs-definition'>isStrict</span> <span class='hs-conid'>C_11</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-154"></a><span class='hs-definition'>isStrict</span> <span class='hs-conid'>C_1N</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-155"></a><span class='hs-definition'>isStrict</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-156"></a>
<a name="line-157"></a><a name="isAbs"></a><span class='hs-comment'>-- | True &lt;=&gt; upper bound is 0.</span>
<a name="line-158"></a><span class='hs-definition'>isAbs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Card</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-159"></a><span class='hs-definition'>isAbs</span> <span class='hs-conid'>C_00</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-160"></a><span class='hs-definition'>isAbs</span> <span class='hs-conid'>C_10</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-comment'>-- Bottom cardinality is also absent</span>
<a name="line-161"></a><span class='hs-definition'>isAbs</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-162"></a>
<a name="line-163"></a><a name="isUsedOnce"></a><span class='hs-comment'>-- | True &lt;=&gt; upper bound is 1.</span>
<a name="line-164"></a><span class='hs-definition'>isUsedOnce</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Card</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-165"></a><span class='hs-definition'>isUsedOnce</span> <span class='hs-conid'>C_0N</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-166"></a><span class='hs-definition'>isUsedOnce</span> <span class='hs-conid'>C_1N</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-167"></a><span class='hs-definition'>isUsedOnce</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-168"></a>
<a name="line-169"></a><a name="oneifyCard"></a><span class='hs-comment'>-- | Intersect with [0,1].</span>
<a name="line-170"></a><span class='hs-definition'>oneifyCard</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Card</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Card</span>
<a name="line-171"></a><span class='hs-definition'>oneifyCard</span> <span class='hs-conid'>C_0N</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_01</span>
<a name="line-172"></a><span class='hs-definition'>oneifyCard</span> <span class='hs-conid'>C_1N</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_11</span>
<a name="line-173"></a><span class='hs-definition'>oneifyCard</span> <span class='hs-varid'>c</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c</span>
<a name="line-174"></a>
<a name="line-175"></a><a name="lubCard"></a><span class='hs-comment'>-- | Denotes '∪' on 'Card'.</span>
<a name="line-176"></a><span class='hs-definition'>lubCard</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Card</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Card</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Card</span>
<a name="line-177"></a><span class='hs-comment'>-- Handle C_10 (bot)</span>
<a name="line-178"></a><span class='hs-definition'>lubCard</span> <span class='hs-conid'>C_10</span> <span class='hs-varid'>n</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>    <span class='hs-comment'>-- bot</span>
<a name="line-179"></a><span class='hs-definition'>lubCard</span> <span class='hs-varid'>n</span>    <span class='hs-conid'>C_10</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>    <span class='hs-comment'>-- bot</span>
<a name="line-180"></a><span class='hs-comment'>-- Handle C_0N (top)</span>
<a name="line-181"></a><span class='hs-definition'>lubCard</span> <span class='hs-conid'>C_0N</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_0N</span> <span class='hs-comment'>-- top</span>
<a name="line-182"></a><span class='hs-definition'>lubCard</span> <span class='hs-keyword'>_</span>    <span class='hs-conid'>C_0N</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_0N</span> <span class='hs-comment'>-- top</span>
<a name="line-183"></a><span class='hs-comment'>-- Handle C_11</span>
<a name="line-184"></a><span class='hs-definition'>lubCard</span> <span class='hs-conid'>C_00</span> <span class='hs-conid'>C_11</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_01</span> <span class='hs-comment'>-- {0} ∪ {1} = {0,1}</span>
<a name="line-185"></a><span class='hs-definition'>lubCard</span> <span class='hs-conid'>C_11</span> <span class='hs-conid'>C_00</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_01</span> <span class='hs-comment'>-- {0} ∪ {1} = {0,1}</span>
<a name="line-186"></a><span class='hs-definition'>lubCard</span> <span class='hs-conid'>C_11</span> <span class='hs-varid'>n</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>    <span class='hs-comment'>-- {1} is a subset of all other intervals</span>
<a name="line-187"></a><span class='hs-definition'>lubCard</span> <span class='hs-varid'>n</span>    <span class='hs-conid'>C_11</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>    <span class='hs-comment'>-- {1} is a subset of all other intervals</span>
<a name="line-188"></a><span class='hs-comment'>-- Handle C_1N</span>
<a name="line-189"></a><span class='hs-definition'>lubCard</span> <span class='hs-conid'>C_1N</span> <span class='hs-conid'>C_1N</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_1N</span> <span class='hs-comment'>-- reflexivity</span>
<a name="line-190"></a><span class='hs-definition'>lubCard</span> <span class='hs-keyword'>_</span>    <span class='hs-conid'>C_1N</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_0N</span> <span class='hs-comment'>-- {0} ∪ {1,n} = top</span>
<a name="line-191"></a><span class='hs-definition'>lubCard</span> <span class='hs-conid'>C_1N</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_0N</span> <span class='hs-comment'>-- {0} ∪ {1,n} = top</span>
<a name="line-192"></a><span class='hs-comment'>-- Handle C_01</span>
<a name="line-193"></a><span class='hs-definition'>lubCard</span> <span class='hs-conid'>C_01</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_01</span> <span class='hs-comment'>-- {0} ∪ {0,1} = {0,1}</span>
<a name="line-194"></a><span class='hs-definition'>lubCard</span> <span class='hs-keyword'>_</span>    <span class='hs-conid'>C_01</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_01</span> <span class='hs-comment'>-- {0} ∪ {0,1} = {0,1}</span>
<a name="line-195"></a><span class='hs-comment'>-- Handle C_00</span>
<a name="line-196"></a><span class='hs-definition'>lubCard</span> <span class='hs-conid'>C_00</span> <span class='hs-conid'>C_00</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_00</span> <span class='hs-comment'>-- reflexivity</span>
<a name="line-197"></a>
<a name="line-198"></a><a name="plusCard"></a><span class='hs-comment'>-- | Denotes '+' on 'Card'.</span>
<a name="line-199"></a><span class='hs-definition'>plusCard</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Card</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Card</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Card</span>
<a name="line-200"></a><span class='hs-comment'>-- Handle C_00</span>
<a name="line-201"></a><span class='hs-definition'>plusCard</span> <span class='hs-conid'>C_00</span> <span class='hs-varid'>n</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>    <span class='hs-comment'>-- {0}+n = n</span>
<a name="line-202"></a><span class='hs-definition'>plusCard</span> <span class='hs-varid'>n</span>    <span class='hs-conid'>C_00</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>    <span class='hs-comment'>-- {0}+n = n</span>
<a name="line-203"></a><span class='hs-comment'>-- Handle C_10</span>
<a name="line-204"></a><span class='hs-definition'>plusCard</span> <span class='hs-conid'>C_10</span> <span class='hs-conid'>C_01</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_11</span> <span class='hs-comment'>-- These follow by applying + to lower and upper</span>
<a name="line-205"></a><span class='hs-definition'>plusCard</span> <span class='hs-conid'>C_10</span> <span class='hs-conid'>C_0N</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_1N</span> <span class='hs-comment'>-- bounds individually</span>
<a name="line-206"></a><span class='hs-definition'>plusCard</span> <span class='hs-conid'>C_10</span> <span class='hs-varid'>n</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-207"></a><span class='hs-definition'>plusCard</span> <span class='hs-conid'>C_01</span> <span class='hs-conid'>C_10</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_11</span>
<a name="line-208"></a><span class='hs-definition'>plusCard</span> <span class='hs-conid'>C_0N</span> <span class='hs-conid'>C_10</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_1N</span>
<a name="line-209"></a><span class='hs-definition'>plusCard</span> <span class='hs-varid'>n</span>    <span class='hs-conid'>C_10</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-210"></a><span class='hs-comment'>-- Handle the rest (C_01, C_0N, C_11, C_1N)</span>
<a name="line-211"></a><span class='hs-definition'>plusCard</span> <span class='hs-conid'>C_01</span> <span class='hs-conid'>C_01</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_0N</span> <span class='hs-comment'>-- The upper bound is at least 1, so upper bound of</span>
<a name="line-212"></a><span class='hs-definition'>plusCard</span> <span class='hs-conid'>C_01</span> <span class='hs-conid'>C_0N</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_0N</span> <span class='hs-comment'>-- the result must be 1+1 ~= N.</span>
<a name="line-213"></a><span class='hs-definition'>plusCard</span> <span class='hs-conid'>C_0N</span> <span class='hs-conid'>C_01</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_0N</span> <span class='hs-comment'>-- But for the lower bound we have 4 cases where</span>
<a name="line-214"></a><span class='hs-definition'>plusCard</span> <span class='hs-conid'>C_0N</span> <span class='hs-conid'>C_0N</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_0N</span> <span class='hs-comment'>-- 0+0 ~= 0 (as opposed to 1), so we match on these.</span>
<a name="line-215"></a><span class='hs-definition'>plusCard</span> <span class='hs-keyword'>_</span>    <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_1N</span> <span class='hs-comment'>-- Otherwise we return {1,n}</span>
<a name="line-216"></a>
<a name="line-217"></a><a name="multCard"></a><span class='hs-comment'>-- | Denotes '*' on 'Card'.</span>
<a name="line-218"></a><span class='hs-definition'>multCard</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Card</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Card</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Card</span>
<a name="line-219"></a><span class='hs-comment'>-- Handle C_11 (neutral element)</span>
<a name="line-220"></a><span class='hs-definition'>multCard</span> <span class='hs-conid'>C_11</span> <span class='hs-varid'>c</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c</span>
<a name="line-221"></a><span class='hs-definition'>multCard</span> <span class='hs-varid'>c</span>    <span class='hs-conid'>C_11</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c</span>
<a name="line-222"></a><span class='hs-comment'>-- Handle C_00 (annihilating element)</span>
<a name="line-223"></a><span class='hs-definition'>multCard</span> <span class='hs-conid'>C_00</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_00</span>
<a name="line-224"></a><span class='hs-definition'>multCard</span> <span class='hs-keyword'>_</span>    <span class='hs-conid'>C_00</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_00</span>
<a name="line-225"></a><span class='hs-comment'>-- Handle C_10</span>
<a name="line-226"></a><span class='hs-definition'>multCard</span> <span class='hs-conid'>C_10</span> <span class='hs-varid'>c</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isStrict</span> <span class='hs-varid'>c</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>C_10</span> <span class='hs-keyword'>else</span> <span class='hs-conid'>C_00</span>
<a name="line-227"></a><span class='hs-definition'>multCard</span> <span class='hs-varid'>c</span>    <span class='hs-conid'>C_10</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isStrict</span> <span class='hs-varid'>c</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>C_10</span> <span class='hs-keyword'>else</span> <span class='hs-conid'>C_00</span>
<a name="line-228"></a><span class='hs-comment'>-- Handle reflexive C_1N, C_01</span>
<a name="line-229"></a><span class='hs-definition'>multCard</span> <span class='hs-conid'>C_1N</span> <span class='hs-conid'>C_1N</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_1N</span>
<a name="line-230"></a><span class='hs-definition'>multCard</span> <span class='hs-conid'>C_01</span> <span class='hs-conid'>C_01</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_01</span>
<a name="line-231"></a><span class='hs-comment'>-- Handle C_0N and the rest (C_01, C_1N):</span>
<a name="line-232"></a><span class='hs-definition'>multCard</span> <span class='hs-keyword'>_</span>    <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_0N</span>
<a name="line-233"></a>
<a name="line-234"></a><span class='hs-comment'>{-
<a name="line-235"></a>************************************************************************
<a name="line-236"></a>*                                                                      *
<a name="line-237"></a>           Demand: Evaluation contexts
<a name="line-238"></a>*                                                                      *
<a name="line-239"></a>************************************************************************
<a name="line-240"></a>-}</span>
<a name="line-241"></a>
<a name="line-242"></a><a name="Demand"></a><span class='hs-comment'>-- | A demand describes a /scaled evaluation context/, e.g. how many times</span>
<a name="line-243"></a><a name="Demand"></a><span class='hs-comment'>-- and how deep the denoted thing is evaluated.</span>
<a name="line-244"></a><a name="Demand"></a><span class='hs-comment'>--</span>
<a name="line-245"></a><a name="Demand"></a><span class='hs-comment'>-- The "how many" component is represented by a 'Card'inality.</span>
<a name="line-246"></a><a name="Demand"></a><span class='hs-comment'>-- The "how deep" component is represented by a 'SubDemand'.</span>
<a name="line-247"></a><a name="Demand"></a><span class='hs-comment'>-- Examples (using Note [Demand notation]):</span>
<a name="line-248"></a><a name="Demand"></a><span class='hs-comment'>--</span>
<a name="line-249"></a><a name="Demand"></a><span class='hs-comment'>--   * 'seq' puts demand @1A@ on its first argument: It evaluates the argument</span>
<a name="line-250"></a><a name="Demand"></a><span class='hs-comment'>--     strictly (@1@), but not any deeper (@A@).</span>
<a name="line-251"></a><a name="Demand"></a><span class='hs-comment'>--   * 'fst' puts demand @1P(1L,A)@ on its argument: It evaluates the argument</span>
<a name="line-252"></a><a name="Demand"></a><span class='hs-comment'>--     pair strictly and the first component strictly, but no nested info</span>
<a name="line-253"></a><a name="Demand"></a><span class='hs-comment'>--     beyond that (@L@). Its second argument is not used at all.</span>
<a name="line-254"></a><a name="Demand"></a><span class='hs-comment'>--   * '$' puts demand @1C1(L)@ on its first argument: It calls (@C@) the</span>
<a name="line-255"></a><a name="Demand"></a><span class='hs-comment'>--     argument function with one argument, exactly once (@1@). No info</span>
<a name="line-256"></a><a name="Demand"></a><span class='hs-comment'>--     on how the result of that call is evaluated (@L@).</span>
<a name="line-257"></a><a name="Demand"></a><span class='hs-comment'>--   * 'maybe' puts demand @MCM(L)@ on its second argument: It evaluates</span>
<a name="line-258"></a><a name="Demand"></a><span class='hs-comment'>--     the argument function at most once ((M)aybe) and calls it once when</span>
<a name="line-259"></a><a name="Demand"></a><span class='hs-comment'>--     it is evaluated.</span>
<a name="line-260"></a><a name="Demand"></a><span class='hs-comment'>--   * @fst p + fst p@ puts demand @SP(SL,A)@ on @p@: It's @1P(1L,A)@</span>
<a name="line-261"></a><a name="Demand"></a><span class='hs-comment'>--     multiplied by two, so we get @S@ (used at least once, possibly multiple</span>
<a name="line-262"></a><a name="Demand"></a><span class='hs-comment'>--     times).</span>
<a name="line-263"></a><a name="Demand"></a><span class='hs-comment'>--</span>
<a name="line-264"></a><a name="Demand"></a><span class='hs-comment'>-- This data type is quite similar to @'Scaled' 'SubDemand'@, but it's scaled</span>
<a name="line-265"></a><a name="Demand"></a><span class='hs-comment'>-- by 'Card', which is an /interval/ on 'Multiplicity', the upper bound of</span>
<a name="line-266"></a><a name="Demand"></a><span class='hs-comment'>-- which could be used to infer uniqueness types.</span>
<a name="line-267"></a><a name="Demand"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Demand</span>
<a name="line-268"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varop'>!</span><span class='hs-conid'>Card</span> <span class='hs-conop'>:*</span> <span class='hs-varop'>!</span><span class='hs-conid'>SubDemand</span>
<a name="line-269"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Eq</span>
<a name="line-270"></a>
<a name="line-271"></a><a name="SubDemand"></a><span class='hs-comment'>-- | A sub-demand describes an /evaluation context/, e.g. how deep the</span>
<a name="line-272"></a><a name="SubDemand"></a><span class='hs-comment'>-- denoted thing is evaluated. See 'Demand' for examples.</span>
<a name="line-273"></a><a name="SubDemand"></a><span class='hs-comment'>--</span>
<a name="line-274"></a><a name="SubDemand"></a><span class='hs-comment'>-- The nested 'SubDemand' @d@ of a 'Call' @Cn(d)@ is /relative/ to a single such call.</span>
<a name="line-275"></a><a name="SubDemand"></a><span class='hs-comment'>-- E.g. The expression @f 1 2 + f 3 4@ puts call demand @SCS(C1(L))@ on @f@:</span>
<a name="line-276"></a><a name="SubDemand"></a><span class='hs-comment'>-- @f@ is called exactly twice (@S@), each time exactly once (@1@) with an</span>
<a name="line-277"></a><a name="SubDemand"></a><span class='hs-comment'>-- additional argument.</span>
<a name="line-278"></a><a name="SubDemand"></a><span class='hs-comment'>--</span>
<a name="line-279"></a><a name="SubDemand"></a><span class='hs-comment'>-- The nested 'Demand's @dn@ of a 'Prod' @P(d1,d2,...)@ apply /absolutely/:</span>
<a name="line-280"></a><a name="SubDemand"></a><span class='hs-comment'>-- If @dn@ is a used once demand (cf. 'isUsedOnce'), then that means that</span>
<a name="line-281"></a><a name="SubDemand"></a><span class='hs-comment'>-- the denoted sub-expression is used once in the entire evaluation context</span>
<a name="line-282"></a><a name="SubDemand"></a><span class='hs-comment'>-- described by the surrounding 'Demand'. E.g., @LP(ML)@ means that the</span>
<a name="line-283"></a><a name="SubDemand"></a><span class='hs-comment'>-- field of the denoted expression is used at most once, although the</span>
<a name="line-284"></a><a name="SubDemand"></a><span class='hs-comment'>-- entire expression might be used many times.</span>
<a name="line-285"></a><a name="SubDemand"></a><span class='hs-comment'>--</span>
<a name="line-286"></a><a name="SubDemand"></a><span class='hs-comment'>-- See Note [Call demands are relative]</span>
<a name="line-287"></a><a name="SubDemand"></a><span class='hs-comment'>-- and Note [Demand notation].</span>
<a name="line-288"></a><a name="SubDemand"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SubDemand</span>
<a name="line-289"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Poly</span> <span class='hs-varop'>!</span><span class='hs-conid'>Card</span>
<a name="line-290"></a>  <span class='hs-comment'>-- ^ Polymorphic demand, the denoted thing is evaluated arbitrarily deep,</span>
<a name="line-291"></a>  <span class='hs-comment'>-- with the specified cardinality at every level.</span>
<a name="line-292"></a>  <span class='hs-comment'>-- Expands to 'Call' via 'viewCall' and to 'Prod' via 'viewProd'.</span>
<a name="line-293"></a>  <span class='hs-comment'>--</span>
<a name="line-294"></a>  <span class='hs-comment'>-- @Poly n@ is semantically equivalent to @Prod [n :* Poly n, ...]@ or</span>
<a name="line-295"></a>  <span class='hs-comment'>-- @Call n (Poly n)@. 'mkCall' and 'mkProd' do these rewrites.</span>
<a name="line-296"></a>  <span class='hs-comment'>--</span>
<a name="line-297"></a>  <span class='hs-comment'>-- In Note [Demand notation]: @L === P(L,L,...)@ and @L === CL(L)@,</span>
<a name="line-298"></a>  <span class='hs-comment'>--                            @1 === P(1,1,...)@ and @1 === C1(1)@, and so on.</span>
<a name="line-299"></a>  <span class='hs-comment'>--</span>
<a name="line-300"></a>  <span class='hs-comment'>-- We only really use 'Poly' with 'C_10' (B), 'C_00' (A), 'C_0N' (L) and</span>
<a name="line-301"></a>  <span class='hs-comment'>-- sometimes 'C_1N' (S), but it's simpler to treat it uniformly than to</span>
<a name="line-302"></a>  <span class='hs-comment'>-- have a special constructor for each of the three cases.</span>
<a name="line-303"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Call</span> <span class='hs-varop'>!</span><span class='hs-conid'>Card</span> <span class='hs-varop'>!</span><span class='hs-conid'>SubDemand</span>
<a name="line-304"></a>  <span class='hs-comment'>-- ^ @Call n sd@ describes the evaluation context of @n@ function</span>
<a name="line-305"></a>  <span class='hs-comment'>-- applications, where every individual result is evaluated according to @sd@.</span>
<a name="line-306"></a>  <span class='hs-comment'>-- @sd@ is /relative/ to a single call, cf. Note [Call demands are relative].</span>
<a name="line-307"></a>  <span class='hs-comment'>-- Used only for values of function type. Use the smart constructor 'mkCall'</span>
<a name="line-308"></a>  <span class='hs-comment'>-- whenever possible!</span>
<a name="line-309"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Prod</span> <span class='hs-varop'>!</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span>
<a name="line-310"></a>  <span class='hs-comment'>-- ^ @Prod ds@ describes the evaluation context of a case scrutinisation</span>
<a name="line-311"></a>  <span class='hs-comment'>-- on an expression of product type, where the product components are</span>
<a name="line-312"></a>  <span class='hs-comment'>-- evaluated according to @ds@.</span>
<a name="line-313"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Eq</span>
<a name="line-314"></a>
<a name="line-315"></a><a name="poly00"></a><span class='hs-definition'>poly00</span><span class='hs-layout'>,</span> <span class='hs-varid'>poly01</span><span class='hs-layout'>,</span> <span class='hs-varid'>poly0N</span><span class='hs-layout'>,</span> <span class='hs-varid'>poly11</span><span class='hs-layout'>,</span> <span class='hs-varid'>poly1N</span><span class='hs-layout'>,</span> <span class='hs-varid'>poly10</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubDemand</span>
<a name="line-316"></a><a name="topSubDmd"></a><span class='hs-definition'>topSubDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>botSubDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>seqSubDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubDemand</span>
<a name="line-317"></a><span class='hs-definition'>poly00</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Poly</span> <span class='hs-conid'>C_00</span>
<a name="line-318"></a><a name="poly01"></a><span class='hs-definition'>poly01</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Poly</span> <span class='hs-conid'>C_01</span>
<a name="line-319"></a><a name="poly0N"></a><span class='hs-definition'>poly0N</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Poly</span> <span class='hs-conid'>C_0N</span>
<a name="line-320"></a><a name="poly11"></a><span class='hs-definition'>poly11</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Poly</span> <span class='hs-conid'>C_11</span>
<a name="line-321"></a><a name="poly1N"></a><span class='hs-definition'>poly1N</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Poly</span> <span class='hs-conid'>C_1N</span>
<a name="line-322"></a><a name="poly10"></a><span class='hs-definition'>poly10</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Poly</span> <span class='hs-conid'>C_10</span>
<a name="line-323"></a><span class='hs-definition'>topSubDmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>poly0N</span>
<a name="line-324"></a><a name="botSubDmd"></a><span class='hs-definition'>botSubDmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>poly10</span>
<a name="line-325"></a><a name="seqSubDmd"></a><span class='hs-definition'>seqSubDmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>poly00</span>
<a name="line-326"></a>
<a name="line-327"></a><a name="polyDmd"></a><span class='hs-definition'>polyDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Card</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-328"></a><span class='hs-definition'>polyDmd</span> <span class='hs-conid'>C_00</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_00</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>poly00</span>
<a name="line-329"></a><span class='hs-definition'>polyDmd</span> <span class='hs-conid'>C_01</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_01</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>poly01</span>
<a name="line-330"></a><span class='hs-definition'>polyDmd</span> <span class='hs-conid'>C_0N</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_0N</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>poly0N</span>
<a name="line-331"></a><span class='hs-definition'>polyDmd</span> <span class='hs-conid'>C_11</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_11</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>poly11</span>
<a name="line-332"></a><span class='hs-definition'>polyDmd</span> <span class='hs-conid'>C_1N</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_1N</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>poly1N</span>
<a name="line-333"></a><span class='hs-definition'>polyDmd</span> <span class='hs-conid'>C_10</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_10</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>poly10</span>
<a name="line-334"></a>
<a name="line-335"></a><a name="mkProd"></a><span class='hs-comment'>-- | A smart constructor for 'Prod', applying rewrite rules along the semantic</span>
<a name="line-336"></a><span class='hs-comment'>-- equality @Prod [polyDmd n, ...] === polyDmd n@, simplifying to 'Poly'</span>
<a name="line-337"></a><span class='hs-comment'>-- 'SubDemand's when possible. Note that this degrades boxity information! E.g. a</span>
<a name="line-338"></a><span class='hs-comment'>-- polymorphic demand will never unbox.</span>
<a name="line-339"></a><span class='hs-definition'>mkProd</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubDemand</span>
<a name="line-340"></a><span class='hs-definition'>mkProd</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqSubDmd</span>
<a name="line-341"></a><span class='hs-definition'>mkProd</span> <span class='hs-varid'>ds</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-conop'>:*</span><span class='hs-varid'>sd</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-342"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>want_to_simplify</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varop'>==</span> <span class='hs-varid'>polyDmd</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sd</span>
<a name="line-343"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Prod</span> <span class='hs-varid'>ds</span>
<a name="line-344"></a>  <span class='hs-keyword'>where</span>
<a name="line-345"></a>    <span class='hs-comment'>-- We only want to simplify absent and bottom demands and unbox the others.</span>
<a name="line-346"></a>    <span class='hs-comment'>-- See also Note [L should win] and Note [Don't optimise LP(L,L,...) to L].</span>
<a name="line-347"></a>    <span class='hs-varid'>want_to_simplify</span> <span class='hs-conid'>C_00</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-348"></a>    <span class='hs-varid'>want_to_simplify</span> <span class='hs-conid'>C_10</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-349"></a>    <span class='hs-varid'>want_to_simplify</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-350"></a>
<a name="line-351"></a><a name="viewProd"></a><span class='hs-comment'>-- | @viewProd n sd@ interprets @sd@ as a 'Prod' of arity @n@, expanding 'Poly'</span>
<a name="line-352"></a><span class='hs-comment'>-- demands as necessary.</span>
<a name="line-353"></a><span class='hs-definition'>viewProd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span>
<a name="line-354"></a><span class='hs-comment'>-- It's quite important that this function is optimised well;</span>
<a name="line-355"></a><span class='hs-comment'>-- it is used by lubSubDmd and plusSubDmd. Note the strict</span>
<a name="line-356"></a><span class='hs-comment'>-- application to 'polyDmd':</span>
<a name="line-357"></a><span class='hs-definition'>viewProd</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>Prod</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ds</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ds</span>
<a name="line-358"></a><span class='hs-comment'>-- Note the strict application to replicate: This makes sure we don't allocate</span>
<a name="line-359"></a><span class='hs-comment'>-- a thunk for it, inlines it and lets case-of-case fire at call sites.</span>
<a name="line-360"></a><span class='hs-definition'>viewProd</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>Poly</span> <span class='hs-varid'>card</span><span class='hs-layout'>)</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>replicate</span> <span class='hs-varid'>n</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>polyDmd</span> <span class='hs-varid'>card</span><span class='hs-layout'>)</span>
<a name="line-361"></a><span class='hs-definition'>viewProd</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-362"></a><span class='hs-comment'>{-# INLINE viewProd #-}</span> <span class='hs-comment'>-- we want to fuse away the replicate and the allocation</span>
<a name="line-363"></a>                        <span class='hs-comment'>-- for Arity. Otherwise, #18304 bites us.</span>
<a name="line-364"></a>
<a name="line-365"></a><a name="mkCall"></a><span class='hs-comment'>-- | A smart constructor for 'Call', applying rewrite rules along the semantic</span>
<a name="line-366"></a><span class='hs-comment'>-- equality @Call n (Poly n) === Poly n@, simplifying to 'Poly' 'SubDemand's</span>
<a name="line-367"></a><span class='hs-comment'>-- when possible.</span>
<a name="line-368"></a><span class='hs-definition'>mkCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Card</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubDemand</span>
<a name="line-369"></a><span class='hs-definition'>mkCall</span> <span class='hs-varid'>n</span> <span class='hs-varid'>cd</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Poly</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cd</span>
<a name="line-370"></a><span class='hs-definition'>mkCall</span> <span class='hs-varid'>n</span> <span class='hs-varid'>cd</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Call</span> <span class='hs-varid'>n</span> <span class='hs-varid'>cd</span>
<a name="line-371"></a>
<a name="line-372"></a><a name="viewCall"></a><span class='hs-comment'>-- | @viewCall sd@ interprets @sd@ as a 'Call', expanding 'Poly' demands as</span>
<a name="line-373"></a><span class='hs-comment'>-- necessary.</span>
<a name="line-374"></a><span class='hs-definition'>viewCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Card</span><span class='hs-layout'>,</span> <span class='hs-conid'>SubDemand</span><span class='hs-layout'>)</span>
<a name="line-375"></a><span class='hs-definition'>viewCall</span> <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-varid'>n</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span>
<a name="line-376"></a><span class='hs-definition'>viewCall</span> <span class='hs-varid'>sd</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Poly</span> <span class='hs-varid'>card</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>card</span><span class='hs-layout'>,</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span>
<a name="line-377"></a><span class='hs-definition'>viewCall</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-378"></a>
<a name="line-379"></a><a name="topDmd"></a><span class='hs-definition'>topDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>absDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>botDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>seqDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span>
<a name="line-380"></a><span class='hs-definition'>topDmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>polyDmd</span> <span class='hs-conid'>C_0N</span>
<a name="line-381"></a><a name="absDmd"></a><span class='hs-definition'>absDmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>polyDmd</span> <span class='hs-conid'>C_00</span>
<a name="line-382"></a><a name="botDmd"></a><span class='hs-definition'>botDmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>polyDmd</span> <span class='hs-conid'>C_10</span>
<a name="line-383"></a><a name="seqDmd"></a><span class='hs-definition'>seqDmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_11</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>seqSubDmd</span>
<a name="line-384"></a>
<a name="line-385"></a><a name="lubSubDmd"></a><span class='hs-comment'>-- | Denotes '∪' on 'SubDemand'.</span>
<a name="line-386"></a><span class='hs-definition'>lubSubDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubDemand</span>
<a name="line-387"></a><span class='hs-comment'>-- Handle Prod</span>
<a name="line-388"></a><span class='hs-definition'>lubSubDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Prod</span> <span class='hs-varid'>ds1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>viewProd</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>ds1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ds2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-389"></a>  <span class='hs-conid'>Prod</span> <span class='hs-varop'>$</span> <span class='hs-varid'>strictZipWith</span> <span class='hs-varid'>lubDmd</span> <span class='hs-varid'>ds2</span> <span class='hs-varid'>ds1</span> <span class='hs-comment'>-- try to fuse with ds2</span>
<a name="line-390"></a><span class='hs-comment'>-- Handle Call</span>
<a name="line-391"></a><span class='hs-definition'>lubSubDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>d1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>viewCall</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>n2</span><span class='hs-layout'>,</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-392"></a>  <span class='hs-comment'>-- See Note [Call demands are relative]</span>
<a name="line-393"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAbs</span> <span class='hs-varid'>n1</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCall</span> <span class='hs-layout'>(</span><span class='hs-varid'>lubCard</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lubSubDmd</span> <span class='hs-varid'>botSubDmd</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span>
<a name="line-394"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAbs</span> <span class='hs-varid'>n2</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCall</span> <span class='hs-layout'>(</span><span class='hs-varid'>lubCard</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lubSubDmd</span> <span class='hs-varid'>d1</span> <span class='hs-varid'>botSubDmd</span><span class='hs-layout'>)</span>
<a name="line-395"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCall</span> <span class='hs-layout'>(</span><span class='hs-varid'>lubCard</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lubSubDmd</span> <span class='hs-varid'>d1</span>        <span class='hs-varid'>d2</span><span class='hs-layout'>)</span>
<a name="line-396"></a><span class='hs-comment'>-- Handle Poly</span>
<a name="line-397"></a><span class='hs-definition'>lubSubDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Poly</span> <span class='hs-varid'>n1</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Poly</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Poly</span> <span class='hs-layout'>(</span><span class='hs-varid'>lubCard</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span>
<a name="line-398"></a><span class='hs-comment'>-- Make use of reflexivity (so we'll match the Prod or Call cases again).</span>
<a name="line-399"></a><span class='hs-definition'>lubSubDmd</span> <span class='hs-varid'>sd1</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Poly</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-varid'>sd2</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lubSubDmd</span> <span class='hs-varid'>sd2</span> <span class='hs-varid'>sd1</span>
<a name="line-400"></a><span class='hs-comment'>-- Otherwise (Call `lub` Prod) return Top</span>
<a name="line-401"></a><span class='hs-definition'>lubSubDmd</span> <span class='hs-keyword'>_</span>          <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topSubDmd</span>
<a name="line-402"></a>
<a name="line-403"></a><a name="lubDmd"></a><span class='hs-comment'>-- | Denotes '∪' on 'Demand'.</span>
<a name="line-404"></a><span class='hs-definition'>lubDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-405"></a><span class='hs-definition'>lubDmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>n1</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>sd1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>n2</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>sd2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lubCard</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>n2</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>lubSubDmd</span> <span class='hs-varid'>sd1</span> <span class='hs-varid'>sd2</span>
<a name="line-406"></a>
<a name="line-407"></a><a name="plusSubDmd"></a><span class='hs-comment'>-- | Denotes '+' on 'SubDemand'.</span>
<a name="line-408"></a><span class='hs-definition'>plusSubDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubDemand</span>
<a name="line-409"></a><span class='hs-comment'>-- Handle Prod</span>
<a name="line-410"></a><span class='hs-definition'>plusSubDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Prod</span> <span class='hs-varid'>ds1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>viewProd</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>ds1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ds2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-411"></a>  <span class='hs-conid'>Prod</span> <span class='hs-varop'>$</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>plusDmd</span> <span class='hs-varid'>ds2</span> <span class='hs-varid'>ds1</span> <span class='hs-comment'>-- try to fuse with ds2</span>
<a name="line-412"></a><span class='hs-comment'>-- Handle Call</span>
<a name="line-413"></a><span class='hs-definition'>plusSubDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>d1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>viewCall</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>n2</span><span class='hs-layout'>,</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-414"></a>  <span class='hs-comment'>-- See Note [Call demands are relative]</span>
<a name="line-415"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAbs</span> <span class='hs-varid'>n1</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCall</span> <span class='hs-layout'>(</span><span class='hs-varid'>plusCard</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lubSubDmd</span> <span class='hs-varid'>botSubDmd</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span>
<a name="line-416"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAbs</span> <span class='hs-varid'>n2</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCall</span> <span class='hs-layout'>(</span><span class='hs-varid'>plusCard</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lubSubDmd</span> <span class='hs-varid'>d1</span> <span class='hs-varid'>botSubDmd</span><span class='hs-layout'>)</span>
<a name="line-417"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCall</span> <span class='hs-layout'>(</span><span class='hs-varid'>plusCard</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lubSubDmd</span> <span class='hs-varid'>d1</span>        <span class='hs-varid'>d2</span><span class='hs-layout'>)</span>
<a name="line-418"></a><span class='hs-comment'>-- Handle Poly</span>
<a name="line-419"></a><span class='hs-definition'>plusSubDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Poly</span> <span class='hs-varid'>n1</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Poly</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Poly</span> <span class='hs-layout'>(</span><span class='hs-varid'>plusCard</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span>
<a name="line-420"></a><span class='hs-comment'>-- Make use of reflexivity (so we'll match the Prod or Call cases again).</span>
<a name="line-421"></a><span class='hs-definition'>plusSubDmd</span> <span class='hs-varid'>sd1</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Poly</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-varid'>sd2</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusSubDmd</span> <span class='hs-varid'>sd2</span> <span class='hs-varid'>sd1</span>
<a name="line-422"></a><span class='hs-comment'>-- Otherwise (Call `lub` Prod) return Top</span>
<a name="line-423"></a><span class='hs-definition'>plusSubDmd</span> <span class='hs-keyword'>_</span>          <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topSubDmd</span>
<a name="line-424"></a>
<a name="line-425"></a><a name="plusDmd"></a><span class='hs-comment'>-- | Denotes '+' on 'Demand'.</span>
<a name="line-426"></a><span class='hs-definition'>plusDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-427"></a><span class='hs-definition'>plusDmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>n1</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>sd1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>n2</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>sd2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusCard</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>n2</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>plusSubDmd</span> <span class='hs-varid'>sd1</span> <span class='hs-varid'>sd2</span>
<a name="line-428"></a>
<a name="line-429"></a><a name="multTrivial"></a><span class='hs-comment'>-- | The trivial cases of the @mult*@ functions.</span>
<a name="line-430"></a><span class='hs-comment'>-- If @multTrivial n abs a = ma@, we have the following outcomes</span>
<a name="line-431"></a><span class='hs-comment'>-- depending on @n@:</span>
<a name="line-432"></a><span class='hs-comment'>--</span>
<a name="line-433"></a><span class='hs-comment'>--   * 'C_11' =&gt; multiply by one, @ma = Just a@</span>
<a name="line-434"></a><span class='hs-comment'>--   * 'C_00', 'C_10' (e.g. @'isAbs' n@) =&gt; return the absent thing,</span>
<a name="line-435"></a><span class='hs-comment'>--      @ma = Just abs@</span>
<a name="line-436"></a><span class='hs-comment'>--   * Otherwise ('C_01', 'C_*N') it's not a trivial case, @ma = Nothing@.</span>
<a name="line-437"></a><span class='hs-definition'>multTrivial</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Card</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>
<a name="line-438"></a><span class='hs-definition'>multTrivial</span> <span class='hs-conid'>C_11</span> <span class='hs-keyword'>_</span>   <span class='hs-varid'>a</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>a</span>
<a name="line-439"></a><span class='hs-definition'>multTrivial</span> <span class='hs-varid'>n</span>    <span class='hs-varid'>abs</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAbs</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>abs</span>
<a name="line-440"></a><span class='hs-definition'>multTrivial</span> <span class='hs-keyword'>_</span>    <span class='hs-keyword'>_</span>   <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-441"></a>
<a name="line-442"></a><a name="multSubDmd"></a><span class='hs-definition'>multSubDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Card</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubDemand</span>
<a name="line-443"></a><span class='hs-definition'>multSubDmd</span> <span class='hs-varid'>n</span> <span class='hs-varid'>sd</span>
<a name="line-444"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>sd'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>multTrivial</span> <span class='hs-varid'>n</span> <span class='hs-varid'>seqSubDmd</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sd'</span>
<a name="line-445"></a><span class='hs-definition'>multSubDmd</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>Poly</span> <span class='hs-varid'>n'</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Poly</span> <span class='hs-layout'>(</span><span class='hs-varid'>multCard</span> <span class='hs-varid'>n</span> <span class='hs-varid'>n'</span><span class='hs-layout'>)</span>
<a name="line-446"></a><span class='hs-definition'>multSubDmd</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-varid'>n'</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCall</span> <span class='hs-layout'>(</span><span class='hs-varid'>multCard</span> <span class='hs-varid'>n</span> <span class='hs-varid'>n'</span><span class='hs-layout'>)</span> <span class='hs-varid'>sd</span> <span class='hs-comment'>-- See Note [Call demands are relative]</span>
<a name="line-447"></a><span class='hs-definition'>multSubDmd</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>Prod</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Prod</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>multDmd</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-448"></a>
<a name="line-449"></a><a name="multDmd"></a><span class='hs-definition'>multDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Card</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-450"></a><span class='hs-definition'>multDmd</span> <span class='hs-varid'>n</span>    <span class='hs-varid'>dmd</span>
<a name="line-451"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>dmd'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>multTrivial</span> <span class='hs-varid'>n</span> <span class='hs-varid'>absDmd</span> <span class='hs-varid'>dmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmd'</span>
<a name="line-452"></a><span class='hs-definition'>multDmd</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>multCard</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>multSubDmd</span> <span class='hs-varid'>n</span> <span class='hs-varid'>dmd</span>
<a name="line-453"></a>
<a name="line-454"></a><a name="isTopDmd"></a><span class='hs-comment'>-- | Used to suppress pretty-printing of an uninformative demand</span>
<a name="line-455"></a><span class='hs-definition'>isTopDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-456"></a><span class='hs-definition'>isTopDmd</span> <span class='hs-varid'>dmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmd</span> <span class='hs-varop'>==</span> <span class='hs-varid'>topDmd</span>
<a name="line-457"></a>
<a name="line-458"></a><a name="isAbsDmd"></a><span class='hs-definition'>isAbsDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-459"></a><span class='hs-definition'>isAbsDmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-conop'>:*</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isAbs</span> <span class='hs-varid'>n</span>
<a name="line-460"></a>
<a name="line-461"></a><a name="isStrictDmd"></a><span class='hs-comment'>-- | Contrast with isStrictUsedDmd. See Note [Strict demands]</span>
<a name="line-462"></a><span class='hs-definition'>isStrictDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-463"></a><span class='hs-definition'>isStrictDmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-conop'>:*</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isStrict</span> <span class='hs-varid'>n</span>
<a name="line-464"></a>
<a name="line-465"></a><a name="isStrUsedDmd"></a><span class='hs-comment'>-- | Not absent and used strictly. See Note [Strict demands]</span>
<a name="line-466"></a><span class='hs-definition'>isStrUsedDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-467"></a><span class='hs-definition'>isStrUsedDmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-conop'>:*</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isStrict</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isAbs</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-468"></a>
<a name="line-469"></a><a name="isSeqDmd"></a><span class='hs-definition'>isSeqDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-470"></a><span class='hs-definition'>isSeqDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>C_11</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sd</span> <span class='hs-varop'>==</span> <span class='hs-varid'>seqSubDmd</span>
<a name="line-471"></a><span class='hs-definition'>isSeqDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>C_1N</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sd</span> <span class='hs-varop'>==</span> <span class='hs-varid'>seqSubDmd</span> <span class='hs-comment'>-- I wonder if we need this case.</span>
<a name="line-472"></a><span class='hs-definition'>isSeqDmd</span> <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-473"></a>
<a name="line-474"></a><a name="isUsedOnceDmd"></a><span class='hs-comment'>-- | Is the value used at most once?</span>
<a name="line-475"></a><span class='hs-definition'>isUsedOnceDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-476"></a><span class='hs-definition'>isUsedOnceDmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-conop'>:*</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUsedOnce</span> <span class='hs-varid'>n</span>
<a name="line-477"></a>
<a name="line-478"></a><a name="isWeakDmd"></a><span class='hs-comment'>-- | We try to avoid tracking weak free variable demands in strictness</span>
<a name="line-479"></a><span class='hs-comment'>-- signatures for analysis performance reasons.</span>
<a name="line-480"></a><span class='hs-comment'>-- See Note [Lazy and unleashable free variables] in "GHC.Core.Opt.DmdAnal".</span>
<a name="line-481"></a><span class='hs-definition'>isWeakDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-482"></a><span class='hs-definition'>isWeakDmd</span> <span class='hs-varid'>dmd</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-conop'>:*</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isStrict</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>is_plus_idem_dmd</span> <span class='hs-varid'>dmd</span>
<a name="line-483"></a>  <span class='hs-keyword'>where</span>
<a name="line-484"></a>    <span class='hs-comment'>-- @is_plus_idem_* thing@ checks whether @thing `plus` thing = thing@,</span>
<a name="line-485"></a>    <span class='hs-comment'>-- e.g. if @thing@ is idempotent wrt. to @plus@.</span>
<a name="line-486"></a>    <span class='hs-varid'>is_plus_idem_card</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusCard</span> <span class='hs-varid'>c</span> <span class='hs-varid'>c</span> <span class='hs-varop'>==</span> <span class='hs-varid'>c</span>
<a name="line-487"></a>    <span class='hs-comment'>-- is_plus_idem_dmd dmd = plusDmd dmd dmd == dmd</span>
<a name="line-488"></a>    <span class='hs-varid'>is_plus_idem_dmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_plus_idem_card</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>is_plus_idem_sub_dmd</span> <span class='hs-varid'>sd</span>
<a name="line-489"></a>    <span class='hs-comment'>-- is_plus_idem_sub_dmd sd = plusSubDmd sd sd == sd</span>
<a name="line-490"></a>    <span class='hs-varid'>is_plus_idem_sub_dmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Poly</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_plus_idem_card</span> <span class='hs-varid'>n</span>
<a name="line-491"></a>    <span class='hs-varid'>is_plus_idem_sub_dmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Prod</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>is_plus_idem_dmd</span> <span class='hs-varid'>ds</span>
<a name="line-492"></a>    <span class='hs-varid'>is_plus_idem_sub_dmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_plus_idem_card</span> <span class='hs-varid'>n</span> <span class='hs-comment'>-- See Note [Call demands are relative]</span>
<a name="line-493"></a>
<a name="line-494"></a><a name="evalDmd"></a><span class='hs-definition'>evalDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span>
<a name="line-495"></a><span class='hs-definition'>evalDmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_1N</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>topSubDmd</span>
<a name="line-496"></a>
<a name="line-497"></a><a name="strictOnceApply1Dmd"></a><span class='hs-comment'>-- | First argument of 'GHC.Exts.maskAsyncExceptions#': @1C1(L)@.</span>
<a name="line-498"></a><span class='hs-comment'>-- Called exactly once.</span>
<a name="line-499"></a><span class='hs-definition'>strictOnceApply1Dmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span>
<a name="line-500"></a><span class='hs-definition'>strictOnceApply1Dmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_11</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>mkCall</span> <span class='hs-conid'>C_11</span> <span class='hs-varid'>topSubDmd</span>
<a name="line-501"></a>
<a name="line-502"></a><a name="strictManyApply1Dmd"></a><span class='hs-comment'>-- | First argument of 'GHC.Exts.atomically#': @SCS(L)@.</span>
<a name="line-503"></a><span class='hs-comment'>-- Called at least once, possibly many times.</span>
<a name="line-504"></a><span class='hs-definition'>strictManyApply1Dmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span>
<a name="line-505"></a><span class='hs-definition'>strictManyApply1Dmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_1N</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>mkCall</span> <span class='hs-conid'>C_1N</span> <span class='hs-varid'>topSubDmd</span>
<a name="line-506"></a>
<a name="line-507"></a><a name="lazyApply1Dmd"></a><span class='hs-comment'>-- | First argument of catch#: @MCM(L)@.</span>
<a name="line-508"></a><span class='hs-comment'>-- Evaluates its arg lazily, but then applies it exactly once to one argument.</span>
<a name="line-509"></a><span class='hs-definition'>lazyApply1Dmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span>
<a name="line-510"></a><span class='hs-definition'>lazyApply1Dmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_01</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>mkCall</span> <span class='hs-conid'>C_01</span> <span class='hs-varid'>topSubDmd</span>
<a name="line-511"></a>
<a name="line-512"></a><a name="lazyApply2Dmd"></a><span class='hs-comment'>-- | Second argument of catch#: @MCM(C1(L))@.</span>
<a name="line-513"></a><span class='hs-comment'>-- Calls its arg lazily, but then applies it exactly once to an additional argument.</span>
<a name="line-514"></a><span class='hs-definition'>lazyApply2Dmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span>
<a name="line-515"></a><span class='hs-definition'>lazyApply2Dmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_01</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>mkCall</span> <span class='hs-conid'>C_01</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCall</span> <span class='hs-conid'>C_11</span> <span class='hs-varid'>topSubDmd</span><span class='hs-layout'>)</span>
<a name="line-516"></a>
<a name="line-517"></a><a name="oneifyDmd"></a><span class='hs-comment'>-- | Make a 'Demand' evaluated at-most-once.</span>
<a name="line-518"></a><span class='hs-definition'>oneifyDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-519"></a><span class='hs-definition'>oneifyDmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>oneifyCard</span> <span class='hs-varid'>n</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>sd</span>
<a name="line-520"></a>
<a name="line-521"></a><a name="strictifyDmd"></a><span class='hs-comment'>-- | Make a 'Demand' evaluated at-least-once (e.g. strict).</span>
<a name="line-522"></a><span class='hs-definition'>strictifyDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-523"></a><span class='hs-definition'>strictifyDmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusCard</span> <span class='hs-conid'>C_10</span> <span class='hs-varid'>n</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>sd</span>
<a name="line-524"></a>
<a name="line-525"></a><a name="strictifyDictDmd"></a><span class='hs-comment'>-- | If the argument is a used non-newtype dictionary, give it strict demand.</span>
<a name="line-526"></a><span class='hs-comment'>-- Also split the product type &amp; demand and recur in order to similarly</span>
<a name="line-527"></a><span class='hs-comment'>-- strictify the argument's contained used non-newtype superclass dictionaries.</span>
<a name="line-528"></a><span class='hs-comment'>-- We use the demand as our recursive measure to guarantee termination.</span>
<a name="line-529"></a><span class='hs-definition'>strictifyDictDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-530"></a><span class='hs-definition'>strictifyDictDmd</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-conop'>:*</span> <span class='hs-conid'>Prod</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-531"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isAbs</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-532"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>field_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>as_non_newtype_dict</span> <span class='hs-varid'>ty</span>
<a name="line-533"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_1N</span> <span class='hs-conop'>:*</span> <span class='hs-comment'>-- main idea: ensure it's strict</span>
<a name="line-534"></a>      <span class='hs-keyword'>if</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isAbsDmd</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span>
<a name="line-535"></a>        <span class='hs-keyword'>then</span> <span class='hs-varid'>topSubDmd</span> <span class='hs-comment'>-- abstract to strict w/ arbitrary component use,</span>
<a name="line-536"></a>                         <span class='hs-comment'>-- since this smells like reboxing; results in CBV</span>
<a name="line-537"></a>                         <span class='hs-comment'>-- boxed</span>
<a name="line-538"></a>                         <span class='hs-comment'>--</span>
<a name="line-539"></a>                         <span class='hs-comment'>-- TODO revisit this if we ever do boxity analysis</span>
<a name="line-540"></a>        <span class='hs-keyword'>else</span> <span class='hs-conid'>Prod</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>strictifyDictDmd</span> <span class='hs-varid'>field_tys</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-541"></a>  <span class='hs-keyword'>where</span>
<a name="line-542"></a>    <span class='hs-comment'>-- | Return a TyCon and a list of field types if the given</span>
<a name="line-543"></a>    <span class='hs-comment'>-- type is a non-newtype dictionary type</span>
<a name="line-544"></a>    <span class='hs-varid'>as_non_newtype_dict</span> <span class='hs-varid'>ty</span>
<a name="line-545"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tycon</span><span class='hs-layout'>,</span> <span class='hs-sel'>_arg_tys</span><span class='hs-layout'>,</span> <span class='hs-sel'>_data_con</span><span class='hs-layout'>,</span> <span class='hs-varid'>map</span> <span class='hs-varid'>scaledThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>inst_con_arg_tys</span><span class='hs-layout'>)</span>
<a name="line-546"></a>          <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitDataProductType_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-547"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isNewTyCon</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span>
<a name="line-548"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>isClassTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-549"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>inst_con_arg_tys</span>
<a name="line-550"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-551"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-552"></a><span class='hs-definition'>strictifyDictDmd</span> <span class='hs-keyword'>_</span>  <span class='hs-varid'>dmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmd</span>
<a name="line-553"></a>
<a name="line-554"></a><a name="mkCalledOnceDmd"></a><span class='hs-comment'>-- | Wraps the 'SubDemand' with a one-shot call demand: @d@ -&gt; @C1(d)@.</span>
<a name="line-555"></a><span class='hs-definition'>mkCalledOnceDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubDemand</span>
<a name="line-556"></a><span class='hs-definition'>mkCalledOnceDmd</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCall</span> <span class='hs-conid'>C_11</span> <span class='hs-varid'>sd</span>
<a name="line-557"></a>
<a name="line-558"></a><a name="mkCalledOnceDmds"></a><span class='hs-comment'>-- | @mkCalledOnceDmds n d@ returns @C1(C1...(C1 d))@ where there are @n@ @C1@'s.</span>
<a name="line-559"></a><span class='hs-definition'>mkCalledOnceDmds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubDemand</span>
<a name="line-560"></a><span class='hs-definition'>mkCalledOnceDmds</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>iterate</span> <span class='hs-varid'>mkCalledOnceDmd</span> <span class='hs-varid'>sd</span> <span class='hs-varop'>!!</span> <span class='hs-varid'>arity</span>
<a name="line-561"></a>
<a name="line-562"></a><a name="peelCallDmd"></a><span class='hs-comment'>-- | Peels one call level from the sub-demand, and also returns how many</span>
<a name="line-563"></a><span class='hs-comment'>-- times we entered the lambda body.</span>
<a name="line-564"></a><span class='hs-definition'>peelCallDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Card</span><span class='hs-layout'>,</span> <span class='hs-conid'>SubDemand</span><span class='hs-layout'>)</span>
<a name="line-565"></a><span class='hs-definition'>peelCallDmd</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>viewCall</span> <span class='hs-varid'>sd</span> <span class='hs-varop'>`orElse`</span> <span class='hs-layout'>(</span><span class='hs-varid'>topCard</span><span class='hs-layout'>,</span> <span class='hs-varid'>topSubDmd</span><span class='hs-layout'>)</span>
<a name="line-566"></a>
<a name="line-567"></a><a name="peelManyCalls"></a><span class='hs-comment'>-- Peels multiple nestings of 'Call' sub-demands and also returns</span>
<a name="line-568"></a><span class='hs-comment'>-- whether it was unsaturated in the form of a 'Card'inality, denoting</span>
<a name="line-569"></a><span class='hs-comment'>-- how many times the lambda body was entered.</span>
<a name="line-570"></a><span class='hs-comment'>-- See Note [Demands from unsaturated function calls].</span>
<a name="line-571"></a><span class='hs-definition'>peelManyCalls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Card</span>
<a name="line-572"></a><span class='hs-definition'>peelManyCalls</span> <span class='hs-num'>0</span> <span class='hs-keyword'>_</span>                          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_11</span>
<a name="line-573"></a><span class='hs-comment'>-- See Note [Call demands are relative]</span>
<a name="line-574"></a><span class='hs-definition'>peelManyCalls</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>viewCall</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span> <span class='hs-varop'>`multCard`</span> <span class='hs-varid'>peelManyCalls</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>sd</span>
<a name="line-575"></a><span class='hs-definition'>peelManyCalls</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_0N</span>
<a name="line-576"></a>
<a name="line-577"></a><a name="mkWorkerDemand"></a><span class='hs-comment'>-- See Note [Demand on the worker] in GHC.Core.Opt.WorkWrap</span>
<a name="line-578"></a><span class='hs-definition'>mkWorkerDemand</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-579"></a><span class='hs-definition'>mkWorkerDemand</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_01</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n</span>
<a name="line-580"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>go</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topSubDmd</span>
<a name="line-581"></a>        <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Call</span> <span class='hs-conid'>C_01</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-582"></a>
<a name="line-583"></a><a name="addCaseBndrDmd"></a><span class='hs-definition'>addCaseBndrDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubDemand</span> <span class='hs-comment'>-- On the case binder</span>
<a name="line-584"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- On the components of the constructor</span>
<a name="line-585"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- Final demands for the components of the constructor</span>
<a name="line-586"></a><span class='hs-definition'>addCaseBndrDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Poly</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>alt_dmds</span>
<a name="line-587"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAbs</span> <span class='hs-varid'>n</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alt_dmds</span>
<a name="line-588"></a><span class='hs-comment'>-- See Note [Demand on case-alternative binders]</span>
<a name="line-589"></a><span class='hs-definition'>addCaseBndrDmd</span> <span class='hs-varid'>sd</span>       <span class='hs-varid'>alt_dmds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>plusDmd</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>alt_dmds</span> <span class='hs-comment'>-- fuse ds!</span>
<a name="line-590"></a>  <span class='hs-keyword'>where</span>
<a name="line-591"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>viewProd</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>alt_dmds</span><span class='hs-layout'>)</span> <span class='hs-varid'>sd</span> <span class='hs-comment'>-- Guaranteed not to be a call</span>
<a name="line-592"></a>
<a name="line-593"></a><a name="argsOneShots"></a><span class='hs-definition'>argsOneShots</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>OneShotInfo</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-594"></a><span class='hs-comment'>-- ^ See Note [Computing one-shot info]</span>
<a name="line-595"></a><span class='hs-definition'>argsOneShots</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arg_ds</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>n_val_args</span>
<a name="line-596"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>unsaturated_call</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-597"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg_ds</span>
<a name="line-598"></a>  <span class='hs-keyword'>where</span>
<a name="line-599"></a>    <span class='hs-varid'>unsaturated_call</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_ds</span> <span class='hs-varop'>`lengthExceeds`</span> <span class='hs-varid'>n_val_args</span>
<a name="line-600"></a>
<a name="line-601"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-602"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_d</span> <span class='hs-conop'>:</span> <span class='hs-varid'>arg_ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>argOneShots</span> <span class='hs-varid'>arg_d</span> <span class='hs-varop'>`cons`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg_ds</span>
<a name="line-603"></a>
<a name="line-604"></a>    <span class='hs-comment'>-- Avoid list tail like [ [], [], [] ]</span>
<a name="line-605"></a>    <span class='hs-varid'>cons</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-606"></a>    <span class='hs-varid'>cons</span> <span class='hs-varid'>a</span>  <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span>
<a name="line-607"></a>
<a name="line-608"></a><a name="argOneShots"></a><span class='hs-definition'>argOneShots</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span>          <span class='hs-comment'>-- ^ depending on saturation</span>
<a name="line-609"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>OneShotInfo</span><span class='hs-keyglyph'>]</span>
<a name="line-610"></a><span class='hs-comment'>-- ^ See Note [Computing one-shot info]</span>
<a name="line-611"></a><span class='hs-definition'>argOneShots</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>sd</span> <span class='hs-comment'>-- See Note [Call demands are relative]</span>
<a name="line-612"></a>  <span class='hs-keyword'>where</span>
<a name="line-613"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-varid'>n</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span>
<a name="line-614"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUsedOnce</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OneShotLam</span>    <span class='hs-conop'>:</span> <span class='hs-varid'>go</span> <span class='hs-varid'>sd</span>
<a name="line-615"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoOneShotInfo</span> <span class='hs-conop'>:</span> <span class='hs-varid'>go</span> <span class='hs-varid'>sd</span>
<a name="line-616"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-617"></a>
<a name="line-618"></a><a name="saturatedByOneShots"></a><span class='hs-comment'>-- |</span>
<a name="line-619"></a><span class='hs-comment'>-- @saturatedByOneShots n CM(CM(...)) = True@</span>
<a name="line-620"></a><span class='hs-comment'>--   &lt;=&gt;</span>
<a name="line-621"></a><span class='hs-comment'>-- There are at least n nested CM(..) calls.</span>
<a name="line-622"></a><span class='hs-comment'>-- See Note [Demand on the worker] in GHC.Core.Opt.WorkWrap</span>
<a name="line-623"></a><span class='hs-definition'>saturatedByOneShots</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-624"></a><span class='hs-definition'>saturatedByOneShots</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUsedOnce</span> <span class='hs-layout'>(</span><span class='hs-varid'>peelManyCalls</span> <span class='hs-varid'>n</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span>
<a name="line-625"></a>
<a name="line-626"></a><span class='hs-comment'>{- Note [Strict demands]
<a name="line-627"></a>~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-628"></a>'isStrUsedDmd' returns true only of demands that are
<a name="line-629"></a>   both strict
<a name="line-630"></a>   and  used
<a name="line-631"></a>
<a name="line-632"></a>In particular, it is False for &lt;B&gt; (i.e. strict and not used,
<a name="line-633"></a>cardinality C_10), which can and does arise in, say (#7319)
<a name="line-634"></a>   f x = raise# &lt;some exception&gt;
<a name="line-635"></a>Then 'x' is not used, so f gets strictness &lt;B&gt; -&gt; .
<a name="line-636"></a>Now the w/w generates
<a name="line-637"></a>   fx = let x &lt;B&gt; = absentError "unused"
<a name="line-638"></a>        in raise &lt;some exception&gt;
<a name="line-639"></a>At this point we really don't want to convert to
<a name="line-640"></a>   fx = case absentError "unused" of x -&gt; raise &lt;some exception&gt;
<a name="line-641"></a>Since the program is going to diverge, this swaps one error for another,
<a name="line-642"></a>but it's really a bad idea to *ever* evaluate an absent argument.
<a name="line-643"></a>In #7319 we get
<a name="line-644"></a>   T7319.exe: Oops!  Entered absent arg w_s1Hd{v} [lid] [base:GHC.Base.String{tc 36u}]
<a name="line-645"></a>
<a name="line-646"></a>Note [Call demands are relative]
<a name="line-647"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-648"></a>The expression @if b then 0 else f 1 2 + f 3 4@ uses @f@ according to the demand
<a name="line-649"></a>@LCL(C1(P(L)))@, meaning
<a name="line-650"></a>
<a name="line-651"></a>  "f is called multiple times or not at all (CL), but each time it
<a name="line-652"></a>   is called, it's called with *exactly one* (C1) more argument.
<a name="line-653"></a>   Whenever it is called with two arguments, we have no info on how often
<a name="line-654"></a>   the field of the product result is used (L)."
<a name="line-655"></a>
<a name="line-656"></a>So the 'SubDemand' nested in a 'Call' demand is relative to exactly one call.
<a name="line-657"></a>And that extends to the information we have how its results are used in each
<a name="line-658"></a>call site. Consider (#18903)
<a name="line-659"></a>
<a name="line-660"></a>  h :: Int -&gt; Int
<a name="line-661"></a>  h m =
<a name="line-662"></a>    let g :: Int -&gt; (Int,Int)
<a name="line-663"></a>        g 1 = (m, 0)
<a name="line-664"></a>        g n = (2 * n, 2 `div` n)
<a name="line-665"></a>        {-# NOINLINE g #-}
<a name="line-666"></a>    in case m of
<a name="line-667"></a>      1 -&gt; 0
<a name="line-668"></a>      2 -&gt; snd (g m)
<a name="line-669"></a>      _ -&gt; uncurry (+) (g m)
<a name="line-670"></a>
<a name="line-671"></a>We want to give @g@ the demand @MCM(P(MP(L),1P(L)))@, so we see that in each call
<a name="line-672"></a>site of @g@, we are strict in the second component of the returned pair.
<a name="line-673"></a>
<a name="line-674"></a>This relative cardinality leads to an otherwise unexpected call to 'lubSubDmd'
<a name="line-675"></a>in 'plusSubDmd', but if you do the math it's just the right thing.
<a name="line-676"></a>
<a name="line-677"></a>There's one more subtlety: Since the nested demand is relative to exactly one
<a name="line-678"></a>call, in the case where we have *at most zero calls* (e.g. CA(...)), the premise
<a name="line-679"></a>is hurt and we can assume that the nested demand is 'botSubDmd'. That ensures
<a name="line-680"></a>that @g@ above actually gets the @1P(L)@ demand on its second pair component,
<a name="line-681"></a>rather than the lazy @MP(L)@ if we 'lub'bed with an absent demand.
<a name="line-682"></a>
<a name="line-683"></a>Demand on case-alternative binders]
<a name="line-684"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-685"></a>The demand on a binder in a case alternative comes
<a name="line-686"></a>  (a) From the demand on the binder itself
<a name="line-687"></a>  (b) From the demand on the case binder
<a name="line-688"></a>Forgetting (b) led directly to #10148.
<a name="line-689"></a>
<a name="line-690"></a>Example. Source code:
<a name="line-691"></a>  f x@(p,_) = if p then foo x else True
<a name="line-692"></a>
<a name="line-693"></a>  foo (p,True) = True
<a name="line-694"></a>  foo (p,q)    = foo (q,p)
<a name="line-695"></a>
<a name="line-696"></a>After strictness analysis:
<a name="line-697"></a>  f = \ (x_an1 [Dmd=1P(1L,ML)] :: (Bool, Bool)) -&gt;
<a name="line-698"></a>      case x_an1
<a name="line-699"></a>      of wild_X7 [Dmd=MP(ML,ML)]
<a name="line-700"></a>      { (p_an2 [Dmd=1L], ds_dnz [Dmd=A]) -&gt;
<a name="line-701"></a>      case p_an2 of _ {
<a name="line-702"></a>        False -&gt; GHC.Types.True;
<a name="line-703"></a>        True -&gt; foo wild_X7 }
<a name="line-704"></a>
<a name="line-705"></a>It's true that ds_dnz is *itself* absent, but the use of wild_X7 means
<a name="line-706"></a>that it is very much alive and demanded.  See #10148 for how the
<a name="line-707"></a>consequences play out.
<a name="line-708"></a>
<a name="line-709"></a>This is needed even for non-product types, in case the case-binder
<a name="line-710"></a>is used but the components of the case alternative are not.
<a name="line-711"></a>
<a name="line-712"></a>Note [Don't optimise LP(L,L,...) to L]
<a name="line-713"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-714"></a>These two SubDemands:
<a name="line-715"></a>   LP(L,L) (@Prod [topDmd, topDmd]@)   and   L (@topSubDmd@)
<a name="line-716"></a>are semantically equivalent, but we do not turn the former into
<a name="line-717"></a>the latter, for a regrettable-subtle reason.  Consider
<a name="line-718"></a>  f p1@(x,y) = (y,x)
<a name="line-719"></a>  g h p2@(_,_) = h p
<a name="line-720"></a>We want to unbox @p1@ of @f@, but not @p2@ of @g@, because @g@ only uses
<a name="line-721"></a>@p2@ boxed and we'd have to rebox. So we give @p1@ demand LP(L,L) and @p2@
<a name="line-722"></a>demand @L@ to inform 'GHC.Core.Opt.WorkWrap.Utils.wantToUnbox', which will
<a name="line-723"></a>say "unbox" for @p1@ and "don't unbox" for @p2@.
<a name="line-724"></a>
<a name="line-725"></a>So the solution is: don't aggressively collapse @Prod [topDmd, topDmd]@ to
<a name="line-726"></a>@topSubDmd@; instead leave it as-is. In effect we are using the UseDmd to do a
<a name="line-727"></a>little bit of boxity analysis.  Not very nice.
<a name="line-728"></a>
<a name="line-729"></a>Note [L should win]
<a name="line-730"></a>~~~~~~~~~~~~~~~~~~~
<a name="line-731"></a>Both in 'lubSubDmd' and 'plusSubDmd' we want @L `plusSubDmd` LP(..))@ to be @L@.
<a name="line-732"></a>Why?  Because U carries the implication the whole thing is used, box and all,
<a name="line-733"></a>so we don't want to w/w it, cf. Note [Don't optimise LP(L,L,...) to L].
<a name="line-734"></a>If we use it both boxed and unboxed, then we are definitely using the box,
<a name="line-735"></a>and so we are quite likely to pay a reboxing cost. So we make U win here.
<a name="line-736"></a>TODO: Investigate why since 2013, we don't.
<a name="line-737"></a>
<a name="line-738"></a>Example is in the Buffer argument of GHC.IO.Handle.Internals.writeCharBuffer
<a name="line-739"></a>
<a name="line-740"></a>Baseline: (A) Not making Used win (LP(..) wins)
<a name="line-741"></a>Compare with: (B) making Used win for lub and both
<a name="line-742"></a>
<a name="line-743"></a>            Min          -0.3%     -5.6%    -10.7%    -11.0%    -33.3%
<a name="line-744"></a>            Max          +0.3%    +45.6%    +11.5%    +11.5%     +6.9%
<a name="line-745"></a> Geometric Mean          -0.0%     +0.5%     +0.3%     +0.2%     -0.8%
<a name="line-746"></a>
<a name="line-747"></a>Baseline: (B) Making L win for both lub and both
<a name="line-748"></a>Compare with: (C) making L win for plus, but LP(..) win for lub
<a name="line-749"></a>
<a name="line-750"></a>            Min          -0.1%     -0.3%     -7.9%     -8.0%     -6.5%
<a name="line-751"></a>            Max          +0.1%     +1.0%    +21.0%    +21.0%     +0.5%
<a name="line-752"></a> Geometric Mean          +0.0%     +0.0%     -0.0%     -0.1%     -0.1%
<a name="line-753"></a>
<a name="line-754"></a>Note [Computing one-shot info]
<a name="line-755"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-756"></a>Consider a call
<a name="line-757"></a>    f (\pqr. e1) (\xyz. e2) e3
<a name="line-758"></a>where f has usage signature
<a name="line-759"></a>    &lt;CM(CL(CM(L)))&gt;&lt;CM(L)&gt;&lt;L&gt;
<a name="line-760"></a>Then argsOneShots returns a [[OneShotInfo]] of
<a name="line-761"></a>    [[OneShot,NoOneShotInfo,OneShot],  [OneShot]]
<a name="line-762"></a>The occurrence analyser propagates this one-shot infor to the
<a name="line-763"></a>binders \pqr and \xyz;
<a name="line-764"></a>see Note [Use one-shot information] in "GHC.Core.Opt.OccurAnal".
<a name="line-765"></a>-}</span>
<a name="line-766"></a>
<a name="line-767"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-768"></a>*                                                                      *
<a name="line-769"></a>                 Divergence: Whether evaluation surely diverges
<a name="line-770"></a>*                                                                      *
<a name="line-771"></a>********************************************************************* -}</span>
<a name="line-772"></a>
<a name="line-773"></a><a name="Divergence"></a><span class='hs-comment'>-- | 'Divergence' characterises whether something surely diverges.</span>
<a name="line-774"></a><a name="Divergence"></a><span class='hs-comment'>-- Models a subset lattice of the following exhaustive set of divergence</span>
<a name="line-775"></a><a name="Divergence"></a><span class='hs-comment'>-- results:</span>
<a name="line-776"></a><a name="Divergence"></a><span class='hs-comment'>--</span>
<a name="line-777"></a><a name="Divergence"></a><span class='hs-comment'>-- [n] nontermination (e.g. loops)</span>
<a name="line-778"></a><a name="Divergence"></a><span class='hs-comment'>-- [i] throws imprecise exception</span>
<a name="line-779"></a><a name="Divergence"></a><span class='hs-comment'>-- [p] throws precise exceTtion</span>
<a name="line-780"></a><a name="Divergence"></a><span class='hs-comment'>-- [c] converges (reduces to WHNF).</span>
<a name="line-781"></a><a name="Divergence"></a><span class='hs-comment'>--</span>
<a name="line-782"></a><a name="Divergence"></a><span class='hs-comment'>-- The different lattice elements correspond to different subsets, indicated by</span>
<a name="line-783"></a><a name="Divergence"></a><span class='hs-comment'>-- juxtaposition of indicators (e.g. __nc__ definitely doesn't throw an</span>
<a name="line-784"></a><a name="Divergence"></a><span class='hs-comment'>-- exception, and may or may not reduce to WHNF).</span>
<a name="line-785"></a><a name="Divergence"></a><span class='hs-comment'>--</span>
<a name="line-786"></a><a name="Divergence"></a><span class='hs-comment'>-- @</span>
<a name="line-787"></a><a name="Divergence"></a><span class='hs-comment'>--             Dunno (nipc)</span>
<a name="line-788"></a><a name="Divergence"></a><span class='hs-comment'>--                  |</span>
<a name="line-789"></a><a name="Divergence"></a><span class='hs-comment'>--            ExnOrDiv (nip)</span>
<a name="line-790"></a><a name="Divergence"></a><span class='hs-comment'>--                  |</span>
<a name="line-791"></a><a name="Divergence"></a><span class='hs-comment'>--            Diverges (ni)</span>
<a name="line-792"></a><a name="Divergence"></a><span class='hs-comment'>-- @</span>
<a name="line-793"></a><a name="Divergence"></a><span class='hs-comment'>--</span>
<a name="line-794"></a><a name="Divergence"></a><span class='hs-comment'>-- As you can see, we don't distinguish __n__ and __i__.</span>
<a name="line-795"></a><a name="Divergence"></a><span class='hs-comment'>-- See Note [Precise exceptions and strictness analysis] for why __p__ is so</span>
<a name="line-796"></a><a name="Divergence"></a><span class='hs-comment'>-- special compared to __i__.</span>
<a name="line-797"></a><a name="Divergence"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Divergence</span>
<a name="line-798"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Diverges</span> <span class='hs-comment'>-- ^ Definitely throws an imprecise exception or diverges.</span>
<a name="line-799"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ExnOrDiv</span> <span class='hs-comment'>-- ^ Definitely throws a *precise* exception, an imprecise</span>
<a name="line-800"></a>             <span class='hs-comment'>--   exception or diverges. Never converges, hence 'isDeadEndDiv'!</span>
<a name="line-801"></a>             <span class='hs-comment'>--   See scenario 1 in Note [Precise exceptions and strictness analysis].</span>
<a name="line-802"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Dunno</span>    <span class='hs-comment'>-- ^ Might diverge, throw any kind of exception or converge.</span>
<a name="line-803"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Eq</span>
<a name="line-804"></a>
<a name="line-805"></a><a name="lubDivergence"></a><span class='hs-definition'>lubDivergence</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Divergence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Divergence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Divergence</span>
<a name="line-806"></a><span class='hs-definition'>lubDivergence</span> <span class='hs-conid'>Diverges</span> <span class='hs-varid'>div</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>div</span>
<a name="line-807"></a><span class='hs-definition'>lubDivergence</span> <span class='hs-varid'>div</span>      <span class='hs-conid'>Diverges</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>div</span>
<a name="line-808"></a><span class='hs-definition'>lubDivergence</span> <span class='hs-conid'>ExnOrDiv</span> <span class='hs-conid'>ExnOrDiv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ExnOrDiv</span>
<a name="line-809"></a><span class='hs-definition'>lubDivergence</span> <span class='hs-keyword'>_</span>        <span class='hs-keyword'>_</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Dunno</span>
<a name="line-810"></a><span class='hs-comment'>-- This needs to commute with defaultFvDmd, i.e.</span>
<a name="line-811"></a><span class='hs-comment'>-- defaultFvDmd (r1 `lubDivergence` r2) = defaultFvDmd r1 `lubDmd` defaultFvDmd r2</span>
<a name="line-812"></a><span class='hs-comment'>-- (See Note [Default demand on free variables and arguments] for why)</span>
<a name="line-813"></a>
<a name="line-814"></a><a name="plusDivergence"></a><span class='hs-comment'>-- | See Note [Asymmetry of 'plus*'], which concludes that 'plusDivergence'</span>
<a name="line-815"></a><span class='hs-comment'>-- needs to be symmetric.</span>
<a name="line-816"></a><span class='hs-comment'>-- Strictly speaking, we should have @plusDivergence Dunno Diverges = ExnOrDiv@.</span>
<a name="line-817"></a><span class='hs-comment'>-- But that regresses in too many places (every infinite loop, basically) to be</span>
<a name="line-818"></a><span class='hs-comment'>-- worth it and is only relevant in higher-order scenarios</span>
<a name="line-819"></a><span class='hs-comment'>-- (e.g. Divergence of @f (throwIO blah)@).</span>
<a name="line-820"></a><span class='hs-comment'>-- So 'plusDivergence' currently is 'glbDivergence', really.</span>
<a name="line-821"></a><span class='hs-definition'>plusDivergence</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Divergence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Divergence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Divergence</span>
<a name="line-822"></a><span class='hs-definition'>plusDivergence</span> <span class='hs-conid'>Dunno</span>    <span class='hs-conid'>Dunno</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Dunno</span>
<a name="line-823"></a><span class='hs-definition'>plusDivergence</span> <span class='hs-conid'>Diverges</span> <span class='hs-keyword'>_</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Diverges</span>
<a name="line-824"></a><span class='hs-definition'>plusDivergence</span> <span class='hs-keyword'>_</span>        <span class='hs-conid'>Diverges</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Diverges</span>
<a name="line-825"></a><span class='hs-definition'>plusDivergence</span> <span class='hs-keyword'>_</span>        <span class='hs-keyword'>_</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ExnOrDiv</span>
<a name="line-826"></a>
<a name="line-827"></a><a name="multDivergence"></a><span class='hs-comment'>-- | In a non-strict scenario, we might not force the Divergence, in which case</span>
<a name="line-828"></a><span class='hs-comment'>-- we might converge, hence Dunno.</span>
<a name="line-829"></a><span class='hs-definition'>multDivergence</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Card</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Divergence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Divergence</span>
<a name="line-830"></a><span class='hs-definition'>multDivergence</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isStrict</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Dunno</span>
<a name="line-831"></a><span class='hs-definition'>multDivergence</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>d</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span>
<a name="line-832"></a>
<a name="line-833"></a><a name="topDiv"></a><span class='hs-definition'>topDiv</span><span class='hs-layout'>,</span> <span class='hs-varid'>exnDiv</span><span class='hs-layout'>,</span> <span class='hs-varid'>botDiv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Divergence</span>
<a name="line-834"></a><span class='hs-definition'>topDiv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Dunno</span>
<a name="line-835"></a><a name="exnDiv"></a><span class='hs-definition'>exnDiv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ExnOrDiv</span>
<a name="line-836"></a><a name="botDiv"></a><span class='hs-definition'>botDiv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Diverges</span>
<a name="line-837"></a>
<a name="line-838"></a><a name="isDeadEndDiv"></a><span class='hs-comment'>-- | True if the 'Divergence' indicates that evaluation will not return.</span>
<a name="line-839"></a><span class='hs-comment'>-- See Note [Dead ends].</span>
<a name="line-840"></a><span class='hs-definition'>isDeadEndDiv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Divergence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-841"></a><span class='hs-definition'>isDeadEndDiv</span> <span class='hs-conid'>Diverges</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-842"></a><span class='hs-definition'>isDeadEndDiv</span> <span class='hs-conid'>ExnOrDiv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-843"></a><span class='hs-definition'>isDeadEndDiv</span> <span class='hs-conid'>Dunno</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-844"></a>
<a name="line-845"></a><a name="defaultFvDmd"></a><span class='hs-comment'>-- See Notes [Default demand on free variables and arguments]</span>
<a name="line-846"></a><span class='hs-comment'>-- and Scenario 1 in [Precise exceptions and strictness analysis]</span>
<a name="line-847"></a><span class='hs-definition'>defaultFvDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Divergence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-848"></a><span class='hs-definition'>defaultFvDmd</span> <span class='hs-conid'>Dunno</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>absDmd</span>
<a name="line-849"></a><span class='hs-definition'>defaultFvDmd</span> <span class='hs-conid'>ExnOrDiv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>absDmd</span> <span class='hs-comment'>-- This is the whole point of ExnOrDiv!</span>
<a name="line-850"></a><span class='hs-definition'>defaultFvDmd</span> <span class='hs-conid'>Diverges</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>botDmd</span> <span class='hs-comment'>-- Diverges</span>
<a name="line-851"></a>
<a name="line-852"></a><a name="defaultArgDmd"></a><span class='hs-definition'>defaultArgDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Divergence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-853"></a><span class='hs-comment'>-- TopRes and BotRes are polymorphic, so that</span>
<a name="line-854"></a><span class='hs-comment'>--      BotRes === (Bot -&gt; BotRes) === ...</span>
<a name="line-855"></a><span class='hs-comment'>--      TopRes === (Top -&gt; TopRes) === ...</span>
<a name="line-856"></a><span class='hs-comment'>-- This function makes that concrete</span>
<a name="line-857"></a><span class='hs-comment'>-- Also see Note [Default demand on free variables and arguments]</span>
<a name="line-858"></a><span class='hs-definition'>defaultArgDmd</span> <span class='hs-conid'>Dunno</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topDmd</span>
<a name="line-859"></a><span class='hs-comment'>-- NB: not botDmd! We don't want to mask the precise exception by forcing the</span>
<a name="line-860"></a><span class='hs-comment'>-- argument. But it is still absent.</span>
<a name="line-861"></a><span class='hs-definition'>defaultArgDmd</span> <span class='hs-conid'>ExnOrDiv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>absDmd</span>
<a name="line-862"></a><span class='hs-definition'>defaultArgDmd</span> <span class='hs-conid'>Diverges</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>botDmd</span>
<a name="line-863"></a>
<a name="line-864"></a><span class='hs-comment'>{- Note [Precise vs imprecise exceptions]
<a name="line-865"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-866"></a>An exception is considered to be /precise/ when it is thrown by the 'raiseIO#'
<a name="line-867"></a>primop. It follows that all other primops (such as 'raise#' or
<a name="line-868"></a>division-by-zero) throw /imprecise/ exceptions. Note that the actual type of
<a name="line-869"></a>the exception thrown doesn't have any impact!
<a name="line-870"></a>
<a name="line-871"></a>GHC undertakes some effort not to apply an optimisation that would mask a
<a name="line-872"></a>/precise/ exception with some other source of nontermination, such as genuine
<a name="line-873"></a>divergence or an imprecise exception, so that the user can reliably
<a name="line-874"></a>intercept the precise exception with a catch handler before and after
<a name="line-875"></a>optimisations.
<a name="line-876"></a>
<a name="line-877"></a>See also the wiki page on precise exceptions:
<a name="line-878"></a>https://gitlab.haskell.org/ghc/ghc/wikis/exceptions/precise-exceptions
<a name="line-879"></a>Section 5 of "Tackling the awkward squad" talks about semantic concerns.
<a name="line-880"></a>Imprecise exceptions are actually more interesting than precise ones (which are
<a name="line-881"></a>fairly standard) from the perspective of semantics. See the paper "A Semantics
<a name="line-882"></a>for Imprecise Exceptions" for more details.
<a name="line-883"></a>
<a name="line-884"></a>Note [Dead ends]
<a name="line-885"></a>~~~~~~~~~~~~~~~~
<a name="line-886"></a>We call an expression that either diverges or throws a precise or imprecise
<a name="line-887"></a>exception a "dead end". We used to call such an expression just "bottoming",
<a name="line-888"></a>but with the measures we take to preserve precise exception semantics
<a name="line-889"></a>(see Note [Precise exceptions and strictness analysis]), that is no longer
<a name="line-890"></a>accurate: 'exnDiv' is no longer the bottom of the Divergence lattice.
<a name="line-891"></a>
<a name="line-892"></a>Yet externally to demand analysis, we mostly care about being able to drop dead
<a name="line-893"></a>code etc., which is all due to the property that such an expression never
<a name="line-894"></a>returns, hence we consider throwing a precise exception to be a dead end.
<a name="line-895"></a>See also 'isDeadEndDiv'.
<a name="line-896"></a>
<a name="line-897"></a>Note [Precise exceptions and strictness analysis]
<a name="line-898"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-899"></a>We have to take care to preserve precise exception semantics in strictness
<a name="line-900"></a>analysis (#17676). There are two scenarios that need careful treatment.
<a name="line-901"></a>
<a name="line-902"></a>The fixes were discussed at
<a name="line-903"></a>https://gitlab.haskell.org/ghc/ghc/wikis/fixing-precise-exceptions
<a name="line-904"></a>
<a name="line-905"></a>Recall that raiseIO# raises a *precise* exception, in contrast to raise# which
<a name="line-906"></a>raises an *imprecise* exception. See Note [Precise vs imprecise exceptions].
<a name="line-907"></a>
<a name="line-908"></a>Scenario 1: Precise exceptions in case alternatives
<a name="line-909"></a>---------------------------------------------------
<a name="line-910"></a>Unlike raise# (which returns botDiv), we want raiseIO# to return exnDiv.
<a name="line-911"></a>Here's why. Consider this example from #13380 (similarly #17676):
<a name="line-912"></a>  f x y | x&gt;0       = raiseIO# Exc
<a name="line-913"></a>        | y&gt;0       = return 1
<a name="line-914"></a>        | otherwise = return 2
<a name="line-915"></a>Is 'f' strict in 'y'? One might be tempted to say yes! But that plays fast and
<a name="line-916"></a>loose with the precise exception; after optimisation, (f 42 (error "boom"))
<a name="line-917"></a>turns from throwing the precise Exc to throwing the imprecise user error
<a name="line-918"></a>"boom". So, the defaultFvDmd of raiseIO# should be lazy (topDmd), which can be
<a name="line-919"></a>achieved by giving it divergence exnDiv.
<a name="line-920"></a>See Note [Default demand on free variables and arguments].
<a name="line-921"></a>
<a name="line-922"></a>Why don't we just give it topDiv instead of introducing exnDiv?
<a name="line-923"></a>Because then the simplifier will fail to discard raiseIO#'s continuation in
<a name="line-924"></a>  case raiseIO# x s of { (# s', r #) -&gt; &lt;BIG&gt; }
<a name="line-925"></a>which we'd like to optimise to
<a name="line-926"></a>  case raiseIO# x s of {}
<a name="line-927"></a>Hence we came up with exnDiv. The default FV demand of exnDiv is lazy (and
<a name="line-928"></a>its default arg dmd is absent), but otherwise (in terms of 'isDeadEndDiv') it
<a name="line-929"></a>behaves exactly as botDiv, so that dead code elimination works as expected.
<a name="line-930"></a>This is tracked by T13380b.
<a name="line-931"></a>
<a name="line-932"></a>Scenario 2: Precise exceptions in case scrutinees
<a name="line-933"></a>-------------------------------------------------
<a name="line-934"></a>Consider (more complete examples in #148, #1592, testcase strun003)
<a name="line-935"></a>
<a name="line-936"></a>  case foo x s of { (# s', r #) -&gt; y }
<a name="line-937"></a>
<a name="line-938"></a>Is this strict in 'y'? Often not! If @foo x s@ might throw a precise exception
<a name="line-939"></a>(ultimately via raiseIO#), then we must not force 'y', which may fail to
<a name="line-940"></a>terminate or throw an imprecise exception, until we have performed @foo x s@.
<a name="line-941"></a>
<a name="line-942"></a>So we have to 'deferAfterPreciseException' (which 'lub's with 'exnDmdType' to
<a name="line-943"></a>model the exceptional control flow) when @foo x s@ may throw a precise
<a name="line-944"></a>exception. Motivated by T13380{d,e,f}.
<a name="line-945"></a>See Note [Which scrutinees may throw precise exceptions] in "GHC.Core.Opt.DmdAnal".
<a name="line-946"></a>
<a name="line-947"></a>We have to be careful not to discard dead-end Divergence from case
<a name="line-948"></a>alternatives, though (#18086):
<a name="line-949"></a>
<a name="line-950"></a>  m = putStrLn "foo" &gt;&gt; error "bar"
<a name="line-951"></a>
<a name="line-952"></a>'m' should still have 'exnDiv', which is why it is not sufficient to lub with
<a name="line-953"></a>'nopDmdType' (which has 'topDiv') in 'deferAfterPreciseException'.
<a name="line-954"></a>
<a name="line-955"></a>Historical Note: This used to be called the "IO hack". But that term is rather
<a name="line-956"></a>a bad fit because
<a name="line-957"></a>1. It's easily confused with the "State hack", which also affects IO.
<a name="line-958"></a>2. Neither "IO" nor "hack" is a good description of what goes on here, which
<a name="line-959"></a>   is deferring strictness results after possibly throwing a precise exception.
<a name="line-960"></a>   The "hack" is probably not having to defer when we can prove that the
<a name="line-961"></a>   expression may not throw a precise exception (increasing precision of the
<a name="line-962"></a>   analysis), but that's just a favourable guess.
<a name="line-963"></a>
<a name="line-964"></a>Note [Exceptions and strictness]
<a name="line-965"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-966"></a>We used to smart about catching exceptions, but we aren't anymore.
<a name="line-967"></a>See #14998 for the way it's resolved at the moment.
<a name="line-968"></a>
<a name="line-969"></a>Here's a historic breakdown:
<a name="line-970"></a>
<a name="line-971"></a>Apparently, exception handling prim-ops didn't use to have any special
<a name="line-972"></a>strictness signatures, thus defaulting to nopSig, which assumes they use their
<a name="line-973"></a>arguments lazily. Joachim was the first to realise that we could provide richer
<a name="line-974"></a>information. Thus, in 0558911f91c (Dec 13), he added signatures to
<a name="line-975"></a>primops.txt.pp indicating that functions like `catch#` and `catchRetry#` call
<a name="line-976"></a>their argument, which is useful information for usage analysis. Still with a
<a name="line-977"></a>'Lazy' strictness demand (i.e. 'lazyApply1Dmd'), though, and the world was fine.
<a name="line-978"></a>
<a name="line-979"></a>In 7c0fff4 (July 15), Simon argued that giving `catch#` et al. a
<a name="line-980"></a>'strictApply1Dmd' leads to substantial performance gains. That was at the cost
<a name="line-981"></a>of correctness, as #10712 proved. So, back to 'lazyApply1Dmd' in
<a name="line-982"></a>28638dfe79e (Dec 15).
<a name="line-983"></a>
<a name="line-984"></a>Motivated to reproduce the gains of 7c0fff4 without the breakage of #10712,
<a name="line-985"></a>Ben opened #11222. Simon made the demand analyser "understand catch" in
<a name="line-986"></a>9915b656 (Jan 16) by adding a new 'catchArgDmd', which basically said to call
<a name="line-987"></a>its argument strictly, but also swallow any thrown exceptions in
<a name="line-988"></a>'multDivergence'. This was realized by extending the 'Str' constructor of
<a name="line-989"></a>'ArgStr' with a 'ExnStr' field, indicating that it catches the exception, and
<a name="line-990"></a>adding a 'ThrowsExn' constructor to the 'Divergence' lattice as an element
<a name="line-991"></a>between 'Dunno' and 'Diverges'. Then along came #11555 and finally #13330,
<a name="line-992"></a>so we had to revert to 'lazyApply1Dmd' again in 701256df88c (Mar 17).
<a name="line-993"></a>
<a name="line-994"></a>This left the other variants like 'catchRetry#' having 'catchArgDmd', which is
<a name="line-995"></a>where #14998 picked up. Item 1 was concerned with measuring the impact of also
<a name="line-996"></a>making `catchRetry#` and `catchSTM#` have 'lazyApply1Dmd'. The result was that
<a name="line-997"></a>there was none. We removed the last usages of 'catchArgDmd' in 00b8ecb7
<a name="line-998"></a>(Apr 18). There was a lot of dead code resulting from that change, that we
<a name="line-999"></a>removed in ef6b283 (Jan 19): We got rid of 'ThrowsExn' and 'ExnStr' again and
<a name="line-1000"></a>removed any code that was dealing with the peculiarities.
<a name="line-1001"></a>
<a name="line-1002"></a>Where did the speed-ups vanish to? In #14998, item 3 established that
<a name="line-1003"></a>turning 'catch#' strict in its first argument didn't bring back any of the
<a name="line-1004"></a>alleged performance benefits. Item 2 of that ticket finally found out that it
<a name="line-1005"></a>was entirely due to 'catchException's new (since #11555) definition, which
<a name="line-1006"></a>was simply
<a name="line-1007"></a>
<a name="line-1008"></a>    catchException !io handler = catch io handler
<a name="line-1009"></a>
<a name="line-1010"></a>While 'catchException' is arguably the saner semantics for 'catch', it is an
<a name="line-1011"></a>internal helper function in "GHC.IO". Its use in
<a name="line-1012"></a>"GHC.IO.Handle.Internals.do_operation" made for the huge allocation differences:
<a name="line-1013"></a>Remove the bang and you find the regressions we originally wanted to avoid with
<a name="line-1014"></a>'catchArgDmd'. See also #exceptions_and_strictness# in "GHC.IO".
<a name="line-1015"></a>
<a name="line-1016"></a>So history keeps telling us that the only possibly correct strictness annotation
<a name="line-1017"></a>for the first argument of 'catch#' is 'lazyApply1Dmd', because 'catch#' really
<a name="line-1018"></a>is not strict in its argument: Just try this in GHCi
<a name="line-1019"></a>
<a name="line-1020"></a>  :set -XScopedTypeVariables
<a name="line-1021"></a>  import Control.Exception
<a name="line-1022"></a>  catch undefined (\(_ :: SomeException) -&gt; putStrLn "you'll see this")
<a name="line-1023"></a>
<a name="line-1024"></a>Any analysis that assumes otherwise will be broken in some way or another
<a name="line-1025"></a>(beyond `-fno-pendantic-bottoms`).
<a name="line-1026"></a>
<a name="line-1027"></a>But then #13380 and #17676 suggest (in Mar 20) that we need to re-introduce a
<a name="line-1028"></a>subtly different variant of `ThrowsExn` (which we call `ExnOrDiv` now) that is
<a name="line-1029"></a>only used by `raiseIO#` in order to preserve precise exceptions by strictness
<a name="line-1030"></a>analysis, while not impacting the ability to eliminate dead code.
<a name="line-1031"></a>See Note [Precise exceptions and strictness analysis].
<a name="line-1032"></a>
<a name="line-1033"></a>Note [Default demand on free variables and arguments]
<a name="line-1034"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1035"></a>Free variables not mentioned in the environment of a 'DmdType'
<a name="line-1036"></a>are demanded according to the demand type's Divergence:
<a name="line-1037"></a>  * In a Diverges (botDiv) context, that demand is botDmd
<a name="line-1038"></a>    (strict and absent).
<a name="line-1039"></a>  * In all other contexts, the demand is absDmd (lazy and absent).
<a name="line-1040"></a>This is recorded in 'defaultFvDmd'.
<a name="line-1041"></a>
<a name="line-1042"></a>Similarly, we can eta-expand demand types to get demands on excess arguments
<a name="line-1043"></a>not accounted for in the type, by consulting 'defaultArgDmd':
<a name="line-1044"></a>  * In a Diverges (botDiv) context, that demand is again botDmd.
<a name="line-1045"></a>  * In a ExnOrDiv (exnDiv) context, that demand is absDmd: We surely diverge
<a name="line-1046"></a>    before evaluating the excess argument, but don't want to eagerly evaluate
<a name="line-1047"></a>    it (cf. Note [Precise exceptions and strictness analysis]).
<a name="line-1048"></a>  * In a Dunno context (topDiv), the demand is topDmd, because
<a name="line-1049"></a>    it's perfectly possible to enter the additional lambda and evaluate it
<a name="line-1050"></a>    in unforeseen ways (so, not absent).
<a name="line-1051"></a>
<a name="line-1052"></a>Note [Bottom CPR iff Dead-Ending Divergence]
<a name="line-1053"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1054"></a>Both CPR analysis and Demand analysis handle recursive functions by doing
<a name="line-1055"></a>fixed-point iteration. To find the *least* (e.g., most informative) fixed-point,
<a name="line-1056"></a>iteration starts with the bottom element of the semantic domain. Diverging
<a name="line-1057"></a>functions generally have the bottom element as their least fixed-point.
<a name="line-1058"></a>
<a name="line-1059"></a>One might think that CPR analysis and Demand analysis then agree in when a
<a name="line-1060"></a>function gets a bottom denotation. E.g., whenever it has 'botCpr', it should
<a name="line-1061"></a>also have 'botDiv'. But that is not the case, because strictness analysis has to
<a name="line-1062"></a>be careful around precise exceptions, see Note [Precise vs imprecise exceptions].
<a name="line-1063"></a>
<a name="line-1064"></a>So Demand analysis gives some diverging functions 'exnDiv' (which is *not* the
<a name="line-1065"></a>bottom element) when the CPR signature says 'botCpr', and that's OK. Here's an
<a name="line-1066"></a>example (from #18086) where that is the case:
<a name="line-1067"></a>
<a name="line-1068"></a>ioTest :: IO ()
<a name="line-1069"></a>ioTest = do
<a name="line-1070"></a>  putStrLn "hi"
<a name="line-1071"></a>  undefined
<a name="line-1072"></a>
<a name="line-1073"></a>However, one can loosely say that we give a function 'botCpr' whenever its
<a name="line-1074"></a>'Divergence' is 'exnDiv' or 'botDiv', i.e., dead-ending. But that's just
<a name="line-1075"></a>a consequence of fixed-point iteration, it's not important that they agree.
<a name="line-1076"></a>
<a name="line-1077"></a>************************************************************************
<a name="line-1078"></a>*                                                                      *
<a name="line-1079"></a>           Demand environments and types
<a name="line-1080"></a>*                                                                      *
<a name="line-1081"></a>************************************************************************
<a name="line-1082"></a>-}</span>
<a name="line-1083"></a>
<a name="line-1084"></a><a name="DmdEnv"></a><span class='hs-comment'>-- Subject to Note [Default demand on free variables and arguments]</span>
<a name="line-1085"></a><a name="DmdEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VarEnv</span> <span class='hs-conid'>Demand</span>
<a name="line-1086"></a>
<a name="line-1087"></a><a name="emptyDmdEnv"></a><span class='hs-definition'>emptyDmdEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdEnv</span>
<a name="line-1088"></a><span class='hs-definition'>emptyDmdEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-1089"></a>
<a name="line-1090"></a><a name="multDmdEnv"></a><span class='hs-definition'>multDmdEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Card</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span>
<a name="line-1091"></a><span class='hs-definition'>multDmdEnv</span> <span class='hs-varid'>n</span> <span class='hs-varid'>env</span>
<a name="line-1092"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>env'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>multTrivial</span> <span class='hs-varid'>n</span> <span class='hs-varid'>emptyDmdEnv</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env'</span>
<a name="line-1093"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>multDmd</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span>
<a name="line-1094"></a>
<a name="line-1095"></a><a name="reuseEnv"></a><span class='hs-definition'>reuseEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span>
<a name="line-1096"></a><span class='hs-definition'>reuseEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>multDmdEnv</span> <span class='hs-conid'>C_1N</span>
<a name="line-1097"></a>
<a name="line-1098"></a><a name="keepAliveDmdEnv"></a><span class='hs-comment'>-- | @keepAliveDmdType dt vs@ makes sure that the Ids in @vs@ have</span>
<a name="line-1099"></a><span class='hs-comment'>-- /some/ usage in the returned demand types -- they are not Absent.</span>
<a name="line-1100"></a><span class='hs-comment'>-- See Note [Absence analysis for stable unfoldings and RULES]</span>
<a name="line-1101"></a><span class='hs-comment'>--     in "GHC.Core.Opt.DmdAnal".</span>
<a name="line-1102"></a><span class='hs-definition'>keepAliveDmdEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IdSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span>
<a name="line-1103"></a><span class='hs-definition'>keepAliveDmdEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>vs</span>
<a name="line-1104"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nonDetStrictFoldVarSet</span> <span class='hs-varid'>add</span> <span class='hs-varid'>env</span> <span class='hs-varid'>vs</span>
<a name="line-1105"></a>  <span class='hs-keyword'>where</span>
<a name="line-1106"></a>    <span class='hs-varid'>add</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span>
<a name="line-1107"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>v</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv_C</span> <span class='hs-varid'>add_dmd</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span> <span class='hs-varid'>topDmd</span>
<a name="line-1108"></a>
<a name="line-1109"></a>    <span class='hs-varid'>add_dmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-1110"></a>    <span class='hs-comment'>-- If the existing usage is Absent, make it used</span>
<a name="line-1111"></a>    <span class='hs-comment'>-- Otherwise leave it alone</span>
<a name="line-1112"></a>    <span class='hs-varid'>add_dmd</span> <span class='hs-varid'>dmd</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAbsDmd</span> <span class='hs-varid'>dmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topDmd</span>
<a name="line-1113"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmd</span>
<a name="line-1114"></a>
<a name="line-1115"></a><a name="DmdType"></a><span class='hs-comment'>-- | Characterises how an expression</span>
<a name="line-1116"></a><a name="DmdType"></a><span class='hs-comment'>--    * Evaluates its free variables ('dt_env')</span>
<a name="line-1117"></a><a name="DmdType"></a><span class='hs-comment'>--    * Evaluates its arguments ('dt_args')</span>
<a name="line-1118"></a><a name="DmdType"></a><span class='hs-comment'>--    * Diverges on every code path or not ('dt_div')</span>
<a name="line-1119"></a><a name="DmdType"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DmdType</span>
<a name="line-1120"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span>
<a name="line-1121"></a>  <span class='hs-layout'>{</span> <span class='hs-varid'>dt_env</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>DmdEnv</span>     <span class='hs-comment'>-- ^ Demand on explicitly-mentioned free variables</span>
<a name="line-1122"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>dt_args</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- ^ Demand on arguments</span>
<a name="line-1123"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>dt_div</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>Divergence</span> <span class='hs-comment'>-- ^ Whether evaluation diverges.</span>
<a name="line-1124"></a>                          <span class='hs-comment'>-- See Note [Demand type Divergence]</span>
<a name="line-1125"></a>  <span class='hs-layout'>}</span>
<a name="line-1126"></a>
<a name="line-1127"></a><a name="instance%20Eq%20DmdType"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyword'>where</span>
<a name="line-1128"></a>  <span class='hs-layout'>(</span><span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>ds1</span> <span class='hs-varid'>div1</span><span class='hs-layout'>)</span>
<a name="line-1129"></a>       <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv2</span> <span class='hs-varid'>ds2</span> <span class='hs-varid'>div2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nonDetUFMToList</span> <span class='hs-varid'>fv1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>nonDetUFMToList</span> <span class='hs-varid'>fv2</span>
<a name="line-1130"></a>         <span class='hs-comment'>-- It's OK to use nonDetUFMToList here because we're testing for</span>
<a name="line-1131"></a>         <span class='hs-comment'>-- equality and even though the lists will be in some arbitrary</span>
<a name="line-1132"></a>         <span class='hs-comment'>-- Unique order, it is the same order for both</span>
<a name="line-1133"></a>                              <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>ds1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ds2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>div1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>div2</span>
<a name="line-1134"></a>
<a name="line-1135"></a><a name="lubDmdType"></a><span class='hs-comment'>-- | Compute the least upper bound of two 'DmdType's elicited /by the same</span>
<a name="line-1136"></a><span class='hs-comment'>-- incoming demand/!</span>
<a name="line-1137"></a><span class='hs-definition'>lubDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-1138"></a><span class='hs-definition'>lubDmdType</span> <span class='hs-varid'>d1</span> <span class='hs-varid'>d2</span>
<a name="line-1139"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>lub_fv</span> <span class='hs-varid'>lub_ds</span> <span class='hs-varid'>lub_div</span>
<a name="line-1140"></a>  <span class='hs-keyword'>where</span>
<a name="line-1141"></a>    <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>max</span> <span class='hs-layout'>(</span><span class='hs-varid'>dmdTypeDepth</span> <span class='hs-varid'>d1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dmdTypeDepth</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span>
<a name="line-1142"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>ds1</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>etaExpandDmdType</span> <span class='hs-varid'>n</span> <span class='hs-varid'>d1</span>
<a name="line-1143"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv2</span> <span class='hs-varid'>ds2</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>etaExpandDmdType</span> <span class='hs-varid'>n</span> <span class='hs-varid'>d2</span>
<a name="line-1144"></a>
<a name="line-1145"></a>    <span class='hs-varid'>lub_fv</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusVarEnv_CD</span> <span class='hs-varid'>lubDmd</span> <span class='hs-varid'>fv1</span> <span class='hs-layout'>(</span><span class='hs-varid'>defaultFvDmd</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>defaultFvDmd</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span>
<a name="line-1146"></a>    <span class='hs-varid'>lub_ds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWithEqual</span> <span class='hs-str'>"lubDmdType"</span> <span class='hs-varid'>lubDmd</span> <span class='hs-varid'>ds1</span> <span class='hs-varid'>ds2</span>
<a name="line-1147"></a>    <span class='hs-varid'>lub_div</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lubDivergence</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span>
<a name="line-1148"></a>
<a name="line-1149"></a><a name="PlusDmdArg"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>PlusDmdArg</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Divergence</span><span class='hs-layout'>)</span>
<a name="line-1150"></a>
<a name="line-1151"></a><a name="mkPlusDmdArg"></a><span class='hs-definition'>mkPlusDmdArg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PlusDmdArg</span>
<a name="line-1152"></a><span class='hs-definition'>mkPlusDmdArg</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-varid'>topDiv</span><span class='hs-layout'>)</span>
<a name="line-1153"></a>
<a name="line-1154"></a><a name="toPlusDmdArg"></a><span class='hs-definition'>toPlusDmdArg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PlusDmdArg</span>
<a name="line-1155"></a><span class='hs-definition'>toPlusDmdArg</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>fv</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1156"></a>
<a name="line-1157"></a><a name="plusDmdType"></a><span class='hs-definition'>plusDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PlusDmdArg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-1158"></a><span class='hs-definition'>plusDmdType</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>ds1</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fv2</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-1159"></a>    <span class='hs-comment'>-- See Note [Asymmetry of 'plus*']</span>
<a name="line-1160"></a>    <span class='hs-comment'>-- 'plus' takes the argument/result info from its *first* arg,</span>
<a name="line-1161"></a>    <span class='hs-comment'>-- using its second arg just for its free-var info.</span>
<a name="line-1162"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-layout'>(</span><span class='hs-varid'>plusVarEnv_CD</span> <span class='hs-varid'>plusDmd</span> <span class='hs-varid'>fv1</span> <span class='hs-layout'>(</span><span class='hs-varid'>defaultFvDmd</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>defaultFvDmd</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1163"></a>            <span class='hs-varid'>ds1</span>
<a name="line-1164"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>r1</span> <span class='hs-varop'>`plusDivergence`</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-1165"></a>
<a name="line-1166"></a><a name="botDmdType"></a><span class='hs-definition'>botDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span>
<a name="line-1167"></a><span class='hs-definition'>botDmdType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>emptyDmdEnv</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>botDiv</span>
<a name="line-1168"></a>
<a name="line-1169"></a><a name="nopDmdType"></a><span class='hs-comment'>-- | The demand type of doing nothing (lazy, absent, no Divergence</span>
<a name="line-1170"></a><span class='hs-comment'>-- information). Note that it is ''not'' the top of the lattice (which would be</span>
<a name="line-1171"></a><span class='hs-comment'>-- "may use everything"), so it is (no longer) called topDmdType.</span>
<a name="line-1172"></a><span class='hs-definition'>nopDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span>
<a name="line-1173"></a><span class='hs-definition'>nopDmdType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>emptyDmdEnv</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>topDiv</span>
<a name="line-1174"></a>
<a name="line-1175"></a><a name="isTopDmdType"></a><span class='hs-definition'>isTopDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1176"></a><span class='hs-definition'>isTopDmdType</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>args</span> <span class='hs-varid'>div</span><span class='hs-layout'>)</span>
<a name="line-1177"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>div</span> <span class='hs-varop'>==</span> <span class='hs-varid'>topDiv</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>args</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>env</span>
<a name="line-1178"></a>
<a name="line-1179"></a><a name="exnDmdType"></a><span class='hs-comment'>-- | The demand type of an unspecified expression that is guaranteed to</span>
<a name="line-1180"></a><span class='hs-comment'>-- throw a (precise or imprecise) exception or diverge.</span>
<a name="line-1181"></a><span class='hs-definition'>exnDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span>
<a name="line-1182"></a><span class='hs-definition'>exnDmdType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>emptyDmdEnv</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>exnDiv</span>
<a name="line-1183"></a>
<a name="line-1184"></a><a name="dmdTypeDepth"></a><span class='hs-definition'>dmdTypeDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-1185"></a><span class='hs-definition'>dmdTypeDepth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varop'>.</span> <span class='hs-varid'>dt_args</span>
<a name="line-1186"></a>
<a name="line-1187"></a><a name="etaExpandDmdType"></a><span class='hs-comment'>-- | This makes sure we can use the demand type with n arguments after eta</span>
<a name="line-1188"></a><span class='hs-comment'>-- expansion, where n must not be lower than the demand types depth.</span>
<a name="line-1189"></a><span class='hs-comment'>-- It appends the argument list with the correct 'defaultArgDmd'.</span>
<a name="line-1190"></a><span class='hs-definition'>etaExpandDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-1191"></a><span class='hs-definition'>etaExpandDmdType</span> <span class='hs-varid'>n</span> <span class='hs-varid'>d</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>DmdType</span><span class='hs-layout'>{</span><span class='hs-varid'>dt_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ds</span><span class='hs-layout'>,</span> <span class='hs-varid'>dt_div</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>div</span><span class='hs-layout'>}</span>
<a name="line-1192"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-varid'>depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span>
<a name="line-1193"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&gt;</span>  <span class='hs-varid'>depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span><span class='hs-layout'>{</span><span class='hs-varid'>dt_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inc_ds</span><span class='hs-layout'>}</span>
<a name="line-1194"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"etaExpandDmdType: arity decrease"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>
<a name="line-1195"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>ds</span>
<a name="line-1196"></a>        <span class='hs-comment'>-- Arity increase:</span>
<a name="line-1197"></a>        <span class='hs-comment'>--  * Demands on FVs are still valid</span>
<a name="line-1198"></a>        <span class='hs-comment'>--  * Demands on args also valid, plus we can extend with defaultArgDmd</span>
<a name="line-1199"></a>        <span class='hs-comment'>--    as appropriate for the given Divergence</span>
<a name="line-1200"></a>        <span class='hs-comment'>--  * Divergence is still valid:</span>
<a name="line-1201"></a>        <span class='hs-comment'>--    - A dead end after 2 arguments stays a dead end after 3 arguments</span>
<a name="line-1202"></a>        <span class='hs-comment'>--    - The remaining case is Dunno, which is already topDiv</span>
<a name="line-1203"></a>        <span class='hs-varid'>inc_ds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>take</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>ds</span> <span class='hs-varop'>++</span> <span class='hs-varid'>repeat</span> <span class='hs-layout'>(</span><span class='hs-varid'>defaultArgDmd</span> <span class='hs-varid'>div</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1204"></a>
<a name="line-1205"></a><a name="decreaseArityDmdType"></a><span class='hs-comment'>-- | A conservative approximation for a given 'DmdType' in case of an arity</span>
<a name="line-1206"></a><span class='hs-comment'>-- decrease. Currently, it's just nopDmdType.</span>
<a name="line-1207"></a><span class='hs-definition'>decreaseArityDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-1208"></a><span class='hs-definition'>decreaseArityDmdType</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nopDmdType</span>
<a name="line-1209"></a>
<a name="line-1210"></a><a name="splitDmdTy"></a><span class='hs-definition'>splitDmdTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Demand</span><span class='hs-layout'>,</span> <span class='hs-conid'>DmdType</span><span class='hs-layout'>)</span>
<a name="line-1211"></a><span class='hs-comment'>-- Split off one function argument</span>
<a name="line-1212"></a><span class='hs-comment'>-- We already have a suitable demand on all</span>
<a name="line-1213"></a><span class='hs-comment'>-- free vars, so no need to add more!</span>
<a name="line-1214"></a><span class='hs-definition'>splitDmdTy</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>DmdType</span><span class='hs-layout'>{</span><span class='hs-varid'>dt_args</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>dmd</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>dmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>{</span><span class='hs-varid'>dt_args</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>args</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1215"></a><span class='hs-definition'>splitDmdTy</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>DmdType</span><span class='hs-layout'>{</span><span class='hs-varid'>dt_div</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>div</span><span class='hs-layout'>}</span>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>defaultArgDmd</span> <span class='hs-varid'>div</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1216"></a>
<a name="line-1217"></a><a name="multDmdType"></a><span class='hs-definition'>multDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Card</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-1218"></a><span class='hs-definition'>multDmdType</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>args</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-1219"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- pprTrace "multDmdType" (ppr n $$ ppr fv $$ ppr (multDmdEnv n fv)) $</span>
<a name="line-1220"></a>    <span class='hs-conid'>DmdType</span> <span class='hs-layout'>(</span><span class='hs-varid'>multDmdEnv</span> <span class='hs-varid'>n</span> <span class='hs-varid'>fv</span><span class='hs-layout'>)</span>
<a name="line-1221"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>multDmd</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-1222"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>multDivergence</span> <span class='hs-varid'>n</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-1223"></a>
<a name="line-1224"></a><a name="peelFV"></a><span class='hs-definition'>peelFV</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Demand</span><span class='hs-layout'>)</span>
<a name="line-1225"></a><span class='hs-definition'>peelFV</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- pprTrace "rfv" (ppr id &lt;+&gt; ppr dmd $$ ppr fv)</span>
<a name="line-1226"></a>                               <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv'</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>)</span>
<a name="line-1227"></a>  <span class='hs-keyword'>where</span>
<a name="line-1228"></a>  <span class='hs-comment'>-- Force these arguments so that old `Env` is not retained.</span>
<a name="line-1229"></a>  <span class='hs-varop'>!</span><span class='hs-varid'>fv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fv</span> <span class='hs-varop'>`delVarEnv`</span> <span class='hs-varid'>id</span>
<a name="line-1230"></a>  <span class='hs-comment'>-- See Note [Default demand on free variables and arguments]</span>
<a name="line-1231"></a>  <span class='hs-varop'>!</span><span class='hs-varid'>dmd</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>id</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>defaultFvDmd</span> <span class='hs-varid'>res</span>
<a name="line-1232"></a>
<a name="line-1233"></a><a name="addDemand"></a><span class='hs-definition'>addDemand</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-1234"></a><span class='hs-definition'>addDemand</span> <span class='hs-varid'>dmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-layout'>(</span><span class='hs-varid'>dmd</span><span class='hs-conop'>:</span><span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span>
<a name="line-1235"></a>
<a name="line-1236"></a><a name="findIdDemand"></a><span class='hs-definition'>findIdDemand</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-1237"></a><span class='hs-definition'>findIdDemand</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-1238"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>id</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>defaultFvDmd</span> <span class='hs-varid'>res</span>
<a name="line-1239"></a>
<a name="line-1240"></a><a name="deferAfterPreciseException"></a><span class='hs-comment'>-- | When e is evaluated after executing an IO action that may throw a precise</span>
<a name="line-1241"></a><span class='hs-comment'>-- exception, we act as if there is an additional control flow path that is</span>
<a name="line-1242"></a><span class='hs-comment'>-- taken if e throws a precise exception. The demand type of this control flow</span>
<a name="line-1243"></a><span class='hs-comment'>-- path</span>
<a name="line-1244"></a><span class='hs-comment'>--   * is lazy and absent ('topDmd') in all free variables and arguments</span>
<a name="line-1245"></a><span class='hs-comment'>--   * has 'exnDiv' 'Divergence' result</span>
<a name="line-1246"></a><span class='hs-comment'>-- So we can simply take a variant of 'nopDmdType', 'exnDmdType'.</span>
<a name="line-1247"></a><span class='hs-comment'>-- Why not 'nopDmdType'? Because then the result of 'e' can never be 'exnDiv'!</span>
<a name="line-1248"></a><span class='hs-comment'>-- That means failure to drop dead-ends, see #18086.</span>
<a name="line-1249"></a><span class='hs-comment'>-- See Note [Precise exceptions and strictness analysis]</span>
<a name="line-1250"></a><span class='hs-definition'>deferAfterPreciseException</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-1251"></a><span class='hs-definition'>deferAfterPreciseException</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lubDmdType</span> <span class='hs-varid'>exnDmdType</span>
<a name="line-1252"></a>
<a name="line-1253"></a><a name="keepAliveDmdType"></a><span class='hs-comment'>-- | See 'keepAliveDmdEnv'.</span>
<a name="line-1254"></a><span class='hs-definition'>keepAliveDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-1255"></a><span class='hs-definition'>keepAliveDmdType</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fvs</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>vars</span> <span class='hs-keyglyph'>=</span>
<a name="line-1256"></a>  <span class='hs-conid'>DmdType</span> <span class='hs-layout'>(</span><span class='hs-varid'>fvs</span> <span class='hs-varop'>`keepAliveDmdEnv`</span> <span class='hs-varid'>vars</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span>
<a name="line-1257"></a>
<a name="line-1258"></a><span class='hs-comment'>{-
<a name="line-1259"></a>Note [Demand type Divergence]
<a name="line-1260"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1261"></a>In contrast to StrictSigs, DmdTypes are elicited under a specific incoming demand.
<a name="line-1262"></a>This is described in detail in Note [Understanding DmdType and StrictSig].
<a name="line-1263"></a>Here, we'll focus on what that means for a DmdType's Divergence in a higher-order
<a name="line-1264"></a>scenario.
<a name="line-1265"></a>
<a name="line-1266"></a>Consider
<a name="line-1267"></a>  err x y = x `seq` y `seq` error (show x)
<a name="line-1268"></a>this has a strictness signature of
<a name="line-1269"></a>  &lt;1L&gt;&lt;1L&gt;b
<a name="line-1270"></a>meaning that we don't know what happens when we call err in weaker contexts than
<a name="line-1271"></a>C1(C1(L)), like @err `seq` ()@ (1A) and @err 1 `seq` ()@ (CS(A)). We
<a name="line-1272"></a>may not unleash the botDiv, hence assume topDiv. Of course, in
<a name="line-1273"></a>@err 1 2 `seq` ()@ the incoming demand CS(CS(A)) is strong enough and we see
<a name="line-1274"></a>that the expression diverges.
<a name="line-1275"></a>
<a name="line-1276"></a>Now consider a function
<a name="line-1277"></a>  f g = g 1 2
<a name="line-1278"></a>with signature &lt;C1(C1(L))&gt;, and the expression
<a name="line-1279"></a>  f err `seq` ()
<a name="line-1280"></a>now f puts a strictness demand of C1(C1(L)) onto its argument, which is unleashed
<a name="line-1281"></a>on err via the App rule. In contrast to weaker head strictness, this demand is
<a name="line-1282"></a>strong enough to unleash err's signature and hence we see that the whole
<a name="line-1283"></a>expression diverges!
<a name="line-1284"></a>
<a name="line-1285"></a>Note [Asymmetry of 'plus*']
<a name="line-1286"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1287"></a>'plus' for DmdTypes is *asymmetrical*, because there can only one
<a name="line-1288"></a>be one type contributing argument demands!  For example, given (e1 e2), we get
<a name="line-1289"></a>a DmdType dt1 for e1, use its arg demand to analyse e2 giving dt2, and then do
<a name="line-1290"></a>(dt1 `plusType` dt2). Similarly with
<a name="line-1291"></a>  case e of { p -&gt; rhs }
<a name="line-1292"></a>we get dt_scrut from the scrutinee and dt_rhs from the RHS, and then
<a name="line-1293"></a>compute (dt_rhs `plusType` dt_scrut).
<a name="line-1294"></a>
<a name="line-1295"></a>We
<a name="line-1296"></a> 1. combine the information on the free variables,
<a name="line-1297"></a> 2. take the demand on arguments from the first argument
<a name="line-1298"></a> 3. combine the termination results, as in plusDivergence.
<a name="line-1299"></a>
<a name="line-1300"></a>Since we don't use argument demands of the second argument anyway, 'plus's
<a name="line-1301"></a>second argument is just a 'PlusDmdType'.
<a name="line-1302"></a>
<a name="line-1303"></a>But note that the argument demand types are not guaranteed to be observed in
<a name="line-1304"></a>left to right order. For example, analysis of a case expression will pass the
<a name="line-1305"></a>demand type for the alts as the left argument and the type for the scrutinee as
<a name="line-1306"></a>the right argument. Also, it is not at all clear if there is such an order;
<a name="line-1307"></a>consider the LetUp case, where the RHS might be forced at any point while
<a name="line-1308"></a>evaluating the let body.
<a name="line-1309"></a>Therefore, it is crucial that 'plusDivergence' is symmetric!
<a name="line-1310"></a>
<a name="line-1311"></a>Note [Demands from unsaturated function calls]
<a name="line-1312"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1313"></a>Consider a demand transformer d1 -&gt; d2 -&gt; r for f.
<a name="line-1314"></a>If a sufficiently detailed demand is fed into this transformer,
<a name="line-1315"></a>e.g &lt;C1(C1(L))&gt; arising from "f x1 x2" in a strict, use-once context,
<a name="line-1316"></a>then d1 and d2 is precisely the demand unleashed onto x1 and x2 (similar for
<a name="line-1317"></a>the free variable environment) and furthermore the result information r is the
<a name="line-1318"></a>one we want to use.
<a name="line-1319"></a>
<a name="line-1320"></a>An anonymous lambda is also an unsaturated function all (needs one argument,
<a name="line-1321"></a>none given), so this applies to that case as well.
<a name="line-1322"></a>
<a name="line-1323"></a>But the demand fed into f might be less than C1(C1(L)). Then we have to
<a name="line-1324"></a>'multDmdType' the announced demand type. Examples:
<a name="line-1325"></a> * Not strict enough, e.g. C1(C1(L)):
<a name="line-1326"></a>   - We have to multiply all argument and free variable demands with C_01,
<a name="line-1327"></a>     zapping strictness.
<a name="line-1328"></a>   - We have to multiply divergence with C_01. If r says that f Diverges for sure,
<a name="line-1329"></a>     then this holds when the demand guarantees that two arguments are going to
<a name="line-1330"></a>     be passed. If the demand is lower, we may just as well converge.
<a name="line-1331"></a>     If we were tracking definite convergence, than that would still hold under
<a name="line-1332"></a>     a weaker demand than expected by the demand transformer.
<a name="line-1333"></a> * Used more than once, e.g. CS(C1(L)):
<a name="line-1334"></a>   - Multiply with C_1N. Even if f puts a used-once demand on any of its argument
<a name="line-1335"></a>     or free variables, if we call f multiple times, we may evaluate this
<a name="line-1336"></a>     argument or free variable multiple times.
<a name="line-1337"></a>
<a name="line-1338"></a>In dmdTransformSig, we call peelManyCalls to find out the 'Card'inality with
<a name="line-1339"></a>which we have to multiply and then call multDmdType with that.
<a name="line-1340"></a>
<a name="line-1341"></a>Similarly, dmdTransformDictSelSig and dmdAnal, when analyzing a Lambda, use
<a name="line-1342"></a>peelCallDmd, which peels only one level, but also returns the demand put on the
<a name="line-1343"></a>body of the function.
<a name="line-1344"></a>-}</span>
<a name="line-1345"></a>
<a name="line-1346"></a>
<a name="line-1347"></a><span class='hs-comment'>{-
<a name="line-1348"></a>************************************************************************
<a name="line-1349"></a>*                                                                      *
<a name="line-1350"></a>                     Demand signatures
<a name="line-1351"></a>*                                                                      *
<a name="line-1352"></a>************************************************************************
<a name="line-1353"></a>
<a name="line-1354"></a>In a let-bound Id we record its demand signature.
<a name="line-1355"></a>In principle, this demand signature is a demand transformer, mapping
<a name="line-1356"></a>a demand on the Id into a DmdType, which gives
<a name="line-1357"></a>        a) the free vars of the Id's value
<a name="line-1358"></a>        b) the Id's arguments
<a name="line-1359"></a>        c) an indication of the result of applying
<a name="line-1360"></a>           the Id to its arguments
<a name="line-1361"></a>
<a name="line-1362"></a>However, in fact we store in the Id an extremely emascuated demand
<a name="line-1363"></a>transfomer, namely
<a name="line-1364"></a>
<a name="line-1365"></a>                a single DmdType
<a name="line-1366"></a>(Nevertheless we dignify StrictSig as a distinct type.)
<a name="line-1367"></a>
<a name="line-1368"></a>This DmdType gives the demands unleashed by the Id when it is applied
<a name="line-1369"></a>to as many arguments as are given in by the arg demands in the DmdType.
<a name="line-1370"></a>Also see Note [Demand type Divergence] for the meaning of a Divergence in a
<a name="line-1371"></a>strictness signature.
<a name="line-1372"></a>
<a name="line-1373"></a>If an Id is applied to less arguments than its arity, it means that
<a name="line-1374"></a>the demand on the function at a call site is weaker than the vanilla
<a name="line-1375"></a>call demand, used for signature inference. Therefore we place a top
<a name="line-1376"></a>demand on all arguments. Otherwise, the demand is specified by Id's
<a name="line-1377"></a>signature.
<a name="line-1378"></a>
<a name="line-1379"></a>For example, the demand transformer described by the demand signature
<a name="line-1380"></a>        StrictSig (DmdType {x -&gt; &lt;1L&gt;} &lt;A&gt;&lt;1P(L,L)&gt;)
<a name="line-1381"></a>says that when the function is applied to two arguments, it
<a name="line-1382"></a>unleashes demand 1L on the free var x, A on the first arg,
<a name="line-1383"></a>and 1P(L,L) on the second.
<a name="line-1384"></a>
<a name="line-1385"></a>If this same function is applied to one arg, all we can say is that it
<a name="line-1386"></a>uses x with 1L, and its arg with demand 1P(L,L).
<a name="line-1387"></a>
<a name="line-1388"></a>Note [Understanding DmdType and StrictSig]
<a name="line-1389"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1390"></a>Demand types are sound approximations of an expression's semantics relative to
<a name="line-1391"></a>the incoming demand we put the expression under. Consider the following
<a name="line-1392"></a>expression:
<a name="line-1393"></a>
<a name="line-1394"></a>    \x y -&gt; x `seq` (y, 2*x)
<a name="line-1395"></a>
<a name="line-1396"></a>Here is a table with demand types resulting from different incoming demands we
<a name="line-1397"></a>put that expression under. Note the monotonicity; a stronger incoming demand
<a name="line-1398"></a>yields a more precise demand type:
<a name="line-1399"></a>
<a name="line-1400"></a>    incoming demand   |  demand type
<a name="line-1401"></a>    --------------------------------
<a name="line-1402"></a>    1A                  |  &lt;L&gt;&lt;L&gt;{}
<a name="line-1403"></a>    C1(C1(L))           |  &lt;1P(L)&gt;&lt;L&gt;{}
<a name="line-1404"></a>    C1(C1(1P(1P(L),A))) |  &lt;1P(A)&gt;&lt;A&gt;{}
<a name="line-1405"></a>
<a name="line-1406"></a>Note that in the first example, the depth of the demand type was *higher* than
<a name="line-1407"></a>the arity of the incoming call demand due to the anonymous lambda.
<a name="line-1408"></a>The converse is also possible and happens when we unleash demand signatures.
<a name="line-1409"></a>In @f x y@, the incoming call demand on f has arity 2. But if all we have is a
<a name="line-1410"></a>demand signature with depth 1 for @f@ (which we can safely unleash, see below),
<a name="line-1411"></a>the demand type of @f@ under a call demand of arity 2 has a *lower* depth of 1.
<a name="line-1412"></a>
<a name="line-1413"></a>So: Demand types are elicited by putting an expression under an incoming (call)
<a name="line-1414"></a>demand, the arity of which can be lower or higher than the depth of the
<a name="line-1415"></a>resulting demand type.
<a name="line-1416"></a>In contrast, a demand signature summarises a function's semantics *without*
<a name="line-1417"></a>immediately specifying the incoming demand it was produced under. Despite StrSig
<a name="line-1418"></a>being a newtype wrapper around DmdType, it actually encodes two things:
<a name="line-1419"></a>
<a name="line-1420"></a>  * The threshold (i.e., minimum arity) to unleash the signature
<a name="line-1421"></a>  * A demand type that is sound to unleash when the minimum arity requirement is
<a name="line-1422"></a>    met.
<a name="line-1423"></a>
<a name="line-1424"></a>Here comes the subtle part: The threshold is encoded in the wrapped demand
<a name="line-1425"></a>type's depth! So in mkStrictSigForArity we make sure to trim the list of
<a name="line-1426"></a>argument demands to the given threshold arity. Call sites will make sure that
<a name="line-1427"></a>this corresponds to the arity of the call demand that elicited the wrapped
<a name="line-1428"></a>demand type. See also Note [What are demand signatures?].
<a name="line-1429"></a>-}</span>
<a name="line-1430"></a>
<a name="line-1431"></a><a name="StrictSig"></a><span class='hs-comment'>-- | The depth of the wrapped 'DmdType' encodes the arity at which it is safe</span>
<a name="line-1432"></a><a name="StrictSig"></a><span class='hs-comment'>-- to unleash. Better construct this through 'mkStrictSigForArity'.</span>
<a name="line-1433"></a><a name="StrictSig"></a><span class='hs-comment'>-- See Note [Understanding DmdType and StrictSig]</span>
<a name="line-1434"></a><a name="StrictSig"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>StrictSig</span>
<a name="line-1435"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-conid'>DmdType</span>
<a name="line-1436"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Eq</span>
<a name="line-1437"></a>
<a name="line-1438"></a><a name="mkStrictSigForArity"></a><span class='hs-comment'>-- | Turns a 'DmdType' computed for the particular 'Arity' into a 'StrictSig'</span>
<a name="line-1439"></a><span class='hs-comment'>-- unleashable at that arity. See Note [Understanding DmdType and StrictSig]</span>
<a name="line-1440"></a><span class='hs-definition'>mkStrictSigForArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span>
<a name="line-1441"></a><span class='hs-definition'>mkStrictSigForArity</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>dmd_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fvs</span> <span class='hs-varid'>args</span> <span class='hs-varid'>div</span><span class='hs-layout'>)</span>
<a name="line-1442"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>dmdTypeDepth</span> <span class='hs-varid'>dmd_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>div</span><span class='hs-layout'>)</span>
<a name="line-1443"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-varid'>etaExpandDmdType</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>dmd_ty</span><span class='hs-layout'>)</span>
<a name="line-1444"></a>
<a name="line-1445"></a><a name="mkClosedStrictSig"></a><span class='hs-definition'>mkClosedStrictSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Divergence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span>
<a name="line-1446"></a><span class='hs-definition'>mkClosedStrictSig</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkStrictSigForArity</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>emptyDmdEnv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-1447"></a>
<a name="line-1448"></a><a name="splitStrictSig"></a><span class='hs-definition'>splitStrictSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Divergence</span><span class='hs-layout'>)</span>
<a name="line-1449"></a><span class='hs-definition'>splitStrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>dmds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>dmds</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-1450"></a>
<a name="line-1451"></a><a name="strictSigDmdEnv"></a><span class='hs-definition'>strictSigDmdEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span>
<a name="line-1452"></a><span class='hs-definition'>strictSigDmdEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>env</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-1453"></a>
<a name="line-1454"></a><a name="hasDemandEnvSig"></a><span class='hs-definition'>hasDemandEnvSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1455"></a><span class='hs-definition'>hasDemandEnvSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varop'>.</span> <span class='hs-varid'>strictSigDmdEnv</span>
<a name="line-1456"></a>
<a name="line-1457"></a><a name="botSig"></a><span class='hs-definition'>botSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span>
<a name="line-1458"></a><span class='hs-definition'>botSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-varid'>botDmdType</span>
<a name="line-1459"></a>
<a name="line-1460"></a><a name="nopSig"></a><span class='hs-definition'>nopSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span>
<a name="line-1461"></a><span class='hs-definition'>nopSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-varid'>nopDmdType</span>
<a name="line-1462"></a>
<a name="line-1463"></a><a name="isTopSig"></a><span class='hs-definition'>isTopSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1464"></a><span class='hs-definition'>isTopSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTopDmdType</span> <span class='hs-varid'>ty</span>
<a name="line-1465"></a>
<a name="line-1466"></a><a name="isDeadEndSig"></a><span class='hs-comment'>-- | True if the signature diverges or throws an exception in a saturated call.</span>
<a name="line-1467"></a><span class='hs-comment'>-- See Note [Dead ends].</span>
<a name="line-1468"></a><span class='hs-definition'>isDeadEndSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1469"></a><span class='hs-definition'>isDeadEndSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isDeadEndDiv</span> <span class='hs-varid'>res</span>
<a name="line-1470"></a>
<a name="line-1471"></a><a name="isDeadEndAppSig"></a><span class='hs-comment'>-- | Returns true if an application to n value args would diverge or throw an</span>
<a name="line-1472"></a><span class='hs-comment'>-- exception.</span>
<a name="line-1473"></a><span class='hs-comment'>--</span>
<a name="line-1474"></a><span class='hs-comment'>-- If a function having 'botDiv' is applied to a less number of arguments than</span>
<a name="line-1475"></a><span class='hs-comment'>-- its syntactic arity, we cannot say for sure that it is going to diverge.</span>
<a name="line-1476"></a><span class='hs-comment'>-- Hence this function conservatively returns False in that case.</span>
<a name="line-1477"></a><span class='hs-comment'>-- See Note [Dead ends].</span>
<a name="line-1478"></a><span class='hs-definition'>isDeadEndAppSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1479"></a><span class='hs-definition'>isDeadEndAppSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span>
<a name="line-1480"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isDeadEndDiv</span> <span class='hs-varid'>res</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>lengthExceeds</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-1481"></a>
<a name="line-1482"></a><a name="prependArgsStrictSig"></a><span class='hs-definition'>prependArgsStrictSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span>
<a name="line-1483"></a><span class='hs-comment'>-- ^ Add extra ('topDmd') arguments to a strictness signature.</span>
<a name="line-1484"></a><span class='hs-comment'>-- In contrast to 'etaConvertStrictSig', this /prepends/ additional argument</span>
<a name="line-1485"></a><span class='hs-comment'>-- demands. This is used by FloatOut.</span>
<a name="line-1486"></a><span class='hs-definition'>prependArgsStrictSig</span> <span class='hs-varid'>new_args</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-varid'>dmd_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1487"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>new_args</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig</span>
<a name="line-1488"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTopDmdType</span> <span class='hs-varid'>dmd_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig</span>
<a name="line-1489"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>new_args</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>0</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"prependArgsStrictSig: negative new_args"</span>
<a name="line-1490"></a>                                   <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>new_args</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span>
<a name="line-1491"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmds'</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-1492"></a>  <span class='hs-keyword'>where</span>
<a name="line-1493"></a>    <span class='hs-varid'>dmds'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>replicate</span> <span class='hs-varid'>new_args</span> <span class='hs-varid'>topDmd</span> <span class='hs-varop'>++</span> <span class='hs-varid'>dmds</span>
<a name="line-1494"></a>
<a name="line-1495"></a><a name="etaConvertStrictSig"></a><span class='hs-definition'>etaConvertStrictSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span>
<a name="line-1496"></a><span class='hs-comment'>-- ^ We are expanding (\x y. e) to (\x y z. e z) or reducing from the latter to</span>
<a name="line-1497"></a><span class='hs-comment'>-- the former (when the Simplifier identifies a new join points, for example).</span>
<a name="line-1498"></a><span class='hs-comment'>-- In contrast to 'prependArgsStrictSig', this /appends/ extra arg demands if</span>
<a name="line-1499"></a><span class='hs-comment'>-- necessary.</span>
<a name="line-1500"></a><span class='hs-comment'>-- This works by looking at the 'DmdType' (which was produced under a call</span>
<a name="line-1501"></a><span class='hs-comment'>-- demand for the old arity) and trying to transfer as many facts as we can to</span>
<a name="line-1502"></a><span class='hs-comment'>-- the call demand of new arity.</span>
<a name="line-1503"></a><span class='hs-comment'>-- An arity increase (resulting in a stronger incoming demand) can retain much</span>
<a name="line-1504"></a><span class='hs-comment'>-- of the info, while an arity decrease (a weakening of the incoming demand)</span>
<a name="line-1505"></a><span class='hs-comment'>-- must fall back to a conservative default.</span>
<a name="line-1506"></a><span class='hs-definition'>etaConvertStrictSig</span> <span class='hs-varid'>arity</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-varid'>dmd_ty</span><span class='hs-layout'>)</span>
<a name="line-1507"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>dmdTypeDepth</span> <span class='hs-varid'>dmd_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-varop'>$</span> <span class='hs-varid'>decreaseArityDmdType</span> <span class='hs-varid'>dmd_ty</span>
<a name="line-1508"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-varop'>$</span> <span class='hs-varid'>etaExpandDmdType</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>dmd_ty</span>
<a name="line-1509"></a>
<a name="line-1510"></a><span class='hs-comment'>{-
<a name="line-1511"></a>************************************************************************
<a name="line-1512"></a>*                                                                      *
<a name="line-1513"></a>                     Demand transformers
<a name="line-1514"></a>*                                                                      *
<a name="line-1515"></a>************************************************************************
<a name="line-1516"></a>-}</span>
<a name="line-1517"></a>
<a name="line-1518"></a><a name="DmdTransformer"></a><span class='hs-comment'>-- | A /demand transformer/ is a monotone function from an incoming evaluation</span>
<a name="line-1519"></a><a name="DmdTransformer"></a><span class='hs-comment'>-- context ('SubDemand') to a 'DmdType', describing how the denoted thing</span>
<a name="line-1520"></a><a name="DmdTransformer"></a><span class='hs-comment'>-- (i.e. expression, function) uses its arguments and free variables, and</span>
<a name="line-1521"></a><a name="DmdTransformer"></a><span class='hs-comment'>-- whether it diverges.</span>
<a name="line-1522"></a><a name="DmdTransformer"></a><span class='hs-comment'>--</span>
<a name="line-1523"></a><a name="DmdTransformer"></a><span class='hs-comment'>-- See Note [Understanding DmdType and StrictSig]</span>
<a name="line-1524"></a><a name="DmdTransformer"></a><span class='hs-comment'>-- and Note [What are demand signatures?].</span>
<a name="line-1525"></a><a name="DmdTransformer"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>DmdTransformer</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-1526"></a>
<a name="line-1527"></a><a name="dmdTransformSig"></a><span class='hs-comment'>-- | Extrapolate a demand signature ('StrictSig') into a 'DmdTransformer'.</span>
<a name="line-1528"></a><span class='hs-comment'>--</span>
<a name="line-1529"></a><span class='hs-comment'>-- Given a function's 'StrictSig' and a 'SubDemand' for the evaluation context,</span>
<a name="line-1530"></a><span class='hs-comment'>-- return how the function evaluates its free variables and arguments.</span>
<a name="line-1531"></a><span class='hs-definition'>dmdTransformSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdTransformer</span>
<a name="line-1532"></a><span class='hs-definition'>dmdTransformSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-varid'>dmd_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arg_ds</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>sd</span>
<a name="line-1533"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>multDmdType</span> <span class='hs-layout'>(</span><span class='hs-varid'>peelManyCalls</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>arg_ds</span><span class='hs-layout'>)</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span> <span class='hs-varid'>dmd_ty</span>
<a name="line-1534"></a>    <span class='hs-comment'>-- see Note [Demands from unsaturated function calls]</span>
<a name="line-1535"></a>    <span class='hs-comment'>-- and Note [What are demand signatures?]</span>
<a name="line-1536"></a>
<a name="line-1537"></a><a name="dmdTransformDataConSig"></a><span class='hs-comment'>-- | A special 'DmdTransformer' for data constructors that feeds product</span>
<a name="line-1538"></a><span class='hs-comment'>-- demands into the constructor arguments.</span>
<a name="line-1539"></a><span class='hs-definition'>dmdTransformDataConSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdTransformer</span>
<a name="line-1540"></a><span class='hs-definition'>dmdTransformDataConSig</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>sd</span> <span class='hs-keyword'>of</span>
<a name="line-1541"></a>  <span class='hs-conid'>Just</span> <span class='hs-varid'>dmds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>emptyDmdEnv</span> <span class='hs-varid'>dmds</span> <span class='hs-varid'>topDiv</span>
<a name="line-1542"></a>  <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>nopDmdType</span> <span class='hs-comment'>-- Not saturated</span>
<a name="line-1543"></a>  <span class='hs-keyword'>where</span>
<a name="line-1544"></a>    <span class='hs-varid'>go</span> <span class='hs-num'>0</span> <span class='hs-varid'>sd</span>                            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>viewProd</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>sd</span>
<a name="line-1545"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>viewCall</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>C_11</span><span class='hs-layout'>,</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>sd</span>  <span class='hs-comment'>-- strict calls only!</span>
<a name="line-1546"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1547"></a>
<a name="line-1548"></a><a name="dmdTransformDictSelSig"></a><span class='hs-comment'>-- | A special 'DmdTransformer' for dictionary selectors that feeds the demand</span>
<a name="line-1549"></a><span class='hs-comment'>-- on the result into the indicated dictionary component (if saturated).</span>
<a name="line-1550"></a><span class='hs-definition'>dmdTransformDictSelSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdTransformer</span>
<a name="line-1551"></a><span class='hs-comment'>-- NB: This currently doesn't handle newtype dictionaries and it's unclear how</span>
<a name="line-1552"></a><span class='hs-comment'>-- it could without additional parameters.</span>
<a name="line-1553"></a><span class='hs-definition'>dmdTransformDictSelSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>sig_sd</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>call_sd</span>
<a name="line-1554"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>sd'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>peelCallDmd</span> <span class='hs-varid'>call_sd</span>
<a name="line-1555"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>Prod</span> <span class='hs-varid'>sig_ds</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sig_sd</span>
<a name="line-1556"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>multDmdType</span> <span class='hs-varid'>n</span> <span class='hs-varop'>$</span>
<a name="line-1557"></a>     <span class='hs-conid'>DmdType</span> <span class='hs-varid'>emptyDmdEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>C_11</span> <span class='hs-conop'>:*</span> <span class='hs-conid'>Prod</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>enhance</span> <span class='hs-varid'>sd'</span><span class='hs-layout'>)</span> <span class='hs-varid'>sig_ds</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>topDiv</span>
<a name="line-1558"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1559"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nopDmdType</span> <span class='hs-comment'>-- See Note [Demand transformer for a dictionary selector]</span>
<a name="line-1560"></a>  <span class='hs-keyword'>where</span>
<a name="line-1561"></a>    <span class='hs-varid'>enhance</span> <span class='hs-varid'>sd</span> <span class='hs-varid'>old</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAbsDmd</span> <span class='hs-varid'>old</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old</span>
<a name="line-1562"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_11</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>sd</span>  <span class='hs-comment'>-- This is the one!</span>
<a name="line-1563"></a>
<a name="line-1564"></a><span class='hs-definition'>dmdTransformDictSelSig</span> <span class='hs-varid'>sig</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"dmdTransformDictSelSig: no args"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span>
<a name="line-1565"></a>
<a name="line-1566"></a><span class='hs-comment'>{-
<a name="line-1567"></a>Note [What are demand signatures?]
<a name="line-1568"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1569"></a>Demand analysis interprets expressions in the abstract domain of demand
<a name="line-1570"></a>transformers. Given a (sub-)demand that denotes the evaluation context, the
<a name="line-1571"></a>abstract transformer of an expression gives us back a demand type denoting
<a name="line-1572"></a>how other things (like arguments and free vars) were used when the expression
<a name="line-1573"></a>was evaluated. Here's an example:
<a name="line-1574"></a>
<a name="line-1575"></a>  f x y =
<a name="line-1576"></a>    if x + expensive
<a name="line-1577"></a>      then \z -&gt; z + y * ...
<a name="line-1578"></a>      else \z -&gt; z * ...
<a name="line-1579"></a>
<a name="line-1580"></a>The abstract transformer (let's call it F_e) of the if expression (let's
<a name="line-1581"></a>call it e) would transform an incoming (undersaturated!) head demand 1A into
<a name="line-1582"></a>a demand type like {x-&gt;&lt;1L&gt;,y-&gt;&lt;L&gt;}&lt;L&gt;. In pictures:
<a name="line-1583"></a>
<a name="line-1584"></a>     Demand ---F_e---&gt; DmdType
<a name="line-1585"></a>     &lt;1A&gt;              {x-&gt;&lt;1L&gt;,y-&gt;&lt;L&gt;}&lt;L&gt;
<a name="line-1586"></a>
<a name="line-1587"></a>Let's assume that the demand transformers we compute for an expression are
<a name="line-1588"></a>correct wrt. to some concrete semantics for Core. How do demand signatures fit
<a name="line-1589"></a>in? They are strange beasts, given that they come with strict rules when to
<a name="line-1590"></a>it's sound to unleash them.
<a name="line-1591"></a>
<a name="line-1592"></a>Fortunately, we can formalise the rules with Galois connections. Consider
<a name="line-1593"></a>f's strictness signature, {}&lt;1L&gt;&lt;L&gt;. It's a single-point approximation of
<a name="line-1594"></a>the actual abstract transformer of f's RHS for arity 2. So, what happens is that
<a name="line-1595"></a>we abstract *once more* from the abstract domain we already are in, replacing
<a name="line-1596"></a>the incoming Demand by a simple lattice with two elements denoting incoming
<a name="line-1597"></a>arity: A_2 = {&lt;2, &gt;=2} (where '&lt;2' is the top element and &gt;=2 the bottom
<a name="line-1598"></a>element). Here's the diagram:
<a name="line-1599"></a>
<a name="line-1600"></a>     A_2 -----f_f----&gt; DmdType
<a name="line-1601"></a>      ^                   |
<a name="line-1602"></a>      | α               γ |
<a name="line-1603"></a>      |                   v
<a name="line-1604"></a>  SubDemand --F_f----&gt; DmdType
<a name="line-1605"></a>
<a name="line-1606"></a>With
<a name="line-1607"></a>  α(C1(C1(_))) = &gt;=2
<a name="line-1608"></a>  α(_)         =  &lt;2
<a name="line-1609"></a>  γ(ty)        =  ty
<a name="line-1610"></a>and F_f being the abstract transformer of f's RHS and f_f being the abstracted
<a name="line-1611"></a>abstract transformer computable from our demand signature simply by
<a name="line-1612"></a>
<a name="line-1613"></a>  f_f(&gt;=2) = {}&lt;1L&gt;&lt;L&gt;
<a name="line-1614"></a>  f_f(&lt;2)  = multDmdType C_0N {}&lt;1L&gt;&lt;L&gt;
<a name="line-1615"></a>
<a name="line-1616"></a>where multDmdType makes a proper top element out of the given demand type.
<a name="line-1617"></a>
<a name="line-1618"></a>In practice, the A_n domain is not just a simple Bool, but a Card, which is
<a name="line-1619"></a>exactly the Card with which we have to multDmdType. The Card for arity n
<a name="line-1620"></a>is computed by calling @peelManyCalls n@, which corresponds to α above.
<a name="line-1621"></a>
<a name="line-1622"></a>Note [Demand transformer for a dictionary selector]
<a name="line-1623"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1624"></a>If we evaluate (op dict-expr) under demand 'd', then we can push the demand 'd'
<a name="line-1625"></a>into the appropriate field of the dictionary. What *is* the appropriate field?
<a name="line-1626"></a>We just look at the strictness signature of the class op, which will be
<a name="line-1627"></a>something like: P(AAA1AAAAA).  Then replace the '1' by the demand 'd'.
<a name="line-1628"></a>
<a name="line-1629"></a>For single-method classes, which are represented by newtypes the signature
<a name="line-1630"></a>of 'op' won't look like P(...), so matching on Prod will fail.
<a name="line-1631"></a>That's fine: if we are doing strictness analysis we are also doing inlining,
<a name="line-1632"></a>so we'll have inlined 'op' into a cast.  So we can bale out in a conservative
<a name="line-1633"></a>way, returning nopDmdType.
<a name="line-1634"></a>
<a name="line-1635"></a>It is (just.. #8329) possible to be running strictness analysis *without*
<a name="line-1636"></a>having inlined class ops from single-method classes.  Suppose you are using
<a name="line-1637"></a>ghc --make; and the first module has a local -O0 flag.  So you may load a class
<a name="line-1638"></a>without interface pragmas, ie (currently) without an unfolding for the class
<a name="line-1639"></a>ops.   Now if a subsequent module in the --make sweep has a local -O flag
<a name="line-1640"></a>you might do strictness analysis, but there is no inlining for the class op.
<a name="line-1641"></a>This is weird, so I'm not worried about whether this optimises brilliantly; but
<a name="line-1642"></a>it should not fall over.
<a name="line-1643"></a>-}</span>
<a name="line-1644"></a>
<a name="line-1645"></a><a name="zapDmdEnvSig"></a><span class='hs-comment'>-- | Remove the demand environment from the signature.</span>
<a name="line-1646"></a><span class='hs-definition'>zapDmdEnvSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span>
<a name="line-1647"></a><span class='hs-definition'>zapDmdEnvSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkClosedStrictSig</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>r</span>
<a name="line-1648"></a>
<a name="line-1649"></a><a name="zapUsageDemand"></a><span class='hs-definition'>zapUsageDemand</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-1650"></a><span class='hs-comment'>-- Remove the usage info, but not the strictness info, from the demand</span>
<a name="line-1651"></a><span class='hs-definition'>zapUsageDemand</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kill_usage</span> <span class='hs-varop'>$</span> <span class='hs-conid'>KillFlags</span>
<a name="line-1652"></a>    <span class='hs-layout'>{</span> <span class='hs-varid'>kf_abs</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1653"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>kf_used_once</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1654"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>kf_called_once</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1655"></a>    <span class='hs-layout'>}</span>
<a name="line-1656"></a>
<a name="line-1657"></a><a name="zapUsedOnceDemand"></a><span class='hs-comment'>-- | Remove all `C_01 :*` info (but not `CM` sub-demands) from the demand</span>
<a name="line-1658"></a><span class='hs-definition'>zapUsedOnceDemand</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-1659"></a><span class='hs-definition'>zapUsedOnceDemand</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kill_usage</span> <span class='hs-varop'>$</span> <span class='hs-conid'>KillFlags</span>
<a name="line-1660"></a>    <span class='hs-layout'>{</span> <span class='hs-varid'>kf_abs</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1661"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>kf_used_once</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1662"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>kf_called_once</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1663"></a>    <span class='hs-layout'>}</span>
<a name="line-1664"></a>
<a name="line-1665"></a><a name="zapUsedOnceSig"></a><span class='hs-comment'>-- | Remove all `C_01 :*` info (but not `CM` sub-demands) from the strictness</span>
<a name="line-1666"></a><span class='hs-comment'>--   signature</span>
<a name="line-1667"></a><span class='hs-definition'>zapUsedOnceSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span>
<a name="line-1668"></a><span class='hs-definition'>zapUsedOnceSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1669"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>zapUsedOnceDemand</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1670"></a>
<a name="line-1671"></a><a name="KillFlags"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>KillFlags</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>KillFlags</span>
<a name="line-1672"></a>    <span class='hs-layout'>{</span> <span class='hs-varid'>kf_abs</span>         <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-1673"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>kf_used_once</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-1674"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>kf_called_once</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-1675"></a>    <span class='hs-layout'>}</span>
<a name="line-1676"></a>
<a name="line-1677"></a><a name="kill_usage_card"></a><span class='hs-definition'>kill_usage_card</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>KillFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Card</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Card</span>
<a name="line-1678"></a><span class='hs-definition'>kill_usage_card</span> <span class='hs-varid'>kfs</span> <span class='hs-conid'>C_00</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kf_abs</span> <span class='hs-varid'>kfs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_0N</span>
<a name="line-1679"></a><span class='hs-definition'>kill_usage_card</span> <span class='hs-varid'>kfs</span> <span class='hs-conid'>C_10</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kf_abs</span> <span class='hs-varid'>kfs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_1N</span>
<a name="line-1680"></a><span class='hs-definition'>kill_usage_card</span> <span class='hs-varid'>kfs</span> <span class='hs-conid'>C_01</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kf_used_once</span> <span class='hs-varid'>kfs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_0N</span>
<a name="line-1681"></a><span class='hs-definition'>kill_usage_card</span> <span class='hs-varid'>kfs</span> <span class='hs-conid'>C_11</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kf_used_once</span> <span class='hs-varid'>kfs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C_1N</span>
<a name="line-1682"></a><span class='hs-definition'>kill_usage_card</span> <span class='hs-keyword'>_</span>   <span class='hs-varid'>n</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-1683"></a>
<a name="line-1684"></a><a name="kill_usage"></a><span class='hs-definition'>kill_usage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>KillFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-1685"></a><span class='hs-definition'>kill_usage</span> <span class='hs-varid'>kfs</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kill_usage_card</span> <span class='hs-varid'>kfs</span> <span class='hs-varid'>n</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>kill_usage_sd</span> <span class='hs-varid'>kfs</span> <span class='hs-varid'>sd</span>
<a name="line-1686"></a>
<a name="line-1687"></a><a name="kill_usage_sd"></a><span class='hs-definition'>kill_usage_sd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>KillFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubDemand</span>
<a name="line-1688"></a><span class='hs-definition'>kill_usage_sd</span> <span class='hs-varid'>kfs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-varid'>n</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span>
<a name="line-1689"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kf_called_once</span> <span class='hs-varid'>kfs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCall</span> <span class='hs-layout'>(</span><span class='hs-varid'>lubCard</span> <span class='hs-conid'>C_1N</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>kill_usage_sd</span> <span class='hs-varid'>kfs</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span>
<a name="line-1690"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCall</span> <span class='hs-varid'>n</span>                <span class='hs-layout'>(</span><span class='hs-varid'>kill_usage_sd</span> <span class='hs-varid'>kfs</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span>
<a name="line-1691"></a><span class='hs-definition'>kill_usage_sd</span> <span class='hs-varid'>kfs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Prod</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Prod</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>kill_usage</span> <span class='hs-varid'>kfs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-1692"></a><span class='hs-definition'>kill_usage_sd</span> <span class='hs-keyword'>_</span>   <span class='hs-varid'>sd</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sd</span>
<a name="line-1693"></a>
<a name="line-1694"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1695"></a>*                                                                      *
<a name="line-1696"></a>               TypeShape and demand trimming
<a name="line-1697"></a>*                                                                      *
<a name="line-1698"></a>********************************************************************* -}</span>
<a name="line-1699"></a>
<a name="line-1700"></a>
<a name="line-1701"></a><a name="TypeShape"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TypeShape</span> <span class='hs-comment'>-- See Note [Trimming a demand to a type]</span>
<a name="line-1702"></a>               <span class='hs-comment'>--     in GHC.Core.Opt.DmdAnal</span>
<a name="line-1703"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TsFun</span> <span class='hs-conid'>TypeShape</span>
<a name="line-1704"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TsProd</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TypeShape</span><span class='hs-keyglyph'>]</span>
<a name="line-1705"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TsUnk</span>
<a name="line-1706"></a>
<a name="line-1707"></a><a name="trimToType"></a><span class='hs-definition'>trimToType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeShape</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-1708"></a><span class='hs-comment'>-- See Note [Trimming a demand to a type] in GHC.Core.Opt.DmdAnal</span>
<a name="line-1709"></a><span class='hs-definition'>trimToType</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span> <span class='hs-varid'>ts</span>
<a name="line-1710"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>go</span> <span class='hs-varid'>sd</span> <span class='hs-varid'>ts</span>
<a name="line-1711"></a>  <span class='hs-keyword'>where</span>
<a name="line-1712"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Prod</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>   <span class='hs-layout'>(</span><span class='hs-conid'>TsProd</span> <span class='hs-varid'>tss</span><span class='hs-layout'>)</span>
<a name="line-1713"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>equalLength</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>tss</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Prod</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>trimToType</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>tss</span><span class='hs-layout'>)</span>
<a name="line-1714"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-varid'>n</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TsFun</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCall</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>sd</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>
<a name="line-1715"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>sd</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Poly</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sd</span>
<a name="line-1716"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>           <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topSubDmd</span>
<a name="line-1717"></a>
<a name="line-1718"></a><span class='hs-comment'>{-
<a name="line-1719"></a>************************************************************************
<a name="line-1720"></a>*                                                                      *
<a name="line-1721"></a>                     'seq'ing demands
<a name="line-1722"></a>*                                                                      *
<a name="line-1723"></a>************************************************************************
<a name="line-1724"></a>-}</span>
<a name="line-1725"></a>
<a name="line-1726"></a><a name="seqDemand"></a><span class='hs-definition'>seqDemand</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-1727"></a><span class='hs-definition'>seqDemand</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqSubDemand</span> <span class='hs-varid'>sd</span>
<a name="line-1728"></a>
<a name="line-1729"></a><a name="seqSubDemand"></a><span class='hs-definition'>seqSubDemand</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-1730"></a><span class='hs-definition'>seqSubDemand</span> <span class='hs-layout'>(</span><span class='hs-conid'>Prod</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqDemandList</span> <span class='hs-varid'>ds</span>
<a name="line-1731"></a><span class='hs-definition'>seqSubDemand</span> <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqSubDemand</span> <span class='hs-varid'>sd</span>
<a name="line-1732"></a><span class='hs-definition'>seqSubDemand</span> <span class='hs-layout'>(</span><span class='hs-conid'>Poly</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-1733"></a>
<a name="line-1734"></a><a name="seqDemandList"></a><span class='hs-definition'>seqDemandList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-1735"></a><span class='hs-definition'>seqDemandList</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>seq</span> <span class='hs-varop'>.</span> <span class='hs-varid'>seqDemand</span><span class='hs-layout'>)</span> <span class='hs-conid'>()</span>
<a name="line-1736"></a>
<a name="line-1737"></a><a name="seqDmdType"></a><span class='hs-definition'>seqDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-1738"></a><span class='hs-definition'>seqDmdType</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1739"></a>  <span class='hs-varid'>seqDmdEnv</span> <span class='hs-varid'>env</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqDemandList</span> <span class='hs-varid'>ds</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>res</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>()</span>
<a name="line-1740"></a>
<a name="line-1741"></a><a name="seqDmdEnv"></a><span class='hs-definition'>seqDmdEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-1742"></a><span class='hs-definition'>seqDmdEnv</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqEltsUFM</span> <span class='hs-varid'>seqDemandList</span> <span class='hs-varid'>env</span>
<a name="line-1743"></a>
<a name="line-1744"></a><a name="seqStrictSig"></a><span class='hs-definition'>seqStrictSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-1745"></a><span class='hs-definition'>seqStrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqDmdType</span> <span class='hs-varid'>ty</span>
<a name="line-1746"></a>
<a name="line-1747"></a><span class='hs-comment'>{-
<a name="line-1748"></a>************************************************************************
<a name="line-1749"></a>*                                                                      *
<a name="line-1750"></a>                     Outputable and Binary instances
<a name="line-1751"></a>*                                                                      *
<a name="line-1752"></a>************************************************************************
<a name="line-1753"></a>-}</span>
<a name="line-1754"></a>
<a name="line-1755"></a><span class='hs-comment'>{- Note [Demand notation]
<a name="line-1756"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1757"></a>This Note should be kept up to date with the documentation of `-fstrictness`
<a name="line-1758"></a>in the user's guide.
<a name="line-1759"></a>
<a name="line-1760"></a>For pretty-printing demands, we use quite a compact notation with some
<a name="line-1761"></a>abbreviations. Here's the BNF:
<a name="line-1762"></a>
<a name="line-1763"></a>  card ::= B    {}
<a name="line-1764"></a>        |  A    {0}
<a name="line-1765"></a>        |  M    {0,1}
<a name="line-1766"></a>        |  L    {0,1,n}
<a name="line-1767"></a>        |  1    {1}
<a name="line-1768"></a>        |  S    {1,n}
<a name="line-1769"></a>
<a name="line-1770"></a>  d    ::= card sd                  The :* constructor, just juxtaposition
<a name="line-1771"></a>        |  card                     abbreviation: Same as "card card",
<a name="line-1772"></a>                                                  in code @polyDmd card@
<a name="line-1773"></a>
<a name="line-1774"></a>  sd   ::= card                     @Poly card@
<a name="line-1775"></a>        |  P(d,d,..)                @Prod [d1,d2,..]@
<a name="line-1776"></a>        |  Ccard(sd)                @Call card sd@
<a name="line-1777"></a>
<a name="line-1778"></a>So, L can denote a 'Card', polymorphic 'SubDemand' or polymorphic 'Demand',
<a name="line-1779"></a>but it's always clear from context which "overload" is meant. It's like
<a name="line-1780"></a>return-type inference of e.g. 'read'.
<a name="line-1781"></a>
<a name="line-1782"></a>Examples are in the haddock for 'Demand'.
<a name="line-1783"></a>
<a name="line-1784"></a>This is the syntax for demand signatures:
<a name="line-1785"></a>
<a name="line-1786"></a>  div ::= &lt;empty&gt;      topDiv
<a name="line-1787"></a>       |  x            exnDiv
<a name="line-1788"></a>       |  b            botDiv
<a name="line-1789"></a>
<a name="line-1790"></a>  sig ::= {x-&gt;dx,y-&gt;dy,z-&gt;dz...}&lt;d1&gt;&lt;d2&gt;&lt;d3&gt;...&lt;dn&gt;div
<a name="line-1791"></a>                  ^              ^   ^   ^      ^   ^
<a name="line-1792"></a>                  |              |   |   |      |   |
<a name="line-1793"></a>                  |              \---+---+------/   |
<a name="line-1794"></a>                  |                  |              |
<a name="line-1795"></a>             demand on free        demand on      divergence
<a name="line-1796"></a>               variables           arguments      information
<a name="line-1797"></a>           (omitted if empty)                     (omitted if
<a name="line-1798"></a>                                                no information)
<a name="line-1799"></a>
<a name="line-1800"></a>
<a name="line-1801"></a>-}</span>
<a name="line-1802"></a>
<a name="line-1803"></a><a name="instance%20Outputable%20Card"></a><span class='hs-comment'>-- | See Note [Demand notation]</span>
<a name="line-1804"></a><a name="instance%20Outputable%20Card"></a><span class='hs-comment'>-- Current syntax was discussed in #19016.</span>
<a name="line-1805"></a><a name="instance%20Outputable%20Card"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Card</span> <span class='hs-keyword'>where</span>
<a name="line-1806"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>C_00</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'A'</span> <span class='hs-comment'>-- "Absent"</span>
<a name="line-1807"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>C_01</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'M'</span> <span class='hs-comment'>-- "Maybe"</span>
<a name="line-1808"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>C_0N</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'L'</span> <span class='hs-comment'>-- "Lazy"</span>
<a name="line-1809"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>C_11</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'1'</span> <span class='hs-comment'>-- "exactly 1"</span>
<a name="line-1810"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>C_1N</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'S'</span> <span class='hs-comment'>-- "Strict"</span>
<a name="line-1811"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>C_10</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'B'</span> <span class='hs-comment'>-- "Bottom"</span>
<a name="line-1812"></a>
<a name="line-1813"></a><a name="instance%20Outputable%20Demand"></a><span class='hs-comment'>-- | See Note [Demand notation]</span>
<a name="line-1814"></a><a name="instance%20Outputable%20Demand"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Demand</span> <span class='hs-keyword'>where</span>
<a name="line-1815"></a>  <span class='hs-varid'>ppr</span> <span class='hs-varid'>dmd</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span>
<a name="line-1816"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAbs</span> <span class='hs-varid'>n</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span>   <span class='hs-comment'>-- If absent, sd is arbitrary</span>
<a name="line-1817"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dmd</span> <span class='hs-varop'>==</span> <span class='hs-varid'>polyDmd</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span>   <span class='hs-comment'>-- Print UU as just U</span>
<a name="line-1818"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sd</span>
<a name="line-1819"></a>
<a name="line-1820"></a><a name="instance%20Outputable%20SubDemand"></a><span class='hs-comment'>-- | See Note [Demand notation]</span>
<a name="line-1821"></a><a name="instance%20Outputable%20SubDemand"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>SubDemand</span> <span class='hs-keyword'>where</span>
<a name="line-1822"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Poly</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sd</span>
<a name="line-1823"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-varid'>n</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'C'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span>
<a name="line-1824"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Prod</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'P'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>fields</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-1825"></a>    <span class='hs-keyword'>where</span>
<a name="line-1826"></a>      <span class='hs-varid'>fields</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-1827"></a>      <span class='hs-varid'>fields</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>x</span>
<a name="line-1828"></a>      <span class='hs-varid'>fields</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>','</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>fields</span> <span class='hs-varid'>xs</span>
<a name="line-1829"></a>
<a name="line-1830"></a><a name="instance%20Outputable%20Divergence"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Divergence</span> <span class='hs-keyword'>where</span>
<a name="line-1831"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Diverges</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'b'</span> <span class='hs-comment'>-- for (b)ottom</span>
<a name="line-1832"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>ExnOrDiv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'x'</span> <span class='hs-comment'>-- for e(x)ception</span>
<a name="line-1833"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Dunno</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-1834"></a>
<a name="line-1835"></a><a name="instance%20Outputable%20DmdType"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyword'>where</span>
<a name="line-1836"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-1837"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>hcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>angleBrackets</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ppr</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>res</span><span class='hs-layout'>,</span>
<a name="line-1838"></a>            <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>fv_elts</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>empty</span>
<a name="line-1839"></a>            <span class='hs-keyword'>else</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pp_elt</span> <span class='hs-varid'>fv_elts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1840"></a>    <span class='hs-keyword'>where</span>
<a name="line-1841"></a>      <span class='hs-varid'>pp_elt</span> <span class='hs-layout'>(</span><span class='hs-varid'>uniq</span><span class='hs-layout'>,</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>uniq</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"-&gt;"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dmd</span>
<a name="line-1842"></a>      <span class='hs-varid'>fv_elts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nonDetUFMToList</span> <span class='hs-varid'>fv</span>
<a name="line-1843"></a>        <span class='hs-comment'>-- It's OK to use nonDetUFMToList here because we only do it for</span>
<a name="line-1844"></a>        <span class='hs-comment'>-- pretty printing</span>
<a name="line-1845"></a>
<a name="line-1846"></a><a name="instance%20Outputable%20StrictSig"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyword'>where</span>
<a name="line-1847"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-1848"></a>
<a name="line-1849"></a><a name="instance%20Outputable%20TypeShape"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TypeShape</span> <span class='hs-keyword'>where</span>
<a name="line-1850"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>TsUnk</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TsUnk"</span>
<a name="line-1851"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TsFun</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TsFun"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>
<a name="line-1852"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TsProd</span> <span class='hs-varid'>tss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-varop'>$</span> <span class='hs-varid'>punctuate</span> <span class='hs-varid'>comma</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tss</span><span class='hs-layout'>)</span>
<a name="line-1853"></a>
<a name="line-1854"></a><a name="instance%20Binary%20Card"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>Card</span> <span class='hs-keyword'>where</span>
<a name="line-1855"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>C_00</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>0</span>
<a name="line-1856"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>C_01</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span>
<a name="line-1857"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>C_0N</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>2</span>
<a name="line-1858"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>C_11</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>3</span>
<a name="line-1859"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>C_1N</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>4</span>
<a name="line-1860"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>C_10</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>5</span>
<a name="line-1861"></a>  <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1862"></a>    <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-1863"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span>
<a name="line-1864"></a>      <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>C_00</span>
<a name="line-1865"></a>      <span class='hs-num'>1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>C_01</span>
<a name="line-1866"></a>      <span class='hs-num'>2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>C_0N</span>
<a name="line-1867"></a>      <span class='hs-num'>3</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>C_11</span>
<a name="line-1868"></a>      <span class='hs-num'>4</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>C_1N</span>
<a name="line-1869"></a>      <span class='hs-num'>5</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>C_10</span>
<a name="line-1870"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"Binary:Card"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1871"></a>
<a name="line-1872"></a><a name="instance%20Binary%20Demand"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>Demand</span> <span class='hs-keyword'>where</span>
<a name="line-1873"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-conop'>:*</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>n</span> <span class='hs-varop'>*&gt;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>sd</span>
<a name="line-1874"></a>  <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conop'>:*</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-1875"></a>
<a name="line-1876"></a><a name="instance%20Binary%20SubDemand"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>SubDemand</span> <span class='hs-keyword'>where</span>
<a name="line-1877"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>Poly</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>0</span> <span class='hs-varop'>*&gt;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>sd</span>
<a name="line-1878"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-varid'>n</span> <span class='hs-varid'>sd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span> <span class='hs-varop'>*&gt;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>n</span> <span class='hs-varop'>*&gt;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>sd</span>
<a name="line-1879"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>Prod</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>2</span> <span class='hs-varop'>*&gt;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>ds</span>
<a name="line-1880"></a>  <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1881"></a>    <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-1882"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span>
<a name="line-1883"></a>      <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Poly</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-1884"></a>      <span class='hs-num'>1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkCall</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-1885"></a>      <span class='hs-num'>2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Prod</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-1886"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"Binary:SubDemand"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1887"></a>
<a name="line-1888"></a><a name="instance%20Binary%20StrictSig"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyword'>where</span>
<a name="line-1889"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-varid'>aa</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>aa</span>
<a name="line-1890"></a>  <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-1891"></a>
<a name="line-1892"></a><a name="instance%20Binary%20DmdType"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyword'>where</span>
<a name="line-1893"></a>  <span class='hs-comment'>-- Ignore DmdEnv when spitting out the DmdType</span>
<a name="line-1894"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>dr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>ds</span> <span class='hs-varop'>*&gt;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>dr</span>
<a name="line-1895"></a>  <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>emptyDmdEnv</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-1896"></a>
<a name="line-1897"></a><a name="instance%20Binary%20Divergence"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>Divergence</span> <span class='hs-keyword'>where</span>
<a name="line-1898"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>Dunno</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>0</span>
<a name="line-1899"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>ExnOrDiv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span>
<a name="line-1900"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>Diverges</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>2</span>
<a name="line-1901"></a>  <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1902"></a>    <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-1903"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span>
<a name="line-1904"></a>      <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Dunno</span>
<a name="line-1905"></a>      <span class='hs-num'>1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>ExnOrDiv</span>
<a name="line-1906"></a>      <span class='hs-num'>2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Diverges</span>
<a name="line-1907"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"Binary:Divergence"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre></body>
</html>
