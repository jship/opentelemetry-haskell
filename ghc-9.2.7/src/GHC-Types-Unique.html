<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Types/Unique.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The University of Glasgow 2006
<a name="line-3"></a>(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
<a name="line-4"></a>
<a name="line-5"></a>
<a name="line-6"></a>@Uniques@ are used to distinguish entities in the compiler (@Ids@,
<a name="line-7"></a>@Classes@, etc.) from each other.  Thus, @Uniques@ are the basic
<a name="line-8"></a>comparison key in the compiler.
<a name="line-9"></a>
<a name="line-10"></a>If there is any single operation that needs to be fast, it is @Unique@
<a name="line-11"></a>
<a name="line-12"></a>comparison.  Unsurprisingly, there is quite a bit of huff-and-puff
<a name="line-13"></a>directed to that end.
<a name="line-14"></a>
<a name="line-15"></a>Some of the other hair in this code is to be able to use a
<a name="line-16"></a>``splittable @UniqueSupply@'' if requested/possible (not standard
<a name="line-17"></a>Haskell).
<a name="line-18"></a>-}</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-comment'>{-# LANGUAGE CPP, BangPatterns, MagicHash #-}</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Types.Unique</span> <span class='hs-layout'>(</span>
<a name="line-23"></a>        <span class='hs-comment'>-- * Main data types</span>
<a name="line-24"></a>        <span class='hs-conid'>Unique</span><span class='hs-layout'>,</span> <span class='hs-conid'>Uniquable</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-25"></a>        <span class='hs-varid'>uNIQUE_BITS</span><span class='hs-layout'>,</span>
<a name="line-26"></a>
<a name="line-27"></a>        <span class='hs-comment'>-- ** Constructors, destructors and operations on 'Unique's</span>
<a name="line-28"></a>        <span class='hs-varid'>hasKey</span><span class='hs-layout'>,</span>
<a name="line-29"></a>
<a name="line-30"></a>        <span class='hs-varid'>pprUniqueAlways</span><span class='hs-layout'>,</span>
<a name="line-31"></a>
<a name="line-32"></a>        <span class='hs-varid'>mkUniqueGrimily</span><span class='hs-layout'>,</span>
<a name="line-33"></a>        <span class='hs-varid'>getKey</span><span class='hs-layout'>,</span>
<a name="line-34"></a>        <span class='hs-varid'>mkUnique</span><span class='hs-layout'>,</span> <span class='hs-varid'>unpkUnique</span><span class='hs-layout'>,</span>
<a name="line-35"></a>        <span class='hs-varid'>eqUnique</span><span class='hs-layout'>,</span> <span class='hs-varid'>ltUnique</span><span class='hs-layout'>,</span>
<a name="line-36"></a>        <span class='hs-varid'>incrUnique</span><span class='hs-layout'>,</span> <span class='hs-varid'>stepUnique</span><span class='hs-layout'>,</span>
<a name="line-37"></a>
<a name="line-38"></a>        <span class='hs-varid'>newTagUnique</span><span class='hs-layout'>,</span>
<a name="line-39"></a>        <span class='hs-varid'>nonDetCmpUnique</span><span class='hs-layout'>,</span>
<a name="line-40"></a>        <span class='hs-varid'>isValidKnownKeyUnique</span><span class='hs-layout'>,</span>
<a name="line-41"></a>
<a name="line-42"></a>        <span class='hs-comment'>-- ** Local uniques</span>
<a name="line-43"></a>        <span class='hs-comment'>-- | These are exposed exclusively for use by 'GHC.Types.Var.Env.uniqAway', which</span>
<a name="line-44"></a>        <span class='hs-comment'>-- has rather peculiar needs. See Note [Local uniques].</span>
<a name="line-45"></a>        <span class='hs-varid'>mkLocalUnique</span><span class='hs-layout'>,</span> <span class='hs-varid'>minLocalUnique</span><span class='hs-layout'>,</span> <span class='hs-varid'>maxLocalUnique</span><span class='hs-layout'>,</span>
<a name="line-46"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-47"></a>
<a name="line-48"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-49"></a><span class='hs-cpp'>#include "Unique.h"</span>
<a name="line-50"></a>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.FastString</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-comment'>-- just for implementing a fast [0,61) -&gt; Char function</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Exts</span> <span class='hs-layout'>(</span><span class='hs-varid'>indexCharOffAddr</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span> <span class='hs-conid'>Char</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-60"></a>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Char</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>chr</span><span class='hs-layout'>,</span> <span class='hs-varid'>ord</span> <span class='hs-layout'>)</span>
<a name="line-62"></a>
<a name="line-63"></a><span class='hs-comment'>{-
<a name="line-64"></a>************************************************************************
<a name="line-65"></a>*                                                                      *
<a name="line-66"></a>\subsection[Unique-type]{@Unique@ type and operations}
<a name="line-67"></a>*                                                                      *
<a name="line-68"></a>************************************************************************
<a name="line-69"></a>
<a name="line-70"></a>Note [Uniques and masks]
<a name="line-71"></a>~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-72"></a>A `Unique` in GHC is a Word-sized value composed of two pieces:
<a name="line-73"></a>* A "mask", of width `UNIQUE_TAG_BITS`, in the high order bits
<a name="line-74"></a>* A number, of width `uNIQUE_BITS`, which fills up the remainder of the Word
<a name="line-75"></a>
<a name="line-76"></a>The mask is typically an ASCII character.  It is typically used to make it easier
<a name="line-77"></a>to distinguish uniques constructed by different parts of the compiler.
<a name="line-78"></a>There is a (potentially incomplete) list of unique masks used given in
<a name="line-79"></a>GHC.Builtin.Uniques. See Note [Uniques-prelude - Uniques for wired-in Prelude things]
<a name="line-80"></a>
<a name="line-81"></a>`mkUnique` constructs a `Unique` from its pieces
<a name="line-82"></a>  mkUnique :: Char -&gt; Int -&gt; Unique
<a name="line-83"></a>
<a name="line-84"></a>-}</span>
<a name="line-85"></a>
<a name="line-86"></a><a name="Unique"></a><span class='hs-comment'>-- | Unique identifier.</span>
<a name="line-87"></a><a name="Unique"></a><span class='hs-comment'>--</span>
<a name="line-88"></a><a name="Unique"></a><span class='hs-comment'>-- The type of unique identifiers that are used in many places in GHC</span>
<a name="line-89"></a><a name="Unique"></a><span class='hs-comment'>-- for fast ordering and equality tests. You should generate these with</span>
<a name="line-90"></a><a name="Unique"></a><span class='hs-comment'>-- the functions from the 'UniqSupply' module</span>
<a name="line-91"></a><a name="Unique"></a><span class='hs-comment'>--</span>
<a name="line-92"></a><a name="Unique"></a><span class='hs-comment'>-- These are sometimes also referred to as \"keys\" in comments in GHC.</span>
<a name="line-93"></a><a name="Unique"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MkUnique</span> <span class='hs-conid'>Int</span>
<a name="line-94"></a>
<a name="line-95"></a><a name="uNIQUE_BITS"></a><span class='hs-comment'>{-# INLINE uNIQUE_BITS #-}</span>
<a name="line-96"></a><span class='hs-definition'>uNIQUE_BITS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-97"></a><span class='hs-definition'>uNIQUE_BITS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>finiteBitSize</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-comment'>-</span> <span class='hs-conid'>UNIQUE_TAG_BITS</span>
<a name="line-98"></a>
<a name="line-99"></a><span class='hs-comment'>{-
<a name="line-100"></a>Now come the functions which construct uniques from their pieces, and vice versa.
<a name="line-101"></a>The stuff about unique *supplies* is handled further down this module.
<a name="line-102"></a>-}</span>
<a name="line-103"></a>
<a name="line-104"></a><a name="unpkUnique"></a><span class='hs-definition'>unpkUnique</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Char</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- The reverse</span>
<a name="line-105"></a>
<a name="line-106"></a><a name="mkUniqueGrimily"></a><span class='hs-definition'>mkUniqueGrimily</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span>                <span class='hs-comment'>-- A trap-door for UniqSupply</span>
<a name="line-107"></a><a name="getKey"></a><span class='hs-definition'>getKey</span>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>                <span class='hs-comment'>-- for Var</span>
<a name="line-108"></a>
<a name="line-109"></a><a name="incrUnique"></a><span class='hs-definition'>incrUnique</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span>
<a name="line-110"></a><a name="stepUnique"></a><span class='hs-definition'>stepUnique</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span>
<a name="line-111"></a><a name="newTagUnique"></a><span class='hs-definition'>newTagUnique</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Char</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span>
<a name="line-112"></a>
<a name="line-113"></a><span class='hs-definition'>mkUniqueGrimily</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MkUnique</span>
<a name="line-114"></a>
<a name="line-115"></a><span class='hs-comment'>{-# INLINE getKey #-}</span>
<a name="line-116"></a><span class='hs-definition'>getKey</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkUnique</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span>
<a name="line-117"></a>
<a name="line-118"></a><span class='hs-definition'>incrUnique</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkUnique</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MkUnique</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-119"></a><span class='hs-definition'>stepUnique</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkUnique</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MkUnique</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span> <span class='hs-varop'>+</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-120"></a>
<a name="line-121"></a><a name="mkLocalUnique"></a><span class='hs-definition'>mkLocalUnique</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span>
<a name="line-122"></a><span class='hs-definition'>mkLocalUnique</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnique</span> <span class='hs-chr'>'X'</span> <span class='hs-varid'>i</span>
<a name="line-123"></a>
<a name="line-124"></a><a name="minLocalUnique"></a><span class='hs-definition'>minLocalUnique</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span>
<a name="line-125"></a><span class='hs-definition'>minLocalUnique</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalUnique</span> <span class='hs-num'>0</span>
<a name="line-126"></a>
<a name="line-127"></a><a name="maxLocalUnique"></a><span class='hs-definition'>maxLocalUnique</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span>
<a name="line-128"></a><span class='hs-definition'>maxLocalUnique</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalUnique</span> <span class='hs-varid'>uniqueMask</span>
<a name="line-129"></a>
<a name="line-130"></a><span class='hs-comment'>-- newTagUnique changes the "domain" of a unique to a different char</span>
<a name="line-131"></a><span class='hs-definition'>newTagUnique</span> <span class='hs-varid'>u</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnique</span> <span class='hs-varid'>c</span> <span class='hs-varid'>i</span> <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unpkUnique</span> <span class='hs-varid'>u</span>
<a name="line-132"></a>
<a name="line-133"></a><a name="uniqueMask"></a><span class='hs-comment'>-- | How many bits are devoted to the unique index (as opposed to the class</span>
<a name="line-134"></a><span class='hs-comment'>-- character).</span>
<a name="line-135"></a><span class='hs-definition'>uniqueMask</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-136"></a><span class='hs-definition'>uniqueMask</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span> <span class='hs-varop'>`shiftL`</span> <span class='hs-varid'>uNIQUE_BITS</span><span class='hs-layout'>)</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span>
<a name="line-137"></a>
<a name="line-138"></a><span class='hs-comment'>-- pop the Char in the top 8 bits of the Unique(Supply)</span>
<a name="line-139"></a>
<a name="line-140"></a><span class='hs-comment'>-- No 64-bit bugs here, as long as we have at least 32 bits. --JSM</span>
<a name="line-141"></a>
<a name="line-142"></a><span class='hs-comment'>-- and as long as the Char fits in 8 bits, which we assume anyway!</span>
<a name="line-143"></a>
<a name="line-144"></a><a name="mkUnique"></a><span class='hs-definition'>mkUnique</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Char</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span>       <span class='hs-comment'>-- Builds a unique from pieces</span>
<a name="line-145"></a><span class='hs-comment'>-- EXPORTED and used only in GHC.Builtin.Uniques</span>
<a name="line-146"></a><span class='hs-definition'>mkUnique</span> <span class='hs-varid'>c</span> <span class='hs-varid'>i</span>
<a name="line-147"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MkUnique</span> <span class='hs-layout'>(</span><span class='hs-varid'>tag</span> <span class='hs-varop'>.|.</span> <span class='hs-varid'>bits</span><span class='hs-layout'>)</span>
<a name="line-148"></a>  <span class='hs-keyword'>where</span>
<a name="line-149"></a>    <span class='hs-varid'>tag</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ord</span> <span class='hs-varid'>c</span> <span class='hs-varop'>`shiftL`</span> <span class='hs-varid'>uNIQUE_BITS</span>
<a name="line-150"></a>    <span class='hs-varid'>bits</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span> <span class='hs-varop'>.&amp;.</span> <span class='hs-varid'>uniqueMask</span>
<a name="line-151"></a>
<a name="line-152"></a><span class='hs-definition'>unpkUnique</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkUnique</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-153"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>
<a name="line-154"></a>        <span class='hs-comment'>-- as long as the Char may have its eighth bit set, we</span>
<a name="line-155"></a>        <span class='hs-comment'>-- really do need the logical right-shift here!</span>
<a name="line-156"></a>        <span class='hs-varid'>tag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>chr</span> <span class='hs-layout'>(</span><span class='hs-varid'>u</span> <span class='hs-varop'>`shiftR`</span> <span class='hs-varid'>uNIQUE_BITS</span><span class='hs-layout'>)</span>
<a name="line-157"></a>        <span class='hs-varid'>i</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span> <span class='hs-varop'>.&amp;.</span> <span class='hs-varid'>uniqueMask</span>
<a name="line-158"></a>    <span class='hs-keyword'>in</span>
<a name="line-159"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tag</span><span class='hs-layout'>,</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-160"></a>
<a name="line-161"></a><a name="isValidKnownKeyUnique"></a><span class='hs-comment'>-- | The interface file symbol-table encoding assumes that known-key uniques fit</span>
<a name="line-162"></a><span class='hs-comment'>-- in 30-bits; verify this.</span>
<a name="line-163"></a><span class='hs-comment'>--</span>
<a name="line-164"></a><span class='hs-comment'>-- See Note [Symbol table representation of names] in "GHC.Iface.Binary" for details.</span>
<a name="line-165"></a><span class='hs-definition'>isValidKnownKeyUnique</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-166"></a><span class='hs-definition'>isValidKnownKeyUnique</span> <span class='hs-varid'>u</span> <span class='hs-keyglyph'>=</span>
<a name="line-167"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>unpkUnique</span> <span class='hs-varid'>u</span> <span class='hs-keyword'>of</span>
<a name="line-168"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-layout'>,</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ord</span> <span class='hs-varid'>c</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>0xff</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&lt;=</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span> <span class='hs-varop'>`shiftL`</span> <span class='hs-num'>22</span><span class='hs-layout'>)</span>
<a name="line-169"></a>
<a name="line-170"></a><span class='hs-comment'>{-
<a name="line-171"></a>************************************************************************
<a name="line-172"></a>*                                                                      *
<a name="line-173"></a>\subsection[Uniquable-class]{The @Uniquable@ class}
<a name="line-174"></a>*                                                                      *
<a name="line-175"></a>************************************************************************
<a name="line-176"></a>-}</span>
<a name="line-177"></a>
<a name="line-178"></a><span class='hs-comment'>-- | Class of things that we can obtain a 'Unique' from</span>
<a name="line-179"></a><span class='hs-keyword'>class</span> <span class='hs-conid'>Uniquable</span> <span class='hs-varid'>a</span> <span class='hs-keyword'>where</span>
<a name="line-180"></a>    <span class='hs-varid'>getUnique</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span>
<a name="line-181"></a>
<a name="line-182"></a><a name="hasKey"></a><span class='hs-definition'>hasKey</span>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Uniquable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-183"></a><a name="hasKey"></a><span class='hs-definition'>x</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>k</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUnique</span> <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-varid'>k</span>
<a name="line-184"></a>
<a name="line-185"></a><a name="instance%20Uniquable%20FastString"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Uniquable</span> <span class='hs-conid'>FastString</span> <span class='hs-keyword'>where</span>
<a name="line-186"></a> <span class='hs-varid'>getUnique</span> <span class='hs-varid'>fs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUniqueGrimily</span> <span class='hs-layout'>(</span><span class='hs-varid'>uniqueOfFS</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span>
<a name="line-187"></a>
<a name="line-188"></a><a name="instance%20Uniquable%20Int"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Uniquable</span> <span class='hs-conid'>Int</span> <span class='hs-keyword'>where</span>
<a name="line-189"></a> <span class='hs-varid'>getUnique</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUniqueGrimily</span> <span class='hs-varid'>i</span>
<a name="line-190"></a>
<a name="line-191"></a><span class='hs-comment'>{-
<a name="line-192"></a>************************************************************************
<a name="line-193"></a>*                                                                      *
<a name="line-194"></a>\subsection[Unique-instances]{Instance declarations for @Unique@}
<a name="line-195"></a>*                                                                      *
<a name="line-196"></a>************************************************************************
<a name="line-197"></a>
<a name="line-198"></a>And the whole point (besides uniqueness) is fast equality.  We don't
<a name="line-199"></a>use `deriving' because we want {\em precise} control of ordering
<a name="line-200"></a>(equality on @Uniques@ is v common).
<a name="line-201"></a>-}</span>
<a name="line-202"></a>
<a name="line-203"></a><span class='hs-comment'>-- Note [Unique Determinism]</span>
<a name="line-204"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-205"></a><span class='hs-comment'>-- The order of allocated @Uniques@ is not stable across rebuilds.</span>
<a name="line-206"></a><span class='hs-comment'>-- The main reason for that is that typechecking interface files pulls</span>
<a name="line-207"></a><span class='hs-comment'>-- @Uniques@ from @UniqSupply@ and the interface file for the module being</span>
<a name="line-208"></a><span class='hs-comment'>-- currently compiled can, but doesn't have to exist.</span>
<a name="line-209"></a><span class='hs-comment'>--</span>
<a name="line-210"></a><span class='hs-comment'>-- It gets more complicated if you take into account that the interface</span>
<a name="line-211"></a><span class='hs-comment'>-- files are loaded lazily and that building multiple files at once has to</span>
<a name="line-212"></a><span class='hs-comment'>-- work for any subset of interface files present. When you add parallelism</span>
<a name="line-213"></a><span class='hs-comment'>-- this makes @Uniques@ hopelessly random.</span>
<a name="line-214"></a><span class='hs-comment'>--</span>
<a name="line-215"></a><span class='hs-comment'>-- As such, to get deterministic builds, the order of the allocated</span>
<a name="line-216"></a><span class='hs-comment'>-- @Uniques@ should not affect the final result.</span>
<a name="line-217"></a><span class='hs-comment'>-- see also wiki/deterministic-builds</span>
<a name="line-218"></a><span class='hs-comment'>--</span>
<a name="line-219"></a><span class='hs-comment'>-- Note [Unique Determinism and code generation]</span>
<a name="line-220"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-221"></a><span class='hs-comment'>-- The goal of the deterministic builds (wiki/deterministic-builds, #4012)</span>
<a name="line-222"></a><span class='hs-comment'>-- is to get ABI compatible binaries given the same inputs and environment.</span>
<a name="line-223"></a><span class='hs-comment'>-- The motivation behind that is that if the ABI doesn't change the</span>
<a name="line-224"></a><span class='hs-comment'>-- binaries can be safely reused.</span>
<a name="line-225"></a><span class='hs-comment'>-- Note that this is weaker than bit-for-bit identical binaries and getting</span>
<a name="line-226"></a><span class='hs-comment'>-- bit-for-bit identical binaries is not a goal for now.</span>
<a name="line-227"></a><span class='hs-comment'>-- This means that we don't care about nondeterminism that happens after</span>
<a name="line-228"></a><span class='hs-comment'>-- the interface files are created, in particular we don't care about</span>
<a name="line-229"></a><span class='hs-comment'>-- register allocation and code generation.</span>
<a name="line-230"></a><span class='hs-comment'>-- To track progress on bit-for-bit determinism see #12262.</span>
<a name="line-231"></a>
<a name="line-232"></a><a name="eqUnique"></a><span class='hs-definition'>eqUnique</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-233"></a><span class='hs-definition'>eqUnique</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkUnique</span> <span class='hs-varid'>u1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkUnique</span> <span class='hs-varid'>u2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>u2</span>
<a name="line-234"></a>
<a name="line-235"></a><a name="ltUnique"></a><span class='hs-definition'>ltUnique</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-236"></a><span class='hs-definition'>ltUnique</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkUnique</span> <span class='hs-varid'>u1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkUnique</span> <span class='hs-varid'>u2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u1</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>u2</span>
<a name="line-237"></a>
<a name="line-238"></a><a name="nonDetCmpUnique"></a><span class='hs-comment'>-- Provided here to make it explicit at the call-site that it can</span>
<a name="line-239"></a><span class='hs-comment'>-- introduce non-determinism.</span>
<a name="line-240"></a><span class='hs-comment'>-- See Note [Unique Determinism]</span>
<a name="line-241"></a><span class='hs-comment'>-- See Note [No Ord for Unique]</span>
<a name="line-242"></a><span class='hs-definition'>nonDetCmpUnique</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ordering</span>
<a name="line-243"></a><span class='hs-definition'>nonDetCmpUnique</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkUnique</span> <span class='hs-varid'>u1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkUnique</span> <span class='hs-varid'>u2</span><span class='hs-layout'>)</span>
<a name="line-244"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>u1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>u2</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>EQ</span> <span class='hs-keyword'>else</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>u1</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>u2</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>LT</span> <span class='hs-keyword'>else</span> <span class='hs-conid'>GT</span>
<a name="line-245"></a>
<a name="line-246"></a><span class='hs-comment'>{-
<a name="line-247"></a>Note [No Ord for Unique]
<a name="line-248"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-249"></a>As explained in Note [Unique Determinism] the relative order of Uniques
<a name="line-250"></a>is nondeterministic. To prevent from accidental use the Ord Unique
<a name="line-251"></a>instance has been removed.
<a name="line-252"></a>This makes it easier to maintain deterministic builds, but comes with some
<a name="line-253"></a>drawbacks.
<a name="line-254"></a>The biggest drawback is that Maps keyed by Uniques can't directly be used.
<a name="line-255"></a>The alternatives are:
<a name="line-256"></a>
<a name="line-257"></a>  1) Use UniqFM or UniqDFM, see Note [Deterministic UniqFM] to decide which
<a name="line-258"></a>  2) Create a newtype wrapper based on Unique ordering where nondeterminism
<a name="line-259"></a>     is controlled. See Module.ModuleEnv
<a name="line-260"></a>  3) Change the algorithm to use nonDetCmpUnique and document why it's still
<a name="line-261"></a>     deterministic
<a name="line-262"></a>  4) Use TrieMap as done in GHC.Cmm.CommonBlockElim.groupByLabel
<a name="line-263"></a>-}</span>
<a name="line-264"></a>
<a name="line-265"></a><a name="instance%20Eq%20Unique"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-conid'>Unique</span> <span class='hs-keyword'>where</span>
<a name="line-266"></a>    <span class='hs-varid'>a</span> <span class='hs-varop'>==</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqUnique</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>
<a name="line-267"></a>    <span class='hs-varid'>a</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqUnique</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-268"></a>
<a name="line-269"></a><a name="instance%20Uniquable%20Unique"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Uniquable</span> <span class='hs-conid'>Unique</span> <span class='hs-keyword'>where</span>
<a name="line-270"></a>    <span class='hs-varid'>getUnique</span> <span class='hs-varid'>u</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span>
<a name="line-271"></a>
<a name="line-272"></a><span class='hs-comment'>-- We do sometimes make strings with @Uniques@ in them:</span>
<a name="line-273"></a>
<a name="line-274"></a><a name="showUnique"></a><span class='hs-definition'>showUnique</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-275"></a><span class='hs-definition'>showUnique</span> <span class='hs-varid'>uniq</span>
<a name="line-276"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>unpkUnique</span> <span class='hs-varid'>uniq</span> <span class='hs-keyword'>of</span>
<a name="line-277"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>tag</span><span class='hs-layout'>,</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>finish_show</span> <span class='hs-varid'>tag</span> <span class='hs-varid'>u</span> <span class='hs-layout'>(</span><span class='hs-varid'>iToBase62</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-278"></a>
<a name="line-279"></a><a name="finish_show"></a><span class='hs-definition'>finish_show</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Char</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-280"></a><span class='hs-definition'>finish_show</span> <span class='hs-chr'>'t'</span> <span class='hs-varid'>u</span> <span class='hs-sel'>_pp_u</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>u</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>26</span>
<a name="line-281"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- Special case to make v common tyvars, t1, t2, ...</span>
<a name="line-282"></a>    <span class='hs-comment'>-- come out as a, b, ... (shorter, easier to read)</span>
<a name="line-283"></a>    <span class='hs-keyglyph'>[</span><span class='hs-varid'>chr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ord</span> <span class='hs-chr'>'a'</span> <span class='hs-varop'>+</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-284"></a><span class='hs-definition'>finish_show</span> <span class='hs-varid'>tag</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>pp_u</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tag</span> <span class='hs-conop'>:</span> <span class='hs-varid'>pp_u</span>
<a name="line-285"></a>
<a name="line-286"></a><a name="pprUniqueAlways"></a><span class='hs-definition'>pprUniqueAlways</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-287"></a><span class='hs-comment'>-- The "always" means regardless of -dsuppress-uniques</span>
<a name="line-288"></a><span class='hs-comment'>-- It replaces the old pprUnique to remind callers that</span>
<a name="line-289"></a><span class='hs-comment'>-- they should consider whether they want to consult</span>
<a name="line-290"></a><span class='hs-comment'>-- Opt_SuppressUniques</span>
<a name="line-291"></a><span class='hs-definition'>pprUniqueAlways</span> <span class='hs-varid'>u</span>
<a name="line-292"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>showUnique</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-293"></a>
<a name="line-294"></a><a name="instance%20Outputable%20Unique"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Unique</span> <span class='hs-keyword'>where</span>
<a name="line-295"></a>    <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprUniqueAlways</span>
<a name="line-296"></a>
<a name="line-297"></a><a name="instance%20Show%20Unique"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Show</span> <span class='hs-conid'>Unique</span> <span class='hs-keyword'>where</span>
<a name="line-298"></a>    <span class='hs-varid'>show</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>showUnique</span> <span class='hs-varid'>uniq</span>
<a name="line-299"></a>
<a name="line-300"></a><span class='hs-comment'>{-
<a name="line-301"></a>************************************************************************
<a name="line-302"></a>*                                                                      *
<a name="line-303"></a>\subsection[Utils-base62]{Base-62 numbers}
<a name="line-304"></a>*                                                                      *
<a name="line-305"></a>************************************************************************
<a name="line-306"></a>
<a name="line-307"></a>A character-stingy way to read/write numbers (notably Uniques).
<a name="line-308"></a>The ``62-its'' are \tr{[0-9a-zA-Z]}.  We don't handle negative Ints.
<a name="line-309"></a>Code stolen from Lennart.
<a name="line-310"></a>-}</span>
<a name="line-311"></a>
<a name="line-312"></a><a name="iToBase62"></a><span class='hs-definition'>iToBase62</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-313"></a><span class='hs-definition'>iToBase62</span> <span class='hs-varid'>n_</span>
<a name="line-314"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>n_</span> <span class='hs-varop'>&gt;=</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n_</span> <span class='hs-str'>""</span>
<a name="line-315"></a>  <span class='hs-keyword'>where</span>
<a name="line-316"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>cs</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>62</span>
<a name="line-317"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varop'>!</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>chooseChar62</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>in</span> <span class='hs-varid'>c</span> <span class='hs-conop'>:</span> <span class='hs-varid'>cs</span>
<a name="line-318"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-319"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>q</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span> <span class='hs-conop'>:</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varop'>!</span><span class='hs-varid'>q</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotRem</span> <span class='hs-varid'>n</span> <span class='hs-num'>62</span>
<a name="line-320"></a>                                  <span class='hs-varop'>!</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>chooseChar62</span> <span class='hs-varid'>r</span>
<a name="line-321"></a>
<a name="line-322"></a>    <span class='hs-varid'>chooseChar62</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Char</span>
<a name="line-323"></a>    <span class='hs-comment'>{-# INLINE chooseChar62 #-}</span>
<a name="line-324"></a>    <span class='hs-varid'>chooseChar62</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>C</span><span class='hs-cpp'>#</span> <span class='hs-layout'>(</span><span class='hs-varid'>indexCharOffAddr</span><span class='hs-cpp'>#</span> <span class='hs-varid'>chars62</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-325"></a>    <span class='hs-varid'>chars62</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"</span><span class='hs-cpp'>#</span>
</pre></body>
</html>
