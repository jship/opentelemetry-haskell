<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Cmm/Type.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Cmm.Type</span>
<a name="line-2"></a>    <span class='hs-layout'>(</span> <span class='hs-conid'>CmmType</span>   <span class='hs-comment'>-- Abstract</span>
<a name="line-3"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>b8</span><span class='hs-layout'>,</span> <span class='hs-varid'>b16</span><span class='hs-layout'>,</span> <span class='hs-varid'>b32</span><span class='hs-layout'>,</span> <span class='hs-varid'>b64</span><span class='hs-layout'>,</span> <span class='hs-varid'>b128</span><span class='hs-layout'>,</span> <span class='hs-varid'>b256</span><span class='hs-layout'>,</span> <span class='hs-varid'>b512</span><span class='hs-layout'>,</span> <span class='hs-varid'>f32</span><span class='hs-layout'>,</span> <span class='hs-varid'>f64</span><span class='hs-layout'>,</span> <span class='hs-varid'>bWord</span><span class='hs-layout'>,</span> <span class='hs-varid'>bHalfWord</span><span class='hs-layout'>,</span> <span class='hs-varid'>gcWord</span>
<a name="line-4"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>cInt</span>
<a name="line-5"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>cmmBits</span><span class='hs-layout'>,</span> <span class='hs-varid'>cmmFloat</span>
<a name="line-6"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>typeWidth</span><span class='hs-layout'>,</span> <span class='hs-varid'>cmmEqType</span><span class='hs-layout'>,</span> <span class='hs-varid'>cmmEqType_ignoring_ptrhood</span>
<a name="line-7"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>isFloatType</span><span class='hs-layout'>,</span> <span class='hs-varid'>isGcPtrType</span><span class='hs-layout'>,</span> <span class='hs-varid'>isBitsType</span>
<a name="line-8"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>isWord32</span><span class='hs-layout'>,</span> <span class='hs-varid'>isWord64</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFloat64</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFloat32</span>
<a name="line-9"></a>
<a name="line-10"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>Width</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-11"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>widthInBits</span><span class='hs-layout'>,</span> <span class='hs-varid'>widthInBytes</span><span class='hs-layout'>,</span> <span class='hs-varid'>widthInLog</span><span class='hs-layout'>,</span> <span class='hs-varid'>widthFromBytes</span>
<a name="line-12"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>wordWidth</span><span class='hs-layout'>,</span> <span class='hs-varid'>halfWordWidth</span><span class='hs-layout'>,</span> <span class='hs-varid'>cIntWidth</span>
<a name="line-13"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>halfWordMask</span>
<a name="line-14"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>narrowU</span><span class='hs-layout'>,</span> <span class='hs-varid'>narrowS</span>
<a name="line-15"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>rEP_CostCentreStack_mem_alloc</span>
<a name="line-16"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>rEP_CostCentreStack_scc_count</span>
<a name="line-17"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>rEP_StgEntCounter_allocs</span>
<a name="line-18"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>rEP_StgEntCounter_allocd</span>
<a name="line-19"></a>
<a name="line-20"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>ForeignHint</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-21"></a>
<a name="line-22"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>Length</span>
<a name="line-23"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>vec</span><span class='hs-layout'>,</span> <span class='hs-varid'>vec2</span><span class='hs-layout'>,</span> <span class='hs-varid'>vec4</span><span class='hs-layout'>,</span> <span class='hs-varid'>vec8</span><span class='hs-layout'>,</span> <span class='hs-varid'>vec16</span>
<a name="line-24"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>vec2f64</span><span class='hs-layout'>,</span> <span class='hs-varid'>vec2b64</span><span class='hs-layout'>,</span> <span class='hs-varid'>vec4f32</span><span class='hs-layout'>,</span> <span class='hs-varid'>vec4b32</span><span class='hs-layout'>,</span> <span class='hs-varid'>vec8b16</span><span class='hs-layout'>,</span> <span class='hs-varid'>vec16b8</span>
<a name="line-25"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>cmmVec</span>
<a name="line-26"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>vecLength</span><span class='hs-layout'>,</span> <span class='hs-varid'>vecElemType</span>
<a name="line-27"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>isVecType</span>
<a name="line-28"></a>   <span class='hs-layout'>)</span>
<a name="line-29"></a><span class='hs-keyword'>where</span>
<a name="line-30"></a>
<a name="line-31"></a>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Platform</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.FastString</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Word</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Int</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-43"></a><span class='hs-comment'>--              CmmType</span>
<a name="line-44"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-45"></a>
<a name="line-46"></a>  <span class='hs-comment'>-- NOTE: CmmType is an abstract type, not exported from this</span>
<a name="line-47"></a>  <span class='hs-comment'>--       module so you can easily change its representation</span>
<a name="line-48"></a>  <span class='hs-comment'>--</span>
<a name="line-49"></a>  <span class='hs-comment'>-- However Width is exported in a concrete way,</span>
<a name="line-50"></a>  <span class='hs-comment'>-- and is used extensively in pattern-matching</span>
<a name="line-51"></a>
<a name="line-52"></a><a name="CmmType"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CmmType</span>    <span class='hs-comment'>-- The important one!</span>
<a name="line-53"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmType</span> <span class='hs-conid'>CmmCat</span> <span class='hs-varop'>!</span><span class='hs-conid'>Width</span>
<a name="line-54"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Show</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="CmmCat"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CmmCat</span>                <span class='hs-comment'>-- "Category" (not exported)</span>
<a name="line-57"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GcPtrCat</span>              <span class='hs-comment'>-- GC pointer</span>
<a name="line-58"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BitsCat</span>               <span class='hs-comment'>-- Non-pointer</span>
<a name="line-59"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FloatCat</span>              <span class='hs-comment'>-- Float</span>
<a name="line-60"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>VecCat</span> <span class='hs-conid'>Length</span> <span class='hs-conid'>CmmCat</span>  <span class='hs-comment'>-- Vector</span>
<a name="line-61"></a>   <span class='hs-keyword'>deriving</span><span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-layout'>)</span>
<a name="line-62"></a>        <span class='hs-comment'>-- See Note [Signed vs unsigned] at the end</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="instance%20Outputable%20CmmType"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>CmmType</span> <span class='hs-keyword'>where</span>
<a name="line-65"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmType</span> <span class='hs-varid'>cat</span> <span class='hs-varid'>wid</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cat</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>widthInBits</span> <span class='hs-varid'>wid</span><span class='hs-layout'>)</span>
<a name="line-66"></a>
<a name="line-67"></a><a name="instance%20Outputable%20CmmCat"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>CmmCat</span> <span class='hs-keyword'>where</span>
<a name="line-68"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>FloatCat</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"F"</span>
<a name="line-69"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>GcPtrCat</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"P"</span>
<a name="line-70"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>BitsCat</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"I"</span>
<a name="line-71"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>VecCat</span> <span class='hs-varid'>n</span> <span class='hs-varid'>cat</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cat</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"x"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"V"</span>
<a name="line-72"></a>
<a name="line-73"></a><span class='hs-comment'>-- Why is CmmType stratified?  For native code generation,</span>
<a name="line-74"></a><span class='hs-comment'>-- most of the time you just want to know what sort of register</span>
<a name="line-75"></a><span class='hs-comment'>-- to put the thing in, and for this you need to know how</span>
<a name="line-76"></a><span class='hs-comment'>-- many bits thing has, and whether it goes in a floating-point</span>
<a name="line-77"></a><span class='hs-comment'>-- register.  By contrast, the distinction between GcPtr and</span>
<a name="line-78"></a><span class='hs-comment'>-- GcNonPtr is of interest to only a few parts of the code generator.</span>
<a name="line-79"></a>
<a name="line-80"></a><a name="cmmEqType"></a><span class='hs-comment'>-------- Equality on CmmType --------------</span>
<a name="line-81"></a><span class='hs-comment'>-- CmmType is *not* an instance of Eq; sometimes we care about the</span>
<a name="line-82"></a><span class='hs-comment'>-- Gc/NonGc distinction, and sometimes we don't</span>
<a name="line-83"></a><span class='hs-comment'>-- So we use an explicit function to force you to think about it</span>
<a name="line-84"></a><span class='hs-definition'>cmmEqType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-comment'>-- Exact equality</span>
<a name="line-85"></a><span class='hs-definition'>cmmEqType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmType</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>w1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmType</span> <span class='hs-varid'>c2</span> <span class='hs-varid'>w2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c1</span><span class='hs-varop'>==</span><span class='hs-varid'>c2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>w1</span><span class='hs-varop'>==</span><span class='hs-varid'>w2</span>
<a name="line-86"></a>
<a name="line-87"></a><a name="cmmEqType_ignoring_ptrhood"></a><span class='hs-definition'>cmmEqType_ignoring_ptrhood</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-88"></a>  <span class='hs-comment'>-- This equality is temporary; used in CmmLint</span>
<a name="line-89"></a>  <span class='hs-comment'>-- but the RTS files are not yet well-typed wrt pointers</span>
<a name="line-90"></a><span class='hs-definition'>cmmEqType_ignoring_ptrhood</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmType</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>w1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmType</span> <span class='hs-varid'>c2</span> <span class='hs-varid'>w2</span><span class='hs-layout'>)</span>
<a name="line-91"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>`weak_eq`</span> <span class='hs-varid'>c2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>w1</span><span class='hs-varop'>==</span><span class='hs-varid'>w2</span>
<a name="line-92"></a>   <span class='hs-keyword'>where</span>
<a name="line-93"></a>     <span class='hs-varid'>weak_eq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmCat</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmCat</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-94"></a>     <span class='hs-conid'>FloatCat</span>         <span class='hs-varop'>`weak_eq`</span> <span class='hs-conid'>FloatCat</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-95"></a>     <span class='hs-conid'>FloatCat</span>         <span class='hs-varop'>`weak_eq`</span> <span class='hs-sel'>_other</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-96"></a>     <span class='hs-sel'>_other</span>           <span class='hs-varop'>`weak_eq`</span> <span class='hs-conid'>FloatCat</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-97"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>VecCat</span> <span class='hs-varid'>l1</span> <span class='hs-varid'>cat1</span><span class='hs-layout'>)</span> <span class='hs-varop'>`weak_eq`</span> <span class='hs-layout'>(</span><span class='hs-conid'>VecCat</span> <span class='hs-varid'>l2</span> <span class='hs-varid'>cat2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>l2</span>
<a name="line-98"></a>                                                   <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>cat1</span> <span class='hs-varop'>`weak_eq`</span> <span class='hs-varid'>cat2</span>
<a name="line-99"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>VecCat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-varop'>`weak_eq`</span> <span class='hs-sel'>_other</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-100"></a>     <span class='hs-sel'>_other</span>           <span class='hs-varop'>`weak_eq`</span> <span class='hs-layout'>(</span><span class='hs-conid'>VecCat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-101"></a>     <span class='hs-sel'>_word1</span>           <span class='hs-varop'>`weak_eq`</span> <span class='hs-sel'>_word2</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>        <span class='hs-comment'>-- Ignores GcPtr</span>
<a name="line-102"></a>
<a name="line-103"></a><a name="typeWidth"></a><span class='hs-comment'>--- Simple operations on CmmType -----</span>
<a name="line-104"></a><span class='hs-definition'>typeWidth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Width</span>
<a name="line-105"></a><span class='hs-definition'>typeWidth</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w</span>
<a name="line-106"></a>
<a name="line-107"></a><a name="cmmBits"></a><span class='hs-definition'>cmmBits</span><span class='hs-layout'>,</span> <span class='hs-varid'>cmmFloat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Width</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmType</span>
<a name="line-108"></a><span class='hs-definition'>cmmBits</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmType</span> <span class='hs-conid'>BitsCat</span>
<a name="line-109"></a><a name="cmmFloat"></a><span class='hs-definition'>cmmFloat</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmType</span> <span class='hs-conid'>FloatCat</span>
<a name="line-110"></a>
<a name="line-111"></a><a name="b8"></a><span class='hs-comment'>-------- Common CmmTypes ------------</span>
<a name="line-112"></a><span class='hs-comment'>-- Floats and words of specific widths</span>
<a name="line-113"></a><span class='hs-definition'>b8</span><span class='hs-layout'>,</span> <span class='hs-varid'>b16</span><span class='hs-layout'>,</span> <span class='hs-varid'>b32</span><span class='hs-layout'>,</span> <span class='hs-varid'>b64</span><span class='hs-layout'>,</span> <span class='hs-varid'>b128</span><span class='hs-layout'>,</span> <span class='hs-varid'>b256</span><span class='hs-layout'>,</span> <span class='hs-varid'>b512</span><span class='hs-layout'>,</span> <span class='hs-varid'>f32</span><span class='hs-layout'>,</span> <span class='hs-varid'>f64</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmType</span>
<a name="line-114"></a><span class='hs-definition'>b8</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmBits</span> <span class='hs-conid'>W8</span>
<a name="line-115"></a><a name="b16"></a><span class='hs-definition'>b16</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmBits</span> <span class='hs-conid'>W16</span>
<a name="line-116"></a><a name="b32"></a><span class='hs-definition'>b32</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmBits</span> <span class='hs-conid'>W32</span>
<a name="line-117"></a><a name="b64"></a><span class='hs-definition'>b64</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmBits</span> <span class='hs-conid'>W64</span>
<a name="line-118"></a><a name="b128"></a><span class='hs-definition'>b128</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmBits</span> <span class='hs-conid'>W128</span>
<a name="line-119"></a><a name="b256"></a><span class='hs-definition'>b256</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmBits</span> <span class='hs-conid'>W256</span>
<a name="line-120"></a><a name="b512"></a><span class='hs-definition'>b512</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmBits</span> <span class='hs-conid'>W512</span>
<a name="line-121"></a><a name="f32"></a><span class='hs-definition'>f32</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmFloat</span> <span class='hs-conid'>W32</span>
<a name="line-122"></a><a name="f64"></a><span class='hs-definition'>f64</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmFloat</span> <span class='hs-conid'>W64</span>
<a name="line-123"></a>
<a name="line-124"></a><a name="bWord"></a><span class='hs-comment'>-- CmmTypes of native word widths</span>
<a name="line-125"></a><span class='hs-definition'>bWord</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmType</span>
<a name="line-126"></a><span class='hs-definition'>bWord</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmBits</span> <span class='hs-layout'>(</span><span class='hs-varid'>wordWidth</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-127"></a>
<a name="line-128"></a><a name="bHalfWord"></a><span class='hs-definition'>bHalfWord</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmType</span>
<a name="line-129"></a><span class='hs-definition'>bHalfWord</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmBits</span> <span class='hs-layout'>(</span><span class='hs-varid'>halfWordWidth</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-130"></a>
<a name="line-131"></a><a name="gcWord"></a><span class='hs-definition'>gcWord</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmType</span>
<a name="line-132"></a><span class='hs-definition'>gcWord</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmType</span> <span class='hs-conid'>GcPtrCat</span> <span class='hs-layout'>(</span><span class='hs-varid'>wordWidth</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-133"></a>
<a name="line-134"></a><a name="cInt"></a><span class='hs-definition'>cInt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmType</span>
<a name="line-135"></a><span class='hs-definition'>cInt</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmBits</span> <span class='hs-layout'>(</span><span class='hs-varid'>cIntWidth</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-136"></a>
<a name="line-137"></a><a name="isFloatType"></a><span class='hs-comment'>------------ Predicates ----------------</span>
<a name="line-138"></a><span class='hs-definition'>isFloatType</span><span class='hs-layout'>,</span> <span class='hs-varid'>isGcPtrType</span><span class='hs-layout'>,</span> <span class='hs-varid'>isBitsType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-139"></a><span class='hs-definition'>isFloatType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmType</span> <span class='hs-conid'>FloatCat</span>    <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-140"></a><span class='hs-definition'>isFloatType</span> <span class='hs-sel'>_other</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-141"></a>
<a name="line-142"></a><a name="isGcPtrType"></a><span class='hs-definition'>isGcPtrType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmType</span> <span class='hs-conid'>GcPtrCat</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-143"></a><span class='hs-definition'>isGcPtrType</span> <span class='hs-sel'>_other</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-144"></a>
<a name="line-145"></a><a name="isBitsType"></a><span class='hs-definition'>isBitsType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmType</span> <span class='hs-conid'>BitsCat</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-146"></a><span class='hs-definition'>isBitsType</span> <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-147"></a>
<a name="line-148"></a><a name="isWord32"></a><span class='hs-definition'>isWord32</span><span class='hs-layout'>,</span> <span class='hs-varid'>isWord64</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFloat32</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFloat64</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-149"></a><span class='hs-comment'>-- isWord64 is true of 64-bit non-floats (both gc-ptrs and otherwise)</span>
<a name="line-150"></a><span class='hs-comment'>-- isFloat32 and 64 are obvious</span>
<a name="line-151"></a>
<a name="line-152"></a><a name="isWord64"></a><span class='hs-definition'>isWord64</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmType</span> <span class='hs-conid'>BitsCat</span>  <span class='hs-conid'>W64</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-153"></a><span class='hs-definition'>isWord64</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmType</span> <span class='hs-conid'>GcPtrCat</span> <span class='hs-conid'>W64</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-154"></a><span class='hs-definition'>isWord64</span> <span class='hs-sel'>_other</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-155"></a>
<a name="line-156"></a><span class='hs-definition'>isWord32</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmType</span> <span class='hs-conid'>BitsCat</span>  <span class='hs-conid'>W32</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-157"></a><span class='hs-definition'>isWord32</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmType</span> <span class='hs-conid'>GcPtrCat</span> <span class='hs-conid'>W32</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-158"></a><span class='hs-definition'>isWord32</span> <span class='hs-sel'>_other</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-159"></a>
<a name="line-160"></a><a name="isFloat32"></a><span class='hs-definition'>isFloat32</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmType</span> <span class='hs-conid'>FloatCat</span> <span class='hs-conid'>W32</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-161"></a><span class='hs-definition'>isFloat32</span> <span class='hs-sel'>_other</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-162"></a>
<a name="line-163"></a><a name="isFloat64"></a><span class='hs-definition'>isFloat64</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmType</span> <span class='hs-conid'>FloatCat</span> <span class='hs-conid'>W64</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-164"></a><span class='hs-definition'>isFloat64</span> <span class='hs-sel'>_other</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-165"></a>
<a name="line-166"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-167"></a><span class='hs-comment'>--              Width</span>
<a name="line-168"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-169"></a>
<a name="line-170"></a><a name="Width"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Width</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>W8</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>W16</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>W32</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>W64</span>
<a name="line-171"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-conid'>W128</span>
<a name="line-172"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-conid'>W256</span>
<a name="line-173"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-conid'>W512</span>
<a name="line-174"></a>             <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span><span class='hs-layout'>)</span>
<a name="line-175"></a>
<a name="line-176"></a><a name="instance%20Outputable%20Width"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Width</span> <span class='hs-keyword'>where</span>
<a name="line-177"></a>   <span class='hs-varid'>ppr</span> <span class='hs-varid'>rep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>mrStr</span> <span class='hs-varid'>rep</span><span class='hs-layout'>)</span>
<a name="line-178"></a>
<a name="line-179"></a><a name="mrStr"></a><span class='hs-definition'>mrStr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Width</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PtrString</span>
<a name="line-180"></a><span class='hs-definition'>mrStr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sLit</span> <span class='hs-varop'>.</span> <span class='hs-varid'>show</span>
<a name="line-181"></a>
<a name="line-182"></a>
<a name="line-183"></a><span class='hs-comment'>-------- Common Widths  ------------</span>
<a name="line-184"></a>
<a name="line-185"></a><a name="wordWidth"></a><span class='hs-comment'>-- | The width of the current platform's word size.</span>
<a name="line-186"></a><span class='hs-definition'>wordWidth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Width</span>
<a name="line-187"></a><span class='hs-definition'>wordWidth</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>platformWordSize</span> <span class='hs-varid'>platform</span> <span class='hs-keyword'>of</span>
<a name="line-188"></a> <span class='hs-conid'>PW4</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>W32</span>
<a name="line-189"></a> <span class='hs-conid'>PW8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>W64</span>
<a name="line-190"></a>
<a name="line-191"></a><a name="halfWordWidth"></a><span class='hs-comment'>-- | The width of the current platform's half-word size.</span>
<a name="line-192"></a><span class='hs-definition'>halfWordWidth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Width</span>
<a name="line-193"></a><span class='hs-definition'>halfWordWidth</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>platformWordSize</span> <span class='hs-varid'>platform</span> <span class='hs-keyword'>of</span>
<a name="line-194"></a> <span class='hs-conid'>PW4</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>W16</span>
<a name="line-195"></a> <span class='hs-conid'>PW8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>W32</span>
<a name="line-196"></a>
<a name="line-197"></a><a name="halfWordMask"></a><span class='hs-comment'>-- | A bit-mask for the lower half-word of current platform.</span>
<a name="line-198"></a><span class='hs-definition'>halfWordMask</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Integer</span>
<a name="line-199"></a><span class='hs-definition'>halfWordMask</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>platformWordSize</span> <span class='hs-varid'>platform</span> <span class='hs-keyword'>of</span>
<a name="line-200"></a> <span class='hs-conid'>PW4</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>0xFFFF</span>
<a name="line-201"></a> <span class='hs-conid'>PW8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>0xFFFFFFFF</span>
<a name="line-202"></a>
<a name="line-203"></a><a name="cIntWidth"></a><span class='hs-comment'>-- cIntRep is the Width for a C-language 'int'</span>
<a name="line-204"></a><span class='hs-definition'>cIntWidth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Width</span>
<a name="line-205"></a><span class='hs-definition'>cIntWidth</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>pc_CINT_SIZE</span> <span class='hs-layout'>(</span><span class='hs-varid'>platformConstants</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-206"></a>                   <span class='hs-num'>4</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>W32</span>
<a name="line-207"></a>                   <span class='hs-num'>8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>W64</span>
<a name="line-208"></a>                   <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"cIntWidth: Unknown cINT_SIZE: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-209"></a>
<a name="line-210"></a><a name="widthInBits"></a><span class='hs-comment'>-- | A width in bits.</span>
<a name="line-211"></a><span class='hs-definition'>widthInBits</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Width</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-212"></a><span class='hs-definition'>widthInBits</span> <span class='hs-conid'>W8</span>   <span class='hs-keyglyph'>=</span> <span class='hs-num'>8</span>
<a name="line-213"></a><span class='hs-definition'>widthInBits</span> <span class='hs-conid'>W16</span>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>16</span>
<a name="line-214"></a><span class='hs-definition'>widthInBits</span> <span class='hs-conid'>W32</span>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>32</span>
<a name="line-215"></a><span class='hs-definition'>widthInBits</span> <span class='hs-conid'>W64</span>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>64</span>
<a name="line-216"></a><span class='hs-definition'>widthInBits</span> <span class='hs-conid'>W128</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>128</span>
<a name="line-217"></a><span class='hs-definition'>widthInBits</span> <span class='hs-conid'>W256</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>256</span>
<a name="line-218"></a><span class='hs-definition'>widthInBits</span> <span class='hs-conid'>W512</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>512</span>
<a name="line-219"></a>
<a name="line-220"></a><a name="widthInBytes"></a><span class='hs-comment'>-- | A width in bytes.</span>
<a name="line-221"></a><span class='hs-comment'>--</span>
<a name="line-222"></a><span class='hs-comment'>-- &gt; widthFromBytes (widthInBytes w) === w</span>
<a name="line-223"></a><span class='hs-definition'>widthInBytes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Width</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-224"></a><span class='hs-definition'>widthInBytes</span> <span class='hs-conid'>W8</span>   <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-225"></a><span class='hs-definition'>widthInBytes</span> <span class='hs-conid'>W16</span>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>2</span>
<a name="line-226"></a><span class='hs-definition'>widthInBytes</span> <span class='hs-conid'>W32</span>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>4</span>
<a name="line-227"></a><span class='hs-definition'>widthInBytes</span> <span class='hs-conid'>W64</span>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>8</span>
<a name="line-228"></a><span class='hs-definition'>widthInBytes</span> <span class='hs-conid'>W128</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>16</span>
<a name="line-229"></a><span class='hs-definition'>widthInBytes</span> <span class='hs-conid'>W256</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>32</span>
<a name="line-230"></a><span class='hs-definition'>widthInBytes</span> <span class='hs-conid'>W512</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>64</span>
<a name="line-231"></a>
<a name="line-232"></a>
<a name="line-233"></a><a name="widthFromBytes"></a><span class='hs-comment'>-- | *Partial* A width from the number of bytes.</span>
<a name="line-234"></a><span class='hs-definition'>widthFromBytes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Width</span>
<a name="line-235"></a><span class='hs-definition'>widthFromBytes</span> <span class='hs-num'>1</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>W8</span>
<a name="line-236"></a><span class='hs-definition'>widthFromBytes</span> <span class='hs-num'>2</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>W16</span>
<a name="line-237"></a><span class='hs-definition'>widthFromBytes</span> <span class='hs-num'>4</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>W32</span>
<a name="line-238"></a><span class='hs-definition'>widthFromBytes</span> <span class='hs-num'>8</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>W64</span>
<a name="line-239"></a><span class='hs-definition'>widthFromBytes</span> <span class='hs-num'>16</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>W128</span>
<a name="line-240"></a><span class='hs-definition'>widthFromBytes</span> <span class='hs-num'>32</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>W256</span>
<a name="line-241"></a><span class='hs-definition'>widthFromBytes</span> <span class='hs-num'>64</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>W512</span>
<a name="line-242"></a>
<a name="line-243"></a><span class='hs-definition'>widthFromBytes</span> <span class='hs-varid'>n</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"no width for given number of bytes"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-244"></a>
<a name="line-245"></a><a name="widthInLog"></a><span class='hs-comment'>-- | log_2 of the width in bytes, useful for generating shifts.</span>
<a name="line-246"></a><span class='hs-definition'>widthInLog</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Width</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-247"></a><span class='hs-definition'>widthInLog</span> <span class='hs-conid'>W8</span>   <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-248"></a><span class='hs-definition'>widthInLog</span> <span class='hs-conid'>W16</span>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-249"></a><span class='hs-definition'>widthInLog</span> <span class='hs-conid'>W32</span>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>2</span>
<a name="line-250"></a><span class='hs-definition'>widthInLog</span> <span class='hs-conid'>W64</span>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>3</span>
<a name="line-251"></a><span class='hs-definition'>widthInLog</span> <span class='hs-conid'>W128</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>4</span>
<a name="line-252"></a><span class='hs-definition'>widthInLog</span> <span class='hs-conid'>W256</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>5</span>
<a name="line-253"></a><span class='hs-definition'>widthInLog</span> <span class='hs-conid'>W512</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>6</span>
<a name="line-254"></a>
<a name="line-255"></a>
<a name="line-256"></a><span class='hs-comment'>-- widening / narrowing</span>
<a name="line-257"></a>
<a name="line-258"></a><a name="narrowU"></a><span class='hs-comment'>-- | Narrow a signed or unsigned value to the given width. The result will</span>
<a name="line-259"></a><span class='hs-comment'>-- reside in @[0, +2^width)@.</span>
<a name="line-260"></a><span class='hs-comment'>--</span>
<a name="line-261"></a><span class='hs-comment'>-- &gt;&gt;&gt; narrowU W8 256    == 256</span>
<a name="line-262"></a><span class='hs-comment'>-- &gt;&gt;&gt; narrowU W8 255    == 255</span>
<a name="line-263"></a><span class='hs-comment'>-- &gt;&gt;&gt; narrowU W8 128    == 128</span>
<a name="line-264"></a><span class='hs-comment'>-- &gt;&gt;&gt; narrowU W8 127    == 127</span>
<a name="line-265"></a><span class='hs-comment'>-- &gt;&gt;&gt; narrowU W8 0      == 0</span>
<a name="line-266"></a><span class='hs-comment'>-- &gt;&gt;&gt; narrowU W8 (-127) == 129</span>
<a name="line-267"></a><span class='hs-comment'>-- &gt;&gt;&gt; narrowU W8 (-128) == 128</span>
<a name="line-268"></a><span class='hs-comment'>-- &gt;&gt;&gt; narrowU W8 (-129) == 127</span>
<a name="line-269"></a><span class='hs-comment'>-- &gt;&gt;&gt; narrowU W8 (-255) == 1</span>
<a name="line-270"></a><span class='hs-comment'>-- &gt;&gt;&gt; narrowU W8 (-256) == 0</span>
<a name="line-271"></a><span class='hs-comment'>--</span>
<a name="line-272"></a><span class='hs-definition'>narrowU</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Width</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Integer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Integer</span>
<a name="line-273"></a><span class='hs-definition'>narrowU</span> <span class='hs-conid'>W8</span>  <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word8</span><span class='hs-layout'>)</span>
<a name="line-274"></a><span class='hs-definition'>narrowU</span> <span class='hs-conid'>W16</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word16</span><span class='hs-layout'>)</span>
<a name="line-275"></a><span class='hs-definition'>narrowU</span> <span class='hs-conid'>W32</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word32</span><span class='hs-layout'>)</span>
<a name="line-276"></a><span class='hs-definition'>narrowU</span> <span class='hs-conid'>W64</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word64</span><span class='hs-layout'>)</span>
<a name="line-277"></a><span class='hs-definition'>narrowU</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"narrowTo"</span>
<a name="line-278"></a>
<a name="line-279"></a><a name="narrowS"></a><span class='hs-comment'>-- | Narrow a signed value to the given width. The result will reside</span>
<a name="line-280"></a><span class='hs-comment'>-- in @[-2^(width-1), +2^(width-1))@.</span>
<a name="line-281"></a><span class='hs-comment'>--</span>
<a name="line-282"></a><span class='hs-comment'>-- &gt;&gt;&gt; narrowS W8 256    == 0</span>
<a name="line-283"></a><span class='hs-comment'>-- &gt;&gt;&gt; narrowS W8 255    == -1</span>
<a name="line-284"></a><span class='hs-comment'>-- &gt;&gt;&gt; narrowS W8 128    == -128</span>
<a name="line-285"></a><span class='hs-comment'>-- &gt;&gt;&gt; narrowS W8 127    == 127</span>
<a name="line-286"></a><span class='hs-comment'>-- &gt;&gt;&gt; narrowS W8 0      == 0</span>
<a name="line-287"></a><span class='hs-comment'>-- &gt;&gt;&gt; narrowS W8 (-127) == -127</span>
<a name="line-288"></a><span class='hs-comment'>-- &gt;&gt;&gt; narrowS W8 (-128) == -128</span>
<a name="line-289"></a><span class='hs-comment'>-- &gt;&gt;&gt; narrowS W8 (-129) == 127</span>
<a name="line-290"></a><span class='hs-comment'>-- &gt;&gt;&gt; narrowS W8 (-255) == 1</span>
<a name="line-291"></a><span class='hs-comment'>-- &gt;&gt;&gt; narrowS W8 (-256) == 0</span>
<a name="line-292"></a><span class='hs-comment'>--</span>
<a name="line-293"></a><span class='hs-definition'>narrowS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Width</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Integer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Integer</span>
<a name="line-294"></a><span class='hs-definition'>narrowS</span> <span class='hs-conid'>W8</span>  <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int8</span><span class='hs-layout'>)</span>
<a name="line-295"></a><span class='hs-definition'>narrowS</span> <span class='hs-conid'>W16</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int16</span><span class='hs-layout'>)</span>
<a name="line-296"></a><span class='hs-definition'>narrowS</span> <span class='hs-conid'>W32</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int32</span><span class='hs-layout'>)</span>
<a name="line-297"></a><span class='hs-definition'>narrowS</span> <span class='hs-conid'>W64</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int64</span><span class='hs-layout'>)</span>
<a name="line-298"></a><span class='hs-definition'>narrowS</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"narrowTo"</span>
<a name="line-299"></a>
<a name="line-300"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-301"></a><span class='hs-comment'>--              SIMD</span>
<a name="line-302"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-303"></a>
<a name="line-304"></a><a name="Length"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Length</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Int</span>
<a name="line-305"></a>
<a name="line-306"></a><a name="vec"></a><span class='hs-definition'>vec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Length</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmType</span>
<a name="line-307"></a><span class='hs-definition'>vec</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmType</span> <span class='hs-varid'>cat</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmType</span> <span class='hs-layout'>(</span><span class='hs-conid'>VecCat</span> <span class='hs-varid'>l</span> <span class='hs-varid'>cat</span><span class='hs-layout'>)</span> <span class='hs-varid'>vecw</span>
<a name="line-308"></a>  <span class='hs-keyword'>where</span>
<a name="line-309"></a>    <span class='hs-varid'>vecw</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Width</span>
<a name="line-310"></a>    <span class='hs-varid'>vecw</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>widthFromBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-varop'>*</span><span class='hs-varid'>widthInBytes</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span>
<a name="line-311"></a>
<a name="line-312"></a><a name="vec2"></a><span class='hs-definition'>vec2</span><span class='hs-layout'>,</span> <span class='hs-varid'>vec4</span><span class='hs-layout'>,</span> <span class='hs-varid'>vec8</span><span class='hs-layout'>,</span> <span class='hs-varid'>vec16</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmType</span>
<a name="line-313"></a><span class='hs-definition'>vec2</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vec</span> <span class='hs-num'>2</span>
<a name="line-314"></a><a name="vec4"></a><span class='hs-definition'>vec4</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vec</span> <span class='hs-num'>4</span>
<a name="line-315"></a><a name="vec8"></a><span class='hs-definition'>vec8</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vec</span> <span class='hs-num'>8</span>
<a name="line-316"></a><a name="vec16"></a><span class='hs-definition'>vec16</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vec</span> <span class='hs-num'>16</span>
<a name="line-317"></a>
<a name="line-318"></a><a name="vec2f64"></a><span class='hs-definition'>vec2f64</span><span class='hs-layout'>,</span> <span class='hs-varid'>vec2b64</span><span class='hs-layout'>,</span> <span class='hs-varid'>vec4f32</span><span class='hs-layout'>,</span> <span class='hs-varid'>vec4b32</span><span class='hs-layout'>,</span> <span class='hs-varid'>vec8b16</span><span class='hs-layout'>,</span> <span class='hs-varid'>vec16b8</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmType</span>
<a name="line-319"></a><span class='hs-definition'>vec2f64</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vec</span> <span class='hs-num'>2</span> <span class='hs-varid'>f64</span>
<a name="line-320"></a><a name="vec2b64"></a><span class='hs-definition'>vec2b64</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vec</span> <span class='hs-num'>2</span> <span class='hs-varid'>b64</span>
<a name="line-321"></a><a name="vec4f32"></a><span class='hs-definition'>vec4f32</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vec</span> <span class='hs-num'>4</span> <span class='hs-varid'>f32</span>
<a name="line-322"></a><a name="vec4b32"></a><span class='hs-definition'>vec4b32</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vec</span> <span class='hs-num'>4</span> <span class='hs-varid'>b32</span>
<a name="line-323"></a><a name="vec8b16"></a><span class='hs-definition'>vec8b16</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vec</span> <span class='hs-num'>8</span> <span class='hs-varid'>b16</span>
<a name="line-324"></a><a name="vec16b8"></a><span class='hs-definition'>vec16b8</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vec</span> <span class='hs-num'>16</span> <span class='hs-varid'>b8</span>
<a name="line-325"></a>
<a name="line-326"></a><a name="cmmVec"></a><span class='hs-definition'>cmmVec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmType</span>
<a name="line-327"></a><span class='hs-definition'>cmmVec</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmType</span> <span class='hs-varid'>cat</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-328"></a>    <span class='hs-conid'>CmmType</span> <span class='hs-layout'>(</span><span class='hs-conid'>VecCat</span> <span class='hs-varid'>n</span> <span class='hs-varid'>cat</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>widthFromBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>*</span><span class='hs-varid'>widthInBytes</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-329"></a>
<a name="line-330"></a><a name="vecLength"></a><span class='hs-definition'>vecLength</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Length</span>
<a name="line-331"></a><span class='hs-definition'>vecLength</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmType</span> <span class='hs-layout'>(</span><span class='hs-conid'>VecCat</span> <span class='hs-varid'>l</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l</span>
<a name="line-332"></a><span class='hs-definition'>vecLength</span> <span class='hs-keyword'>_</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"vecLength: not a vector"</span>
<a name="line-333"></a>
<a name="line-334"></a><a name="vecElemType"></a><span class='hs-definition'>vecElemType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmType</span>
<a name="line-335"></a><span class='hs-definition'>vecElemType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmType</span> <span class='hs-layout'>(</span><span class='hs-conid'>VecCat</span> <span class='hs-varid'>l</span> <span class='hs-varid'>cat</span><span class='hs-layout'>)</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmType</span> <span class='hs-varid'>cat</span> <span class='hs-varid'>scalw</span>
<a name="line-336"></a>  <span class='hs-keyword'>where</span>
<a name="line-337"></a>    <span class='hs-varid'>scalw</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Width</span>
<a name="line-338"></a>    <span class='hs-varid'>scalw</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>widthFromBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>widthInBytes</span> <span class='hs-varid'>w</span> <span class='hs-varop'>`div`</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-339"></a><span class='hs-definition'>vecElemType</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"vecElemType: not a vector"</span>
<a name="line-340"></a>
<a name="line-341"></a><a name="isVecType"></a><span class='hs-definition'>isVecType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-342"></a><span class='hs-definition'>isVecType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmType</span> <span class='hs-layout'>(</span><span class='hs-conid'>VecCat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-343"></a><span class='hs-definition'>isVecType</span> <span class='hs-keyword'>_</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-344"></a>
<a name="line-345"></a><span class='hs-comment'>-------------------------------------------------------------------------</span>
<a name="line-346"></a><span class='hs-comment'>-- Hints</span>
<a name="line-347"></a>
<a name="line-348"></a><span class='hs-comment'>-- Hints are extra type information we attach to the arguments and</span>
<a name="line-349"></a><span class='hs-comment'>-- results of a foreign call, where more type information is sometimes</span>
<a name="line-350"></a><span class='hs-comment'>-- needed by the ABI to make the correct kind of call.</span>
<a name="line-351"></a><span class='hs-comment'>--</span>
<a name="line-352"></a><span class='hs-comment'>-- See Note [Signed vs unsigned] for one case where this is used.</span>
<a name="line-353"></a>
<a name="line-354"></a><a name="ForeignHint"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ForeignHint</span>
<a name="line-355"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoHint</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AddrHint</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SignedHint</span>
<a name="line-356"></a>  <span class='hs-keyword'>deriving</span><span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span> <span class='hs-layout'>)</span>
<a name="line-357"></a>        <span class='hs-comment'>-- Used to give extra per-argument or per-result</span>
<a name="line-358"></a>        <span class='hs-comment'>-- information needed by foreign calling conventions</span>
<a name="line-359"></a>
<a name="line-360"></a><span class='hs-comment'>-------------------------------------------------------------------------</span>
<a name="line-361"></a>
<a name="line-362"></a><span class='hs-comment'>-- These don't really belong here, but I don't know where is best to</span>
<a name="line-363"></a><span class='hs-comment'>-- put them.</span>
<a name="line-364"></a>
<a name="line-365"></a><a name="rEP_CostCentreStack_mem_alloc"></a><span class='hs-definition'>rEP_CostCentreStack_mem_alloc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmType</span>
<a name="line-366"></a><span class='hs-definition'>rEP_CostCentreStack_mem_alloc</span> <span class='hs-varid'>platform</span>
<a name="line-367"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmBits</span> <span class='hs-layout'>(</span><span class='hs-varid'>widthFromBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pc_REP_CostCentreStack_mem_alloc</span> <span class='hs-varid'>pc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-368"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>pc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>platformConstants</span> <span class='hs-varid'>platform</span>
<a name="line-369"></a>
<a name="line-370"></a><a name="rEP_CostCentreStack_scc_count"></a><span class='hs-definition'>rEP_CostCentreStack_scc_count</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmType</span>
<a name="line-371"></a><span class='hs-definition'>rEP_CostCentreStack_scc_count</span> <span class='hs-varid'>platform</span>
<a name="line-372"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmBits</span> <span class='hs-layout'>(</span><span class='hs-varid'>widthFromBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pc_REP_CostCentreStack_scc_count</span> <span class='hs-varid'>pc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-373"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>pc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>platformConstants</span> <span class='hs-varid'>platform</span>
<a name="line-374"></a>
<a name="line-375"></a><a name="rEP_StgEntCounter_allocs"></a><span class='hs-definition'>rEP_StgEntCounter_allocs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmType</span>
<a name="line-376"></a><span class='hs-definition'>rEP_StgEntCounter_allocs</span> <span class='hs-varid'>platform</span>
<a name="line-377"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmBits</span> <span class='hs-layout'>(</span><span class='hs-varid'>widthFromBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pc_REP_StgEntCounter_allocs</span> <span class='hs-varid'>pc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-378"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>pc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>platformConstants</span> <span class='hs-varid'>platform</span>
<a name="line-379"></a>
<a name="line-380"></a><a name="rEP_StgEntCounter_allocd"></a><span class='hs-definition'>rEP_StgEntCounter_allocd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmType</span>
<a name="line-381"></a><span class='hs-definition'>rEP_StgEntCounter_allocd</span> <span class='hs-varid'>platform</span>
<a name="line-382"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmBits</span> <span class='hs-layout'>(</span><span class='hs-varid'>widthFromBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pc_REP_StgEntCounter_allocd</span> <span class='hs-varid'>pc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-383"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>pc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>platformConstants</span> <span class='hs-varid'>platform</span>
<a name="line-384"></a>
<a name="line-385"></a><span class='hs-comment'>-------------------------------------------------------------------------</span>
<a name="line-386"></a><span class='hs-comment'>{-      Note [Signed vs unsigned]
<a name="line-387"></a>        ~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-388"></a>Should a CmmType include a signed vs. unsigned distinction?
<a name="line-389"></a>
<a name="line-390"></a>This is very much like a "hint" in C-- terminology: it isn't necessary
<a name="line-391"></a>in order to generate correct code, but it might be useful in that the
<a name="line-392"></a>compiler can generate better code if it has access to higher-level
<a name="line-393"></a>hints about data.  This is important at call boundaries, because the
<a name="line-394"></a>definition of a function is not visible at all of its call sites, so
<a name="line-395"></a>the compiler cannot infer the hints.
<a name="line-396"></a>
<a name="line-397"></a>Here in Cmm, we're taking a slightly different approach.  We include
<a name="line-398"></a>the int vs. float hint in the CmmType, because (a) the majority of
<a name="line-399"></a>platforms have a strong distinction between float and int registers,
<a name="line-400"></a>and (b) we don't want to do any heavyweight hint-inference in the
<a name="line-401"></a>native code backend in order to get good code.  We're treating the
<a name="line-402"></a>hint more like a type: our Cmm is always completely consistent with
<a name="line-403"></a>respect to hints.  All coercions between float and int are explicit.
<a name="line-404"></a>
<a name="line-405"></a>What about the signed vs. unsigned hint?  This information might be
<a name="line-406"></a>useful if we want to keep sub-word-sized values in word-size
<a name="line-407"></a>registers, which we must do if we only have word-sized registers.
<a name="line-408"></a>
<a name="line-409"></a>On such a system, there are two straightforward conventions for
<a name="line-410"></a>representing sub-word-sized values:
<a name="line-411"></a>
<a name="line-412"></a>(a) Leave the upper bits undefined.  Comparison operations must
<a name="line-413"></a>    sign- or zero-extend both operands before comparing them,
<a name="line-414"></a>    depending on whether the comparison is signed or unsigned.
<a name="line-415"></a>
<a name="line-416"></a>(b) Always keep the values sign- or zero-extended as appropriate.
<a name="line-417"></a>    Arithmetic operations must narrow the result to the appropriate
<a name="line-418"></a>    size.
<a name="line-419"></a>
<a name="line-420"></a>A clever compiler might not use either (a) or (b) exclusively, instead
<a name="line-421"></a>it would attempt to minimize the coercions by analysis: the same kind
<a name="line-422"></a>of analysis that propagates hints around.  In Cmm we don't want to
<a name="line-423"></a>have to do this, so we plump for having richer types and keeping the
<a name="line-424"></a>type information consistent.
<a name="line-425"></a>
<a name="line-426"></a>If signed/unsigned hints are missing from CmmType, then the only
<a name="line-427"></a>choice we have is (a), because we don't know whether the result of an
<a name="line-428"></a>operation should be sign- or zero-extended.
<a name="line-429"></a>
<a name="line-430"></a>Many architectures have extending load operations, which work well
<a name="line-431"></a>with (b).  To make use of them with (a), you need to know whether the
<a name="line-432"></a>value is going to be sign- or zero-extended by an enclosing comparison
<a name="line-433"></a>(for example), which involves knowing above the context.  This is
<a name="line-434"></a>doable but more complex.
<a name="line-435"></a>
<a name="line-436"></a>Further complicating the issue is foreign calls: a foreign calling
<a name="line-437"></a>convention can specify that signed 8-bit quantities are passed as
<a name="line-438"></a>sign-extended 32 bit quantities, for example (this is the case on the
<a name="line-439"></a>PowerPC).  So we *do* need sign information on foreign call arguments.
<a name="line-440"></a>
<a name="line-441"></a>Pros for adding signed vs. unsigned to CmmType:
<a name="line-442"></a>
<a name="line-443"></a>  - It would let us use convention (b) above, and get easier
<a name="line-444"></a>    code generation for extending loads.
<a name="line-445"></a>
<a name="line-446"></a>  - Less information required on foreign calls.
<a name="line-447"></a>
<a name="line-448"></a>  - MachOp type would be simpler
<a name="line-449"></a>
<a name="line-450"></a>Cons:
<a name="line-451"></a>
<a name="line-452"></a>  - More complexity
<a name="line-453"></a>
<a name="line-454"></a>  - What is the CmmType for a VanillaReg?  Currently it is
<a name="line-455"></a>    always wordRep, but now we have to decide whether it is
<a name="line-456"></a>    signed or unsigned.  The same VanillaReg can thus have
<a name="line-457"></a>    different CmmType in different parts of the program.
<a name="line-458"></a>
<a name="line-459"></a>  - Extra coercions cluttering up expressions.
<a name="line-460"></a>
<a name="line-461"></a>Currently for GHC, the foreign call point is moot, because we do our
<a name="line-462"></a>own promotion of sub-word-sized values to word-sized values.  The Int8
<a name="line-463"></a>type is represented by an Int# which is kept sign-extended at all times
<a name="line-464"></a>(this is slightly naughty, because we're making assumptions about the
<a name="line-465"></a>C calling convention rather early on in the compiler).  However, given
<a name="line-466"></a>this, the cons outweigh the pros.
<a name="line-467"></a>
<a name="line-468"></a>-}</span>
</pre></body>
</html>
