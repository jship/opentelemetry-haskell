<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Types/Name/Shape.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Types.Name.Shape</span>
<a name="line-4"></a>   <span class='hs-layout'>(</span> <span class='hs-conid'>NameShape</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-5"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>emptyNameShape</span>
<a name="line-6"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mkNameShape</span>
<a name="line-7"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>extendNameShape</span>
<a name="line-8"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>nameShapeExports</span>
<a name="line-9"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>substNameShape</span>
<a name="line-10"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>maybeSubstNameShape</span>
<a name="line-11"></a>   <span class='hs-layout'>)</span>
<a name="line-12"></a><span class='hs-keyword'>where</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Env</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.FM</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Avail</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.FieldLabel</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Env</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Monad</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Iface.Env</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-34"></a>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-comment'>-- Note [NameShape]</span>
<a name="line-38"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~</span>
<a name="line-39"></a><span class='hs-comment'>-- When we write a declaration in a signature, e.g., data T, we</span>
<a name="line-40"></a><span class='hs-comment'>-- ascribe to it a *name variable*, e.g., {m.T}.  This</span>
<a name="line-41"></a><span class='hs-comment'>-- name variable may be substituted with an actual original</span>
<a name="line-42"></a><span class='hs-comment'>-- name when the signature is implemented (or even if we</span>
<a name="line-43"></a><span class='hs-comment'>-- merge the signature with one which reexports this entity</span>
<a name="line-44"></a><span class='hs-comment'>-- from another module).</span>
<a name="line-45"></a>
<a name="line-46"></a><span class='hs-comment'>-- When we instantiate a signature m with a module M,</span>
<a name="line-47"></a><span class='hs-comment'>-- we also need to substitute over names.  To do so, we must</span>
<a name="line-48"></a><span class='hs-comment'>-- compute the *name substitution* induced by the *exports*</span>
<a name="line-49"></a><span class='hs-comment'>-- of the module in question.  A NameShape represents</span>
<a name="line-50"></a><span class='hs-comment'>-- such a name substitution for a single module instantiation.</span>
<a name="line-51"></a><span class='hs-comment'>-- The "shape" in the name comes from the fact that the computation</span>
<a name="line-52"></a><span class='hs-comment'>-- of a name substitution is essentially the *shaping pass* from</span>
<a name="line-53"></a><span class='hs-comment'>-- Backpack'14, but in a far more restricted form.</span>
<a name="line-54"></a>
<a name="line-55"></a><span class='hs-comment'>-- The name substitution for an export list is easy to explain.  If we are</span>
<a name="line-56"></a><span class='hs-comment'>-- filling the module variable &lt;m&gt;, given an export N of the form</span>
<a name="line-57"></a><span class='hs-comment'>-- M.n or {m'.n} (where n is an OccName), the induced name</span>
<a name="line-58"></a><span class='hs-comment'>-- substitution is from {m.n} to N.  So, for example, if we have</span>
<a name="line-59"></a><span class='hs-comment'>-- A=impl:B, and the exports of impl:B are impl:B.f and</span>
<a name="line-60"></a><span class='hs-comment'>-- impl:C.g, then our name substitution is {A.f} to impl:B.f</span>
<a name="line-61"></a><span class='hs-comment'>-- and {A.g} to impl:C.g</span>
<a name="line-62"></a>
<a name="line-63"></a>
<a name="line-64"></a>
<a name="line-65"></a>
<a name="line-66"></a><span class='hs-comment'>-- The 'NameShape' type is defined in GHC.Tc.Types, because GHC.Tc.Types</span>
<a name="line-67"></a><span class='hs-comment'>-- needs to refer to NameShape, and having GHC.Tc.Types import</span>
<a name="line-68"></a><span class='hs-comment'>-- NameShape (even by SOURCE) would cause a large number of</span>
<a name="line-69"></a><span class='hs-comment'>-- modules to be pulled into the DynFlags cycle.</span>
<a name="line-70"></a><span class='hs-comment'>{-
<a name="line-71"></a>data NameShape = NameShape {
<a name="line-72"></a>        ns_mod_name :: ModuleName,
<a name="line-73"></a>        ns_exports :: [AvailInfo],
<a name="line-74"></a>        ns_map :: OccEnv Name
<a name="line-75"></a>    }
<a name="line-76"></a>-}</span>
<a name="line-77"></a>
<a name="line-78"></a><span class='hs-comment'>-- NB: substitution functions need 'HscEnv' since they need the name cache</span>
<a name="line-79"></a><span class='hs-comment'>-- to allocate new names if we change the 'Module' of a 'Name'</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="emptyNameShape"></a><span class='hs-comment'>-- | Create an empty 'NameShape' (i.e., the renaming that</span>
<a name="line-82"></a><span class='hs-comment'>-- would occur with an implementing module with no exports)</span>
<a name="line-83"></a><span class='hs-comment'>-- for a specific hole @mod_name@.</span>
<a name="line-84"></a><span class='hs-definition'>emptyNameShape</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameShape</span>
<a name="line-85"></a><span class='hs-definition'>emptyNameShape</span> <span class='hs-varid'>mod_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameShape</span> <span class='hs-varid'>mod_name</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>emptyOccEnv</span>
<a name="line-86"></a>
<a name="line-87"></a><a name="mkNameShape"></a><span class='hs-comment'>-- | Create a 'NameShape' corresponding to an implementing</span>
<a name="line-88"></a><span class='hs-comment'>-- module for the hole @mod_name@ that exports a list of 'AvailInfo's.</span>
<a name="line-89"></a><span class='hs-definition'>mkNameShape</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameShape</span>
<a name="line-90"></a><span class='hs-definition'>mkNameShape</span> <span class='hs-varid'>mod_name</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span>
<a name="line-91"></a>    <span class='hs-conid'>NameShape</span> <span class='hs-varid'>mod_name</span> <span class='hs-keyword'>as</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkOccEnv</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-92"></a>        <span class='hs-varid'>a</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>as</span>
<a name="line-93"></a>        <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>availName</span> <span class='hs-varid'>a</span> <span class='hs-conop'>:</span> <span class='hs-varid'>availNamesWithSelectors</span> <span class='hs-varid'>a</span>
<a name="line-94"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>occName</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-95"></a>
<a name="line-96"></a><a name="extendNameShape"></a><span class='hs-comment'>-- | Given an existing 'NameShape', merge it with a list of 'AvailInfo's</span>
<a name="line-97"></a><span class='hs-comment'>-- with Backpack style mix-in linking.  This is used solely when merging</span>
<a name="line-98"></a><span class='hs-comment'>-- signatures together: we successively merge the exports of each</span>
<a name="line-99"></a><span class='hs-comment'>-- signature until we have the final, full exports of the merged signature.</span>
<a name="line-100"></a><span class='hs-comment'>--</span>
<a name="line-101"></a><span class='hs-comment'>-- What makes this operation nontrivial is what we are supposed to do when</span>
<a name="line-102"></a><span class='hs-comment'>-- we want to merge in an export for M.T when we already have an existing</span>
<a name="line-103"></a><span class='hs-comment'>-- export {H.T}.  What should happen in this case is that {H.T} should be</span>
<a name="line-104"></a><span class='hs-comment'>-- unified with @M.T@: we've determined a more *precise* identity for the</span>
<a name="line-105"></a><span class='hs-comment'>-- export at 'OccName' @T@.</span>
<a name="line-106"></a><span class='hs-comment'>--</span>
<a name="line-107"></a><span class='hs-comment'>-- Note that we don't do unrestricted unification: only name holes from</span>
<a name="line-108"></a><span class='hs-comment'>-- @ns_mod_name ns@ are flexible.  This is because we have a much more</span>
<a name="line-109"></a><span class='hs-comment'>-- restricted notion of shaping than in Backpack'14: we do shaping</span>
<a name="line-110"></a><span class='hs-comment'>-- *as* we do type-checking.  Thus, once we shape a signature, its</span>
<a name="line-111"></a><span class='hs-comment'>-- exports are *final* and we're not allowed to refine them further,</span>
<a name="line-112"></a><span class='hs-definition'>extendNameShape</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameShape</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-conid'>SDoc</span> <span class='hs-conid'>NameShape</span><span class='hs-layout'>)</span>
<a name="line-113"></a><span class='hs-definition'>extendNameShape</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>ns</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span>
<a name="line-114"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>uAvailInfos</span> <span class='hs-layout'>(</span><span class='hs-varid'>ns_mod_name</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ns_exports</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span> <span class='hs-keyword'>as</span> <span class='hs-keyword'>of</span>
<a name="line-115"></a>        <span class='hs-conid'>Left</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span>
<a name="line-116"></a>        <span class='hs-conid'>Right</span> <span class='hs-varid'>nsubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-117"></a>            <span class='hs-varid'>as1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftIO</span> <span class='hs-varop'>.</span> <span class='hs-varid'>substNameAvailInfo</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>nsubst</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ns_exports</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span>
<a name="line-118"></a>            <span class='hs-varid'>as2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftIO</span> <span class='hs-varop'>.</span> <span class='hs-varid'>substNameAvailInfo</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>nsubst</span><span class='hs-layout'>)</span> <span class='hs-keyword'>as</span>
<a name="line-119"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>new_avails</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mergeAvails</span> <span class='hs-varid'>as1</span> <span class='hs-varid'>as2</span>
<a name="line-120"></a>            <span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-conid'>Right</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ns</span> <span class='hs-layout'>{</span>
<a name="line-121"></a>                <span class='hs-varid'>ns_exports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_avails</span><span class='hs-layout'>,</span>
<a name="line-122"></a>                <span class='hs-comment'>-- TODO: stop repeatedly rebuilding the OccEnv</span>
<a name="line-123"></a>                <span class='hs-varid'>ns_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOccEnv</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-124"></a>                            <span class='hs-varid'>a</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>new_avails</span>
<a name="line-125"></a>                            <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>availName</span> <span class='hs-varid'>a</span> <span class='hs-conop'>:</span> <span class='hs-varid'>availNames</span> <span class='hs-varid'>a</span>
<a name="line-126"></a>                            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>occName</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-127"></a>                <span class='hs-layout'>}</span>
<a name="line-128"></a>
<a name="line-129"></a><a name="nameShapeExports"></a><span class='hs-comment'>-- | The export list associated with this 'NameShape' (i.e., what</span>
<a name="line-130"></a><span class='hs-comment'>-- the exports of an implementing module which induces this 'NameShape'</span>
<a name="line-131"></a><span class='hs-comment'>-- would be.)</span>
<a name="line-132"></a><span class='hs-definition'>nameShapeExports</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameShape</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span>
<a name="line-133"></a><span class='hs-definition'>nameShapeExports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ns_exports</span>
<a name="line-134"></a>
<a name="line-135"></a><a name="substNameShape"></a><span class='hs-comment'>-- | Given a 'Name', substitute it according to the 'NameShape' implied</span>
<a name="line-136"></a><span class='hs-comment'>-- substitution, i.e. map @{A.T}@ to @M.T@, if the implementing module</span>
<a name="line-137"></a><span class='hs-comment'>-- exports @M.T@.</span>
<a name="line-138"></a><span class='hs-definition'>substNameShape</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameShape</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-139"></a><span class='hs-definition'>substNameShape</span> <span class='hs-varid'>ns</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>nameModule</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ns_module</span> <span class='hs-varid'>ns</span>
<a name="line-140"></a>                    <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>n'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupOccEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>ns_map</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>occName</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-141"></a>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n'</span>
<a name="line-142"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-143"></a>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-144"></a>
<a name="line-145"></a><a name="maybeSubstNameShape"></a><span class='hs-comment'>-- | Like 'substNameShape', but returns @Nothing@ if no substitution</span>
<a name="line-146"></a><span class='hs-comment'>-- works.</span>
<a name="line-147"></a><span class='hs-definition'>maybeSubstNameShape</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameShape</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span>
<a name="line-148"></a><span class='hs-definition'>maybeSubstNameShape</span> <span class='hs-varid'>ns</span> <span class='hs-varid'>n</span>
<a name="line-149"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>nameModule</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ns_module</span> <span class='hs-varid'>ns</span>
<a name="line-150"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupOccEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>ns_map</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>occName</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-151"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-152"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-153"></a>
<a name="line-154"></a><a name="ns_module"></a><span class='hs-comment'>-- | The 'Module' of any 'Name's a 'NameShape' has action over.</span>
<a name="line-155"></a><span class='hs-definition'>ns_module</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameShape</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span>
<a name="line-156"></a><span class='hs-definition'>ns_module</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHoleModule</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ns_mod_name</span>
<a name="line-157"></a>
<a name="line-158"></a><span class='hs-comment'>{-
<a name="line-159"></a>************************************************************************
<a name="line-160"></a>*                                                                      *
<a name="line-161"></a>                        Name substitutions
<a name="line-162"></a>*                                                                      *
<a name="line-163"></a>************************************************************************
<a name="line-164"></a>-}</span>
<a name="line-165"></a>
<a name="line-166"></a><a name="ShNameSubst"></a><span class='hs-comment'>-- | Substitution on @{A.T}@.  We enforce the invariant that the</span>
<a name="line-167"></a><a name="ShNameSubst"></a><span class='hs-comment'>-- 'nameModule' of keys of this map have 'moduleUnit' @hole@</span>
<a name="line-168"></a><a name="ShNameSubst"></a><span class='hs-comment'>-- (meaning that if we have a hole substitution, the keys of the map</span>
<a name="line-169"></a><a name="ShNameSubst"></a><span class='hs-comment'>-- are never affected.)  Alternatively, this is isomorphic to</span>
<a name="line-170"></a><a name="ShNameSubst"></a><span class='hs-comment'>-- @Map ('ModuleName', 'OccName') 'Name'@.</span>
<a name="line-171"></a><a name="ShNameSubst"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ShNameSubst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>Name</span>
<a name="line-172"></a>
<a name="line-173"></a><span class='hs-comment'>-- NB: In this module, we actually only ever construct 'ShNameSubst'</span>
<a name="line-174"></a><span class='hs-comment'>-- at a single 'ModuleName'.  But 'ShNameSubst' is more convenient to</span>
<a name="line-175"></a><span class='hs-comment'>-- work with.</span>
<a name="line-176"></a>
<a name="line-177"></a><a name="substName"></a><span class='hs-comment'>-- | Substitute names in a 'Name'.</span>
<a name="line-178"></a><span class='hs-definition'>substName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ShNameSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-179"></a><span class='hs-definition'>substName</span> <span class='hs-varid'>env</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>n'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n'</span>
<a name="line-180"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-181"></a>
<a name="line-182"></a><a name="substNameAvailInfo"></a><span class='hs-comment'>-- | Substitute names in an 'AvailInfo'.  This has special behavior</span>
<a name="line-183"></a><span class='hs-comment'>-- for type constructors, where it is sufficient to substitute the 'availName'</span>
<a name="line-184"></a><span class='hs-comment'>-- to induce a substitution on 'availNames'.</span>
<a name="line-185"></a><span class='hs-definition'>substNameAvailInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ShNameSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AvailInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>AvailInfo</span>
<a name="line-186"></a><span class='hs-definition'>substNameAvailInfo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Avail</span> <span class='hs-layout'>(</span><span class='hs-conid'>NormalGreName</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Avail</span> <span class='hs-layout'>(</span><span class='hs-conid'>NormalGreName</span> <span class='hs-layout'>(</span><span class='hs-varid'>substName</span> <span class='hs-varid'>env</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-187"></a><span class='hs-definition'>substNameAvailInfo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Avail</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldGreName</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-188"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Avail</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldGreName</span> <span class='hs-varid'>fl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>flSelector</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substName</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>flSelector</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-189"></a><span class='hs-definition'>substNameAvailInfo</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-190"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>mb_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>nameModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-191"></a>    <span class='hs-keyword'>in</span> <span class='hs-conid'>AvailTC</span> <span class='hs-layout'>(</span><span class='hs-varid'>substName</span> <span class='hs-varid'>env</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>setNameGreName</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mb_mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>ns</span>
<a name="line-192"></a>
<a name="line-193"></a><a name="setNameGreName"></a><span class='hs-definition'>setNameGreName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GreName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>GreName</span>
<a name="line-194"></a><span class='hs-definition'>setNameGreName</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mb_mod</span> <span class='hs-varid'>gname</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>gname</span> <span class='hs-keyword'>of</span>
<a name="line-195"></a>    <span class='hs-conid'>NormalGreName</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormalGreName</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>initIfaceLoad</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>setNameModule</span> <span class='hs-varid'>mb_mod</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-196"></a>    <span class='hs-conid'>FieldGreName</span> <span class='hs-varid'>fl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FieldGreName</span>  <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>setNameFieldSelector</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mb_mod</span> <span class='hs-varid'>fl</span>
<a name="line-197"></a>
<a name="line-198"></a><a name="setNameFieldSelector"></a><span class='hs-comment'>-- | Set the 'Module' of a 'FieldSelector'</span>
<a name="line-199"></a><span class='hs-definition'>setNameFieldSelector</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FieldLabel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FieldLabel</span>
<a name="line-200"></a><span class='hs-definition'>setNameFieldSelector</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>f</span>
<a name="line-201"></a><span class='hs-definition'>setNameFieldSelector</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mb_mod</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldLabel</span> <span class='hs-varid'>l</span> <span class='hs-varid'>b</span> <span class='hs-varid'>has_sel</span> <span class='hs-varid'>sel</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-202"></a>    <span class='hs-varid'>sel'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initIfaceLoad</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-varid'>setNameModule</span> <span class='hs-varid'>mb_mod</span> <span class='hs-varid'>sel</span>
<a name="line-203"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldLabel</span> <span class='hs-varid'>l</span> <span class='hs-varid'>b</span> <span class='hs-varid'>has_sel</span> <span class='hs-varid'>sel'</span><span class='hs-layout'>)</span>
<a name="line-204"></a>
<a name="line-205"></a><span class='hs-comment'>{-
<a name="line-206"></a>************************************************************************
<a name="line-207"></a>*                                                                      *
<a name="line-208"></a>                        AvailInfo merging
<a name="line-209"></a>*                                                                      *
<a name="line-210"></a>************************************************************************
<a name="line-211"></a>-}</span>
<a name="line-212"></a>
<a name="line-213"></a><a name="mergeAvails"></a><span class='hs-comment'>-- | Merges to 'AvailInfo' lists together, assuming the 'AvailInfo's have</span>
<a name="line-214"></a><span class='hs-comment'>-- already been unified ('uAvailInfos').</span>
<a name="line-215"></a><span class='hs-definition'>mergeAvails</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span>
<a name="line-216"></a><span class='hs-definition'>mergeAvails</span> <span class='hs-varid'>as1</span> <span class='hs-varid'>as2</span> <span class='hs-keyglyph'>=</span>
<a name="line-217"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>mkNE</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>availName</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>as</span><span class='hs-keyglyph'>]</span>
<a name="line-218"></a>    <span class='hs-keyword'>in</span> <span class='hs-varid'>nameEnvElts</span> <span class='hs-layout'>(</span><span class='hs-varid'>plusNameEnv_C</span> <span class='hs-varid'>plusAvail</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNE</span> <span class='hs-varid'>as1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNE</span> <span class='hs-varid'>as2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-219"></a>
<a name="line-220"></a><span class='hs-comment'>{-
<a name="line-221"></a>************************************************************************
<a name="line-222"></a>*                                                                      *
<a name="line-223"></a>                        AvailInfo unification
<a name="line-224"></a>*                                                                      *
<a name="line-225"></a>************************************************************************
<a name="line-226"></a>-}</span>
<a name="line-227"></a>
<a name="line-228"></a><a name="uAvailInfos"></a><span class='hs-comment'>-- | Unify two lists of 'AvailInfo's, given an existing substitution @subst@,</span>
<a name="line-229"></a><span class='hs-comment'>-- with only name holes from @flexi@ unifiable (all other name holes rigid.)</span>
<a name="line-230"></a><span class='hs-definition'>uAvailInfos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>SDoc</span> <span class='hs-conid'>ShNameSubst</span>
<a name="line-231"></a><span class='hs-definition'>uAvailInfos</span> <span class='hs-varid'>flexi</span> <span class='hs-varid'>as1</span> <span class='hs-varid'>as2</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- pprTrace "uAvailInfos" (ppr as1 $$ ppr as2) $</span>
<a name="line-232"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>mkOE</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>listToUFM</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>as</span>
<a name="line-233"></a>                                 <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>availNames</span> <span class='hs-varid'>a</span>
<a name="line-234"></a>                                 <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-235"></a>    <span class='hs-keyword'>in</span> <span class='hs-varid'>foldM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>a1</span><span class='hs-layout'>,</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uAvailInfo</span> <span class='hs-varid'>flexi</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyNameEnv</span>
<a name="line-236"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>eltsUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>intersectUFM_C</span> <span class='hs-conid'>(,)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkOE</span> <span class='hs-varid'>as1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkOE</span> <span class='hs-varid'>as2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-237"></a>             <span class='hs-comment'>-- Edward: I have to say, this is pretty clever.</span>
<a name="line-238"></a>
<a name="line-239"></a><a name="uAvailInfo"></a><span class='hs-comment'>-- | Unify two 'AvailInfo's, given an existing substitution @subst@,</span>
<a name="line-240"></a><span class='hs-comment'>-- with only name holes from @flexi@ unifiable (all other name holes rigid.)</span>
<a name="line-241"></a><span class='hs-definition'>uAvailInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ShNameSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AvailInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AvailInfo</span>
<a name="line-242"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>SDoc</span> <span class='hs-conid'>ShNameSubst</span>
<a name="line-243"></a><span class='hs-definition'>uAvailInfo</span> <span class='hs-varid'>flexi</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Avail</span> <span class='hs-layout'>(</span><span class='hs-conid'>NormalGreName</span> <span class='hs-varid'>n1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Avail</span> <span class='hs-layout'>(</span><span class='hs-conid'>NormalGreName</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uName</span> <span class='hs-varid'>flexi</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>n2</span>
<a name="line-244"></a><span class='hs-definition'>uAvailInfo</span> <span class='hs-varid'>flexi</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n2</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uName</span> <span class='hs-varid'>flexi</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>n2</span>
<a name="line-245"></a><span class='hs-definition'>uAvailInfo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>a2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Left</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"While merging export lists, could not combine"</span>
<a name="line-246"></a>                           <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>a1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"with"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>a2</span>
<a name="line-247"></a>                           <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"one is a type, the other is a plain identifier"</span><span class='hs-layout'>)</span>
<a name="line-248"></a>
<a name="line-249"></a><a name="uName"></a><span class='hs-comment'>-- | Unify two 'Name's, given an existing substitution @subst@,</span>
<a name="line-250"></a><span class='hs-comment'>-- with only name holes from @flexi@ unifiable (all other name holes rigid.)</span>
<a name="line-251"></a><span class='hs-definition'>uName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ShNameSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>SDoc</span> <span class='hs-conid'>ShNameSubst</span>
<a name="line-252"></a><span class='hs-definition'>uName</span> <span class='hs-varid'>flexi</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>n2</span>
<a name="line-253"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>n2</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>subst</span>
<a name="line-254"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFlexi</span> <span class='hs-varid'>n1</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uHoleName</span> <span class='hs-varid'>flexi</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>n2</span>
<a name="line-255"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFlexi</span> <span class='hs-varid'>n2</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uHoleName</span> <span class='hs-varid'>flexi</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>n2</span> <span class='hs-varid'>n1</span>
<a name="line-256"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"While merging export lists, could not unify"</span>
<a name="line-257"></a>                         <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"with"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n2</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>extra</span><span class='hs-layout'>)</span>
<a name="line-258"></a>  <span class='hs-keyword'>where</span>
<a name="line-259"></a>    <span class='hs-varid'>isFlexi</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isHoleName</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>moduleName</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameModule</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varop'>==</span> <span class='hs-varid'>flexi</span>
<a name="line-260"></a>    <span class='hs-varid'>extra</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isHoleName</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isHoleName</span> <span class='hs-varid'>n2</span>
<a name="line-261"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Neither name variable originates from the current signature."</span>
<a name="line-262"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-263"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-264"></a>
<a name="line-265"></a><a name="uHoleName"></a><span class='hs-comment'>-- | Unify a name @h@ which 'isHoleName' with another name, given an existing</span>
<a name="line-266"></a><span class='hs-comment'>-- substitution @subst@, with only name holes from @flexi@ unifiable (all</span>
<a name="line-267"></a><span class='hs-comment'>-- other name holes rigid.)</span>
<a name="line-268"></a><span class='hs-definition'>uHoleName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ShNameSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-comment'>{- hole name -}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-269"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>SDoc</span> <span class='hs-conid'>ShNameSubst</span>
<a name="line-270"></a><span class='hs-definition'>uHoleName</span> <span class='hs-varid'>flexi</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>h</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span>
<a name="line-271"></a>    <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isHoleName</span> <span class='hs-varid'>h</span> <span class='hs-layout'>)</span>
<a name="line-272"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span>
<a name="line-273"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>n'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uName</span> <span class='hs-varid'>flexi</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>n'</span> <span class='hs-varid'>n</span>
<a name="line-274"></a>                <span class='hs-comment'>-- Do a quick check if the other name is substituted.</span>
<a name="line-275"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>n'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-276"></a>                    <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isHoleName</span> <span class='hs-varid'>n</span> <span class='hs-layout'>)</span> <span class='hs-varid'>uName</span> <span class='hs-varid'>flexi</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>h</span> <span class='hs-varid'>n'</span>
<a name="line-277"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-278"></a>                    <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendNameEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>h</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
</pre></body>
</html>
