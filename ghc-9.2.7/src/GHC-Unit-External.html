<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Unit/External.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Unit.External</span>
<a name="line-2"></a>   <span class='hs-layout'>(</span> <span class='hs-conid'>ExternalPackageState</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-3"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>EpsStats</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-4"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>addEpsInStats</span>
<a name="line-5"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>PackageTypeEnv</span>
<a name="line-6"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>PackageIfaceTable</span>
<a name="line-7"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>PackageInstEnv</span>
<a name="line-8"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>PackageFamInstEnv</span>
<a name="line-9"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>PackageRuleBase</span>
<a name="line-10"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>PackageCompleteMatches</span>
<a name="line-11"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>emptyPackageIfaceTable</span>
<a name="line-12"></a>   <span class='hs-layout'>)</span>
<a name="line-13"></a><span class='hs-keyword'>where</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.ModIface</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core</span>         <span class='hs-layout'>(</span> <span class='hs-conid'>RuleBase</span> <span class='hs-layout'>)</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.FamInstEnv</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.InstEnv</span> <span class='hs-layout'>(</span> <span class='hs-conid'>InstEnv</span> <span class='hs-layout'>)</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Annotations</span> <span class='hs-layout'>(</span> <span class='hs-conid'>AnnEnv</span> <span class='hs-layout'>)</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.CompleteMatch</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.TypeEnv</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.DSet</span>
<a name="line-28"></a>
<a name="line-29"></a>
<a name="line-30"></a><a name="PackageTypeEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>PackageTypeEnv</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeEnv</span>
<a name="line-31"></a><a name="PackageRuleBase"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>PackageRuleBase</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RuleBase</span>
<a name="line-32"></a><a name="PackageInstEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>PackageInstEnv</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InstEnv</span>
<a name="line-33"></a><a name="PackageFamInstEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>PackageFamInstEnv</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-34"></a><a name="PackageAnnEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>PackageAnnEnv</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnnEnv</span>
<a name="line-35"></a><a name="PackageCompleteMatches"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>PackageCompleteMatches</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CompleteMatches</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="PackageIfaceTable"></a><span class='hs-comment'>-- | Helps us find information about modules in the imported packages</span>
<a name="line-38"></a><a name="PackageIfaceTable"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>PackageIfaceTable</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModuleEnv</span> <span class='hs-conid'>ModIface</span>
<a name="line-39"></a>        <span class='hs-comment'>-- Domain = modules in the imported packages</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="emptyPackageIfaceTable"></a><span class='hs-comment'>-- | Constructs an empty PackageIfaceTable</span>
<a name="line-42"></a><span class='hs-definition'>emptyPackageIfaceTable</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PackageIfaceTable</span>
<a name="line-43"></a><span class='hs-definition'>emptyPackageIfaceTable</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyModuleEnv</span>
<a name="line-44"></a>
<a name="line-45"></a>
<a name="line-46"></a><a name="ExternalPackageState"></a><span class='hs-comment'>-- | Information about other packages that we have slurped in by reading</span>
<a name="line-47"></a><a name="ExternalPackageState"></a><span class='hs-comment'>-- their interface files</span>
<a name="line-48"></a><a name="ExternalPackageState"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ExternalPackageState</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EPS</span> <span class='hs-layout'>{</span>
<a name="line-50"></a>        <span class='hs-varid'>eps_is_boot</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>ModuleNameEnv</span> <span class='hs-conid'>ModuleNameWithIsBoot</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-51"></a>                <span class='hs-comment'>-- ^ In OneShot mode (only), home-package modules</span>
<a name="line-52"></a>                <span class='hs-comment'>-- accumulate in the external package state, and are</span>
<a name="line-53"></a>                <span class='hs-comment'>-- sucked in lazily.  For these home-pkg modules</span>
<a name="line-54"></a>                <span class='hs-comment'>-- (only) we need to record which are boot modules.</span>
<a name="line-55"></a>                <span class='hs-comment'>-- We set this field after loading all the</span>
<a name="line-56"></a>                <span class='hs-comment'>-- explicitly-imported interfaces, but before doing</span>
<a name="line-57"></a>                <span class='hs-comment'>-- anything else</span>
<a name="line-58"></a>                <span class='hs-comment'>--</span>
<a name="line-59"></a>                <span class='hs-comment'>-- The 'ModuleName' part is not necessary, but it's useful for</span>
<a name="line-60"></a>                <span class='hs-comment'>-- debug prints, and it's convenient because this field comes</span>
<a name="line-61"></a>                <span class='hs-comment'>-- direct from 'GHC.Tc.Utils.imp_dep_mods'</span>
<a name="line-62"></a>
<a name="line-63"></a>        <span class='hs-varid'>eps_PIT</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>PackageIfaceTable</span><span class='hs-layout'>,</span>
<a name="line-64"></a>                <span class='hs-comment'>-- ^ The 'ModIface's for modules in external packages</span>
<a name="line-65"></a>                <span class='hs-comment'>-- whose interfaces we have opened.</span>
<a name="line-66"></a>                <span class='hs-comment'>-- The declarations in these interface files are held in the</span>
<a name="line-67"></a>                <span class='hs-comment'>-- 'eps_decls', 'eps_inst_env', 'eps_fam_inst_env' and 'eps_rules'</span>
<a name="line-68"></a>                <span class='hs-comment'>-- fields of this record, not in the 'mi_decls' fields of the</span>
<a name="line-69"></a>                <span class='hs-comment'>-- interface we have sucked in.</span>
<a name="line-70"></a>                <span class='hs-comment'>--</span>
<a name="line-71"></a>                <span class='hs-comment'>-- What /is/ in the PIT is:</span>
<a name="line-72"></a>                <span class='hs-comment'>--</span>
<a name="line-73"></a>                <span class='hs-comment'>-- * The Module</span>
<a name="line-74"></a>                <span class='hs-comment'>--</span>
<a name="line-75"></a>                <span class='hs-comment'>-- * Fingerprint info</span>
<a name="line-76"></a>                <span class='hs-comment'>--</span>
<a name="line-77"></a>                <span class='hs-comment'>-- * Its exports</span>
<a name="line-78"></a>                <span class='hs-comment'>--</span>
<a name="line-79"></a>                <span class='hs-comment'>-- * Fixities</span>
<a name="line-80"></a>                <span class='hs-comment'>--</span>
<a name="line-81"></a>                <span class='hs-comment'>-- * Deprecations and warnings</span>
<a name="line-82"></a>
<a name="line-83"></a>        <span class='hs-varid'>eps_free_holes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InstalledModuleEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>UniqDSet</span> <span class='hs-conid'>ModuleName</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-84"></a>                <span class='hs-comment'>-- ^ Cache for 'mi_free_holes'.  Ordinarily, we can rely on</span>
<a name="line-85"></a>                <span class='hs-comment'>-- the 'eps_PIT' for this information, EXCEPT that when</span>
<a name="line-86"></a>                <span class='hs-comment'>-- we do dependency analysis, we need to look at the</span>
<a name="line-87"></a>                <span class='hs-comment'>-- 'Dependencies' of our imports to determine what their</span>
<a name="line-88"></a>                <span class='hs-comment'>-- precise free holes are ('moduleFreeHolesPrecise').  We</span>
<a name="line-89"></a>                <span class='hs-comment'>-- don't want to repeatedly reread in the interface</span>
<a name="line-90"></a>                <span class='hs-comment'>-- for every import, so cache it here.  When the PIT</span>
<a name="line-91"></a>                <span class='hs-comment'>-- gets filled in we can drop these entries.</span>
<a name="line-92"></a>
<a name="line-93"></a>        <span class='hs-varid'>eps_PTE</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>PackageTypeEnv</span><span class='hs-layout'>,</span>
<a name="line-94"></a>                <span class='hs-comment'>-- ^ Result of typechecking all the external package</span>
<a name="line-95"></a>                <span class='hs-comment'>-- interface files we have sucked in. The domain of</span>
<a name="line-96"></a>                <span class='hs-comment'>-- the mapping is external-package modules</span>
<a name="line-97"></a>
<a name="line-98"></a>        <span class='hs-varid'>eps_inst_env</span>     <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>PackageInstEnv</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- ^ The total 'InstEnv' accumulated</span>
<a name="line-99"></a>                                               <span class='hs-comment'>-- from all the external-package modules</span>
<a name="line-100"></a>        <span class='hs-varid'>eps_fam_inst_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>PackageFamInstEnv</span><span class='hs-layout'>,</span><span class='hs-comment'>-- ^ The total 'FamInstEnv' accumulated</span>
<a name="line-101"></a>                                               <span class='hs-comment'>-- from all the external-package modules</span>
<a name="line-102"></a>        <span class='hs-varid'>eps_rule_base</span>    <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>PackageRuleBase</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- ^ The total 'RuleEnv' accumulated</span>
<a name="line-103"></a>                                               <span class='hs-comment'>-- from all the external-package modules</span>
<a name="line-104"></a>        <span class='hs-varid'>eps_ann_env</span>      <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>PackageAnnEnv</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- ^ The total 'AnnEnv' accumulated</span>
<a name="line-105"></a>                                               <span class='hs-comment'>-- from all the external-package modules</span>
<a name="line-106"></a>        <span class='hs-varid'>eps_complete_matches</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>PackageCompleteMatches</span><span class='hs-layout'>,</span>
<a name="line-107"></a>                                  <span class='hs-comment'>-- ^ The total 'CompleteMatches' accumulated</span>
<a name="line-108"></a>                                  <span class='hs-comment'>-- from all the external-package modules</span>
<a name="line-109"></a>
<a name="line-110"></a>        <span class='hs-varid'>eps_mod_fam_inst_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>ModuleEnv</span> <span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ^ The family instances accumulated from external</span>
<a name="line-111"></a>                                                         <span class='hs-comment'>-- packages, keyed off the module that declared them</span>
<a name="line-112"></a>
<a name="line-113"></a>        <span class='hs-varid'>eps_stats</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>EpsStats</span>                 <span class='hs-comment'>-- ^ Stastics about what was loaded from external packages</span>
<a name="line-114"></a>  <span class='hs-layout'>}</span>
<a name="line-115"></a>
<a name="line-116"></a><a name="EpsStats"></a><span class='hs-comment'>-- | Accumulated statistics about what we are putting into the 'ExternalPackageState'.</span>
<a name="line-117"></a><a name="EpsStats"></a><span class='hs-comment'>-- \"In\" means stuff that is just /read/ from interface files,</span>
<a name="line-118"></a><a name="EpsStats"></a><span class='hs-comment'>-- \"Out\" means actually sucked in and type-checked</span>
<a name="line-119"></a><a name="EpsStats"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EpsStats</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EpsStats</span> <span class='hs-layout'>{</span> <span class='hs-varid'>n_ifaces_in</span>
<a name="line-120"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>n_decls_in</span><span class='hs-layout'>,</span> <span class='hs-varid'>n_decls_out</span>
<a name="line-121"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>n_rules_in</span><span class='hs-layout'>,</span> <span class='hs-varid'>n_rules_out</span>
<a name="line-122"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>n_insts_in</span><span class='hs-layout'>,</span> <span class='hs-varid'>n_insts_out</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span> <span class='hs-layout'>}</span>
<a name="line-123"></a>
<a name="line-124"></a><a name="addEpsInStats"></a><span class='hs-definition'>addEpsInStats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EpsStats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EpsStats</span>
<a name="line-125"></a><span class='hs-comment'>-- ^ Add stats for one newly-read interface</span>
<a name="line-126"></a><span class='hs-definition'>addEpsInStats</span> <span class='hs-varid'>stats</span> <span class='hs-varid'>n_decls</span> <span class='hs-varid'>n_insts</span> <span class='hs-varid'>n_rules</span>
<a name="line-127"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stats</span> <span class='hs-layout'>{</span> <span class='hs-varid'>n_ifaces_in</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n_ifaces_in</span> <span class='hs-varid'>stats</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span>
<a name="line-128"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>n_decls_in</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n_decls_in</span> <span class='hs-varid'>stats</span> <span class='hs-varop'>+</span> <span class='hs-varid'>n_decls</span>
<a name="line-129"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>n_insts_in</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n_insts_in</span> <span class='hs-varid'>stats</span> <span class='hs-varop'>+</span> <span class='hs-varid'>n_insts</span>
<a name="line-130"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>n_rules_in</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n_rules_in</span> <span class='hs-varid'>stats</span> <span class='hs-varop'>+</span> <span class='hs-varid'>n_rules</span> <span class='hs-layout'>}</span>
<a name="line-131"></a>
</pre></body>
</html>
