<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Iface/Make.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP                      #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE NondecreasingIndentation #-}</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-comment'>{-
<a name="line-5"></a>(c) The University of Glasgow 2006-2008
<a name="line-6"></a>(c) The GRASP/AQUA Project, Glasgow University, 1993-1998
<a name="line-7"></a>-}</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-comment'>-- | Module for constructing @ModIface@ values (interface files),</span>
<a name="line-10"></a><span class='hs-comment'>-- writing them to disk and comparing two versions to see if</span>
<a name="line-11"></a><span class='hs-comment'>-- recompilation is required.</span>
<a name="line-12"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Iface.Make</span>
<a name="line-13"></a>   <span class='hs-layout'>(</span> <span class='hs-varid'>mkPartialIface</span>
<a name="line-14"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mkFullIface</span>
<a name="line-15"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mkIfaceTc</span>
<a name="line-16"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>mkIfaceExports</span>
<a name="line-17"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>coAxiomToIfaceDecl</span>
<a name="line-18"></a>   <span class='hs-layout'>,</span> <span class='hs-varid'>tyThingToIfaceDecl</span> <span class='hs-comment'>-- Converting things to their Iface equivalents</span>
<a name="line-19"></a>   <span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-keyword'>where</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Hs</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.StgToCmm.Types</span> <span class='hs-layout'>(</span><span class='hs-conid'>CgInfos</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-29"></a>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.TcType</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Monad</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Iface.Syntax</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Iface.Recomp</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Iface.Load</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Iface.Ext.Fields</span>
<a name="line-37"></a>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.CoreToIface</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.LanguageExtensions</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>LangExt</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Class</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCon</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Coercion.Axiom</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.ConLike</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.DataCon</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Type</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Multiplicity</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.InstEnv</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.FamInstEnv</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Unify</span><span class='hs-layout'>(</span> <span class='hs-conid'>RoughMatchTc</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Env</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Backend</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Session</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Ppr</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Plugins</span> <span class='hs-layout'>(</span><span class='hs-conid'>LoadedPlugin</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-58"></a>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Id</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Fixity.Env</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SafeHaskell</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Annotations</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var.Env</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Avail</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Reader</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Env</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Set</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.DSet</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Basic</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-conid'>SuccessFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.TypeEnv</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SourceFile</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.TyThing</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.HpcInfo</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.CompleteMatch</span>
<a name="line-77"></a>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>  <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-varid'>eqListBy</span> <span class='hs-layout'>)</span>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Logger</span>
<a name="line-82"></a>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.FastString</span>
<a name="line-84"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Maybe</span>
<a name="line-85"></a>
<a name="line-86"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.HsToCore.Docs</span>
<a name="line-87"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.HsToCore.Usage</span> <span class='hs-layout'>(</span> <span class='hs-varid'>mkUsageInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUsedNames</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkDependencies</span> <span class='hs-layout'>)</span>
<a name="line-88"></a>
<a name="line-89"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit</span>
<a name="line-90"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.Warnings</span>
<a name="line-91"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.ModIface</span>
<a name="line-92"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.ModDetails</span>
<a name="line-93"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.ModGuts</span>
<a name="line-94"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.Deps</span>
<a name="line-95"></a>
<a name="line-96"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Function</span>
<a name="line-97"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List</span> <span class='hs-layout'>(</span> <span class='hs-varid'>findIndex</span><span class='hs-layout'>,</span> <span class='hs-varid'>mapAccumL</span><span class='hs-layout'>,</span> <span class='hs-varid'>sortBy</span> <span class='hs-layout'>)</span>
<a name="line-98"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Ord</span>
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.IORef</span>
<a name="line-100"></a>
<a name="line-101"></a><span class='hs-comment'>{-
<a name="line-102"></a>************************************************************************
<a name="line-103"></a>*                                                                      *
<a name="line-104"></a>\subsection{Completing an interface}
<a name="line-105"></a>*                                                                      *
<a name="line-106"></a>************************************************************************
<a name="line-107"></a>-}</span>
<a name="line-108"></a>
<a name="line-109"></a><a name="mkPartialIface"></a><span class='hs-definition'>mkPartialIface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-110"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModDetails</span>
<a name="line-111"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span>
<a name="line-112"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PartialModIface</span>
<a name="line-113"></a><span class='hs-definition'>mkPartialIface</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_details</span>
<a name="line-114"></a>  <span class='hs-conid'>ModGuts</span><span class='hs-layout'>{</span> <span class='hs-varid'>mg_module</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>this_mod</span>
<a name="line-115"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>mg_hsc_src</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_src</span>
<a name="line-116"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>mg_usages</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>usages</span>
<a name="line-117"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>mg_used_th</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>used_th</span>
<a name="line-118"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>mg_deps</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deps</span>
<a name="line-119"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>mg_rdr_env</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rdr_env</span>
<a name="line-120"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>mg_fix_env</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fix_env</span>
<a name="line-121"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>mg_warns</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>warns</span>
<a name="line-122"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>mg_hpc_info</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hpc_info</span>
<a name="line-123"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>mg_safe_haskell</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>safe_mode</span>
<a name="line-124"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>mg_trust_pkg</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>self_trust</span>
<a name="line-125"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>mg_doc_hdr</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>doc_hdr</span>
<a name="line-126"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>mg_decl_docs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decl_docs</span>
<a name="line-127"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>mg_arg_docs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_docs</span>
<a name="line-128"></a>         <span class='hs-layout'>}</span>
<a name="line-129"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkIface_</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>hsc_src</span> <span class='hs-varid'>used_th</span> <span class='hs-varid'>deps</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>fix_env</span> <span class='hs-varid'>warns</span> <span class='hs-varid'>hpc_info</span> <span class='hs-varid'>self_trust</span>
<a name="line-130"></a>             <span class='hs-varid'>safe_mode</span> <span class='hs-varid'>usages</span> <span class='hs-varid'>doc_hdr</span> <span class='hs-varid'>decl_docs</span> <span class='hs-varid'>arg_docs</span> <span class='hs-varid'>mod_details</span>
<a name="line-131"></a>
<a name="line-132"></a><a name="mkFullIface"></a><span class='hs-comment'>-- | Fully instantiate an interface. Adds fingerprints and potentially code</span>
<a name="line-133"></a><span class='hs-comment'>-- generator produced information.</span>
<a name="line-134"></a><span class='hs-comment'>--</span>
<a name="line-135"></a><span class='hs-comment'>-- CgInfos is not available when not generating code (-fno-code), or when not</span>
<a name="line-136"></a><span class='hs-comment'>-- generating interface pragmas (-fomit-interface-pragmas). See also</span>
<a name="line-137"></a><span class='hs-comment'>-- Note [Conveying CAF-info and LFInfo between modules] in GHC.StgToCmm.Types.</span>
<a name="line-138"></a><span class='hs-definition'>mkFullIface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PartialModIface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CgInfos</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ModIface</span>
<a name="line-139"></a><span class='hs-definition'>mkFullIface</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>partial_iface</span> <span class='hs-varid'>mb_cg_infos</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-140"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>decls</span>
<a name="line-141"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_OmitInterfacePragmas</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-142"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_decls</span> <span class='hs-varid'>partial_iface</span>
<a name="line-143"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-144"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updateDecl</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_decls</span> <span class='hs-varid'>partial_iface</span><span class='hs-layout'>)</span> <span class='hs-varid'>mb_cg_infos</span>
<a name="line-145"></a>
<a name="line-146"></a>    <span class='hs-varid'>full_iface</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-147"></a>      <span class='hs-comment'>{-# SCC "addFingerprints" #-}</span>
<a name="line-148"></a>      <span class='hs-varid'>addFingerprints</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>partial_iface</span><span class='hs-layout'>{</span> <span class='hs-varid'>mi_decls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decls</span> <span class='hs-layout'>}</span>
<a name="line-149"></a>
<a name="line-150"></a>    <span class='hs-comment'>-- Debug printing</span>
<a name="line-151"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>unit_state</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_units</span> <span class='hs-varid'>hsc_env</span>
<a name="line-152"></a>    <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_logger</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-conid'>Opt_D_dump_hi</span> <span class='hs-str'>"FINAL INTERFACE"</span> <span class='hs-conid'>FormatText</span>
<a name="line-153"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>pprModIface</span> <span class='hs-varid'>unit_state</span> <span class='hs-varid'>full_iface</span><span class='hs-layout'>)</span>
<a name="line-154"></a>
<a name="line-155"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>full_iface</span>
<a name="line-156"></a>
<a name="line-157"></a><a name="updateDecl"></a><span class='hs-definition'>updateDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IfaceDecl</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CgInfos</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IfaceDecl</span><span class='hs-keyglyph'>]</span>
<a name="line-158"></a><span class='hs-definition'>updateDecl</span> <span class='hs-varid'>decls</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decls</span>
<a name="line-159"></a><span class='hs-definition'>updateDecl</span> <span class='hs-varid'>decls</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-conid'>CgInfos</span><span class='hs-layout'>{</span> <span class='hs-varid'>cgNonCafs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NonCaffySet</span> <span class='hs-varid'>non_cafs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cgLFInfos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lf_infos</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>update_decl</span> <span class='hs-varid'>decls</span>
<a name="line-160"></a>  <span class='hs-keyword'>where</span>
<a name="line-161"></a>    <span class='hs-varid'>update_decl</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfaceId</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>details</span> <span class='hs-varid'>infos</span><span class='hs-layout'>)</span>
<a name="line-162"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>not_caffy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>elemNameSet</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>non_cafs</span>
<a name="line-163"></a>      <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mb_lf_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>lf_infos</span> <span class='hs-varid'>nm</span>
<a name="line-164"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-varid'>isNothing</span> <span class='hs-varid'>mb_lf_info</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Name without LFInfo:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>nm</span> <span class='hs-layout'>)</span> <span class='hs-conid'>True</span>
<a name="line-165"></a>        <span class='hs-comment'>-- Only allocate a new IfaceId if we're going to update the infos</span>
<a name="line-166"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>isJust</span> <span class='hs-varid'>mb_lf_info</span> <span class='hs-varop'>||</span> <span class='hs-varid'>not_caffy</span>
<a name="line-167"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceId</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>details</span> <span class='hs-varop'>$</span>
<a name="line-168"></a>          <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>not_caffy</span> <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsNoCafRefs</span> <span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-169"></a>          <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>mb_lf_info</span> <span class='hs-keyword'>of</span>
<a name="line-170"></a>             <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>infos</span> <span class='hs-comment'>-- LFInfos not available when building .cmm files</span>
<a name="line-171"></a>             <span class='hs-conid'>Just</span> <span class='hs-varid'>lf_info</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsLFInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceLFInfo</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>lf_info</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>infos</span><span class='hs-layout'>)</span>
<a name="line-172"></a>
<a name="line-173"></a>    <span class='hs-varid'>update_decl</span> <span class='hs-varid'>decl</span>
<a name="line-174"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decl</span>
<a name="line-175"></a>
<a name="line-176"></a><a name="mkIfaceTc"></a><span class='hs-comment'>-- | Make an interface from the results of typechecking only.  Useful</span>
<a name="line-177"></a><span class='hs-comment'>-- for non-optimising compilation, or where we aren't generating any</span>
<a name="line-178"></a><span class='hs-comment'>-- object code at all ('NoBackend').</span>
<a name="line-179"></a><span class='hs-definition'>mkIfaceTc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-180"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SafeHaskellMode</span>    <span class='hs-comment'>-- The safe haskell mode</span>
<a name="line-181"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModDetails</span>         <span class='hs-comment'>-- gotten from mkBootModDetails, probably</span>
<a name="line-182"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcGblEnv</span>           <span class='hs-comment'>-- Usages, deprecations, etc</span>
<a name="line-183"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ModIface</span>
<a name="line-184"></a><span class='hs-definition'>mkIfaceTc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>safe_mode</span> <span class='hs-varid'>mod_details</span>
<a name="line-185"></a>  <span class='hs-varid'>tc_result</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>{</span> <span class='hs-varid'>tcg_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>,</span>
<a name="line-186"></a>                      <span class='hs-varid'>tcg_src</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_src</span><span class='hs-layout'>,</span>
<a name="line-187"></a>                      <span class='hs-varid'>tcg_imports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imports</span><span class='hs-layout'>,</span>
<a name="line-188"></a>                      <span class='hs-varid'>tcg_rdr_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rdr_env</span><span class='hs-layout'>,</span>
<a name="line-189"></a>                      <span class='hs-varid'>tcg_fix_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>,</span>
<a name="line-190"></a>                      <span class='hs-varid'>tcg_merged</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>merged</span><span class='hs-layout'>,</span>
<a name="line-191"></a>                      <span class='hs-varid'>tcg_warns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>warns</span><span class='hs-layout'>,</span>
<a name="line-192"></a>                      <span class='hs-varid'>tcg_hpc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>other_hpc_info</span><span class='hs-layout'>,</span>
<a name="line-193"></a>                      <span class='hs-varid'>tcg_th_splice_used</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_splice_used</span><span class='hs-layout'>,</span>
<a name="line-194"></a>                      <span class='hs-varid'>tcg_dependent_files</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dependent_files</span>
<a name="line-195"></a>                    <span class='hs-layout'>}</span>
<a name="line-196"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-197"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>used_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUsedNames</span> <span class='hs-varid'>tc_result</span>
<a name="line-198"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>pluginModules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>lpModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_plugins</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-199"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>home_unit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_home_unit</span> <span class='hs-varid'>hsc_env</span>
<a name="line-200"></a>          <span class='hs-varid'>deps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkDependencies</span> <span class='hs-layout'>(</span><span class='hs-varid'>homeUnitId</span> <span class='hs-varid'>home_unit</span><span class='hs-layout'>)</span>
<a name="line-201"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mi_module</span> <span class='hs-varid'>pluginModules</span><span class='hs-layout'>)</span> <span class='hs-varid'>tc_result</span>
<a name="line-202"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>hpc_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyHpcInfo</span> <span class='hs-varid'>other_hpc_info</span>
<a name="line-203"></a>          <span class='hs-varid'>used_th</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>tc_splice_used</span>
<a name="line-204"></a>          <span class='hs-varid'>dep_files</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-layout'>(</span><span class='hs-varid'>readIORef</span> <span class='hs-varid'>dependent_files</span><span class='hs-layout'>)</span>
<a name="line-205"></a>          <span class='hs-comment'>-- Do NOT use semantic module here; this_mod in mkUsageInfo</span>
<a name="line-206"></a>          <span class='hs-comment'>-- is used solely to decide if we should record a dependency</span>
<a name="line-207"></a>          <span class='hs-comment'>-- or not.  When we instantiate a signature, the semantic</span>
<a name="line-208"></a>          <span class='hs-comment'>-- module is something we want to record dependencies for,</span>
<a name="line-209"></a>          <span class='hs-comment'>-- but if you pass that in here, we'll decide it's the local</span>
<a name="line-210"></a>          <span class='hs-comment'>-- module and does not need to be recorded as a dependency.</span>
<a name="line-211"></a>          <span class='hs-comment'>-- See Note [Identity versus semantic module]</span>
<a name="line-212"></a>          <span class='hs-varid'>usages</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkUsageInfo</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>this_mod</span> <span class='hs-layout'>(</span><span class='hs-varid'>imp_mods</span> <span class='hs-varid'>imports</span><span class='hs-layout'>)</span> <span class='hs-varid'>used_names</span>
<a name="line-213"></a>                      <span class='hs-varid'>dep_files</span> <span class='hs-varid'>merged</span> <span class='hs-varid'>pluginModules</span>
<a name="line-214"></a>
<a name="line-215"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>doc_hdr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>doc_map</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_map</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>extractDocs</span> <span class='hs-varid'>tc_result</span>
<a name="line-216"></a>
<a name="line-217"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>partial_iface</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkIface_</span> <span class='hs-varid'>hsc_env</span>
<a name="line-218"></a>                   <span class='hs-varid'>this_mod</span> <span class='hs-varid'>hsc_src</span>
<a name="line-219"></a>                   <span class='hs-varid'>used_th</span> <span class='hs-varid'>deps</span> <span class='hs-varid'>rdr_env</span>
<a name="line-220"></a>                   <span class='hs-varid'>fix_env</span> <span class='hs-varid'>warns</span> <span class='hs-varid'>hpc_info</span>
<a name="line-221"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-varid'>imports</span><span class='hs-layout'>)</span> <span class='hs-varid'>safe_mode</span> <span class='hs-varid'>usages</span>
<a name="line-222"></a>                   <span class='hs-varid'>doc_hdr'</span> <span class='hs-varid'>doc_map</span> <span class='hs-varid'>arg_map</span>
<a name="line-223"></a>                   <span class='hs-varid'>mod_details</span>
<a name="line-224"></a>
<a name="line-225"></a>          <span class='hs-varid'>mkFullIface</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>partial_iface</span> <span class='hs-conid'>Nothing</span>
<a name="line-226"></a>
<a name="line-227"></a><a name="mkIface_"></a><span class='hs-definition'>mkIface_</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscSource</span>
<a name="line-228"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Dependencies</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrEnv</span>
<a name="line-229"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>FixItem</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Warnings</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HpcInfo</span>
<a name="line-230"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-231"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SafeHaskellMode</span>
<a name="line-232"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Usage</span><span class='hs-keyglyph'>]</span>
<a name="line-233"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>HsDocString</span>
<a name="line-234"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DeclDocMap</span>
<a name="line-235"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArgDocMap</span>
<a name="line-236"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModDetails</span>
<a name="line-237"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PartialModIface</span>
<a name="line-238"></a><span class='hs-definition'>mkIface_</span> <span class='hs-varid'>hsc_env</span>
<a name="line-239"></a>         <span class='hs-varid'>this_mod</span> <span class='hs-varid'>hsc_src</span> <span class='hs-varid'>used_th</span> <span class='hs-varid'>deps</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>fix_env</span> <span class='hs-varid'>src_warns</span>
<a name="line-240"></a>         <span class='hs-varid'>hpc_info</span> <span class='hs-varid'>pkg_trust_req</span> <span class='hs-varid'>safe_mode</span> <span class='hs-varid'>usages</span>
<a name="line-241"></a>         <span class='hs-varid'>doc_hdr</span> <span class='hs-varid'>decl_docs</span> <span class='hs-varid'>arg_docs</span>
<a name="line-242"></a>         <span class='hs-conid'>ModDetails</span><span class='hs-layout'>{</span>  <span class='hs-varid'>md_insts</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insts</span><span class='hs-layout'>,</span>
<a name="line-243"></a>                      <span class='hs-varid'>md_fam_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam_insts</span><span class='hs-layout'>,</span>
<a name="line-244"></a>                      <span class='hs-varid'>md_rules</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rules</span><span class='hs-layout'>,</span>
<a name="line-245"></a>                      <span class='hs-varid'>md_anns</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>anns</span><span class='hs-layout'>,</span>
<a name="line-246"></a>                      <span class='hs-varid'>md_types</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>type_env</span><span class='hs-layout'>,</span>
<a name="line-247"></a>                      <span class='hs-varid'>md_exports</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exports</span><span class='hs-layout'>,</span>
<a name="line-248"></a>                      <span class='hs-varid'>md_complete_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>complete_matches</span> <span class='hs-layout'>}</span>
<a name="line-249"></a><span class='hs-comment'>-- NB:  notice that mkIface does not look at the bindings</span>
<a name="line-250"></a><span class='hs-comment'>--      only at the TypeEnv.  The previous Tidy phase has</span>
<a name="line-251"></a><span class='hs-comment'>--      put exactly the info into the TypeEnv that we want</span>
<a name="line-252"></a><span class='hs-comment'>--      to expose in the interface</span>
<a name="line-253"></a>
<a name="line-254"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-255"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>home_unit</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_home_unit</span> <span class='hs-varid'>hsc_env</span>
<a name="line-256"></a>        <span class='hs-varid'>semantic_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>homeModuleNameInstantiation</span> <span class='hs-varid'>home_unit</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>)</span>
<a name="line-257"></a>        <span class='hs-varid'>entities</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeEnvElts</span> <span class='hs-varid'>type_env</span>
<a name="line-258"></a>        <span class='hs-varid'>show_linear_types</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>LangExt.LinearTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-259"></a>        <span class='hs-varid'>decls</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>tyThingToIfaceDecl</span> <span class='hs-varid'>show_linear_types</span> <span class='hs-varid'>entity</span>
<a name="line-260"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>entity</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>entities</span><span class='hs-layout'>,</span>
<a name="line-261"></a>                   <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>entity</span><span class='hs-layout'>,</span>
<a name="line-262"></a>                   <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isImplicitTyThing</span> <span class='hs-varid'>entity</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-263"></a>                      <span class='hs-comment'>-- No implicit Ids and class tycons in the interface file</span>
<a name="line-264"></a>                   <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isWiredInName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-265"></a>                      <span class='hs-comment'>-- Nor wired-in things; the compiler knows about them anyhow</span>
<a name="line-266"></a>                   <span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>semantic_mod</span> <span class='hs-varid'>name</span>  <span class='hs-keyglyph'>]</span>
<a name="line-267"></a>                      <span class='hs-comment'>-- Sigh: see Note [Root-main Id] in GHC.Tc.Module</span>
<a name="line-268"></a>                      <span class='hs-comment'>-- NB: ABSOLUTELY need to check against semantic_mod,</span>
<a name="line-269"></a>                      <span class='hs-comment'>-- because all of the names in an hsig p[H=&lt;H&gt;]:H</span>
<a name="line-270"></a>                      <span class='hs-comment'>-- are going to be for &lt;H&gt;, not the former id!</span>
<a name="line-271"></a>                      <span class='hs-comment'>-- See Note [Identity versus semantic module]</span>
<a name="line-272"></a>
<a name="line-273"></a>        <span class='hs-varid'>fixities</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>comparing</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span>
<a name="line-274"></a>          <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>occ</span><span class='hs-layout'>,</span><span class='hs-varid'>fix</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FixItem</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>fix</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nameEnvElts</span> <span class='hs-varid'>fix_env</span><span class='hs-keyglyph'>]</span>
<a name="line-275"></a>          <span class='hs-comment'>-- The order of fixities returned from nameEnvElts is not</span>
<a name="line-276"></a>          <span class='hs-comment'>-- deterministic, so we sort by OccName to canonicalize it.</span>
<a name="line-277"></a>          <span class='hs-comment'>-- See Note [Deterministic UniqFM] in GHC.Types.Unique.DFM for more details.</span>
<a name="line-278"></a>        <span class='hs-varid'>warns</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src_warns</span>
<a name="line-279"></a>        <span class='hs-varid'>iface_rules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>coreRuleToIfaceRule</span> <span class='hs-varid'>rules</span>
<a name="line-280"></a>        <span class='hs-varid'>iface_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>instanceToIfaceInst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fixSafeInstances</span> <span class='hs-varid'>safe_mode</span> <span class='hs-varid'>insts</span>
<a name="line-281"></a>        <span class='hs-varid'>iface_fam_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>famInstToIfaceFamInst</span> <span class='hs-varid'>fam_insts</span>
<a name="line-282"></a>        <span class='hs-varid'>trust_info</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSafeMode</span> <span class='hs-varid'>safe_mode</span>
<a name="line-283"></a>        <span class='hs-varid'>annotations</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>mkIfaceAnnotation</span> <span class='hs-varid'>anns</span>
<a name="line-284"></a>        <span class='hs-varid'>icomplete_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>mkIfaceCompleteMatch</span> <span class='hs-varid'>complete_matches</span>
<a name="line-285"></a>
<a name="line-286"></a>    <span class='hs-conid'>ModIface</span> <span class='hs-layout'>{</span>
<a name="line-287"></a>          <span class='hs-varid'>mi_module</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>,</span>
<a name="line-288"></a>          <span class='hs-comment'>-- Need to record this because it depends on the -instantiated-with flag</span>
<a name="line-289"></a>          <span class='hs-comment'>-- which could change</span>
<a name="line-290"></a>          <span class='hs-varid'>mi_sig_of</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>semantic_mod</span> <span class='hs-varop'>==</span> <span class='hs-varid'>this_mod</span>
<a name="line-291"></a>                            <span class='hs-keyword'>then</span> <span class='hs-conid'>Nothing</span>
<a name="line-292"></a>                            <span class='hs-keyword'>else</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>semantic_mod</span><span class='hs-layout'>,</span>
<a name="line-293"></a>          <span class='hs-varid'>mi_hsc_src</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_src</span><span class='hs-layout'>,</span>
<a name="line-294"></a>          <span class='hs-varid'>mi_deps</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deps</span><span class='hs-layout'>,</span>
<a name="line-295"></a>          <span class='hs-varid'>mi_usages</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>usages</span><span class='hs-layout'>,</span>
<a name="line-296"></a>          <span class='hs-varid'>mi_exports</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkIfaceExports</span> <span class='hs-varid'>exports</span><span class='hs-layout'>,</span>
<a name="line-297"></a>
<a name="line-298"></a>          <span class='hs-comment'>-- Sort these lexicographically, so that</span>
<a name="line-299"></a>          <span class='hs-comment'>-- the result is stable across compilations</span>
<a name="line-300"></a>          <span class='hs-varid'>mi_insts</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-varid'>cmp_inst</span>     <span class='hs-varid'>iface_insts</span><span class='hs-layout'>,</span>
<a name="line-301"></a>          <span class='hs-varid'>mi_fam_insts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-varid'>cmp_fam_inst</span> <span class='hs-varid'>iface_fam_insts</span><span class='hs-layout'>,</span>
<a name="line-302"></a>          <span class='hs-varid'>mi_rules</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-varid'>cmp_rule</span>     <span class='hs-varid'>iface_rules</span><span class='hs-layout'>,</span>
<a name="line-303"></a>
<a name="line-304"></a>          <span class='hs-varid'>mi_fixities</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fixities</span><span class='hs-layout'>,</span>
<a name="line-305"></a>          <span class='hs-varid'>mi_warns</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>warns</span><span class='hs-layout'>,</span>
<a name="line-306"></a>          <span class='hs-varid'>mi_anns</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>annotations</span><span class='hs-layout'>,</span>
<a name="line-307"></a>          <span class='hs-varid'>mi_globals</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeGlobalRdrEnv</span> <span class='hs-varid'>rdr_env</span><span class='hs-layout'>,</span>
<a name="line-308"></a>          <span class='hs-varid'>mi_used_th</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>used_th</span><span class='hs-layout'>,</span>
<a name="line-309"></a>          <span class='hs-varid'>mi_decls</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decls</span><span class='hs-layout'>,</span>
<a name="line-310"></a>          <span class='hs-varid'>mi_hpc</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isHpcUsed</span> <span class='hs-varid'>hpc_info</span><span class='hs-layout'>,</span>
<a name="line-311"></a>          <span class='hs-varid'>mi_trust</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>trust_info</span><span class='hs-layout'>,</span>
<a name="line-312"></a>          <span class='hs-varid'>mi_trust_pkg</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pkg_trust_req</span><span class='hs-layout'>,</span>
<a name="line-313"></a>          <span class='hs-varid'>mi_complete_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>icomplete_matches</span><span class='hs-layout'>,</span>
<a name="line-314"></a>          <span class='hs-varid'>mi_doc_hdr</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>doc_hdr</span><span class='hs-layout'>,</span>
<a name="line-315"></a>          <span class='hs-varid'>mi_decl_docs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decl_docs</span><span class='hs-layout'>,</span>
<a name="line-316"></a>          <span class='hs-varid'>mi_arg_docs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_docs</span><span class='hs-layout'>,</span>
<a name="line-317"></a>          <span class='hs-varid'>mi_final_exts</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span><span class='hs-layout'>,</span>
<a name="line-318"></a>          <span class='hs-varid'>mi_ext_fields</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyExtensibleFields</span> <span class='hs-layout'>}</span>
<a name="line-319"></a>  <span class='hs-keyword'>where</span>
<a name="line-320"></a>     <span class='hs-varid'>cmp_rule</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lexicalCompareFS</span> <span class='hs-varop'>`on`</span> <span class='hs-varid'>ifRuleName</span>
<a name="line-321"></a>     <span class='hs-comment'>-- Compare these lexicographically by OccName, *not* by unique,</span>
<a name="line-322"></a>     <span class='hs-comment'>-- because the latter is not stable across compilations:</span>
<a name="line-323"></a>     <span class='hs-varid'>cmp_inst</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>comparing</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ifDFun</span><span class='hs-layout'>)</span>
<a name="line-324"></a>     <span class='hs-varid'>cmp_fam_inst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>comparing</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ifFamInstTcName</span><span class='hs-layout'>)</span>
<a name="line-325"></a>
<a name="line-326"></a>     <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-327"></a>
<a name="line-328"></a>     <span class='hs-comment'>-- We only fill in mi_globals if the module was compiled to byte</span>
<a name="line-329"></a>     <span class='hs-comment'>-- code.  Otherwise, the compiler may not have retained all the</span>
<a name="line-330"></a>     <span class='hs-comment'>-- top-level bindings and they won't be in the TypeEnv (see</span>
<a name="line-331"></a>     <span class='hs-comment'>-- Desugar.addExportFlagsAndRules).  The mi_globals field is used</span>
<a name="line-332"></a>     <span class='hs-comment'>-- by GHCi to decide whether the module has its full top-level</span>
<a name="line-333"></a>     <span class='hs-comment'>-- scope available. (#5534)</span>
<a name="line-334"></a>     <span class='hs-varid'>maybeGlobalRdrEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>GlobalRdrEnv</span>
<a name="line-335"></a>     <span class='hs-varid'>maybeGlobalRdrEnv</span> <span class='hs-varid'>rdr_env</span>
<a name="line-336"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>backendRetainsAllBindings</span> <span class='hs-layout'>(</span><span class='hs-varid'>backend</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>rdr_env</span>
<a name="line-337"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-338"></a>
<a name="line-339"></a>     <span class='hs-varid'>ifFamInstTcName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ifFamInstFam</span>
<a name="line-340"></a>
<a name="line-341"></a>
<a name="line-342"></a><span class='hs-comment'>{-
<a name="line-343"></a>************************************************************************
<a name="line-344"></a>*                                                                      *
<a name="line-345"></a>       COMPLETE Pragmas
<a name="line-346"></a>*                                                                      *
<a name="line-347"></a>************************************************************************
<a name="line-348"></a>-}</span>
<a name="line-349"></a>
<a name="line-350"></a><a name="mkIfaceCompleteMatch"></a><span class='hs-definition'>mkIfaceCompleteMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CompleteMatch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceCompleteMatch</span>
<a name="line-351"></a><span class='hs-definition'>mkIfaceCompleteMatch</span> <span class='hs-layout'>(</span><span class='hs-conid'>CompleteMatch</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>mtc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-352"></a>  <span class='hs-conid'>IfaceCompleteMatch</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>conLikeName</span> <span class='hs-layout'>(</span><span class='hs-varid'>uniqDSetToList</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceTyCon</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>mtc</span><span class='hs-layout'>)</span>
<a name="line-353"></a>
<a name="line-354"></a>
<a name="line-355"></a><span class='hs-comment'>{-
<a name="line-356"></a>************************************************************************
<a name="line-357"></a>*                                                                      *
<a name="line-358"></a>       Keeping track of what we've slurped, and fingerprints
<a name="line-359"></a>*                                                                      *
<a name="line-360"></a>************************************************************************
<a name="line-361"></a>-}</span>
<a name="line-362"></a>
<a name="line-363"></a>
<a name="line-364"></a><a name="mkIfaceAnnotation"></a><span class='hs-definition'>mkIfaceAnnotation</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Annotation</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceAnnotation</span>
<a name="line-365"></a><span class='hs-definition'>mkIfaceAnnotation</span> <span class='hs-layout'>(</span><span class='hs-conid'>Annotation</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ann_target</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>target</span><span class='hs-layout'>,</span> <span class='hs-varid'>ann_value</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>payload</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-366"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceAnnotation</span> <span class='hs-layout'>{</span>
<a name="line-367"></a>        <span class='hs-varid'>ifAnnotatedTarget</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>target</span><span class='hs-layout'>,</span>
<a name="line-368"></a>        <span class='hs-varid'>ifAnnotatedValue</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>payload</span>
<a name="line-369"></a>    <span class='hs-layout'>}</span>
<a name="line-370"></a>
<a name="line-371"></a><a name="mkIfaceExports"></a><span class='hs-definition'>mkIfaceExports</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IfaceExport</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- Sort to make canonical</span>
<a name="line-372"></a><span class='hs-definition'>mkIfaceExports</span> <span class='hs-varid'>exports</span>
<a name="line-373"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-varid'>stableAvailCmp</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>sort_subs</span> <span class='hs-varid'>exports</span><span class='hs-layout'>)</span>
<a name="line-374"></a>  <span class='hs-keyword'>where</span>
<a name="line-375"></a>    <span class='hs-varid'>sort_subs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AvailInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AvailInfo</span>
<a name="line-376"></a>    <span class='hs-varid'>sort_subs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Avail</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Avail</span> <span class='hs-varid'>n</span>
<a name="line-377"></a>    <span class='hs-varid'>sort_subs</span> <span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n</span> <span class='hs-conid'>[]</span>
<a name="line-378"></a>    <span class='hs-varid'>sort_subs</span> <span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-conop'>:</span><span class='hs-varid'>ms</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-379"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NormalGreName</span> <span class='hs-varid'>n</span><span class='hs-varop'>==</span><span class='hs-varid'>m</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-conop'>:</span><span class='hs-varid'>sortBy</span> <span class='hs-varid'>stableGreNameCmp</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span>
<a name="line-380"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>sortBy</span> <span class='hs-varid'>stableGreNameCmp</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-conop'>:</span><span class='hs-varid'>ms</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-381"></a>       <span class='hs-comment'>-- Maintain the AvailTC Invariant</span>
<a name="line-382"></a>
<a name="line-383"></a><span class='hs-comment'>{-
<a name="line-384"></a>Note [Original module]
<a name="line-385"></a>~~~~~~~~~~~~~~~~~~~~~
<a name="line-386"></a>Consider this:
<a name="line-387"></a>        module X where { data family T }
<a name="line-388"></a>        module Y( T(..) ) where { import X; data instance T Int = MkT Int }
<a name="line-389"></a>The exported Avail from Y will look like
<a name="line-390"></a>        X.T{X.T, Y.MkT}
<a name="line-391"></a>That is, in Y,
<a name="line-392"></a>  - only MkT is brought into scope by the data instance;
<a name="line-393"></a>  - but the parent (used for grouping and naming in T(..) exports) is X.T
<a name="line-394"></a>  - and in this case we export X.T too
<a name="line-395"></a>
<a name="line-396"></a>In the result of mkIfaceExports, the names are grouped by defining module,
<a name="line-397"></a>so we may need to split up a single Avail into multiple ones.
<a name="line-398"></a>-}</span>
<a name="line-399"></a>
<a name="line-400"></a>
<a name="line-401"></a><span class='hs-comment'>{-
<a name="line-402"></a>************************************************************************
<a name="line-403"></a>*                                                                      *
<a name="line-404"></a>                Converting things to their Iface equivalents
<a name="line-405"></a>*                                                                      *
<a name="line-406"></a>************************************************************************
<a name="line-407"></a>-}</span>
<a name="line-408"></a>
<a name="line-409"></a><a name="tyThingToIfaceDecl"></a><span class='hs-definition'>tyThingToIfaceDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceDecl</span>
<a name="line-410"></a><span class='hs-definition'>tyThingToIfaceDecl</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnId</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idToIfaceDecl</span> <span class='hs-varid'>id</span>
<a name="line-411"></a><span class='hs-definition'>tyThingToIfaceDecl</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConToIfaceDecl</span> <span class='hs-varid'>emptyTidyEnv</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span>
<a name="line-412"></a><span class='hs-definition'>tyThingToIfaceDecl</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ACoAxiom</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomToIfaceDecl</span> <span class='hs-varid'>ax</span>
<a name="line-413"></a><span class='hs-definition'>tyThingToIfaceDecl</span> <span class='hs-varid'>show_linear_types</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-varid'>cl</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cl</span> <span class='hs-keyword'>of</span>
<a name="line-414"></a>    <span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>dataConToIfaceDecl</span> <span class='hs-varid'>show_linear_types</span> <span class='hs-varid'>dc</span> <span class='hs-comment'>-- for ppr purposes only</span>
<a name="line-415"></a>    <span class='hs-conid'>PatSynCon</span> <span class='hs-varid'>ps</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patSynToIfaceDecl</span> <span class='hs-varid'>ps</span>
<a name="line-416"></a>
<a name="line-417"></a><a name="idToIfaceDecl"></a><span class='hs-comment'>--------------------------</span>
<a name="line-418"></a><span class='hs-definition'>idToIfaceDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceDecl</span>
<a name="line-419"></a><span class='hs-comment'>-- The Id is already tidied, so that locally-bound names</span>
<a name="line-420"></a><span class='hs-comment'>-- (lambdas, for-alls) already have non-clashing OccNames</span>
<a name="line-421"></a><span class='hs-comment'>-- We can't tidy it here, locally, because it may have</span>
<a name="line-422"></a><span class='hs-comment'>-- free variables in its type or IdInfo</span>
<a name="line-423"></a><span class='hs-definition'>idToIfaceDecl</span> <span class='hs-varid'>id</span>
<a name="line-424"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceId</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifName</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span>
<a name="line-425"></a>              <span class='hs-varid'>ifType</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-426"></a>              <span class='hs-varid'>ifIdDetails</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceIdDetails</span> <span class='hs-layout'>(</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-427"></a>              <span class='hs-varid'>ifIdInfo</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceIdInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-428"></a>
<a name="line-429"></a><a name="dataConToIfaceDecl"></a><span class='hs-comment'>--------------------------</span>
<a name="line-430"></a><span class='hs-definition'>dataConToIfaceDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceDecl</span>
<a name="line-431"></a><span class='hs-definition'>dataConToIfaceDecl</span> <span class='hs-varid'>show_linear_types</span> <span class='hs-varid'>dataCon</span>
<a name="line-432"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceId</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifName</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>dataCon</span><span class='hs-layout'>,</span>
<a name="line-433"></a>              <span class='hs-varid'>ifType</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceType</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConDisplayType</span> <span class='hs-varid'>show_linear_types</span> <span class='hs-varid'>dataCon</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-434"></a>              <span class='hs-varid'>ifIdDetails</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfVanillaId</span><span class='hs-layout'>,</span>
<a name="line-435"></a>              <span class='hs-varid'>ifIdInfo</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span>
<a name="line-436"></a>
<a name="line-437"></a><a name="coAxiomToIfaceDecl"></a><span class='hs-comment'>--------------------------</span>
<a name="line-438"></a><span class='hs-definition'>coAxiomToIfaceDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceDecl</span>
<a name="line-439"></a><span class='hs-comment'>-- We *do* tidy Axioms, because they are not (and cannot</span>
<a name="line-440"></a><span class='hs-comment'>-- conveniently be) built in tidy form</span>
<a name="line-441"></a><span class='hs-definition'>coAxiomToIfaceDecl</span> <span class='hs-varid'>ax</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_branches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>branches</span>
<a name="line-442"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_role</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>role</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-443"></a> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifName</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>ax</span>
<a name="line-444"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ifTyCon</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-445"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ifRole</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>role</span>
<a name="line-446"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ifAxBranches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxBranchToIfaceBranch</span> <span class='hs-varid'>tycon</span>
<a name="line-447"></a>                                     <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>coAxBranchLHS</span> <span class='hs-varid'>branch_list</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-448"></a>                                   <span class='hs-varid'>branch_list</span> <span class='hs-layout'>}</span>
<a name="line-449"></a> <span class='hs-keyword'>where</span>
<a name="line-450"></a>   <span class='hs-varid'>branch_list</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromBranches</span> <span class='hs-varid'>branches</span>
<a name="line-451"></a>
<a name="line-452"></a><a name="coAxBranchToIfaceBranch"></a><span class='hs-comment'>-- 2nd parameter is the list of branch LHSs, in case of a closed type family,</span>
<a name="line-453"></a><span class='hs-comment'>-- for conversion from incompatible branches to incompatible indices.</span>
<a name="line-454"></a><span class='hs-comment'>-- For an open type family the list should be empty.</span>
<a name="line-455"></a><span class='hs-comment'>-- See Note [Storing compatibility] in GHC.Core.Coercion.Axiom</span>
<a name="line-456"></a><span class='hs-definition'>coAxBranchToIfaceBranch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceAxBranch</span>
<a name="line-457"></a><span class='hs-definition'>coAxBranchToIfaceBranch</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>lhs_s</span>
<a name="line-458"></a>                        <span class='hs-layout'>(</span><span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_cvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cvs</span>
<a name="line-459"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>cab_eta_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eta_tvs</span>
<a name="line-460"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_roles</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>roles</span>
<a name="line-461"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_incomps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>incomps</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-462"></a>
<a name="line-463"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifaxbTyVars</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceTvBndrs</span> <span class='hs-varid'>tvs</span>
<a name="line-464"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>ifaxbCoVars</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toIfaceIdBndr</span> <span class='hs-varid'>cvs</span>
<a name="line-465"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>ifaxbEtaTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceTvBndrs</span> <span class='hs-varid'>eta_tvs</span>
<a name="line-466"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>ifaxbLHS</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceTcArgs</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>lhs</span>
<a name="line-467"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>ifaxbRoles</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>roles</span>
<a name="line-468"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>ifaxbRHS</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceType</span> <span class='hs-varid'>rhs</span>
<a name="line-469"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>ifaxbIncomps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>iface_incomps</span> <span class='hs-layout'>}</span>
<a name="line-470"></a>  <span class='hs-keyword'>where</span>
<a name="line-471"></a>    <span class='hs-varid'>iface_incomps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>expectJust</span> <span class='hs-str'>"iface_incomps"</span>
<a name="line-472"></a>                        <span class='hs-varop'>.</span> <span class='hs-varid'>flip</span> <span class='hs-varid'>findIndex</span> <span class='hs-varid'>lhs_s</span>
<a name="line-473"></a>                        <span class='hs-varop'>.</span> <span class='hs-varid'>eqTypes</span>
<a name="line-474"></a>                        <span class='hs-varop'>.</span> <span class='hs-varid'>coAxBranchLHS</span><span class='hs-layout'>)</span> <span class='hs-varid'>incomps</span>
<a name="line-475"></a>
<a name="line-476"></a><a name="tyConToIfaceDecl"></a><span class='hs-comment'>-----------------</span>
<a name="line-477"></a><span class='hs-definition'>tyConToIfaceDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfaceDecl</span><span class='hs-layout'>)</span>
<a name="line-478"></a><span class='hs-comment'>-- We *do* tidy TyCons, because they are not (and cannot</span>
<a name="line-479"></a><span class='hs-comment'>-- conveniently be) built in tidy form</span>
<a name="line-480"></a><span class='hs-comment'>-- The returned TidyEnv is the one after tidying the tyConTyVars</span>
<a name="line-481"></a><span class='hs-definition'>tyConToIfaceDecl</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tycon</span>
<a name="line-482"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>clas</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConClass_maybe</span> <span class='hs-varid'>tycon</span>
<a name="line-483"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classToIfaceDecl</span> <span class='hs-varid'>env</span> <span class='hs-varid'>clas</span>
<a name="line-484"></a>
<a name="line-485"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>syn_rhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>synTyConRhs_maybe</span> <span class='hs-varid'>tycon</span>
<a name="line-486"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-varid'>tc_env1</span>
<a name="line-487"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>IfaceSynonym</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifName</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span>
<a name="line-488"></a>                     <span class='hs-varid'>ifRoles</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConRoles</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span>
<a name="line-489"></a>                     <span class='hs-varid'>ifSynRhs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>if_syn_type</span> <span class='hs-varid'>syn_rhs</span><span class='hs-layout'>,</span>
<a name="line-490"></a>                     <span class='hs-varid'>ifBinders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>if_binders</span><span class='hs-layout'>,</span>
<a name="line-491"></a>                     <span class='hs-varid'>ifResKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>if_res_kind</span>
<a name="line-492"></a>                   <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-493"></a>
<a name="line-494"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>fam_flav</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>famTyConFlav_maybe</span> <span class='hs-varid'>tycon</span>
<a name="line-495"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-varid'>tc_env1</span>
<a name="line-496"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>IfaceFamily</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifName</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span>
<a name="line-497"></a>                    <span class='hs-varid'>ifResVar</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>if_res_var</span><span class='hs-layout'>,</span>
<a name="line-498"></a>                    <span class='hs-varid'>ifFamFlav</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>to_if_fam_flav</span> <span class='hs-varid'>fam_flav</span><span class='hs-layout'>,</span>
<a name="line-499"></a>                    <span class='hs-varid'>ifBinders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>if_binders</span><span class='hs-layout'>,</span>
<a name="line-500"></a>                    <span class='hs-varid'>ifResKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>if_res_kind</span><span class='hs-layout'>,</span>
<a name="line-501"></a>                    <span class='hs-varid'>ifFamInj</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConInjectivityInfo</span> <span class='hs-varid'>tycon</span>
<a name="line-502"></a>                  <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-503"></a>
<a name="line-504"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAlgTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-505"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-varid'>tc_env1</span>
<a name="line-506"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>IfaceData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifName</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span>
<a name="line-507"></a>                  <span class='hs-varid'>ifBinders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>if_binders</span><span class='hs-layout'>,</span>
<a name="line-508"></a>                  <span class='hs-varid'>ifResKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>if_res_kind</span><span class='hs-layout'>,</span>
<a name="line-509"></a>                  <span class='hs-varid'>ifCType</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConCType</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span>
<a name="line-510"></a>                  <span class='hs-varid'>ifRoles</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConRoles</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span>
<a name="line-511"></a>                  <span class='hs-varid'>ifCtxt</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyToIfaceContext</span> <span class='hs-varid'>tc_env1</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConStupidTheta</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-512"></a>                  <span class='hs-varid'>ifCons</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ifaceConDecls</span> <span class='hs-layout'>(</span><span class='hs-varid'>algTyConRhs</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-513"></a>                  <span class='hs-varid'>ifGadtSyntax</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isGadtSyntaxTyCon</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span>
<a name="line-514"></a>                  <span class='hs-varid'>ifParent</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parent</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-515"></a>
<a name="line-516"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-comment'>-- FunTyCon, PrimTyCon, promoted TyCon/DataCon</span>
<a name="line-517"></a>  <span class='hs-comment'>-- We only convert these TyCons to IfaceTyCons when we are</span>
<a name="line-518"></a>  <span class='hs-comment'>-- just about to pretty-print them, not because we are going</span>
<a name="line-519"></a>  <span class='hs-comment'>-- to put them into interface files</span>
<a name="line-520"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-varid'>env</span>
<a name="line-521"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>IfaceData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifName</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span>
<a name="line-522"></a>                  <span class='hs-varid'>ifBinders</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>if_binders</span><span class='hs-layout'>,</span>
<a name="line-523"></a>                  <span class='hs-varid'>ifResKind</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>if_res_kind</span><span class='hs-layout'>,</span>
<a name="line-524"></a>                  <span class='hs-varid'>ifCType</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span>
<a name="line-525"></a>                  <span class='hs-varid'>ifRoles</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConRoles</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span>
<a name="line-526"></a>                  <span class='hs-varid'>ifCtxt</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-527"></a>                  <span class='hs-varid'>ifCons</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfDataTyCon</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-528"></a>                  <span class='hs-varid'>ifGadtSyntax</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span>
<a name="line-529"></a>                  <span class='hs-varid'>ifParent</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfNoParent</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-530"></a>  <span class='hs-keyword'>where</span>
<a name="line-531"></a>    <span class='hs-comment'>-- NOTE: Not all TyCons have `tyConTyVars` field. Forcing this when `tycon`</span>
<a name="line-532"></a>    <span class='hs-comment'>-- is one of these TyCons (FunTyCon, PrimTyCon, PromotedDataCon) will cause</span>
<a name="line-533"></a>    <span class='hs-comment'>-- an error.</span>
<a name="line-534"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tc_env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_binders</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTyConBinders</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConBinders</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span>
<a name="line-535"></a>    <span class='hs-varid'>tc_tyvars</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binderVars</span> <span class='hs-varid'>tc_binders</span>
<a name="line-536"></a>    <span class='hs-varid'>if_binders</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceTyCoVarBinders</span> <span class='hs-varid'>tc_binders</span>
<a name="line-537"></a>                     <span class='hs-comment'>-- No tidying of the binders; they are already tidy</span>
<a name="line-538"></a>    <span class='hs-varid'>if_res_kind</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyToIfaceType</span> <span class='hs-varid'>tc_env1</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConResKind</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span>
<a name="line-539"></a>    <span class='hs-varid'>if_syn_type</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyToIfaceType</span> <span class='hs-varid'>tc_env1</span> <span class='hs-varid'>ty</span>
<a name="line-540"></a>    <span class='hs-varid'>if_res_var</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getOccFS</span> <span class='hs-varop'>`fmap`</span> <span class='hs-varid'>tyConFamilyResVar_maybe</span> <span class='hs-varid'>tycon</span>
<a name="line-541"></a>
<a name="line-542"></a>    <span class='hs-varid'>parent</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConFamInstSig_maybe</span> <span class='hs-varid'>tycon</span> <span class='hs-keyword'>of</span>
<a name="line-543"></a>               <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfDataInstance</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomName</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span>
<a name="line-544"></a>                                                   <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-545"></a>                                                   <span class='hs-layout'>(</span><span class='hs-varid'>tidyToIfaceTcArgs</span> <span class='hs-varid'>tc_env1</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-546"></a>               <span class='hs-conid'>Nothing</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfNoParent</span>
<a name="line-547"></a>
<a name="line-548"></a>    <span class='hs-varid'>to_if_fam_flav</span> <span class='hs-conid'>OpenSynFamilyTyCon</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceOpenSynFamilyTyCon</span>
<a name="line-549"></a>    <span class='hs-varid'>to_if_fam_flav</span> <span class='hs-conid'>AbstractClosedSynFamilyTyCon</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceAbstractClosedSynFamilyTyCon</span>
<a name="line-550"></a>    <span class='hs-varid'>to_if_fam_flav</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataFamilyTyCon</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceDataFamilyTyCon</span>
<a name="line-551"></a>    <span class='hs-varid'>to_if_fam_flav</span> <span class='hs-layout'>(</span><span class='hs-conid'>BuiltInSynFamTyCon</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceBuiltInSynFamTyCon</span>
<a name="line-552"></a>    <span class='hs-varid'>to_if_fam_flav</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClosedSynFamilyTyCon</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceClosedSynFamilyTyCon</span> <span class='hs-conid'>Nothing</span>
<a name="line-553"></a>    <span class='hs-varid'>to_if_fam_flav</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClosedSynFamilyTyCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-554"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceClosedSynFamilyTyCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>axn</span><span class='hs-layout'>,</span> <span class='hs-varid'>ibr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-555"></a>      <span class='hs-keyword'>where</span> <span class='hs-varid'>defs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromBranches</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coAxiomBranches</span> <span class='hs-varid'>ax</span>
<a name="line-556"></a>            <span class='hs-varid'>lhss</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>coAxBranchLHS</span> <span class='hs-varid'>defs</span>
<a name="line-557"></a>            <span class='hs-varid'>ibr</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxBranchToIfaceBranch</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>lhss</span><span class='hs-layout'>)</span> <span class='hs-varid'>defs</span>
<a name="line-558"></a>            <span class='hs-varid'>axn</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomName</span> <span class='hs-varid'>ax</span>
<a name="line-559"></a>
<a name="line-560"></a>    <span class='hs-varid'>ifaceConDecls</span> <span class='hs-layout'>(</span><span class='hs-conid'>NewTyCon</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_con</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfNewTyCon</span>  <span class='hs-layout'>(</span><span class='hs-varid'>ifaceConDecl</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-561"></a>    <span class='hs-varid'>ifaceConDecls</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataTyCon</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_cons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cons</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfDataTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ifaceConDecl</span> <span class='hs-varid'>cons</span><span class='hs-layout'>)</span>
<a name="line-562"></a>    <span class='hs-varid'>ifaceConDecls</span> <span class='hs-layout'>(</span><span class='hs-conid'>TupleTyCon</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_con</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfDataTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ifaceConDecl</span> <span class='hs-varid'>con</span><span class='hs-keyglyph'>]</span>
<a name="line-563"></a>    <span class='hs-varid'>ifaceConDecls</span> <span class='hs-layout'>(</span><span class='hs-conid'>SumTyCon</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_cons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cons</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfDataTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ifaceConDecl</span> <span class='hs-varid'>cons</span><span class='hs-layout'>)</span>
<a name="line-564"></a>    <span class='hs-varid'>ifaceConDecls</span> <span class='hs-conid'>AbstractTyCon</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfAbstractTyCon</span>
<a name="line-565"></a>        <span class='hs-comment'>-- The AbstractTyCon case happens when a TyCon has been trimmed</span>
<a name="line-566"></a>        <span class='hs-comment'>-- during tidying.</span>
<a name="line-567"></a>        <span class='hs-comment'>-- Furthermore, tyThingToIfaceDecl is also used in GHC.Tc.Module</span>
<a name="line-568"></a>        <span class='hs-comment'>-- for GHCi, when browsing a module, in which case the</span>
<a name="line-569"></a>        <span class='hs-comment'>-- AbstractTyCon and TupleTyCon cases are perfectly sensible.</span>
<a name="line-570"></a>        <span class='hs-comment'>-- (Tuple declarations are not serialised into interface files.)</span>
<a name="line-571"></a>
<a name="line-572"></a>    <span class='hs-varid'>ifaceConDecl</span> <span class='hs-varid'>data_con</span>
<a name="line-573"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfCon</span>   <span class='hs-layout'>{</span> <span class='hs-varid'>ifConName</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConName</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>,</span>
<a name="line-574"></a>                    <span class='hs-varid'>ifConInfix</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConIsInfix</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>,</span>
<a name="line-575"></a>                    <span class='hs-varid'>ifConWrapper</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConWrapId_maybe</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-576"></a>                    <span class='hs-varid'>ifConExTCvs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toIfaceBndr</span> <span class='hs-varid'>ex_tvs'</span><span class='hs-layout'>,</span>
<a name="line-577"></a>                    <span class='hs-varid'>ifConUserTvBinders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toIfaceForAllBndr</span> <span class='hs-varid'>user_bndrs'</span><span class='hs-layout'>,</span>
<a name="line-578"></a>                    <span class='hs-varid'>ifConEqSpec</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>to_eq_spec</span> <span class='hs-varop'>.</span> <span class='hs-varid'>eqSpecPair</span><span class='hs-layout'>)</span> <span class='hs-varid'>eq_spec</span><span class='hs-layout'>,</span>
<a name="line-579"></a>                    <span class='hs-varid'>ifConCtxt</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyToIfaceContext</span> <span class='hs-varid'>con_env2</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span>
<a name="line-580"></a>                    <span class='hs-varid'>ifConArgTys</span>  <span class='hs-keyglyph'>=</span>
<a name="line-581"></a>                      <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>Scaled</span> <span class='hs-varid'>w</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyToIfaceType</span> <span class='hs-varid'>con_env2</span> <span class='hs-varid'>w</span>
<a name="line-582"></a>                                          <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyToIfaceType</span> <span class='hs-varid'>con_env2</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span>
<a name="line-583"></a>                    <span class='hs-varid'>ifConFields</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFieldLabels</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>,</span>
<a name="line-584"></a>                    <span class='hs-varid'>ifConStricts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceBang</span> <span class='hs-varid'>con_env2</span><span class='hs-layout'>)</span>
<a name="line-585"></a>                                       <span class='hs-layout'>(</span><span class='hs-varid'>dataConImplBangs</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-586"></a>                    <span class='hs-varid'>ifConSrcStricts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toIfaceSrcBang</span>
<a name="line-587"></a>                                          <span class='hs-layout'>(</span><span class='hs-varid'>dataConSrcBangs</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span><span class='hs-layout'>}</span>
<a name="line-588"></a>        <span class='hs-keyword'>where</span>
<a name="line-589"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>eq_spec</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-590"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFullSig</span> <span class='hs-varid'>data_con</span>
<a name="line-591"></a>          <span class='hs-varid'>user_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConUserTyVarBinders</span> <span class='hs-varid'>data_con</span>
<a name="line-592"></a>
<a name="line-593"></a>          <span class='hs-comment'>-- Tidy the univ_tvs of the data constructor to be identical</span>
<a name="line-594"></a>          <span class='hs-comment'>-- to the tyConTyVars of the type constructor.  This means</span>
<a name="line-595"></a>          <span class='hs-comment'>-- (a) we don't need to redundantly put them into the interface file</span>
<a name="line-596"></a>          <span class='hs-comment'>-- (b) when pretty-printing an Iface data declaration in H98-style syntax,</span>
<a name="line-597"></a>          <span class='hs-comment'>--     we know that the type variables will line up</span>
<a name="line-598"></a>          <span class='hs-comment'>-- The latter (b) is important because we pretty-print type constructors</span>
<a name="line-599"></a>          <span class='hs-comment'>-- by converting to Iface syntax and pretty-printing that</span>
<a name="line-600"></a>          <span class='hs-varid'>con_env1</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-varid'>tc_env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipEqual</span> <span class='hs-str'>"ifaceConDecl"</span> <span class='hs-varid'>univ_tvs</span> <span class='hs-varid'>tc_tyvars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-601"></a>                     <span class='hs-comment'>-- A bit grimy, perhaps, but it's simple!</span>
<a name="line-602"></a>
<a name="line-603"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>con_env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyVarBndrs</span> <span class='hs-varid'>con_env1</span> <span class='hs-varid'>ex_tvs</span>
<a name="line-604"></a>          <span class='hs-varid'>user_bndrs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyUserTyCoVarBinder</span> <span class='hs-varid'>con_env2</span><span class='hs-layout'>)</span> <span class='hs-varid'>user_bndrs</span>
<a name="line-605"></a>          <span class='hs-varid'>to_eq_spec</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyTyVar</span> <span class='hs-varid'>con_env2</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyToIfaceType</span> <span class='hs-varid'>con_env2</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-606"></a>
<a name="line-607"></a>          <span class='hs-comment'>-- By this point, we have tidied every universal and existential</span>
<a name="line-608"></a>          <span class='hs-comment'>-- tyvar. Because of the dcUserTyCoVarBinders invariant</span>
<a name="line-609"></a>          <span class='hs-comment'>-- (see Note [DataCon user type variable binders]), *every*</span>
<a name="line-610"></a>          <span class='hs-comment'>-- user-written tyvar must be contained in the substitution that</span>
<a name="line-611"></a>          <span class='hs-comment'>-- tidying produced. Therefore, tidying the user-written tyvars is a</span>
<a name="line-612"></a>          <span class='hs-comment'>-- simple matter of looking up each variable in the substitution,</span>
<a name="line-613"></a>          <span class='hs-comment'>-- which tidyTyCoVarOcc accomplishes.</span>
<a name="line-614"></a>          <span class='hs-varid'>tidyUserTyCoVarBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InvisTVBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InvisTVBinder</span>
<a name="line-615"></a>          <span class='hs-varid'>tidyUserTyCoVarBinder</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-616"></a>            <span class='hs-conid'>Bndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyTyCoVarOcc</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>vis</span>
<a name="line-617"></a>
<a name="line-618"></a><a name="classToIfaceDecl"></a><span class='hs-definition'>classToIfaceDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfaceDecl</span><span class='hs-layout'>)</span>
<a name="line-619"></a><span class='hs-definition'>classToIfaceDecl</span> <span class='hs-varid'>env</span> <span class='hs-varid'>clas</span>
<a name="line-620"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-varid'>env1</span>
<a name="line-621"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>IfaceClass</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifName</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span>
<a name="line-622"></a>                   <span class='hs-varid'>ifRoles</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConRoles</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-623"></a>                   <span class='hs-varid'>ifBinders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceTyCoVarBinders</span> <span class='hs-varid'>tc_binders</span><span class='hs-layout'>,</span>
<a name="line-624"></a>                   <span class='hs-varid'>ifBody</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>body</span><span class='hs-layout'>,</span>
<a name="line-625"></a>                   <span class='hs-varid'>ifFDs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toIfaceFD</span> <span class='hs-varid'>clas_fds</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-626"></a>  <span class='hs-keyword'>where</span>
<a name="line-627"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>clas_fds</span><span class='hs-layout'>,</span> <span class='hs-varid'>sc_theta</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>clas_ats</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_stuff</span><span class='hs-layout'>)</span>
<a name="line-628"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classExtraBigSig</span> <span class='hs-varid'>clas</span>
<a name="line-629"></a>    <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classTyCon</span> <span class='hs-varid'>clas</span>
<a name="line-630"></a>
<a name="line-631"></a>    <span class='hs-varid'>body</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAbstractTyCon</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfAbstractClass</span>
<a name="line-632"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-633"></a>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfConcreteClass</span> <span class='hs-layout'>{</span>
<a name="line-634"></a>                <span class='hs-varid'>ifClassCtxt</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyToIfaceContext</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>sc_theta</span><span class='hs-layout'>,</span>
<a name="line-635"></a>                <span class='hs-varid'>ifATs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toIfaceAT</span> <span class='hs-varid'>clas_ats</span><span class='hs-layout'>,</span>
<a name="line-636"></a>                <span class='hs-varid'>ifSigs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toIfaceClassOp</span> <span class='hs-varid'>op_stuff</span><span class='hs-layout'>,</span>
<a name="line-637"></a>                <span class='hs-varid'>ifMinDef</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>getOccFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>classMinimalDef</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span>
<a name="line-638"></a>            <span class='hs-layout'>}</span>
<a name="line-639"></a>
<a name="line-640"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_binders</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTyConBinders</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConBinders</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span>
<a name="line-641"></a>
<a name="line-642"></a>    <span class='hs-varid'>toIfaceAT</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClassATItem</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceAT</span>
<a name="line-643"></a>    <span class='hs-varid'>toIfaceAT</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATI</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>def</span><span class='hs-layout'>)</span>
<a name="line-644"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceAT</span> <span class='hs-varid'>if_decl</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyToIfaceType</span> <span class='hs-varid'>env2</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varid'>def</span><span class='hs-layout'>)</span>
<a name="line-645"></a>      <span class='hs-keyword'>where</span>
<a name="line-646"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>if_decl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConToIfaceDecl</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>tc</span>
<a name="line-647"></a>
<a name="line-648"></a>    <span class='hs-varid'>toIfaceClassOp</span> <span class='hs-layout'>(</span><span class='hs-varid'>sel_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>def_meth</span><span class='hs-layout'>)</span>
<a name="line-649"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>sel_tyvars</span> <span class='hs-varop'>==</span> <span class='hs-varid'>binderVars</span> <span class='hs-varid'>tc_binders</span> <span class='hs-layout'>)</span>
<a name="line-650"></a>          <span class='hs-conid'>IfaceClassOp</span> <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span>
<a name="line-651"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>tidyToIfaceType</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>op_ty</span><span class='hs-layout'>)</span>
<a name="line-652"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>toDmSpec</span> <span class='hs-varid'>def_meth</span><span class='hs-layout'>)</span>
<a name="line-653"></a>        <span class='hs-keyword'>where</span>
<a name="line-654"></a>                <span class='hs-comment'>-- Be careful when splitting the type, because of things</span>
<a name="line-655"></a>                <span class='hs-comment'>-- like         class Foo a where</span>
<a name="line-656"></a>                <span class='hs-comment'>--                op :: (?x :: String) =&gt; a -&gt; a</span>
<a name="line-657"></a>                <span class='hs-comment'>-- and          class Baz a where</span>
<a name="line-658"></a>                <span class='hs-comment'>--                op :: (Ord a) =&gt; a -&gt; a</span>
<a name="line-659"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>sel_tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTyCoVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span>
<a name="line-660"></a>          <span class='hs-varid'>op_ty</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funResultTy</span> <span class='hs-varid'>rho_ty</span>
<a name="line-661"></a>
<a name="line-662"></a>    <span class='hs-varid'>toDmSpec</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>DefMethSpec</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DefMethSpec</span> <span class='hs-conid'>IfaceType</span>
<a name="line-663"></a>    <span class='hs-varid'>toDmSpec</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>VanillaDM</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VanillaDM</span>
<a name="line-664"></a>    <span class='hs-varid'>toDmSpec</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>GenericDM</span> <span class='hs-varid'>dm_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GenericDM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyToIfaceType</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>dm_ty</span><span class='hs-layout'>)</span>
<a name="line-665"></a>
<a name="line-666"></a>    <span class='hs-varid'>toIfaceFD</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyTyVar</span> <span class='hs-varid'>env1</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs1</span>
<a name="line-667"></a>                             <span class='hs-layout'>,</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyTyVar</span> <span class='hs-varid'>env1</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs2</span><span class='hs-layout'>)</span>
<a name="line-668"></a>
<a name="line-669"></a><span class='hs-comment'>--------------------------</span>
<a name="line-670"></a>
<a name="line-671"></a><a name="tidyTyConBinder"></a><span class='hs-definition'>tidyTyConBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyConBinder</span><span class='hs-layout'>)</span>
<a name="line-672"></a><span class='hs-comment'>-- If the type variable "binder" is in scope, don't re-bind it</span>
<a name="line-673"></a><span class='hs-comment'>-- In a class decl, for example, the ATD binders mention</span>
<a name="line-674"></a><span class='hs-comment'>-- (amd must mention) the class tyvars</span>
<a name="line-675"></a><span class='hs-definition'>tidyTyConBinder</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvb</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span>
<a name="line-676"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-677"></a>     <span class='hs-conid'>Just</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span>  <span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv'</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span>
<a name="line-678"></a>     <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tidyTyCoVarBinder</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tvb</span>
<a name="line-679"></a>
<a name="line-680"></a><a name="tidyTyConBinders"></a><span class='hs-definition'>tidyTyConBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyConBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyConBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-681"></a><span class='hs-definition'>tidyTyConBinders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>tidyTyConBinder</span>
<a name="line-682"></a>
<a name="line-683"></a><a name="tidyTyVar"></a><span class='hs-definition'>tidyTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FastString</span>
<a name="line-684"></a><span class='hs-definition'>tidyTyVar</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-685"></a>
<a name="line-686"></a><a name="instanceToIfaceInst"></a><span class='hs-comment'>--------------------------</span>
<a name="line-687"></a><span class='hs-definition'>instanceToIfaceInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClsInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceClsInst</span>
<a name="line-688"></a><span class='hs-definition'>instanceToIfaceInst</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClsInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_dfun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dfun_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_flag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>oflag</span>
<a name="line-689"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>is_cls_nm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_cls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span>
<a name="line-690"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>is_tcs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rough_tcs</span>
<a name="line-691"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>is_orphan</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orph</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-692"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>cls_name</span> <span class='hs-varop'>==</span> <span class='hs-varid'>className</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>)</span>
<a name="line-693"></a>    <span class='hs-conid'>IfaceClsInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifDFun</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>dfun_id</span>
<a name="line-694"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ifOFlag</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>oflag</span>
<a name="line-695"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ifInstCls</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls_name</span>
<a name="line-696"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ifInstTys</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ifaceRoughMatchTcs</span> <span class='hs-varid'>rough_tcs</span>
<a name="line-697"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ifInstOrph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orph</span> <span class='hs-layout'>}</span>
<a name="line-698"></a>
<a name="line-699"></a><a name="famInstToIfaceFamInst"></a><span class='hs-comment'>--------------------------</span>
<a name="line-700"></a><span class='hs-definition'>famInstToIfaceFamInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceFamInst</span>
<a name="line-701"></a><span class='hs-definition'>famInstToIfaceFamInst</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fi_axiom</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>axiom</span><span class='hs-layout'>,</span>
<a name="line-702"></a>                                 <span class='hs-varid'>fi_fam</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam</span><span class='hs-layout'>,</span>
<a name="line-703"></a>                                 <span class='hs-varid'>fi_tcs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rough_tcs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-704"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceFamInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifFamInstAxiom</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomName</span> <span class='hs-varid'>axiom</span>
<a name="line-705"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ifFamInstFam</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam</span>
<a name="line-706"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ifFamInstTys</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ifaceRoughMatchTcs</span> <span class='hs-varid'>rough_tcs</span>
<a name="line-707"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ifFamInstOrph</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orph</span> <span class='hs-layout'>}</span>
<a name="line-708"></a>  <span class='hs-keyword'>where</span>
<a name="line-709"></a>    <span class='hs-varid'>fam_decl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coAxiomTyCon</span> <span class='hs-varid'>axiom</span>
<a name="line-710"></a>    <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isExternalName</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomName</span> <span class='hs-varid'>axiom</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-711"></a>          <span class='hs-varid'>nameModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomName</span> <span class='hs-varid'>axiom</span><span class='hs-layout'>)</span>
<a name="line-712"></a>    <span class='hs-varid'>is_local</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>name</span>
<a name="line-713"></a>
<a name="line-714"></a>    <span class='hs-varid'>lhs_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterNameSet</span> <span class='hs-varid'>is_local</span> <span class='hs-layout'>(</span><span class='hs-varid'>orphNamesOfCoCon</span> <span class='hs-varid'>axiom</span><span class='hs-layout'>)</span>
<a name="line-715"></a>
<a name="line-716"></a>    <span class='hs-varid'>orph</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_local</span> <span class='hs-varid'>fam_decl</span>
<a name="line-717"></a>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NotOrphan</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>fam_decl</span><span class='hs-layout'>)</span>
<a name="line-718"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-719"></a>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>chooseOrphanAnchor</span> <span class='hs-varid'>lhs_names</span>
<a name="line-720"></a>
<a name="line-721"></a><a name="ifaceRoughMatchTcs"></a><span class='hs-definition'>ifaceRoughMatchTcs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RoughMatchTc</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>IfaceTyCon</span><span class='hs-keyglyph'>]</span>
<a name="line-722"></a><span class='hs-definition'>ifaceRoughMatchTcs</span> <span class='hs-varid'>tcs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>do_rough</span> <span class='hs-varid'>tcs</span>
<a name="line-723"></a>  <span class='hs-keyword'>where</span>
<a name="line-724"></a>    <span class='hs-varid'>do_rough</span> <span class='hs-conid'>OtherTc</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-725"></a>    <span class='hs-varid'>do_rough</span> <span class='hs-layout'>(</span><span class='hs-conid'>KnownTc</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceTyCon_name</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-726"></a>
<a name="line-727"></a><a name="coreRuleToIfaceRule"></a><span class='hs-comment'>--------------------------</span>
<a name="line-728"></a><span class='hs-definition'>coreRuleToIfaceRule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreRule</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceRule</span>
<a name="line-729"></a><span class='hs-definition'>coreRuleToIfaceRule</span> <span class='hs-layout'>(</span><span class='hs-conid'>BuiltinRule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ru_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fn</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-730"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"toHsRule: builtin"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fn</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-731"></a>    <span class='hs-varid'>bogusIfaceRule</span> <span class='hs-varid'>fn</span>
<a name="line-732"></a>
<a name="line-733"></a><span class='hs-definition'>coreRuleToIfaceRule</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ru_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ru_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fn</span><span class='hs-layout'>,</span>
<a name="line-734"></a>                            <span class='hs-varid'>ru_act</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act</span><span class='hs-layout'>,</span> <span class='hs-varid'>ru_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span>
<a name="line-735"></a>                            <span class='hs-varid'>ru_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>ru_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span>
<a name="line-736"></a>                            <span class='hs-varid'>ru_orphan</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orph</span><span class='hs-layout'>,</span> <span class='hs-varid'>ru_auto</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>auto</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-737"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceRule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifRuleName</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ifActivation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act</span><span class='hs-layout'>,</span>
<a name="line-738"></a>                <span class='hs-varid'>ifRuleBndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toIfaceBndr</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span>
<a name="line-739"></a>                <span class='hs-varid'>ifRuleHead</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fn</span><span class='hs-layout'>,</span>
<a name="line-740"></a>                <span class='hs-varid'>ifRuleArgs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>do_arg</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span>
<a name="line-741"></a>                <span class='hs-varid'>ifRuleRhs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceExpr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span>
<a name="line-742"></a>                <span class='hs-varid'>ifRuleAuto</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>auto</span><span class='hs-layout'>,</span>
<a name="line-743"></a>                <span class='hs-varid'>ifRuleOrph</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orph</span> <span class='hs-layout'>}</span>
<a name="line-744"></a>  <span class='hs-keyword'>where</span>
<a name="line-745"></a>        <span class='hs-comment'>-- For type args we must remove synonyms from the outermost</span>
<a name="line-746"></a>        <span class='hs-comment'>-- level.  Reason: so that when we read it back in we'll</span>
<a name="line-747"></a>        <span class='hs-comment'>-- construct the same ru_rough field as we have right now;</span>
<a name="line-748"></a>        <span class='hs-comment'>-- see tcIfaceRule</span>
<a name="line-749"></a>    <span class='hs-varid'>do_arg</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceType</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceType</span> <span class='hs-layout'>(</span><span class='hs-varid'>deNoteType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-750"></a>    <span class='hs-varid'>do_arg</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceCo</span>   <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-751"></a>    <span class='hs-varid'>do_arg</span> <span class='hs-varid'>arg</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceExpr</span> <span class='hs-varid'>arg</span>
<a name="line-752"></a>
<a name="line-753"></a><a name="bogusIfaceRule"></a><span class='hs-definition'>bogusIfaceRule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceRule</span>
<a name="line-754"></a><span class='hs-definition'>bogusIfaceRule</span> <span class='hs-varid'>id_name</span>
<a name="line-755"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceRule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifRuleName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fsLit</span> <span class='hs-str'>"bogus"</span><span class='hs-layout'>,</span> <span class='hs-varid'>ifActivation</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NeverActive</span><span class='hs-layout'>,</span>
<a name="line-756"></a>        <span class='hs-varid'>ifRuleBndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>ifRuleHead</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ifRuleArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-757"></a>        <span class='hs-varid'>ifRuleRhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceExt</span> <span class='hs-varid'>id_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ifRuleOrph</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IsOrphan</span><span class='hs-layout'>,</span>
<a name="line-758"></a>        <span class='hs-varid'>ifRuleAuto</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span>
</pre></body>
</html>
