<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/SysTools/Info.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables #-}</span>
<a name="line-2"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-3"></a><span class='hs-comment'>--</span>
<a name="line-4"></a><span class='hs-comment'>-- Compiler information functions</span>
<a name="line-5"></a><span class='hs-comment'>--</span>
<a name="line-6"></a><span class='hs-comment'>-- (c) The GHC Team 2017</span>
<a name="line-7"></a><span class='hs-comment'>--</span>
<a name="line-8"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-9"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.SysTools.Info</span> <span class='hs-keyword'>where</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Exception</span>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Error</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Session</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Logger</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List</span> <span class='hs-layout'>(</span> <span class='hs-varid'>isInfixOf</span><span class='hs-layout'>,</span> <span class='hs-varid'>isPrefixOf</span> <span class='hs-layout'>)</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.IORef</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.IO</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Platform</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.SysTools.Process</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-comment'>{- Note [Run-time linker info]
<a name="line-29"></a>
<a name="line-30"></a>See also: #5240, #6063, #10110
<a name="line-31"></a>
<a name="line-32"></a>Before 'runLink', we need to be sure to get the relevant information
<a name="line-33"></a>about the linker we're using at runtime to see if we need any extra
<a name="line-34"></a>options. For example, GNU ld requires '--reduce-memory-overheads' and
<a name="line-35"></a>'--hash-size=31' in order to use reasonable amounts of memory (see
<a name="line-36"></a>trac #5240.) But this isn't supported in GNU gold.
<a name="line-37"></a>
<a name="line-38"></a>Generally, the linker changing from what was detected at ./configure
<a name="line-39"></a>time has always been possible using -pgml, but on Linux it can happen
<a name="line-40"></a>'transparently' by installing packages like binutils-gold, which
<a name="line-41"></a>change what /usr/bin/ld actually points to.
<a name="line-42"></a>
<a name="line-43"></a>Clang vs GCC notes:
<a name="line-44"></a>
<a name="line-45"></a>For gcc, 'gcc -Wl,--version' gives a bunch of output about how to
<a name="line-46"></a>invoke the linker before the version information string. For 'clang',
<a name="line-47"></a>the version information for 'ld' is all that's output. For this
<a name="line-48"></a>reason, we typically need to slurp up all of the standard error output
<a name="line-49"></a>and look through it.
<a name="line-50"></a>
<a name="line-51"></a>Other notes:
<a name="line-52"></a>
<a name="line-53"></a>We cache the LinkerInfo inside DynFlags, since clients may link
<a name="line-54"></a>multiple times. The definition of LinkerInfo is there to avoid a
<a name="line-55"></a>circular dependency.
<a name="line-56"></a>
<a name="line-57"></a>-}</span>
<a name="line-58"></a>
<a name="line-59"></a><span class='hs-comment'>{- Note [ELF needed shared libs]
<a name="line-60"></a>
<a name="line-61"></a>Some distributions change the link editor's default handling of
<a name="line-62"></a>ELF DT_NEEDED tags to include only those shared objects that are
<a name="line-63"></a>needed to resolve undefined symbols. For Template Haskell we need
<a name="line-64"></a>the last temporary shared library also if it is not needed for the
<a name="line-65"></a>currently linked temporary shared library. We specify --no-as-needed
<a name="line-66"></a>to override the default. This flag exists in GNU ld and GNU gold.
<a name="line-67"></a>
<a name="line-68"></a>The flag is only needed on ELF systems. On Windows (PE) and Mac OS X
<a name="line-69"></a>(Mach-O) the flag is not needed.
<a name="line-70"></a>
<a name="line-71"></a>-}</span>
<a name="line-72"></a>
<a name="line-73"></a><span class='hs-comment'>{- Note [Windows static libGCC]
<a name="line-74"></a>
<a name="line-75"></a>The GCC versions being upgraded to in #10726 are configured with
<a name="line-76"></a>dynamic linking of libgcc supported. This results in libgcc being
<a name="line-77"></a>linked dynamically when a shared library is created.
<a name="line-78"></a>
<a name="line-79"></a>This introduces thus an extra dependency on GCC dll that was not
<a name="line-80"></a>needed before by shared libraries created with GHC. This is a particular
<a name="line-81"></a>issue on Windows because you get a non-obvious error due to this missing
<a name="line-82"></a>dependency. This dependent dll is also not commonly on your path.
<a name="line-83"></a>
<a name="line-84"></a>For this reason using the static libgcc is preferred as it preserves
<a name="line-85"></a>the same behaviour that existed before. There are however some very good
<a name="line-86"></a>reasons to have the shared version as well as described on page 181 of
<a name="line-87"></a>https://gcc.gnu.org/onlinedocs/gcc-5.2.0/gcc.pdf :
<a name="line-88"></a>
<a name="line-89"></a>"There are several situations in which an application should use the
<a name="line-90"></a> shared ‘libgcc’ instead of the static version. The most common of these
<a name="line-91"></a> is when the application wishes to throw and catch exceptions across different
<a name="line-92"></a> shared libraries. In that case, each of the libraries as well as the application
<a name="line-93"></a> itself should use the shared ‘libgcc’. "
<a name="line-94"></a>
<a name="line-95"></a>-}</span>
<a name="line-96"></a>
<a name="line-97"></a><a name="neededLinkArgs"></a><span class='hs-definition'>neededLinkArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LinkerInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span>
<a name="line-98"></a><span class='hs-definition'>neededLinkArgs</span> <span class='hs-layout'>(</span><span class='hs-conid'>GnuLD</span> <span class='hs-varid'>o</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o</span>
<a name="line-99"></a><span class='hs-definition'>neededLinkArgs</span> <span class='hs-layout'>(</span><span class='hs-conid'>GnuGold</span> <span class='hs-varid'>o</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o</span>
<a name="line-100"></a><span class='hs-definition'>neededLinkArgs</span> <span class='hs-layout'>(</span><span class='hs-conid'>LlvmLLD</span> <span class='hs-varid'>o</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o</span>
<a name="line-101"></a><span class='hs-definition'>neededLinkArgs</span> <span class='hs-layout'>(</span><span class='hs-conid'>DarwinLD</span> <span class='hs-varid'>o</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o</span>
<a name="line-102"></a><span class='hs-definition'>neededLinkArgs</span> <span class='hs-layout'>(</span><span class='hs-conid'>SolarisLD</span> <span class='hs-varid'>o</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o</span>
<a name="line-103"></a><span class='hs-definition'>neededLinkArgs</span> <span class='hs-layout'>(</span><span class='hs-conid'>AixLD</span> <span class='hs-varid'>o</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o</span>
<a name="line-104"></a><span class='hs-definition'>neededLinkArgs</span> <span class='hs-conid'>UnknownLD</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-105"></a>
<a name="line-106"></a><a name="getLinkerInfo"></a><span class='hs-comment'>-- Grab linker info and cache it in DynFlags.</span>
<a name="line-107"></a><span class='hs-definition'>getLinkerInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Logger</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>LinkerInfo</span>
<a name="line-108"></a><span class='hs-definition'>getLinkerInfo</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-109"></a>  <span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>rtldInfo</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-110"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>info</span> <span class='hs-keyword'>of</span>
<a name="line-111"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>v</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-112"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-113"></a>      <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLinkerInfo'</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span>
<a name="line-114"></a>      <span class='hs-varid'>writeIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>rtldInfo</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-115"></a>      <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-116"></a>
<a name="line-117"></a><a name="getLinkerInfo'"></a><span class='hs-comment'>-- See Note [Run-time linker info].</span>
<a name="line-118"></a><span class='hs-definition'>getLinkerInfo'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Logger</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>LinkerInfo</span>
<a name="line-119"></a><span class='hs-definition'>getLinkerInfo'</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-120"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-121"></a>      <span class='hs-varid'>os</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>platformOS</span> <span class='hs-varid'>platform</span>
<a name="line-122"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>pgm</span><span class='hs-layout'>,</span><span class='hs-varid'>args0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_l</span> <span class='hs-varid'>dflags</span>
<a name="line-123"></a>      <span class='hs-varid'>args1</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_l</span><span class='hs-layout'>)</span>
<a name="line-124"></a>      <span class='hs-varid'>args2</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args0</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args1</span>
<a name="line-125"></a>      <span class='hs-varid'>args3</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>notNull</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>showOpt</span> <span class='hs-varid'>args2</span><span class='hs-layout'>)</span>
<a name="line-126"></a>
<a name="line-127"></a>      <span class='hs-comment'>-- Try to grab the info from the process output.</span>
<a name="line-128"></a>      <span class='hs-varid'>parseLinkerInfo</span> <span class='hs-varid'>stdo</span> <span class='hs-sel'>_stde</span> <span class='hs-sel'>_exitc</span>
<a name="line-129"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-str'>"GNU ld"</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>stdo</span> <span class='hs-keyglyph'>=</span>
<a name="line-130"></a>          <span class='hs-comment'>-- GNU ld specifically needs to use less memory. This especially</span>
<a name="line-131"></a>          <span class='hs-comment'>-- hurts on small object files. #5240.</span>
<a name="line-132"></a>          <span class='hs-comment'>-- Set DT_NEEDED for all shared libraries. #10110.</span>
<a name="line-133"></a>          <span class='hs-comment'>-- TODO: Investigate if these help or hurt when using split sections.</span>
<a name="line-134"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>GnuLD</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"-Wl,--hash-size=31"</span><span class='hs-layout'>,</span>
<a name="line-135"></a>                                      <span class='hs-str'>"-Wl,--reduce-memory-overheads"</span><span class='hs-layout'>,</span>
<a name="line-136"></a>                                      <span class='hs-comment'>-- ELF specific flag</span>
<a name="line-137"></a>                                      <span class='hs-comment'>-- see Note [ELF needed shared libs]</span>
<a name="line-138"></a>                                      <span class='hs-str'>"-Wl,--no-as-needed"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-139"></a>
<a name="line-140"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-str'>"GNU gold"</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>stdo</span> <span class='hs-keyglyph'>=</span>
<a name="line-141"></a>          <span class='hs-comment'>-- GNU gold only needs --no-as-needed. #10110.</span>
<a name="line-142"></a>          <span class='hs-comment'>-- ELF specific flag, see Note [ELF needed shared libs]</span>
<a name="line-143"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>GnuGold</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span> <span class='hs-str'>"-Wl,--no-as-needed"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-144"></a>
<a name="line-145"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>line</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"LLD"</span> <span class='hs-varop'>`isPrefixOf`</span> <span class='hs-varid'>line</span> <span class='hs-varop'>||</span> <span class='hs-str'>"LLD"</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>words</span> <span class='hs-varid'>line</span><span class='hs-layout'>)</span> <span class='hs-varid'>stdo</span> <span class='hs-keyglyph'>=</span>
<a name="line-146"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>LlvmLLD</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-keyglyph'>[</span> <span class='hs-comment'>--see Note [ELF needed shared libs]</span>
<a name="line-147"></a>                                        <span class='hs-str'>"-Wl,--no-as-needed"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-148"></a>
<a name="line-149"></a>         <span class='hs-comment'>-- Unknown linker.</span>
<a name="line-150"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fail</span> <span class='hs-str'>"invalid --version output, or linker is unsupported"</span>
<a name="line-151"></a>
<a name="line-152"></a>  <span class='hs-comment'>-- Process the executable call</span>
<a name="line-153"></a>  <span class='hs-varid'>catchIO</span> <span class='hs-layout'>(</span>
<a name="line-154"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>os</span> <span class='hs-keyword'>of</span>
<a name="line-155"></a>      <span class='hs-conid'>OSSolaris2</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-156"></a>        <span class='hs-comment'>-- Solaris uses its own Solaris linker. Even all</span>
<a name="line-157"></a>        <span class='hs-comment'>-- GNU C are recommended to configure with Solaris</span>
<a name="line-158"></a>        <span class='hs-comment'>-- linker instead of using GNU binutils linker. Also</span>
<a name="line-159"></a>        <span class='hs-comment'>-- all GCC distributed with Solaris follows this rule</span>
<a name="line-160"></a>        <span class='hs-comment'>-- precisely so we assume here, the Solaris linker is</span>
<a name="line-161"></a>        <span class='hs-comment'>-- used.</span>
<a name="line-162"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>SolarisLD</span> <span class='hs-conid'>[]</span>
<a name="line-163"></a>      <span class='hs-conid'>OSAIX</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-164"></a>        <span class='hs-comment'>-- IBM AIX uses its own non-binutils linker as well</span>
<a name="line-165"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>AixLD</span> <span class='hs-conid'>[]</span>
<a name="line-166"></a>      <span class='hs-conid'>OSDarwin</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-167"></a>        <span class='hs-comment'>-- Darwin has neither GNU Gold or GNU LD, but a strange linker</span>
<a name="line-168"></a>        <span class='hs-comment'>-- that doesn't support --version. We can just assume that's</span>
<a name="line-169"></a>        <span class='hs-comment'>-- what we're using.</span>
<a name="line-170"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DarwinLD</span> <span class='hs-conid'>[]</span>
<a name="line-171"></a>      <span class='hs-conid'>OSMinGW32</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-172"></a>        <span class='hs-comment'>-- GHC doesn't support anything but GNU ld on Windows anyway.</span>
<a name="line-173"></a>        <span class='hs-comment'>-- Process creation is also fairly expensive on win32, so</span>
<a name="line-174"></a>        <span class='hs-comment'>-- we short-circuit here.</span>
<a name="line-175"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>GnuLD</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span>
<a name="line-176"></a>          <span class='hs-keyglyph'>[</span> <span class='hs-comment'>-- Reduce ld memory usage</span>
<a name="line-177"></a>            <span class='hs-str'>"-Wl,--hash-size=31"</span>
<a name="line-178"></a>          <span class='hs-layout'>,</span> <span class='hs-str'>"-Wl,--reduce-memory-overheads"</span>
<a name="line-179"></a>            <span class='hs-comment'>-- Emit gcc stack checks</span>
<a name="line-180"></a>            <span class='hs-comment'>-- Note [Windows stack usage]</span>
<a name="line-181"></a>          <span class='hs-layout'>,</span> <span class='hs-str'>"-fstack-check"</span>
<a name="line-182"></a>            <span class='hs-comment'>-- Force static linking of libGCC</span>
<a name="line-183"></a>            <span class='hs-comment'>-- Note [Windows static libGCC]</span>
<a name="line-184"></a>          <span class='hs-layout'>,</span> <span class='hs-str'>"-static-libgcc"</span> <span class='hs-keyglyph'>]</span>
<a name="line-185"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-186"></a>        <span class='hs-comment'>-- In practice, we use the compiler as the linker here. Pass</span>
<a name="line-187"></a>        <span class='hs-comment'>-- -Wl,--version to get linker version info.</span>
<a name="line-188"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>exitc</span><span class='hs-layout'>,</span> <span class='hs-varid'>stdo</span><span class='hs-layout'>,</span> <span class='hs-varid'>stde</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readProcessEnvWithExitCode</span> <span class='hs-varid'>pgm</span>
<a name="line-189"></a>                               <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-str'>"-Wl,--version"</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args3</span><span class='hs-layout'>)</span>
<a name="line-190"></a>                               <span class='hs-varid'>c_locale_env</span>
<a name="line-191"></a>        <span class='hs-comment'>-- Split the output by lines to make certain kinds</span>
<a name="line-192"></a>        <span class='hs-comment'>-- of processing easier. In particular, 'clang' and 'gcc'</span>
<a name="line-193"></a>        <span class='hs-comment'>-- have slightly different outputs for '-Wl,--version', but</span>
<a name="line-194"></a>        <span class='hs-comment'>-- it's still easy to figure out.</span>
<a name="line-195"></a>        <span class='hs-varid'>parseLinkerInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>lines</span> <span class='hs-varid'>stdo</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lines</span> <span class='hs-varid'>stde</span><span class='hs-layout'>)</span> <span class='hs-varid'>exitc</span>
<a name="line-196"></a>    <span class='hs-layout'>)</span>
<a name="line-197"></a>    <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-198"></a>        <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span>
<a name="line-199"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Error (figuring out linker information):"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-200"></a>             <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-201"></a>        <span class='hs-varid'>errorMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Warning:"</span><span class='hs-layout'>)</span> <span class='hs-num'>9</span> <span class='hs-varop'>$</span>
<a name="line-202"></a>          <span class='hs-varid'>text</span> <span class='hs-str'>"Couldn't figure out linker information!"</span> <span class='hs-varop'>$$</span>
<a name="line-203"></a>          <span class='hs-varid'>text</span> <span class='hs-str'>"Make sure you're using GNU ld, GNU gold"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-204"></a>          <span class='hs-varid'>text</span> <span class='hs-str'>"or the built in OS X linker, etc."</span>
<a name="line-205"></a>        <span class='hs-varid'>return</span> <span class='hs-conid'>UnknownLD</span>
<a name="line-206"></a>    <span class='hs-layout'>)</span>
<a name="line-207"></a>
<a name="line-208"></a><a name="getCompilerInfo"></a><span class='hs-comment'>-- Grab compiler info and cache it in DynFlags.</span>
<a name="line-209"></a><span class='hs-definition'>getCompilerInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Logger</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CompilerInfo</span>
<a name="line-210"></a><span class='hs-definition'>getCompilerInfo</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-211"></a>  <span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>rtccInfo</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-212"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>info</span> <span class='hs-keyword'>of</span>
<a name="line-213"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>v</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-214"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-215"></a>      <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCompilerInfo'</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span>
<a name="line-216"></a>      <span class='hs-varid'>writeIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>rtccInfo</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-217"></a>      <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-218"></a>
<a name="line-219"></a><a name="getCompilerInfo'"></a><span class='hs-comment'>-- See Note [Run-time linker info].</span>
<a name="line-220"></a><span class='hs-definition'>getCompilerInfo'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Logger</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CompilerInfo</span>
<a name="line-221"></a><span class='hs-definition'>getCompilerInfo'</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-222"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>pgm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_c</span> <span class='hs-varid'>dflags</span>
<a name="line-223"></a>      <span class='hs-comment'>-- Try to grab the info from the process output.</span>
<a name="line-224"></a>      <span class='hs-varid'>parseCompilerInfo</span> <span class='hs-sel'>_stdo</span> <span class='hs-varid'>stde</span> <span class='hs-sel'>_exitc</span>
<a name="line-225"></a>        <span class='hs-comment'>-- Regular GCC</span>
<a name="line-226"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-str'>"gcc version"</span> <span class='hs-varop'>`isInfixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>stde</span> <span class='hs-keyglyph'>=</span>
<a name="line-227"></a>          <span class='hs-varid'>return</span> <span class='hs-conid'>GCC</span>
<a name="line-228"></a>        <span class='hs-comment'>-- Regular clang</span>
<a name="line-229"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-str'>"clang version"</span> <span class='hs-varop'>`isInfixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>stde</span> <span class='hs-keyglyph'>=</span>
<a name="line-230"></a>          <span class='hs-varid'>return</span> <span class='hs-conid'>Clang</span>
<a name="line-231"></a>        <span class='hs-comment'>-- FreeBSD clang</span>
<a name="line-232"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-str'>"FreeBSD clang version"</span> <span class='hs-varop'>`isInfixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>stde</span> <span class='hs-keyglyph'>=</span>
<a name="line-233"></a>          <span class='hs-varid'>return</span> <span class='hs-conid'>Clang</span>
<a name="line-234"></a>        <span class='hs-comment'>-- Xcode 5.1 clang</span>
<a name="line-235"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-str'>"Apple LLVM version 5.1"</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>stde</span> <span class='hs-keyglyph'>=</span>
<a name="line-236"></a>          <span class='hs-varid'>return</span> <span class='hs-conid'>AppleClang51</span>
<a name="line-237"></a>        <span class='hs-comment'>-- Xcode 5 clang</span>
<a name="line-238"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-str'>"Apple LLVM version"</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>stde</span> <span class='hs-keyglyph'>=</span>
<a name="line-239"></a>          <span class='hs-varid'>return</span> <span class='hs-conid'>AppleClang</span>
<a name="line-240"></a>        <span class='hs-comment'>-- Xcode 4.1 clang</span>
<a name="line-241"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-str'>"Apple clang version"</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>stde</span> <span class='hs-keyglyph'>=</span>
<a name="line-242"></a>          <span class='hs-varid'>return</span> <span class='hs-conid'>AppleClang</span>
<a name="line-243"></a>         <span class='hs-comment'>-- Unknown linker.</span>
<a name="line-244"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fail</span> <span class='hs-varop'>$</span> <span class='hs-str'>"invalid -v output, or compiler is unsupported: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>unlines</span> <span class='hs-varid'>stde</span>
<a name="line-245"></a>
<a name="line-246"></a>  <span class='hs-comment'>-- Process the executable call</span>
<a name="line-247"></a>  <span class='hs-varid'>catchIO</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span>
<a name="line-248"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>exitc</span><span class='hs-layout'>,</span> <span class='hs-varid'>stdo</span><span class='hs-layout'>,</span> <span class='hs-varid'>stde</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-249"></a>          <span class='hs-varid'>readProcessEnvWithExitCode</span> <span class='hs-varid'>pgm</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"-v"</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>c_locale_env</span>
<a name="line-250"></a>      <span class='hs-comment'>-- Split the output by lines to make certain kinds</span>
<a name="line-251"></a>      <span class='hs-comment'>-- of processing easier.</span>
<a name="line-252"></a>      <span class='hs-varid'>parseCompilerInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>lines</span> <span class='hs-varid'>stdo</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lines</span> <span class='hs-varid'>stde</span><span class='hs-layout'>)</span> <span class='hs-varid'>exitc</span>
<a name="line-253"></a>      <span class='hs-layout'>)</span>
<a name="line-254"></a>      <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-255"></a>          <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span>
<a name="line-256"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Error (figuring out C compiler information):"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-257"></a>               <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-258"></a>          <span class='hs-varid'>errorMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Warning:"</span><span class='hs-layout'>)</span> <span class='hs-num'>9</span> <span class='hs-varop'>$</span>
<a name="line-259"></a>            <span class='hs-varid'>text</span> <span class='hs-str'>"Couldn't figure out C compiler information!"</span> <span class='hs-varop'>$$</span>
<a name="line-260"></a>            <span class='hs-varid'>text</span> <span class='hs-str'>"Make sure you're using GNU gcc, or clang"</span>
<a name="line-261"></a>          <span class='hs-varid'>return</span> <span class='hs-conid'>UnknownCC</span>
<a name="line-262"></a>      <span class='hs-layout'>)</span>
</pre></body>
</html>
