<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Unit/Env.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Unit.Env</span>
<a name="line-2"></a>    <span class='hs-layout'>(</span> <span class='hs-conid'>UnitEnv</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-3"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>preloadUnitsInfo</span>
<a name="line-4"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>preloadUnitsInfo'</span>
<a name="line-5"></a>    <span class='hs-layout'>)</span>
<a name="line-6"></a><span class='hs-keyword'>where</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.State</span>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Home</span>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Types</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Platform</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Settings</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Maybe</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="UnitEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>UnitEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnitEnv</span>
<a name="line-19"></a>    <span class='hs-layout'>{</span> <span class='hs-varid'>ue_units</span>     <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>UnitState</span>      <span class='hs-comment'>-- ^ Units</span>
<a name="line-20"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>ue_home_unit</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>HomeUnit</span>       <span class='hs-comment'>-- ^ Home unit</span>
<a name="line-21"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>ue_platform</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>Platform</span>       <span class='hs-comment'>-- ^ Platform</span>
<a name="line-22"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>ue_namever</span>   <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>GhcNameVersion</span> <span class='hs-comment'>-- ^ GHC name/version (used for dynamic library suffix)</span>
<a name="line-23"></a>    <span class='hs-layout'>}</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-26"></a><span class='hs-comment'>-- Extracting information from the packages in scope</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-comment'>-- Many of these functions take a list of packages: in those cases,</span>
<a name="line-29"></a><span class='hs-comment'>-- the list is expected to contain the "dependent packages",</span>
<a name="line-30"></a><span class='hs-comment'>-- i.e. those packages that were found to be depended on by the</span>
<a name="line-31"></a><span class='hs-comment'>-- current module/program.  These can be auto or non-auto packages, it</span>
<a name="line-32"></a><span class='hs-comment'>-- doesn't really matter.  The list is always combined with the list</span>
<a name="line-33"></a><span class='hs-comment'>-- of preload (command-line) packages to determine which packages to</span>
<a name="line-34"></a><span class='hs-comment'>-- use.</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="preloadUnitsInfo'"></a><span class='hs-comment'>-- | Lookup 'UnitInfo' for every preload unit from the UnitState, for every unit</span>
<a name="line-37"></a><span class='hs-comment'>-- used to instantiate the home unit, and for every unit explicitly passed in</span>
<a name="line-38"></a><span class='hs-comment'>-- the given list of UnitId.</span>
<a name="line-39"></a><span class='hs-definition'>preloadUnitsInfo'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnitEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UnitId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeErr</span> <span class='hs-conid'>UnitErr</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UnitInfo</span><span class='hs-keyglyph'>]</span>
<a name="line-40"></a><span class='hs-definition'>preloadUnitsInfo'</span> <span class='hs-varid'>unit_env</span> <span class='hs-varid'>ids0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all_infos</span>
<a name="line-41"></a>  <span class='hs-keyword'>where</span>
<a name="line-42"></a>    <span class='hs-varid'>home_unit</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ue_home_unit</span> <span class='hs-varid'>unit_env</span>
<a name="line-43"></a>    <span class='hs-varid'>unit_state</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ue_units</span>     <span class='hs-varid'>unit_env</span>
<a name="line-44"></a>    <span class='hs-varid'>ids</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ids0</span> <span class='hs-varop'>++</span> <span class='hs-varid'>inst_ids</span>
<a name="line-45"></a>    <span class='hs-varid'>inst_ids</span>
<a name="line-46"></a>       <span class='hs-comment'>-- An indefinite package will have insts to HOLE,</span>
<a name="line-47"></a>       <span class='hs-comment'>-- which is not a real package. Don't look it up.</span>
<a name="line-48"></a>       <span class='hs-comment'>-- Fixes #14525</span>
<a name="line-49"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isHomeUnitIndefinite</span> <span class='hs-varid'>home_unit</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-50"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>toUnitId</span> <span class='hs-varop'>.</span> <span class='hs-varid'>moduleUnit</span> <span class='hs-varop'>.</span> <span class='hs-varid'>snd</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>homeUnitInstantiations</span> <span class='hs-varid'>home_unit</span><span class='hs-layout'>)</span>
<a name="line-51"></a>    <span class='hs-varid'>pkg_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitInfoMap</span> <span class='hs-varid'>unit_state</span>
<a name="line-52"></a>    <span class='hs-varid'>preload</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>preloadUnits</span> <span class='hs-varid'>unit_state</span>
<a name="line-53"></a>
<a name="line-54"></a>    <span class='hs-varid'>all_pkgs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closeUnitDeps'</span> <span class='hs-varid'>pkg_map</span> <span class='hs-varid'>preload</span> <span class='hs-layout'>(</span><span class='hs-varid'>ids</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>repeat</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-55"></a>    <span class='hs-varid'>all_infos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsafeLookupUnitId</span> <span class='hs-varid'>unit_state</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>all_pkgs</span>
<a name="line-56"></a>
<a name="line-57"></a>
<a name="line-58"></a><a name="preloadUnitsInfo"></a><span class='hs-comment'>-- | Lookup 'UnitInfo' for every preload unit from the UnitState and for every</span>
<a name="line-59"></a><span class='hs-comment'>-- unit used to instantiate the home unit.</span>
<a name="line-60"></a><span class='hs-definition'>preloadUnitsInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnitEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeErr</span> <span class='hs-conid'>UnitErr</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UnitInfo</span><span class='hs-keyglyph'>]</span>
<a name="line-61"></a><span class='hs-definition'>preloadUnitsInfo</span> <span class='hs-varid'>unit_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>preloadUnitsInfo'</span> <span class='hs-varid'>unit_env</span> <span class='hs-conid'>[]</span>
</pre></body>
</html>
