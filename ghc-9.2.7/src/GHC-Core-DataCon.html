<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Core/DataCon.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The University of Glasgow 2006
<a name="line-3"></a>(c) The GRASP/AQUA Project, Glasgow University, 1998
<a name="line-4"></a>
<a name="line-5"></a>\section[DataCon]{@DataCon@: Data Constructors}
<a name="line-6"></a>-}</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-comment'>{-# LANGUAGE CPP, DeriveDataTypeable #-}</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Core.DataCon</span> <span class='hs-layout'>(</span>
<a name="line-11"></a>        <span class='hs-comment'>-- * Main data types</span>
<a name="line-12"></a>        <span class='hs-conid'>DataCon</span><span class='hs-layout'>,</span> <span class='hs-conid'>DataConRep</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-13"></a>        <span class='hs-conid'>SrcStrictness</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>SrcUnpackedness</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-14"></a>        <span class='hs-conid'>HsSrcBang</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsImplBang</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-15"></a>        <span class='hs-conid'>StrictnessMark</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-16"></a>        <span class='hs-conid'>ConTag</span><span class='hs-layout'>,</span>
<a name="line-17"></a>
<a name="line-18"></a>        <span class='hs-comment'>-- ** Equality specs</span>
<a name="line-19"></a>        <span class='hs-conid'>EqSpec</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkEqSpec</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqSpecTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqSpecType</span><span class='hs-layout'>,</span>
<a name="line-20"></a>        <span class='hs-varid'>eqSpecPair</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqSpecPreds</span><span class='hs-layout'>,</span>
<a name="line-21"></a>        <span class='hs-varid'>substEqSpec</span><span class='hs-layout'>,</span> <span class='hs-varid'>filterEqSpec</span><span class='hs-layout'>,</span>
<a name="line-22"></a>
<a name="line-23"></a>        <span class='hs-comment'>-- ** Field labels</span>
<a name="line-24"></a>        <span class='hs-conid'>FieldLabel</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FieldLabelString</span><span class='hs-layout'>,</span>
<a name="line-25"></a>
<a name="line-26"></a>        <span class='hs-comment'>-- ** Type construction</span>
<a name="line-27"></a>        <span class='hs-varid'>mkDataCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>fIRST_TAG</span><span class='hs-layout'>,</span>
<a name="line-28"></a>
<a name="line-29"></a>        <span class='hs-comment'>-- ** Type deconstruction</span>
<a name="line-30"></a>        <span class='hs-varid'>dataConRepType</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConInstSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConFullSig</span><span class='hs-layout'>,</span>
<a name="line-31"></a>        <span class='hs-varid'>dataConName</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConIdentity</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConTag</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConTagZ</span><span class='hs-layout'>,</span>
<a name="line-32"></a>        <span class='hs-varid'>dataConTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConOrigTyCon</span><span class='hs-layout'>,</span>
<a name="line-33"></a>        <span class='hs-varid'>dataConWrapperType</span><span class='hs-layout'>,</span>
<a name="line-34"></a>        <span class='hs-varid'>dataConNonlinearType</span><span class='hs-layout'>,</span>
<a name="line-35"></a>        <span class='hs-varid'>dataConDisplayType</span><span class='hs-layout'>,</span>
<a name="line-36"></a>        <span class='hs-varid'>dataConUnivTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConExTyCoVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConUnivAndExTyCoVars</span><span class='hs-layout'>,</span>
<a name="line-37"></a>        <span class='hs-varid'>dataConUserTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConUserTyVarBinders</span><span class='hs-layout'>,</span>
<a name="line-38"></a>        <span class='hs-varid'>dataConEqSpec</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConTheta</span><span class='hs-layout'>,</span>
<a name="line-39"></a>        <span class='hs-varid'>dataConStupidTheta</span><span class='hs-layout'>,</span>
<a name="line-40"></a>        <span class='hs-varid'>dataConOtherTheta</span><span class='hs-layout'>,</span>
<a name="line-41"></a>        <span class='hs-varid'>dataConInstArgTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConOrigArgTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConOrigResTy</span><span class='hs-layout'>,</span>
<a name="line-42"></a>        <span class='hs-varid'>dataConInstOrigArgTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConRepArgTys</span><span class='hs-layout'>,</span>
<a name="line-43"></a>        <span class='hs-varid'>dataConFieldLabels</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConFieldType</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConFieldType_maybe</span><span class='hs-layout'>,</span>
<a name="line-44"></a>        <span class='hs-varid'>dataConSrcBangs</span><span class='hs-layout'>,</span>
<a name="line-45"></a>        <span class='hs-varid'>dataConSourceArity</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConRepArity</span><span class='hs-layout'>,</span>
<a name="line-46"></a>        <span class='hs-varid'>dataConIsInfix</span><span class='hs-layout'>,</span>
<a name="line-47"></a>        <span class='hs-varid'>dataConWorkId</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConWrapId</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConWrapId_maybe</span><span class='hs-layout'>,</span>
<a name="line-48"></a>        <span class='hs-varid'>dataConImplicitTyThings</span><span class='hs-layout'>,</span>
<a name="line-49"></a>        <span class='hs-varid'>dataConRepStrictness</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConImplBangs</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConBoxer</span><span class='hs-layout'>,</span>
<a name="line-50"></a>
<a name="line-51"></a>        <span class='hs-varid'>splitDataProductType_maybe</span><span class='hs-layout'>,</span>
<a name="line-52"></a>
<a name="line-53"></a>        <span class='hs-comment'>-- ** Predicates on DataCons</span>
<a name="line-54"></a>        <span class='hs-varid'>isNullarySrcDataCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>isNullaryRepDataCon</span><span class='hs-layout'>,</span>
<a name="line-55"></a>        <span class='hs-varid'>isTupleDataCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>isBoxedTupleDataCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>isUnboxedTupleDataCon</span><span class='hs-layout'>,</span>
<a name="line-56"></a>        <span class='hs-varid'>isUnboxedSumDataCon</span><span class='hs-layout'>,</span>
<a name="line-57"></a>        <span class='hs-varid'>isVanillaDataCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>isNewDataCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>classDataCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConCannotMatch</span><span class='hs-layout'>,</span>
<a name="line-58"></a>        <span class='hs-varid'>dataConUserTyVarsArePermuted</span><span class='hs-layout'>,</span>
<a name="line-59"></a>        <span class='hs-varid'>isBanged</span><span class='hs-layout'>,</span> <span class='hs-varid'>isMarkedStrict</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqHsBang</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSrcStrict</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSrcUnpacked</span><span class='hs-layout'>,</span>
<a name="line-60"></a>        <span class='hs-varid'>specialPromotedDc</span><span class='hs-layout'>,</span>
<a name="line-61"></a>
<a name="line-62"></a>        <span class='hs-comment'>-- ** Promotion related functions</span>
<a name="line-63"></a>        <span class='hs-varid'>promoteDataCon</span>
<a name="line-64"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-65"></a>
<a name="line-66"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-67"></a>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-69"></a>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>GHC.Types.Id.Make</span> <span class='hs-layout'>(</span> <span class='hs-conid'>DataConBoxer</span> <span class='hs-layout'>)</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Type</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Type</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Coercion</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Unify</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCon</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Multiplicity</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>GHC.Types.TyThing</span>
<a name="line-77"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.FieldLabel</span>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SourceText</span>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Class</span>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name</span>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Names</span>
<a name="line-82"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Predicate</span>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var</span>
<a name="line-84"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Basic</span>
<a name="line-85"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.FastString</span>
<a name="line-86"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Types</span>
<a name="line-87"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.Name</span>
<a name="line-88"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Binary</span>
<a name="line-89"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.Set</span>
<a name="line-90"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Uniques</span><span class='hs-layout'>(</span> <span class='hs-varid'>mkAlphaTyVarUnique</span> <span class='hs-layout'>)</span>
<a name="line-91"></a>
<a name="line-92"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-93"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-94"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-95"></a>
<a name="line-96"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.ByteString</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>)</span>
<a name="line-97"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.ByteString.Builder</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>BSB</span>
<a name="line-98"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.ByteString.Lazy</span>    <span class='hs-keyword'>as</span> <span class='hs-conid'>LBS</span>
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.Data</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Data</span>
<a name="line-100"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Char</span>
<a name="line-101"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List</span><span class='hs-layout'>(</span> <span class='hs-varid'>find</span> <span class='hs-layout'>)</span>
<a name="line-102"></a>
<a name="line-103"></a><span class='hs-comment'>{-
<a name="line-104"></a>Data constructor representation
<a name="line-105"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-106"></a>Consider the following Haskell data type declaration
<a name="line-107"></a>
<a name="line-108"></a>        data T = T !Int ![Int]
<a name="line-109"></a>
<a name="line-110"></a>Using the strictness annotations, GHC will represent this as
<a name="line-111"></a>
<a name="line-112"></a>        data T = T Int# [Int]
<a name="line-113"></a>
<a name="line-114"></a>That is, the Int has been unboxed.  Furthermore, the Haskell source construction
<a name="line-115"></a>
<a name="line-116"></a>        T e1 e2
<a name="line-117"></a>
<a name="line-118"></a>is translated to
<a name="line-119"></a>
<a name="line-120"></a>        case e1 of { I# x -&gt;
<a name="line-121"></a>        case e2 of { r -&gt;
<a name="line-122"></a>        T x r }}
<a name="line-123"></a>
<a name="line-124"></a>That is, the first argument is unboxed, and the second is evaluated.  Finally,
<a name="line-125"></a>pattern matching is translated too:
<a name="line-126"></a>
<a name="line-127"></a>        case e of { T a b -&gt; ... }
<a name="line-128"></a>
<a name="line-129"></a>becomes
<a name="line-130"></a>
<a name="line-131"></a>        case e of { T a' b -&gt; let a = I# a' in ... }
<a name="line-132"></a>
<a name="line-133"></a>To keep ourselves sane, we name the different versions of the data constructor
<a name="line-134"></a>differently, as follows.
<a name="line-135"></a>
<a name="line-136"></a>
<a name="line-137"></a>Note [Data Constructor Naming]
<a name="line-138"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-139"></a>Each data constructor C has two, and possibly up to four, Names associated with it:
<a name="line-140"></a>
<a name="line-141"></a>                   OccName   Name space   Name of   Notes
<a name="line-142"></a> ---------------------------------------------------------------------------
<a name="line-143"></a> The "data con itself"   C     DataName   DataCon   In dom( GlobalRdrEnv )
<a name="line-144"></a> The "worker data con"   C     VarName    Id        The worker
<a name="line-145"></a> The "wrapper data con"  $WC   VarName    Id        The wrapper
<a name="line-146"></a> The "newtype coercion"  :CoT  TcClsName  TyCon
<a name="line-147"></a>
<a name="line-148"></a>EVERY data constructor (incl for newtypes) has the former two (the
<a name="line-149"></a>data con itself, and its worker.  But only some data constructors have a
<a name="line-150"></a>wrapper (see Note [The need for a wrapper]).
<a name="line-151"></a>
<a name="line-152"></a>Each of these three has a distinct Unique.  The "data con itself" name
<a name="line-153"></a>appears in the output of the renamer, and names the Haskell-source
<a name="line-154"></a>data constructor.  The type checker translates it into either the wrapper Id
<a name="line-155"></a>(if it exists) or worker Id (otherwise).
<a name="line-156"></a>
<a name="line-157"></a>The data con has one or two Ids associated with it:
<a name="line-158"></a>
<a name="line-159"></a>The "worker Id", is the actual data constructor.
<a name="line-160"></a>* Every data constructor (newtype or data type) has a worker
<a name="line-161"></a>
<a name="line-162"></a>* The worker is very like a primop, in that it has no binding.
<a name="line-163"></a>
<a name="line-164"></a>* For a *data* type, the worker *is* the data constructor;
<a name="line-165"></a>  it has no unfolding
<a name="line-166"></a>
<a name="line-167"></a>* For a *newtype*, the worker has a compulsory unfolding which
<a name="line-168"></a>  does a cast, e.g.
<a name="line-169"></a>        newtype T = MkT Int
<a name="line-170"></a>        The worker for MkT has unfolding
<a name="line-171"></a>                \\(x:Int). x `cast` sym CoT
<a name="line-172"></a>  Here CoT is the type constructor, witnessing the FC axiom
<a name="line-173"></a>        axiom CoT : T = Int
<a name="line-174"></a>
<a name="line-175"></a>The "wrapper Id", \$WC, goes as follows
<a name="line-176"></a>
<a name="line-177"></a>* Its type is exactly what it looks like in the source program.
<a name="line-178"></a>
<a name="line-179"></a>* It is an ordinary function, and it gets a top-level binding
<a name="line-180"></a>  like any other function.
<a name="line-181"></a>
<a name="line-182"></a>* The wrapper Id isn't generated for a data type if there is
<a name="line-183"></a>  nothing for the wrapper to do.  That is, if its defn would be
<a name="line-184"></a>        \$wC = C
<a name="line-185"></a>
<a name="line-186"></a>Note [Data constructor workers and wrappers]
<a name="line-187"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-188"></a>* Algebraic data types
<a name="line-189"></a>  - Always have a worker, with no unfolding
<a name="line-190"></a>  - May or may not have a wrapper; see Note [The need for a wrapper]
<a name="line-191"></a>
<a name="line-192"></a>* Newtypes
<a name="line-193"></a>  - Always have a worker, which has a compulsory unfolding (just a cast)
<a name="line-194"></a>  - May or may not have a wrapper; see Note [The need for a wrapper]
<a name="line-195"></a>
<a name="line-196"></a>* INVARIANT: the dictionary constructor for a class
<a name="line-197"></a>             never has a wrapper.
<a name="line-198"></a>
<a name="line-199"></a>* Neither_ the worker _nor_ the wrapper take the dcStupidTheta dicts as arguments
<a name="line-200"></a>
<a name="line-201"></a>* The wrapper (if it exists) takes dcOrigArgTys as its arguments.
<a name="line-202"></a>  The worker takes dataConRepArgTys as its arguments
<a name="line-203"></a>  If the worker is absent, dataConRepArgTys is the same as dcOrigArgTys
<a name="line-204"></a>
<a name="line-205"></a>* The 'NoDataConRep' case of DataConRep is important. Not only is it
<a name="line-206"></a>  efficient, but it also ensures that the wrapper is replaced by the
<a name="line-207"></a>  worker (because it *is* the worker) even when there are no
<a name="line-208"></a>  args. E.g. in
<a name="line-209"></a>               f (:) x
<a name="line-210"></a>  the (:) *is* the worker.  This is really important in rule matching,
<a name="line-211"></a>  (We could match on the wrappers, but that makes it less likely that
<a name="line-212"></a>  rules will match when we bring bits of unfoldings together.)
<a name="line-213"></a>
<a name="line-214"></a>Note [The need for a wrapper]
<a name="line-215"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-216"></a>Why might the wrapper have anything to do?  The full story is
<a name="line-217"></a>in wrapper_reqd in GHC.Types.Id.Make.mkDataConRep.
<a name="line-218"></a>
<a name="line-219"></a>* Unboxing strict fields (with -funbox-strict-fields)
<a name="line-220"></a>        data T = MkT !(Int,Int)
<a name="line-221"></a>        \$wMkT :: (Int,Int) -&gt; T
<a name="line-222"></a>        \$wMkT (x,y) = MkT x y
<a name="line-223"></a>  Notice that the worker has two fields where the wapper has
<a name="line-224"></a>  just one.  That is, the worker has type
<a name="line-225"></a>                MkT :: Int -&gt; Int -&gt; T
<a name="line-226"></a>
<a name="line-227"></a>* Equality constraints for GADTs
<a name="line-228"></a>        data T a where { MkT :: a -&gt; T [a] }
<a name="line-229"></a>
<a name="line-230"></a>  The worker gets a type with explicit equality
<a name="line-231"></a>  constraints, thus:
<a name="line-232"></a>        MkT :: forall a b. (a=[b]) =&gt; b -&gt; T a
<a name="line-233"></a>
<a name="line-234"></a>  The wrapper has the programmer-specified type:
<a name="line-235"></a>        \$wMkT :: a -&gt; T [a]
<a name="line-236"></a>        \$wMkT a x = MkT [a] a [a] x
<a name="line-237"></a>  The third argument is a coercion
<a name="line-238"></a>        [a] :: [a]~[a]
<a name="line-239"></a>
<a name="line-240"></a>* Data family instances may do a cast on the result
<a name="line-241"></a>
<a name="line-242"></a>* Type variables may be permuted; see MkId
<a name="line-243"></a>  Note [Data con wrappers and GADT syntax]
<a name="line-244"></a>
<a name="line-245"></a>
<a name="line-246"></a>Note [The stupid context]
<a name="line-247"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-248"></a>Data types can have a context:
<a name="line-249"></a>
<a name="line-250"></a>        data (Eq a, Ord b) =&gt; T a b = T1 a b | T2 a
<a name="line-251"></a>
<a name="line-252"></a>and that makes the constructors have a context too
<a name="line-253"></a>(notice that T2's context is "thinned"):
<a name="line-254"></a>
<a name="line-255"></a>        T1 :: (Eq a, Ord b) =&gt; a -&gt; b -&gt; T a b
<a name="line-256"></a>        T2 :: (Eq a) =&gt; a -&gt; T a b
<a name="line-257"></a>
<a name="line-258"></a>Furthermore, this context pops up when pattern matching
<a name="line-259"></a>(though GHC hasn't implemented this, but it is in H98, and
<a name="line-260"></a>I've fixed GHC so that it now does):
<a name="line-261"></a>
<a name="line-262"></a>        f (T2 x) = x
<a name="line-263"></a>gets inferred type
<a name="line-264"></a>        f :: Eq a =&gt; T a b -&gt; a
<a name="line-265"></a>
<a name="line-266"></a>I say the context is "stupid" because the dictionaries passed
<a name="line-267"></a>are immediately discarded -- they do nothing and have no benefit.
<a name="line-268"></a>It's a flaw in the language.
<a name="line-269"></a>
<a name="line-270"></a>        Up to now [March 2002] I have put this stupid context into the
<a name="line-271"></a>        type of the "wrapper" constructors functions, T1 and T2, but
<a name="line-272"></a>        that turned out to be jolly inconvenient for generics, and
<a name="line-273"></a>        record update, and other functions that build values of type T
<a name="line-274"></a>        (because they don't have suitable dictionaries available).
<a name="line-275"></a>
<a name="line-276"></a>        So now I've taken the stupid context out.  I simply deal with
<a name="line-277"></a>        it separately in the type checker on occurrences of a
<a name="line-278"></a>        constructor, either in an expression or in a pattern.
<a name="line-279"></a>
<a name="line-280"></a>        [May 2003: actually I think this decision could easily be
<a name="line-281"></a>        reversed now, and probably should be.  Generics could be
<a name="line-282"></a>        disabled for types with a stupid context; record updates now
<a name="line-283"></a>        (H98) needs the context too; etc.  It's an unforced change, so
<a name="line-284"></a>        I'm leaving it for now --- but it does seem odd that the
<a name="line-285"></a>        wrapper doesn't include the stupid context.]
<a name="line-286"></a>
<a name="line-287"></a>[July 04] With the advent of generalised data types, it's less obvious
<a name="line-288"></a>what the "stupid context" is.  Consider
<a name="line-289"></a>        C :: forall a. Ord a =&gt; a -&gt; a -&gt; T (Foo a)
<a name="line-290"></a>Does the C constructor in Core contain the Ord dictionary?  Yes, it must:
<a name="line-291"></a>
<a name="line-292"></a>        f :: T b -&gt; Ordering
<a name="line-293"></a>        f = /\b. \x:T b.
<a name="line-294"></a>            case x of
<a name="line-295"></a>                C a (d:Ord a) (p:a) (q:a) -&gt; compare d p q
<a name="line-296"></a>
<a name="line-297"></a>Note that (Foo a) might not be an instance of Ord.
<a name="line-298"></a>
<a name="line-299"></a>************************************************************************
<a name="line-300"></a>*                                                                      *
<a name="line-301"></a>\subsection{Data constructors}
<a name="line-302"></a>*                                                                      *
<a name="line-303"></a>************************************************************************
<a name="line-304"></a>-}</span>
<a name="line-305"></a>
<a name="line-306"></a><span class='hs-comment'>-- | A data constructor</span>
<a name="line-307"></a><span class='hs-comment'>--</span>
<a name="line-308"></a><span class='hs-comment'>-- - 'GHC.Parser.Annotation.AnnKeywordId' : 'GHC.Parser.Annotation.AnnOpen',</span>
<a name="line-309"></a><span class='hs-comment'>--             'GHC.Parser.Annotation.AnnClose','GHC.Parser.Annotation.AnnComma'</span>
<a name="line-310"></a>
<a name="line-311"></a><a name="DataCon"></a><span class='hs-comment'>-- For details on above see note [exact print annotations] in GHC.Parser.Annotation</span>
<a name="line-312"></a><a name="DataCon"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DataCon</span>
<a name="line-313"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span>
<a name="line-314"></a>        <span class='hs-varid'>dcName</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- This is the name of the *source data con*</span>
<a name="line-315"></a>                                <span class='hs-comment'>-- (see "Note [Data Constructor Naming]" above)</span>
<a name="line-316"></a>        <span class='hs-varid'>dcUnique</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Cached from Name</span>
<a name="line-317"></a>        <span class='hs-varid'>dcTag</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ConTag</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- ^ Tag, used for ordering 'DataCon's</span>
<a name="line-318"></a>
<a name="line-319"></a>        <span class='hs-comment'>-- Running example:</span>
<a name="line-320"></a>        <span class='hs-comment'>--</span>
<a name="line-321"></a>        <span class='hs-comment'>--      *** As declared by the user</span>
<a name="line-322"></a>        <span class='hs-comment'>--  data T a b c where</span>
<a name="line-323"></a>        <span class='hs-comment'>--    MkT :: forall c y x b. (x~y,Ord x) =&gt; x -&gt; y -&gt; T (x,y) b c</span>
<a name="line-324"></a>
<a name="line-325"></a>        <span class='hs-comment'>--      *** As represented internally</span>
<a name="line-326"></a>        <span class='hs-comment'>--  data T a b c where</span>
<a name="line-327"></a>        <span class='hs-comment'>--    MkT :: forall a b c. forall x y. (a~(x,y),x~y,Ord x)</span>
<a name="line-328"></a>        <span class='hs-comment'>--        =&gt; x -&gt; y -&gt; T a b c</span>
<a name="line-329"></a>        <span class='hs-comment'>--</span>
<a name="line-330"></a>        <span class='hs-comment'>-- The next six fields express the type of the constructor, in pieces</span>
<a name="line-331"></a>        <span class='hs-comment'>-- e.g.</span>
<a name="line-332"></a>        <span class='hs-comment'>--</span>
<a name="line-333"></a>        <span class='hs-comment'>--      dcUnivTyVars       = [a,b,c]</span>
<a name="line-334"></a>        <span class='hs-comment'>--      dcExTyCoVars       = [x,y]</span>
<a name="line-335"></a>        <span class='hs-comment'>--      dcUserTyVarBinders = [c,y,x,b]</span>
<a name="line-336"></a>        <span class='hs-comment'>--      dcEqSpec           = [a~(x,y)]</span>
<a name="line-337"></a>        <span class='hs-comment'>--      dcOtherTheta       = [x~y, Ord x]</span>
<a name="line-338"></a>        <span class='hs-comment'>--      dcOrigArgTys       = [x,y]</span>
<a name="line-339"></a>        <span class='hs-comment'>--      dcRepTyCon         = T</span>
<a name="line-340"></a>
<a name="line-341"></a>        <span class='hs-comment'>-- In general, the dcUnivTyVars are NOT NECESSARILY THE SAME AS THE</span>
<a name="line-342"></a>        <span class='hs-comment'>-- TYVARS FOR THE PARENT TyCon. (This is a change (Oct05): previously,</span>
<a name="line-343"></a>        <span class='hs-comment'>-- vanilla datacons guaranteed to have the same type variables as their</span>
<a name="line-344"></a>        <span class='hs-comment'>-- parent TyCon, but that seems ugly.) They can be different in the case</span>
<a name="line-345"></a>        <span class='hs-comment'>-- where a GADT constructor uses different names for the universal</span>
<a name="line-346"></a>        <span class='hs-comment'>-- tyvars than does the tycon. For example:</span>
<a name="line-347"></a>        <span class='hs-comment'>--</span>
<a name="line-348"></a>        <span class='hs-comment'>--   data H a where</span>
<a name="line-349"></a>        <span class='hs-comment'>--     MkH :: b -&gt; H b</span>
<a name="line-350"></a>        <span class='hs-comment'>--</span>
<a name="line-351"></a>        <span class='hs-comment'>-- Here, the tyConTyVars of H will be [a], but the dcUnivTyVars of MkH</span>
<a name="line-352"></a>        <span class='hs-comment'>-- will be [b].</span>
<a name="line-353"></a>
<a name="line-354"></a>        <span class='hs-varid'>dcVanilla</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- True &lt;=&gt; This is a vanilla Haskell 98 data constructor</span>
<a name="line-355"></a>                                <span class='hs-comment'>--          Its type is of form</span>
<a name="line-356"></a>                                <span class='hs-comment'>--              forall a1..an . t1 -&gt; ... tm -&gt; T a1..an</span>
<a name="line-357"></a>                                <span class='hs-comment'>--          No existentials, no coercions, nothing.</span>
<a name="line-358"></a>                                <span class='hs-comment'>-- That is: dcExTyCoVars = dcEqSpec = dcOtherTheta = []</span>
<a name="line-359"></a>                <span class='hs-comment'>-- NB 1: newtypes always have a vanilla data con</span>
<a name="line-360"></a>                <span class='hs-comment'>-- NB 2: a vanilla constructor can still be declared in GADT-style</span>
<a name="line-361"></a>                <span class='hs-comment'>--       syntax, provided its type looks like the above.</span>
<a name="line-362"></a>                <span class='hs-comment'>--       The declaration format is held in the TyCon (algTcGadtSyntax)</span>
<a name="line-363"></a>
<a name="line-364"></a>        <span class='hs-comment'>-- Universally-quantified type vars [a,b,c]</span>
<a name="line-365"></a>        <span class='hs-comment'>-- INVARIANT: length matches arity of the dcRepTyCon</span>
<a name="line-366"></a>        <span class='hs-comment'>-- INVARIANT: result type of data con worker is exactly (T a b c)</span>
<a name="line-367"></a>        <span class='hs-comment'>-- COROLLARY: The dcUnivTyVars are always in one-to-one correspondence with</span>
<a name="line-368"></a>        <span class='hs-comment'>--            the tyConTyVars of the parent TyCon</span>
<a name="line-369"></a>        <span class='hs-varid'>dcUnivTyVars</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-370"></a>
<a name="line-371"></a>        <span class='hs-comment'>-- Existentially-quantified type and coercion vars [x,y]</span>
<a name="line-372"></a>        <span class='hs-comment'>-- For an example involving coercion variables,</span>
<a name="line-373"></a>        <span class='hs-comment'>-- Why tycovars? See Note [Existential coercion variables]</span>
<a name="line-374"></a>        <span class='hs-varid'>dcExTyCoVars</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-375"></a>
<a name="line-376"></a>        <span class='hs-comment'>-- INVARIANT: the UnivTyVars and ExTyCoVars all have distinct OccNames</span>
<a name="line-377"></a>        <span class='hs-comment'>-- Reason: less confusing, and easier to generate Iface syntax</span>
<a name="line-378"></a>
<a name="line-379"></a>        <span class='hs-comment'>-- The type/coercion vars in the order the user wrote them [c,y,x,b]</span>
<a name="line-380"></a>        <span class='hs-comment'>-- INVARIANT: the set of tyvars in dcUserTyVarBinders is exactly the set</span>
<a name="line-381"></a>        <span class='hs-comment'>--            of tyvars (*not* covars) of dcExTyCoVars unioned with the</span>
<a name="line-382"></a>        <span class='hs-comment'>--            set of dcUnivTyVars whose tyvars do not appear in dcEqSpec</span>
<a name="line-383"></a>        <span class='hs-comment'>-- See Note [DataCon user type variable binders]</span>
<a name="line-384"></a>        <span class='hs-varid'>dcUserTyVarBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InvisTVBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-385"></a>
<a name="line-386"></a>        <span class='hs-varid'>dcEqSpec</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EqSpec</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- Equalities derived from the result type,</span>
<a name="line-387"></a>                                <span class='hs-comment'>-- _as written by the programmer_.</span>
<a name="line-388"></a>                                <span class='hs-comment'>-- Only non-dependent GADT equalities (dependent</span>
<a name="line-389"></a>                                <span class='hs-comment'>-- GADT equalities are in the covars of</span>
<a name="line-390"></a>                                <span class='hs-comment'>-- dcExTyCoVars).</span>
<a name="line-391"></a>
<a name="line-392"></a>                <span class='hs-comment'>-- This field allows us to move conveniently between the two ways</span>
<a name="line-393"></a>                <span class='hs-comment'>-- of representing a GADT constructor's type:</span>
<a name="line-394"></a>                <span class='hs-comment'>--      MkT :: forall a b. (a ~ [b]) =&gt; b -&gt; T a</span>
<a name="line-395"></a>                <span class='hs-comment'>--      MkT :: forall b. b -&gt; T [b]</span>
<a name="line-396"></a>                <span class='hs-comment'>-- Each equality is of the form (a ~ ty), where 'a' is one of</span>
<a name="line-397"></a>                <span class='hs-comment'>-- the universally quantified type variables. Moreover, the</span>
<a name="line-398"></a>                <span class='hs-comment'>-- only place in the DataCon where this 'a' will occur is in</span>
<a name="line-399"></a>                <span class='hs-comment'>-- dcUnivTyVars. See [The dcEqSpec domain invariant].</span>
<a name="line-400"></a>
<a name="line-401"></a>                <span class='hs-comment'>-- The next two fields give the type context of the data constructor</span>
<a name="line-402"></a>                <span class='hs-comment'>--      (aside from the GADT constraints,</span>
<a name="line-403"></a>                <span class='hs-comment'>--       which are given by the dcExpSpec)</span>
<a name="line-404"></a>                <span class='hs-comment'>-- In GADT form, this is *exactly* what the programmer writes, even if</span>
<a name="line-405"></a>                <span class='hs-comment'>-- the context constrains only universally quantified variables</span>
<a name="line-406"></a>                <span class='hs-comment'>--      MkT :: forall a b. (a ~ b, Ord b) =&gt; a -&gt; T a b</span>
<a name="line-407"></a>        <span class='hs-varid'>dcOtherTheta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- The other constraints in the data con's type</span>
<a name="line-408"></a>                                    <span class='hs-comment'>-- other than those in the dcEqSpec</span>
<a name="line-409"></a>
<a name="line-410"></a>        <span class='hs-varid'>dcStupidTheta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- The context of the data type declaration</span>
<a name="line-411"></a>                                        <span class='hs-comment'>--      data Eq a =&gt; T a = ...</span>
<a name="line-412"></a>                                        <span class='hs-comment'>-- or, rather, a "thinned" version thereof</span>
<a name="line-413"></a>                <span class='hs-comment'>-- "Thinned", because the Report says</span>
<a name="line-414"></a>                <span class='hs-comment'>-- to eliminate any constraints that don't mention</span>
<a name="line-415"></a>                <span class='hs-comment'>-- tyvars free in the arg types for this constructor</span>
<a name="line-416"></a>                <span class='hs-comment'>--</span>
<a name="line-417"></a>                <span class='hs-comment'>-- INVARIANT: the free tyvars of dcStupidTheta are a subset of dcUnivTyVars</span>
<a name="line-418"></a>                <span class='hs-comment'>-- Reason: dcStupidTeta is gotten by thinning the stupid theta from the tycon</span>
<a name="line-419"></a>                <span class='hs-comment'>--</span>
<a name="line-420"></a>                <span class='hs-comment'>-- "Stupid", because the dictionaries aren't used for anything.</span>
<a name="line-421"></a>                <span class='hs-comment'>-- Indeed, [as of March 02] they are no longer in the type of</span>
<a name="line-422"></a>                <span class='hs-comment'>-- the wrapper Id, because that makes it harder to use the wrap-id</span>
<a name="line-423"></a>                <span class='hs-comment'>-- to rebuild values after record selection or in generics.</span>
<a name="line-424"></a>
<a name="line-425"></a>        <span class='hs-varid'>dcOrigArgTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Scaled</span> <span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- Original argument types</span>
<a name="line-426"></a>                                        <span class='hs-comment'>-- (before unboxing and flattening of strict fields)</span>
<a name="line-427"></a>        <span class='hs-varid'>dcOrigResTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span>            <span class='hs-comment'>-- Original result type, as seen by the user</span>
<a name="line-428"></a>                <span class='hs-comment'>-- NB: for a data instance, the original user result type may</span>
<a name="line-429"></a>                <span class='hs-comment'>-- differ from the DataCon's representation TyCon.  Example</span>
<a name="line-430"></a>                <span class='hs-comment'>--      data instance T [a] where MkT :: a -&gt; T [a]</span>
<a name="line-431"></a>                <span class='hs-comment'>-- The dcOrigResTy is T [a], but the dcRepTyCon might be R:TList</span>
<a name="line-432"></a>
<a name="line-433"></a>        <span class='hs-comment'>-- Now the strictness annotations and field labels of the constructor</span>
<a name="line-434"></a>        <span class='hs-varid'>dcSrcBangs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>HsSrcBang</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-435"></a>                <span class='hs-comment'>-- See Note [Bangs on data constructor arguments]</span>
<a name="line-436"></a>                <span class='hs-comment'>--</span>
<a name="line-437"></a>                <span class='hs-comment'>-- The [HsSrcBang] as written by the programmer.</span>
<a name="line-438"></a>                <span class='hs-comment'>--</span>
<a name="line-439"></a>                <span class='hs-comment'>-- Matches 1-1 with dcOrigArgTys</span>
<a name="line-440"></a>                <span class='hs-comment'>-- Hence length = dataConSourceArity dataCon</span>
<a name="line-441"></a>
<a name="line-442"></a>        <span class='hs-varid'>dcFields</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FieldLabel</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-443"></a>                <span class='hs-comment'>-- Field labels for this constructor, in the</span>
<a name="line-444"></a>                <span class='hs-comment'>-- same order as the dcOrigArgTys;</span>
<a name="line-445"></a>                <span class='hs-comment'>-- length = 0 (if not a record) or dataConSourceArity.</span>
<a name="line-446"></a>
<a name="line-447"></a>        <span class='hs-comment'>-- The curried worker function that corresponds to the constructor:</span>
<a name="line-448"></a>        <span class='hs-comment'>-- It doesn't have an unfolding; the code generator saturates these Ids</span>
<a name="line-449"></a>        <span class='hs-comment'>-- and allocates a real constructor when it finds one.</span>
<a name="line-450"></a>        <span class='hs-varid'>dcWorkId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span><span class='hs-layout'>,</span>
<a name="line-451"></a>
<a name="line-452"></a>        <span class='hs-comment'>-- Constructor representation</span>
<a name="line-453"></a>        <span class='hs-varid'>dcRep</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataConRep</span><span class='hs-layout'>,</span>
<a name="line-454"></a>
<a name="line-455"></a>        <span class='hs-comment'>-- Cached; see Note [DataCon arities]</span>
<a name="line-456"></a>        <span class='hs-comment'>-- INVARIANT: dcRepArity    == length dataConRepArgTys + count isCoVar (dcExTyCoVars)</span>
<a name="line-457"></a>        <span class='hs-comment'>-- INVARIANT: dcSourceArity == length dcOrigArgTys</span>
<a name="line-458"></a>        <span class='hs-varid'>dcRepArity</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span><span class='hs-layout'>,</span>
<a name="line-459"></a>        <span class='hs-varid'>dcSourceArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span><span class='hs-layout'>,</span>
<a name="line-460"></a>
<a name="line-461"></a>        <span class='hs-comment'>-- Result type of constructor is T t1..tn</span>
<a name="line-462"></a>        <span class='hs-varid'>dcRepTyCon</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span>           <span class='hs-comment'>-- Result tycon, T</span>
<a name="line-463"></a>
<a name="line-464"></a>        <span class='hs-varid'>dcRepType</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- Type of the constructor</span>
<a name="line-465"></a>                                <span class='hs-comment'>--      forall a x y. (a~(x,y), x~y, Ord x) =&gt;</span>
<a name="line-466"></a>                                <span class='hs-comment'>--        x -&gt; y -&gt; T a</span>
<a name="line-467"></a>                                <span class='hs-comment'>-- (this is *not* of the constructor wrapper Id:</span>
<a name="line-468"></a>                                <span class='hs-comment'>--  see Note [Data con representation] below)</span>
<a name="line-469"></a>        <span class='hs-comment'>-- Notice that the existential type parameters come *second*.</span>
<a name="line-470"></a>        <span class='hs-comment'>-- Reason: in a case expression we may find:</span>
<a name="line-471"></a>        <span class='hs-comment'>--      case (e :: T t) of</span>
<a name="line-472"></a>        <span class='hs-comment'>--        MkT x y co1 co2 (d:Ord x) (v:r) (w:F s) -&gt; ...</span>
<a name="line-473"></a>        <span class='hs-comment'>-- It's convenient to apply the rep-type of MkT to 't', to get</span>
<a name="line-474"></a>        <span class='hs-comment'>--      forall x y. (t~(x,y), x~y, Ord x) =&gt; x -&gt; y -&gt; T t</span>
<a name="line-475"></a>        <span class='hs-comment'>-- and use that to check the pattern.  Mind you, this is really only</span>
<a name="line-476"></a>        <span class='hs-comment'>-- used in GHC.Core.Lint.</span>
<a name="line-477"></a>
<a name="line-478"></a>
<a name="line-479"></a>        <span class='hs-varid'>dcInfix</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- True &lt;=&gt; declared infix</span>
<a name="line-480"></a>                                <span class='hs-comment'>-- Used for Template Haskell and 'deriving' only</span>
<a name="line-481"></a>                                <span class='hs-comment'>-- The actual fixity is stored elsewhere</span>
<a name="line-482"></a>
<a name="line-483"></a>        <span class='hs-varid'>dcPromoted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span>    <span class='hs-comment'>-- The promoted TyCon</span>
<a name="line-484"></a>                               <span class='hs-comment'>-- See Note [Promoted data constructors] in GHC.Core.TyCon</span>
<a name="line-485"></a>  <span class='hs-layout'>}</span>
<a name="line-486"></a>
<a name="line-487"></a>
<a name="line-488"></a><span class='hs-comment'>{- Note [TyVarBinders in DataCons]
<a name="line-489"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-490"></a>For the TyVarBinders in a DataCon and PatSyn:
<a name="line-491"></a>
<a name="line-492"></a> * Each argument flag is Inferred or Specified.
<a name="line-493"></a>   None are Required. (A DataCon is a term-level function; see
<a name="line-494"></a>   Note [No Required TyCoBinder in terms] in GHC.Core.TyCo.Rep.)
<a name="line-495"></a>
<a name="line-496"></a>Why do we need the TyVarBinders, rather than just the TyVars?  So that
<a name="line-497"></a>we can construct the right type for the DataCon with its foralls
<a name="line-498"></a>attributed the correct visibility.  That in turn governs whether you
<a name="line-499"></a>can use visible type application at a call of the data constructor.
<a name="line-500"></a>
<a name="line-501"></a>See also [DataCon user type variable binders] for an extended discussion on the
<a name="line-502"></a>order in which TyVarBinders appear in a DataCon.
<a name="line-503"></a>
<a name="line-504"></a>Note [Existential coercion variables]
<a name="line-505"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-506"></a>
<a name="line-507"></a>For now (Aug 2018) we can't write coercion quantifications in source Haskell, but
<a name="line-508"></a>we can in Core. Consider having:
<a name="line-509"></a>
<a name="line-510"></a>  data T :: forall k. k -&gt; k -&gt; Constraint where
<a name="line-511"></a>    MkT :: forall k (a::k) (b::k). forall k' (c::k') (co::k'~k). (b~(c|&gt;co))
<a name="line-512"></a>        =&gt; T k a b
<a name="line-513"></a>
<a name="line-514"></a>  dcUnivTyVars       = [k,a,b]
<a name="line-515"></a>  dcExTyCoVars       = [k',c,co]
<a name="line-516"></a>  dcUserTyVarBinders = [k,a,k',c]
<a name="line-517"></a>  dcEqSpec           = [b~(c|&gt;co)]
<a name="line-518"></a>  dcOtherTheta       = []
<a name="line-519"></a>  dcOrigArgTys       = []
<a name="line-520"></a>  dcRepTyCon         = T
<a name="line-521"></a>
<a name="line-522"></a>  Function call 'dataConKindEqSpec' returns [k'~k]
<a name="line-523"></a>
<a name="line-524"></a>Note [DataCon arities]
<a name="line-525"></a>~~~~~~~~~~~~~~~~~~~~~~
<a name="line-526"></a>dcSourceArity does not take constraints into account,
<a name="line-527"></a>but dcRepArity does.  For example:
<a name="line-528"></a>   MkT :: Ord a =&gt; a -&gt; T a
<a name="line-529"></a>    dcSourceArity = 1
<a name="line-530"></a>    dcRepArity    = 2
<a name="line-531"></a>
<a name="line-532"></a>Note [DataCon user type variable binders]
<a name="line-533"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-534"></a>In System FC, data constructor type signatures always quantify over all of
<a name="line-535"></a>their universal type variables, followed by their existential type variables.
<a name="line-536"></a>Normally, this isn't a problem, as most datatypes naturally quantify their type
<a name="line-537"></a>variables in this order anyway. For example:
<a name="line-538"></a>
<a name="line-539"></a>  data T a b = forall c. MkT b c
<a name="line-540"></a>
<a name="line-541"></a>Here, we have `MkT :: forall {k} (a :: k) (b :: *) (c :: *). b -&gt; c -&gt; T a b`,
<a name="line-542"></a>where k, a, and b are universal and c is existential. (The inferred variable k
<a name="line-543"></a>isn't available for TypeApplications, hence why it's in braces.) This is a
<a name="line-544"></a>perfectly reasonable order to use, as the syntax of H98-style datatypes
<a name="line-545"></a>(+ ExistentialQuantification) suggests it.
<a name="line-546"></a>
<a name="line-547"></a>Things become more complicated when GADT syntax enters the picture. Consider
<a name="line-548"></a>this example:
<a name="line-549"></a>
<a name="line-550"></a>  data X a where
<a name="line-551"></a>    MkX :: forall b a. b -&gt; Proxy a -&gt; X a
<a name="line-552"></a>
<a name="line-553"></a>If we adopt the earlier approach of quantifying all the universal variables
<a name="line-554"></a>followed by all the existential ones, GHC would come up with this type
<a name="line-555"></a>signature for MkX:
<a name="line-556"></a>
<a name="line-557"></a>  MkX :: forall {k} (a :: k) (b :: *). b -&gt; Proxy a -&gt; X a
<a name="line-558"></a>
<a name="line-559"></a>But this is not what we want at all! After all, if a user were to use
<a name="line-560"></a>TypeApplications on MkX, they would expect to instantiate `b` before `a`,
<a name="line-561"></a>as that's the order in which they were written in the `forall`. (See #11721.)
<a name="line-562"></a>Instead, we'd like GHC to come up with this type signature:
<a name="line-563"></a>
<a name="line-564"></a>  MkX :: forall {k} (b :: *) (a :: k). b -&gt; Proxy a -&gt; X a
<a name="line-565"></a>
<a name="line-566"></a>In fact, even if we left off the explicit forall:
<a name="line-567"></a>
<a name="line-568"></a>  data X a where
<a name="line-569"></a>    MkX :: b -&gt; Proxy a -&gt; X a
<a name="line-570"></a>
<a name="line-571"></a>Then a user should still expect `b` to be quantified before `a`, since
<a name="line-572"></a>according to the rules of TypeApplications, in the absence of `forall` GHC
<a name="line-573"></a>performs a stable topological sort on the type variables in the user-written
<a name="line-574"></a>type signature, which would place `b` before `a`.
<a name="line-575"></a>
<a name="line-576"></a>But as noted above, enacting this behavior is not entirely trivial, as System
<a name="line-577"></a>FC demands the variables go in universal-then-existential order under the hood.
<a name="line-578"></a>Our solution is thus to equip DataCon with two different sets of type
<a name="line-579"></a>variables:
<a name="line-580"></a>
<a name="line-581"></a>* dcUnivTyVars and dcExTyCoVars, for the universal type variable and existential
<a name="line-582"></a>  type/coercion variables, respectively. Their order is irrelevant for the
<a name="line-583"></a>  purposes of TypeApplications, and as a consequence, they do not come equipped
<a name="line-584"></a>  with visibilities (that is, they are TyVars/TyCoVars instead of
<a name="line-585"></a>  TyCoVarBinders).
<a name="line-586"></a>
<a name="line-587"></a>* dcUserTyVarBinders, for the type variables binders in the order in which they
<a name="line-588"></a>  originally arose in the user-written type signature. Their order *does* matter
<a name="line-589"></a>  for TypeApplications, so they are full TyVarBinders, complete with
<a name="line-590"></a>  visibilities.
<a name="line-591"></a>
<a name="line-592"></a>This encoding has some redundancy. The set of tyvars in dcUserTyVarBinders
<a name="line-593"></a>consists precisely of:
<a name="line-594"></a>
<a name="line-595"></a>* The set of tyvars in dcUnivTyVars whose type variables do not appear in
<a name="line-596"></a>  dcEqSpec, unioned with:
<a name="line-597"></a>* The set of tyvars (*not* covars) in dcExTyCoVars
<a name="line-598"></a>  No covars here because because they're not user-written
<a name="line-599"></a>
<a name="line-600"></a>The word "set" is used above because the order in which the tyvars appear in
<a name="line-601"></a>dcUserTyVarBinders can be completely different from the order in dcUnivTyVars or
<a name="line-602"></a>dcExTyCoVars. That is, the tyvars in dcUserTyVarBinders are a permutation of
<a name="line-603"></a>(tyvars of dcExTyCoVars + a subset of dcUnivTyVars). But aside from the
<a name="line-604"></a>ordering, they in fact share the same type variables (with the same Uniques). We
<a name="line-605"></a>sometimes refer to this as "the dcUserTyVarBinders invariant".
<a name="line-606"></a>
<a name="line-607"></a>dcUserTyVarBinders, as the name suggests, is the one that users will
<a name="line-608"></a>see most of the time. It's used when computing the type signature of a
<a name="line-609"></a>data constructor wrapper (see dataConWrapperType), and as a result,
<a name="line-610"></a>it's what matters from a TypeApplications perspective.
<a name="line-611"></a>
<a name="line-612"></a>Note [The dcEqSpec domain invariant]
<a name="line-613"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-614"></a>Consider this example of a GADT constructor:
<a name="line-615"></a>
<a name="line-616"></a>  data Y a where
<a name="line-617"></a>    MkY :: Bool -&gt; Y Bool
<a name="line-618"></a>
<a name="line-619"></a>The user-written type of MkY is `Bool -&gt; Y Bool`, but what is the underlying
<a name="line-620"></a>Core type for MkY? There are two conceivable possibilities:
<a name="line-621"></a>
<a name="line-622"></a>1. MkY :: forall a. (a ~# Bool) =&gt; Bool -&gt; Y a
<a name="line-623"></a>2. MkY :: forall a. (a ~# Bool) =&gt; a    -&gt; Y a
<a name="line-624"></a>
<a name="line-625"></a>In practice, GHC picks (1) as the Core type for MkY. This is because we
<a name="line-626"></a>maintain an invariant that the type variables in the domain of dcEqSpec will
<a name="line-627"></a>only ever appear in the dcUnivTyVars. As a consequence, the type variables in
<a name="line-628"></a>the domain of dcEqSpec will /never/ appear in the dcExTyCoVars, dcOtherTheta,
<a name="line-629"></a>dcOrigArgTys, or dcOrigResTy; these can only ever mention variables from
<a name="line-630"></a>dcUserTyVarBinders, which excludes things in the domain of dcEqSpec.
<a name="line-631"></a>(See Note [DataCon user type variable binders].) This explains why GHC would
<a name="line-632"></a>not pick (2) as the Core type, since the argument type `a` mentions a type
<a name="line-633"></a>variable in the dcEqSpec.
<a name="line-634"></a>
<a name="line-635"></a>There are certain parts of the codebase where it is convenient to apply the
<a name="line-636"></a>substitution arising from the dcEqSpec to the dcUnivTyVars in order to obtain
<a name="line-637"></a>the user-written return type of a GADT constructor. A consequence of the
<a name="line-638"></a>dcEqSpec domain invariant is that you /never/ need to apply the substitution
<a name="line-639"></a>to any other part of the constructor type, as they don't require it.
<a name="line-640"></a>-}</span>
<a name="line-641"></a>
<a name="line-642"></a><a name="DataConRep"></a><span class='hs-comment'>-- | Data Constructor Representation</span>
<a name="line-643"></a><a name="DataConRep"></a><span class='hs-comment'>-- See Note [Data constructor workers and wrappers]</span>
<a name="line-644"></a><a name="DataConRep"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DataConRep</span>
<a name="line-645"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- NoDataConRep means that the data con has no wrapper</span>
<a name="line-646"></a>    <span class='hs-conid'>NoDataConRep</span>
<a name="line-647"></a>
<a name="line-648"></a>    <span class='hs-comment'>-- DCR means that the data con has a wrapper</span>
<a name="line-649"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DCR</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcr_wrap_id</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>   <span class='hs-comment'>-- Takes src args, unboxes/flattens,</span>
<a name="line-650"></a>                              <span class='hs-comment'>-- and constructs the representation</span>
<a name="line-651"></a>
<a name="line-652"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>dcr_boxer</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataConBoxer</span>
<a name="line-653"></a>
<a name="line-654"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>dcr_arg_tys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Scaled</span> <span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- Final, representation argument types,</span>
<a name="line-655"></a>                                          <span class='hs-comment'>-- after unboxing and flattening,</span>
<a name="line-656"></a>                                          <span class='hs-comment'>-- and *including* all evidence args</span>
<a name="line-657"></a>
<a name="line-658"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>dcr_stricts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StrictnessMark</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- 1-1 with dcr_arg_tys</span>
<a name="line-659"></a>                <span class='hs-comment'>-- See also Note [Data-con worker strictness]</span>
<a name="line-660"></a>
<a name="line-661"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>dcr_bangs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>HsImplBang</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- The actual decisions made (including failures)</span>
<a name="line-662"></a>                                     <span class='hs-comment'>-- about the original arguments; 1-1 with orig_arg_tys</span>
<a name="line-663"></a>                                     <span class='hs-comment'>-- See Note [Bangs on data constructor arguments]</span>
<a name="line-664"></a>
<a name="line-665"></a>    <span class='hs-layout'>}</span>
<a name="line-666"></a>
<a name="line-667"></a><span class='hs-comment'>-------------------------</span>
<a name="line-668"></a>
<a name="line-669"></a><a name="HsSrcBang"></a><span class='hs-comment'>-- | Haskell Source Bang</span>
<a name="line-670"></a><a name="HsSrcBang"></a><span class='hs-comment'>--</span>
<a name="line-671"></a><a name="HsSrcBang"></a><span class='hs-comment'>-- Bangs on data constructor arguments as the user wrote them in the</span>
<a name="line-672"></a><a name="HsSrcBang"></a><span class='hs-comment'>-- source code.</span>
<a name="line-673"></a><a name="HsSrcBang"></a><span class='hs-comment'>--</span>
<a name="line-674"></a><a name="HsSrcBang"></a><span class='hs-comment'>-- @(HsSrcBang _ SrcUnpack SrcLazy)@ and</span>
<a name="line-675"></a><a name="HsSrcBang"></a><span class='hs-comment'>-- @(HsSrcBang _ SrcUnpack NoSrcStrict)@ (without StrictData) makes no sense, we</span>
<a name="line-676"></a><a name="HsSrcBang"></a><span class='hs-comment'>-- emit a warning (in checkValidDataCon) and treat it like</span>
<a name="line-677"></a><a name="HsSrcBang"></a><span class='hs-comment'>-- @(HsSrcBang _ NoSrcUnpack SrcLazy)@</span>
<a name="line-678"></a><a name="HsSrcBang"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>HsSrcBang</span> <span class='hs-keyglyph'>=</span>
<a name="line-679"></a>  <span class='hs-conid'>HsSrcBang</span> <span class='hs-conid'>SourceText</span> <span class='hs-comment'>-- Note [Pragma source text] in GHC.Types.SourceText</span>
<a name="line-680"></a>            <span class='hs-conid'>SrcUnpackedness</span>
<a name="line-681"></a>            <span class='hs-conid'>SrcStrictness</span>
<a name="line-682"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Data.Data</span>
<a name="line-683"></a>
<a name="line-684"></a><a name="HsImplBang"></a><span class='hs-comment'>-- | Haskell Implementation Bang</span>
<a name="line-685"></a><a name="HsImplBang"></a><span class='hs-comment'>--</span>
<a name="line-686"></a><a name="HsImplBang"></a><span class='hs-comment'>-- Bangs of data constructor arguments as generated by the compiler</span>
<a name="line-687"></a><a name="HsImplBang"></a><span class='hs-comment'>-- after consulting HsSrcBang, flags, etc.</span>
<a name="line-688"></a><a name="HsImplBang"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>HsImplBang</span>
<a name="line-689"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsLazy</span>    <span class='hs-comment'>-- ^ Lazy field, or one with an unlifted type</span>
<a name="line-690"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HsStrict</span>  <span class='hs-comment'>-- ^ Strict but not unpacked field</span>
<a name="line-691"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HsUnpack</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-692"></a>    <span class='hs-comment'>-- ^ Strict and unpacked field</span>
<a name="line-693"></a>    <span class='hs-comment'>-- co :: arg-ty ~ product-ty HsBang</span>
<a name="line-694"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Data.Data</span>
<a name="line-695"></a>
<a name="line-696"></a><a name="SrcStrictness"></a><span class='hs-comment'>-- | Source Strictness</span>
<a name="line-697"></a><a name="SrcStrictness"></a><span class='hs-comment'>--</span>
<a name="line-698"></a><a name="SrcStrictness"></a><span class='hs-comment'>-- What strictness annotation the user wrote</span>
<a name="line-699"></a><a name="SrcStrictness"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SrcStrictness</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SrcLazy</span> <span class='hs-comment'>-- ^ Lazy, ie '~'</span>
<a name="line-700"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SrcStrict</span> <span class='hs-comment'>-- ^ Strict, ie '!'</span>
<a name="line-701"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NoSrcStrict</span> <span class='hs-comment'>-- ^ no strictness annotation</span>
<a name="line-702"></a>     <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data.Data</span><span class='hs-layout'>)</span>
<a name="line-703"></a>
<a name="line-704"></a><a name="SrcUnpackedness"></a><span class='hs-comment'>-- | Source Unpackedness</span>
<a name="line-705"></a><a name="SrcUnpackedness"></a><span class='hs-comment'>--</span>
<a name="line-706"></a><a name="SrcUnpackedness"></a><span class='hs-comment'>-- What unpackedness the user requested</span>
<a name="line-707"></a><a name="SrcUnpackedness"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SrcUnpackedness</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SrcUnpack</span> <span class='hs-comment'>-- ^ {-# UNPACK #-} specified</span>
<a name="line-708"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SrcNoUnpack</span> <span class='hs-comment'>-- ^ {-# NOUNPACK #-} specified</span>
<a name="line-709"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NoSrcUnpack</span> <span class='hs-comment'>-- ^ no unpack pragma</span>
<a name="line-710"></a>     <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data.Data</span><span class='hs-layout'>)</span>
<a name="line-711"></a>
<a name="line-712"></a>
<a name="line-713"></a>
<a name="line-714"></a><a name="StrictnessMark"></a><span class='hs-comment'>-------------------------</span>
<a name="line-715"></a><a name="StrictnessMark"></a><span class='hs-comment'>-- StrictnessMark is internal only, used to indicate strictness</span>
<a name="line-716"></a><a name="StrictnessMark"></a><span class='hs-comment'>-- of the DataCon *worker* fields</span>
<a name="line-717"></a><a name="StrictnessMark"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>StrictnessMark</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MarkedStrict</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NotMarkedStrict</span>
<a name="line-718"></a>
<a name="line-719"></a><a name="EqSpec"></a><span class='hs-comment'>-- | An 'EqSpec' is a tyvar/type pair representing an equality made in</span>
<a name="line-720"></a><a name="EqSpec"></a><span class='hs-comment'>-- rejigging a GADT constructor</span>
<a name="line-721"></a><a name="EqSpec"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EqSpec</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EqSpec</span> <span class='hs-conid'>TyVar</span>
<a name="line-722"></a>                     <span class='hs-conid'>Type</span>
<a name="line-723"></a>
<a name="line-724"></a><a name="mkEqSpec"></a><span class='hs-comment'>-- | Make a non-dependent 'EqSpec'</span>
<a name="line-725"></a><span class='hs-definition'>mkEqSpec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqSpec</span>
<a name="line-726"></a><span class='hs-definition'>mkEqSpec</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EqSpec</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-727"></a>
<a name="line-728"></a><a name="eqSpecTyVar"></a><span class='hs-definition'>eqSpecTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>
<a name="line-729"></a><span class='hs-definition'>eqSpecTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqSpec</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span>
<a name="line-730"></a>
<a name="line-731"></a><a name="eqSpecType"></a><span class='hs-definition'>eqSpecType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-732"></a><span class='hs-definition'>eqSpecType</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqSpec</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-733"></a>
<a name="line-734"></a><a name="eqSpecPair"></a><span class='hs-definition'>eqSpecPair</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-735"></a><span class='hs-definition'>eqSpecPair</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqSpec</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-736"></a>
<a name="line-737"></a><a name="eqSpecPreds"></a><span class='hs-definition'>eqSpecPreds</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EqSpec</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span>
<a name="line-738"></a><span class='hs-definition'>eqSpecPreds</span> <span class='hs-varid'>spec</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mkPrimEqPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-739"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EqSpec</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>spec</span> <span class='hs-keyglyph'>]</span>
<a name="line-740"></a>
<a name="line-741"></a><a name="substEqSpec"></a><span class='hs-comment'>-- | Substitute in an 'EqSpec'. Precondition: if the LHS of the EqSpec</span>
<a name="line-742"></a><span class='hs-comment'>-- is mapped in the substitution, it is mapped to a type variable, not</span>
<a name="line-743"></a><span class='hs-comment'>-- a full type.</span>
<a name="line-744"></a><span class='hs-definition'>substEqSpec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqSpec</span>
<a name="line-745"></a><span class='hs-definition'>substEqSpec</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqSpec</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-746"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EqSpec</span> <span class='hs-varid'>tv'</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-747"></a>  <span class='hs-keyword'>where</span>
<a name="line-748"></a>    <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getTyVar</span> <span class='hs-str'>"substEqSpec"</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTyVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-749"></a>
<a name="line-750"></a><a name="filterEqSpec"></a><span class='hs-comment'>-- | Filter out any 'TyVar's mentioned in an 'EqSpec'.</span>
<a name="line-751"></a><span class='hs-definition'>filterEqSpec</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EqSpec</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-752"></a><span class='hs-definition'>filterEqSpec</span> <span class='hs-varid'>eq_spec</span>
<a name="line-753"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>not_in_eq_spec</span>
<a name="line-754"></a>  <span class='hs-keyword'>where</span>
<a name="line-755"></a>    <span class='hs-varid'>not_in_eq_spec</span> <span class='hs-varid'>var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varop'>==</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>eqSpecTyVar</span><span class='hs-layout'>)</span> <span class='hs-varid'>eq_spec</span>
<a name="line-756"></a>
<a name="line-757"></a><a name="instance%20Outputable%20EqSpec"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>EqSpec</span> <span class='hs-keyword'>where</span>
<a name="line-758"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqSpec</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-759"></a>
<a name="line-760"></a><span class='hs-comment'>{- Note [Data-con worker strictness]
<a name="line-761"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-762"></a>Notice that we do *not* say the worker Id is strict even if the data
<a name="line-763"></a>constructor is declared strict
<a name="line-764"></a>     e.g.    data T = MkT !(Int,Int)
<a name="line-765"></a>Why?  Because the *wrapper* $WMkT is strict (and its unfolding has case
<a name="line-766"></a>expressions that do the evals) but the *worker* MkT itself is not. If we
<a name="line-767"></a>pretend it is strict then when we see
<a name="line-768"></a>     case x of y -&gt; MkT y
<a name="line-769"></a>the simplifier thinks that y is "sure to be evaluated" (because the worker MkT
<a name="line-770"></a>is strict) and drops the case.  No, the workerId MkT is not strict.
<a name="line-771"></a>
<a name="line-772"></a>However, the worker does have StrictnessMarks.  When the simplifier sees a
<a name="line-773"></a>pattern
<a name="line-774"></a>     case e of MkT x -&gt; ...
<a name="line-775"></a>it uses the dataConRepStrictness of MkT to mark x as evaluated; but that's
<a name="line-776"></a>fine... dataConRepStrictness comes from the data con not from the worker Id.
<a name="line-777"></a>
<a name="line-778"></a>Note [Bangs on data constructor arguments]
<a name="line-779"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-780"></a>Consider
<a name="line-781"></a>  data T = MkT !Int {-# UNPACK #-} !Int Bool
<a name="line-782"></a>
<a name="line-783"></a>When compiling the module, GHC will decide how to represent
<a name="line-784"></a>MkT, depending on the optimisation level, and settings of
<a name="line-785"></a>flags like -funbox-small-strict-fields.
<a name="line-786"></a>
<a name="line-787"></a>Terminology:
<a name="line-788"></a>  * HsSrcBang:  What the user wrote
<a name="line-789"></a>                Constructors: HsSrcBang
<a name="line-790"></a>
<a name="line-791"></a>  * HsImplBang: What GHC decided
<a name="line-792"></a>                Constructors: HsLazy, HsStrict, HsUnpack
<a name="line-793"></a>
<a name="line-794"></a>* If T was defined in this module, MkT's dcSrcBangs field
<a name="line-795"></a>  records the [HsSrcBang] of what the user wrote; in the example
<a name="line-796"></a>    [ HsSrcBang _ NoSrcUnpack SrcStrict
<a name="line-797"></a>    , HsSrcBang _ SrcUnpack SrcStrict
<a name="line-798"></a>    , HsSrcBang _ NoSrcUnpack NoSrcStrictness]
<a name="line-799"></a>
<a name="line-800"></a>* However, if T was defined in an imported module, the importing module
<a name="line-801"></a>  must follow the decisions made in the original module, regardless of
<a name="line-802"></a>  the flag settings in the importing module.
<a name="line-803"></a>  Also see Note [Bangs on imported data constructors] in GHC.Types.Id.Make
<a name="line-804"></a>
<a name="line-805"></a>* The dcr_bangs field of the dcRep field records the [HsImplBang]
<a name="line-806"></a>  If T was defined in this module, Without -O the dcr_bangs might be
<a name="line-807"></a>    [HsStrict, HsStrict, HsLazy]
<a name="line-808"></a>  With -O it might be
<a name="line-809"></a>    [HsStrict, HsUnpack _, HsLazy]
<a name="line-810"></a>  With -funbox-small-strict-fields it might be
<a name="line-811"></a>    [HsUnpack, HsUnpack _, HsLazy]
<a name="line-812"></a>  With -XStrictData it might be
<a name="line-813"></a>    [HsStrict, HsUnpack _, HsStrict]
<a name="line-814"></a>
<a name="line-815"></a>Note [Data con representation]
<a name="line-816"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-817"></a>The dcRepType field contains the type of the representation of a constructor
<a name="line-818"></a>This may differ from the type of the constructor *Id* (built
<a name="line-819"></a>by MkId.mkDataConId) for two reasons:
<a name="line-820"></a>        a) the constructor Id may be overloaded, but the dictionary isn't stored
<a name="line-821"></a>           e.g.    data Eq a =&gt; T a = MkT a a
<a name="line-822"></a>
<a name="line-823"></a>        b) the constructor may store an unboxed version of a strict field.
<a name="line-824"></a>
<a name="line-825"></a>Here's an example illustrating both:
<a name="line-826"></a>        data Ord a =&gt; T a = MkT Int! a
<a name="line-827"></a>Here
<a name="line-828"></a>        T :: Ord a =&gt; Int -&gt; a -&gt; T a
<a name="line-829"></a>but the rep type is
<a name="line-830"></a>        Trep :: Int# -&gt; a -&gt; T a
<a name="line-831"></a>Actually, the unboxed part isn't implemented yet!
<a name="line-832"></a>
<a name="line-833"></a>
<a name="line-834"></a>
<a name="line-835"></a>************************************************************************
<a name="line-836"></a>*                                                                      *
<a name="line-837"></a>\subsection{Instances}
<a name="line-838"></a>*                                                                      *
<a name="line-839"></a>************************************************************************
<a name="line-840"></a>-}</span>
<a name="line-841"></a>
<a name="line-842"></a><a name="instance%20Eq%20DataCon"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyword'>where</span>
<a name="line-843"></a>    <span class='hs-varid'>a</span> <span class='hs-varop'>==</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUnique</span> <span class='hs-varid'>a</span> <span class='hs-varop'>==</span> <span class='hs-varid'>getUnique</span> <span class='hs-varid'>b</span>
<a name="line-844"></a>    <span class='hs-varid'>a</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUnique</span> <span class='hs-varid'>a</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>getUnique</span> <span class='hs-varid'>b</span>
<a name="line-845"></a>
<a name="line-846"></a><a name="instance%20Uniquable%20DataCon"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Uniquable</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyword'>where</span>
<a name="line-847"></a>    <span class='hs-varid'>getUnique</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dcUnique</span>
<a name="line-848"></a>
<a name="line-849"></a><a name="instance%20NamedThing%20DataCon"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>NamedThing</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyword'>where</span>
<a name="line-850"></a>    <span class='hs-varid'>getName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dcName</span>
<a name="line-851"></a>
<a name="line-852"></a><a name="instance%20Outputable%20DataCon"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyword'>where</span>
<a name="line-853"></a>    <span class='hs-varid'>ppr</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConName</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-854"></a>
<a name="line-855"></a><a name="instance%20OutputableBndr%20DataCon"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>OutputableBndr</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyword'>where</span>
<a name="line-856"></a>    <span class='hs-varid'>pprInfixOcc</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprInfixName</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConName</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-857"></a>    <span class='hs-varid'>pprPrefixOcc</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixName</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConName</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-858"></a>
<a name="line-859"></a><a name="instance%20Data.Data%20DataCon"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Data.Data</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyword'>where</span>
<a name="line-860"></a>    <span class='hs-comment'>-- don't traverse?</span>
<a name="line-861"></a>    <span class='hs-varid'>toConstr</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>abstractConstr</span> <span class='hs-str'>"DataCon"</span>
<a name="line-862"></a>    <span class='hs-varid'>gunfold</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"gunfold"</span>
<a name="line-863"></a>    <span class='hs-varid'>dataTypeOf</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNoRepType</span> <span class='hs-str'>"DataCon"</span>
<a name="line-864"></a>
<a name="line-865"></a><a name="instance%20Outputable%20HsSrcBang"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>HsSrcBang</span> <span class='hs-keyword'>where</span>
<a name="line-866"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSrcBang</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>prag</span> <span class='hs-varid'>mark</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>prag</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mark</span>
<a name="line-867"></a>
<a name="line-868"></a><a name="instance%20Outputable%20HsImplBang"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>HsImplBang</span> <span class='hs-keyword'>where</span>
<a name="line-869"></a>    <span class='hs-varid'>ppr</span> <span class='hs-conid'>HsLazy</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Lazy"</span>
<a name="line-870"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnpack</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Unpacked"</span>
<a name="line-871"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnpack</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Unpacked"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-872"></a>    <span class='hs-varid'>ppr</span> <span class='hs-conid'>HsStrict</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"StrictNotUnpacked"</span>
<a name="line-873"></a>
<a name="line-874"></a><a name="instance%20Outputable%20SrcStrictness"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>SrcStrictness</span> <span class='hs-keyword'>where</span>
<a name="line-875"></a>    <span class='hs-varid'>ppr</span> <span class='hs-conid'>SrcLazy</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'~'</span>
<a name="line-876"></a>    <span class='hs-varid'>ppr</span> <span class='hs-conid'>SrcStrict</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'!'</span>
<a name="line-877"></a>    <span class='hs-varid'>ppr</span> <span class='hs-conid'>NoSrcStrict</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-878"></a>
<a name="line-879"></a><a name="instance%20Outputable%20SrcUnpackedness"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>SrcUnpackedness</span> <span class='hs-keyword'>where</span>
<a name="line-880"></a>    <span class='hs-varid'>ppr</span> <span class='hs-conid'>SrcUnpack</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"{-# UNPACK #-}"</span>
<a name="line-881"></a>    <span class='hs-varid'>ppr</span> <span class='hs-conid'>SrcNoUnpack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"{-# NOUNPACK #-}"</span>
<a name="line-882"></a>    <span class='hs-varid'>ppr</span> <span class='hs-conid'>NoSrcUnpack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-883"></a>
<a name="line-884"></a><a name="instance%20Outputable%20StrictnessMark"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>StrictnessMark</span> <span class='hs-keyword'>where</span>
<a name="line-885"></a>    <span class='hs-varid'>ppr</span> <span class='hs-conid'>MarkedStrict</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"!"</span>
<a name="line-886"></a>    <span class='hs-varid'>ppr</span> <span class='hs-conid'>NotMarkedStrict</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-887"></a>
<a name="line-888"></a><a name="instance%20Binary%20SrcStrictness"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>SrcStrictness</span> <span class='hs-keyword'>where</span>
<a name="line-889"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>SrcLazy</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>0</span>
<a name="line-890"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>SrcStrict</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span>
<a name="line-891"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>NoSrcStrict</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>2</span>
<a name="line-892"></a>
<a name="line-893"></a>    <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span>
<a name="line-894"></a>      <span class='hs-keyword'>do</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-895"></a>         <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span>
<a name="line-896"></a>           <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>SrcLazy</span>
<a name="line-897"></a>           <span class='hs-num'>1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>SrcStrict</span>
<a name="line-898"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>NoSrcStrict</span>
<a name="line-899"></a>
<a name="line-900"></a><a name="instance%20Binary%20SrcUnpackedness"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>SrcUnpackedness</span> <span class='hs-keyword'>where</span>
<a name="line-901"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>SrcNoUnpack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>0</span>
<a name="line-902"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>SrcUnpack</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span>
<a name="line-903"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>NoSrcUnpack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>2</span>
<a name="line-904"></a>
<a name="line-905"></a>    <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span>
<a name="line-906"></a>      <span class='hs-keyword'>do</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-907"></a>         <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span>
<a name="line-908"></a>           <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>SrcNoUnpack</span>
<a name="line-909"></a>           <span class='hs-num'>1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>SrcUnpack</span>
<a name="line-910"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>NoSrcUnpack</span>
<a name="line-911"></a>
<a name="line-912"></a><a name="eqHsBang"></a><span class='hs-comment'>-- | Compare strictness annotations</span>
<a name="line-913"></a><span class='hs-definition'>eqHsBang</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsImplBang</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsImplBang</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-914"></a><span class='hs-definition'>eqHsBang</span> <span class='hs-conid'>HsLazy</span>               <span class='hs-conid'>HsLazy</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-915"></a><span class='hs-definition'>eqHsBang</span> <span class='hs-conid'>HsStrict</span>             <span class='hs-conid'>HsStrict</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-916"></a><span class='hs-definition'>eqHsBang</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnpack</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>   <span class='hs-layout'>(</span><span class='hs-conid'>HsUnpack</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-917"></a><span class='hs-definition'>eqHsBang</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnpack</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>c1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnpack</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-918"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqType</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionType</span> <span class='hs-varid'>c1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionType</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span>
<a name="line-919"></a><span class='hs-definition'>eqHsBang</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                                       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-920"></a>
<a name="line-921"></a><a name="isBanged"></a><span class='hs-definition'>isBanged</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsImplBang</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-922"></a><span class='hs-definition'>isBanged</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnpack</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-923"></a><span class='hs-definition'>isBanged</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsStrict</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-924"></a><span class='hs-definition'>isBanged</span> <span class='hs-conid'>HsLazy</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-925"></a>
<a name="line-926"></a><a name="isSrcStrict"></a><span class='hs-definition'>isSrcStrict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcStrictness</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-927"></a><span class='hs-definition'>isSrcStrict</span> <span class='hs-conid'>SrcStrict</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-928"></a><span class='hs-definition'>isSrcStrict</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-929"></a>
<a name="line-930"></a><a name="isSrcUnpacked"></a><span class='hs-definition'>isSrcUnpacked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcUnpackedness</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-931"></a><span class='hs-definition'>isSrcUnpacked</span> <span class='hs-conid'>SrcUnpack</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-932"></a><span class='hs-definition'>isSrcUnpacked</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-933"></a>
<a name="line-934"></a><a name="isMarkedStrict"></a><span class='hs-definition'>isMarkedStrict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictnessMark</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-935"></a><span class='hs-definition'>isMarkedStrict</span> <span class='hs-conid'>NotMarkedStrict</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-936"></a><span class='hs-definition'>isMarkedStrict</span> <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>   <span class='hs-comment'>-- All others are strict</span>
<a name="line-937"></a>
<a name="line-938"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-939"></a>*                                                                      *
<a name="line-940"></a>\subsection{Construction}
<a name="line-941"></a>*                                                                      *
<a name="line-942"></a>********************************************************************* -}</span>
<a name="line-943"></a>
<a name="line-944"></a><a name="mkDataCon"></a><span class='hs-comment'>-- | Build a new data constructor</span>
<a name="line-945"></a><span class='hs-definition'>mkDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>
<a name="line-946"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>           <span class='hs-comment'>-- ^ Is the constructor declared infix?</span>
<a name="line-947"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConRepName</span>   <span class='hs-comment'>-- ^  TyConRepName for the promoted TyCon</span>
<a name="line-948"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>HsSrcBang</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- ^ Strictness/unpack annotations, from user</span>
<a name="line-949"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FieldLabel</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- ^ Field labels for the constructor,</span>
<a name="line-950"></a>                            <span class='hs-comment'>-- if it is a record, otherwise empty</span>
<a name="line-951"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- ^ Universals.</span>
<a name="line-952"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- ^ Existentials.</span>
<a name="line-953"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InvisTVBinder</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- ^ User-written 'TyVarBinder's.</span>
<a name="line-954"></a>                                <span class='hs-comment'>--   These must be Inferred/Specified.</span>
<a name="line-955"></a>                                <span class='hs-comment'>--   See @Note [TyVarBinders in DataCons]@</span>
<a name="line-956"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EqSpec</span><span class='hs-keyglyph'>]</span>           <span class='hs-comment'>-- ^ GADT equalities</span>
<a name="line-957"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>KnotTied</span> <span class='hs-conid'>ThetaType</span> <span class='hs-comment'>-- ^ Theta-type occurring before the arguments proper</span>
<a name="line-958"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>KnotTied</span> <span class='hs-layout'>(</span><span class='hs-conid'>Scaled</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- ^ Original argument types</span>
<a name="line-959"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>KnotTied</span> <span class='hs-conid'>Type</span>      <span class='hs-comment'>-- ^ Original result type</span>
<a name="line-960"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RuntimeRepInfo</span>     <span class='hs-comment'>-- ^ See comments on 'GHC.Core.TyCon.RuntimeRepInfo'</span>
<a name="line-961"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>KnotTied</span> <span class='hs-conid'>TyCon</span>     <span class='hs-comment'>-- ^ Representation type constructor</span>
<a name="line-962"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ConTag</span>             <span class='hs-comment'>-- ^ Constructor tag</span>
<a name="line-963"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span>          <span class='hs-comment'>-- ^ The "stupid theta", context of the data</span>
<a name="line-964"></a>                                <span class='hs-comment'>-- declaration e.g. @data Eq a =&gt; T a ...@</span>
<a name="line-965"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>                 <span class='hs-comment'>-- ^ Worker Id</span>
<a name="line-966"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataConRep</span>         <span class='hs-comment'>-- ^ Representation</span>
<a name="line-967"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span>
<a name="line-968"></a>  <span class='hs-comment'>-- Can get the tag from the TyCon</span>
<a name="line-969"></a>
<a name="line-970"></a><span class='hs-definition'>mkDataCon</span> <span class='hs-varid'>name</span> <span class='hs-varid'>declared_infix</span> <span class='hs-varid'>prom_info</span>
<a name="line-971"></a>          <span class='hs-varid'>arg_stricts</span>   <span class='hs-comment'>-- Must match orig_arg_tys 1-1</span>
<a name="line-972"></a>          <span class='hs-varid'>fields</span>
<a name="line-973"></a>          <span class='hs-varid'>univ_tvs</span> <span class='hs-varid'>ex_tvs</span> <span class='hs-varid'>user_tvbs</span>
<a name="line-974"></a>          <span class='hs-varid'>eq_spec</span> <span class='hs-varid'>theta</span>
<a name="line-975"></a>          <span class='hs-varid'>orig_arg_tys</span> <span class='hs-varid'>orig_res_ty</span> <span class='hs-varid'>rep_info</span> <span class='hs-varid'>rep_tycon</span> <span class='hs-varid'>tag</span>
<a name="line-976"></a>          <span class='hs-varid'>stupid_theta</span> <span class='hs-varid'>work_id</span> <span class='hs-varid'>rep</span>
<a name="line-977"></a><span class='hs-comment'>-- Warning: mkDataCon is not a good place to check certain invariants.</span>
<a name="line-978"></a><span class='hs-comment'>-- If the programmer writes the wrong result type in the decl, thus:</span>
<a name="line-979"></a><span class='hs-comment'>--      data T a where { MkT :: S }</span>
<a name="line-980"></a><span class='hs-comment'>-- then it's possible that the univ_tvs may hit an assertion failure</span>
<a name="line-981"></a><span class='hs-comment'>-- if you pull on univ_tvs.  This case is checked by checkValidDataCon,</span>
<a name="line-982"></a><span class='hs-comment'>-- so the error is detected properly... it's just that assertions here</span>
<a name="line-983"></a><span class='hs-comment'>-- are a little dodgy.</span>
<a name="line-984"></a>
<a name="line-985"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con</span>
<a name="line-986"></a>  <span class='hs-keyword'>where</span>
<a name="line-987"></a>    <span class='hs-varid'>is_vanilla</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>null</span> <span class='hs-varid'>ex_tvs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>eq_spec</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>theta</span>
<a name="line-988"></a>
<a name="line-989"></a>    <span class='hs-varid'>con</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span><span class='hs-varid'>dcName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>dcUnique</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameUnique</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span>
<a name="line-990"></a>                  <span class='hs-varid'>dcVanilla</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_vanilla</span><span class='hs-layout'>,</span> <span class='hs-varid'>dcInfix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>declared_infix</span><span class='hs-layout'>,</span>
<a name="line-991"></a>                  <span class='hs-varid'>dcUnivTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span>
<a name="line-992"></a>                  <span class='hs-varid'>dcExTyCoVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span>
<a name="line-993"></a>                  <span class='hs-varid'>dcUserTyVarBinders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>user_tvbs</span><span class='hs-layout'>,</span>
<a name="line-994"></a>                  <span class='hs-varid'>dcEqSpec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq_spec</span><span class='hs-layout'>,</span>
<a name="line-995"></a>                  <span class='hs-varid'>dcOtherTheta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span>
<a name="line-996"></a>                  <span class='hs-varid'>dcStupidTheta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stupid_theta</span><span class='hs-layout'>,</span>
<a name="line-997"></a>                  <span class='hs-varid'>dcOrigArgTys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orig_arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>dcOrigResTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orig_res_ty</span><span class='hs-layout'>,</span>
<a name="line-998"></a>                  <span class='hs-varid'>dcRepTyCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rep_tycon</span><span class='hs-layout'>,</span>
<a name="line-999"></a>                  <span class='hs-varid'>dcSrcBangs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_stricts</span><span class='hs-layout'>,</span>
<a name="line-1000"></a>                  <span class='hs-varid'>dcFields</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fields</span><span class='hs-layout'>,</span> <span class='hs-varid'>dcTag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tag</span><span class='hs-layout'>,</span> <span class='hs-varid'>dcRepType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rep_ty</span><span class='hs-layout'>,</span>
<a name="line-1001"></a>                  <span class='hs-varid'>dcWorkId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>work_id</span><span class='hs-layout'>,</span>
<a name="line-1002"></a>                  <span class='hs-varid'>dcRep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rep</span><span class='hs-layout'>,</span>
<a name="line-1003"></a>                  <span class='hs-varid'>dcSourceArity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>orig_arg_tys</span><span class='hs-layout'>,</span>
<a name="line-1004"></a>                  <span class='hs-varid'>dcRepArity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>rep_arg_tys</span> <span class='hs-varop'>+</span> <span class='hs-varid'>count</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span>
<a name="line-1005"></a>                  <span class='hs-varid'>dcPromoted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>promoted</span> <span class='hs-layout'>}</span>
<a name="line-1006"></a>
<a name="line-1007"></a>        <span class='hs-comment'>-- The 'arg_stricts' passed to mkDataCon are simply those for the</span>
<a name="line-1008"></a>        <span class='hs-comment'>-- source-language arguments.  We add extra ones for the</span>
<a name="line-1009"></a>        <span class='hs-comment'>-- dictionary arguments right here.</span>
<a name="line-1010"></a>
<a name="line-1011"></a>    <span class='hs-varid'>rep_arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConRepArgTys</span> <span class='hs-varid'>con</span>
<a name="line-1012"></a>
<a name="line-1013"></a>    <span class='hs-varid'>rep_ty</span> <span class='hs-keyglyph'>=</span>
<a name="line-1014"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>rep</span> <span class='hs-keyword'>of</span>
<a name="line-1015"></a>        <span class='hs-comment'>-- If the DataCon has no wrapper, then the worker's type *is* the</span>
<a name="line-1016"></a>        <span class='hs-comment'>-- user-facing type, so we can simply use dataConWrapperType.</span>
<a name="line-1017"></a>        <span class='hs-conid'>NoDataConRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>dataConWrapperType</span> <span class='hs-varid'>con</span>
<a name="line-1018"></a>        <span class='hs-comment'>-- If the DataCon has a wrapper, then the worker's type is never seen</span>
<a name="line-1019"></a>        <span class='hs-comment'>-- by the user. The visibilities we pick do not matter here.</span>
<a name="line-1020"></a>        <span class='hs-conid'>DCR</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkInfForAllTys</span> <span class='hs-varid'>univ_tvs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTyCoInvForAllTys</span> <span class='hs-varid'>ex_tvs</span> <span class='hs-varop'>$</span>
<a name="line-1021"></a>                 <span class='hs-varid'>mkVisFunTys</span> <span class='hs-varid'>rep_arg_tys</span> <span class='hs-varop'>$</span>
<a name="line-1022"></a>                 <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>rep_tycon</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>univ_tvs</span><span class='hs-layout'>)</span>
<a name="line-1023"></a>
<a name="line-1024"></a>      <span class='hs-comment'>-- See Note [Promoted data constructors] in GHC.Core.TyCon</span>
<a name="line-1025"></a>    <span class='hs-varid'>prom_tv_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mkNamedTyConBinder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Invisible</span> <span class='hs-varid'>spec</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span>
<a name="line-1026"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>spec</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>user_tvbs</span> <span class='hs-keyglyph'>]</span>
<a name="line-1027"></a>
<a name="line-1028"></a>    <span class='hs-varid'>fresh_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>freshNames</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>user_tvbs</span><span class='hs-layout'>)</span>
<a name="line-1029"></a>      <span class='hs-comment'>-- fresh_names: make sure that the "anonymous" tyvars don't</span>
<a name="line-1030"></a>      <span class='hs-comment'>-- clash in name or unique with the universal/existential ones.</span>
<a name="line-1031"></a>      <span class='hs-comment'>-- Tiresome!  And unnecessary because these tyvars are never looked at</span>
<a name="line-1032"></a>    <span class='hs-varid'>prom_theta_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mkAnonTyConBinder</span> <span class='hs-conid'>InvisArg</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-1033"></a>     <span class='hs-comment'>{- Invisible -}</span>   <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fresh_names</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>]</span>
<a name="line-1034"></a>    <span class='hs-varid'>prom_arg_bndrs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mkAnonTyConBinder</span> <span class='hs-conid'>VisArg</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-1035"></a>     <span class='hs-comment'>{- Visible -}</span>     <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dropList</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>fresh_names</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>map</span> <span class='hs-varid'>scaledThing</span> <span class='hs-varid'>orig_arg_tys</span> <span class='hs-keyglyph'>]</span>
<a name="line-1036"></a>    <span class='hs-varid'>prom_bndrs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prom_tv_bndrs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>prom_theta_bndrs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>prom_arg_bndrs</span>
<a name="line-1037"></a>    <span class='hs-varid'>prom_res_kind</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orig_res_ty</span>
<a name="line-1038"></a>    <span class='hs-varid'>promoted</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPromotedDataCon</span> <span class='hs-varid'>con</span> <span class='hs-varid'>name</span> <span class='hs-varid'>prom_info</span> <span class='hs-varid'>prom_bndrs</span>
<a name="line-1039"></a>                                         <span class='hs-varid'>prom_res_kind</span> <span class='hs-varid'>roles</span> <span class='hs-varid'>rep_info</span>
<a name="line-1040"></a>
<a name="line-1041"></a>    <span class='hs-varid'>roles</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>tv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>Nominal</span> <span class='hs-keyword'>else</span> <span class='hs-conid'>Phantom</span><span class='hs-layout'>)</span>
<a name="line-1042"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>univ_tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>)</span>
<a name="line-1043"></a>            <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>Representational</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>theta</span> <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-varid'>scaledThing</span> <span class='hs-varid'>orig_arg_tys</span><span class='hs-layout'>)</span>
<a name="line-1044"></a>
<a name="line-1045"></a><a name="freshNames"></a><span class='hs-definition'>freshNames</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-1046"></a><span class='hs-comment'>-- Make an infinite list of Names whose Uniques and OccNames</span>
<a name="line-1047"></a><span class='hs-comment'>-- differ from those in the 'avoid' list</span>
<a name="line-1048"></a><span class='hs-definition'>freshNames</span> <span class='hs-varid'>avoids</span>
<a name="line-1049"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mkSystemName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>occ</span>
<a name="line-1050"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span>
<a name="line-1051"></a>    <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAlphaTyVarUnique</span> <span class='hs-varid'>n</span>
<a name="line-1052"></a>          <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarOccFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFastString</span> <span class='hs-layout'>(</span><span class='hs-chr'>'x'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1053"></a>
<a name="line-1054"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>uniq</span> <span class='hs-varop'>`elementOfUniqSet`</span> <span class='hs-varid'>avoid_uniqs</span><span class='hs-layout'>)</span>
<a name="line-1055"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>occ</span> <span class='hs-varop'>`elemOccSet`</span> <span class='hs-varid'>avoid_occs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-1056"></a>
<a name="line-1057"></a>  <span class='hs-keyword'>where</span>
<a name="line-1058"></a>    <span class='hs-varid'>avoid_uniqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqSet</span> <span class='hs-conid'>Unique</span>
<a name="line-1059"></a>    <span class='hs-varid'>avoid_uniqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUniqSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>getUnique</span> <span class='hs-varid'>avoids</span><span class='hs-layout'>)</span>
<a name="line-1060"></a>
<a name="line-1061"></a>    <span class='hs-varid'>avoid_occs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccSet</span>
<a name="line-1062"></a>    <span class='hs-varid'>avoid_occs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOccSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>avoids</span><span class='hs-layout'>)</span>
<a name="line-1063"></a>
<a name="line-1064"></a><a name="dataConName"></a><span class='hs-comment'>-- | The 'Name' of the 'DataCon', giving it a unique, rooted identification</span>
<a name="line-1065"></a><span class='hs-definition'>dataConName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-1066"></a><span class='hs-definition'>dataConName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dcName</span>
<a name="line-1067"></a>
<a name="line-1068"></a><a name="dataConTag"></a><span class='hs-comment'>-- | The tag used for ordering 'DataCon's</span>
<a name="line-1069"></a><span class='hs-definition'>dataConTag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ConTag</span>
<a name="line-1070"></a><span class='hs-definition'>dataConTag</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dcTag</span>
<a name="line-1071"></a>
<a name="line-1072"></a><a name="dataConTagZ"></a><span class='hs-definition'>dataConTagZ</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ConTagZ</span>
<a name="line-1073"></a><span class='hs-definition'>dataConTagZ</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConTag</span> <span class='hs-varid'>con</span> <span class='hs-comment'>-</span> <span class='hs-varid'>fIRST_TAG</span>
<a name="line-1074"></a>
<a name="line-1075"></a><a name="dataConTyCon"></a><span class='hs-comment'>-- | The type constructor that we are building via this data constructor</span>
<a name="line-1076"></a><span class='hs-definition'>dataConTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span>
<a name="line-1077"></a><span class='hs-definition'>dataConTyCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dcRepTyCon</span>
<a name="line-1078"></a>
<a name="line-1079"></a><a name="dataConOrigTyCon"></a><span class='hs-comment'>-- | The original type constructor used in the definition of this data</span>
<a name="line-1080"></a><span class='hs-comment'>-- constructor.  In case of a data family instance, that will be the family</span>
<a name="line-1081"></a><span class='hs-comment'>-- type constructor.</span>
<a name="line-1082"></a><span class='hs-definition'>dataConOrigTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span>
<a name="line-1083"></a><span class='hs-definition'>dataConOrigTyCon</span> <span class='hs-varid'>dc</span>
<a name="line-1084"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConFamInst_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>dcRepTyCon</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span>
<a name="line-1085"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dcRepTyCon</span> <span class='hs-varid'>dc</span>
<a name="line-1086"></a>
<a name="line-1087"></a><a name="dataConRepType"></a><span class='hs-comment'>-- | The representation type of the data constructor, i.e. the sort</span>
<a name="line-1088"></a><span class='hs-comment'>-- type that will represent values of this type at runtime</span>
<a name="line-1089"></a><span class='hs-definition'>dataConRepType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1090"></a><span class='hs-definition'>dataConRepType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dcRepType</span>
<a name="line-1091"></a>
<a name="line-1092"></a><a name="dataConIsInfix"></a><span class='hs-comment'>-- | Should the 'DataCon' be presented infix?</span>
<a name="line-1093"></a><span class='hs-definition'>dataConIsInfix</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1094"></a><span class='hs-definition'>dataConIsInfix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dcInfix</span>
<a name="line-1095"></a>
<a name="line-1096"></a><a name="dataConUnivTyVars"></a><span class='hs-comment'>-- | The universally-quantified type variables of the constructor</span>
<a name="line-1097"></a><span class='hs-definition'>dataConUnivTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1098"></a><span class='hs-definition'>dataConUnivTyVars</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcUnivTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvbs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvbs</span>
<a name="line-1099"></a>
<a name="line-1100"></a><a name="dataConExTyCoVars"></a><span class='hs-comment'>-- | The existentially-quantified type/coercion variables of the constructor</span>
<a name="line-1101"></a><span class='hs-comment'>-- including dependent (kind-) GADT equalities</span>
<a name="line-1102"></a><span class='hs-definition'>dataConExTyCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1103"></a><span class='hs-definition'>dataConExTyCoVars</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcExTyCoVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvbs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvbs</span>
<a name="line-1104"></a>
<a name="line-1105"></a><a name="dataConUnivAndExTyCoVars"></a><span class='hs-comment'>-- | Both the universal and existential type/coercion variables of the constructor</span>
<a name="line-1106"></a><span class='hs-definition'>dataConUnivAndExTyCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1107"></a><span class='hs-definition'>dataConUnivAndExTyCoVars</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcUnivTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>dcExTyCoVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ex_tvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1108"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>univ_tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ex_tvs</span>
<a name="line-1109"></a>
<a name="line-1110"></a><a name="dataConUserTyVars"></a><span class='hs-comment'>-- See Note [DataCon user type variable binders]</span>
<a name="line-1111"></a><span class='hs-comment'>-- | The type variables of the constructor, in the order the user wrote them</span>
<a name="line-1112"></a><span class='hs-definition'>dataConUserTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1113"></a><span class='hs-definition'>dataConUserTyVars</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcUserTyVarBinders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvbs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binderVars</span> <span class='hs-varid'>tvbs</span>
<a name="line-1114"></a>
<a name="line-1115"></a><a name="dataConUserTyVarBinders"></a><span class='hs-comment'>-- See Note [DataCon user type variable binders]</span>
<a name="line-1116"></a><span class='hs-comment'>-- | 'InvisTVBinder's for the type variables of the constructor, in the order the</span>
<a name="line-1117"></a><span class='hs-comment'>-- user wrote them</span>
<a name="line-1118"></a><span class='hs-definition'>dataConUserTyVarBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InvisTVBinder</span><span class='hs-keyglyph'>]</span>
<a name="line-1119"></a><span class='hs-definition'>dataConUserTyVarBinders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dcUserTyVarBinders</span>
<a name="line-1120"></a>
<a name="line-1121"></a><a name="dataConEqSpec"></a><span class='hs-comment'>-- | Equalities derived from the result type of the data constructor, as written</span>
<a name="line-1122"></a><span class='hs-comment'>-- by the programmer in any GADT declaration. This includes *all* GADT-like</span>
<a name="line-1123"></a><span class='hs-comment'>-- equalities, including those written in by hand by the programmer.</span>
<a name="line-1124"></a><span class='hs-definition'>dataConEqSpec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EqSpec</span><span class='hs-keyglyph'>]</span>
<a name="line-1125"></a><span class='hs-definition'>dataConEqSpec</span> <span class='hs-varid'>con</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcEqSpec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq_spec</span><span class='hs-layout'>,</span> <span class='hs-varid'>dcOtherTheta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>theta</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1126"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConKindEqSpec</span> <span class='hs-varid'>con</span>
<a name="line-1127"></a>    <span class='hs-varop'>++</span> <span class='hs-varid'>eq_spec</span> <span class='hs-varop'>++</span>
<a name="line-1128"></a>    <span class='hs-keyglyph'>[</span> <span class='hs-varid'>spec</span>   <span class='hs-comment'>-- heterogeneous equality</span>
<a name="line-1129"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-sel'>_k1</span><span class='hs-layout'>,</span> <span class='hs-sel'>_k2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>map</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>theta</span>
<a name="line-1130"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>heqTyConKey</span>
<a name="line-1131"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>spec</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>getTyVar_maybe</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTyVar_maybe</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1132"></a>                    <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkEqSpec</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-1133"></a>                    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkEqSpec</span> <span class='hs-varid'>tv2</span> <span class='hs-varid'>ty1</span><span class='hs-keyglyph'>]</span>
<a name="line-1134"></a>                    <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-1135"></a>    <span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span>
<a name="line-1136"></a>    <span class='hs-keyglyph'>[</span> <span class='hs-varid'>spec</span>   <span class='hs-comment'>-- homogeneous equality</span>
<a name="line-1137"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-sel'>_k</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>map</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>theta</span>
<a name="line-1138"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqTyConKey</span>
<a name="line-1139"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>spec</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>getTyVar_maybe</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTyVar_maybe</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1140"></a>                    <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkEqSpec</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-1141"></a>                    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkEqSpec</span> <span class='hs-varid'>tv2</span> <span class='hs-varid'>ty1</span><span class='hs-keyglyph'>]</span>
<a name="line-1142"></a>                    <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-1143"></a>    <span class='hs-keyglyph'>]</span>
<a name="line-1144"></a>
<a name="line-1145"></a><a name="dataConKindEqSpec"></a><span class='hs-comment'>-- | Dependent (kind-level) equalities in a constructor.</span>
<a name="line-1146"></a><span class='hs-comment'>-- There are extracted from the existential variables.</span>
<a name="line-1147"></a><span class='hs-comment'>-- See Note [Existential coercion variables]</span>
<a name="line-1148"></a><span class='hs-definition'>dataConKindEqSpec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EqSpec</span><span class='hs-keyglyph'>]</span>
<a name="line-1149"></a><span class='hs-definition'>dataConKindEqSpec</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span><span class='hs-varid'>dcExTyCoVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ex_tcvs</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1150"></a>  <span class='hs-comment'>-- It is used in 'dataConEqSpec' (maybe also 'dataConFullSig' in the future),</span>
<a name="line-1151"></a>  <span class='hs-comment'>-- which are frequently used functions.</span>
<a name="line-1152"></a>  <span class='hs-comment'>-- For now (Aug 2018) this function always return empty set as we don't really</span>
<a name="line-1153"></a>  <span class='hs-comment'>-- have coercion variables.</span>
<a name="line-1154"></a>  <span class='hs-comment'>-- In the future when we do, we might want to cache this information in DataCon</span>
<a name="line-1155"></a>  <span class='hs-comment'>-- so it won't be computed every time when aforementioned functions are called.</span>
<a name="line-1156"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>EqSpec</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-1157"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ex_tcvs</span>
<a name="line-1158"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>cv</span>
<a name="line-1159"></a>    <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarKindsTypesRole</span> <span class='hs-varid'>cv</span>
<a name="line-1160"></a>          <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getTyVar</span> <span class='hs-str'>"dataConKindEqSpec"</span> <span class='hs-varid'>ty1</span>
<a name="line-1161"></a>    <span class='hs-keyglyph'>]</span>
<a name="line-1162"></a>
<a name="line-1163"></a><a name="dataConTheta"></a><span class='hs-comment'>-- | The *full* constraints on the constructor type, including dependent GADT</span>
<a name="line-1164"></a><span class='hs-comment'>-- equalities.</span>
<a name="line-1165"></a><span class='hs-definition'>dataConTheta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span>
<a name="line-1166"></a><span class='hs-definition'>dataConTheta</span> <span class='hs-varid'>con</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcEqSpec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq_spec</span><span class='hs-layout'>,</span> <span class='hs-varid'>dcOtherTheta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>theta</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1167"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqSpecPreds</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConKindEqSpec</span> <span class='hs-varid'>con</span> <span class='hs-varop'>++</span> <span class='hs-varid'>eq_spec</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-varid'>theta</span>
<a name="line-1168"></a>
<a name="line-1169"></a><a name="dataConWorkId"></a><span class='hs-comment'>-- | Get the Id of the 'DataCon' worker: a function that is the "actual"</span>
<a name="line-1170"></a><span class='hs-comment'>-- constructor and has no top level binding in the program. The type may</span>
<a name="line-1171"></a><span class='hs-comment'>-- be different from the obvious one written in the source program. Panics</span>
<a name="line-1172"></a><span class='hs-comment'>-- if there is no such 'Id' for this 'DataCon'</span>
<a name="line-1173"></a><span class='hs-definition'>dataConWorkId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-1174"></a><span class='hs-definition'>dataConWorkId</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dcWorkId</span> <span class='hs-varid'>dc</span>
<a name="line-1175"></a>
<a name="line-1176"></a><a name="dataConWrapId_maybe"></a><span class='hs-comment'>-- | Get the Id of the 'DataCon' wrapper: a function that wraps the "actual"</span>
<a name="line-1177"></a><span class='hs-comment'>-- constructor so it has the type visible in the source program: c.f.</span>
<a name="line-1178"></a><span class='hs-comment'>-- 'dataConWorkId'.</span>
<a name="line-1179"></a><span class='hs-comment'>-- Returns Nothing if there is no wrapper, which occurs for an algebraic data</span>
<a name="line-1180"></a><span class='hs-comment'>-- constructor and also for a newtype (whose constructor is inlined</span>
<a name="line-1181"></a><span class='hs-comment'>-- compulsorily)</span>
<a name="line-1182"></a><span class='hs-definition'>dataConWrapId_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Id</span>
<a name="line-1183"></a><span class='hs-definition'>dataConWrapId_maybe</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>dcRep</span> <span class='hs-varid'>dc</span> <span class='hs-keyword'>of</span>
<a name="line-1184"></a>                           <span class='hs-conid'>NoDataConRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1185"></a>                           <span class='hs-conid'>DCR</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcr_wrap_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrap_id</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>wrap_id</span>
<a name="line-1186"></a>
<a name="line-1187"></a><a name="dataConWrapId"></a><span class='hs-comment'>-- | Returns an Id which looks like the Haskell-source constructor by using</span>
<a name="line-1188"></a><span class='hs-comment'>-- the wrapper if it exists (see 'dataConWrapId_maybe') and failing over to</span>
<a name="line-1189"></a><span class='hs-comment'>-- the worker (see 'dataConWorkId')</span>
<a name="line-1190"></a><span class='hs-definition'>dataConWrapId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-1191"></a><span class='hs-definition'>dataConWrapId</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>dcRep</span> <span class='hs-varid'>dc</span> <span class='hs-keyword'>of</span>
<a name="line-1192"></a>                     <span class='hs-conid'>NoDataConRep</span><span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>dcWorkId</span> <span class='hs-varid'>dc</span>    <span class='hs-comment'>-- worker=wrapper</span>
<a name="line-1193"></a>                     <span class='hs-conid'>DCR</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcr_wrap_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrap_id</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrap_id</span>
<a name="line-1194"></a>
<a name="line-1195"></a><a name="dataConImplicitTyThings"></a><span class='hs-comment'>-- | Find all the 'Id's implicitly brought into scope by the data constructor. Currently,</span>
<a name="line-1196"></a><span class='hs-comment'>-- the union of the 'dataConWorkId' and the 'dataConWrapId'</span>
<a name="line-1197"></a><span class='hs-definition'>dataConImplicitTyThings</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyThing</span><span class='hs-keyglyph'>]</span>
<a name="line-1198"></a><span class='hs-definition'>dataConImplicitTyThings</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcWorkId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>work</span><span class='hs-layout'>,</span> <span class='hs-varid'>dcRep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rep</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1199"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkAnId</span> <span class='hs-varid'>work</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span> <span class='hs-varid'>wrap_ids</span>
<a name="line-1200"></a>  <span class='hs-keyword'>where</span>
<a name="line-1201"></a>    <span class='hs-varid'>wrap_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>rep</span> <span class='hs-keyword'>of</span>
<a name="line-1202"></a>                 <span class='hs-conid'>NoDataConRep</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-1203"></a>                 <span class='hs-conid'>DCR</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcr_wrap_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrap</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkAnId</span> <span class='hs-varid'>wrap</span><span class='hs-keyglyph'>]</span>
<a name="line-1204"></a>
<a name="line-1205"></a><a name="dataConFieldLabels"></a><span class='hs-comment'>-- | The labels for the fields of this particular 'DataCon'</span>
<a name="line-1206"></a><span class='hs-definition'>dataConFieldLabels</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FieldLabel</span><span class='hs-keyglyph'>]</span>
<a name="line-1207"></a><span class='hs-definition'>dataConFieldLabels</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dcFields</span>
<a name="line-1208"></a>
<a name="line-1209"></a><a name="dataConFieldType"></a><span class='hs-comment'>-- | Extract the type for any given labelled field of the 'DataCon'</span>
<a name="line-1210"></a><span class='hs-definition'>dataConFieldType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FieldLabelString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1211"></a><span class='hs-definition'>dataConFieldType</span> <span class='hs-varid'>con</span> <span class='hs-varid'>label</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>dataConFieldType_maybe</span> <span class='hs-varid'>con</span> <span class='hs-varid'>label</span> <span class='hs-keyword'>of</span>
<a name="line-1212"></a>      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ty</span>
<a name="line-1213"></a>      <span class='hs-conid'>Nothing</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"dataConFieldType"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>con</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>label</span><span class='hs-layout'>)</span>
<a name="line-1214"></a>
<a name="line-1215"></a><a name="dataConFieldType_maybe"></a><span class='hs-comment'>-- | Extract the label and type for any given labelled field of the</span>
<a name="line-1216"></a><span class='hs-comment'>-- 'DataCon', or return 'Nothing' if the field does not belong to it</span>
<a name="line-1217"></a><span class='hs-definition'>dataConFieldType_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FieldLabelString</span>
<a name="line-1218"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldLabel</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1219"></a><span class='hs-definition'>dataConFieldType_maybe</span> <span class='hs-varid'>con</span> <span class='hs-varid'>label</span>
<a name="line-1220"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>find</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>==</span> <span class='hs-varid'>label</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>flLabel</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dcFields</span> <span class='hs-varid'>con</span> <span class='hs-varop'>`zip`</span> <span class='hs-layout'>(</span><span class='hs-varid'>scaledThing</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>dcOrigArgTys</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1221"></a>
<a name="line-1222"></a><span class='hs-comment'>-- | Strictness/unpack annotations, from user; or, for imported</span>
<a name="line-1223"></a><span class='hs-comment'>-- DataCons, from the interface file</span>
<a name="line-1224"></a><span class='hs-comment'>-- The list is in one-to-one correspondence with the arity of the 'DataCon'</span>
<a name="line-1225"></a>
<a name="line-1226"></a><a name="dataConSrcBangs"></a><span class='hs-definition'>dataConSrcBangs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>HsSrcBang</span><span class='hs-keyglyph'>]</span>
<a name="line-1227"></a><span class='hs-definition'>dataConSrcBangs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dcSrcBangs</span>
<a name="line-1228"></a>
<a name="line-1229"></a><a name="dataConSourceArity"></a><span class='hs-comment'>-- | Source-level arity of the data constructor</span>
<a name="line-1230"></a><span class='hs-definition'>dataConSourceArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-1231"></a><span class='hs-definition'>dataConSourceArity</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcSourceArity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arity</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arity</span>
<a name="line-1232"></a>
<a name="line-1233"></a><a name="dataConRepArity"></a><span class='hs-comment'>-- | Gives the number of actual fields in the /representation/ of the</span>
<a name="line-1234"></a><span class='hs-comment'>-- data constructor. This may be more than appear in the source code;</span>
<a name="line-1235"></a><span class='hs-comment'>-- the extra ones are the existentially quantified dictionaries</span>
<a name="line-1236"></a><span class='hs-definition'>dataConRepArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-1237"></a><span class='hs-definition'>dataConRepArity</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcRepArity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arity</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arity</span>
<a name="line-1238"></a>
<a name="line-1239"></a><a name="isNullarySrcDataCon"></a><span class='hs-comment'>-- | Return whether there are any argument types for this 'DataCon's original source type</span>
<a name="line-1240"></a><span class='hs-comment'>-- See Note [DataCon arities]</span>
<a name="line-1241"></a><span class='hs-definition'>isNullarySrcDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1242"></a><span class='hs-definition'>isNullarySrcDataCon</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConSourceArity</span> <span class='hs-varid'>dc</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>
<a name="line-1243"></a>
<a name="line-1244"></a><a name="isNullaryRepDataCon"></a><span class='hs-comment'>-- | Return whether there are any argument types for this 'DataCon's runtime representation type</span>
<a name="line-1245"></a><span class='hs-comment'>-- See Note [DataCon arities]</span>
<a name="line-1246"></a><span class='hs-definition'>isNullaryRepDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1247"></a><span class='hs-definition'>isNullaryRepDataCon</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConRepArity</span> <span class='hs-varid'>dc</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>
<a name="line-1248"></a>
<a name="line-1249"></a><a name="dataConRepStrictness"></a><span class='hs-definition'>dataConRepStrictness</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StrictnessMark</span><span class='hs-keyglyph'>]</span>
<a name="line-1250"></a><span class='hs-comment'>-- ^ Give the demands on the arguments of a</span>
<a name="line-1251"></a><span class='hs-comment'>-- Core constructor application (Con dc args)</span>
<a name="line-1252"></a><span class='hs-definition'>dataConRepStrictness</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>dcRep</span> <span class='hs-varid'>dc</span> <span class='hs-keyword'>of</span>
<a name="line-1253"></a>                            <span class='hs-conid'>NoDataConRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NotMarkedStrict</span> <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dataConRepArgTys</span> <span class='hs-varid'>dc</span><span class='hs-keyglyph'>]</span>
<a name="line-1254"></a>                            <span class='hs-conid'>DCR</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcr_stricts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>strs</span>
<a name="line-1255"></a>
<a name="line-1256"></a><a name="dataConImplBangs"></a><span class='hs-definition'>dataConImplBangs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>HsImplBang</span><span class='hs-keyglyph'>]</span>
<a name="line-1257"></a><span class='hs-comment'>-- The implementation decisions about the strictness/unpack of each</span>
<a name="line-1258"></a><span class='hs-comment'>-- source program argument to the data constructor</span>
<a name="line-1259"></a><span class='hs-definition'>dataConImplBangs</span> <span class='hs-varid'>dc</span>
<a name="line-1260"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>dcRep</span> <span class='hs-varid'>dc</span> <span class='hs-keyword'>of</span>
<a name="line-1261"></a>      <span class='hs-conid'>NoDataConRep</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>replicate</span> <span class='hs-layout'>(</span><span class='hs-varid'>dcSourceArity</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span> <span class='hs-conid'>HsLazy</span>
<a name="line-1262"></a>      <span class='hs-conid'>DCR</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcr_bangs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bangs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bangs</span>
<a name="line-1263"></a>
<a name="line-1264"></a><a name="dataConBoxer"></a><span class='hs-definition'>dataConBoxer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>DataConBoxer</span>
<a name="line-1265"></a><span class='hs-definition'>dataConBoxer</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcRep</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DCR</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcr_boxer</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boxer</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>boxer</span>
<a name="line-1266"></a><span class='hs-definition'>dataConBoxer</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1267"></a>
<a name="line-1268"></a><a name="dataConInstSig"></a><span class='hs-definition'>dataConInstSig</span>
<a name="line-1269"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span>
<a name="line-1270"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- Instantiate the *universal* tyvars with these types</span>
<a name="line-1271"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Return instantiated existentials</span>
<a name="line-1272"></a>                                     <span class='hs-comment'>-- theta and arg tys</span>
<a name="line-1273"></a><span class='hs-comment'>-- ^ Instantiate the universal tyvars of a data con,</span>
<a name="line-1274"></a><span class='hs-comment'>--   returning</span>
<a name="line-1275"></a><span class='hs-comment'>--     ( instantiated existentials</span>
<a name="line-1276"></a><span class='hs-comment'>--     , instantiated constraints including dependent GADT equalities</span>
<a name="line-1277"></a><span class='hs-comment'>--         which are *also* listed in the instantiated existentials</span>
<a name="line-1278"></a><span class='hs-comment'>--     , instantiated args)</span>
<a name="line-1279"></a><span class='hs-definition'>dataConInstSig</span> <span class='hs-varid'>con</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcUnivTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>dcExTyCoVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ex_tvs</span>
<a name="line-1280"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>dcOrigArgTys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1281"></a>               <span class='hs-varid'>univ_tys</span>
<a name="line-1282"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-varid'>ex_tvs'</span>
<a name="line-1283"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>substTheta</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConTheta</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-1284"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>substTys</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>scaledThing</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1285"></a>  <span class='hs-keyword'>where</span>
<a name="line-1286"></a>    <span class='hs-varid'>univ_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipTvSubst</span> <span class='hs-varid'>univ_tvs</span> <span class='hs-varid'>univ_tys</span>
<a name="line-1287"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type.substVarBndrs</span> <span class='hs-varid'>univ_subst</span> <span class='hs-varid'>ex_tvs</span>
<a name="line-1288"></a>
<a name="line-1289"></a>
<a name="line-1290"></a><a name="dataConFullSig"></a><span class='hs-comment'>-- | The \"full signature\" of the 'DataCon' returns, in order:</span>
<a name="line-1291"></a><span class='hs-comment'>--</span>
<a name="line-1292"></a><span class='hs-comment'>-- 1) The result of 'dataConUnivTyVars'</span>
<a name="line-1293"></a><span class='hs-comment'>--</span>
<a name="line-1294"></a><span class='hs-comment'>-- 2) The result of 'dataConExTyCoVars'</span>
<a name="line-1295"></a><span class='hs-comment'>--</span>
<a name="line-1296"></a><span class='hs-comment'>-- 3) The non-dependent GADT equalities.</span>
<a name="line-1297"></a><span class='hs-comment'>--    Dependent GADT equalities are implied by coercion variables in</span>
<a name="line-1298"></a><span class='hs-comment'>--    return value (2).</span>
<a name="line-1299"></a><span class='hs-comment'>--</span>
<a name="line-1300"></a><span class='hs-comment'>-- 4) The other constraints of the data constructor type, excluding GADT</span>
<a name="line-1301"></a><span class='hs-comment'>-- equalities</span>
<a name="line-1302"></a><span class='hs-comment'>--</span>
<a name="line-1303"></a><span class='hs-comment'>-- 5) The original argument types to the 'DataCon' (i.e. before</span>
<a name="line-1304"></a><span class='hs-comment'>--    any change of the representation of the type) with linearity</span>
<a name="line-1305"></a><span class='hs-comment'>--    annotations</span>
<a name="line-1306"></a><span class='hs-comment'>--</span>
<a name="line-1307"></a><span class='hs-comment'>-- 6) The original result type of the 'DataCon'</span>
<a name="line-1308"></a><span class='hs-definition'>dataConFullSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span>
<a name="line-1309"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EqSpec</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Scaled</span> <span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1310"></a><span class='hs-definition'>dataConFullSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span><span class='hs-varid'>dcUnivTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>dcExTyCoVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span>
<a name="line-1311"></a>                        <span class='hs-varid'>dcEqSpec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq_spec</span><span class='hs-layout'>,</span> <span class='hs-varid'>dcOtherTheta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span>
<a name="line-1312"></a>                        <span class='hs-varid'>dcOrigArgTys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>dcOrigResTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1313"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>eq_spec</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-1314"></a>
<a name="line-1315"></a><a name="dataConOrigResTy"></a><span class='hs-definition'>dataConOrigResTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1316"></a><span class='hs-definition'>dataConOrigResTy</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dcOrigResTy</span> <span class='hs-varid'>dc</span>
<a name="line-1317"></a>
<a name="line-1318"></a><a name="dataConStupidTheta"></a><span class='hs-comment'>-- | The \"stupid theta\" of the 'DataCon', such as @data Eq a@ in:</span>
<a name="line-1319"></a><span class='hs-comment'>--</span>
<a name="line-1320"></a><span class='hs-comment'>-- &gt; data Eq a =&gt; T a = ...</span>
<a name="line-1321"></a><span class='hs-definition'>dataConStupidTheta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span>
<a name="line-1322"></a><span class='hs-definition'>dataConStupidTheta</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dcStupidTheta</span> <span class='hs-varid'>dc</span>
<a name="line-1323"></a>
<a name="line-1324"></a><span class='hs-comment'>{-
<a name="line-1325"></a>Note [Displaying linear fields]
<a name="line-1326"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1327"></a>A constructor with a linear field can be written either as
<a name="line-1328"></a>MkT :: a %1 -&gt; T a (with -XLinearTypes)
<a name="line-1329"></a>or
<a name="line-1330"></a>MkT :: a  -&gt; T a (with -XNoLinearTypes)
<a name="line-1331"></a>
<a name="line-1332"></a>There are two different methods to retrieve a type of a datacon.
<a name="line-1333"></a>They differ in how linear fields are handled.
<a name="line-1334"></a>
<a name="line-1335"></a>1. dataConWrapperType:
<a name="line-1336"></a>The type of the wrapper in Core.
<a name="line-1337"></a>For example, dataConWrapperType for Maybe is a %1 -&gt; Just a.
<a name="line-1338"></a>
<a name="line-1339"></a>2. dataConNonlinearType:
<a name="line-1340"></a>The type of the constructor, with linear arrows replaced by unrestricted ones.
<a name="line-1341"></a>Used when we don't want to introduce linear types to user (in holes
<a name="line-1342"></a>and in types in hie used by haddock).
<a name="line-1343"></a>
<a name="line-1344"></a>3. dataConDisplayType (take a boolean indicating if -XLinearTypes is enabled):
<a name="line-1345"></a>The type we'd like to show in error messages, :info and -ddump-types.
<a name="line-1346"></a>Ideally, it should reflect the type written by the user;
<a name="line-1347"></a>the function returns a type with arrows that would be required
<a name="line-1348"></a>to write this constructor under the current setting of -XLinearTypes.
<a name="line-1349"></a>In principle, this type can be different from the user's source code
<a name="line-1350"></a>when the value of -XLinearTypes has changed, but we don't
<a name="line-1351"></a>expect this to cause much trouble.
<a name="line-1352"></a>
<a name="line-1353"></a>Due to internal plumbing in checkValidDataCon, we can't just return a Doc.
<a name="line-1354"></a>The multiplicity of arrows returned by dataConDisplayType and
<a name="line-1355"></a>dataConDisplayType is used only for pretty-printing.
<a name="line-1356"></a>-}</span>
<a name="line-1357"></a>
<a name="line-1358"></a><a name="dataConWrapperType"></a><span class='hs-definition'>dataConWrapperType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1359"></a><span class='hs-comment'>-- ^ The user-declared type of the data constructor</span>
<a name="line-1360"></a><span class='hs-comment'>-- in the nice-to-read form:</span>
<a name="line-1361"></a><span class='hs-comment'>--</span>
<a name="line-1362"></a><span class='hs-comment'>-- &gt; T :: forall a b. a -&gt; b -&gt; T [a]</span>
<a name="line-1363"></a><span class='hs-comment'>--</span>
<a name="line-1364"></a><span class='hs-comment'>-- rather than:</span>
<a name="line-1365"></a><span class='hs-comment'>--</span>
<a name="line-1366"></a><span class='hs-comment'>-- &gt; T :: forall a c. forall b. (c~[a]) =&gt; a -&gt; b -&gt; T c</span>
<a name="line-1367"></a><span class='hs-comment'>--</span>
<a name="line-1368"></a><span class='hs-comment'>-- The type variables are quantified in the order that the user wrote them.</span>
<a name="line-1369"></a><span class='hs-comment'>-- See @Note [DataCon user type variable binders]@.</span>
<a name="line-1370"></a><span class='hs-comment'>--</span>
<a name="line-1371"></a><span class='hs-comment'>-- NB: If the constructor is part of a data instance, the result type</span>
<a name="line-1372"></a><span class='hs-comment'>-- mentions the family tycon, not the internal one.</span>
<a name="line-1373"></a><span class='hs-definition'>dataConWrapperType</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcUserTyVarBinders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>user_tvbs</span><span class='hs-layout'>,</span>
<a name="line-1374"></a>                             <span class='hs-varid'>dcOtherTheta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>dcOrigArgTys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span>
<a name="line-1375"></a>                             <span class='hs-varid'>dcOrigResTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1376"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInvisForAllTys</span> <span class='hs-varid'>user_tvbs</span> <span class='hs-varop'>$</span>
<a name="line-1377"></a>    <span class='hs-varid'>mkInvisFunTysMany</span> <span class='hs-varid'>theta</span> <span class='hs-varop'>$</span>
<a name="line-1378"></a>    <span class='hs-varid'>mkVisFunTys</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varop'>$</span>
<a name="line-1379"></a>    <span class='hs-varid'>res_ty</span>
<a name="line-1380"></a>
<a name="line-1381"></a><a name="dataConNonlinearType"></a><span class='hs-definition'>dataConNonlinearType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1382"></a><span class='hs-definition'>dataConNonlinearType</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcUserTyVarBinders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>user_tvbs</span><span class='hs-layout'>,</span>
<a name="line-1383"></a>                               <span class='hs-varid'>dcOtherTheta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>dcOrigArgTys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span>
<a name="line-1384"></a>                               <span class='hs-varid'>dcOrigResTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1385"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arg_tys'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>Scaled</span> <span class='hs-varid'>w</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Scaled</span> <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>w</span> <span class='hs-keyword'>of</span> <span class='hs-conid'>One</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Many</span><span class='hs-layout'>;</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys</span>
<a name="line-1386"></a>    <span class='hs-keyword'>in</span> <span class='hs-varid'>mkInvisForAllTys</span> <span class='hs-varid'>user_tvbs</span> <span class='hs-varop'>$</span>
<a name="line-1387"></a>       <span class='hs-varid'>mkInvisFunTysMany</span> <span class='hs-varid'>theta</span> <span class='hs-varop'>$</span>
<a name="line-1388"></a>       <span class='hs-varid'>mkVisFunTys</span> <span class='hs-varid'>arg_tys'</span> <span class='hs-varop'>$</span>
<a name="line-1389"></a>       <span class='hs-varid'>res_ty</span>
<a name="line-1390"></a>
<a name="line-1391"></a><a name="dataConDisplayType"></a><span class='hs-definition'>dataConDisplayType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1392"></a><span class='hs-definition'>dataConDisplayType</span> <span class='hs-varid'>show_linear_types</span> <span class='hs-varid'>dc</span>
<a name="line-1393"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>show_linear_types</span>
<a name="line-1394"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>dataConWrapperType</span> <span class='hs-varid'>dc</span>
<a name="line-1395"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>dataConNonlinearType</span> <span class='hs-varid'>dc</span>
<a name="line-1396"></a>
<a name="line-1397"></a><a name="dataConInstArgTys"></a><span class='hs-comment'>-- | Finds the instantiated types of the arguments required to construct a</span>
<a name="line-1398"></a><span class='hs-comment'>-- 'DataCon' representation</span>
<a name="line-1399"></a><span class='hs-comment'>-- NB: these INCLUDE any dictionary args</span>
<a name="line-1400"></a><span class='hs-comment'>--     but EXCLUDE the data-declaration context, which is discarded</span>
<a name="line-1401"></a><span class='hs-comment'>-- It's all post-flattening etc; this is a representation type</span>
<a name="line-1402"></a><span class='hs-definition'>dataConInstArgTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span>    <span class='hs-comment'>-- ^ A datacon with no existentials or equality constraints</span>
<a name="line-1403"></a>                                <span class='hs-comment'>-- However, it can have a dcTheta (notably it can be a</span>
<a name="line-1404"></a>                                <span class='hs-comment'>-- class dictionary, with superclasses)</span>
<a name="line-1405"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- ^ Instantiated at these types</span>
<a name="line-1406"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Scaled</span> <span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-1407"></a><span class='hs-definition'>dataConInstArgTys</span> <span class='hs-varid'>dc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span><span class='hs-varid'>dcUnivTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span>
<a name="line-1408"></a>                              <span class='hs-varid'>dcExTyCoVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>inst_tys</span>
<a name="line-1409"></a> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>univ_tvs</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>inst_tys</span>
<a name="line-1410"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"dataConInstArgTys"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dc</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>univ_tvs</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span>
<a name="line-1411"></a>   <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dc</span> <span class='hs-layout'>)</span>
<a name="line-1412"></a>   <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapScaledType</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTyWith</span> <span class='hs-varid'>univ_tvs</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConRepArgTys</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span>
<a name="line-1413"></a>
<a name="line-1414"></a><a name="dataConInstOrigArgTys"></a><span class='hs-comment'>-- | Returns just the instantiated /value/ argument types of a 'DataCon',</span>
<a name="line-1415"></a><span class='hs-comment'>-- (excluding dictionary args)</span>
<a name="line-1416"></a><span class='hs-definition'>dataConInstOrigArgTys</span>
<a name="line-1417"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span>      <span class='hs-comment'>-- Works for any DataCon</span>
<a name="line-1418"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>       <span class='hs-comment'>-- Includes existential tyvar args, but NOT</span>
<a name="line-1419"></a>                        <span class='hs-comment'>-- equality constraints or dicts</span>
<a name="line-1420"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Scaled</span> <span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-1421"></a><span class='hs-comment'>-- For vanilla datacons, it's all quite straightforward</span>
<a name="line-1422"></a><span class='hs-comment'>-- But for the call in GHC.HsToCore.Match.Constructor, we really do want just</span>
<a name="line-1423"></a><span class='hs-comment'>-- the value args</span>
<a name="line-1424"></a><span class='hs-definition'>dataConInstOrigArgTys</span> <span class='hs-varid'>dc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span><span class='hs-varid'>dcOrigArgTys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span>
<a name="line-1425"></a>                                  <span class='hs-varid'>dcUnivTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span>
<a name="line-1426"></a>                                  <span class='hs-varid'>dcExTyCoVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>inst_tys</span>
<a name="line-1427"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>tyvars</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>inst_tys</span>
<a name="line-1428"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"dataConInstOrigArgTys"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dc</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvars</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>inst_tys</span> <span class='hs-layout'>)</span>
<a name="line-1429"></a>    <span class='hs-varid'>substScaledTys</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>arg_tys</span>
<a name="line-1430"></a>  <span class='hs-keyword'>where</span>
<a name="line-1431"></a>    <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>univ_tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ex_tvs</span>
<a name="line-1432"></a>    <span class='hs-varid'>subst</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipTCvSubst</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>inst_tys</span>
<a name="line-1433"></a>
<a name="line-1434"></a><a name="dataConOrigArgTys"></a><span class='hs-comment'>-- | Returns the argument types of the wrapper, excluding all dictionary arguments</span>
<a name="line-1435"></a><span class='hs-comment'>-- and without substituting for any type variables</span>
<a name="line-1436"></a><span class='hs-definition'>dataConOrigArgTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Scaled</span> <span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-1437"></a><span class='hs-definition'>dataConOrigArgTys</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dcOrigArgTys</span> <span class='hs-varid'>dc</span>
<a name="line-1438"></a>
<a name="line-1439"></a><a name="dataConOtherTheta"></a><span class='hs-comment'>-- | Returns constraints in the wrapper type, other than those in the dataConEqSpec</span>
<a name="line-1440"></a><span class='hs-definition'>dataConOtherTheta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span>
<a name="line-1441"></a><span class='hs-definition'>dataConOtherTheta</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dcOtherTheta</span> <span class='hs-varid'>dc</span>
<a name="line-1442"></a>
<a name="line-1443"></a><a name="dataConRepArgTys"></a><span class='hs-comment'>-- | Returns the arg types of the worker, including *all* non-dependent</span>
<a name="line-1444"></a><span class='hs-comment'>-- evidence, after any flattening has been done and without substituting for</span>
<a name="line-1445"></a><span class='hs-comment'>-- any type variables</span>
<a name="line-1446"></a><span class='hs-definition'>dataConRepArgTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Scaled</span> <span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-1447"></a><span class='hs-definition'>dataConRepArgTys</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcRep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rep</span>
<a name="line-1448"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>dcEqSpec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq_spec</span>
<a name="line-1449"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>dcOtherTheta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>theta</span>
<a name="line-1450"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>dcOrigArgTys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orig_arg_tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1451"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>rep</span> <span class='hs-keyword'>of</span>
<a name="line-1452"></a>      <span class='hs-conid'>NoDataConRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>eq_spec</span> <span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>unrestricted</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-varid'>orig_arg_tys</span>
<a name="line-1453"></a>      <span class='hs-conid'>DCR</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcr_arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_tys</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>arg_tys</span>
<a name="line-1454"></a>
<a name="line-1455"></a><a name="dataConIdentity"></a><span class='hs-comment'>-- | The string @package:module.name@ identifying a constructor, which is attached</span>
<a name="line-1456"></a><span class='hs-comment'>-- to its info table and used by the GHCi debugger and the heap profiler</span>
<a name="line-1457"></a><span class='hs-definition'>dataConIdentity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span>
<a name="line-1458"></a><span class='hs-comment'>-- We want this string to be UTF-8, so we get the bytes directly from the FastStrings.</span>
<a name="line-1459"></a><span class='hs-definition'>dataConIdentity</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LBS.toStrict</span> <span class='hs-varop'>$</span> <span class='hs-conid'>BSB.toLazyByteString</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mconcat</span>
<a name="line-1460"></a>   <span class='hs-keyglyph'>[</span> <span class='hs-conid'>BSB.shortByteString</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fastStringToShortByteString</span> <span class='hs-varop'>$</span>
<a name="line-1461"></a>       <span class='hs-varid'>unitFS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>moduleUnit</span> <span class='hs-varid'>mod</span>
<a name="line-1462"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>BSB.int8</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>ord</span> <span class='hs-chr'>':'</span><span class='hs-layout'>)</span>
<a name="line-1463"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>BSB.shortByteString</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fastStringToShortByteString</span> <span class='hs-varop'>$</span>
<a name="line-1464"></a>       <span class='hs-varid'>moduleNameFS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>moduleName</span> <span class='hs-varid'>mod</span>
<a name="line-1465"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>BSB.int8</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>ord</span> <span class='hs-chr'>'.'</span><span class='hs-layout'>)</span>
<a name="line-1466"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>BSB.shortByteString</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fastStringToShortByteString</span> <span class='hs-varop'>$</span>
<a name="line-1467"></a>       <span class='hs-varid'>occNameFS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span>
<a name="line-1468"></a>   <span class='hs-keyglyph'>]</span>
<a name="line-1469"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConName</span> <span class='hs-varid'>dc</span>
<a name="line-1470"></a>        <span class='hs-varid'>mod</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span> <span class='hs-layout'>)</span> <span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span>
<a name="line-1471"></a>
<a name="line-1472"></a><a name="isTupleDataCon"></a><span class='hs-definition'>isTupleDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1473"></a><span class='hs-definition'>isTupleDataCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span><span class='hs-varid'>dcRepTyCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTupleTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-1474"></a>
<a name="line-1475"></a><a name="isBoxedTupleDataCon"></a><span class='hs-definition'>isBoxedTupleDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1476"></a><span class='hs-definition'>isBoxedTupleDataCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span><span class='hs-varid'>dcRepTyCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isBoxedTupleTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-1477"></a>
<a name="line-1478"></a><a name="isUnboxedTupleDataCon"></a><span class='hs-definition'>isUnboxedTupleDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1479"></a><span class='hs-definition'>isUnboxedTupleDataCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span><span class='hs-varid'>dcRepTyCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUnboxedTupleTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-1480"></a>
<a name="line-1481"></a><a name="isUnboxedSumDataCon"></a><span class='hs-definition'>isUnboxedSumDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1482"></a><span class='hs-definition'>isUnboxedSumDataCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span><span class='hs-varid'>dcRepTyCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUnboxedSumTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-1483"></a>
<a name="line-1484"></a><a name="isVanillaDataCon"></a><span class='hs-comment'>-- | Vanilla 'DataCon's are those that are nice boring Haskell 98 constructors</span>
<a name="line-1485"></a><span class='hs-definition'>isVanillaDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1486"></a><span class='hs-definition'>isVanillaDataCon</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dcVanilla</span> <span class='hs-varid'>dc</span>
<a name="line-1487"></a>
<a name="line-1488"></a><a name="isNewDataCon"></a><span class='hs-comment'>-- | Is this the 'DataCon' of a newtype?</span>
<a name="line-1489"></a><span class='hs-definition'>isNewDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1490"></a><span class='hs-definition'>isNewDataCon</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNewTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConTyCon</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span>
<a name="line-1491"></a>
<a name="line-1492"></a><a name="specialPromotedDc"></a><span class='hs-comment'>-- | Should this DataCon be allowed in a type even without -XDataKinds?</span>
<a name="line-1493"></a><span class='hs-comment'>-- Currently, only Lifted &amp; Unlifted</span>
<a name="line-1494"></a><span class='hs-definition'>specialPromotedDc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1495"></a><span class='hs-definition'>specialPromotedDc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isKindTyCon</span> <span class='hs-varop'>.</span> <span class='hs-varid'>dataConTyCon</span>
<a name="line-1496"></a>
<a name="line-1497"></a><a name="classDataCon"></a><span class='hs-definition'>classDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span>
<a name="line-1498"></a><span class='hs-definition'>classDataCon</span> <span class='hs-varid'>clas</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConDataCons</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1499"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>dict_constr</span><span class='hs-conop'>:</span><span class='hs-varid'>no_more</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>no_more</span> <span class='hs-layout'>)</span> <span class='hs-varid'>dict_constr</span>
<a name="line-1500"></a>                      <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"classDataCon"</span>
<a name="line-1501"></a>
<a name="line-1502"></a><a name="dataConCannotMatch"></a><span class='hs-definition'>dataConCannotMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1503"></a><span class='hs-comment'>-- Returns True iff the data con *definitely cannot* match a</span>
<a name="line-1504"></a><span class='hs-comment'>--                  scrutinee of type (T tys)</span>
<a name="line-1505"></a><span class='hs-comment'>--                  where T is the dcRepTyCon for the data con</span>
<a name="line-1506"></a><span class='hs-definition'>dataConCannotMatch</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>con</span>
<a name="line-1507"></a>  <span class='hs-comment'>-- See (U6) in Note [Implementing unsafeCoerce]</span>
<a name="line-1508"></a>  <span class='hs-comment'>-- in base:Unsafe.Coerce</span>
<a name="line-1509"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dataConName</span> <span class='hs-varid'>con</span> <span class='hs-varop'>==</span> <span class='hs-varid'>unsafeReflDataConName</span>
<a name="line-1510"></a>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1511"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>inst_theta</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>   <span class='hs-comment'>-- Common</span>
<a name="line-1512"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTyVarTy</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>   <span class='hs-comment'>-- Also common</span>
<a name="line-1513"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typesCantMatch</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-varid'>predEqs</span> <span class='hs-varid'>inst_theta</span><span class='hs-layout'>)</span>
<a name="line-1514"></a>  <span class='hs-keyword'>where</span>
<a name="line-1515"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_theta</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConInstSig</span> <span class='hs-varid'>con</span> <span class='hs-varid'>tys</span>
<a name="line-1516"></a>
<a name="line-1517"></a>    <span class='hs-comment'>-- TODO: could gather equalities from superclasses too</span>
<a name="line-1518"></a>    <span class='hs-varid'>predEqs</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-varid'>pred</span> <span class='hs-keyword'>of</span>
<a name="line-1519"></a>                     <span class='hs-conid'>EqPred</span> <span class='hs-conid'>NomEq</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1520"></a>                     <span class='hs-conid'>ClassPred</span> <span class='hs-varid'>eq</span> <span class='hs-varid'>args</span>
<a name="line-1521"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>eq</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqTyConKey</span>
<a name="line-1522"></a>                       <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>args</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1523"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>eq</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>heqTyConKey</span>
<a name="line-1524"></a>                       <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1525"></a>                     <span class='hs-keyword'>_</span>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-1526"></a>
<a name="line-1527"></a><span class='hs-comment'>-- | Were the type variables of the data con written in a different order</span>
<a name="line-1528"></a><span class='hs-comment'>-- than the regular order (universal tyvars followed by existential tyvars)?</span>
<a name="line-1529"></a><span class='hs-comment'>--</span>
<a name="line-1530"></a><span class='hs-comment'>-- This is not a cheap test, so we minimize its use in GHC as much as possible.</span>
<a name="line-1531"></a><span class='hs-comment'>-- Currently, its only call site in the GHC codebase is in 'mkDataConRep' in</span>
<a name="line-1532"></a><span class='hs-comment'>-- "MkId", and so 'dataConUserTyVarsArePermuted' is only called at most once</span>
<a name="line-1533"></a><span class='hs-comment'>-- during a data constructor's lifetime.</span>
<a name="line-1534"></a>
<a name="line-1535"></a><a name="dataConUserTyVarsArePermuted"></a><span class='hs-comment'>-- See Note [DataCon user type variable binders], as well as</span>
<a name="line-1536"></a><span class='hs-comment'>-- Note [Data con wrappers and GADT syntax] for an explanation of what</span>
<a name="line-1537"></a><span class='hs-comment'>-- mkDataConRep is doing with this function.</span>
<a name="line-1538"></a><span class='hs-definition'>dataConUserTyVarsArePermuted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1539"></a><span class='hs-definition'>dataConUserTyVarsArePermuted</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcUnivTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>univ_tvs</span>
<a name="line-1540"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>dcExTyCoVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>dcEqSpec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq_spec</span>
<a name="line-1541"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>dcUserTyVarBinders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>user_tvbs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1542"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>filterEqSpec</span> <span class='hs-varid'>eq_spec</span> <span class='hs-varid'>univ_tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>)</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>binderVars</span> <span class='hs-varid'>user_tvbs</span>
<a name="line-1543"></a>
<a name="line-1544"></a><span class='hs-comment'>{-
<a name="line-1545"></a>%************************************************************************
<a name="line-1546"></a>%*                                                                      *
<a name="line-1547"></a>        Promoting of data types to the kind level
<a name="line-1548"></a>*                                                                      *
<a name="line-1549"></a>************************************************************************
<a name="line-1550"></a>
<a name="line-1551"></a>-}</span>
<a name="line-1552"></a>
<a name="line-1553"></a><a name="promoteDataCon"></a><span class='hs-definition'>promoteDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span>
<a name="line-1554"></a><span class='hs-definition'>promoteDataCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcPromoted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span>
<a name="line-1555"></a>
<a name="line-1556"></a><span class='hs-comment'>{-
<a name="line-1557"></a>************************************************************************
<a name="line-1558"></a>*                                                                      *
<a name="line-1559"></a>\subsection{Splitting products}
<a name="line-1560"></a>*                                                                      *
<a name="line-1561"></a>************************************************************************
<a name="line-1562"></a>-}</span>
<a name="line-1563"></a>
<a name="line-1564"></a><a name="splitDataProductType_maybe"></a><span class='hs-comment'>-- | Extract the type constructor, type argument, data constructor and it's</span>
<a name="line-1565"></a><span class='hs-comment'>-- /representation/ argument types from a type if it is a product type.</span>
<a name="line-1566"></a><span class='hs-comment'>--</span>
<a name="line-1567"></a><span class='hs-comment'>-- Precisely, we return @Just@ for any data type that is all of:</span>
<a name="line-1568"></a><span class='hs-comment'>--</span>
<a name="line-1569"></a><span class='hs-comment'>--  * Concrete (i.e. constructors visible)</span>
<a name="line-1570"></a><span class='hs-comment'>--  * Single-constructor</span>
<a name="line-1571"></a><span class='hs-comment'>--  * ... which has no existentials</span>
<a name="line-1572"></a><span class='hs-comment'>--</span>
<a name="line-1573"></a><span class='hs-comment'>-- Whether the type is a @data@ type or a @newtype@.</span>
<a name="line-1574"></a><span class='hs-definition'>splitDataProductType_maybe</span>
<a name="line-1575"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span>                         <span class='hs-comment'>-- ^ A product type, perhaps</span>
<a name="line-1576"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span>                <span class='hs-comment'>-- The type constructor</span>
<a name="line-1577"></a>                  <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>               <span class='hs-comment'>-- Type args of the tycon</span>
<a name="line-1578"></a>                  <span class='hs-conid'>DataCon</span><span class='hs-layout'>,</span>              <span class='hs-comment'>-- The data constructor</span>
<a name="line-1579"></a>                  <span class='hs-keyglyph'>[</span><span class='hs-conid'>Scaled</span> <span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- Its /representation/ arg types</span>
<a name="line-1580"></a>
<a name="line-1581"></a>        <span class='hs-comment'>-- Rejecting existentials means we don't have to worry about</span>
<a name="line-1582"></a>        <span class='hs-comment'>-- freshening and substituting type variables</span>
<a name="line-1583"></a>        <span class='hs-comment'>-- (See "GHC.Type.Id.Make.dataConArgUnpack")</span>
<a name="line-1584"></a>
<a name="line-1585"></a><span class='hs-definition'>splitDataProductType_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1586"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tycon</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1587"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConSingleDataCon_maybe</span> <span class='hs-varid'>tycon</span>
<a name="line-1588"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConExTyCoVars</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- no existentials! See above</span>
<a name="line-1589"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tycon</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConInstArgTys</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ty_args</span><span class='hs-layout'>)</span>
<a name="line-1590"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1591"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre></body>
</html>
