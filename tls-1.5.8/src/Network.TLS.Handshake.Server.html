<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-2"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-3"></span><span class="hs-comment">-- Module      : Network.TLS.Handshake.Server</span><span>
</span><span id="line-4"></span><span class="hs-comment">-- License     : BSD-style</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- Maintainer  : Vincent Hanquez &lt;vincent@snarc.org&gt;</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- Stability   : experimental</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- Portability : unknown</span><span>
</span><span id="line-8"></span><span class="hs-comment">--</span><span>
</span><span id="line-9"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network.TLS.Handshake.Server</span><span>
</span><span id="line-10"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Server.html#handshakeServer"><span class="hs-identifier">handshakeServer</span></a></span><span>
</span><span id="line-11"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Server.html#handshakeServerWith"><span class="hs-identifier">handshakeServerWith</span></a></span><span>
</span><span id="line-12"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Server.html#requestCertificateServer"><span class="hs-identifier">requestCertificateServer</span></a></span><span>
</span><span id="line-13"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Server.html#postHandshakeAuthServerWith"><span class="hs-identifier">postHandshakeAuthServerWith</span></a></span><span>
</span><span id="line-14"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html"><span class="hs-identifier">Network.TLS.Parameters</span></a></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Imports.html"><span class="hs-identifier">Network.TLS.Imports</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html"><span class="hs-identifier">Network.TLS.Context.Internal</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Session.html"><span class="hs-identifier">Network.TLS.Session</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html"><span class="hs-identifier">Network.TLS.Struct</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Struct13.html"><span class="hs-identifier">Network.TLS.Struct13</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Cipher.html"><span class="hs-identifier">Network.TLS.Cipher</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Compression.html"><span class="hs-identifier">Network.TLS.Compression</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Credentials.html"><span class="hs-identifier">Network.TLS.Credentials</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Crypto.html"><span class="hs-identifier">Network.TLS.Crypto</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Extension.html"><span class="hs-identifier">Network.TLS.Extension</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Util.html"><span class="hs-identifier">Network.TLS.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Util.html#bytesEq"><span class="hs-identifier">bytesEq</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Util.html#catchException"><span class="hs-identifier">catchException</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Util.html#fromJust"><span class="hs-identifier">fromJust</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.IO.html"><span class="hs-identifier">Network.TLS.IO</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Types.html"><span class="hs-identifier">Network.TLS.Types</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.State.html"><span class="hs-identifier">Network.TLS.State</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Control.html"><span class="hs-identifier">Network.TLS.Handshake.Control</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.State.html"><span class="hs-identifier">Network.TLS.Handshake.State</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Process.html"><span class="hs-identifier">Network.TLS.Handshake.Process</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Key.html"><span class="hs-identifier">Network.TLS.Handshake.Key</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Random.html"><span class="hs-identifier">Network.TLS.Handshake.Random</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Measurement.html"><span class="hs-identifier">Network.TLS.Measurement</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">B</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.X509</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ExtKeyUsageFlag</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State.Strict</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">bracket</span></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Signature.html"><span class="hs-identifier">Network.TLS.Handshake.Signature</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Common.html"><span class="hs-identifier">Network.TLS.Handshake.Common</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Certificate.html"><span class="hs-identifier">Network.TLS.Handshake.Certificate</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.X509.html"><span class="hs-identifier">Network.TLS.X509</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.State13.html"><span class="hs-identifier">Network.TLS.Handshake.State13</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Common13.html"><span class="hs-identifier">Network.TLS.Handshake.Common13</span></a></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-comment">-- Put the server context in handshake mode.</span><span>
</span><span id="line-51"></span><span class="hs-comment">--</span><span>
</span><span id="line-52"></span><span class="hs-comment">-- Expect to receive as first packet a client hello handshake message</span><span>
</span><span id="line-53"></span><span class="hs-comment">--</span><span>
</span><span id="line-54"></span><span class="hs-comment">-- This is just a helper to pop the next message from the recv layer,</span><span>
</span><span id="line-55"></span><span class="hs-comment">-- and call handshakeServerWith.</span><span>
</span><span id="line-56"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#handshakeServer"><span class="hs-identifier hs-type">handshakeServer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ServerParams"><span class="hs-identifier hs-type">ServerParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span id="handshakeServer"><span class="annot"><span class="annottext">handshakeServer :: ServerParams -&gt; Context -&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#handshakeServer"><span class="hs-identifier hs-var hs-var">handshakeServer</span></a></span></span><span> </span><span id="local-6989586621679178352"><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679178352"><span class="hs-identifier hs-var">sparams</span></a></span></span><span> </span><span id="local-6989586621679178351"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178351"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-58"></span><span>    </span><span id="local-6989586621679178349"><span class="annot"><span class="annottext">[Handshake]
</span><a href="#local-6989586621679178349"><span class="hs-identifier hs-var">hss</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO [Handshake]
</span><a href="Network.TLS.Handshake.Common.html#recvPacketHandshake"><span class="hs-identifier hs-var">recvPacketHandshake</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178351"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-59"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Handshake]
</span><a href="#local-6989586621679178349"><span class="hs-identifier hs-var">hss</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-60"></span><span>        </span><span class="hs-special">[</span><span id="local-6989586621679178347"><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679178347"><span class="hs-identifier hs-var">ch</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ServerParams -&gt; Context -&gt; Handshake -&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#handshakeServerWith"><span class="hs-identifier hs-var">handshakeServerWith</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679178352"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178351"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679178347"><span class="hs-identifier hs-var">ch</span></a></span><span>
</span><span id="line-61"></span><span>        </span><span class="annot"><span class="annottext">[Handshake]
</span><span class="hs-identifier">_</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; Maybe String -&gt; m a
</span><a href="Network.TLS.Handshake.Common.html#unexpected"><span class="hs-identifier hs-var">unexpected</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">[Handshake]
</span><a href="#local-6989586621679178349"><span class="hs-identifier hs-var">hss</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;client hello&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span class="hs-comment">-- | Put the server context in handshake mode.</span><span>
</span><span id="line-64"></span><span class="hs-comment">--</span><span>
</span><span id="line-65"></span><span class="hs-comment">-- Expect a client hello message as parameter.</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- This is useful when the client hello has been already poped from the recv layer to inspect the packet.</span><span>
</span><span id="line-67"></span><span class="hs-comment">--</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- When the function returns, a new handshake has been succesfully negociated.</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- On any error, a HandshakeFailed exception is raised.</span><span>
</span><span id="line-70"></span><span class="hs-comment">--</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- handshake protocol (&lt;- receiving, -&gt; sending, [] optional):</span><span>
</span><span id="line-72"></span><span class="hs-comment">--    (no session)           (session resumption)</span><span>
</span><span id="line-73"></span><span class="hs-comment">--      &lt;- client hello       &lt;- client hello</span><span>
</span><span id="line-74"></span><span class="hs-comment">--      -&gt; server hello       -&gt; server hello</span><span>
</span><span id="line-75"></span><span class="hs-comment">--      -&gt; [certificate]</span><span>
</span><span id="line-76"></span><span class="hs-comment">--      -&gt; [server key xchg]</span><span>
</span><span id="line-77"></span><span class="hs-comment">--      -&gt; [cert request]</span><span>
</span><span id="line-78"></span><span class="hs-comment">--      -&gt; hello done</span><span>
</span><span id="line-79"></span><span class="hs-comment">--      &lt;- [certificate]</span><span>
</span><span id="line-80"></span><span class="hs-comment">--      &lt;- client key xchg</span><span>
</span><span id="line-81"></span><span class="hs-comment">--      &lt;- [cert verify]</span><span>
</span><span id="line-82"></span><span class="hs-comment">--      &lt;- change cipher      -&gt; change cipher</span><span>
</span><span id="line-83"></span><span class="hs-comment">--      &lt;- finish             -&gt; finish</span><span>
</span><span id="line-84"></span><span class="hs-comment">--      -&gt; change cipher      &lt;- change cipher</span><span>
</span><span id="line-85"></span><span class="hs-comment">--      -&gt; finish             &lt;- finish</span><span>
</span><span id="line-86"></span><span class="hs-comment">--</span><span>
</span><span id="line-87"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#handshakeServerWith"><span class="hs-identifier hs-type">handshakeServerWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ServerParams"><span class="hs-identifier hs-type">ServerParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#Handshake"><span class="hs-identifier hs-type">Handshake</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span id="handshakeServerWith"><span class="annot"><span class="annottext">handshakeServerWith :: ServerParams -&gt; Context -&gt; Handshake -&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#handshakeServerWith"><span class="hs-identifier hs-var hs-var">handshakeServerWith</span></a></span></span><span> </span><span id="local-6989586621679178344"><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679178344"><span class="hs-identifier hs-var">sparams</span></a></span></span><span> </span><span id="local-6989586621679178343"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178343"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679178342"><span class="annot"><span class="annottext">clientHello :: Handshake
</span><a href="#local-6989586621679178342"><span class="hs-identifier hs-var">clientHello</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#ClientHello"><span class="hs-identifier hs-type">ClientHello</span></a></span><span> </span><span id="local-6989586621679178340"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178340"><span class="hs-identifier hs-var">legacyVersion</span></a></span></span><span> </span><span class="annot"><span class="annottext">ClientRandom
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679178339"><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679178339"><span class="hs-identifier hs-var">clientSession</span></a></span></span><span> </span><span id="local-6989586621679178338"><span class="annot"><span class="annottext">[ExtensionID]
</span><a href="#local-6989586621679178338"><span class="hs-identifier hs-var">ciphers</span></a></span></span><span> </span><span id="local-6989586621679178337"><span class="annot"><span class="annottext">[CompressionID]
</span><a href="#local-6989586621679178337"><span class="hs-identifier hs-var">compressions</span></a></span></span><span> </span><span id="local-6989586621679178336"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178336"><span class="hs-identifier hs-var">exts</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-89"></span><span>    </span><span id="local-6989586621679178335"><span class="annot"><span class="annottext">Established
</span><a href="#local-6989586621679178335"><span class="hs-identifier hs-var">established</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO Established
</span><a href="Network.TLS.Context.Internal.html#ctxEstablished"><span class="hs-identifier hs-var">ctxEstablished</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178343"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-comment">-- renego is not allowed in TLS 1.3</span><span>
</span><span id="line-91"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Established
</span><a href="#local-6989586621679178335"><span class="hs-identifier hs-var">established</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Established
</span><a href="Network.TLS.Context.Internal.html#NotEstablished"><span class="hs-identifier hs-var">NotEstablished</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-92"></span><span>        </span><span id="local-6989586621679178330"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178330"><span class="hs-identifier hs-var">ver</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178343"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Version -&gt; TLSSt Version
</span><a href="Network.TLS.State.html#getVersionWithDefault"><span class="hs-identifier hs-var">getVersionWithDefault</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS10"><span class="hs-identifier hs-var">TLS10</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178330"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS13"><span class="hs-identifier hs-var">TLS13</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;renegotiation is not allowed in TLS 1.3&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#UnexpectedMessage"><span class="hs-identifier hs-var">UnexpectedMessage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-comment">-- rejecting client initiated renegotiation to prevent DOS.</span><span>
</span><span id="line-95"></span><span>    </span><span id="local-6989586621679178322"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178322"><span class="hs-identifier hs-var">eof</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO Bool
</span><a href="Network.TLS.Context.Internal.html#ctxEOF"><span class="hs-identifier hs-var">ctxEOF</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178343"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679178319"><span class="annot"><span class="annottext">renegotiation :: Bool
</span><a href="#local-6989586621679178319"><span class="hs-identifier hs-var hs-var">renegotiation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Established
</span><a href="#local-6989586621679178335"><span class="hs-identifier hs-var">established</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Established
</span><a href="Network.TLS.Context.Internal.html#Established"><span class="hs-identifier hs-var">Established</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178322"><span class="hs-identifier hs-var">eof</span></a></span><span>
</span><span id="line-97"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178319"><span class="hs-identifier hs-var">renegotiation</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Supported -&gt; Bool
</span><a href="Network.TLS.Parameters.html#supportedClientInitiatedRenegotiation"><span class="hs-identifier hs-var">supportedClientInitiatedRenegotiation</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178343"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-98"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;renegotiation is not allowed&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#NoRenegotiation"><span class="hs-identifier hs-var">NoRenegotiation</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>    </span><span class="hs-comment">-- check if policy allow this new handshake to happens</span><span>
</span><span id="line-100"></span><span>    </span><span id="local-6989586621679178312"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178312"><span class="hs-identifier hs-var">handshakeAuthorized</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Context -&gt; (Measurement -&gt; IO a) -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#withMeasure"><span class="hs-identifier hs-var">withMeasure</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178343"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerHooks -&gt; Measurement -&gt; IO Bool
</span><a href="Network.TLS.Parameters.html#onNewHandshake"><span class="hs-identifier hs-var">onNewHandshake</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerParams -&gt; ServerHooks
</span><a href="Network.TLS.Parameters.html#serverHooks"><span class="hs-identifier hs-var">serverHooks</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679178344"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178312"><span class="hs-identifier hs-var">handshakeAuthorized</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_HandshakePolicy"><span class="hs-identifier hs-var">Error_HandshakePolicy</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;server: handshake denied&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; (Measurement -&gt; Measurement) -&gt; IO ()
</span><a href="Network.TLS.Context.Internal.html#updateMeasure"><span class="hs-identifier hs-var">updateMeasure</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178343"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Measurement -&gt; Measurement
</span><a href="Network.TLS.Measurement.html#incrementNbHandshakes"><span class="hs-identifier hs-var">incrementNbHandshakes</span></a></span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-comment">-- Handle Client hello</span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; Handshake -&gt; IO ()
</span><a href="Network.TLS.Handshake.Process.html#processHandshake"><span class="hs-identifier hs-var">processHandshake</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178343"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679178342"><span class="hs-identifier hs-var">clientHello</span></a></span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-comment">-- rejecting SSL2. RFC 6176</span><span>
</span><span id="line-108"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178340"><span class="hs-identifier hs-var">legacyVersion</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#SSL2"><span class="hs-identifier hs-var">SSL2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SSL 2.0 is not supported&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#ProtocolVersion"><span class="hs-identifier hs-var">ProtocolVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-comment">-- rejecting SSL3. RFC 7568</span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-comment">-- when (legacyVersion == SSL3) $ throwCore $ Error_Protocol (&quot;SSL 3.0 is not supported&quot;, True, ProtocolVersion)</span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-comment">-- Fallback SCSV: RFC7507</span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-comment">-- TLS_FALLBACK_SCSV: {0x56, 0x00}</span><span>
</span><span id="line-114"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Supported -&gt; Bool
</span><a href="Network.TLS.Parameters.html#supportedFallbackScsv"><span class="hs-identifier hs-var">supportedFallbackScsv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178343"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span>
</span><span id="line-115"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtensionID
</span><span class="hs-number">0x5600</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[ExtensionID]
</span><a href="#local-6989586621679178338"><span class="hs-identifier hs-var">ciphers</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span>
</span><span id="line-116"></span><span>          </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178340"><span class="hs-identifier hs-var">legacyVersion</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS12"><span class="hs-identifier hs-var">TLS12</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-117"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;fallback is not allowed&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#InappropriateFallback"><span class="hs-identifier hs-var">InappropriateFallback</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-comment">-- choosing TLS version</span><span>
</span><span id="line-119"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679178293"><span class="annot"><span class="annottext">clientVersions :: [Version]
</span><a href="#local-6989586621679178293"><span class="hs-identifier hs-var hs-var">clientVersions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; [ExtensionRaw] -&gt; Maybe ByteString
</span><a href="Network.TLS.Handshake.Common.html#extensionLookup"><span class="hs-identifier hs-var">extensionLookup</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_SupportedVersions"><span class="hs-identifier hs-var">extensionID_SupportedVersions</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178336"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTClientHello"><span class="hs-identifier hs-var">MsgTClientHello</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-120"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#SupportedVersionsClientHello"><span class="hs-identifier hs-type">SupportedVersionsClientHello</span></a></span><span> </span><span id="local-6989586621679178287"><span class="annot"><span class="annottext">[Version]
</span><a href="#local-6989586621679178287"><span class="hs-identifier hs-var">vers</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Version]
</span><a href="#local-6989586621679178287"><span class="hs-identifier hs-var">vers</span></a></span><span>
</span><span id="line-121"></span><span>            </span><span class="annot"><span class="annottext">Maybe SupportedVersions
</span><span class="hs-identifier">_</span></span><span>                                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-122"></span><span>        </span><span id="local-6989586621679178285"><span class="annot"><span class="annottext">clientVersion :: Version
</span><a href="#local-6989586621679178285"><span class="hs-identifier hs-var hs-var">clientVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">min</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS12"><span class="hs-identifier hs-var">TLS12</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178340"><span class="hs-identifier hs-var">legacyVersion</span></a></span><span>
</span><span id="line-123"></span><span>        </span><span id="local-6989586621679178282"><span class="annot"><span class="annottext">serverVersions :: [Version]
</span><a href="#local-6989586621679178282"><span class="hs-identifier hs-var hs-var">serverVersions</span></a></span></span><span>
</span><span id="line-124"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178319"><span class="hs-identifier hs-var">renegotiation</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS13"><span class="hs-identifier hs-var">TLS13</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Supported -&gt; [Version]
</span><a href="Network.TLS.Parameters.html#supportedVersions"><span class="hs-identifier hs-var">supportedVersions</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178343"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Supported -&gt; [Version]
</span><a href="Network.TLS.Parameters.html#supportedVersions"><span class="hs-identifier hs-var">supportedVersions</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178343"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-126"></span><span>        </span><span id="local-6989586621679178280"><span class="annot"><span class="annottext">mVersion :: Maybe Version
</span><a href="#local-6989586621679178280"><span class="hs-identifier hs-var hs-var">mVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DebugParams -&gt; Maybe Version
</span><a href="Network.TLS.Parameters.html#debugVersionForced"><span class="hs-identifier hs-var">debugVersionForced</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerParams -&gt; DebugParams
</span><a href="Network.TLS.Parameters.html#serverDebug"><span class="hs-identifier hs-var">serverDebug</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679178344"><span class="hs-identifier hs-var">sparams</span></a></span><span>
</span><span id="line-127"></span><span>    </span><span id="local-6989586621679178277"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178277"><span class="hs-identifier hs-var">chosenVersion</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Version
</span><a href="#local-6989586621679178280"><span class="hs-identifier hs-var">mVersion</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-128"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679178276"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178276"><span class="hs-identifier hs-var">cver</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178276"><span class="hs-identifier hs-var">cver</span></a></span><span>
</span><span id="line-129"></span><span>      </span><span class="annot"><span class="annottext">Maybe Version
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-130"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS13"><span class="hs-identifier hs-var">TLS13</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[Version]
</span><a href="#local-6989586621679178282"><span class="hs-identifier hs-var">serverVersions</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">[Version]
</span><a href="#local-6989586621679178293"><span class="hs-identifier hs-var">clientVersions</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Version] -&gt; [Version] -&gt; Maybe Version
</span><a href="Network.TLS.Handshake.Server.html#findHighestVersionFrom13"><span class="hs-identifier hs-var">findHighestVersionFrom13</span></a></span><span> </span><span class="annot"><span class="annottext">[Version]
</span><a href="#local-6989586621679178293"><span class="hs-identifier hs-var">clientVersions</span></a></span><span> </span><span class="annot"><span class="annottext">[Version]
</span><a href="#local-6989586621679178282"><span class="hs-identifier hs-var">serverVersions</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-131"></span><span>                  </span><span class="annot"><span class="annottext">Maybe Version
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;client versions &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">[Version]
</span><a href="#local-6989586621679178293"><span class="hs-identifier hs-var">clientVersions</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; is not supported&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#ProtocolVersion"><span class="hs-identifier hs-var">ProtocolVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679178274"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178274"><span class="hs-identifier hs-var">v</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178274"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-133"></span><span>           </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Version -&gt; [Version] -&gt; Maybe Version
</span><a href="Network.TLS.Handshake.Server.html#findHighestVersionFrom"><span class="hs-identifier hs-var">findHighestVersionFrom</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178285"><span class="hs-identifier hs-var">clientVersion</span></a></span><span> </span><span class="annot"><span class="annottext">[Version]
</span><a href="#local-6989586621679178282"><span class="hs-identifier hs-var">serverVersions</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-134"></span><span>                  </span><span class="annot"><span class="annottext">Maybe Version
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;client version &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178285"><span class="hs-identifier hs-var">clientVersion</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; is not supported&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#ProtocolVersion"><span class="hs-identifier hs-var">ProtocolVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679178272"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178272"><span class="hs-identifier hs-var">v</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178272"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-comment">-- SNI (Server Name Indication)</span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679178268"><span class="annot"><span class="annottext">serverName :: Maybe String
</span><a href="#local-6989586621679178268"><span class="hs-identifier hs-var hs-var">serverName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; [ExtensionRaw] -&gt; Maybe ByteString
</span><a href="Network.TLS.Handshake.Common.html#extensionLookup"><span class="hs-identifier hs-var">extensionLookup</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_ServerName"><span class="hs-identifier hs-var">extensionID_ServerName</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178336"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTClientHello"><span class="hs-identifier hs-var">MsgTClientHello</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-139"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#ServerName"><span class="hs-identifier hs-type">ServerName</span></a></span><span> </span><span id="local-6989586621679178265"><span class="annot"><span class="annottext">[ServerNameType]
</span><a href="#local-6989586621679178265"><span class="hs-identifier hs-var">ns</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; Maybe a
</span><span class="hs-identifier hs-var">listToMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">ServerNameType -&gt; Maybe String
</span><a href="#local-6989586621679178262"><span class="hs-identifier hs-var">toHostName</span></a></span><span> </span><span class="annot"><span class="annottext">[ServerNameType]
</span><a href="#local-6989586621679178265"><span class="hs-identifier hs-var">ns</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span>                </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679178262"><span class="annot"><span class="annottext">toHostName :: ServerNameType -&gt; Maybe String
</span><a href="#local-6989586621679178262"><span class="hs-identifier hs-var hs-var">toHostName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#ServerNameHostName"><span class="hs-identifier hs-type">ServerNameHostName</span></a></span><span> </span><span id="local-6989586621679178260"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679178260"><span class="hs-identifier hs-var">hostName</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679178260"><span class="hs-identifier hs-var">hostName</span></a></span><span>
</span><span id="line-141"></span><span>                      </span><span class="annot"><a href="#local-6989586621679178262"><span class="hs-identifier hs-var">toHostName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#ServerNameOther"><span class="hs-identifier hs-type">ServerNameOther</span></a></span><span> </span><span class="annot"><span class="annottext">(CompressionID, ByteString)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-142"></span><span>            </span><span class="annot"><span class="annottext">Maybe ServerName
</span><span class="hs-identifier">_</span></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-143"></span><span>    </span><span class="annot"><span class="annottext">forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178343"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setClientSNI"><span class="hs-identifier hs-var">setClientSNI</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621679178268"><span class="hs-identifier hs-var">serverName</span></a></span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-comment">-- TLS version dependent</span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178277"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS12"><span class="hs-identifier hs-var">TLS12</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-147"></span><span>        </span><span class="annot"><span class="annottext">ServerParams
-&gt; Context
-&gt; Version
-&gt; [ExtensionRaw]
-&gt; [ExtensionID]
-&gt; Maybe String
-&gt; Version
-&gt; [CompressionID]
-&gt; Session
-&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#handshakeServerWithTLS12"><span class="hs-identifier hs-var">handshakeServerWithTLS12</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679178344"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178343"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178277"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178336"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionID]
</span><a href="#local-6989586621679178338"><span class="hs-identifier hs-var">ciphers</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621679178268"><span class="hs-identifier hs-var">serverName</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178285"><span class="hs-identifier hs-var">clientVersion</span></a></span><span> </span><span class="annot"><span class="annottext">[CompressionID]
</span><a href="#local-6989586621679178337"><span class="hs-identifier hs-var">compressions</span></a></span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679178339"><span class="hs-identifier hs-var">clientSession</span></a></span><span>
</span><span id="line-148"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-149"></span><span>        </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadIO m =&gt; CompressionID -&gt; m ()
</span><a href="Network.TLS.Handshake.Common13.html#ensureNullCompression"><span class="hs-identifier hs-var">ensureNullCompression</span></a></span><span> </span><span class="annot"><span class="annottext">[CompressionID]
</span><a href="#local-6989586621679178337"><span class="hs-identifier hs-var">compressions</span></a></span><span>
</span><span id="line-150"></span><span>        </span><span class="hs-comment">-- fixme: we should check if the client random is the same as</span><span>
</span><span id="line-151"></span><span>        </span><span class="hs-comment">-- that in the first client hello in the case of hello retry.</span><span>
</span><span id="line-152"></span><span>        </span><span class="annot"><span class="annottext">ServerParams
-&gt; Context
-&gt; Version
-&gt; [ExtensionRaw]
-&gt; [ExtensionID]
-&gt; Maybe String
-&gt; Session
-&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#handshakeServerWithTLS13"><span class="hs-identifier hs-var">handshakeServerWithTLS13</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679178344"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178343"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178277"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178336"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionID]
</span><a href="#local-6989586621679178338"><span class="hs-identifier hs-var">ciphers</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621679178268"><span class="hs-identifier hs-var">serverName</span></a></span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679178339"><span class="hs-identifier hs-var">clientSession</span></a></span><span>
</span><span id="line-153"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#handshakeServerWith"><span class="hs-identifier hs-var">handshakeServerWith</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Handshake
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unexpected handshake message received in handshakeServerWith&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span class="hs-comment">-- TLS 1.2 or earlier</span><span>
</span><span id="line-156"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#handshakeServerWithTLS12"><span class="hs-identifier hs-type">handshakeServerWithTLS12</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ServerParams"><span class="hs-identifier hs-type">ServerParams</span></a></span><span>
</span><span id="line-157"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span>
</span><span id="line-158"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Types.html#Version"><span class="hs-identifier hs-type">Version</span></a></span><span>
</span><span id="line-159"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-type">ExtensionRaw</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-160"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Types.html#CipherID"><span class="hs-identifier hs-type">CipherID</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-161"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-162"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Types.html#Version"><span class="hs-identifier hs-type">Version</span></a></span><span>
</span><span id="line-163"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Types.html#CompressionID"><span class="hs-identifier hs-type">CompressionID</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-164"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#Session"><span class="hs-identifier hs-type">Session</span></a></span><span>
</span><span id="line-165"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span id="handshakeServerWithTLS12"><span class="annot"><span class="annottext">handshakeServerWithTLS12 :: ServerParams
-&gt; Context
-&gt; Version
-&gt; [ExtensionRaw]
-&gt; [ExtensionID]
-&gt; Maybe String
-&gt; Version
-&gt; [CompressionID]
-&gt; Session
-&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#handshakeServerWithTLS12"><span class="hs-identifier hs-var hs-var">handshakeServerWithTLS12</span></a></span></span><span> </span><span id="local-6989586621679178248"><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679178248"><span class="hs-identifier hs-var">sparams</span></a></span></span><span> </span><span id="local-6989586621679178247"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178247"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679178246"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178246"><span class="hs-identifier hs-var">chosenVersion</span></a></span></span><span> </span><span id="local-6989586621679178245"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178245"><span class="hs-identifier hs-var">exts</span></a></span></span><span> </span><span id="local-6989586621679178244"><span class="annot"><span class="annottext">[ExtensionID]
</span><a href="#local-6989586621679178244"><span class="hs-identifier hs-var">ciphers</span></a></span></span><span> </span><span id="local-6989586621679178243"><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621679178243"><span class="hs-identifier hs-var">serverName</span></a></span></span><span> </span><span id="local-6989586621679178242"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178242"><span class="hs-identifier hs-var">clientVersion</span></a></span></span><span> </span><span id="local-6989586621679178241"><span class="annot"><span class="annottext">[CompressionID]
</span><a href="#local-6989586621679178241"><span class="hs-identifier hs-var">compressions</span></a></span></span><span> </span><span id="local-6989586621679178240"><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679178240"><span class="hs-identifier hs-var">clientSession</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-167"></span><span>    </span><span id="local-6989586621679178239"><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178239"><span class="hs-identifier hs-var">extraCreds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ServerHooks -&gt; Maybe String -&gt; IO Credentials
</span><a href="Network.TLS.Parameters.html#onServerNameIndication"><span class="hs-identifier hs-var">onServerNameIndication</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerParams -&gt; ServerHooks
</span><a href="Network.TLS.Parameters.html#serverHooks"><span class="hs-identifier hs-var">serverHooks</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679178248"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621679178243"><span class="hs-identifier hs-var">serverName</span></a></span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679178235"><span class="annot"><span class="annottext">allCreds :: Credentials
</span><a href="#local-6989586621679178235"><span class="hs-identifier hs-var hs-var">allCreds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Credential -&gt; Bool) -&gt; Credentials -&gt; Credentials
</span><a href="Network.TLS.Handshake.Server.html#filterCredentials"><span class="hs-identifier hs-var">filterCredentials</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Version -&gt; [ExtensionRaw] -&gt; Credential -&gt; Bool
</span><a href="Network.TLS.Handshake.Server.html#isCredentialAllowed"><span class="hs-identifier hs-var">isCredentialAllowed</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178246"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178245"><span class="hs-identifier hs-var">exts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-169"></span><span>                       </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178239"><span class="hs-identifier hs-var">extraCreds</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`mappend`</span></span><span> </span><span class="annot"><span class="annottext">Shared -&gt; Credentials
</span><a href="Network.TLS.Parameters.html#sharedCredentials"><span class="hs-identifier hs-var">sharedCredentials</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Shared
</span><a href="Network.TLS.Context.Internal.html#ctxShared"><span class="hs-identifier hs-var">ctxShared</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178247"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-comment">-- If compression is null, commonCompressions should be [0].</span><span>
</span><span id="line-172"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Compression]
</span><a href="#local-6989586621679178229"><span class="hs-identifier hs-var">commonCompressions</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-173"></span><span>        </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;no compression in common with the client&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-comment">-- When selecting a cipher we must ensure that it is allowed for the</span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-comment">-- TLS version but also that all its key-exchange requirements</span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-comment">-- will be met.</span><span>
</span><span id="line-178"></span><span>
</span><span id="line-179"></span><span>    </span><span class="hs-comment">-- Some ciphers require a signature and a hash.  With TLS 1.2 the hash</span><span>
</span><span id="line-180"></span><span>    </span><span class="hs-comment">-- algorithm is selected from a combination of server configuration and</span><span>
</span><span id="line-181"></span><span>    </span><span class="hs-comment">-- the client &quot;supported_signatures&quot; extension.  So we cannot pick</span><span>
</span><span id="line-182"></span><span>    </span><span class="hs-comment">-- such a cipher if no hash is available for it.  It's best to skip this</span><span>
</span><span id="line-183"></span><span>    </span><span class="hs-comment">-- cipher and pick another one (with another key exchange).</span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-comment">-- Cipher selection is performed in two steps: first server credentials</span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-comment">-- are flagged as not suitable for signature if not compatible with</span><span>
</span><span id="line-187"></span><span>    </span><span class="hs-comment">-- negotiated signature parameters.  Then ciphers are evalutated from</span><span>
</span><span id="line-188"></span><span>    </span><span class="hs-comment">-- the resulting credentials.</span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679178228"><span class="annot"><span class="annottext">possibleGroups :: [Group]
</span><a href="#local-6989586621679178228"><span class="hs-identifier hs-var hs-var">possibleGroups</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; [ExtensionRaw] -&gt; [Group]
</span><a href="Network.TLS.Handshake.Server.html#negotiatedGroupsInCommon"><span class="hs-identifier hs-var">negotiatedGroupsInCommon</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178247"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178245"><span class="hs-identifier hs-var">exts</span></a></span><span>
</span><span id="line-191"></span><span>        </span><span id="local-6989586621679178225"><span class="annot"><span class="annottext">possibleECGroups :: [Group]
</span><a href="#local-6989586621679178225"><span class="hs-identifier hs-var hs-var">possibleECGroups</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679178228"><span class="hs-identifier hs-var">possibleGroups</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">`intersect`</span></span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="Network.TLS.Crypto.Types.html#availableECGroups"><span class="hs-identifier hs-var">availableECGroups</span></a></span><span>
</span><span id="line-192"></span><span>        </span><span id="local-6989586621679178221"><span class="annot"><span class="annottext">possibleFFGroups :: [Group]
</span><a href="#local-6989586621679178221"><span class="hs-identifier hs-var hs-var">possibleFFGroups</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679178228"><span class="hs-identifier hs-var">possibleGroups</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">`intersect`</span></span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="Network.TLS.Crypto.Types.html#availableFFGroups"><span class="hs-identifier hs-var">availableFFGroups</span></a></span><span>
</span><span id="line-193"></span><span>        </span><span id="local-6989586621679178218"><span class="annot"><span class="annottext">hasCommonGroupForECDHE :: Bool
</span><a href="#local-6989586621679178218"><span class="hs-identifier hs-var hs-var">hasCommonGroupForECDHE</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679178225"><span class="hs-identifier hs-var">possibleECGroups</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>        </span><span id="local-6989586621679178216"><span class="annot"><span class="annottext">hasCommonGroupForFFDHE :: Bool
</span><a href="#local-6989586621679178216"><span class="hs-identifier hs-var hs-var">hasCommonGroupForFFDHE</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679178221"><span class="hs-identifier hs-var">possibleFFGroups</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>        </span><span id="local-6989586621679178215"><span class="annot"><span class="annottext">hasCustomGroupForFFDHE :: Bool
</span><a href="#local-6989586621679178215"><span class="hs-identifier hs-var hs-var">hasCustomGroupForFFDHE</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerParams -&gt; Maybe DHParams
</span><a href="Network.TLS.Parameters.html#serverDHEParams"><span class="hs-identifier hs-var">serverDHEParams</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679178248"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>        </span><span id="local-6989586621679178212"><span class="annot"><span class="annottext">canFFDHE :: Bool
</span><a href="#local-6989586621679178212"><span class="hs-identifier hs-var hs-var">canFFDHE</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178215"><span class="hs-identifier hs-var">hasCustomGroupForFFDHE</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178216"><span class="hs-identifier hs-var">hasCommonGroupForFFDHE</span></a></span><span>
</span><span id="line-197"></span><span>        </span><span id="local-6989586621679178210"><span class="annot"><span class="annottext">hasCommonGroup :: Cipher -&gt; Bool
</span><a href="#local-6989586621679178210"><span class="hs-identifier hs-var hs-var">hasCommonGroup</span></a></span></span><span> </span><span id="local-6989586621679178209"><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679178209"><span class="hs-identifier hs-var">cipher</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-198"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#cipherKeyExchange"><span class="hs-identifier hs-var">cipherKeyExchange</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679178209"><span class="hs-identifier hs-var">cipher</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-199"></span><span>                </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DH_Anon"><span class="hs-identifier hs-var">CipherKeyExchange_DH_Anon</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178212"><span class="hs-identifier hs-var">canFFDHE</span></a></span><span>
</span><span id="line-200"></span><span>                </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DHE_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_DHE_RSA</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178212"><span class="hs-identifier hs-var">canFFDHE</span></a></span><span>
</span><span id="line-201"></span><span>                </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DHE_DSS"><span class="hs-identifier hs-var">CipherKeyExchange_DHE_DSS</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178212"><span class="hs-identifier hs-var">canFFDHE</span></a></span><span>
</span><span id="line-202"></span><span>                </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_ECDHE_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_ECDHE_RSA</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178218"><span class="hs-identifier hs-var">hasCommonGroupForECDHE</span></a></span><span>
</span><span id="line-203"></span><span>                </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_ECDHE_ECDSA"><span class="hs-identifier hs-var">CipherKeyExchange_ECDHE_ECDSA</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178218"><span class="hs-identifier hs-var">hasCommonGroupForECDHE</span></a></span><span>
</span><span id="line-204"></span><span>                </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><span class="hs-identifier">_</span></span><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- group not used</span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span>        </span><span class="hs-comment">-- Ciphers are selected according to TLS version, availability of</span><span>
</span><span id="line-207"></span><span>        </span><span class="hs-comment">-- (EC)DHE group and credential depending on key exchange.</span><span>
</span><span id="line-208"></span><span>        </span><span id="local-6989586621679178202"><span class="annot"><span class="annottext">cipherAllowed :: Cipher -&gt; Bool
</span><a href="#local-6989586621679178202"><span class="hs-identifier hs-var hs-var">cipherAllowed</span></a></span></span><span> </span><span id="local-6989586621679178201"><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679178201"><span class="hs-identifier hs-var">cipher</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Version -&gt; Cipher -&gt; Bool
</span><a href="Network.TLS.Cipher.html#cipherAllowedForVersion"><span class="hs-identifier hs-var">cipherAllowedForVersion</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178246"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679178201"><span class="hs-identifier hs-var">cipher</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; Bool
</span><a href="#local-6989586621679178210"><span class="hs-identifier hs-var">hasCommonGroup</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679178201"><span class="hs-identifier hs-var">cipher</span></a></span><span>
</span><span id="line-209"></span><span>        </span><span id="local-6989586621679178199"><span class="annot"><span class="annottext">selectCipher :: Credentials -&gt; Credentials -&gt; [Cipher]
</span><a href="#local-6989586621679178199"><span class="hs-identifier hs-var hs-var">selectCipher</span></a></span></span><span> </span><span id="local-6989586621679178198"><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178198"><span class="hs-identifier hs-var">credentials</span></a></span></span><span> </span><span id="local-6989586621679178197"><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178197"><span class="hs-identifier hs-var">signatureCredentials</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; Bool
</span><a href="#local-6989586621679178202"><span class="hs-identifier hs-var">cipherAllowed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Credentials -&gt; Credentials -&gt; [Cipher]
</span><a href="#local-6989586621679178196"><span class="hs-identifier hs-var">commonCiphers</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178198"><span class="hs-identifier hs-var">credentials</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178197"><span class="hs-identifier hs-var">signatureCredentials</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679178195"><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178195"><span class="hs-identifier hs-var">creds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679178194"><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178194"><span class="hs-identifier hs-var">signatureCreds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679178193"><span class="annot"><span class="annottext">[Cipher]
</span><a href="#local-6989586621679178193"><span class="hs-identifier hs-var">ciphersFilteredVersion</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178246"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-213"></span><span>                  </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS12"><span class="hs-identifier hs-var">TLS12</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Build a list of all hash/signature algorithms in common between</span><span>
</span><span id="line-214"></span><span>                               </span><span class="hs-comment">-- client and server.</span><span>
</span><span id="line-215"></span><span>                               </span><span id="local-6989586621679178192"><span class="annot"><span class="annottext">possibleHashSigAlgs :: [HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679178192"><span class="hs-identifier hs-var hs-var">possibleHashSigAlgs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; [ExtensionRaw] -&gt; [HashAndSignatureAlgorithm]
</span><a href="Network.TLS.Handshake.Server.html#hashAndSignaturesInCommon"><span class="hs-identifier hs-var">hashAndSignaturesInCommon</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178247"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178245"><span class="hs-identifier hs-var">exts</span></a></span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span>                               </span><span class="hs-comment">-- Check that a candidate signature credential will be compatible with</span><span>
</span><span id="line-218"></span><span>                               </span><span class="hs-comment">-- client &amp; server hash/signature algorithms.  This returns Just Int</span><span>
</span><span id="line-219"></span><span>                               </span><span class="hs-comment">-- in order to sort credentials according to server hash/signature</span><span>
</span><span id="line-220"></span><span>                               </span><span class="hs-comment">-- preference.  When the certificate has no matching hash/signature in</span><span>
</span><span id="line-221"></span><span>                               </span><span class="hs-comment">-- 'possibleHashSigAlgs' the result is Nothing, and the credential will</span><span>
</span><span id="line-222"></span><span>                               </span><span class="hs-comment">-- not be used to sign.  This avoids a failure later in 'decideHashSig'.</span><span>
</span><span id="line-223"></span><span>                               </span><span id="local-6989586621679178190"><span class="annot"><span class="annottext">signingRank :: Credential -&gt; Maybe Int
</span><a href="#local-6989586621679178190"><span class="hs-identifier hs-var hs-var">signingRank</span></a></span></span><span> </span><span id="local-6989586621679178189"><span class="annot"><span class="annottext">Credential
</span><a href="#local-6989586621679178189"><span class="hs-identifier hs-var">cred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-224"></span><span>                                   </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Credential -&gt; Maybe PubKey
</span><a href="Network.TLS.Handshake.Server.html#credentialDigitalSignatureKey"><span class="hs-identifier hs-var">credentialDigitalSignatureKey</span></a></span><span> </span><span class="annot"><span class="annottext">Credential
</span><a href="#local-6989586621679178189"><span class="hs-identifier hs-var">cred</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-225"></span><span>                                       </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679178187"><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679178187"><span class="hs-identifier hs-var">pub</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; Bool) -&gt; [a] -&gt; Maybe Int
</span><span class="hs-identifier hs-var">findIndex</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679178187"><span class="hs-identifier hs-var">pub</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey -&gt; HashAndSignatureAlgorithm -&gt; Bool
</span><a href="Network.TLS.Handshake.Signature.html#signatureCompatible"><span class="hs-operator hs-var">`signatureCompatible`</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679178192"><span class="hs-identifier hs-var">possibleHashSigAlgs</span></a></span><span>
</span><span id="line-226"></span><span>                                       </span><span class="annot"><span class="annottext">Maybe PubKey
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span>                               </span><span class="hs-comment">-- Finally compute credential lists and resulting cipher list.</span><span>
</span><span id="line-229"></span><span>                               </span><span class="hs-comment">--</span><span>
</span><span id="line-230"></span><span>                               </span><span class="hs-comment">-- We try to keep certificates supported by the client, but</span><span>
</span><span id="line-231"></span><span>                               </span><span class="hs-comment">-- fallback to all credentials if this produces no suitable result</span><span>
</span><span id="line-232"></span><span>                               </span><span class="hs-comment">-- (see RFC 5246 section 7.4.2 and RFC 8446 section 4.4.2.2).</span><span>
</span><span id="line-233"></span><span>                               </span><span class="hs-comment">-- The condition is based on resulting (EC)DHE ciphers so that</span><span>
</span><span id="line-234"></span><span>                               </span><span class="hs-comment">-- filtering credentials does not give advantage to a less secure</span><span>
</span><span id="line-235"></span><span>                               </span><span class="hs-comment">-- key exchange like CipherKeyExchange_RSA or CipherKeyExchange_DH_Anon.</span><span>
</span><span id="line-236"></span><span>                               </span><span id="local-6989586621679178184"><span class="annot"><span class="annottext">cltCreds :: Credentials
</span><a href="#local-6989586621679178184"><span class="hs-identifier hs-var hs-var">cltCreds</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw] -&gt; Credentials -&gt; Credentials
</span><a href="Network.TLS.Handshake.Server.html#filterCredentialsWithHashSignatures"><span class="hs-identifier hs-var">filterCredentialsWithHashSignatures</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178245"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178235"><span class="hs-identifier hs-var">allCreds</span></a></span><span>
</span><span id="line-237"></span><span>                               </span><span id="local-6989586621679178180"><span class="annot"><span class="annottext">sigCltCreds :: Credentials
</span><a href="#local-6989586621679178180"><span class="hs-identifier hs-var hs-var">sigCltCreds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a.
Ord a =&gt;
(Credential -&gt; Maybe a) -&gt; Credentials -&gt; Credentials
</span><a href="Network.TLS.Handshake.Server.html#filterSortCredentials"><span class="hs-identifier hs-var">filterSortCredentials</span></a></span><span> </span><span class="annot"><span class="annottext">Credential -&gt; Maybe Int
</span><a href="#local-6989586621679178190"><span class="hs-identifier hs-var">signingRank</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178184"><span class="hs-identifier hs-var">cltCreds</span></a></span><span>
</span><span id="line-238"></span><span>                               </span><span id="local-6989586621679178177"><span class="annot"><span class="annottext">sigAllCreds :: Credentials
</span><a href="#local-6989586621679178177"><span class="hs-identifier hs-var hs-var">sigAllCreds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a.
Ord a =&gt;
(Credential -&gt; Maybe a) -&gt; Credentials -&gt; Credentials
</span><a href="Network.TLS.Handshake.Server.html#filterSortCredentials"><span class="hs-identifier hs-var">filterSortCredentials</span></a></span><span> </span><span class="annot"><span class="annottext">Credential -&gt; Maybe Int
</span><a href="#local-6989586621679178190"><span class="hs-identifier hs-var">signingRank</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178235"><span class="hs-identifier hs-var">allCreds</span></a></span><span>
</span><span id="line-239"></span><span>                               </span><span id="local-6989586621679178176"><span class="annot"><span class="annottext">cltCiphers :: [Cipher]
</span><a href="#local-6989586621679178176"><span class="hs-identifier hs-var hs-var">cltCiphers</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Credentials -&gt; Credentials -&gt; [Cipher]
</span><a href="#local-6989586621679178199"><span class="hs-identifier hs-var">selectCipher</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178184"><span class="hs-identifier hs-var">cltCreds</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178180"><span class="hs-identifier hs-var">sigCltCreds</span></a></span><span>
</span><span id="line-240"></span><span>                               </span><span id="local-6989586621679178175"><span class="annot"><span class="annottext">allCiphers :: [Cipher]
</span><a href="#local-6989586621679178175"><span class="hs-identifier hs-var hs-var">allCiphers</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Credentials -&gt; Credentials -&gt; [Cipher]
</span><a href="#local-6989586621679178199"><span class="hs-identifier hs-var">selectCipher</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178235"><span class="hs-identifier hs-var">allCreds</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178177"><span class="hs-identifier hs-var">sigAllCreds</span></a></span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span>                               </span><span id="local-6989586621679178174"><span class="annot"><span class="annottext">resultTuple :: (Credentials, Credentials, [Cipher])
</span><a href="#local-6989586621679178174"><span class="hs-identifier hs-var hs-var">resultTuple</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[Cipher] -&gt; Bool
</span><a href="Network.TLS.Handshake.Server.html#cipherListCredentialFallback"><span class="hs-identifier hs-var">cipherListCredentialFallback</span></a></span><span> </span><span class="annot"><span class="annottext">[Cipher]
</span><a href="#local-6989586621679178176"><span class="hs-identifier hs-var">cltCiphers</span></a></span><span>
</span><span id="line-243"></span><span>                                                 </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178235"><span class="hs-identifier hs-var">allCreds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178177"><span class="hs-identifier hs-var">sigAllCreds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Cipher]
</span><a href="#local-6989586621679178175"><span class="hs-identifier hs-var">allCiphers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-244"></span><span>                                                 </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178184"><span class="hs-identifier hs-var">cltCreds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178180"><span class="hs-identifier hs-var">sigCltCreds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Cipher]
</span><a href="#local-6989586621679178176"><span class="hs-identifier hs-var">cltCiphers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>                            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(Credentials, Credentials, [Cipher])
</span><a href="#local-6989586621679178174"><span class="hs-identifier hs-var">resultTuple</span></a></span><span>
</span><span id="line-246"></span><span>                  </span><span class="annot"><span class="annottext">Version
</span><span class="hs-identifier">_</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-247"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679178172"><span class="annot"><span class="annottext">sigAllCreds :: Credentials
</span><a href="#local-6989586621679178172"><span class="hs-identifier hs-var hs-var">sigAllCreds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Credential -&gt; Bool) -&gt; Credentials -&gt; Credentials
</span><a href="Network.TLS.Handshake.Server.html#filterCredentials"><span class="hs-identifier hs-var">filterCredentials</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Credential -&gt; Maybe PubKey
</span><a href="Network.TLS.Handshake.Server.html#credentialDigitalSignatureKey"><span class="hs-identifier hs-var">credentialDigitalSignatureKey</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178235"><span class="hs-identifier hs-var">allCreds</span></a></span><span>
</span><span id="line-248"></span><span>                        </span><span id="local-6989586621679178171"><span class="annot"><span class="annottext">allCiphers :: [Cipher]
</span><a href="#local-6989586621679178171"><span class="hs-identifier hs-var hs-var">allCiphers</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Credentials -&gt; Credentials -&gt; [Cipher]
</span><a href="#local-6989586621679178199"><span class="hs-identifier hs-var">selectCipher</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178235"><span class="hs-identifier hs-var">allCreds</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178172"><span class="hs-identifier hs-var">sigAllCreds</span></a></span><span>
</span><span id="line-249"></span><span>                     </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178235"><span class="hs-identifier hs-var">allCreds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178172"><span class="hs-identifier hs-var">sigAllCreds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Cipher]
</span><a href="#local-6989586621679178171"><span class="hs-identifier hs-var">allCiphers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span>    </span><span class="hs-comment">-- The shared cipherlist can become empty after filtering for compatible</span><span>
</span><span id="line-252"></span><span>    </span><span class="hs-comment">-- creds, check now before calling onCipherChoosing, which does not handle</span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-comment">-- empty lists.</span><span>
</span><span id="line-254"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Cipher]
</span><a href="#local-6989586621679178193"><span class="hs-identifier hs-var">ciphersFilteredVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-255"></span><span>        </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;no cipher in common with the client&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679178170"><span class="annot"><span class="annottext">usedCipher :: Cipher
</span><a href="#local-6989586621679178170"><span class="hs-identifier hs-var hs-var">usedCipher</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerHooks -&gt; Version -&gt; [Cipher] -&gt; Cipher
</span><a href="Network.TLS.Parameters.html#onCipherChoosing"><span class="hs-identifier hs-var">onCipherChoosing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerParams -&gt; ServerHooks
</span><a href="Network.TLS.Parameters.html#serverHooks"><span class="hs-identifier hs-var">serverHooks</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679178248"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178246"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span> </span><span class="annot"><span class="annottext">[Cipher]
</span><a href="#local-6989586621679178193"><span class="hs-identifier hs-var">ciphersFilteredVersion</span></a></span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span>    </span><span id="local-6989586621679178168"><span class="annot"><span class="annottext">Maybe Credential
</span><a href="#local-6989586621679178168"><span class="hs-identifier hs-var">cred</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#cipherKeyExchange"><span class="hs-identifier hs-var">cipherKeyExchange</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679178170"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-260"></span><span>                </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_RSA</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Credentials -&gt; Maybe Credential
</span><a href="Network.TLS.Credentials.html#credentialsFindForDecrypting"><span class="hs-identifier hs-var">credentialsFindForDecrypting</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178195"><span class="hs-identifier hs-var">creds</span></a></span><span>
</span><span id="line-261"></span><span>                </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DH_Anon"><span class="hs-identifier hs-var">CipherKeyExchange_DH_Anon</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>   </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-262"></span><span>                </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DHE_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_DHE_RSA</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg -&gt; Credentials -&gt; Maybe Credential
</span><a href="Network.TLS.Credentials.html#credentialsFindForSigning"><span class="hs-identifier hs-var">credentialsFindForSigning</span></a></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="Network.TLS.Crypto.Types.html#KX_RSA"><span class="hs-identifier hs-var">KX_RSA</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178194"><span class="hs-identifier hs-var">signatureCreds</span></a></span><span>
</span><span id="line-263"></span><span>                </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DHE_DSS"><span class="hs-identifier hs-var">CipherKeyExchange_DHE_DSS</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg -&gt; Credentials -&gt; Maybe Credential
</span><a href="Network.TLS.Credentials.html#credentialsFindForSigning"><span class="hs-identifier hs-var">credentialsFindForSigning</span></a></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="Network.TLS.Crypto.Types.html#KX_DSS"><span class="hs-identifier hs-var">KX_DSS</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178194"><span class="hs-identifier hs-var">signatureCreds</span></a></span><span>
</span><span id="line-264"></span><span>                </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_ECDHE_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_ECDHE_RSA</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg -&gt; Credentials -&gt; Maybe Credential
</span><a href="Network.TLS.Credentials.html#credentialsFindForSigning"><span class="hs-identifier hs-var">credentialsFindForSigning</span></a></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="Network.TLS.Crypto.Types.html#KX_RSA"><span class="hs-identifier hs-var">KX_RSA</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178194"><span class="hs-identifier hs-var">signatureCreds</span></a></span><span>
</span><span id="line-265"></span><span>                </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_ECDHE_ECDSA"><span class="hs-identifier hs-var">CipherKeyExchange_ECDHE_ECDSA</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg -&gt; Credentials -&gt; Maybe Credential
</span><a href="Network.TLS.Credentials.html#credentialsFindForSigning"><span class="hs-identifier hs-var">credentialsFindForSigning</span></a></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="Network.TLS.Crypto.Types.html#KX_ECDSA"><span class="hs-identifier hs-var">KX_ECDSA</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178194"><span class="hs-identifier hs-var">signatureCreds</span></a></span><span>
</span><span id="line-266"></span><span>                </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><span class="hs-identifier">_</span></span><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;key exchange algorithm not implemented&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-267"></span><span>
</span><span id="line-268"></span><span>    </span><span id="local-6989586621679178161"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178161"><span class="hs-identifier hs-var">ems</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
Context -&gt; Version -&gt; MessageType -&gt; [ExtensionRaw] -&gt; m Bool
</span><a href="Network.TLS.Handshake.Common.html#processExtendedMasterSec"><span class="hs-identifier hs-var">processExtendedMasterSec</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178247"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178246"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTClientHello"><span class="hs-identifier hs-var">MsgTClientHello</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178245"><span class="hs-identifier hs-var">exts</span></a></span><span>
</span><span id="line-269"></span><span>    </span><span id="local-6989586621679178159"><span class="annot"><span class="annottext">Maybe SessionData
</span><a href="#local-6989586621679178159"><span class="hs-identifier hs-var">resumeSessionData</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679178240"><span class="hs-identifier hs-var">clientSession</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-270"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#Session"><span class="hs-identifier hs-type">Session</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679178157"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679178157"><span class="hs-identifier hs-var">clientSessionId</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-271"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679178155"><span class="annot"><span class="annottext">resume :: IO (Maybe SessionData)
</span><a href="#local-6989586621679178155"><span class="hs-identifier hs-var hs-var">resume</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SessionManager -&gt; ByteString -&gt; IO (Maybe SessionData)
</span><a href="Network.TLS.Session.html#sessionResume"><span class="hs-identifier hs-var">sessionResume</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shared -&gt; SessionManager
</span><a href="Network.TLS.Parameters.html#sharedSessionManager"><span class="hs-identifier hs-var">sharedSessionManager</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Shared
</span><a href="Network.TLS.Context.Internal.html#ctxShared"><span class="hs-identifier hs-var">ctxShared</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178247"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679178157"><span class="hs-identifier hs-var">clientSessionId</span></a></span><span>
</span><span id="line-272"></span><span>                </span><span class="annot"><span class="annottext">IO (Maybe SessionData)
</span><a href="#local-6989586621679178155"><span class="hs-identifier hs-var">resume</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *}.
MonadIO m =&gt;
Maybe String -&gt; Bool -&gt; Maybe SessionData -&gt; m (Maybe SessionData)
</span><a href="#local-6989586621679178152"><span class="hs-identifier hs-var">validateSession</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621679178243"><span class="hs-identifier hs-var">serverName</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178161"><span class="hs-identifier hs-var">ems</span></a></span><span>
</span><span id="line-273"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#Session"><span class="hs-identifier hs-type">Session</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-274"></span><span>
</span><span id="line-275"></span><span>    </span><span class="hs-comment">-- Currently, we don't send back EcPointFormats. In this case,</span><span>
</span><span id="line-276"></span><span>    </span><span class="hs-comment">-- the client chooses EcPointFormat_Uncompressed.</span><span>
</span><span id="line-277"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; [ExtensionRaw] -&gt; Maybe ByteString
</span><a href="Network.TLS.Handshake.Common.html#extensionLookup"><span class="hs-identifier hs-var">extensionLookup</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_EcPointFormats"><span class="hs-identifier hs-var">extensionID_EcPointFormats</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178245"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTClientHello"><span class="hs-identifier hs-var">MsgTClientHello</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-278"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#EcPointFormatsSupported"><span class="hs-identifier hs-type">EcPointFormatsSupported</span></a></span><span> </span><span id="local-6989586621679178149"><span class="annot"><span class="annottext">[EcPointFormat]
</span><a href="#local-6989586621679178149"><span class="hs-identifier hs-var">fs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178247"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[EcPointFormat] -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setClientEcPointFormatSuggest"><span class="hs-identifier hs-var">setClientEcPointFormatSuggest</span></a></span><span> </span><span class="annot"><span class="annottext">[EcPointFormat]
</span><a href="#local-6989586621679178149"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-279"></span><span>        </span><span class="annot"><span class="annottext">Maybe EcPointFormatsSupported
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span>    </span><span class="annot"><span class="annottext">ServerParams
-&gt; Maybe Credential
-&gt; Context
-&gt; Version
-&gt; Cipher
-&gt; Compression
-&gt; Session
-&gt; Maybe SessionData
-&gt; [ExtensionRaw]
-&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#doHandshake"><span class="hs-identifier hs-var">doHandshake</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679178248"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Credential
</span><a href="#local-6989586621679178168"><span class="hs-identifier hs-var">cred</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178247"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178246"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679178170"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="annot"><span class="annottext">Compression
</span><a href="#local-6989586621679178146"><span class="hs-identifier hs-var">usedCompression</span></a></span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679178240"><span class="hs-identifier hs-var">clientSession</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe SessionData
</span><a href="#local-6989586621679178159"><span class="hs-identifier hs-var">resumeSessionData</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178245"><span class="hs-identifier hs-var">exts</span></a></span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-284"></span><span>        </span><span id="local-6989586621679178196"><span class="annot"><span class="annottext">commonCiphers :: Credentials -&gt; Credentials -&gt; [Cipher]
</span><a href="#local-6989586621679178196"><span class="hs-identifier hs-var hs-var">commonCiphers</span></a></span></span><span> </span><span id="local-6989586621679178143"><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178143"><span class="hs-identifier hs-var">creds</span></a></span></span><span> </span><span id="local-6989586621679178142"><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178142"><span class="hs-identifier hs-var">sigCreds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[ExtensionID]
</span><a href="#local-6989586621679178244"><span class="hs-identifier hs-var">ciphers</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; ExtensionID
</span><a href="Network.TLS.Cipher.html#cipherID"><span class="hs-identifier hs-var">cipherID</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerParams -&gt; Credentials -&gt; Credentials -&gt; [Cipher]
</span><a href="Network.TLS.Handshake.Server.html#getCiphers"><span class="hs-identifier hs-var">getCiphers</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679178248"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178143"><span class="hs-identifier hs-var">creds</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679178142"><span class="hs-identifier hs-var">sigCreds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>        </span><span id="local-6989586621679178229"><span class="annot"><span class="annottext">commonCompressions :: [Compression]
</span><a href="#local-6989586621679178229"><span class="hs-identifier hs-var hs-var">commonCompressions</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Compression] -&gt; [CompressionID] -&gt; [Compression]
</span><a href="Network.TLS.Compression.html#compressionIntersectID"><span class="hs-identifier hs-var">compressionIntersectID</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Supported -&gt; [Compression]
</span><a href="Network.TLS.Parameters.html#supportedCompressions"><span class="hs-identifier hs-var">supportedCompressions</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178247"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CompressionID]
</span><a href="#local-6989586621679178241"><span class="hs-identifier hs-var">compressions</span></a></span><span>
</span><span id="line-286"></span><span>        </span><span id="local-6989586621679178146"><span class="annot"><span class="annottext">usedCompression :: Compression
</span><a href="#local-6989586621679178146"><span class="hs-identifier hs-var hs-var">usedCompression</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">head</span></span><span> </span><span class="annot"><span class="annottext">[Compression]
</span><a href="#local-6989586621679178229"><span class="hs-identifier hs-var">commonCompressions</span></a></span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span>        </span><span id="local-6989586621679178152"><span class="annot"><span class="annottext">validateSession :: Maybe String -&gt; Bool -&gt; Maybe SessionData -&gt; m (Maybe SessionData)
</span><a href="#local-6989586621679178152"><span class="hs-identifier hs-var hs-var">validateSession</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe String
</span><span class="hs-identifier">_</span></span><span>   </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span>   </span><span class="annot"><span class="annottext">Maybe SessionData
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-289"></span><span>        </span><span class="annot"><a href="#local-6989586621679178152"><span class="hs-identifier hs-var">validateSession</span></a></span><span> </span><span id="local-6989586621679178114"><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621679178114"><span class="hs-identifier hs-var">sni</span></a></span></span><span> </span><span id="local-6989586621679178113"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178113"><span class="hs-identifier hs-var">ems</span></a></span></span><span> </span><span id="local-6989586621679178112"><span class="annot"><span class="annottext">m :: Maybe SessionData
</span><a href="#local-6989586621679178112"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679178111"><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679178111"><span class="hs-identifier hs-var">sd</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span>            </span><span class="hs-comment">-- SessionData parameters are assumed to match the local server configuration</span><span>
</span><span id="line-291"></span><span>            </span><span class="hs-comment">-- so we need to compare only to ClientHello inputs.  Abbreviated handshake</span><span>
</span><span id="line-292"></span><span>            </span><span class="hs-comment">-- uses the same server_name than full handshake so the same</span><span>
</span><span id="line-293"></span><span>            </span><span class="hs-comment">-- credentials (and thus ciphers) are available.</span><span>
</span><span id="line-294"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178242"><span class="hs-identifier hs-var">clientVersion</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; Version
</span><a href="Network.TLS.Types.html#sessionVersion"><span class="hs-identifier hs-var">sessionVersion</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679178111"><span class="hs-identifier hs-var">sd</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-295"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; ExtensionID
</span><a href="Network.TLS.Types.html#sessionCipher"><span class="hs-identifier hs-var">sessionCipher</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679178111"><span class="hs-identifier hs-var">sd</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`notElem`</span></span><span> </span><span class="annot"><span class="annottext">[ExtensionID]
</span><a href="#local-6989586621679178244"><span class="hs-identifier hs-var">ciphers</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-296"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; CompressionID
</span><a href="Network.TLS.Types.html#sessionCompression"><span class="hs-identifier hs-var">sessionCompression</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679178111"><span class="hs-identifier hs-var">sd</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`notElem`</span></span><span> </span><span class="annot"><span class="annottext">[CompressionID]
</span><a href="#local-6989586621679178241"><span class="hs-identifier hs-var">compressions</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-297"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621679178114"><span class="hs-identifier hs-var">sni</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; Maybe String
</span><a href="Network.TLS.Types.html#sessionClientSNI"><span class="hs-identifier hs-var">sessionClientSNI</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679178111"><span class="hs-identifier hs-var">sd</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621679178114"><span class="hs-identifier hs-var">sni</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-298"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178113"><span class="hs-identifier hs-var">ems</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178105"><span class="hs-identifier hs-var">emsSession</span></a></span><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-299"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178113"><span class="hs-identifier hs-var">ems</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178105"><span class="hs-identifier hs-var">emsSession</span></a></span><span>                         </span><span class="hs-glyph">=</span><span>
</span><span id="line-300"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679178102"><span class="annot"><span class="annottext">err :: String
</span><a href="#local-6989586621679178102"><span class="hs-identifier hs-var hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;client resumes an EMS session without EMS&quot;</span></span><span>
</span><span id="line-301"></span><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679178102"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-302"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe SessionData
</span><a href="#local-6989586621679178112"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-303"></span><span>          </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679178105"><span class="annot"><span class="annottext">emsSession :: Bool
</span><a href="#local-6989586621679178105"><span class="hs-identifier hs-var hs-var">emsSession</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SessionFlag
</span><a href="Network.TLS.Types.html#SessionEMS"><span class="hs-identifier hs-var">SessionEMS</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; [SessionFlag]
</span><a href="Network.TLS.Types.html#sessionFlags"><span class="hs-identifier hs-var">sessionFlags</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679178111"><span class="hs-identifier hs-var">sd</span></a></span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#doHandshake"><span class="hs-identifier hs-type">doHandshake</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ServerParams"><span class="hs-identifier hs-type">ServerParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Network.TLS.Credentials.html#Credential"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Types.html#Version"><span class="hs-identifier hs-type">Version</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Cipher.html#Cipher"><span class="hs-identifier hs-type">Cipher</span></a></span><span>
</span><span id="line-306"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Compression.html#Compression"><span class="hs-identifier hs-type">Compression</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#Session"><span class="hs-identifier hs-type">Session</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Network.TLS.Types.html#SessionData"><span class="hs-identifier hs-type">SessionData</span></a></span><span>
</span><span id="line-307"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-type">ExtensionRaw</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-308"></span><span id="doHandshake"><span class="annot"><span class="annottext">doHandshake :: ServerParams
-&gt; Maybe Credential
-&gt; Context
-&gt; Version
-&gt; Cipher
-&gt; Compression
-&gt; Session
-&gt; Maybe SessionData
-&gt; [ExtensionRaw]
-&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#doHandshake"><span class="hs-identifier hs-var hs-var">doHandshake</span></a></span></span><span> </span><span id="local-6989586621679178096"><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679178096"><span class="hs-identifier hs-var">sparams</span></a></span></span><span> </span><span id="local-6989586621679178095"><span class="annot"><span class="annottext">Maybe Credential
</span><a href="#local-6989586621679178095"><span class="hs-identifier hs-var">mcred</span></a></span></span><span> </span><span id="local-6989586621679178094"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679178093"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178093"><span class="hs-identifier hs-var">chosenVersion</span></a></span></span><span> </span><span id="local-6989586621679178092"><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679178092"><span class="hs-identifier hs-var">usedCipher</span></a></span></span><span> </span><span id="local-6989586621679178091"><span class="annot"><span class="annottext">Compression
</span><a href="#local-6989586621679178091"><span class="hs-identifier hs-var">usedCompression</span></a></span></span><span> </span><span id="local-6989586621679178090"><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679178090"><span class="hs-identifier hs-var">clientSession</span></a></span></span><span> </span><span id="local-6989586621679178089"><span class="annot"><span class="annottext">Maybe SessionData
</span><a href="#local-6989586621679178089"><span class="hs-identifier hs-var">resumeSessionData</span></a></span></span><span> </span><span id="local-6989586621679178088"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178088"><span class="hs-identifier hs-var">exts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe SessionData
</span><a href="#local-6989586621679178089"><span class="hs-identifier hs-var">resumeSessionData</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-310"></span><span>        </span><span class="annot"><span class="annottext">Maybe SessionData
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-311"></span><span>            </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679178087"><span class="hs-identifier hs-var">handshakeSendServerData</span></a></span><span>
</span><span id="line-312"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO ()
</span><a href="Network.TLS.Context.Internal.html#contextFlush"><span class="hs-identifier hs-var">contextFlush</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-313"></span><span>            </span><span class="hs-comment">-- Receive client info until client Finished.</span><span>
</span><span id="line-314"></span><span>            </span><span class="annot"><span class="annottext">ServerParams -&gt; Context -&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#recvClientData"><span class="hs-identifier hs-var">recvClientData</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679178096"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-315"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; Role -&gt; IO ()
</span><a href="Network.TLS.Handshake.Common.html#sendChangeCipherAndFinish"><span class="hs-identifier hs-var">sendChangeCipherAndFinish</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Network.TLS.Types.html#ServerRole"><span class="hs-identifier hs-var">ServerRole</span></a></span><span>
</span><span id="line-316"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679178082"><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679178082"><span class="hs-identifier hs-var">sessionData</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-317"></span><span>            </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Session -&gt; Bool -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setSession"><span class="hs-identifier hs-var">setSession</span></a></span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679178090"><span class="hs-identifier hs-var">clientSession</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-318"></span><span>            </span><span id="local-6989586621679178080"><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679178080"><span class="hs-identifier hs-var">serverhello</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Session -&gt; IO Handshake
</span><a href="#local-6989586621679178079"><span class="hs-identifier hs-var">makeServerHello</span></a></span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679178090"><span class="hs-identifier hs-var">clientSession</span></a></span><span>
</span><span id="line-319"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; Packet -&gt; IO ()
</span><a href="Network.TLS.IO.html#sendPacket"><span class="hs-identifier hs-var">sendPacket</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Handshake] -&gt; Packet
</span><a href="Network.TLS.Struct.html#Handshake"><span class="hs-identifier hs-var">Handshake</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679178080"><span class="hs-identifier hs-var">serverhello</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-320"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679178076"><span class="annot"><span class="annottext">masterSecret :: ByteString
</span><a href="#local-6989586621679178076"><span class="hs-identifier hs-var hs-var">masterSecret</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; ByteString
</span><a href="Network.TLS.Types.html#sessionSecret"><span class="hs-identifier hs-var">sessionSecret</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679178082"><span class="hs-identifier hs-var">sessionData</span></a></span><span>
</span><span id="line-321"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Version -&gt; Role -&gt; ByteString -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setMasterSecret"><span class="hs-identifier hs-var">setMasterSecret</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178093"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Network.TLS.Types.html#ServerRole"><span class="hs-identifier hs-var">ServerRole</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679178076"><span class="hs-identifier hs-var">masterSecret</span></a></span><span>
</span><span id="line-322"></span><span>            </span><span class="annot"><span class="annottext">forall a. LogLabel a =&gt; Context -&gt; a -&gt; IO ()
</span><a href="Network.TLS.Handshake.Key.html#logKey"><span class="hs-identifier hs-var">logKey</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; MasterSecret
</span><a href="Network.TLS.Types.html#MasterSecret"><span class="hs-identifier hs-var">MasterSecret</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679178076"><span class="hs-identifier hs-var">masterSecret</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-323"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; Role -&gt; IO ()
</span><a href="Network.TLS.Handshake.Common.html#sendChangeCipherAndFinish"><span class="hs-identifier hs-var">sendChangeCipherAndFinish</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Network.TLS.Types.html#ServerRole"><span class="hs-identifier hs-var">ServerRole</span></a></span><span>
</span><span id="line-324"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; IO ()
</span><a href="Network.TLS.Handshake.Common.html#recvChangeCipherAndFinish"><span class="hs-identifier hs-var">recvChangeCipherAndFinish</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-325"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; IO ()
</span><a href="Network.TLS.Handshake.Common.html#handshakeTerminate"><span class="hs-identifier hs-var">handshakeTerminate</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-326"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-327"></span><span>        </span><span class="hs-comment">---</span><span>
</span><span id="line-328"></span><span>        </span><span class="hs-comment">-- When the client sends a certificate, check whether</span><span>
</span><span id="line-329"></span><span>        </span><span class="hs-comment">-- it is acceptable for the application.</span><span>
</span><span id="line-330"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-331"></span><span>        </span><span class="hs-comment">---</span><span>
</span><span id="line-332"></span><span>        </span><span id="local-6989586621679178079"><span class="annot"><span class="annottext">makeServerHello :: Session -&gt; IO Handshake
</span><a href="#local-6989586621679178079"><span class="hs-identifier hs-var hs-var">makeServerHello</span></a></span></span><span> </span><span id="local-6989586621679178040"><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679178040"><span class="hs-identifier hs-var">session</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-333"></span><span>            </span><span id="local-6989586621679178039"><span class="annot"><span class="annottext">ServerRandom
</span><a href="#local-6989586621679178039"><span class="hs-identifier hs-var">srand</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Version -&gt; [Version] -&gt; IO ServerRandom
</span><a href="Network.TLS.Handshake.Random.html#serverRandom"><span class="hs-identifier hs-var">serverRandom</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178093"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Supported -&gt; [Version]
</span><a href="Network.TLS.Parameters.html#supportedVersions"><span class="hs-identifier hs-var">supportedVersions</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerParams -&gt; Supported
</span><a href="Network.TLS.Parameters.html#serverSupported"><span class="hs-identifier hs-var">serverSupported</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679178096"><span class="hs-identifier hs-var">sparams</span></a></span><span>
</span><span id="line-334"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Credential
</span><a href="#local-6989586621679178095"><span class="hs-identifier hs-var">mcred</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-335"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679178036"><span class="annot"><span class="annottext">Credential
</span><a href="#local-6989586621679178036"><span class="hs-identifier hs-var">cred</span></a></span></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; Credential -&gt; m ()
</span><a href="Network.TLS.Handshake.Server.html#storePrivInfoServer"><span class="hs-identifier hs-var">storePrivInfoServer</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Credential
</span><a href="#local-6989586621679178036"><span class="hs-identifier hs-var">cred</span></a></span><span>
</span><span id="line-336"></span><span>                </span><span class="annot"><span class="annottext">Maybe Credential
</span><span class="hs-identifier">_</span></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- return a sensible error</span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span>            </span><span class="hs-comment">-- in TLS12, we need to check as well the certificates we are sending if they have in the extension</span><span>
</span><span id="line-339"></span><span>            </span><span class="hs-comment">-- the necessary bits set.</span><span>
</span><span id="line-340"></span><span>            </span><span id="local-6989586621679178034"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178034"><span class="hs-identifier hs-var">secReneg</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Bool
</span><a href="Network.TLS.State.html#getSecureRenegotiation"><span class="hs-identifier hs-var">getSecureRenegotiation</span></a></span><span>
</span><span id="line-341"></span><span>            </span><span id="local-6989586621679178032"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178032"><span class="hs-identifier hs-var">secRengExt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178034"><span class="hs-identifier hs-var">secReneg</span></a></span><span>
</span><span id="line-342"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-343"></span><span>                            </span><span id="local-6989586621679178031"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679178031"><span class="hs-identifier hs-var">vf</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-344"></span><span>                                    </span><span id="local-6989586621679178030"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679178030"><span class="hs-identifier hs-var">cvf</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Role -&gt; TLSSt ByteString
</span><a href="Network.TLS.State.html#getVerifiedData"><span class="hs-identifier hs-var">getVerifiedData</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Network.TLS.Types.html#ClientRole"><span class="hs-identifier hs-var">ClientRole</span></a></span><span>
</span><span id="line-345"></span><span>                                    </span><span id="local-6989586621679178027"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679178027"><span class="hs-identifier hs-var">svf</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Role -&gt; TLSSt ByteString
</span><a href="Network.TLS.State.html#getVerifiedData"><span class="hs-identifier hs-var">getVerifiedData</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Network.TLS.Types.html#ServerRole"><span class="hs-identifier hs-var">ServerRole</span></a></span><span>
</span><span id="line-346"></span><span>                                    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; a -&gt; ByteString
</span><a href="Network.TLS.Extension.html#extensionEncode"><span class="hs-identifier hs-var">extensionEncode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Maybe ByteString -&gt; SecureRenegotiation
</span><a href="Network.TLS.Extension.html#SecureRenegotiation"><span class="hs-identifier hs-var">SecureRenegotiation</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679178030"><span class="hs-identifier hs-var">cvf</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679178027"><span class="hs-identifier hs-var">svf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span>                            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; ByteString -&gt; ExtensionRaw
</span><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-var">ExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_SecureRenegotiation"><span class="hs-identifier hs-var">extensionID_SecureRenegotiation</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679178031"><span class="hs-identifier hs-var">vf</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-348"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-349"></span><span>            </span><span id="local-6989586621679178022"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178022"><span class="hs-identifier hs-var">ems</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeM Bool
</span><a href="Network.TLS.Handshake.State.html#getExtendedMasterSec"><span class="hs-identifier hs-var">getExtendedMasterSec</span></a></span><span>
</span><span id="line-350"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679178020"><span class="annot"><span class="annottext">emsExt :: [ExtensionRaw]
</span><a href="#local-6989586621679178020"><span class="hs-identifier hs-var hs-var">emsExt</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178022"><span class="hs-identifier hs-var">ems</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679178017"><span class="annot"><span class="annottext">raw :: ByteString
</span><a href="#local-6989586621679178017"><span class="hs-identifier hs-var hs-var">raw</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; a -&gt; ByteString
</span><a href="Network.TLS.Extension.html#extensionEncode"><span class="hs-identifier hs-var">extensionEncode</span></a></span><span> </span><span class="annot"><span class="annottext">ExtendedMasterSecret
</span><a href="Network.TLS.Extension.html#ExtendedMasterSecret"><span class="hs-identifier hs-var">ExtendedMasterSecret</span></a></span><span>
</span><span id="line-351"></span><span>                                </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; ByteString -&gt; ExtensionRaw
</span><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-var">ExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_ExtendedMasterSecret"><span class="hs-identifier hs-var">extensionID_ExtendedMasterSecret</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679178017"><span class="hs-identifier hs-var">raw</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-352"></span><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-353"></span><span>            </span><span id="local-6989586621679178014"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178014"><span class="hs-identifier hs-var">protoExt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; [ExtensionRaw] -&gt; ServerParams -&gt; IO [ExtensionRaw]
</span><a href="Network.TLS.Handshake.Server.html#applicationProtocol"><span class="hs-identifier hs-var">applicationProtocol</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178088"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679178096"><span class="hs-identifier hs-var">sparams</span></a></span><span>
</span><span id="line-354"></span><span>            </span><span id="local-6989586621679178012"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178012"><span class="hs-identifier hs-var">sniExt</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-355"></span><span>                </span><span id="local-6989586621679178011"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178011"><span class="hs-identifier hs-var">resuming</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Bool
</span><a href="Network.TLS.State.html#isSessionResuming"><span class="hs-identifier hs-var">isSessionResuming</span></a></span><span>
</span><span id="line-356"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679178011"><span class="hs-identifier hs-var">resuming</span></a></span><span>
</span><span id="line-357"></span><span>                  </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-358"></span><span>                  </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-359"></span><span>                    </span><span id="local-6989586621679178009"><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621679178009"><span class="hs-identifier hs-var">msni</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt (Maybe String)
</span><a href="Network.TLS.State.html#getClientSNI"><span class="hs-identifier hs-var">getClientSNI</span></a></span><span>
</span><span id="line-360"></span><span>                    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621679178009"><span class="hs-identifier hs-var">msni</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-361"></span><span>                      </span><span class="hs-comment">-- RFC6066: In this event, the server SHALL include</span><span>
</span><span id="line-362"></span><span>                      </span><span class="hs-comment">-- an extension of type &quot;server_name&quot; in the</span><span>
</span><span id="line-363"></span><span>                      </span><span class="hs-comment">-- (extended) server hello. The &quot;extension_data&quot;</span><span>
</span><span id="line-364"></span><span>                      </span><span class="hs-comment">-- field of this extension SHALL be empty.</span><span>
</span><span id="line-365"></span><span>                      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; ByteString -&gt; ExtensionRaw
</span><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-var">ExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_ServerName"><span class="hs-identifier hs-var">extensionID_ServerName</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-366"></span><span>                      </span><span class="annot"><span class="annottext">Maybe String
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-367"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679178007"><span class="annot"><span class="annottext">extensions :: [ExtensionRaw]
</span><a href="#local-6989586621679178007"><span class="hs-identifier hs-var hs-var">extensions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Shared -&gt; [ExtensionRaw]
</span><a href="Network.TLS.Parameters.html#sharedHelloExtensions"><span class="hs-identifier hs-var">sharedHelloExtensions</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerParams -&gt; Shared
</span><a href="Network.TLS.Parameters.html#serverShared"><span class="hs-identifier hs-var">serverShared</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679178096"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-368"></span><span>                          </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178032"><span class="hs-identifier hs-var">secRengExt</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178020"><span class="hs-identifier hs-var">emsExt</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178014"><span class="hs-identifier hs-var">protoExt</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178012"><span class="hs-identifier hs-var">sniExt</span></a></span><span>
</span><span id="line-369"></span><span>            </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Version -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setVersion"><span class="hs-identifier hs-var">setVersion</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178093"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-370"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Version -&gt; ServerRandom -&gt; Cipher -&gt; Compression -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setServerHelloParameters"><span class="hs-identifier hs-var">setServerHelloParameters</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178093"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span> </span><span class="annot"><span class="annottext">ServerRandom
</span><a href="#local-6989586621679178039"><span class="hs-identifier hs-var">srand</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679178092"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="annot"><span class="annottext">Compression
</span><a href="#local-6989586621679178091"><span class="hs-identifier hs-var">usedCompression</span></a></span><span>
</span><span id="line-371"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Version
-&gt; ServerRandom
-&gt; Session
-&gt; ExtensionID
-&gt; CompressionID
-&gt; [ExtensionRaw]
-&gt; Handshake
</span><a href="Network.TLS.Struct.html#ServerHello"><span class="hs-identifier hs-var">ServerHello</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679178093"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span> </span><span class="annot"><span class="annottext">ServerRandom
</span><a href="#local-6989586621679178039"><span class="hs-identifier hs-var">srand</span></a></span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679178040"><span class="hs-identifier hs-var">session</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cipher -&gt; ExtensionID
</span><a href="Network.TLS.Cipher.html#cipherID"><span class="hs-identifier hs-var">cipherID</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679178092"><span class="hs-identifier hs-var">usedCipher</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-372"></span><span>                                               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Compression -&gt; CompressionID
</span><a href="Network.TLS.Compression.html#compressionID"><span class="hs-identifier hs-var">compressionID</span></a></span><span> </span><span class="annot"><span class="annottext">Compression
</span><a href="#local-6989586621679178091"><span class="hs-identifier hs-var">usedCompression</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178007"><span class="hs-identifier hs-var">extensions</span></a></span><span>
</span><span id="line-373"></span><span>
</span><span id="line-374"></span><span>        </span><span id="local-6989586621679178087"><span class="annot"><span class="annottext">handshakeSendServerData :: IO ()
</span><a href="#local-6989586621679178087"><span class="hs-identifier hs-var hs-var">handshakeSendServerData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-375"></span><span>            </span><span id="local-6989586621679177981"><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679177981"><span class="hs-identifier hs-var">serverSession</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO Session
</span><a href="Network.TLS.Handshake.Common.html#newSession"><span class="hs-identifier hs-var">newSession</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-376"></span><span>            </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Session -&gt; Bool -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setSession"><span class="hs-identifier hs-var">setSession</span></a></span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679177981"><span class="hs-identifier hs-var">serverSession</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-377"></span><span>            </span><span id="local-6989586621679177979"><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679177979"><span class="hs-identifier hs-var">serverhello</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Session -&gt; IO Handshake
</span><a href="#local-6989586621679178079"><span class="hs-identifier hs-var">makeServerHello</span></a></span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679177981"><span class="hs-identifier hs-var">serverSession</span></a></span><span>
</span><span id="line-378"></span><span>            </span><span class="hs-comment">-- send ServerHello &amp; Certificate &amp; ServerKeyXchg &amp; CertReq</span><span>
</span><span id="line-379"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177978"><span class="annot"><span class="annottext">certMsg :: Handshake
</span><a href="#local-6989586621679177978"><span class="hs-identifier hs-var hs-var">certMsg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Credential
</span><a href="#local-6989586621679178095"><span class="hs-identifier hs-var">mcred</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-380"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679177977"><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679177977"><span class="hs-identifier hs-var">srvCerts</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrivKey
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CertificateChain -&gt; Handshake
</span><a href="Network.TLS.Struct.html#Certificates"><span class="hs-identifier hs-var">Certificates</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679177977"><span class="hs-identifier hs-var">srvCerts</span></a></span><span>
</span><span id="line-381"></span><span>                            </span><span class="annot"><span class="annottext">Maybe Credential
</span><span class="hs-identifier">_</span></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CertificateChain -&gt; Handshake
</span><a href="Network.TLS.Struct.html#Certificates"><span class="hs-identifier hs-var">Certificates</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SignedExact Certificate] -&gt; CertificateChain
</span><span class="hs-identifier hs-var">CertificateChain</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-382"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; Packet -&gt; IO ()
</span><a href="Network.TLS.IO.html#sendPacket"><span class="hs-identifier hs-var">sendPacket</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Handshake] -&gt; Packet
</span><a href="Network.TLS.Struct.html#Handshake"><span class="hs-identifier hs-var">Handshake</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679177979"><span class="hs-identifier hs-var">serverhello</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679177978"><span class="hs-identifier hs-var">certMsg</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-383"></span><span>
</span><span id="line-384"></span><span>            </span><span class="hs-comment">-- send server key exchange if needed</span><span>
</span><span id="line-385"></span><span>            </span><span id="local-6989586621679177974"><span class="annot"><span class="annottext">Maybe ServerKeyXchgAlgorithmData
</span><a href="#local-6989586621679177974"><span class="hs-identifier hs-var">skx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#cipherKeyExchange"><span class="hs-identifier hs-var">cipherKeyExchange</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679178092"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-386"></span><span>                        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DH_Anon"><span class="hs-identifier hs-var">CipherKeyExchange_DH_Anon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO ServerKeyXchgAlgorithmData
</span><a href="#local-6989586621679177972"><span class="hs-identifier hs-var">generateSKX_DH_Anon</span></a></span><span>
</span><span id="line-387"></span><span>                        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DHE_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_DHE_RSA</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg -&gt; IO ServerKeyXchgAlgorithmData
</span><a href="#local-6989586621679177971"><span class="hs-identifier hs-var">generateSKX_DHE</span></a></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="Network.TLS.Crypto.Types.html#KX_RSA"><span class="hs-identifier hs-var">KX_RSA</span></a></span><span>
</span><span id="line-388"></span><span>                        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DHE_DSS"><span class="hs-identifier hs-var">CipherKeyExchange_DHE_DSS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg -&gt; IO ServerKeyXchgAlgorithmData
</span><a href="#local-6989586621679177971"><span class="hs-identifier hs-var">generateSKX_DHE</span></a></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="Network.TLS.Crypto.Types.html#KX_DSS"><span class="hs-identifier hs-var">KX_DSS</span></a></span><span>
</span><span id="line-389"></span><span>                        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_ECDHE_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_ECDHE_RSA</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg -&gt; IO ServerKeyXchgAlgorithmData
</span><a href="#local-6989586621679177970"><span class="hs-identifier hs-var">generateSKX_ECDHE</span></a></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="Network.TLS.Crypto.Types.html#KX_RSA"><span class="hs-identifier hs-var">KX_RSA</span></a></span><span>
</span><span id="line-390"></span><span>                        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_ECDHE_ECDSA"><span class="hs-identifier hs-var">CipherKeyExchange_ECDHE_ECDSA</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg -&gt; IO ServerKeyXchgAlgorithmData
</span><a href="#local-6989586621679177970"><span class="hs-identifier hs-var">generateSKX_ECDHE</span></a></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="Network.TLS.Crypto.Types.html#KX_ECDSA"><span class="hs-identifier hs-var">KX_ECDSA</span></a></span><span>
</span><span id="line-391"></span><span>                        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><span class="hs-identifier">_</span></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-392"></span><span>            </span><span class="annot"><span class="annottext">forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Packet -&gt; IO ()
</span><a href="Network.TLS.IO.html#sendPacket"><span class="hs-identifier hs-var">sendPacket</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Handshake] -&gt; Packet
</span><a href="Network.TLS.Struct.html#Handshake"><span class="hs-identifier hs-var">Handshake</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ServerKeyXchgAlgorithmData -&gt; Handshake
</span><a href="Network.TLS.Struct.html#ServerKeyXchg"><span class="hs-identifier hs-var">ServerKeyXchg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe ServerKeyXchgAlgorithmData
</span><a href="#local-6989586621679177974"><span class="hs-identifier hs-var">skx</span></a></span><span>
</span><span id="line-393"></span><span>
</span><span id="line-394"></span><span>            </span><span class="hs-comment">-- FIXME we don't do this on a Anonymous server</span><span>
</span><span id="line-395"></span><span>
</span><span id="line-396"></span><span>            </span><span class="hs-comment">-- When configured, send a certificate request with the DNs of all</span><span>
</span><span id="line-397"></span><span>            </span><span class="hs-comment">-- configured CA certificates.</span><span>
</span><span id="line-398"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-399"></span><span>            </span><span class="hs-comment">-- Client certificates MUST NOT be accepted if not requested.</span><span>
</span><span id="line-400"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-401"></span><span>            </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerParams -&gt; Bool
</span><a href="Network.TLS.Parameters.html#serverWantClientCert"><span class="hs-identifier hs-var">serverWantClientCert</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679178096"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-402"></span><span>                </span><span id="local-6989586621679177967"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177967"><span class="hs-identifier hs-var">usedVersion</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Version
</span><a href="Network.TLS.State.html#getVersion"><span class="hs-identifier hs-var">getVersion</span></a></span><span>
</span><span id="line-403"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177965"><span class="annot"><span class="annottext">defaultCertTypes :: [CertificateType]
</span><a href="#local-6989586621679177965"><span class="hs-identifier hs-var hs-var">defaultCertTypes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CertificateType
</span><a href="Network.TLS.Struct.html#CertificateType_RSA_Sign"><span class="hs-identifier hs-var">CertificateType_RSA_Sign</span></a></span><span>
</span><span id="line-404"></span><span>                                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CertificateType
</span><a href="Network.TLS.Struct.html#CertificateType_DSS_Sign"><span class="hs-identifier hs-var">CertificateType_DSS_Sign</span></a></span><span>
</span><span id="line-405"></span><span>                                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CertificateType
</span><a href="Network.TLS.Struct.html#CertificateType_ECDSA_Sign"><span class="hs-identifier hs-var">CertificateType_ECDSA_Sign</span></a></span><span>
</span><span id="line-406"></span><span>                                       </span><span class="hs-special">]</span><span>
</span><span id="line-407"></span><span>                    </span><span class="hs-special">(</span><span id="local-6989586621679177958"><span class="annot"><span class="annottext">[CertificateType]
</span><a href="#local-6989586621679177958"><span class="hs-identifier hs-var">certTypes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679177957"><span class="annot"><span class="annottext">Maybe [HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177957"><span class="hs-identifier hs-var">hashSigs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-408"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177967"><span class="hs-identifier hs-var">usedVersion</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS12"><span class="hs-identifier hs-var">TLS12</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CertificateType]
</span><a href="#local-6989586621679177965"><span class="hs-identifier hs-var">defaultCertTypes</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-409"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-410"></span><span>                            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177956"><span class="annot"><span class="annottext">as :: [HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177956"><span class="hs-keyword hs-var hs-var">as</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Supported -&gt; [HashAndSignatureAlgorithm]
</span><a href="Network.TLS.Parameters.html#supportedHashSignatures"><span class="hs-identifier hs-var">supportedHashSignatures</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-411"></span><span>                             </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Eq a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">nub</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">HashAndSignatureAlgorithm -&gt; Maybe CertificateType
</span><a href="Network.TLS.Handshake.Signature.html#hashSigToCertType"><span class="hs-identifier hs-var">hashSigToCertType</span></a></span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177956"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177956"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-412"></span><span>                    </span><span id="local-6989586621679177952"><span class="annot"><span class="annottext">creq :: Handshake
</span><a href="#local-6989586621679177952"><span class="hs-identifier hs-var hs-var">creq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CertificateType]
-&gt; Maybe [HashAndSignatureAlgorithm]
-&gt; [DistinguishedName]
-&gt; Handshake
</span><a href="Network.TLS.Struct.html#CertRequest"><span class="hs-identifier hs-var">CertRequest</span></a></span><span> </span><span class="annot"><span class="annottext">[CertificateType]
</span><a href="#local-6989586621679177958"><span class="hs-identifier hs-var">certTypes</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe [HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177957"><span class="hs-identifier hs-var">hashSigs</span></a></span><span>
</span><span id="line-413"></span><span>                               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SignedExact Certificate -&gt; DistinguishedName
</span><a href="Network.TLS.Handshake.Certificate.html#extractCAname"><span class="hs-identifier hs-var">extractCAname</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerParams -&gt; [SignedExact Certificate]
</span><a href="Network.TLS.Parameters.html#serverCACertificates"><span class="hs-identifier hs-var">serverCACertificates</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679178096"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-414"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setCertReqSent"><span class="hs-identifier hs-var">setCertReqSent</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-415"></span><span>                </span><span class="annot"><span class="annottext">Context -&gt; Packet -&gt; IO ()
</span><a href="Network.TLS.IO.html#sendPacket"><span class="hs-identifier hs-var">sendPacket</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Handshake] -&gt; Packet
</span><a href="Network.TLS.Struct.html#Handshake"><span class="hs-identifier hs-var">Handshake</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679177952"><span class="hs-identifier hs-var">creq</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-416"></span><span>
</span><span id="line-417"></span><span>            </span><span class="hs-comment">-- Send HelloDone</span><span>
</span><span id="line-418"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; Packet -&gt; IO ()
</span><a href="Network.TLS.IO.html#sendPacket"><span class="hs-identifier hs-var">sendPacket</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Handshake] -&gt; Packet
</span><a href="Network.TLS.Struct.html#Handshake"><span class="hs-identifier hs-var">Handshake</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Handshake
</span><a href="Network.TLS.Struct.html#ServerHelloDone"><span class="hs-identifier hs-var">ServerHelloDone</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>
</span><span id="line-420"></span><span>        </span><span id="local-6989586621679177934"><span class="annot"><span class="annottext">setup_DHE :: IO ServerDHParams
</span><a href="#local-6989586621679177934"><span class="hs-identifier hs-var hs-var">setup_DHE</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-421"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177932"><span class="annot"><span class="annottext">possibleFFGroups :: [Group]
</span><a href="#local-6989586621679177932"><span class="hs-identifier hs-var hs-var">possibleFFGroups</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; [ExtensionRaw] -&gt; [Group]
</span><a href="Network.TLS.Handshake.Server.html#negotiatedGroupsInCommon"><span class="hs-identifier hs-var">negotiatedGroupsInCommon</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178088"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">`intersect`</span></span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="Network.TLS.Crypto.Types.html#availableFFGroups"><span class="hs-identifier hs-var">availableFFGroups</span></a></span><span>
</span><span id="line-422"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679177931"><span class="annot"><span class="annottext">DHParams
</span><a href="#local-6989586621679177931"><span class="hs-identifier hs-var">dhparams</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679177930"><span class="annot"><span class="annottext">DHPrivate
</span><a href="#local-6989586621679177930"><span class="hs-identifier hs-var">priv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679177929"><span class="annot"><span class="annottext">DHPublic
</span><a href="#local-6989586621679177929"><span class="hs-identifier hs-var">pub</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-423"></span><span>                    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679177932"><span class="hs-identifier hs-var">possibleFFGroups</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-424"></span><span>                        </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-425"></span><span>                            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177928"><span class="annot"><span class="annottext">dhparams :: DHParams
</span><a href="#local-6989586621679177928"><span class="hs-identifier hs-var hs-var">dhparams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. String -&gt; Maybe a -&gt; a
</span><a href="Network.TLS.Util.html#fromJust"><span class="hs-identifier hs-var">fromJust</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;server DHE Params&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerParams -&gt; Maybe DHParams
</span><a href="Network.TLS.Parameters.html#serverDHEParams"><span class="hs-identifier hs-var">serverDHEParams</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679178096"><span class="hs-identifier hs-var">sparams</span></a></span><span>
</span><span id="line-426"></span><span>                             </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DHParams -&gt; Maybe Group
</span><a href="Network.TLS.Crypto.html#findFiniteFieldGroup"><span class="hs-identifier hs-var">findFiniteFieldGroup</span></a></span><span> </span><span class="annot"><span class="annottext">DHParams
</span><a href="#local-6989586621679177928"><span class="hs-identifier hs-var">dhparams</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-427"></span><span>                                    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679177926"><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679177926"><span class="hs-identifier hs-var">g</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-428"></span><span>                                        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Group -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setNegotiatedGroup"><span class="hs-identifier hs-var">setNegotiatedGroup</span></a></span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679177926"><span class="hs-identifier hs-var">g</span></a></span><span>
</span><span id="line-429"></span><span>                                        </span><span class="annot"><span class="annottext">Context -&gt; Group -&gt; IO (DHParams, DHPrivate, DHPublic)
</span><a href="Network.TLS.Handshake.Key.html#generateFFDHE"><span class="hs-identifier hs-var">generateFFDHE</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679177926"><span class="hs-identifier hs-var">g</span></a></span><span>
</span><span id="line-430"></span><span>                                    </span><span class="annot"><span class="annottext">Maybe Group
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-431"></span><span>                                        </span><span class="hs-special">(</span><span id="local-6989586621679177923"><span class="annot"><span class="annottext">DHPrivate
</span><a href="#local-6989586621679177923"><span class="hs-identifier hs-var">priv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679177922"><span class="annot"><span class="annottext">DHPublic
</span><a href="#local-6989586621679177922"><span class="hs-identifier hs-var">pub</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; DHParams -&gt; IO (DHPrivate, DHPublic)
</span><a href="Network.TLS.Handshake.Key.html#generateDHE"><span class="hs-identifier hs-var">generateDHE</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">DHParams
</span><a href="#local-6989586621679177928"><span class="hs-identifier hs-var">dhparams</span></a></span><span>
</span><span id="line-432"></span><span>                                        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DHParams
</span><a href="#local-6989586621679177928"><span class="hs-identifier hs-var">dhparams</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DHPrivate
</span><a href="#local-6989586621679177923"><span class="hs-identifier hs-var">priv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DHPublic
</span><a href="#local-6989586621679177922"><span class="hs-identifier hs-var">pub</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-433"></span><span>                        </span><span id="local-6989586621679177920"><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679177920"><span class="hs-identifier hs-var">g</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[Group]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-434"></span><span>                            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Group -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setNegotiatedGroup"><span class="hs-identifier hs-var">setNegotiatedGroup</span></a></span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679177920"><span class="hs-identifier hs-var">g</span></a></span><span>
</span><span id="line-435"></span><span>                            </span><span class="annot"><span class="annottext">Context -&gt; Group -&gt; IO (DHParams, DHPrivate, DHPublic)
</span><a href="Network.TLS.Handshake.Key.html#generateFFDHE"><span class="hs-identifier hs-var">generateFFDHE</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679177920"><span class="hs-identifier hs-var">g</span></a></span><span>
</span><span id="line-436"></span><span>
</span><span id="line-437"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177919"><span class="annot"><span class="annottext">serverParams :: ServerDHParams
</span><a href="#local-6989586621679177919"><span class="hs-identifier hs-var hs-var">serverParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DHParams -&gt; DHPublic -&gt; ServerDHParams
</span><a href="Network.TLS.Struct.html#serverDHParamsFrom"><span class="hs-identifier hs-var">serverDHParamsFrom</span></a></span><span> </span><span class="annot"><span class="annottext">DHParams
</span><a href="#local-6989586621679177931"><span class="hs-identifier hs-var">dhparams</span></a></span><span> </span><span class="annot"><span class="annottext">DHPublic
</span><a href="#local-6989586621679177929"><span class="hs-identifier hs-var">pub</span></a></span><span>
</span><span id="line-438"></span><span>
</span><span id="line-439"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerDHParams -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setServerDHParams"><span class="hs-identifier hs-var">setServerDHParams</span></a></span><span> </span><span class="annot"><span class="annottext">ServerDHParams
</span><a href="#local-6989586621679177919"><span class="hs-identifier hs-var">serverParams</span></a></span><span>
</span><span id="line-440"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DHPrivate -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setDHPrivate"><span class="hs-identifier hs-var">setDHPrivate</span></a></span><span> </span><span class="annot"><span class="annottext">DHPrivate
</span><a href="#local-6989586621679177930"><span class="hs-identifier hs-var">priv</span></a></span><span>
</span><span id="line-441"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ServerDHParams
</span><a href="#local-6989586621679177919"><span class="hs-identifier hs-var">serverParams</span></a></span><span>
</span><span id="line-442"></span><span>
</span><span id="line-443"></span><span>        </span><span class="hs-comment">-- Choosing a hash algorithm to sign (EC)DHE parameters</span><span>
</span><span id="line-444"></span><span>        </span><span class="hs-comment">-- in ServerKeyExchange. Hash algorithm is not suggested by</span><span>
</span><span id="line-445"></span><span>        </span><span class="hs-comment">-- the chosen cipher suite. So, it should be selected based on</span><span>
</span><span id="line-446"></span><span>        </span><span class="hs-comment">-- the &quot;signature_algorithms&quot; extension in a client hello.</span><span>
</span><span id="line-447"></span><span>        </span><span class="hs-comment">-- If RSA is also used for key exchange, this function is</span><span>
</span><span id="line-448"></span><span>        </span><span class="hs-comment">-- not called.</span><span>
</span><span id="line-449"></span><span>        </span><span id="local-6989586621679177908"><span class="annot"><span class="annottext">decideHashSig :: PubKey -&gt; IO (Maybe HashAndSignatureAlgorithm)
</span><a href="#local-6989586621679177908"><span class="hs-identifier hs-var hs-var">decideHashSig</span></a></span></span><span> </span><span id="local-6989586621679177907"><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177907"><span class="hs-identifier hs-var">pubKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-450"></span><span>            </span><span id="local-6989586621679177906"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177906"><span class="hs-identifier hs-var">usedVersion</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Version
</span><a href="Network.TLS.State.html#getVersion"><span class="hs-identifier hs-var">getVersion</span></a></span><span>
</span><span id="line-451"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177906"><span class="hs-identifier hs-var">usedVersion</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-452"></span><span>              </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS12"><span class="hs-identifier hs-var">TLS12</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-453"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177905"><span class="annot"><span class="annottext">hashSigs :: [HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177905"><span class="hs-identifier hs-var hs-var">hashSigs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; [ExtensionRaw] -&gt; [HashAndSignatureAlgorithm]
</span><a href="Network.TLS.Handshake.Server.html#hashAndSignaturesInCommon"><span class="hs-identifier hs-var">hashAndSignaturesInCommon</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178088"><span class="hs-identifier hs-var">exts</span></a></span><span>
</span><span id="line-454"></span><span>                  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177907"><span class="hs-identifier hs-var">pubKey</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey -&gt; HashAndSignatureAlgorithm -&gt; Bool
</span><a href="Network.TLS.Handshake.Signature.html#signatureCompatible"><span class="hs-operator hs-var">`signatureCompatible`</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177905"><span class="hs-identifier hs-var">hashSigs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-455"></span><span>                      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;no hash signature for &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PubKey -&gt; String
</span><a href="Network.TLS.X509.html#pubkeyType"><span class="hs-identifier hs-var">pubkeyType</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177907"><span class="hs-identifier hs-var">pubKey</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-456"></span><span>                      </span><span id="local-6989586621679177902"><span class="annot"><span class="annottext">HashAndSignatureAlgorithm
</span><a href="#local-6989586621679177902"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">HashAndSignatureAlgorithm
</span><a href="#local-6989586621679177902"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-457"></span><span>              </span><span class="annot"><span class="annottext">Version
</span><span class="hs-identifier">_</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-458"></span><span>
</span><span id="line-459"></span><span>        </span><span id="local-6989586621679177971"><span class="annot"><span class="annottext">generateSKX_DHE :: KeyExchangeSignatureAlg -&gt; IO ServerKeyXchgAlgorithmData
</span><a href="#local-6989586621679177971"><span class="hs-identifier hs-var hs-var">generateSKX_DHE</span></a></span></span><span> </span><span id="local-6989586621679177888"><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="#local-6989586621679177888"><span class="hs-identifier hs-var">kxsAlg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-460"></span><span>            </span><span id="local-6989586621679177887"><span class="annot"><span class="annottext">ServerDHParams
</span><a href="#local-6989586621679177887"><span class="hs-identifier hs-var">serverParams</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ServerDHParams
</span><a href="#local-6989586621679177934"><span class="hs-identifier hs-var">setup_DHE</span></a></span><span>
</span><span id="line-461"></span><span>            </span><span id="local-6989586621679177886"><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177886"><span class="hs-identifier hs-var">pubKey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m PubKey
</span><a href="Network.TLS.Handshake.Key.html#getLocalPublicKey"><span class="hs-identifier hs-var">getLocalPublicKey</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-462"></span><span>            </span><span id="local-6989586621679177884"><span class="annot"><span class="annottext">Maybe HashAndSignatureAlgorithm
</span><a href="#local-6989586621679177884"><span class="hs-identifier hs-var">mhashSig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PubKey -&gt; IO (Maybe HashAndSignatureAlgorithm)
</span><a href="#local-6989586621679177908"><span class="hs-identifier hs-var">decideHashSig</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177886"><span class="hs-identifier hs-var">pubKey</span></a></span><span>
</span><span id="line-463"></span><span>            </span><span id="local-6989586621679177883"><span class="annot"><span class="annottext">DigitallySigned
</span><a href="#local-6989586621679177883"><span class="hs-identifier hs-var">signed</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; ServerDHParams
-&gt; PubKey
-&gt; Maybe HashAndSignatureAlgorithm
-&gt; IO DigitallySigned
</span><a href="Network.TLS.Handshake.Signature.html#digitallySignDHParams"><span class="hs-identifier hs-var">digitallySignDHParams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">ServerDHParams
</span><a href="#local-6989586621679177887"><span class="hs-identifier hs-var">serverParams</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177886"><span class="hs-identifier hs-var">pubKey</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe HashAndSignatureAlgorithm
</span><a href="#local-6989586621679177884"><span class="hs-identifier hs-var">mhashSig</span></a></span><span>
</span><span id="line-464"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="#local-6989586621679177888"><span class="hs-identifier hs-var">kxsAlg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-465"></span><span>                </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="Network.TLS.Crypto.Types.html#KX_RSA"><span class="hs-identifier hs-var">KX_RSA</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerDHParams -&gt; DigitallySigned -&gt; ServerKeyXchgAlgorithmData
</span><a href="Network.TLS.Struct.html#SKX_DHE_RSA"><span class="hs-identifier hs-var">SKX_DHE_RSA</span></a></span><span> </span><span class="annot"><span class="annottext">ServerDHParams
</span><a href="#local-6989586621679177887"><span class="hs-identifier hs-var">serverParams</span></a></span><span> </span><span class="annot"><span class="annottext">DigitallySigned
</span><a href="#local-6989586621679177883"><span class="hs-identifier hs-var">signed</span></a></span><span>
</span><span id="line-466"></span><span>                </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="Network.TLS.Crypto.Types.html#KX_DSS"><span class="hs-identifier hs-var">KX_DSS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerDHParams -&gt; DigitallySigned -&gt; ServerKeyXchgAlgorithmData
</span><a href="Network.TLS.Struct.html#SKX_DHE_DSS"><span class="hs-identifier hs-var">SKX_DHE_DSS</span></a></span><span> </span><span class="annot"><span class="annottext">ServerDHParams
</span><a href="#local-6989586621679177887"><span class="hs-identifier hs-var">serverParams</span></a></span><span> </span><span class="annot"><span class="annottext">DigitallySigned
</span><a href="#local-6989586621679177883"><span class="hs-identifier hs-var">signed</span></a></span><span>
</span><span id="line-467"></span><span>                </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;generate skx_dhe unsupported key exchange signature: &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="#local-6989586621679177888"><span class="hs-identifier hs-var">kxsAlg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span>        </span><span id="local-6989586621679177972"><span class="annot"><span class="annottext">generateSKX_DH_Anon :: IO ServerKeyXchgAlgorithmData
</span><a href="#local-6989586621679177972"><span class="hs-identifier hs-var hs-var">generateSKX_DH_Anon</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerDHParams -&gt; ServerKeyXchgAlgorithmData
</span><a href="Network.TLS.Struct.html#SKX_DH_Anon"><span class="hs-identifier hs-var">SKX_DH_Anon</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO ServerDHParams
</span><a href="#local-6989586621679177934"><span class="hs-identifier hs-var">setup_DHE</span></a></span><span>
</span><span id="line-470"></span><span>
</span><span id="line-471"></span><span>        </span><span id="local-6989586621679177869"><span class="annot"><span class="annottext">setup_ECDHE :: Group -&gt; IO ServerECDHParams
</span><a href="#local-6989586621679177869"><span class="hs-identifier hs-var hs-var">setup_ECDHE</span></a></span></span><span> </span><span id="local-6989586621679177868"><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679177868"><span class="hs-identifier hs-var">grp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-472"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Group -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setNegotiatedGroup"><span class="hs-identifier hs-var">setNegotiatedGroup</span></a></span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679177868"><span class="hs-identifier hs-var">grp</span></a></span><span>
</span><span id="line-473"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679177867"><span class="annot"><span class="annottext">GroupPrivate
</span><a href="#local-6989586621679177867"><span class="hs-identifier hs-var">srvpri</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679177866"><span class="annot"><span class="annottext">GroupPublic
</span><a href="#local-6989586621679177866"><span class="hs-identifier hs-var">srvpub</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Group -&gt; IO (GroupPrivate, GroupPublic)
</span><a href="Network.TLS.Handshake.Key.html#generateECDHE"><span class="hs-identifier hs-var">generateECDHE</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679177868"><span class="hs-identifier hs-var">grp</span></a></span><span>
</span><span id="line-474"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177864"><span class="annot"><span class="annottext">serverParams :: ServerECDHParams
</span><a href="#local-6989586621679177864"><span class="hs-identifier hs-var hs-var">serverParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Group -&gt; GroupPublic -&gt; ServerECDHParams
</span><a href="Network.TLS.Struct.html#ServerECDHParams"><span class="hs-identifier hs-var">ServerECDHParams</span></a></span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679177868"><span class="hs-identifier hs-var">grp</span></a></span><span> </span><span class="annot"><span class="annottext">GroupPublic
</span><a href="#local-6989586621679177866"><span class="hs-identifier hs-var">srvpub</span></a></span><span>
</span><span id="line-475"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerECDHParams -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setServerECDHParams"><span class="hs-identifier hs-var">setServerECDHParams</span></a></span><span> </span><span class="annot"><span class="annottext">ServerECDHParams
</span><a href="#local-6989586621679177864"><span class="hs-identifier hs-var">serverParams</span></a></span><span>
</span><span id="line-476"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GroupPrivate -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setGroupPrivate"><span class="hs-identifier hs-var">setGroupPrivate</span></a></span><span> </span><span class="annot"><span class="annottext">GroupPrivate
</span><a href="#local-6989586621679177867"><span class="hs-identifier hs-var">srvpri</span></a></span><span>
</span><span id="line-477"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ServerECDHParams
</span><a href="#local-6989586621679177864"><span class="hs-identifier hs-var">serverParams</span></a></span><span>
</span><span id="line-478"></span><span>
</span><span id="line-479"></span><span>        </span><span id="local-6989586621679177970"><span class="annot"><span class="annottext">generateSKX_ECDHE :: KeyExchangeSignatureAlg -&gt; IO ServerKeyXchgAlgorithmData
</span><a href="#local-6989586621679177970"><span class="hs-identifier hs-var hs-var">generateSKX_ECDHE</span></a></span></span><span> </span><span id="local-6989586621679177845"><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="#local-6989586621679177845"><span class="hs-identifier hs-var">kxsAlg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-480"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177843"><span class="annot"><span class="annottext">possibleECGroups :: [Group]
</span><a href="#local-6989586621679177843"><span class="hs-identifier hs-var hs-var">possibleECGroups</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; [ExtensionRaw] -&gt; [Group]
</span><a href="Network.TLS.Handshake.Server.html#negotiatedGroupsInCommon"><span class="hs-identifier hs-var">negotiatedGroupsInCommon</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679178088"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">`intersect`</span></span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="Network.TLS.Crypto.Types.html#availableECGroups"><span class="hs-identifier hs-var">availableECGroups</span></a></span><span>
</span><span id="line-481"></span><span>            </span><span id="local-6989586621679177842"><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679177842"><span class="hs-identifier hs-var">grp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679177843"><span class="hs-identifier hs-var">possibleECGroups</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-482"></span><span>                     </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;no common group&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-483"></span><span>                     </span><span id="local-6989586621679177841"><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679177841"><span class="hs-identifier hs-var">g</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[Group]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679177841"><span class="hs-identifier hs-var">g</span></a></span><span>
</span><span id="line-484"></span><span>            </span><span id="local-6989586621679177840"><span class="annot"><span class="annottext">ServerECDHParams
</span><a href="#local-6989586621679177840"><span class="hs-identifier hs-var">serverParams</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Group -&gt; IO ServerECDHParams
</span><a href="#local-6989586621679177869"><span class="hs-identifier hs-var">setup_ECDHE</span></a></span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679177842"><span class="hs-identifier hs-var">grp</span></a></span><span>
</span><span id="line-485"></span><span>            </span><span id="local-6989586621679177839"><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177839"><span class="hs-identifier hs-var">pubKey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m PubKey
</span><a href="Network.TLS.Handshake.Key.html#getLocalPublicKey"><span class="hs-identifier hs-var">getLocalPublicKey</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-486"></span><span>            </span><span id="local-6989586621679177838"><span class="annot"><span class="annottext">Maybe HashAndSignatureAlgorithm
</span><a href="#local-6989586621679177838"><span class="hs-identifier hs-var">mhashSig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PubKey -&gt; IO (Maybe HashAndSignatureAlgorithm)
</span><a href="#local-6989586621679177908"><span class="hs-identifier hs-var">decideHashSig</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177839"><span class="hs-identifier hs-var">pubKey</span></a></span><span>
</span><span id="line-487"></span><span>            </span><span id="local-6989586621679177837"><span class="annot"><span class="annottext">DigitallySigned
</span><a href="#local-6989586621679177837"><span class="hs-identifier hs-var">signed</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; ServerECDHParams
-&gt; PubKey
-&gt; Maybe HashAndSignatureAlgorithm
-&gt; IO DigitallySigned
</span><a href="Network.TLS.Handshake.Signature.html#digitallySignECDHParams"><span class="hs-identifier hs-var">digitallySignECDHParams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679178094"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">ServerECDHParams
</span><a href="#local-6989586621679177840"><span class="hs-identifier hs-var">serverParams</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177839"><span class="hs-identifier hs-var">pubKey</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe HashAndSignatureAlgorithm
</span><a href="#local-6989586621679177838"><span class="hs-identifier hs-var">mhashSig</span></a></span><span>
</span><span id="line-488"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="#local-6989586621679177845"><span class="hs-identifier hs-var">kxsAlg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-489"></span><span>                </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="Network.TLS.Crypto.Types.html#KX_RSA"><span class="hs-identifier hs-var">KX_RSA</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerECDHParams -&gt; DigitallySigned -&gt; ServerKeyXchgAlgorithmData
</span><a href="Network.TLS.Struct.html#SKX_ECDHE_RSA"><span class="hs-identifier hs-var">SKX_ECDHE_RSA</span></a></span><span> </span><span class="annot"><span class="annottext">ServerECDHParams
</span><a href="#local-6989586621679177840"><span class="hs-identifier hs-var">serverParams</span></a></span><span> </span><span class="annot"><span class="annottext">DigitallySigned
</span><a href="#local-6989586621679177837"><span class="hs-identifier hs-var">signed</span></a></span><span>
</span><span id="line-490"></span><span>                </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="Network.TLS.Crypto.Types.html#KX_ECDSA"><span class="hs-identifier hs-var">KX_ECDSA</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerECDHParams -&gt; DigitallySigned -&gt; ServerKeyXchgAlgorithmData
</span><a href="Network.TLS.Struct.html#SKX_ECDHE_ECDSA"><span class="hs-identifier hs-var">SKX_ECDHE_ECDSA</span></a></span><span> </span><span class="annot"><span class="annottext">ServerECDHParams
</span><a href="#local-6989586621679177840"><span class="hs-identifier hs-var">serverParams</span></a></span><span> </span><span class="annot"><span class="annottext">DigitallySigned
</span><a href="#local-6989586621679177837"><span class="hs-identifier hs-var">signed</span></a></span><span>
</span><span id="line-491"></span><span>                </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><span class="hs-identifier">_</span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;generate skx_ecdhe unsupported key exchange signature: &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="#local-6989586621679177845"><span class="hs-identifier hs-var">kxsAlg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-492"></span><span>
</span><span id="line-493"></span><span>        </span><span class="hs-comment">-- create a DigitallySigned objects for DHParams or ECDHParams.</span><span>
</span><span id="line-494"></span><span>
</span><span id="line-495"></span><span class="hs-comment">-- | receive Client data in handshake until the Finished handshake.</span><span>
</span><span id="line-496"></span><span class="hs-comment">--</span><span>
</span><span id="line-497"></span><span class="hs-comment">--      &lt;- [certificate]</span><span>
</span><span id="line-498"></span><span class="hs-comment">--      &lt;- client key xchg</span><span>
</span><span id="line-499"></span><span class="hs-comment">--      &lt;- [cert verify]</span><span>
</span><span id="line-500"></span><span class="hs-comment">--      &lt;- change cipher</span><span>
</span><span id="line-501"></span><span class="hs-comment">--      &lt;- finish</span><span>
</span><span id="line-502"></span><span class="hs-comment">--</span><span>
</span><span id="line-503"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#recvClientData"><span class="hs-identifier hs-type">recvClientData</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ServerParams"><span class="hs-identifier hs-type">ServerParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-504"></span><span id="recvClientData"><span class="annot"><span class="annottext">recvClientData :: ServerParams -&gt; Context -&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#recvClientData"><span class="hs-identifier hs-var hs-var">recvClientData</span></a></span></span><span> </span><span id="local-6989586621679177833"><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177833"><span class="hs-identifier hs-var">sparams</span></a></span></span><span> </span><span id="local-6989586621679177832"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177832"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; RecvState IO -&gt; IO ()
</span><a href="Network.TLS.Handshake.Common.html#runRecvState"><span class="hs-identifier hs-var">runRecvState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177832"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). (Handshake -&gt; m (RecvState m)) -&gt; RecvState m
</span><a href="Network.TLS.Handshake.Common.html#RecvStateHandshake"><span class="hs-identifier hs-var">RecvStateHandshake</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake -&gt; IO (RecvState IO)
</span><a href="#local-6989586621679177829"><span class="hs-identifier hs-var">processClientCertificate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-505"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679177829"><span class="annot"><span class="annottext">processClientCertificate :: Handshake -&gt; IO (RecvState IO)
</span><a href="#local-6989586621679177829"><span class="hs-identifier hs-var hs-var">processClientCertificate</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#Certificates"><span class="hs-identifier hs-type">Certificates</span></a></span><span> </span><span id="local-6989586621679177824"><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679177824"><span class="hs-identifier hs-var">certs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-506"></span><span>            </span><span class="annot"><span class="annottext">ServerParams -&gt; Context -&gt; CertificateChain -&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#clientCertificate"><span class="hs-identifier hs-var">clientCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177833"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177832"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679177824"><span class="hs-identifier hs-var">certs</span></a></span><span>
</span><span id="line-507"></span><span>
</span><span id="line-508"></span><span>            </span><span class="hs-comment">-- FIXME: We should check whether the certificate</span><span>
</span><span id="line-509"></span><span>            </span><span class="hs-comment">-- matches our request and that we support</span><span>
</span><span id="line-510"></span><span>            </span><span class="hs-comment">-- verifying with that certificate.</span><span>
</span><span id="line-511"></span><span>
</span><span id="line-512"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). (Handshake -&gt; m (RecvState m)) -&gt; RecvState m
</span><a href="Network.TLS.Handshake.Common.html#RecvStateHandshake"><span class="hs-identifier hs-var">RecvStateHandshake</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *}. MonadIO m =&gt; Handshake -&gt; m (RecvState IO)
</span><a href="#local-6989586621679177822"><span class="hs-identifier hs-var">processClientKeyExchange</span></a></span><span>
</span><span id="line-513"></span><span>
</span><span id="line-514"></span><span>        </span><span class="annot"><a href="#local-6989586621679177829"><span class="hs-identifier hs-var">processClientCertificate</span></a></span><span> </span><span id="local-6989586621679177821"><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679177821"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *}. MonadIO m =&gt; Handshake -&gt; m (RecvState IO)
</span><a href="#local-6989586621679177822"><span class="hs-identifier hs-var">processClientKeyExchange</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679177821"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-515"></span><span>
</span><span id="line-516"></span><span>        </span><span class="hs-comment">-- cannot use RecvStateHandshake, as the next message could be a ChangeCipher,</span><span>
</span><span id="line-517"></span><span>        </span><span class="hs-comment">-- so we must process any packet, and in case of handshake call processHandshake manually.</span><span>
</span><span id="line-518"></span><span>        </span><span id="local-6989586621679177822"><span class="annot"><span class="annottext">processClientKeyExchange :: Handshake -&gt; m (RecvState IO)
</span><a href="#local-6989586621679177822"><span class="hs-identifier hs-var hs-var">processClientKeyExchange</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#ClientKeyXchg"><span class="hs-identifier hs-type">ClientKeyXchg</span></a></span><span> </span><span class="annot"><span class="annottext">ClientKeyXchgAlgorithmData
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). (Packet -&gt; m (RecvState m)) -&gt; RecvState m
</span><a href="Network.TLS.Handshake.Common.html#RecvStateNext"><span class="hs-identifier hs-var">RecvStateNext</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *}. MonadIO m =&gt; Packet -&gt; IO (RecvState m)
</span><a href="#local-6989586621679177810"><span class="hs-identifier hs-var">processCertificateVerify</span></a></span><span>
</span><span id="line-519"></span><span>        </span><span class="annot"><a href="#local-6989586621679177822"><span class="hs-identifier hs-var">processClientKeyExchange</span></a></span><span> </span><span id="local-6989586621679177809"><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679177809"><span class="hs-identifier hs-var">p</span></a></span></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; Maybe String -&gt; m a
</span><a href="Network.TLS.Handshake.Common.html#unexpected"><span class="hs-identifier hs-var">unexpected</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679177809"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;client key exchange&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-520"></span><span>
</span><span id="line-521"></span><span>        </span><span class="hs-comment">-- Check whether the client correctly signed the handshake.</span><span>
</span><span id="line-522"></span><span>        </span><span class="hs-comment">-- If not, ask the application on how to proceed.</span><span>
</span><span id="line-523"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-524"></span><span>        </span><span id="local-6989586621679177810"><span class="annot"><span class="annottext">processCertificateVerify :: Packet -&gt; IO (RecvState m)
</span><a href="#local-6989586621679177810"><span class="hs-identifier hs-var hs-var">processCertificateVerify</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#Handshake"><span class="hs-identifier hs-type">Handshake</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679177782"><span class="annot"><span class="annottext">hs :: Handshake
</span><a href="#local-6989586621679177782"><span class="hs-identifier hs-var">hs</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#CertVerify"><span class="hs-identifier hs-type">CertVerify</span></a></span><span> </span><span id="local-6989586621679177780"><span class="annot"><span class="annottext">DigitallySigned
</span><a href="#local-6989586621679177780"><span class="hs-identifier hs-var">dsig</span></a></span></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-525"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; Handshake -&gt; IO ()
</span><a href="Network.TLS.Handshake.Process.html#processHandshake"><span class="hs-identifier hs-var">processHandshake</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177832"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679177782"><span class="hs-identifier hs-var">hs</span></a></span><span>
</span><span id="line-526"></span><span>
</span><span id="line-527"></span><span>            </span><span id="local-6989586621679177779"><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679177779"><span class="hs-identifier hs-var">certs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
Context -&gt; String -&gt; m CertificateChain
</span><a href="Network.TLS.Handshake.Server.html#checkValidClientCertChain"><span class="hs-identifier hs-var">checkValidClientCertChain</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177832"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;change cipher message expected&quot;</span></span><span>
</span><span id="line-528"></span><span>
</span><span id="line-529"></span><span>            </span><span id="local-6989586621679177777"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177777"><span class="hs-identifier hs-var">usedVersion</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177832"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Version
</span><a href="Network.TLS.State.html#getVersion"><span class="hs-identifier hs-var">getVersion</span></a></span><span>
</span><span id="line-530"></span><span>            </span><span class="hs-comment">-- Fetch all handshake messages up to now.</span><span>
</span><span id="line-531"></span><span>            </span><span id="local-6989586621679177776"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177776"><span class="hs-identifier hs-var">msgs</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177832"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; ByteString
</span><span class="hs-identifier hs-var">B.concat</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">HandshakeM [ByteString]
</span><a href="Network.TLS.Handshake.State.html#getHandshakeMessages"><span class="hs-identifier hs-var">getHandshakeMessages</span></a></span><span>
</span><span id="line-532"></span><span>
</span><span id="line-533"></span><span>            </span><span id="local-6989586621679177773"><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177773"><span class="hs-identifier hs-var">pubKey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177832"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeM PubKey
</span><a href="Network.TLS.Handshake.State.html#getRemotePublicKey"><span class="hs-identifier hs-var">getRemotePublicKey</span></a></span><span>
</span><span id="line-534"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadIO m =&gt; Version -&gt; PubKey -&gt; m ()
</span><a href="Network.TLS.Handshake.Key.html#checkDigitalSignatureKey"><span class="hs-identifier hs-var">checkDigitalSignatureKey</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177777"><span class="hs-identifier hs-var">usedVersion</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177773"><span class="hs-identifier hs-var">pubKey</span></a></span><span>
</span><span id="line-535"></span><span>
</span><span id="line-536"></span><span>            </span><span id="local-6989586621679177770"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177770"><span class="hs-identifier hs-var">verif</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; Version -&gt; PubKey -&gt; ByteString -&gt; DigitallySigned -&gt; IO Bool
</span><a href="Network.TLS.Handshake.Signature.html#checkCertificateVerify"><span class="hs-identifier hs-var">checkCertificateVerify</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177832"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177777"><span class="hs-identifier hs-var">usedVersion</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177773"><span class="hs-identifier hs-var">pubKey</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177776"><span class="hs-identifier hs-var">msgs</span></a></span><span> </span><span class="annot"><span class="annottext">DigitallySigned
</span><a href="#local-6989586621679177780"><span class="hs-identifier hs-var">dsig</span></a></span><span>
</span><span id="line-537"></span><span>            </span><span class="annot"><span class="annottext">ServerParams -&gt; Context -&gt; CertificateChain -&gt; Bool -&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#clientCertVerify"><span class="hs-identifier hs-var">clientCertVerify</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177833"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177832"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679177779"><span class="hs-identifier hs-var">certs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177770"><span class="hs-identifier hs-var">verif</span></a></span><span>
</span><span id="line-538"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). (Packet -&gt; m (RecvState m)) -&gt; RecvState m
</span><a href="Network.TLS.Handshake.Common.html#RecvStateNext"><span class="hs-identifier hs-var">RecvStateNext</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {m :: * -&gt; *}.
(MonadIO m, MonadIO m) =&gt;
Packet -&gt; m (RecvState m)
</span><a href="#local-6989586621679177767"><span class="hs-identifier hs-var">expectChangeCipher</span></a></span><span>
</span><span id="line-539"></span><span>
</span><span id="line-540"></span><span>        </span><span class="annot"><a href="#local-6989586621679177810"><span class="hs-identifier hs-var">processCertificateVerify</span></a></span><span> </span><span id="local-6989586621679177766"><span class="annot"><span class="annottext">Packet
</span><a href="#local-6989586621679177766"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-541"></span><span>            </span><span id="local-6989586621679177765"><span class="annot"><span class="annottext">Maybe CertificateChain
</span><a href="#local-6989586621679177765"><span class="hs-identifier hs-var">chain</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177832"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeM (Maybe CertificateChain)
</span><a href="Network.TLS.Handshake.State.html#getClientCertChain"><span class="hs-identifier hs-var">getClientCertChain</span></a></span><span>
</span><span id="line-542"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe CertificateChain
</span><a href="#local-6989586621679177765"><span class="hs-identifier hs-var">chain</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-543"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679177763"><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679177763"><span class="hs-identifier hs-var">cc</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CertificateChain -&gt; Bool
</span><a href="Network.TLS.X509.html#isNullCertificateChain"><span class="hs-identifier hs-var">isNullCertificateChain</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679177763"><span class="hs-identifier hs-var">cc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-544"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cert verify message missing&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#UnexpectedMessage"><span class="hs-identifier hs-var">UnexpectedMessage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-545"></span><span>                </span><span class="annot"><span class="annottext">Maybe CertificateChain
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-546"></span><span>            </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {m :: * -&gt; *}.
(MonadIO m, MonadIO m) =&gt;
Packet -&gt; m (RecvState m)
</span><a href="#local-6989586621679177767"><span class="hs-identifier hs-var">expectChangeCipher</span></a></span><span> </span><span class="annot"><span class="annottext">Packet
</span><a href="#local-6989586621679177766"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-547"></span><span>
</span><span id="line-548"></span><span>        </span><span id="local-6989586621679177767"><span class="annot"><span class="annottext">expectChangeCipher :: Packet -&gt; m (RecvState m)
</span><a href="#local-6989586621679177767"><span class="hs-identifier hs-var hs-var">expectChangeCipher</span></a></span></span><span> </span><span class="annot"><span class="annottext">Packet
</span><a href="Network.TLS.Struct.html#ChangeCipherSpec"><span class="hs-identifier hs-var">ChangeCipherSpec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-549"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). (Handshake -&gt; m (RecvState m)) -&gt; RecvState m
</span><a href="Network.TLS.Handshake.Common.html#RecvStateHandshake"><span class="hs-identifier hs-var">RecvStateHandshake</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {m :: * -&gt; *}.
MonadIO m =&gt;
Handshake -&gt; m (RecvState m)
</span><a href="#local-6989586621679177750"><span class="hs-identifier hs-var">expectFinish</span></a></span><span>
</span><span id="line-550"></span><span>
</span><span id="line-551"></span><span>        </span><span class="annot"><a href="#local-6989586621679177767"><span class="hs-identifier hs-var">expectChangeCipher</span></a></span><span> </span><span id="local-6989586621679177749"><span class="annot"><span class="annottext">Packet
</span><a href="#local-6989586621679177749"><span class="hs-identifier hs-var">p</span></a></span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; Maybe String -&gt; m a
</span><a href="Network.TLS.Handshake.Common.html#unexpected"><span class="hs-identifier hs-var">unexpected</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Packet
</span><a href="#local-6989586621679177749"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;change cipher&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-552"></span><span>
</span><span id="line-553"></span><span>        </span><span id="local-6989586621679177750"><span class="annot"><span class="annottext">expectFinish :: Handshake -&gt; m (RecvState m)
</span><a href="#local-6989586621679177750"><span class="hs-identifier hs-var hs-var">expectFinish</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#Finished"><span class="hs-identifier hs-type">Finished</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). RecvState m
</span><a href="Network.TLS.Handshake.Common.html#RecvStateDone"><span class="hs-identifier hs-var">RecvStateDone</span></a></span><span>
</span><span id="line-554"></span><span>        </span><span class="annot"><a href="#local-6989586621679177750"><span class="hs-identifier hs-var">expectFinish</span></a></span><span> </span><span id="local-6989586621679177739"><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679177739"><span class="hs-identifier hs-var">p</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; Maybe String -&gt; m a
</span><a href="Network.TLS.Handshake.Common.html#unexpected"><span class="hs-identifier hs-var">unexpected</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679177739"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Handshake Finished&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-555"></span><span>
</span><span id="line-556"></span><span id="local-6989586621679178789"><span class="annot"><a href="Network.TLS.Handshake.Server.html#checkValidClientCertChain"><span class="hs-identifier hs-type">checkValidClientCertChain</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679178789"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679178789"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CertificateChain</span></span></span><span>
</span><span id="line-557"></span><span id="checkValidClientCertChain"><span class="annot"><span class="annottext">checkValidClientCertChain :: forall (m :: * -&gt; *).
MonadIO m =&gt;
Context -&gt; String -&gt; m CertificateChain
</span><a href="Network.TLS.Handshake.Server.html#checkValidClientCertChain"><span class="hs-identifier hs-var hs-var">checkValidClientCertChain</span></a></span></span><span> </span><span id="local-6989586621679177731"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177731"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679177730"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679177730"><span class="hs-identifier hs-var">errmsg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-558"></span><span>    </span><span id="local-6989586621679177729"><span class="annot"><span class="annottext">Maybe CertificateChain
</span><a href="#local-6989586621679177729"><span class="hs-identifier hs-var">chain</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177731"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeM (Maybe CertificateChain)
</span><a href="Network.TLS.Handshake.State.html#getClientCertChain"><span class="hs-identifier hs-var">getClientCertChain</span></a></span><span>
</span><span id="line-559"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177728"><span class="annot"><span class="annottext">throwerror :: TLSError
</span><a href="#local-6989586621679177728"><span class="hs-identifier hs-var hs-var">throwerror</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679177730"><span class="hs-identifier hs-var">errmsg</span></a></span><span> </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#UnexpectedMessage"><span class="hs-identifier hs-var">UnexpectedMessage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-560"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe CertificateChain
</span><a href="#local-6989586621679177729"><span class="hs-identifier hs-var">chain</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-561"></span><span>        </span><span class="annot"><span class="annottext">Maybe CertificateChain
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">TLSError
</span><a href="#local-6989586621679177728"><span class="hs-identifier hs-var">throwerror</span></a></span><span>
</span><span id="line-562"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679177727"><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679177727"><span class="hs-identifier hs-var">cc</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CertificateChain -&gt; Bool
</span><a href="Network.TLS.X509.html#isNullCertificateChain"><span class="hs-identifier hs-var">isNullCertificateChain</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679177727"><span class="hs-identifier hs-var">cc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">TLSError
</span><a href="#local-6989586621679177728"><span class="hs-identifier hs-var">throwerror</span></a></span><span>
</span><span id="line-563"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679177727"><span class="hs-identifier hs-var">cc</span></a></span><span>
</span><span id="line-564"></span><span>
</span><span id="line-565"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#hashAndSignaturesInCommon"><span class="hs-identifier hs-type">hashAndSignaturesInCommon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-type">ExtensionRaw</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#HashAndSignatureAlgorithm"><span class="hs-identifier hs-type">HashAndSignatureAlgorithm</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-566"></span><span id="hashAndSignaturesInCommon"><span class="annot"><span class="annottext">hashAndSignaturesInCommon :: Context -&gt; [ExtensionRaw] -&gt; [HashAndSignatureAlgorithm]
</span><a href="Network.TLS.Handshake.Server.html#hashAndSignaturesInCommon"><span class="hs-identifier hs-var hs-var">hashAndSignaturesInCommon</span></a></span></span><span> </span><span id="local-6989586621679177726"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177726"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679177725"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177725"><span class="hs-identifier hs-var">exts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-567"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177722"><span class="annot"><span class="annottext">cHashSigs :: [HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177722"><span class="hs-identifier hs-var hs-var">cHashSigs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; [ExtensionRaw] -&gt; Maybe ByteString
</span><a href="Network.TLS.Handshake.Common.html#extensionLookup"><span class="hs-identifier hs-var">extensionLookup</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_SignatureAlgorithms"><span class="hs-identifier hs-var">extensionID_SignatureAlgorithms</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177725"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTClientHello"><span class="hs-identifier hs-var">MsgTClientHello</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-568"></span><span>            </span><span class="hs-comment">-- See Section 7.4.1.4.1 of RFC 5246.</span><span>
</span><span id="line-569"></span><span>            </span><span class="annot"><span class="annottext">Maybe SignatureAlgorithms
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashAlgorithm
</span><a href="Network.TLS.Struct.html#HashSHA1"><span class="hs-identifier hs-var">HashSHA1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SignatureAlgorithm
</span><a href="Network.TLS.Struct.html#SignatureECDSA"><span class="hs-identifier hs-var">SignatureECDSA</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-570"></span><span>                       </span><span class="hs-special">,</span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashAlgorithm
</span><a href="Network.TLS.Struct.html#HashSHA1"><span class="hs-identifier hs-var">HashSHA1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SignatureAlgorithm
</span><a href="Network.TLS.Struct.html#SignatureRSA"><span class="hs-identifier hs-var">SignatureRSA</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-571"></span><span>                       </span><span class="hs-special">,</span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashAlgorithm
</span><a href="Network.TLS.Struct.html#HashSHA1"><span class="hs-identifier hs-var">HashSHA1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SignatureAlgorithm
</span><a href="Network.TLS.Struct.html#SignatureDSS"><span class="hs-identifier hs-var">SignatureDSS</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-572"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#SignatureAlgorithms"><span class="hs-identifier hs-type">SignatureAlgorithms</span></a></span><span> </span><span id="local-6989586621679177715"><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177715"><span class="hs-identifier hs-var">sas</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177715"><span class="hs-identifier hs-var">sas</span></a></span><span>
</span><span id="line-573"></span><span>        </span><span id="local-6989586621679177714"><span class="annot"><span class="annottext">sHashSigs :: [HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177714"><span class="hs-identifier hs-var hs-var">sHashSigs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Supported -&gt; [HashAndSignatureAlgorithm]
</span><a href="Network.TLS.Parameters.html#supportedHashSignatures"><span class="hs-identifier hs-var">supportedHashSignatures</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177726"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-574"></span><span>        </span><span class="hs-comment">-- The values in the &quot;signature_algorithms&quot; extension</span><span>
</span><span id="line-575"></span><span>        </span><span class="hs-comment">-- are in descending order of preference.</span><span>
</span><span id="line-576"></span><span>        </span><span class="hs-comment">-- However here the algorithms are selected according</span><span>
</span><span id="line-577"></span><span>        </span><span class="hs-comment">-- to server preference in 'supportedHashSignatures'.</span><span>
</span><span id="line-578"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177714"><span class="hs-identifier hs-var">sHashSigs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">`intersect`</span></span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177722"><span class="hs-identifier hs-var">cHashSigs</span></a></span><span>
</span><span id="line-579"></span><span>
</span><span id="line-580"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#negotiatedGroupsInCommon"><span class="hs-identifier hs-type">negotiatedGroupsInCommon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-type">ExtensionRaw</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Crypto.Types.html#Group"><span class="hs-identifier hs-type">Group</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-581"></span><span id="negotiatedGroupsInCommon"><span class="annot"><span class="annottext">negotiatedGroupsInCommon :: Context -&gt; [ExtensionRaw] -&gt; [Group]
</span><a href="Network.TLS.Handshake.Server.html#negotiatedGroupsInCommon"><span class="hs-identifier hs-var hs-var">negotiatedGroupsInCommon</span></a></span></span><span> </span><span id="local-6989586621679177713"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177713"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679177712"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177712"><span class="hs-identifier hs-var">exts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; [ExtensionRaw] -&gt; Maybe ByteString
</span><a href="Network.TLS.Handshake.Common.html#extensionLookup"><span class="hs-identifier hs-var">extensionLookup</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_NegotiatedGroups"><span class="hs-identifier hs-var">extensionID_NegotiatedGroups</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177712"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTClientHello"><span class="hs-identifier hs-var">MsgTClientHello</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-582"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#NegotiatedGroups"><span class="hs-identifier hs-type">NegotiatedGroups</span></a></span><span> </span><span id="local-6989586621679177709"><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679177709"><span class="hs-identifier hs-var">clientGroups</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-583"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177708"><span class="annot"><span class="annottext">serverGroups :: [Group]
</span><a href="#local-6989586621679177708"><span class="hs-identifier hs-var hs-var">serverGroups</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Supported -&gt; [Group]
</span><a href="Network.TLS.Parameters.html#supportedGroups"><span class="hs-identifier hs-var">supportedGroups</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177713"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-584"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679177708"><span class="hs-identifier hs-var">serverGroups</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">`intersect`</span></span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679177709"><span class="hs-identifier hs-var">clientGroups</span></a></span><span>
</span><span id="line-585"></span><span>    </span><span class="annot"><span class="annottext">Maybe NegotiatedGroups
</span><span class="hs-identifier">_</span></span><span>                                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-586"></span><span>
</span><span id="line-587"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#credentialDigitalSignatureKey"><span class="hs-identifier hs-type">credentialDigitalSignatureKey</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Credentials.html#Credential"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PubKey</span></span><span>
</span><span id="line-588"></span><span id="credentialDigitalSignatureKey"><span class="annot"><span class="annottext">credentialDigitalSignatureKey :: Credential -&gt; Maybe PubKey
</span><a href="Network.TLS.Handshake.Server.html#credentialDigitalSignatureKey"><span class="hs-identifier hs-var hs-var">credentialDigitalSignatureKey</span></a></span></span><span> </span><span id="local-6989586621679177706"><span class="annot"><span class="annottext">Credential
</span><a href="#local-6989586621679177706"><span class="hs-identifier hs-var">cred</span></a></span></span><span>
</span><span id="line-589"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(PubKey, PrivKey) -&gt; Bool
</span><a href="Network.TLS.Handshake.Key.html#isDigitalSignaturePair"><span class="hs-identifier hs-var">isDigitalSignaturePair</span></a></span><span> </span><span class="annot"><span class="annottext">(PubKey, PrivKey)
</span><a href="#local-6989586621679177704"><span class="hs-identifier hs-var">keys</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177703"><span class="hs-identifier hs-var">pubkey</span></a></span><span>
</span><span id="line-590"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-591"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679177704"><span class="annot"><span class="annottext">keys :: (PubKey, PrivKey)
</span><a href="#local-6989586621679177704"><span class="hs-identifier hs-var">keys</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679177703"><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177703"><span class="hs-identifier hs-var">pubkey</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrivKey
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Credential -&gt; (PubKey, PrivKey)
</span><a href="Network.TLS.Credentials.html#credentialPublicPrivateKeys"><span class="hs-identifier hs-var">credentialPublicPrivateKeys</span></a></span><span> </span><span class="annot"><span class="annottext">Credential
</span><a href="#local-6989586621679177706"><span class="hs-identifier hs-var">cred</span></a></span><span>
</span><span id="line-592"></span><span>
</span><span id="line-593"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#filterCredentials"><span class="hs-identifier hs-type">filterCredentials</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Credentials.html#Credential"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Credentials.html#Credentials"><span class="hs-identifier hs-type">Credentials</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Credentials.html#Credentials"><span class="hs-identifier hs-type">Credentials</span></a></span><span>
</span><span id="line-594"></span><span id="filterCredentials"><span class="annot"><span class="annottext">filterCredentials :: (Credential -&gt; Bool) -&gt; Credentials -&gt; Credentials
</span><a href="Network.TLS.Handshake.Server.html#filterCredentials"><span class="hs-identifier hs-var hs-var">filterCredentials</span></a></span></span><span> </span><span id="local-6989586621679177701"><span class="annot"><span class="annottext">Credential -&gt; Bool
</span><a href="#local-6989586621679177701"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Credentials.html#Credentials"><span class="hs-identifier hs-type">Credentials</span></a></span><span> </span><span id="local-6989586621679177699"><span class="annot"><span class="annottext">[Credential]
</span><a href="#local-6989586621679177699"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Credential] -&gt; Credentials
</span><a href="Network.TLS.Credentials.html#Credentials"><span class="hs-identifier hs-var">Credentials</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">Credential -&gt; Bool
</span><a href="#local-6989586621679177701"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">[Credential]
</span><a href="#local-6989586621679177699"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-595"></span><span>
</span><span id="line-596"></span><span id="local-6989586621679178840"><span class="annot"><a href="Network.TLS.Handshake.Server.html#filterSortCredentials"><span class="hs-identifier hs-type">filterSortCredentials</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679178840"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Credentials.html#Credential"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679178840"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Credentials.html#Credentials"><span class="hs-identifier hs-type">Credentials</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Credentials.html#Credentials"><span class="hs-identifier hs-type">Credentials</span></a></span></span><span>
</span><span id="line-597"></span><span id="filterSortCredentials"><span class="annot"><span class="annottext">filterSortCredentials :: forall a.
Ord a =&gt;
(Credential -&gt; Maybe a) -&gt; Credentials -&gt; Credentials
</span><a href="Network.TLS.Handshake.Server.html#filterSortCredentials"><span class="hs-identifier hs-var hs-var">filterSortCredentials</span></a></span></span><span> </span><span id="local-6989586621679177697"><span class="annot"><span class="annottext">Credential -&gt; Maybe a
</span><a href="#local-6989586621679177697"><span class="hs-identifier hs-var">rankFun</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Credentials.html#Credentials"><span class="hs-identifier hs-type">Credentials</span></a></span><span> </span><span id="local-6989586621679177696"><span class="annot"><span class="annottext">[Credential]
</span><a href="#local-6989586621679177696"><span class="hs-identifier hs-var">creds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-598"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177692"><span class="annot"><span class="annottext">orderedPairs :: [(Maybe a, Credential)]
</span><a href="#local-6989586621679177692"><span class="hs-identifier hs-var hs-var">orderedPairs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortOn</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Credential -&gt; Maybe a
</span><a href="#local-6989586621679177697"><span class="hs-identifier hs-var">rankFun</span></a></span><span> </span><span class="annot"><span class="annottext">Credential
</span><a href="#local-6989586621679177690"><span class="hs-identifier hs-var">cred</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Credential
</span><a href="#local-6989586621679177690"><span class="hs-identifier hs-var">cred</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679177690"><span class="annot"><span class="annottext">Credential
</span><a href="#local-6989586621679177690"><span class="hs-identifier hs-var">cred</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Credential]
</span><a href="#local-6989586621679177696"><span class="hs-identifier hs-var">creds</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-599"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[Credential] -&gt; Credentials
</span><a href="Network.TLS.Credentials.html#Credentials"><span class="hs-identifier hs-var">Credentials</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Credential
</span><a href="#local-6989586621679177689"><span class="hs-identifier hs-var">cred</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679177689"><span class="annot"><span class="annottext">Credential
</span><a href="#local-6989586621679177689"><span class="hs-identifier hs-var">cred</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Maybe a, Credential)]
</span><a href="#local-6989586621679177692"><span class="hs-identifier hs-var">orderedPairs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-600"></span><span>
</span><span id="line-601"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#isCredentialAllowed"><span class="hs-identifier hs-type">isCredentialAllowed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Types.html#Version"><span class="hs-identifier hs-type">Version</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-type">ExtensionRaw</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Credentials.html#Credential"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-602"></span><span id="isCredentialAllowed"><span class="annot"><span class="annottext">isCredentialAllowed :: Version -&gt; [ExtensionRaw] -&gt; Credential -&gt; Bool
</span><a href="Network.TLS.Handshake.Server.html#isCredentialAllowed"><span class="hs-identifier hs-var hs-var">isCredentialAllowed</span></a></span></span><span> </span><span id="local-6989586621679177688"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177688"><span class="hs-identifier hs-var">ver</span></a></span></span><span> </span><span id="local-6989586621679177687"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177687"><span class="hs-identifier hs-var">exts</span></a></span></span><span> </span><span id="local-6989586621679177686"><span class="annot"><span class="annottext">Credential
</span><a href="#local-6989586621679177686"><span class="hs-identifier hs-var">cred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-603"></span><span>    </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177685"><span class="hs-identifier hs-var">pubkey</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey -&gt; Version -&gt; Bool
</span><a href="Network.TLS.Handshake.Key.html#versionCompatible"><span class="hs-operator hs-var">`versionCompatible`</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177688"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Group -&gt; Bool) -&gt; PubKey -&gt; Bool
</span><a href="Network.TLS.Handshake.Key.html#satisfiesEcPredicate"><span class="hs-identifier hs-var">satisfiesEcPredicate</span></a></span><span> </span><span class="annot"><span class="annottext">Group -&gt; Bool
</span><a href="#local-6989586621679177682"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177685"><span class="hs-identifier hs-var">pubkey</span></a></span><span>
</span><span id="line-604"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-605"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679177685"><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177685"><span class="hs-identifier hs-var">pubkey</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrivKey
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Credential -&gt; (PubKey, PrivKey)
</span><a href="Network.TLS.Credentials.html#credentialPublicPrivateKeys"><span class="hs-identifier hs-var">credentialPublicPrivateKeys</span></a></span><span> </span><span class="annot"><span class="annottext">Credential
</span><a href="#local-6989586621679177686"><span class="hs-identifier hs-var">cred</span></a></span><span>
</span><span id="line-606"></span><span>    </span><span class="hs-comment">-- ECDSA keys are tested against supported elliptic curves until TLS12 but</span><span>
</span><span id="line-607"></span><span>    </span><span class="hs-comment">-- not after.  With TLS13, the curve is linked to the signature algorithm</span><span>
</span><span id="line-608"></span><span>    </span><span class="hs-comment">-- and client support is tested with signatureCompatible13.</span><span>
</span><span id="line-609"></span><span>    </span><span id="local-6989586621679177682"><span class="annot"><span class="annottext">p :: Group -&gt; Bool
</span><a href="#local-6989586621679177682"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177688"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS13"><span class="hs-identifier hs-var">TLS13</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; [ExtensionRaw] -&gt; Maybe ByteString
</span><a href="Network.TLS.Handshake.Common.html#extensionLookup"><span class="hs-identifier hs-var">extensionLookup</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_NegotiatedGroups"><span class="hs-identifier hs-var">extensionID_NegotiatedGroups</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177687"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTClientHello"><span class="hs-identifier hs-var">MsgTClientHello</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-610"></span><span>          </span><span class="annot"><span class="annottext">Maybe NegotiatedGroups
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-611"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#NegotiatedGroups"><span class="hs-identifier hs-type">NegotiatedGroups</span></a></span><span> </span><span id="local-6989586621679177675"><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679177675"><span class="hs-identifier hs-var">sg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679177675"><span class="hs-identifier hs-var">sg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-612"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-613"></span><span>
</span><span id="line-614"></span><span class="hs-comment">-- Filters a list of candidate credentials with credentialMatchesHashSignatures.</span><span>
</span><span id="line-615"></span><span class="hs-comment">--</span><span>
</span><span id="line-616"></span><span class="hs-comment">-- Algorithms to filter with are taken from &quot;signature_algorithms_cert&quot;</span><span>
</span><span id="line-617"></span><span class="hs-comment">-- extension when it exists, else from &quot;signature_algorithms&quot; when clients do</span><span>
</span><span id="line-618"></span><span class="hs-comment">-- not implement the new extension (see RFC 8446 section 4.2.3).</span><span>
</span><span id="line-619"></span><span class="hs-comment">--</span><span>
</span><span id="line-620"></span><span class="hs-comment">-- Resulting credential list can be used as input to the hybrid cipher-and-</span><span>
</span><span id="line-621"></span><span class="hs-comment">-- certificate selection for TLS12, or to the direct certificate selection</span><span>
</span><span id="line-622"></span><span class="hs-comment">-- simplified with TLS13.  As filtering credential signatures with client-</span><span>
</span><span id="line-623"></span><span class="hs-comment">-- advertised algorithms is not supposed to cause negotiation failure, in case</span><span>
</span><span id="line-624"></span><span class="hs-comment">-- of dead end with the subsequent selection process, this process should always</span><span>
</span><span id="line-625"></span><span class="hs-comment">-- be restarted with the unfiltered credential list as input (see fallback</span><span>
</span><span id="line-626"></span><span class="hs-comment">-- certificate chains, described in same RFC section).</span><span>
</span><span id="line-627"></span><span class="hs-comment">--</span><span>
</span><span id="line-628"></span><span class="hs-comment">-- Calling code should not forget to apply constraints of extension</span><span>
</span><span id="line-629"></span><span class="hs-comment">-- &quot;signature_algorithms&quot; to any signature-based key exchange derived from the</span><span>
</span><span id="line-630"></span><span class="hs-comment">-- output credentials.  Respecting client constraints on KX signatures is</span><span>
</span><span id="line-631"></span><span class="hs-comment">-- mandatory but not implemented by this function.</span><span>
</span><span id="line-632"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#filterCredentialsWithHashSignatures"><span class="hs-identifier hs-type">filterCredentialsWithHashSignatures</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-type">ExtensionRaw</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Credentials.html#Credentials"><span class="hs-identifier hs-type">Credentials</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Credentials.html#Credentials"><span class="hs-identifier hs-type">Credentials</span></a></span><span>
</span><span id="line-633"></span><span id="filterCredentialsWithHashSignatures"><span class="annot"><span class="annottext">filterCredentialsWithHashSignatures :: [ExtensionRaw] -&gt; Credentials -&gt; Credentials
</span><a href="Network.TLS.Handshake.Server.html#filterCredentialsWithHashSignatures"><span class="hs-identifier hs-var hs-var">filterCredentialsWithHashSignatures</span></a></span></span><span> </span><span id="local-6989586621679177674"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177674"><span class="hs-identifier hs-var">exts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-634"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall {b}. Extension b =&gt; ExtensionID -&gt; Maybe b
</span><a href="#local-6989586621679177673"><span class="hs-identifier hs-var">withExt</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_SignatureAlgorithmsCert"><span class="hs-identifier hs-var">extensionID_SignatureAlgorithmsCert</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-635"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#SignatureAlgorithmsCert"><span class="hs-identifier hs-type">SignatureAlgorithmsCert</span></a></span><span> </span><span id="local-6989586621679177670"><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177670"><span class="hs-identifier hs-var">sas</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm] -&gt; Credentials -&gt; Credentials
</span><a href="#local-6989586621679177669"><span class="hs-identifier hs-var">withAlgs</span></a></span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177670"><span class="hs-identifier hs-var">sas</span></a></span><span>
</span><span id="line-636"></span><span>        </span><span class="annot"><span class="annottext">Maybe SignatureAlgorithmsCert
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-637"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall {b}. Extension b =&gt; ExtensionID -&gt; Maybe b
</span><a href="#local-6989586621679177673"><span class="hs-identifier hs-var">withExt</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_SignatureAlgorithms"><span class="hs-identifier hs-var">extensionID_SignatureAlgorithms</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-638"></span><span>                </span><span class="annot"><span class="annottext">Maybe SignatureAlgorithms
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-639"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#SignatureAlgorithms"><span class="hs-identifier hs-type">SignatureAlgorithms</span></a></span><span> </span><span id="local-6989586621679177667"><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177667"><span class="hs-identifier hs-var">sas</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm] -&gt; Credentials -&gt; Credentials
</span><a href="#local-6989586621679177669"><span class="hs-identifier hs-var">withAlgs</span></a></span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177667"><span class="hs-identifier hs-var">sas</span></a></span><span>
</span><span id="line-640"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-641"></span><span>    </span><span id="local-6989586621679177673"><span class="annot"><span class="annottext">withExt :: ExtensionID -&gt; Maybe b
</span><a href="#local-6989586621679177673"><span class="hs-identifier hs-var hs-var">withExt</span></a></span></span><span> </span><span id="local-6989586621679177663"><span class="annot"><span class="annottext">ExtensionID
</span><a href="#local-6989586621679177663"><span class="hs-identifier hs-var">extId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; [ExtensionRaw] -&gt; Maybe ByteString
</span><a href="Network.TLS.Handshake.Common.html#extensionLookup"><span class="hs-identifier hs-var">extensionLookup</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="#local-6989586621679177663"><span class="hs-identifier hs-var">extId</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177674"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTClientHello"><span class="hs-identifier hs-var">MsgTClientHello</span></a></span><span>
</span><span id="line-642"></span><span>    </span><span id="local-6989586621679177669"><span class="annot"><span class="annottext">withAlgs :: [HashAndSignatureAlgorithm] -&gt; Credentials -&gt; Credentials
</span><a href="#local-6989586621679177669"><span class="hs-identifier hs-var hs-var">withAlgs</span></a></span></span><span> </span><span id="local-6989586621679177662"><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177662"><span class="hs-identifier hs-var">sas</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Credential -&gt; Bool) -&gt; Credentials -&gt; Credentials
</span><a href="Network.TLS.Handshake.Server.html#filterCredentials"><span class="hs-identifier hs-var">filterCredentials</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm] -&gt; Credential -&gt; Bool
</span><a href="Network.TLS.Credentials.html#credentialMatchesHashSignatures"><span class="hs-identifier hs-var">credentialMatchesHashSignatures</span></a></span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177662"><span class="hs-identifier hs-var">sas</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-643"></span><span>
</span><span id="line-644"></span><span class="hs-comment">-- returns True if certificate filtering with &quot;signature_algorithms_cert&quot; /</span><span>
</span><span id="line-645"></span><span class="hs-comment">-- &quot;signature_algorithms&quot; produced no ephemeral D-H nor TLS13 cipher (so</span><span>
</span><span id="line-646"></span><span class="hs-comment">-- handshake with lower security)</span><span>
</span><span id="line-647"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#cipherListCredentialFallback"><span class="hs-identifier hs-type">cipherListCredentialFallback</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Cipher.html#Cipher"><span class="hs-identifier hs-type">Cipher</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-648"></span><span id="cipherListCredentialFallback"><span class="annot"><span class="annottext">cipherListCredentialFallback :: [Cipher] -&gt; Bool
</span><a href="Network.TLS.Handshake.Server.html#cipherListCredentialFallback"><span class="hs-identifier hs-var hs-var">cipherListCredentialFallback</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; Bool
</span><a href="#local-6989586621679177659"><span class="hs-identifier hs-var">nonDH</span></a></span><span>
</span><span id="line-649"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-650"></span><span>    </span><span id="local-6989586621679177659"><span class="annot"><span class="annottext">nonDH :: Cipher -&gt; Bool
</span><a href="#local-6989586621679177659"><span class="hs-identifier hs-var hs-var">nonDH</span></a></span></span><span> </span><span id="local-6989586621679177658"><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177658"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#cipherKeyExchange"><span class="hs-identifier hs-var">cipherKeyExchange</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177658"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-651"></span><span>        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DHE_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_DHE_RSA</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-652"></span><span>        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DHE_DSS"><span class="hs-identifier hs-var">CipherKeyExchange_DHE_DSS</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-653"></span><span>        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_ECDHE_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_ECDHE_RSA</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-654"></span><span>        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_ECDHE_ECDSA"><span class="hs-identifier hs-var">CipherKeyExchange_ECDHE_ECDSA</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-655"></span><span>        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_TLS13"><span class="hs-identifier hs-var">CipherKeyExchange_TLS13</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-656"></span><span>        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><span class="hs-identifier">_</span></span><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-657"></span><span>
</span><span id="line-658"></span><span id="local-6989586621679178820"><span class="annot"><a href="Network.TLS.Handshake.Server.html#storePrivInfoServer"><span class="hs-identifier hs-type">storePrivInfoServer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679178820"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Credentials.html#Credential"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679178820"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-659"></span><span id="storePrivInfoServer"><span class="annot"><span class="annottext">storePrivInfoServer :: forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; Credential -&gt; m ()
</span><a href="Network.TLS.Handshake.Server.html#storePrivInfoServer"><span class="hs-identifier hs-var hs-var">storePrivInfoServer</span></a></span></span><span> </span><span id="local-6989586621679177648"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177648"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679177647"><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679177647"><span class="hs-identifier hs-var">cc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679177646"><span class="annot"><span class="annottext">PrivKey
</span><a href="#local-6989586621679177646"><span class="hs-identifier hs-var">privkey</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
Context -&gt; CertificateChain -&gt; PrivKey -&gt; m PubKey
</span><a href="Network.TLS.Handshake.Common.html#storePrivInfo"><span class="hs-identifier hs-var">storePrivInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177648"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679177647"><span class="hs-identifier hs-var">cc</span></a></span><span> </span><span class="annot"><span class="annottext">PrivKey
</span><a href="#local-6989586621679177646"><span class="hs-identifier hs-var">privkey</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-660"></span><span>
</span><span id="line-661"></span><span class="hs-comment">-- TLS 1.3 or later</span><span>
</span><span id="line-662"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#handshakeServerWithTLS13"><span class="hs-identifier hs-type">handshakeServerWithTLS13</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ServerParams"><span class="hs-identifier hs-type">ServerParams</span></a></span><span>
</span><span id="line-663"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span>
</span><span id="line-664"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Types.html#Version"><span class="hs-identifier hs-type">Version</span></a></span><span>
</span><span id="line-665"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-type">ExtensionRaw</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-666"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Types.html#CipherID"><span class="hs-identifier hs-type">CipherID</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-667"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-668"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#Session"><span class="hs-identifier hs-type">Session</span></a></span><span>
</span><span id="line-669"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-670"></span><span id="handshakeServerWithTLS13"><span class="annot"><span class="annottext">handshakeServerWithTLS13 :: ServerParams
-&gt; Context
-&gt; Version
-&gt; [ExtensionRaw]
-&gt; [ExtensionID]
-&gt; Maybe String
-&gt; Session
-&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#handshakeServerWithTLS13"><span class="hs-identifier hs-var hs-var">handshakeServerWithTLS13</span></a></span></span><span> </span><span id="local-6989586621679177643"><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177643"><span class="hs-identifier hs-var">sparams</span></a></span></span><span> </span><span id="local-6989586621679177642"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177642"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679177641"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177641"><span class="hs-identifier hs-var">chosenVersion</span></a></span></span><span> </span><span id="local-6989586621679177640"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177640"><span class="hs-identifier hs-var">exts</span></a></span></span><span> </span><span id="local-6989586621679177639"><span class="annot"><span class="annottext">[ExtensionID]
</span><a href="#local-6989586621679177639"><span class="hs-identifier hs-var">clientCiphers</span></a></span></span><span> </span><span id="local-6989586621679177638"><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621679177638"><span class="hs-identifier hs-var">_serverName</span></a></span></span><span> </span><span id="local-6989586621679177637"><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679177637"><span class="hs-identifier hs-var">clientSession</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-671"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-type">ExtensionRaw</span></a></span><span> </span><span id="local-6989586621679177635"><span class="annot"><span class="annottext">ExtensionID
</span><a href="#local-6989586621679177635"><span class="hs-identifier hs-var">eid</span></a></span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="#local-6989586621679177635"><span class="hs-identifier hs-var">eid</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_PreSharedKey"><span class="hs-identifier hs-var">extensionID_PreSharedKey</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177640"><span class="hs-identifier hs-var">exts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-672"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;extension pre_shared_key must be last&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#IllegalParameter"><span class="hs-identifier hs-var">IllegalParameter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-673"></span><span>    </span><span class="hs-comment">-- Deciding cipher.</span><span>
</span><span id="line-674"></span><span>    </span><span class="hs-comment">-- The shared cipherlist can become empty after filtering for compatible</span><span>
</span><span id="line-675"></span><span>    </span><span class="hs-comment">-- creds, check now before calling onCipherChoosing, which does not handle</span><span>
</span><span id="line-676"></span><span>    </span><span class="hs-comment">-- empty lists.</span><span>
</span><span id="line-677"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Cipher]
</span><a href="#local-6989586621679177631"><span class="hs-identifier hs-var">ciphersFilteredVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-678"></span><span>        </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;no cipher in common with the client&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-679"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177630"><span class="annot"><span class="annottext">usedCipher :: Cipher
</span><a href="#local-6989586621679177630"><span class="hs-identifier hs-var hs-var">usedCipher</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerHooks -&gt; Version -&gt; [Cipher] -&gt; Cipher
</span><a href="Network.TLS.Parameters.html#onCipherChoosing"><span class="hs-identifier hs-var">onCipherChoosing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerParams -&gt; ServerHooks
</span><a href="Network.TLS.Parameters.html#serverHooks"><span class="hs-identifier hs-var">serverHooks</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177643"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177641"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span> </span><span class="annot"><span class="annottext">[Cipher]
</span><a href="#local-6989586621679177631"><span class="hs-identifier hs-var">ciphersFilteredVersion</span></a></span><span>
</span><span id="line-680"></span><span>        </span><span id="local-6989586621679177629"><span class="annot"><span class="annottext">usedHash :: Hash
</span><a href="#local-6989586621679177629"><span class="hs-identifier hs-var hs-var">usedHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; Hash
</span><a href="Network.TLS.Cipher.html#cipherHash"><span class="hs-identifier hs-var">cipherHash</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177630"><span class="hs-identifier hs-var">usedCipher</span></a></span><span>
</span><span id="line-681"></span><span>        </span><span id="local-6989586621679177624"><span class="annot"><span class="annottext">rtt0 :: Bool
</span><a href="#local-6989586621679177624"><span class="hs-identifier hs-var hs-var">rtt0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; [ExtensionRaw] -&gt; Maybe ByteString
</span><a href="Network.TLS.Handshake.Common.html#extensionLookup"><span class="hs-identifier hs-var">extensionLookup</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_EarlyData"><span class="hs-identifier hs-var">extensionID_EarlyData</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177640"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTClientHello"><span class="hs-identifier hs-var">MsgTClientHello</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-682"></span><span>                 </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#EarlyDataIndication"><span class="hs-identifier hs-type">EarlyDataIndication</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Word32
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-683"></span><span>                 </span><span class="annot"><span class="annottext">Maybe EarlyDataIndication
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-684"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177624"><span class="hs-identifier hs-var">rtt0</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-685"></span><span>        </span><span class="hs-comment">-- mark a 0-RTT attempt before a possible HRR, and before updating the</span><span>
</span><span id="line-686"></span><span>        </span><span class="hs-comment">-- status again if 0-RTT successful</span><span>
</span><span id="line-687"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; Established -&gt; IO ()
</span><a href="Network.TLS.Context.Internal.html#setEstablished"><span class="hs-identifier hs-var">setEstablished</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177642"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Established
</span><a href="Network.TLS.Context.Internal.html#EarlyDataNotAllowed"><span class="hs-identifier hs-var">EarlyDataNotAllowed</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- hardcoding</span><span>
</span><span id="line-688"></span><span>    </span><span class="hs-comment">-- Deciding key exchange from key shares</span><span>
</span><span id="line-689"></span><span>    </span><span id="local-6989586621679177619"><span class="annot"><span class="annottext">[KeyShareEntry]
</span><a href="#local-6989586621679177619"><span class="hs-identifier hs-var">keyShares</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; [ExtensionRaw] -&gt; Maybe ByteString
</span><a href="Network.TLS.Handshake.Common.html#extensionLookup"><span class="hs-identifier hs-var">extensionLookup</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_KeyShare"><span class="hs-identifier hs-var">extensionID_KeyShare</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177640"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTClientHello"><span class="hs-identifier hs-var">MsgTClientHello</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-690"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#KeyShareClientHello"><span class="hs-identifier hs-type">KeyShareClientHello</span></a></span><span> </span><span id="local-6989586621679177616"><span class="annot"><span class="annottext">[KeyShareEntry]
</span><a href="#local-6989586621679177616"><span class="hs-identifier hs-var">kses</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[KeyShareEntry]
</span><a href="#local-6989586621679177616"><span class="hs-identifier hs-var">kses</span></a></span><span>
</span><span id="line-691"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">KeyShare
</span><span class="hs-identifier">_</span></span><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;handshakeServerWithTLS13: invalid KeyShare value&quot;</span></span><span>
</span><span id="line-692"></span><span>          </span><span class="annot"><span class="annottext">Maybe KeyShare
</span><span class="hs-identifier">_</span></span><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;key exchange not implemented, expected key_share extension&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-693"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall {t :: * -&gt; *}.
Foldable t =&gt;
t KeyShareEntry -&gt; [Group] -&gt; Maybe KeyShareEntry
</span><a href="#local-6989586621679177615"><span class="hs-identifier hs-var">findKeyShare</span></a></span><span> </span><span class="annot"><span class="annottext">[KeyShareEntry]
</span><a href="#local-6989586621679177619"><span class="hs-identifier hs-var">keyShares</span></a></span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679177614"><span class="hs-identifier hs-var">serverGroups</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-694"></span><span>      </span><span class="annot"><span class="annottext">Maybe KeyShareEntry
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ServerParams
-&gt; Context
-&gt; Version
-&gt; Cipher
-&gt; [ExtensionRaw]
-&gt; [Group]
-&gt; Session
-&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#helloRetryRequest"><span class="hs-identifier hs-var">helloRetryRequest</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177643"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177642"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177641"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177630"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177640"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679177614"><span class="hs-identifier hs-var">serverGroups</span></a></span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679177637"><span class="hs-identifier hs-var">clientSession</span></a></span><span>
</span><span id="line-695"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679177612"><span class="annot"><span class="annottext">KeyShareEntry
</span><a href="#local-6989586621679177612"><span class="hs-identifier hs-var">keyShare</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ServerParams
-&gt; Context
-&gt; Version
-&gt; Cipher
-&gt; [ExtensionRaw]
-&gt; Hash
-&gt; KeyShareEntry
-&gt; Session
-&gt; Bool
-&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#doHandshake13"><span class="hs-identifier hs-var">doHandshake13</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177643"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177642"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177641"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177630"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177640"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679177629"><span class="hs-identifier hs-var">usedHash</span></a></span><span> </span><span class="annot"><span class="annottext">KeyShareEntry
</span><a href="#local-6989586621679177612"><span class="hs-identifier hs-var">keyShare</span></a></span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679177637"><span class="hs-identifier hs-var">clientSession</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177624"><span class="hs-identifier hs-var">rtt0</span></a></span><span>
</span><span id="line-696"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-697"></span><span>    </span><span id="local-6989586621679177631"><span class="annot"><span class="annottext">ciphersFilteredVersion :: [Cipher]
</span><a href="#local-6989586621679177631"><span class="hs-identifier hs-var hs-var">ciphersFilteredVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[ExtensionID]
</span><a href="#local-6989586621679177639"><span class="hs-identifier hs-var">clientCiphers</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; ExtensionID
</span><a href="Network.TLS.Cipher.html#cipherID"><span class="hs-identifier hs-var">cipherID</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Cipher]
</span><a href="#local-6989586621679177608"><span class="hs-identifier hs-var">serverCiphers</span></a></span><span>
</span><span id="line-698"></span><span>    </span><span id="local-6989586621679177608"><span class="annot"><span class="annottext">serverCiphers :: [Cipher]
</span><a href="#local-6989586621679177608"><span class="hs-identifier hs-var hs-var">serverCiphers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Version -&gt; Cipher -&gt; Bool
</span><a href="Network.TLS.Cipher.html#cipherAllowedForVersion"><span class="hs-identifier hs-var">cipherAllowedForVersion</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177641"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Supported -&gt; [Cipher]
</span><a href="Network.TLS.Parameters.html#supportedCiphers"><span class="hs-identifier hs-var">supportedCiphers</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerParams -&gt; Supported
</span><a href="Network.TLS.Parameters.html#serverSupported"><span class="hs-identifier hs-var">serverSupported</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177643"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-699"></span><span>    </span><span id="local-6989586621679177614"><span class="annot"><span class="annottext">serverGroups :: [Group]
</span><a href="#local-6989586621679177614"><span class="hs-identifier hs-var hs-var">serverGroups</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Supported -&gt; [Group]
</span><a href="Network.TLS.Parameters.html#supportedGroups"><span class="hs-identifier hs-var">supportedGroups</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177642"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-700"></span><span>    </span><span id="local-6989586621679177615"><span class="annot"><span class="annottext">findKeyShare :: t KeyShareEntry -&gt; [Group] -&gt; Maybe KeyShareEntry
</span><a href="#local-6989586621679177615"><span class="hs-identifier hs-var hs-var">findKeyShare</span></a></span></span><span> </span><span class="annot"><span class="annottext">t KeyShareEntry
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-701"></span><span>    </span><span class="annot"><a href="#local-6989586621679177615"><span class="hs-identifier hs-var">findKeyShare</span></a></span><span> </span><span id="local-6989586621679177603"><span class="annot"><span class="annottext">t KeyShareEntry
</span><a href="#local-6989586621679177603"><span class="hs-identifier hs-var">ks</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679177602"><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679177602"><span class="hs-identifier hs-var">g</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679177601"><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679177601"><span class="hs-identifier hs-var">gs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679177599"><span class="annot"><span class="annottext">KeyShareEntry
</span><a href="#local-6989586621679177599"><span class="hs-identifier hs-var">ent</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">KeyShareEntry -&gt; Group
</span><a href="Network.TLS.Extension.html#keyShareEntryGroup"><span class="hs-identifier hs-var">keyShareEntryGroup</span></a></span><span> </span><span class="annot"><span class="annottext">KeyShareEntry
</span><a href="#local-6989586621679177599"><span class="hs-identifier hs-var">ent</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679177602"><span class="hs-identifier hs-var">g</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">t KeyShareEntry
</span><a href="#local-6989586621679177603"><span class="hs-identifier hs-var">ks</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-702"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679177597"><span class="annot"><span class="annottext">KeyShareEntry
</span><a href="#local-6989586621679177597"><span class="hs-identifier hs-var">k</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">KeyShareEntry
</span><a href="#local-6989586621679177597"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-703"></span><span>      </span><span class="annot"><span class="annottext">Maybe KeyShareEntry
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">t KeyShareEntry -&gt; [Group] -&gt; Maybe KeyShareEntry
</span><a href="#local-6989586621679177615"><span class="hs-identifier hs-var">findKeyShare</span></a></span><span> </span><span class="annot"><span class="annottext">t KeyShareEntry
</span><a href="#local-6989586621679177603"><span class="hs-identifier hs-var">ks</span></a></span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679177601"><span class="hs-identifier hs-var">gs</span></a></span><span>
</span><span id="line-704"></span><span>
</span><span id="line-705"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#doHandshake13"><span class="hs-identifier hs-type">doHandshake13</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ServerParams"><span class="hs-identifier hs-type">ServerParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Types.html#Version"><span class="hs-identifier hs-type">Version</span></a></span><span>
</span><span id="line-706"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Cipher.html#Cipher"><span class="hs-identifier hs-type">Cipher</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-type">ExtensionRaw</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-707"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Crypto.html#Hash"><span class="hs-identifier hs-type">Hash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Extension.html#KeyShareEntry"><span class="hs-identifier hs-type">KeyShareEntry</span></a></span><span>
</span><span id="line-708"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#Session"><span class="hs-identifier hs-type">Session</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-709"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-710"></span><span id="doHandshake13"><span class="annot"><span class="annottext">doHandshake13 :: ServerParams
-&gt; Context
-&gt; Version
-&gt; Cipher
-&gt; [ExtensionRaw]
-&gt; Hash
-&gt; KeyShareEntry
-&gt; Session
-&gt; Bool
-&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#doHandshake13"><span class="hs-identifier hs-var hs-var">doHandshake13</span></a></span></span><span> </span><span id="local-6989586621679177596"><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177596"><span class="hs-identifier hs-var">sparams</span></a></span></span><span> </span><span id="local-6989586621679177595"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679177594"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177594"><span class="hs-identifier hs-var">chosenVersion</span></a></span></span><span> </span><span id="local-6989586621679177593"><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177593"><span class="hs-identifier hs-var">usedCipher</span></a></span></span><span> </span><span id="local-6989586621679177592"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177592"><span class="hs-identifier hs-var">exts</span></a></span></span><span> </span><span id="local-6989586621679177591"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679177591"><span class="hs-identifier hs-var">usedHash</span></a></span></span><span> </span><span id="local-6989586621679177590"><span class="annot"><span class="annottext">KeyShareEntry
</span><a href="#local-6989586621679177590"><span class="hs-identifier hs-var">clientKeyShare</span></a></span></span><span> </span><span id="local-6989586621679177589"><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679177589"><span class="hs-identifier hs-var">clientSession</span></a></span></span><span> </span><span id="local-6989586621679177588"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177588"><span class="hs-identifier hs-var">rtt0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-711"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; IO Session
</span><a href="Network.TLS.Handshake.Common.html#newSession"><span class="hs-identifier hs-var">newSession</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679177587"><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679177587"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-712"></span><span>        </span><span class="annot"><span class="annottext">Session -&gt; Bool -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setSession"><span class="hs-identifier hs-var">setSession</span></a></span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679177587"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-713"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setClientSupportsPHA"><span class="hs-identifier hs-var">setClientSupportsPHA</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177585"><span class="hs-identifier hs-var">supportsPHA</span></a></span><span>
</span><span id="line-714"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Group -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setNegotiatedGroup"><span class="hs-identifier hs-var">setNegotiatedGroup</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KeyShareEntry -&gt; Group
</span><a href="Network.TLS.Extension.html#keyShareEntryGroup"><span class="hs-identifier hs-var">keyShareEntryGroup</span></a></span><span> </span><span class="annot"><span class="annottext">KeyShareEntry
</span><a href="#local-6989586621679177590"><span class="hs-identifier hs-var">clientKeyShare</span></a></span><span>
</span><span id="line-715"></span><span>    </span><span id="local-6989586621679177584"><span class="annot"><span class="annottext">ServerRandom
</span><a href="#local-6989586621679177584"><span class="hs-identifier hs-var">srand</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ServerRandom
</span><a href="#local-6989586621679177583"><span class="hs-identifier hs-var">setServerParameter</span></a></span><span>
</span><span id="line-716"></span><span>    </span><span class="hs-comment">-- ALPN is used in choosePSK</span><span>
</span><span id="line-717"></span><span>    </span><span id="local-6989586621679177582"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177582"><span class="hs-identifier hs-var">protoExt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; [ExtensionRaw] -&gt; ServerParams -&gt; IO [ExtensionRaw]
</span><a href="Network.TLS.Handshake.Server.html#applicationProtocol"><span class="hs-identifier hs-var">applicationProtocol</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177592"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177596"><span class="hs-identifier hs-var">sparams</span></a></span><span>
</span><span id="line-718"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679177581"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177581"><span class="hs-identifier hs-var">psk</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679177580"><span class="annot"><span class="annottext">Maybe (ByteString, Int, Int)
</span><a href="#local-6989586621679177580"><span class="hs-identifier hs-var">binderInfo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679177579"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177579"><span class="hs-identifier hs-var">is0RTTvalid</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (ByteString, Maybe (ByteString, Int, Int), Bool)
</span><a href="#local-6989586621679177578"><span class="hs-identifier hs-var">choosePSK</span></a></span><span>
</span><span id="line-719"></span><span>    </span><span id="local-6989586621679177577"><span class="annot"><span class="annottext">SecretPair EarlySecret
</span><a href="#local-6989586621679177577"><span class="hs-identifier hs-var">earlyKey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; CipherChoice
-&gt; Either ByteString (BaseSecret EarlySecret)
-&gt; Bool
-&gt; IO (SecretPair EarlySecret)
</span><a href="Network.TLS.Handshake.Common13.html#calculateEarlySecret"><span class="hs-identifier hs-var">calculateEarlySecret</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679177575"><span class="hs-identifier hs-var">choice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177581"><span class="hs-identifier hs-var">psk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-720"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177574"><span class="annot"><span class="annottext">earlySecret :: BaseSecret EarlySecret
</span><a href="#local-6989586621679177574"><span class="hs-identifier hs-var hs-var">earlySecret</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. SecretPair a -&gt; BaseSecret a
</span><a href="Network.TLS.Types.html#pairBase"><span class="hs-identifier hs-var">pairBase</span></a></span><span> </span><span class="annot"><span class="annottext">SecretPair EarlySecret
</span><a href="#local-6989586621679177577"><span class="hs-identifier hs-var">earlyKey</span></a></span><span>
</span><span id="line-721"></span><span>        </span><span id="local-6989586621679177572"><span class="annot"><span class="annottext">clientEarlySecret :: ClientTrafficSecret EarlySecret
</span><a href="#local-6989586621679177572"><span class="hs-identifier hs-var hs-var">clientEarlySecret</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. SecretPair a -&gt; ClientTrafficSecret a
</span><a href="Network.TLS.Types.html#pairClient"><span class="hs-identifier hs-var">pairClient</span></a></span><span> </span><span class="annot"><span class="annottext">SecretPair EarlySecret
</span><a href="#local-6989586621679177577"><span class="hs-identifier hs-var">earlyKey</span></a></span><span>
</span><span id="line-722"></span><span>    </span><span id="local-6989586621679177570"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177570"><span class="hs-identifier hs-var">extensions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall {b}.
Integral b =&gt;
BaseSecret EarlySecret
-&gt; Maybe (ByteString, b, Int) -&gt; IO [ExtensionRaw]
</span><a href="#local-6989586621679177569"><span class="hs-identifier hs-var">checkBinder</span></a></span><span> </span><span class="annot"><span class="annottext">BaseSecret EarlySecret
</span><a href="#local-6989586621679177574"><span class="hs-identifier hs-var">earlySecret</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ByteString, Int, Int)
</span><a href="#local-6989586621679177580"><span class="hs-identifier hs-var">binderInfo</span></a></span><span>
</span><span id="line-723"></span><span>    </span><span id="local-6989586621679177568"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177568"><span class="hs-identifier hs-var">hrr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Bool
</span><a href="Network.TLS.State.html#getTLS13HRR"><span class="hs-identifier hs-var">getTLS13HRR</span></a></span><span>
</span><span id="line-724"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177566"><span class="annot"><span class="annottext">authenticated :: Bool
</span><a href="#local-6989586621679177566"><span class="hs-identifier hs-var hs-var">authenticated</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">Maybe (ByteString, Int, Int)
</span><a href="#local-6989586621679177580"><span class="hs-identifier hs-var">binderInfo</span></a></span><span>
</span><span id="line-725"></span><span>        </span><span id="local-6989586621679177565"><span class="annot"><span class="annottext">rtt0OK :: Bool
</span><a href="#local-6989586621679177565"><span class="hs-identifier hs-var hs-var">rtt0OK</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177566"><span class="hs-identifier hs-var">authenticated</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177568"><span class="hs-identifier hs-var">hrr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177588"><span class="hs-identifier hs-var">rtt0</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177564"><span class="hs-identifier hs-var">rtt0accept</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177579"><span class="hs-identifier hs-var">is0RTTvalid</span></a></span><span>
</span><span id="line-726"></span><span>    </span><span id="local-6989586621679177563"><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679177563"><span class="hs-identifier hs-var">extraCreds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt (Maybe String)
</span><a href="Network.TLS.State.html#getClientSNI"><span class="hs-identifier hs-var">getClientSNI</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">ServerHooks -&gt; Maybe String -&gt; IO Credentials
</span><a href="Network.TLS.Parameters.html#onServerNameIndication"><span class="hs-identifier hs-var">onServerNameIndication</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerParams -&gt; ServerHooks
</span><a href="Network.TLS.Parameters.html#serverHooks"><span class="hs-identifier hs-var">serverHooks</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177596"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-727"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177561"><span class="annot"><span class="annottext">allCreds :: Credentials
</span><a href="#local-6989586621679177561"><span class="hs-identifier hs-var hs-var">allCreds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Credential -&gt; Bool) -&gt; Credentials -&gt; Credentials
</span><a href="Network.TLS.Handshake.Server.html#filterCredentials"><span class="hs-identifier hs-var">filterCredentials</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Version -&gt; [ExtensionRaw] -&gt; Credential -&gt; Bool
</span><a href="Network.TLS.Handshake.Server.html#isCredentialAllowed"><span class="hs-identifier hs-var">isCredentialAllowed</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177594"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177592"><span class="hs-identifier hs-var">exts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-728"></span><span>                       </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679177563"><span class="hs-identifier hs-var">extraCreds</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`mappend`</span></span><span> </span><span class="annot"><span class="annottext">Shared -&gt; Credentials
</span><a href="Network.TLS.Parameters.html#sharedCredentials"><span class="hs-identifier hs-var">sharedCredentials</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Shared
</span><a href="Network.TLS.Context.Internal.html#ctxShared"><span class="hs-identifier hs-var">ctxShared</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-729"></span><span>    </span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-730"></span><span>    </span><span id="local-6989586621679177560"><span class="annot"><span class="annottext">Established
</span><a href="#local-6989586621679177560"><span class="hs-identifier hs-var">established</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO Established
</span><a href="Network.TLS.Context.Internal.html#ctxEstablished"><span class="hs-identifier hs-var">ctxEstablished</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-731"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Established
</span><a href="#local-6989586621679177560"><span class="hs-identifier hs-var">established</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Established
</span><a href="Network.TLS.Context.Internal.html#NotEstablished"><span class="hs-identifier hs-var">NotEstablished</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-732"></span><span>         </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177565"><span class="hs-identifier hs-var">rtt0OK</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-733"></span><span>             </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HandshakeMode13 -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setTLS13HandshakeMode"><span class="hs-identifier hs-var">setTLS13HandshakeMode</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeMode13
</span><a href="Network.TLS.Handshake.State.html#RTT0"><span class="hs-identifier hs-var">RTT0</span></a></span><span>
</span><span id="line-734"></span><span>             </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RTT0Status -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setTLS13RTT0Status"><span class="hs-identifier hs-var">setTLS13RTT0Status</span></a></span><span> </span><span class="annot"><span class="annottext">RTT0Status
</span><a href="Network.TLS.Handshake.State.html#RTT0Accepted"><span class="hs-identifier hs-var">RTT0Accepted</span></a></span><span>
</span><span id="line-735"></span><span>           </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-736"></span><span>             </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HandshakeMode13 -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setTLS13HandshakeMode"><span class="hs-identifier hs-var">setTLS13HandshakeMode</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeMode13
</span><a href="Network.TLS.Handshake.State.html#RTT0"><span class="hs-identifier hs-var">RTT0</span></a></span><span>
</span><span id="line-737"></span><span>             </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RTT0Status -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setTLS13RTT0Status"><span class="hs-identifier hs-var">setTLS13RTT0Status</span></a></span><span> </span><span class="annot"><span class="annottext">RTT0Status
</span><a href="Network.TLS.Handshake.State.html#RTT0Rejected"><span class="hs-identifier hs-var">RTT0Rejected</span></a></span><span>
</span><span id="line-738"></span><span>       </span><span class="hs-keyword">else</span><span>
</span><span id="line-739"></span><span>         </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177566"><span class="hs-identifier hs-var">authenticated</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-740"></span><span>             </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HandshakeMode13 -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setTLS13HandshakeMode"><span class="hs-identifier hs-var">setTLS13HandshakeMode</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeMode13
</span><a href="Network.TLS.Handshake.State.html#PreSharedKey"><span class="hs-identifier hs-var">PreSharedKey</span></a></span><span>
</span><span id="line-741"></span><span>           </span><span class="hs-keyword">else</span><span>
</span><span id="line-742"></span><span>             </span><span class="hs-comment">-- FullHandshake or HelloRetryRequest</span><span>
</span><span id="line-743"></span><span>             </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-744"></span><span>    </span><span id="local-6989586621679177553"><span class="annot"><span class="annottext">Maybe (Credential, HashAndSignatureAlgorithm)
</span><a href="#local-6989586621679177553"><span class="hs-identifier hs-var">mCredInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177566"><span class="hs-identifier hs-var">authenticated</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *}.
MonadIO m =&gt;
Credentials -&gt; m (Maybe (Credential, HashAndSignatureAlgorithm))
</span><a href="#local-6989586621679177552"><span class="hs-identifier hs-var">decideCredentialInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679177561"><span class="hs-identifier hs-var">allCreds</span></a></span><span>
</span><span id="line-745"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679177551"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177551"><span class="hs-identifier hs-var">ecdhe</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679177550"><span class="annot"><span class="annottext">KeyShareEntry
</span><a href="#local-6989586621679177550"><span class="hs-identifier hs-var">keyShare</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; KeyShareEntry -&gt; IO (ByteString, KeyShareEntry)
</span><a href="Network.TLS.Handshake.Common13.html#makeServerKeyShare"><span class="hs-identifier hs-var">makeServerKeyShare</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">KeyShareEntry
</span><a href="#local-6989586621679177590"><span class="hs-identifier hs-var">clientKeyShare</span></a></span><span>
</span><span id="line-746"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m ()
</span><a href="Network.TLS.Handshake.Common.html#ensureRecvComplete"><span class="hs-identifier hs-var">ensureRecvComplete</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-747"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679177547"><span class="annot"><span class="annottext">ClientTrafficSecret HandshakeSecret
</span><a href="#local-6989586621679177547"><span class="hs-identifier hs-var">clientHandshakeSecret</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679177546"><span class="annot"><span class="annottext">BaseSecret HandshakeSecret
</span><a href="#local-6989586621679177546"><span class="hs-identifier hs-var">handSecret</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a.
Context -&gt; (forall b. Monoid b =&gt; PacketFlightM b a) -&gt; IO a
</span><a href="Network.TLS.IO.html#runPacketFlight"><span class="hs-identifier hs-var">runPacketFlight</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-748"></span><span>        </span><span class="annot"><span class="annottext">forall {b}.
Monoid b =&gt;
KeyShareEntry
-&gt; ServerRandom -&gt; [ExtensionRaw] -&gt; PacketFlightM b ()
</span><a href="#local-6989586621679177513"><span class="hs-identifier hs-var">sendServerHello</span></a></span><span> </span><span class="annot"><span class="annottext">KeyShareEntry
</span><a href="#local-6989586621679177550"><span class="hs-identifier hs-var">keyShare</span></a></span><span> </span><span class="annot"><span class="annottext">ServerRandom
</span><a href="#local-6989586621679177584"><span class="hs-identifier hs-var">srand</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177570"><span class="hs-identifier hs-var">extensions</span></a></span><span>
</span><span id="line-749"></span><span>        </span><span class="annot"><span class="annottext">forall b. Monoid b =&gt; Context -&gt; PacketFlightM b ()
</span><a href="Network.TLS.Handshake.Common13.html#sendChangeCipherSpec13"><span class="hs-identifier hs-var">sendChangeCipherSpec13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-750"></span><span>    </span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-751"></span><span>        </span><span id="local-6989586621679177511"><span class="annot"><span class="annottext">SecretTriple HandshakeSecret
</span><a href="#local-6989586621679177511"><span class="hs-identifier hs-var">handKey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context
-&gt; CipherChoice
-&gt; BaseSecret EarlySecret
-&gt; ByteString
-&gt; IO (SecretTriple HandshakeSecret)
</span><a href="Network.TLS.Handshake.Common13.html#calculateHandshakeSecret"><span class="hs-identifier hs-var">calculateHandshakeSecret</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679177575"><span class="hs-identifier hs-var">choice</span></a></span><span> </span><span class="annot"><span class="annottext">BaseSecret EarlySecret
</span><a href="#local-6989586621679177574"><span class="hs-identifier hs-var">earlySecret</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177551"><span class="hs-identifier hs-var">ecdhe</span></a></span><span>
</span><span id="line-752"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177509"><span class="annot"><span class="annottext">serverHandshakeSecret :: ServerTrafficSecret HandshakeSecret
</span><a href="#local-6989586621679177509"><span class="hs-identifier hs-var hs-var">serverHandshakeSecret</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. SecretTriple a -&gt; ServerTrafficSecret a
</span><a href="Network.TLS.Types.html#triServer"><span class="hs-identifier hs-var">triServer</span></a></span><span> </span><span class="annot"><span class="annottext">SecretTriple HandshakeSecret
</span><a href="#local-6989586621679177511"><span class="hs-identifier hs-var">handKey</span></a></span><span>
</span><span id="line-753"></span><span>            </span><span id="local-6989586621679177507"><span class="annot"><span class="annottext">clientHandshakeSecret :: ClientTrafficSecret HandshakeSecret
</span><a href="#local-6989586621679177507"><span class="hs-identifier hs-var hs-var">clientHandshakeSecret</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. SecretTriple a -&gt; ClientTrafficSecret a
</span><a href="Network.TLS.Types.html#triClient"><span class="hs-identifier hs-var">triClient</span></a></span><span> </span><span class="annot"><span class="annottext">SecretTriple HandshakeSecret
</span><a href="#local-6989586621679177511"><span class="hs-identifier hs-var">handKey</span></a></span><span>
</span><span id="line-754"></span><span>            </span><span id="local-6989586621679177505"><span class="annot"><span class="annottext">handSecret :: BaseSecret HandshakeSecret
</span><a href="#local-6989586621679177505"><span class="hs-identifier hs-var hs-var">handSecret</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. SecretTriple a -&gt; BaseSecret a
</span><a href="Network.TLS.Types.html#triBase"><span class="hs-identifier hs-var">triBase</span></a></span><span> </span><span class="annot"><span class="annottext">SecretTriple HandshakeSecret
</span><a href="#local-6989586621679177511"><span class="hs-identifier hs-var">handKey</span></a></span><span>
</span><span id="line-755"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-756"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177565"><span class="hs-identifier hs-var">rtt0OK</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Bool
</span><a href="Network.TLS.Context.Internal.html#ctxQUICMode"><span class="hs-identifier hs-var">ctxQUICMode</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-757"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall ty.
TrafficSecret ty =&gt;
Context -&gt; Hash -&gt; Cipher -&gt; ty -&gt; IO ()
</span><a href="Network.TLS.Handshake.State13.html#setRxState"><span class="hs-identifier hs-var">setRxState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679177591"><span class="hs-identifier hs-var">usedHash</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177593"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="annot"><span class="annottext">ClientTrafficSecret EarlySecret
</span><a href="#local-6989586621679177572"><span class="hs-identifier hs-var">clientEarlySecret</span></a></span><span>
</span><span id="line-758"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall ty.
TrafficSecret ty =&gt;
Context -&gt; Hash -&gt; Cipher -&gt; ty -&gt; IO ()
</span><a href="Network.TLS.Handshake.State13.html#setRxState"><span class="hs-identifier hs-var">setRxState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679177591"><span class="hs-identifier hs-var">usedHash</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177593"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="annot"><span class="annottext">ClientTrafficSecret HandshakeSecret
</span><a href="#local-6989586621679177507"><span class="hs-identifier hs-var">clientHandshakeSecret</span></a></span><span>
</span><span id="line-759"></span><span>            </span><span class="annot"><span class="annottext">forall ty.
TrafficSecret ty =&gt;
Context -&gt; Hash -&gt; Cipher -&gt; ty -&gt; IO ()
</span><a href="Network.TLS.Handshake.State13.html#setTxState"><span class="hs-identifier hs-var">setTxState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679177591"><span class="hs-identifier hs-var">usedHash</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177593"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="annot"><span class="annottext">ServerTrafficSecret HandshakeSecret
</span><a href="#local-6989586621679177509"><span class="hs-identifier hs-var">serverHandshakeSecret</span></a></span><span>
</span><span id="line-760"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177500"><span class="annot"><span class="annottext">mEarlySecInfo :: Maybe EarlySecretInfo
</span><a href="#local-6989586621679177500"><span class="hs-identifier hs-var hs-var">mEarlySecInfo</span></a></span></span><span>
</span><span id="line-761"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177565"><span class="hs-identifier hs-var">rtt0OK</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; ClientTrafficSecret EarlySecret -&gt; EarlySecretInfo
</span><a href="Network.TLS.Handshake.Control.html#EarlySecretInfo"><span class="hs-identifier hs-var">EarlySecretInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177593"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="annot"><span class="annottext">ClientTrafficSecret EarlySecret
</span><a href="#local-6989586621679177572"><span class="hs-identifier hs-var">clientEarlySecret</span></a></span><span>
</span><span id="line-762"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-763"></span><span>                </span><span id="local-6989586621679177498"><span class="annot"><span class="annottext">handSecInfo :: HandshakeSecretInfo
</span><a href="#local-6989586621679177498"><span class="hs-identifier hs-var hs-var">handSecInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; TrafficSecrets HandshakeSecret -&gt; HandshakeSecretInfo
</span><a href="Network.TLS.Handshake.Control.html#HandshakeSecretInfo"><span class="hs-identifier hs-var">HandshakeSecretInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177593"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClientTrafficSecret HandshakeSecret
</span><a href="#local-6989586621679177507"><span class="hs-identifier hs-var">clientHandshakeSecret</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">ServerTrafficSecret HandshakeSecret
</span><a href="#local-6989586621679177509"><span class="hs-identifier hs-var">serverHandshakeSecret</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-764"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; ServerState -&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#contextSync"><span class="hs-identifier hs-var">contextSync</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
-&gt; Maybe EarlySecretInfo -&gt; HandshakeSecretInfo -&gt; ServerState
</span><a href="Network.TLS.Handshake.Control.html#SendServerHello"><span class="hs-identifier hs-var">SendServerHello</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177592"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe EarlySecretInfo
</span><a href="#local-6989586621679177500"><span class="hs-identifier hs-var">mEarlySecInfo</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeSecretInfo
</span><a href="#local-6989586621679177498"><span class="hs-identifier hs-var">handSecInfo</span></a></span><span>
</span><span id="line-765"></span><span>    </span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-766"></span><span>        </span><span class="annot"><span class="annottext">forall {b}.
Monoid b =&gt;
Bool -&gt; [ExtensionRaw] -&gt; PacketFlightM b ()
</span><a href="#local-6989586621679177494"><span class="hs-identifier hs-var">sendExtensions</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177565"><span class="hs-identifier hs-var">rtt0OK</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177582"><span class="hs-identifier hs-var">protoExt</span></a></span><span>
</span><span id="line-767"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Credential, HashAndSignatureAlgorithm)
</span><a href="#local-6989586621679177553"><span class="hs-identifier hs-var">mCredInfo</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-768"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Credential, HashAndSignatureAlgorithm)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-769"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679177493"><span class="annot"><span class="annottext">Credential
</span><a href="#local-6989586621679177493"><span class="hs-identifier hs-var">cred</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679177492"><span class="annot"><span class="annottext">HashAndSignatureAlgorithm
</span><a href="#local-6989586621679177492"><span class="hs-identifier hs-var">hashSig</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall {b}.
Monoid b =&gt;
Credential -&gt; HashAndSignatureAlgorithm -&gt; PacketFlightM b ()
</span><a href="#local-6989586621679177491"><span class="hs-identifier hs-var">sendCertAndVerify</span></a></span><span> </span><span class="annot"><span class="annottext">Credential
</span><a href="#local-6989586621679177493"><span class="hs-identifier hs-var">cred</span></a></span><span> </span><span class="annot"><span class="annottext">HashAndSignatureAlgorithm
</span><a href="#local-6989586621679177492"><span class="hs-identifier hs-var">hashSig</span></a></span><span>
</span><span id="line-770"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Network.TLS.Types.html#ServerTrafficSecret"><span class="hs-identifier hs-type">ServerTrafficSecret</span></a></span><span> </span><span id="local-6989586621679177489"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177489"><span class="hs-identifier hs-var">shs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerTrafficSecret HandshakeSecret
</span><a href="#local-6989586621679177509"><span class="hs-identifier hs-var">serverHandshakeSecret</span></a></span><span>
</span><span id="line-771"></span><span>        </span><span id="local-6989586621679177488"><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679177488"><span class="hs-identifier hs-var">rawFinished</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
Context -&gt; Hash -&gt; ByteString -&gt; m Handshake13
</span><a href="Network.TLS.Handshake.Common13.html#makeFinished"><span class="hs-identifier hs-var">makeFinished</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679177591"><span class="hs-identifier hs-var">usedHash</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177489"><span class="hs-identifier hs-var">shs</span></a></span><span>
</span><span id="line-772"></span><span>        </span><span class="annot"><span class="annottext">forall b. Monoid b =&gt; Context -&gt; Packet13 -&gt; PacketFlightM b ()
</span><a href="Network.TLS.IO.html#loadPacket13"><span class="hs-identifier hs-var">loadPacket13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Handshake13] -&gt; Packet13
</span><a href="Network.TLS.Struct13.html#Handshake13"><span class="hs-identifier hs-var">Handshake13</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679177488"><span class="hs-identifier hs-var">rawFinished</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-773"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClientTrafficSecret HandshakeSecret
</span><a href="#local-6989586621679177507"><span class="hs-identifier hs-var">clientHandshakeSecret</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BaseSecret HandshakeSecret
</span><a href="#local-6989586621679177505"><span class="hs-identifier hs-var">handSecret</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-774"></span><span>    </span><span id="local-6989586621679177484"><span class="annot"><span class="annottext">Millisecond
</span><a href="#local-6989586621679177484"><span class="hs-identifier hs-var">sfSentTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Millisecond
</span><a href="Network.TLS.Handshake.Common13.html#getCurrentTimeFromBase"><span class="hs-identifier hs-var">getCurrentTimeFromBase</span></a></span><span>
</span><span id="line-775"></span><span>    </span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-776"></span><span>    </span><span id="local-6989586621679177482"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177482"><span class="hs-identifier hs-var">hChSf</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m ByteString
</span><a href="Network.TLS.Handshake.State13.html#transcriptHash"><span class="hs-identifier hs-var">transcriptHash</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-777"></span><span>    </span><span id="local-6989586621679177480"><span class="annot"><span class="annottext">SecretTriple ApplicationSecret
</span><a href="#local-6989586621679177480"><span class="hs-identifier hs-var">appKey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; CipherChoice
-&gt; BaseSecret HandshakeSecret
-&gt; ByteString
-&gt; IO (SecretTriple ApplicationSecret)
</span><a href="Network.TLS.Handshake.Common13.html#calculateApplicationSecret"><span class="hs-identifier hs-var">calculateApplicationSecret</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679177575"><span class="hs-identifier hs-var">choice</span></a></span><span> </span><span class="annot"><span class="annottext">BaseSecret HandshakeSecret
</span><a href="#local-6989586621679177546"><span class="hs-identifier hs-var">handSecret</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177482"><span class="hs-identifier hs-var">hChSf</span></a></span><span>
</span><span id="line-778"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177478"><span class="annot"><span class="annottext">clientApplicationSecret0 :: ClientTrafficSecret ApplicationSecret
</span><a href="#local-6989586621679177478"><span class="hs-identifier hs-var hs-var">clientApplicationSecret0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. SecretTriple a -&gt; ClientTrafficSecret a
</span><a href="Network.TLS.Types.html#triClient"><span class="hs-identifier hs-var">triClient</span></a></span><span> </span><span class="annot"><span class="annottext">SecretTriple ApplicationSecret
</span><a href="#local-6989586621679177480"><span class="hs-identifier hs-var">appKey</span></a></span><span>
</span><span id="line-779"></span><span>        </span><span id="local-6989586621679177477"><span class="annot"><span class="annottext">serverApplicationSecret0 :: ServerTrafficSecret ApplicationSecret
</span><a href="#local-6989586621679177477"><span class="hs-identifier hs-var hs-var">serverApplicationSecret0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. SecretTriple a -&gt; ServerTrafficSecret a
</span><a href="Network.TLS.Types.html#triServer"><span class="hs-identifier hs-var">triServer</span></a></span><span> </span><span class="annot"><span class="annottext">SecretTriple ApplicationSecret
</span><a href="#local-6989586621679177480"><span class="hs-identifier hs-var">appKey</span></a></span><span>
</span><span id="line-780"></span><span>        </span><span id="local-6989586621679177476"><span class="annot"><span class="annottext">applicationSecret :: BaseSecret ApplicationSecret
</span><a href="#local-6989586621679177476"><span class="hs-identifier hs-var hs-var">applicationSecret</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. SecretTriple a -&gt; BaseSecret a
</span><a href="Network.TLS.Types.html#triBase"><span class="hs-identifier hs-var">triBase</span></a></span><span> </span><span class="annot"><span class="annottext">SecretTriple ApplicationSecret
</span><a href="#local-6989586621679177480"><span class="hs-identifier hs-var">appKey</span></a></span><span>
</span><span id="line-781"></span><span>    </span><span class="annot"><span class="annottext">forall ty.
TrafficSecret ty =&gt;
Context -&gt; Hash -&gt; Cipher -&gt; ty -&gt; IO ()
</span><a href="Network.TLS.Handshake.State13.html#setTxState"><span class="hs-identifier hs-var">setTxState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679177591"><span class="hs-identifier hs-var">usedHash</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177593"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="annot"><span class="annottext">ServerTrafficSecret ApplicationSecret
</span><a href="#local-6989586621679177477"><span class="hs-identifier hs-var">serverApplicationSecret0</span></a></span><span>
</span><span id="line-782"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177475"><span class="annot"><span class="annottext">appSecInfo :: ApplicationSecretInfo
</span><a href="#local-6989586621679177475"><span class="hs-identifier hs-var hs-var">appSecInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TrafficSecrets ApplicationSecret -&gt; ApplicationSecretInfo
</span><a href="Network.TLS.Handshake.Control.html#ApplicationSecretInfo"><span class="hs-identifier hs-var">ApplicationSecretInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClientTrafficSecret ApplicationSecret
</span><a href="#local-6989586621679177478"><span class="hs-identifier hs-var">clientApplicationSecret0</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">ServerTrafficSecret ApplicationSecret
</span><a href="#local-6989586621679177477"><span class="hs-identifier hs-var">serverApplicationSecret0</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-783"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; ServerState -&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#contextSync"><span class="hs-identifier hs-var">contextSync</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ApplicationSecretInfo -&gt; ServerState
</span><a href="Network.TLS.Handshake.Control.html#SendServerFinished"><span class="hs-identifier hs-var">SendServerFinished</span></a></span><span> </span><span class="annot"><span class="annottext">ApplicationSecretInfo
</span><a href="#local-6989586621679177475"><span class="hs-identifier hs-var">appSecInfo</span></a></span><span>
</span><span id="line-784"></span><span>    </span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-785"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177565"><span class="hs-identifier hs-var">rtt0OK</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-786"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; Established -&gt; IO ()
</span><a href="Network.TLS.Context.Internal.html#setEstablished"><span class="hs-identifier hs-var">setEstablished</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Established
</span><a href="Network.TLS.Context.Internal.html#EarlyDataAllowed"><span class="hs-identifier hs-var">EarlyDataAllowed</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679177471"><span class="hs-identifier hs-var">rtt0max</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-787"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Established
</span><a href="#local-6989586621679177560"><span class="hs-identifier hs-var">established</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Established
</span><a href="Network.TLS.Context.Internal.html#NotEstablished"><span class="hs-identifier hs-var">NotEstablished</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-788"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; Established -&gt; IO ()
</span><a href="Network.TLS.Context.Internal.html#setEstablished"><span class="hs-identifier hs-var">setEstablished</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Established
</span><a href="Network.TLS.Context.Internal.html#EarlyDataNotAllowed"><span class="hs-identifier hs-var">EarlyDataNotAllowed</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- hardcoding</span><span>
</span><span id="line-789"></span><span>
</span><span id="line-790"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177458"><span class="annot"><span class="annottext">expectFinished :: ByteString -&gt; Handshake13 -&gt; m ()
</span><a href="#local-6989586621679177458"><span class="hs-identifier hs-var hs-var">expectFinished</span></a></span></span><span> </span><span id="local-6989586621679177457"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177457"><span class="hs-identifier hs-var">hChBeforeCf</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct13.html#Finished13"><span class="hs-identifier hs-type">Finished13</span></a></span><span> </span><span id="local-6989586621679177455"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177455"><span class="hs-identifier hs-var">verifyData</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-791"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Network.TLS.Types.html#ClientTrafficSecret"><span class="hs-identifier hs-type">ClientTrafficSecret</span></a></span><span> </span><span id="local-6989586621679177453"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177453"><span class="hs-identifier hs-var">chs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClientTrafficSecret HandshakeSecret
</span><a href="#local-6989586621679177547"><span class="hs-identifier hs-var">clientHandshakeSecret</span></a></span><span>
</span><span id="line-792"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
Context -&gt; Hash -&gt; ByteString -&gt; ByteString -&gt; ByteString -&gt; m ()
</span><a href="Network.TLS.Handshake.Common13.html#checkFinished"><span class="hs-identifier hs-var">checkFinished</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679177591"><span class="hs-identifier hs-var">usedHash</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177453"><span class="hs-identifier hs-var">chs</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177457"><span class="hs-identifier hs-var">hChBeforeCf</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177455"><span class="hs-identifier hs-var">verifyData</span></a></span><span>
</span><span id="line-793"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; IO ()
</span><a href="Network.TLS.Handshake.Common13.html#handshakeTerminate13"><span class="hs-identifier hs-var">handshakeTerminate13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-794"></span><span>            </span><span class="annot"><span class="annottext">forall ty.
TrafficSecret ty =&gt;
Context -&gt; Hash -&gt; Cipher -&gt; ty -&gt; IO ()
</span><a href="Network.TLS.Handshake.State13.html#setRxState"><span class="hs-identifier hs-var">setRxState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679177591"><span class="hs-identifier hs-var">usedHash</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177593"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="annot"><span class="annottext">ClientTrafficSecret ApplicationSecret
</span><a href="#local-6989586621679177478"><span class="hs-identifier hs-var">clientApplicationSecret0</span></a></span><span>
</span><span id="line-795"></span><span>            </span><span class="annot"><span class="annottext">BaseSecret ApplicationSecret -&gt; Millisecond -&gt; IO ()
</span><a href="#local-6989586621679177450"><span class="hs-identifier hs-var">sendNewSessionTicket</span></a></span><span> </span><span class="annot"><span class="annottext">BaseSecret ApplicationSecret
</span><a href="#local-6989586621679177476"><span class="hs-identifier hs-var">applicationSecret</span></a></span><span> </span><span class="annot"><span class="annottext">Millisecond
</span><a href="#local-6989586621679177484"><span class="hs-identifier hs-var">sfSentTime</span></a></span><span>
</span><span id="line-796"></span><span>        </span><span class="annot"><a href="#local-6989586621679177458"><span class="hs-identifier hs-var">expectFinished</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679177449"><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679177449"><span class="hs-identifier hs-var">hs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; Maybe String -&gt; m a
</span><a href="Network.TLS.Handshake.Common.html#unexpected"><span class="hs-identifier hs-var">unexpected</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679177449"><span class="hs-identifier hs-var">hs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;finished 13&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-797"></span><span>
</span><span id="line-798"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177442"><span class="annot"><span class="annottext">expectEndOfEarlyData :: Handshake13 -&gt; IO ()
</span><a href="#local-6989586621679177442"><span class="hs-identifier hs-var hs-var">expectEndOfEarlyData</span></a></span></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><a href="Network.TLS.Struct13.html#EndOfEarlyData13"><span class="hs-identifier hs-var">EndOfEarlyData13</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-799"></span><span>            </span><span class="annot"><span class="annottext">forall ty.
TrafficSecret ty =&gt;
Context -&gt; Hash -&gt; Cipher -&gt; ty -&gt; IO ()
</span><a href="Network.TLS.Handshake.State13.html#setRxState"><span class="hs-identifier hs-var">setRxState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679177591"><span class="hs-identifier hs-var">usedHash</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177593"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="annot"><span class="annottext">ClientTrafficSecret HandshakeSecret
</span><a href="#local-6989586621679177547"><span class="hs-identifier hs-var">clientHandshakeSecret</span></a></span><span>
</span><span id="line-800"></span><span>        </span><span class="annot"><a href="#local-6989586621679177442"><span class="hs-identifier hs-var">expectEndOfEarlyData</span></a></span><span> </span><span id="local-6989586621679177440"><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679177440"><span class="hs-identifier hs-var">hs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; Maybe String -&gt; m a
</span><a href="Network.TLS.Handshake.Common.html#unexpected"><span class="hs-identifier hs-var">unexpected</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679177440"><span class="hs-identifier hs-var">hs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;end of early data&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-801"></span><span>
</span><span id="line-802"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177566"><span class="hs-identifier hs-var">authenticated</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">ServerParams -&gt; Bool
</span><a href="Network.TLS.Parameters.html#serverWantClientCert"><span class="hs-identifier hs-var">serverWantClientCert</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177596"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-803"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; RecvHandshake13M m a -&gt; m a
</span><a href="Network.TLS.Handshake.Common13.html#runRecvHandshake13"><span class="hs-identifier hs-var">runRecvHandshake13</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-804"></span><span>          </span><span id="local-6989586621679177438"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177438"><span class="hs-identifier hs-var">skip</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
MonadIO m =&gt;
Context
-&gt; (Handshake13 -&gt; RecvHandshake13M m a) -&gt; RecvHandshake13M m a
</span><a href="Network.TLS.Handshake.Common13.html#recvHandshake13"><span class="hs-identifier hs-var">recvHandshake13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake13 -&gt; RecvHandshake13M IO Bool
</span><a href="#local-6989586621679177436"><span class="hs-identifier hs-var">expectCertificate</span></a></span><span>
</span><span id="line-805"></span><span>          </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177438"><span class="hs-identifier hs-var">skip</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
MonadIO m =&gt;
Context
-&gt; (ByteString -&gt; Handshake13 -&gt; RecvHandshake13M m a)
-&gt; RecvHandshake13M m a
</span><a href="Network.TLS.Handshake.Common13.html#recvHandshake13hash"><span class="hs-identifier hs-var">recvHandshake13hash</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
ServerParams -&gt; Context -&gt; ByteString -&gt; Handshake13 -&gt; m ()
</span><a href="Network.TLS.Handshake.Server.html#expectCertVerify"><span class="hs-identifier hs-var">expectCertVerify</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177596"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-806"></span><span>          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
MonadIO m =&gt;
Context
-&gt; (ByteString -&gt; Handshake13 -&gt; RecvHandshake13M m a)
-&gt; RecvHandshake13M m a
</span><a href="Network.TLS.Handshake.Common13.html#recvHandshake13hash"><span class="hs-identifier hs-var">recvHandshake13hash</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *}.
MonadIO m =&gt;
ByteString -&gt; Handshake13 -&gt; m ()
</span><a href="#local-6989586621679177458"><span class="hs-identifier hs-var">expectFinished</span></a></span><span>
</span><span id="line-807"></span><span>          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m ()
</span><a href="Network.TLS.Handshake.Common.html#ensureRecvComplete"><span class="hs-identifier hs-var">ensureRecvComplete</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-808"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177565"><span class="hs-identifier hs-var">rtt0OK</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Bool
</span><a href="Network.TLS.Context.Internal.html#ctxQUICMode"><span class="hs-identifier hs-var">ctxQUICMode</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-809"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; [PendingAction] -&gt; IO ()
</span><a href="Network.TLS.Handshake.State13.html#setPendingActions"><span class="hs-identifier hs-var">setPendingActions</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Bool -&gt; (Handshake13 -&gt; IO ()) -&gt; PendingAction
</span><a href="Network.TLS.Context.Internal.html#PendingAction"><span class="hs-identifier hs-var">PendingAction</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Handshake13 -&gt; IO ()
</span><a href="#local-6989586621679177442"><span class="hs-identifier hs-var">expectEndOfEarlyData</span></a></span><span>
</span><span id="line-810"></span><span>                              </span><span class="hs-special">,</span><span class="annot"><span class="annottext">Bool -&gt; (ByteString -&gt; Handshake13 -&gt; IO ()) -&gt; PendingAction
</span><a href="Network.TLS.Context.Internal.html#PendingActionHash"><span class="hs-identifier hs-var">PendingActionHash</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *}.
MonadIO m =&gt;
ByteString -&gt; Handshake13 -&gt; m ()
</span><a href="#local-6989586621679177458"><span class="hs-identifier hs-var">expectFinished</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-811"></span><span>      </span><span class="hs-keyword">else</span><span>
</span><span id="line-812"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; RecvHandshake13M m a -&gt; m a
</span><a href="Network.TLS.Handshake.Common13.html#runRecvHandshake13"><span class="hs-identifier hs-var">runRecvHandshake13</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-813"></span><span>          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
MonadIO m =&gt;
Context
-&gt; (ByteString -&gt; Handshake13 -&gt; RecvHandshake13M m a)
-&gt; RecvHandshake13M m a
</span><a href="Network.TLS.Handshake.Common13.html#recvHandshake13hash"><span class="hs-identifier hs-var">recvHandshake13hash</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *}.
MonadIO m =&gt;
ByteString -&gt; Handshake13 -&gt; m ()
</span><a href="#local-6989586621679177458"><span class="hs-identifier hs-var">expectFinished</span></a></span><span>
</span><span id="line-814"></span><span>          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m ()
</span><a href="Network.TLS.Handshake.Common.html#ensureRecvComplete"><span class="hs-identifier hs-var">ensureRecvComplete</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-815"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-816"></span><span>    </span><span id="local-6989586621679177575"><span class="annot"><span class="annottext">choice :: CipherChoice
</span><a href="#local-6989586621679177575"><span class="hs-identifier hs-var hs-var">choice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Version -&gt; Cipher -&gt; CipherChoice
</span><a href="Network.TLS.Handshake.Common13.html#makeCipherChoice"><span class="hs-identifier hs-var">makeCipherChoice</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177594"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177593"><span class="hs-identifier hs-var">usedCipher</span></a></span><span>
</span><span id="line-817"></span><span>
</span><span id="line-818"></span><span>    </span><span id="local-6989586621679177583"><span class="annot"><span class="annottext">setServerParameter :: IO ServerRandom
</span><a href="#local-6989586621679177583"><span class="hs-identifier hs-var hs-var">setServerParameter</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-819"></span><span>        </span><span id="local-6989586621679177423"><span class="annot"><span class="annottext">ServerRandom
</span><a href="#local-6989586621679177423"><span class="hs-identifier hs-var">srand</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Version -&gt; [Version] -&gt; IO ServerRandom
</span><a href="Network.TLS.Handshake.Random.html#serverRandom"><span class="hs-identifier hs-var">serverRandom</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177594"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Supported -&gt; [Version]
</span><a href="Network.TLS.Parameters.html#supportedVersions"><span class="hs-identifier hs-var">supportedVersions</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerParams -&gt; Supported
</span><a href="Network.TLS.Parameters.html#serverSupported"><span class="hs-identifier hs-var">serverSupported</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177596"><span class="hs-identifier hs-var">sparams</span></a></span><span>
</span><span id="line-820"></span><span>        </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Version -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setVersion"><span class="hs-identifier hs-var">setVersion</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177594"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span>
</span><span id="line-821"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; m (Either TLSError a) -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#failOnEitherError"><span class="hs-identifier hs-var">failOnEitherError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; HandshakeM (Either TLSError ())
</span><a href="Network.TLS.Handshake.State13.html#setHelloParameters13"><span class="hs-identifier hs-var">setHelloParameters13</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177593"><span class="hs-identifier hs-var">usedCipher</span></a></span><span>
</span><span id="line-822"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ServerRandom
</span><a href="#local-6989586621679177423"><span class="hs-identifier hs-var">srand</span></a></span><span>
</span><span id="line-823"></span><span>
</span><span id="line-824"></span><span>    </span><span id="local-6989586621679177585"><span class="annot"><span class="annottext">supportsPHA :: Bool
</span><a href="#local-6989586621679177585"><span class="hs-identifier hs-var hs-var">supportsPHA</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; [ExtensionRaw] -&gt; Maybe ByteString
</span><a href="Network.TLS.Handshake.Common.html#extensionLookup"><span class="hs-identifier hs-var">extensionLookup</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_PostHandshakeAuth"><span class="hs-identifier hs-var">extensionID_PostHandshakeAuth</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177592"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTClientHello"><span class="hs-identifier hs-var">MsgTClientHello</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-825"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">PostHandshakeAuth
</span><a href="Network.TLS.Extension.html#PostHandshakeAuth"><span class="hs-identifier hs-var">PostHandshakeAuth</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-826"></span><span>        </span><span class="annot"><span class="annottext">Maybe PostHandshakeAuth
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-827"></span><span>
</span><span id="line-828"></span><span>    </span><span id="local-6989586621679177578"><span class="annot"><span class="annottext">choosePSK :: IO (ByteString, Maybe (ByteString, Int, Int), Bool)
</span><a href="#local-6989586621679177578"><span class="hs-identifier hs-var hs-var">choosePSK</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; [ExtensionRaw] -&gt; Maybe ByteString
</span><a href="Network.TLS.Handshake.Common.html#extensionLookup"><span class="hs-identifier hs-var">extensionLookup</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_PreSharedKey"><span class="hs-identifier hs-var">extensionID_PreSharedKey</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177592"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTClientHello"><span class="hs-identifier hs-var">MsgTClientHello</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-829"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#PreSharedKeyClientHello"><span class="hs-identifier hs-type">PreSharedKeyClientHello</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#PskIdentity"><span class="hs-identifier hs-type">PskIdentity</span></a></span><span> </span><span id="local-6989586621679177395"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177395"><span class="hs-identifier hs-var">sessionId</span></a></span></span><span> </span><span id="local-6989586621679177394"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679177394"><span class="hs-identifier hs-var">obfAge</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[PskIdentity]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679177393"><span class="annot"><span class="annottext">bnds :: [ByteString]
</span><a href="#local-6989586621679177393"><span class="hs-identifier hs-var">bnds</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679177392"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177392"><span class="hs-identifier hs-var">bnd</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[ByteString]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-830"></span><span>          </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[PskKexMode]
</span><a href="#local-6989586621679177391"><span class="hs-identifier hs-var">dhModes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-831"></span><span>              </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;no psk_key_exchange_modes extension&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#MissingExtension"><span class="hs-identifier hs-var">MissingExtension</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-832"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">PskKexMode
</span><a href="Network.TLS.Extension.html#PSK_DHE_KE"><span class="hs-identifier hs-var">PSK_DHE_KE</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[PskKexMode]
</span><a href="#local-6989586621679177391"><span class="hs-identifier hs-var">dhModes</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-833"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177381"><span class="annot"><span class="annottext">len :: Int
</span><a href="#local-6989586621679177381"><span class="hs-identifier hs-var hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679177379"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177379"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">B.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177379"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679177393"><span class="hs-identifier hs-var">bnds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span>
</span><span id="line-834"></span><span>                  </span><span id="local-6989586621679177376"><span class="annot"><span class="annottext">mgr :: SessionManager
</span><a href="#local-6989586621679177376"><span class="hs-identifier hs-var hs-var">mgr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Shared -&gt; SessionManager
</span><a href="Network.TLS.Parameters.html#sharedSessionManager"><span class="hs-identifier hs-var">sharedSessionManager</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerParams -&gt; Shared
</span><a href="Network.TLS.Parameters.html#serverShared"><span class="hs-identifier hs-var">serverShared</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177596"><span class="hs-identifier hs-var">sparams</span></a></span><span>
</span><span id="line-835"></span><span>              </span><span id="local-6989586621679177375"><span class="annot"><span class="annottext">Maybe SessionData
</span><a href="#local-6989586621679177375"><span class="hs-identifier hs-var">msdata</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177588"><span class="hs-identifier hs-var">rtt0</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SessionManager -&gt; ByteString -&gt; IO (Maybe SessionData)
</span><a href="Network.TLS.Session.html#sessionResumeOnlyOnce"><span class="hs-identifier hs-var">sessionResumeOnlyOnce</span></a></span><span> </span><span class="annot"><span class="annottext">SessionManager
</span><a href="#local-6989586621679177376"><span class="hs-identifier hs-var">mgr</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177395"><span class="hs-identifier hs-var">sessionId</span></a></span><span>
</span><span id="line-836"></span><span>                                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SessionManager -&gt; ByteString -&gt; IO (Maybe SessionData)
</span><a href="Network.TLS.Session.html#sessionResume"><span class="hs-identifier hs-var">sessionResume</span></a></span><span> </span><span class="annot"><span class="annottext">SessionManager
</span><a href="#local-6989586621679177376"><span class="hs-identifier hs-var">mgr</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177395"><span class="hs-identifier hs-var">sessionId</span></a></span><span>
</span><span id="line-837"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe SessionData
</span><a href="#local-6989586621679177375"><span class="hs-identifier hs-var">msdata</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-838"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679177373"><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679177373"><span class="hs-identifier hs-var">sdata</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-839"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679177372"><span class="annot"><span class="annottext">TLS13TicketInfo
</span><a href="#local-6989586621679177372"><span class="hs-identifier hs-var">tinfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; Maybe TLS13TicketInfo
</span><a href="Network.TLS.Types.html#sessionTicketInfo"><span class="hs-identifier hs-var">sessionTicketInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679177373"><span class="hs-identifier hs-var">sdata</span></a></span><span>
</span><span id="line-840"></span><span>                        </span><span id="local-6989586621679177370"><span class="annot"><span class="annottext">psk :: ByteString
</span><a href="#local-6989586621679177370"><span class="hs-identifier hs-var hs-var">psk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; ByteString
</span><a href="Network.TLS.Types.html#sessionSecret"><span class="hs-identifier hs-var">sessionSecret</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679177373"><span class="hs-identifier hs-var">sdata</span></a></span><span>
</span><span id="line-841"></span><span>                    </span><span id="local-6989586621679177369"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177369"><span class="hs-identifier hs-var">isFresh</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TLS13TicketInfo -&gt; Word32 -&gt; IO Bool
</span><a href="Network.TLS.Handshake.Common13.html#checkFreshness"><span class="hs-identifier hs-var">checkFreshness</span></a></span><span> </span><span class="annot"><span class="annottext">TLS13TicketInfo
</span><a href="#local-6989586621679177372"><span class="hs-identifier hs-var">tinfo</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679177394"><span class="hs-identifier hs-var">obfAge</span></a></span><span>
</span><span id="line-842"></span><span>                    </span><span class="hs-special">(</span><span id="local-6989586621679177367"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177367"><span class="hs-identifier hs-var">isPSKvalid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679177366"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177366"><span class="hs-identifier hs-var">is0RTTvalid</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; IO (Bool, Bool)
</span><a href="#local-6989586621679177365"><span class="hs-identifier hs-var">checkSessionEquality</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679177373"><span class="hs-identifier hs-var">sdata</span></a></span><span>
</span><span id="line-843"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177367"><span class="hs-identifier hs-var">isPSKvalid</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177369"><span class="hs-identifier hs-var">isFresh</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-844"></span><span>                        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177370"><span class="hs-identifier hs-var">psk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177392"><span class="hs-identifier hs-var">bnd</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-glyph">::</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679177381"><span class="hs-identifier hs-var">len</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177366"><span class="hs-identifier hs-var">is0RTTvalid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-845"></span><span>                      </span><span class="hs-keyword">else</span><span>
</span><span id="line-846"></span><span>                        </span><span class="hs-comment">-- fall back to full handshake</span><span>
</span><span id="line-847"></span><span>                        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177364"><span class="hs-identifier hs-var">zero</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-848"></span><span>                </span><span class="annot"><span class="annottext">Maybe SessionData
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177364"><span class="hs-identifier hs-var">zero</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-849"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177364"><span class="hs-identifier hs-var">zero</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-850"></span><span>      </span><span class="annot"><span class="annottext">Maybe PreSharedKey
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177364"><span class="hs-identifier hs-var">zero</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-851"></span><span>
</span><span id="line-852"></span><span>    </span><span id="local-6989586621679177365"><span class="annot"><span class="annottext">checkSessionEquality :: SessionData -&gt; IO (Bool, Bool)
</span><a href="#local-6989586621679177365"><span class="hs-identifier hs-var hs-var">checkSessionEquality</span></a></span></span><span> </span><span id="local-6989586621679177360"><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679177360"><span class="hs-identifier hs-var">sdata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-853"></span><span>        </span><span id="local-6989586621679177359"><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621679177359"><span class="hs-identifier hs-var">msni</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt (Maybe String)
</span><a href="Network.TLS.State.html#getClientSNI"><span class="hs-identifier hs-var">getClientSNI</span></a></span><span>
</span><span id="line-854"></span><span>        </span><span id="local-6989586621679177358"><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621679177358"><span class="hs-identifier hs-var">malpn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt (Maybe ByteString)
</span><a href="Network.TLS.State.html#getNegotiatedProtocol"><span class="hs-identifier hs-var">getNegotiatedProtocol</span></a></span><span>
</span><span id="line-855"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177353"><span class="annot"><span class="annottext">isSameSNI :: Bool
</span><a href="#local-6989586621679177353"><span class="hs-identifier hs-var hs-var">isSameSNI</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; Maybe String
</span><a href="Network.TLS.Types.html#sessionClientSNI"><span class="hs-identifier hs-var">sessionClientSNI</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679177360"><span class="hs-identifier hs-var">sdata</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621679177359"><span class="hs-identifier hs-var">msni</span></a></span><span>
</span><span id="line-856"></span><span>            </span><span id="local-6989586621679177351"><span class="annot"><span class="annottext">isSameCipher :: Bool
</span><a href="#local-6989586621679177351"><span class="hs-identifier hs-var hs-var">isSameCipher</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; ExtensionID
</span><a href="Network.TLS.Types.html#sessionCipher"><span class="hs-identifier hs-var">sessionCipher</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679177360"><span class="hs-identifier hs-var">sdata</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; ExtensionID
</span><a href="Network.TLS.Cipher.html#cipherID"><span class="hs-identifier hs-var">cipherID</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177593"><span class="hs-identifier hs-var">usedCipher</span></a></span><span>
</span><span id="line-857"></span><span>            </span><span id="local-6989586621679177350"><span class="annot"><span class="annottext">ciphers :: [Cipher]
</span><a href="#local-6989586621679177350"><span class="hs-identifier hs-var hs-var">ciphers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Supported -&gt; [Cipher]
</span><a href="Network.TLS.Parameters.html#supportedCiphers"><span class="hs-identifier hs-var">supportedCiphers</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerParams -&gt; Supported
</span><a href="Network.TLS.Parameters.html#serverSupported"><span class="hs-identifier hs-var">serverSupported</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177596"><span class="hs-identifier hs-var">sparams</span></a></span><span>
</span><span id="line-858"></span><span>            </span><span id="local-6989586621679177345"><span class="annot"><span class="annottext">isSameKDF :: Bool
</span><a href="#local-6989586621679177345"><span class="hs-identifier hs-var hs-var">isSameKDF</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679177344"><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177344"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; ExtensionID
</span><a href="Network.TLS.Cipher.html#cipherID"><span class="hs-identifier hs-var">cipherID</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177344"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; ExtensionID
</span><a href="Network.TLS.Types.html#sessionCipher"><span class="hs-identifier hs-var">sessionCipher</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679177360"><span class="hs-identifier hs-var">sdata</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Cipher]
</span><a href="#local-6989586621679177350"><span class="hs-identifier hs-var">ciphers</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-859"></span><span>                </span><span class="annot"><span class="annottext">Maybe Cipher
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-860"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679177343"><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177343"><span class="hs-identifier hs-var">c</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; Hash
</span><a href="Network.TLS.Cipher.html#cipherHash"><span class="hs-identifier hs-var">cipherHash</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177343"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; Hash
</span><a href="Network.TLS.Cipher.html#cipherHash"><span class="hs-identifier hs-var">cipherHash</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177593"><span class="hs-identifier hs-var">usedCipher</span></a></span><span>
</span><span id="line-861"></span><span>            </span><span id="local-6989586621679177341"><span class="annot"><span class="annottext">isSameVersion :: Bool
</span><a href="#local-6989586621679177341"><span class="hs-identifier hs-var hs-var">isSameVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177594"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; Version
</span><a href="Network.TLS.Types.html#sessionVersion"><span class="hs-identifier hs-var">sessionVersion</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679177360"><span class="hs-identifier hs-var">sdata</span></a></span><span>
</span><span id="line-862"></span><span>            </span><span id="local-6989586621679177338"><span class="annot"><span class="annottext">isSameALPN :: Bool
</span><a href="#local-6989586621679177338"><span class="hs-identifier hs-var hs-var">isSameALPN</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; Maybe ByteString
</span><a href="Network.TLS.Types.html#sessionALPN"><span class="hs-identifier hs-var">sessionALPN</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679177360"><span class="hs-identifier hs-var">sdata</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621679177358"><span class="hs-identifier hs-var">malpn</span></a></span><span>
</span><span id="line-863"></span><span>            </span><span id="local-6989586621679177336"><span class="annot"><span class="annottext">isPSKvalid :: Bool
</span><a href="#local-6989586621679177336"><span class="hs-identifier hs-var hs-var">isPSKvalid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177345"><span class="hs-identifier hs-var">isSameKDF</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177353"><span class="hs-identifier hs-var">isSameSNI</span></a></span><span> </span><span class="hs-comment">-- fixme: SNI is not required</span><span>
</span><span id="line-864"></span><span>            </span><span id="local-6989586621679177335"><span class="annot"><span class="annottext">is0RTTvalid :: Bool
</span><a href="#local-6989586621679177335"><span class="hs-identifier hs-var hs-var">is0RTTvalid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177341"><span class="hs-identifier hs-var">isSameVersion</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177351"><span class="hs-identifier hs-var">isSameCipher</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177338"><span class="hs-identifier hs-var">isSameALPN</span></a></span><span>
</span><span id="line-865"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177336"><span class="hs-identifier hs-var">isPSKvalid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177335"><span class="hs-identifier hs-var">is0RTTvalid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-866"></span><span>
</span><span id="line-867"></span><span>    </span><span id="local-6989586621679177471"><span class="annot"><span class="annottext">rtt0max :: Int
</span><a href="#local-6989586621679177471"><span class="hs-identifier hs-var hs-var">rtt0max</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (Num a, Ord a, FiniteBits a) =&gt; a -&gt; a
</span><a href="Network.TLS.Handshake.Common13.html#safeNonNegative32"><span class="hs-identifier hs-var">safeNonNegative32</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerParams -&gt; Int
</span><a href="Network.TLS.Parameters.html#serverEarlyDataSize"><span class="hs-identifier hs-var">serverEarlyDataSize</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177596"><span class="hs-identifier hs-var">sparams</span></a></span><span>
</span><span id="line-868"></span><span>    </span><span id="local-6989586621679177564"><span class="annot"><span class="annottext">rtt0accept :: Bool
</span><a href="#local-6989586621679177564"><span class="hs-identifier hs-var hs-var">rtt0accept</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerParams -&gt; Int
</span><a href="Network.TLS.Parameters.html#serverEarlyDataSize"><span class="hs-identifier hs-var">serverEarlyDataSize</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177596"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-869"></span><span>
</span><span id="line-870"></span><span>    </span><span id="local-6989586621679177569"><span class="annot"><span class="annottext">checkBinder :: BaseSecret EarlySecret
-&gt; Maybe (ByteString, b, Int) -&gt; IO [ExtensionRaw]
</span><a href="#local-6989586621679177569"><span class="hs-identifier hs-var hs-var">checkBinder</span></a></span></span><span> </span><span class="annot"><span class="annottext">BaseSecret EarlySecret
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (ByteString, b, Int)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-871"></span><span>    </span><span class="annot"><a href="#local-6989586621679177569"><span class="hs-identifier hs-var">checkBinder</span></a></span><span> </span><span id="local-6989586621679177318"><span class="annot"><span class="annottext">BaseSecret EarlySecret
</span><a href="#local-6989586621679177318"><span class="hs-identifier hs-var">earlySecret</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679177317"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177317"><span class="hs-identifier hs-var">binder</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679177316"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679177316"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679177315"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679177315"><span class="hs-identifier hs-var">tlen</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-872"></span><span>        </span><span id="local-6989586621679177314"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177314"><span class="hs-identifier hs-var">binder'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; BaseSecret EarlySecret
-&gt; Hash
-&gt; Int
-&gt; Maybe ByteString
-&gt; IO ByteString
</span><a href="Network.TLS.Handshake.Common13.html#makePSKBinder"><span class="hs-identifier hs-var">makePSKBinder</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">BaseSecret EarlySecret
</span><a href="#local-6989586621679177318"><span class="hs-identifier hs-var">earlySecret</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679177591"><span class="hs-identifier hs-var">usedHash</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679177315"><span class="hs-identifier hs-var">tlen</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-873"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177317"><span class="hs-identifier hs-var">binder</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Bool
</span><a href="Network.TLS.Util.html#bytesEq"><span class="hs-operator hs-var">`bytesEq`</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177314"><span class="hs-identifier hs-var">binder'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-874"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; m a
</span><a href="Network.TLS.Handshake.Signature.html#decryptError"><span class="hs-identifier hs-var">decryptError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;PSK binder validation failed&quot;</span></span><span>
</span><span id="line-875"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177308"><span class="annot"><span class="annottext">selectedIdentity :: ByteString
</span><a href="#local-6989586621679177308"><span class="hs-identifier hs-var hs-var">selectedIdentity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; a -&gt; ByteString
</span><a href="Network.TLS.Extension.html#extensionEncode"><span class="hs-identifier hs-var">extensionEncode</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; PreSharedKey
</span><a href="Network.TLS.Extension.html#PreSharedKeyServerHello"><span class="hs-identifier hs-var">PreSharedKeyServerHello</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679177316"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-876"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ExtensionID -&gt; ByteString -&gt; ExtensionRaw
</span><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-var">ExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_PreSharedKey"><span class="hs-identifier hs-var">extensionID_PreSharedKey</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177308"><span class="hs-identifier hs-var">selectedIdentity</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-877"></span><span>
</span><span id="line-878"></span><span>    </span><span id="local-6989586621679177552"><span class="annot"><span class="annottext">decideCredentialInfo :: Credentials -&gt; m (Maybe (Credential, HashAndSignatureAlgorithm))
</span><a href="#local-6989586621679177552"><span class="hs-identifier hs-var hs-var">decideCredentialInfo</span></a></span></span><span> </span><span id="local-6989586621679177296"><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679177296"><span class="hs-identifier hs-var">allCreds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-879"></span><span>        </span><span id="local-6989586621679177295"><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177295"><span class="hs-identifier hs-var">cHashSigs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; [ExtensionRaw] -&gt; Maybe ByteString
</span><a href="Network.TLS.Handshake.Common.html#extensionLookup"><span class="hs-identifier hs-var">extensionLookup</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_SignatureAlgorithms"><span class="hs-identifier hs-var">extensionID_SignatureAlgorithms</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177592"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTClientHello"><span class="hs-identifier hs-var">MsgTClientHello</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-880"></span><span>            </span><span class="annot"><span class="annottext">Maybe SignatureAlgorithms
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;no signature_algorithms extension&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#MissingExtension"><span class="hs-identifier hs-var">MissingExtension</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-881"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#SignatureAlgorithms"><span class="hs-identifier hs-type">SignatureAlgorithms</span></a></span><span> </span><span id="local-6989586621679177294"><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177294"><span class="hs-identifier hs-var">sas</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177294"><span class="hs-identifier hs-var">sas</span></a></span><span>
</span><span id="line-882"></span><span>        </span><span class="hs-comment">-- When deciding signature algorithm and certificate, we try to keep</span><span>
</span><span id="line-883"></span><span>        </span><span class="hs-comment">-- certificates supported by the client, but fallback to all credentials</span><span>
</span><span id="line-884"></span><span>        </span><span class="hs-comment">-- if this produces no suitable result (see RFC 5246 section 7.4.2 and</span><span>
</span><span id="line-885"></span><span>        </span><span class="hs-comment">-- RFC 8446 section 4.4.2.2).</span><span>
</span><span id="line-886"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177293"><span class="annot"><span class="annottext">sHashSigs :: [HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177293"><span class="hs-identifier hs-var hs-var">sHashSigs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">HashAndSignatureAlgorithm -&gt; Bool
</span><a href="Network.TLS.Handshake.Common13.html#isHashSignatureValid13"><span class="hs-identifier hs-var">isHashSignatureValid13</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Supported -&gt; [HashAndSignatureAlgorithm]
</span><a href="Network.TLS.Parameters.html#supportedHashSignatures"><span class="hs-identifier hs-var">supportedHashSignatures</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-887"></span><span>            </span><span id="local-6989586621679177288"><span class="annot"><span class="annottext">hashSigs :: [HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177288"><span class="hs-identifier hs-var hs-var">hashSigs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177293"><span class="hs-identifier hs-var">sHashSigs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">`intersect`</span></span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177295"><span class="hs-identifier hs-var">cHashSigs</span></a></span><span>
</span><span id="line-888"></span><span>            </span><span id="local-6989586621679177287"><span class="annot"><span class="annottext">cltCreds :: Credentials
</span><a href="#local-6989586621679177287"><span class="hs-identifier hs-var hs-var">cltCreds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw] -&gt; Credentials -&gt; Credentials
</span><a href="Network.TLS.Handshake.Server.html#filterCredentialsWithHashSignatures"><span class="hs-identifier hs-var">filterCredentialsWithHashSignatures</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177592"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679177296"><span class="hs-identifier hs-var">allCreds</span></a></span><span>
</span><span id="line-889"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
-&gt; Credentials -&gt; Maybe (Credential, HashAndSignatureAlgorithm)
</span><a href="Network.TLS.Handshake.Server.html#credentialsFindForSigning13"><span class="hs-identifier hs-var">credentialsFindForSigning13</span></a></span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177288"><span class="hs-identifier hs-var">hashSigs</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679177287"><span class="hs-identifier hs-var">cltCreds</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-890"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Credential, HashAndSignatureAlgorithm)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-891"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
-&gt; Credentials -&gt; Maybe (Credential, HashAndSignatureAlgorithm)
</span><a href="Network.TLS.Handshake.Server.html#credentialsFindForSigning13"><span class="hs-identifier hs-var">credentialsFindForSigning13</span></a></span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177288"><span class="hs-identifier hs-var">hashSigs</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679177296"><span class="hs-identifier hs-var">allCreds</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-892"></span><span>                    </span><span class="annot"><span class="annottext">Maybe (Credential, HashAndSignatureAlgorithm)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;credential not found&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-893"></span><span>                    </span><span id="local-6989586621679177285"><span class="annot"><span class="annottext">Maybe (Credential, HashAndSignatureAlgorithm)
</span><a href="#local-6989586621679177285"><span class="hs-identifier hs-var">mcs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Credential, HashAndSignatureAlgorithm)
</span><a href="#local-6989586621679177285"><span class="hs-identifier hs-var">mcs</span></a></span><span>
</span><span id="line-894"></span><span>            </span><span id="local-6989586621679177284"><span class="annot"><span class="annottext">Maybe (Credential, HashAndSignatureAlgorithm)
</span><a href="#local-6989586621679177284"><span class="hs-identifier hs-var">mcs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Credential, HashAndSignatureAlgorithm)
</span><a href="#local-6989586621679177284"><span class="hs-identifier hs-var">mcs</span></a></span><span>
</span><span id="line-895"></span><span>
</span><span id="line-896"></span><span>    </span><span id="local-6989586621679177513"><span class="annot"><span class="annottext">sendServerHello :: KeyShareEntry
-&gt; ServerRandom -&gt; [ExtensionRaw] -&gt; PacketFlightM b ()
</span><a href="#local-6989586621679177513"><span class="hs-identifier hs-var hs-var">sendServerHello</span></a></span></span><span> </span><span id="local-6989586621679177281"><span class="annot"><span class="annottext">KeyShareEntry
</span><a href="#local-6989586621679177281"><span class="hs-identifier hs-var">keyShare</span></a></span></span><span> </span><span id="local-6989586621679177280"><span class="annot"><span class="annottext">ServerRandom
</span><a href="#local-6989586621679177280"><span class="hs-identifier hs-var">srand</span></a></span></span><span> </span><span id="local-6989586621679177279"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177279"><span class="hs-identifier hs-var">extensions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-897"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177277"><span class="annot"><span class="annottext">serverKeyShare :: ByteString
</span><a href="#local-6989586621679177277"><span class="hs-identifier hs-var hs-var">serverKeyShare</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; a -&gt; ByteString
</span><a href="Network.TLS.Extension.html#extensionEncode"><span class="hs-identifier hs-var">extensionEncode</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KeyShareEntry -&gt; KeyShare
</span><a href="Network.TLS.Extension.html#KeyShareServerHello"><span class="hs-identifier hs-var">KeyShareServerHello</span></a></span><span> </span><span class="annot"><span class="annottext">KeyShareEntry
</span><a href="#local-6989586621679177281"><span class="hs-identifier hs-var">keyShare</span></a></span><span>
</span><span id="line-898"></span><span>            </span><span id="local-6989586621679177274"><span class="annot"><span class="annottext">selectedVersion :: ByteString
</span><a href="#local-6989586621679177274"><span class="hs-identifier hs-var hs-var">selectedVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; a -&gt; ByteString
</span><a href="Network.TLS.Extension.html#extensionEncode"><span class="hs-identifier hs-var">extensionEncode</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Version -&gt; SupportedVersions
</span><a href="Network.TLS.Extension.html#SupportedVersionsServerHello"><span class="hs-identifier hs-var">SupportedVersionsServerHello</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177594"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span>
</span><span id="line-899"></span><span>            </span><span id="local-6989586621679177272"><span class="annot"><span class="annottext">extensions' :: [ExtensionRaw]
</span><a href="#local-6989586621679177272"><span class="hs-identifier hs-var hs-var">extensions'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; ByteString -&gt; ExtensionRaw
</span><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-var">ExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_KeyShare"><span class="hs-identifier hs-var">extensionID_KeyShare</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177277"><span class="hs-identifier hs-var">serverKeyShare</span></a></span><span>
</span><span id="line-900"></span><span>                        </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; ByteString -&gt; ExtensionRaw
</span><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-var">ExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_SupportedVersions"><span class="hs-identifier hs-var">extensionID_SupportedVersions</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177274"><span class="hs-identifier hs-var">selectedVersion</span></a></span><span>
</span><span id="line-901"></span><span>                        </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177279"><span class="hs-identifier hs-var">extensions</span></a></span><span>
</span><span id="line-902"></span><span>            </span><span id="local-6989586621679177271"><span class="annot"><span class="annottext">helo :: Handshake13
</span><a href="#local-6989586621679177271"><span class="hs-identifier hs-var hs-var">helo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerRandom
-&gt; Session -&gt; ExtensionID -&gt; [ExtensionRaw] -&gt; Handshake13
</span><a href="Network.TLS.Struct13.html#ServerHello13"><span class="hs-identifier hs-var">ServerHello13</span></a></span><span> </span><span class="annot"><span class="annottext">ServerRandom
</span><a href="#local-6989586621679177280"><span class="hs-identifier hs-var">srand</span></a></span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679177589"><span class="hs-identifier hs-var">clientSession</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cipher -&gt; ExtensionID
</span><a href="Network.TLS.Cipher.html#cipherID"><span class="hs-identifier hs-var">cipherID</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177593"><span class="hs-identifier hs-var">usedCipher</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177272"><span class="hs-identifier hs-var">extensions'</span></a></span><span>
</span><span id="line-903"></span><span>        </span><span class="annot"><span class="annottext">forall b. Monoid b =&gt; Context -&gt; Packet13 -&gt; PacketFlightM b ()
</span><a href="Network.TLS.IO.html#loadPacket13"><span class="hs-identifier hs-var">loadPacket13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Handshake13] -&gt; Packet13
</span><a href="Network.TLS.Struct13.html#Handshake13"><span class="hs-identifier hs-var">Handshake13</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679177271"><span class="hs-identifier hs-var">helo</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-904"></span><span>
</span><span id="line-905"></span><span>    </span><span id="local-6989586621679177491"><span class="annot"><span class="annottext">sendCertAndVerify :: Credential -&gt; HashAndSignatureAlgorithm -&gt; PacketFlightM b ()
</span><a href="#local-6989586621679177491"><span class="hs-identifier hs-var hs-var">sendCertAndVerify</span></a></span></span><span> </span><span id="local-6989586621679177250"><span class="annot"><span class="annottext">cred :: Credential
</span><a href="#local-6989586621679177250"><span class="hs-identifier hs-var">cred</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679177249"><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679177249"><span class="hs-identifier hs-var">certChain</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrivKey
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679177248"><span class="annot"><span class="annottext">HashAndSignatureAlgorithm
</span><a href="#local-6989586621679177248"><span class="hs-identifier hs-var">hashSig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-906"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; Credential -&gt; m ()
</span><a href="Network.TLS.Handshake.Server.html#storePrivInfoServer"><span class="hs-identifier hs-var">storePrivInfoServer</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Credential
</span><a href="#local-6989586621679177250"><span class="hs-identifier hs-var">cred</span></a></span><span>
</span><span id="line-907"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerParams -&gt; Bool
</span><a href="Network.TLS.Parameters.html#serverWantClientCert"><span class="hs-identifier hs-var">serverWantClientCert</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177596"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-908"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177246"><span class="annot"><span class="annottext">certReqCtx :: ByteString
</span><a href="#local-6989586621679177246"><span class="hs-identifier hs-var hs-var">certReqCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="hs-comment">-- this must be zero length here.</span><span>
</span><span id="line-909"></span><span>                </span><span id="local-6989586621679177245"><span class="annot"><span class="annottext">certReq :: Handshake13
</span><a href="#local-6989586621679177245"><span class="hs-identifier hs-var hs-var">certReq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerParams -&gt; Context -&gt; ByteString -&gt; Handshake13
</span><a href="Network.TLS.Handshake.Common13.html#makeCertRequest"><span class="hs-identifier hs-var">makeCertRequest</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177596"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177246"><span class="hs-identifier hs-var">certReqCtx</span></a></span><span>
</span><span id="line-910"></span><span>            </span><span class="annot"><span class="annottext">forall b. Monoid b =&gt; Context -&gt; Packet13 -&gt; PacketFlightM b ()
</span><a href="Network.TLS.IO.html#loadPacket13"><span class="hs-identifier hs-var">loadPacket13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Handshake13] -&gt; Packet13
</span><a href="Network.TLS.Struct13.html#Handshake13"><span class="hs-identifier hs-var">Handshake13</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679177245"><span class="hs-identifier hs-var">certReq</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-911"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setCertReqSent"><span class="hs-identifier hs-var">setCertReqSent</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-912"></span><span>
</span><span id="line-913"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CertificateChain</span></span><span> </span><span id="local-6989586621679177243"><span class="annot"><span class="annottext">[SignedExact Certificate]
</span><a href="#local-6989586621679177243"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679177249"><span class="hs-identifier hs-var">certChain</span></a></span><span>
</span><span id="line-914"></span><span>            </span><span id="local-6989586621679177241"><span class="annot"><span class="annottext">ess :: [[a]]
</span><a href="#local-6989586621679177241"><span class="hs-identifier hs-var hs-var">ess</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SignedExact Certificate]
</span><a href="#local-6989586621679177243"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-915"></span><span>        </span><span class="annot"><span class="annottext">forall b. Monoid b =&gt; Context -&gt; Packet13 -&gt; PacketFlightM b ()
</span><a href="Network.TLS.IO.html#loadPacket13"><span class="hs-identifier hs-var">loadPacket13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Handshake13] -&gt; Packet13
</span><a href="Network.TLS.Struct13.html#Handshake13"><span class="hs-identifier hs-var">Handshake13</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ByteString -&gt; CertificateChain -&gt; [[ExtensionRaw]] -&gt; Handshake13
</span><a href="Network.TLS.Struct13.html#Certificate13"><span class="hs-identifier hs-var">Certificate13</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679177249"><span class="hs-identifier hs-var">certChain</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. [[a]]
</span><a href="#local-6989586621679177241"><span class="hs-identifier hs-var">ess</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-916"></span><span>        </span><span id="local-6989586621679177237"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177237"><span class="hs-identifier hs-var">hChSc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m ByteString
</span><a href="Network.TLS.Handshake.State13.html#transcriptHash"><span class="hs-identifier hs-var">transcriptHash</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-917"></span><span>        </span><span id="local-6989586621679177236"><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177236"><span class="hs-identifier hs-var">pubkey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m PubKey
</span><a href="Network.TLS.Handshake.Key.html#getLocalPublicKey"><span class="hs-identifier hs-var">getLocalPublicKey</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-918"></span><span>        </span><span id="local-6989586621679177235"><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679177235"><span class="hs-identifier hs-var">vrfy</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
Context
-&gt; PubKey
-&gt; HashAndSignatureAlgorithm
-&gt; ByteString
-&gt; m Handshake13
</span><a href="Network.TLS.Handshake.Common13.html#makeCertVerify"><span class="hs-identifier hs-var">makeCertVerify</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177236"><span class="hs-identifier hs-var">pubkey</span></a></span><span> </span><span class="annot"><span class="annottext">HashAndSignatureAlgorithm
</span><a href="#local-6989586621679177248"><span class="hs-identifier hs-var">hashSig</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177237"><span class="hs-identifier hs-var">hChSc</span></a></span><span>
</span><span id="line-919"></span><span>        </span><span class="annot"><span class="annottext">forall b. Monoid b =&gt; Context -&gt; Packet13 -&gt; PacketFlightM b ()
</span><a href="Network.TLS.IO.html#loadPacket13"><span class="hs-identifier hs-var">loadPacket13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Handshake13] -&gt; Packet13
</span><a href="Network.TLS.Struct13.html#Handshake13"><span class="hs-identifier hs-var">Handshake13</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679177235"><span class="hs-identifier hs-var">vrfy</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-920"></span><span>
</span><span id="line-921"></span><span>    </span><span id="local-6989586621679177494"><span class="annot"><span class="annottext">sendExtensions :: Bool -&gt; [ExtensionRaw] -&gt; PacketFlightM b ()
</span><a href="#local-6989586621679177494"><span class="hs-identifier hs-var hs-var">sendExtensions</span></a></span></span><span> </span><span id="local-6989586621679177225"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177225"><span class="hs-identifier hs-var">rtt0OK</span></a></span></span><span> </span><span id="local-6989586621679177224"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177224"><span class="hs-identifier hs-var">protoExt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-922"></span><span>        </span><span id="local-6989586621679177223"><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621679177223"><span class="hs-identifier hs-var">msni</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt (Maybe String)
</span><a href="Network.TLS.State.html#getClientSNI"><span class="hs-identifier hs-var">getClientSNI</span></a></span><span>
</span><span id="line-923"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177221"><span class="annot"><span class="annottext">sniExtension :: Maybe ExtensionRaw
</span><a href="#local-6989586621679177221"><span class="hs-identifier hs-var hs-var">sniExtension</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621679177223"><span class="hs-identifier hs-var">msni</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-924"></span><span>              </span><span class="hs-comment">-- RFC6066: In this event, the server SHALL include</span><span>
</span><span id="line-925"></span><span>              </span><span class="hs-comment">-- an extension of type &quot;server_name&quot; in the</span><span>
</span><span id="line-926"></span><span>              </span><span class="hs-comment">-- (extended) server hello. The &quot;extension_data&quot;</span><span>
</span><span id="line-927"></span><span>              </span><span class="hs-comment">-- field of this extension SHALL be empty.</span><span>
</span><span id="line-928"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; ByteString -&gt; ExtensionRaw
</span><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-var">ExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_ServerName"><span class="hs-identifier hs-var">extensionID_ServerName</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-929"></span><span>              </span><span class="annot"><span class="annottext">Maybe String
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-930"></span><span>        </span><span id="local-6989586621679177220"><span class="annot"><span class="annottext">Maybe Group
</span><a href="#local-6989586621679177220"><span class="hs-identifier hs-var">mgroup</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeM (Maybe Group)
</span><a href="Network.TLS.Handshake.State.html#getNegotiatedGroup"><span class="hs-identifier hs-var">getNegotiatedGroup</span></a></span><span>
</span><span id="line-931"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177218"><span class="annot"><span class="annottext">serverGroups :: [Group]
</span><a href="#local-6989586621679177218"><span class="hs-identifier hs-var hs-var">serverGroups</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Supported -&gt; [Group]
</span><a href="Network.TLS.Parameters.html#supportedGroups"><span class="hs-identifier hs-var">supportedGroups</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-932"></span><span>            </span><span id="local-6989586621679177214"><span class="annot"><span class="annottext">groupExtension :: Maybe ExtensionRaw
</span><a href="#local-6989586621679177214"><span class="hs-identifier hs-var hs-var">groupExtension</span></a></span></span><span>
</span><span id="line-933"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679177218"><span class="hs-identifier hs-var">serverGroups</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-934"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">head</span></span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679177218"><span class="hs-identifier hs-var">serverGroups</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Group
</span><a href="#local-6989586621679177220"><span class="hs-identifier hs-var">mgroup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-935"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; ByteString -&gt; ExtensionRaw
</span><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-var">ExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_NegotiatedGroups"><span class="hs-identifier hs-var">extensionID_NegotiatedGroups</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; a -&gt; ByteString
</span><a href="Network.TLS.Extension.html#extensionEncode"><span class="hs-identifier hs-var">extensionEncode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Group] -&gt; NegotiatedGroups
</span><a href="Network.TLS.Extension.html#NegotiatedGroups"><span class="hs-identifier hs-var">NegotiatedGroups</span></a></span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679177218"><span class="hs-identifier hs-var">serverGroups</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-936"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177212"><span class="annot"><span class="annottext">earlyDataExtension :: Maybe ExtensionRaw
</span><a href="#local-6989586621679177212"><span class="hs-identifier hs-var hs-var">earlyDataExtension</span></a></span></span><span>
</span><span id="line-937"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177225"><span class="hs-identifier hs-var">rtt0OK</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; ByteString -&gt; ExtensionRaw
</span><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-var">ExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_EarlyData"><span class="hs-identifier hs-var">extensionID_EarlyData</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; a -&gt; ByteString
</span><a href="Network.TLS.Extension.html#extensionEncode"><span class="hs-identifier hs-var">extensionEncode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Word32 -&gt; EarlyDataIndication
</span><a href="Network.TLS.Extension.html#EarlyDataIndication"><span class="hs-identifier hs-var">EarlyDataIndication</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-938"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-939"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177211"><span class="annot"><span class="annottext">extensions :: [ExtensionRaw]
</span><a href="#local-6989586621679177211"><span class="hs-identifier hs-var hs-var">extensions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Shared -&gt; [ExtensionRaw]
</span><a href="Network.TLS.Parameters.html#sharedHelloExtensions"><span class="hs-identifier hs-var">sharedHelloExtensions</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerParams -&gt; Shared
</span><a href="Network.TLS.Parameters.html#serverShared"><span class="hs-identifier hs-var">serverShared</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177596"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-940"></span><span>                      </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Maybe ExtensionRaw
</span><a href="#local-6989586621679177212"><span class="hs-identifier hs-var">earlyDataExtension</span></a></span><span>
</span><span id="line-941"></span><span>                                   </span><span class="hs-special">,</span><span class="annot"><span class="annottext">Maybe ExtensionRaw
</span><a href="#local-6989586621679177214"><span class="hs-identifier hs-var">groupExtension</span></a></span><span>
</span><span id="line-942"></span><span>                                   </span><span class="hs-special">,</span><span class="annot"><span class="annottext">Maybe ExtensionRaw
</span><a href="#local-6989586621679177221"><span class="hs-identifier hs-var">sniExtension</span></a></span><span>
</span><span id="line-943"></span><span>                                   </span><span class="hs-special">]</span><span>
</span><span id="line-944"></span><span>                      </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177224"><span class="hs-identifier hs-var">protoExt</span></a></span><span>
</span><span id="line-945"></span><span>        </span><span id="local-6989586621679177209"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177209"><span class="hs-identifier hs-var">extensions'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerHooks -&gt; [ExtensionRaw] -&gt; IO [ExtensionRaw]
</span><a href="Network.TLS.Parameters.html#onEncryptedExtensionsCreating"><span class="hs-identifier hs-var">onEncryptedExtensionsCreating</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerParams -&gt; ServerHooks
</span><a href="Network.TLS.Parameters.html#serverHooks"><span class="hs-identifier hs-var">serverHooks</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177596"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177211"><span class="hs-identifier hs-var">extensions</span></a></span><span>
</span><span id="line-946"></span><span>        </span><span class="annot"><span class="annottext">forall b. Monoid b =&gt; Context -&gt; Packet13 -&gt; PacketFlightM b ()
</span><a href="Network.TLS.IO.html#loadPacket13"><span class="hs-identifier hs-var">loadPacket13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Handshake13] -&gt; Packet13
</span><a href="Network.TLS.Struct13.html#Handshake13"><span class="hs-identifier hs-var">Handshake13</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[ExtensionRaw] -&gt; Handshake13
</span><a href="Network.TLS.Struct13.html#EncryptedExtensions13"><span class="hs-identifier hs-var">EncryptedExtensions13</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177209"><span class="hs-identifier hs-var">extensions'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-947"></span><span>
</span><span id="line-948"></span><span>    </span><span id="local-6989586621679177450"><span class="annot"><span class="annottext">sendNewSessionTicket :: BaseSecret ApplicationSecret -&gt; Millisecond -&gt; IO ()
</span><a href="#local-6989586621679177450"><span class="hs-identifier hs-var hs-var">sendNewSessionTicket</span></a></span></span><span> </span><span id="local-6989586621679177201"><span class="annot"><span class="annottext">BaseSecret ApplicationSecret
</span><a href="#local-6989586621679177201"><span class="hs-identifier hs-var">applicationSecret</span></a></span></span><span> </span><span id="local-6989586621679177200"><span class="annot"><span class="annottext">Millisecond
</span><a href="#local-6989586621679177200"><span class="hs-identifier hs-var">sfSentTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177199"><span class="hs-identifier hs-var">sendNST</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-949"></span><span>        </span><span id="local-6989586621679177198"><span class="annot"><span class="annottext">Millisecond
</span><a href="#local-6989586621679177198"><span class="hs-identifier hs-var">cfRecvTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Millisecond
</span><a href="Network.TLS.Handshake.Common13.html#getCurrentTimeFromBase"><span class="hs-identifier hs-var">getCurrentTimeFromBase</span></a></span><span>
</span><span id="line-950"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177195"><span class="annot"><span class="annottext">rtt :: Millisecond
</span><a href="#local-6989586621679177195"><span class="hs-identifier hs-var hs-var">rtt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Millisecond
</span><a href="#local-6989586621679177198"><span class="hs-identifier hs-var">cfRecvTime</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Millisecond
</span><a href="#local-6989586621679177200"><span class="hs-identifier hs-var">sfSentTime</span></a></span><span>
</span><span id="line-951"></span><span>        </span><span id="local-6989586621679177194"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177194"><span class="hs-identifier hs-var">nonce</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Int -&gt; IO ByteString
</span><a href="Network.TLS.Context.Internal.html#getStateRNG"><span class="hs-identifier hs-var">getStateRNG</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span>
</span><span id="line-952"></span><span>        </span><span id="local-6989586621679177192"><span class="annot"><span class="annottext">BaseSecret ResumptionSecret
</span><a href="#local-6989586621679177192"><span class="hs-identifier hs-var">resumptionMasterSecret</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; CipherChoice
-&gt; BaseSecret ApplicationSecret
-&gt; IO (BaseSecret ResumptionSecret)
</span><a href="Network.TLS.Handshake.Common13.html#calculateResumptionSecret"><span class="hs-identifier hs-var">calculateResumptionSecret</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679177575"><span class="hs-identifier hs-var">choice</span></a></span><span> </span><span class="annot"><span class="annottext">BaseSecret ApplicationSecret
</span><a href="#local-6989586621679177201"><span class="hs-identifier hs-var">applicationSecret</span></a></span><span>
</span><span id="line-953"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177187"><span class="annot"><span class="annottext">life :: Word32
</span><a href="#local-6989586621679177187"><span class="hs-identifier hs-var hs-var">life</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {a} {a}. (Num a, Integral a) =&gt; a -&gt; a
</span><a href="#local-6989586621679177186"><span class="hs-identifier hs-var">toSeconds</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerParams -&gt; Int
</span><a href="Network.TLS.Parameters.html#serverTicketLifetime"><span class="hs-identifier hs-var">serverTicketLifetime</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177596"><span class="hs-identifier hs-var">sparams</span></a></span><span>
</span><span id="line-954"></span><span>            </span><span id="local-6989586621679177184"><span class="annot"><span class="annottext">psk :: ByteString
</span><a href="#local-6989586621679177184"><span class="hs-identifier hs-var hs-var">psk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CipherChoice
-&gt; BaseSecret ResumptionSecret -&gt; ByteString -&gt; ByteString
</span><a href="Network.TLS.Handshake.Common13.html#derivePSK"><span class="hs-identifier hs-var">derivePSK</span></a></span><span> </span><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679177575"><span class="hs-identifier hs-var">choice</span></a></span><span> </span><span class="annot"><span class="annottext">BaseSecret ResumptionSecret
</span><a href="#local-6989586621679177192"><span class="hs-identifier hs-var">resumptionMasterSecret</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177194"><span class="hs-identifier hs-var">nonce</span></a></span><span>
</span><span id="line-955"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679177182"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177182"><span class="hs-keyword hs-var">label</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679177181"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679177181"><span class="hs-identifier hs-var">add</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Word32
-&gt; ByteString -&gt; Int -&gt; Millisecond -&gt; IO (ByteString, Word32)
</span><a href="#local-6989586621679177180"><span class="hs-identifier hs-var">generateSession</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679177187"><span class="hs-identifier hs-var">life</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177184"><span class="hs-identifier hs-var">psk</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679177471"><span class="hs-identifier hs-var">rtt0max</span></a></span><span> </span><span class="annot"><span class="annottext">Millisecond
</span><a href="#local-6989586621679177195"><span class="hs-identifier hs-var">rtt</span></a></span><span>
</span><span id="line-956"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177178"><span class="annot"><span class="annottext">nst :: Handshake13
</span><a href="#local-6989586621679177178"><span class="hs-identifier hs-var hs-var">nst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {p}.
Integral p =&gt;
Word32 -&gt; Word32 -&gt; ByteString -&gt; ByteString -&gt; p -&gt; Handshake13
</span><a href="#local-6989586621679177177"><span class="hs-identifier hs-var">createNewSessionTicket</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679177187"><span class="hs-identifier hs-var">life</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679177181"><span class="hs-identifier hs-var">add</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177194"><span class="hs-identifier hs-var">nonce</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177182"><span class="hs-keyword hs-var">label</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679177471"><span class="hs-identifier hs-var">rtt0max</span></a></span><span>
</span><span id="line-957"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; Packet13 -&gt; IO ()
</span><a href="Network.TLS.IO.html#sendPacket13"><span class="hs-identifier hs-var">sendPacket13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Handshake13] -&gt; Packet13
</span><a href="Network.TLS.Struct13.html#Handshake13"><span class="hs-identifier hs-var">Handshake13</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679177178"><span class="hs-identifier hs-var">nst</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-958"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-959"></span><span>        </span><span id="local-6989586621679177199"><span class="annot"><span class="annottext">sendNST :: Bool
</span><a href="#local-6989586621679177199"><span class="hs-identifier hs-var hs-var">sendNST</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PskKexMode
</span><a href="Network.TLS.Extension.html#PSK_DHE_KE"><span class="hs-identifier hs-var">PSK_DHE_KE</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[PskKexMode]
</span><a href="#local-6989586621679177391"><span class="hs-identifier hs-var">dhModes</span></a></span><span>
</span><span id="line-960"></span><span>        </span><span id="local-6989586621679177180"><span class="annot"><span class="annottext">generateSession :: Word32
-&gt; ByteString -&gt; Int -&gt; Millisecond -&gt; IO (ByteString, Word32)
</span><a href="#local-6989586621679177180"><span class="hs-identifier hs-var hs-var">generateSession</span></a></span></span><span> </span><span id="local-6989586621679177166"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679177166"><span class="hs-identifier hs-var">life</span></a></span></span><span> </span><span id="local-6989586621679177165"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177165"><span class="hs-identifier hs-var">psk</span></a></span></span><span> </span><span id="local-6989586621679177164"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679177164"><span class="hs-identifier hs-var">maxSize</span></a></span></span><span> </span><span id="local-6989586621679177163"><span class="annot"><span class="annottext">Millisecond
</span><a href="#local-6989586621679177163"><span class="hs-identifier hs-var">rtt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-961"></span><span>            </span><span class="annot"><a href="Network.TLS.Struct.html#Session"><span class="hs-identifier hs-type">Session</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679177162"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177162"><span class="hs-identifier hs-var">sessionId</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO Session
</span><a href="Network.TLS.Handshake.Common.html#newSession"><span class="hs-identifier hs-var">newSession</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-962"></span><span>            </span><span id="local-6989586621679177161"><span class="annot"><span class="annottext">TLS13TicketInfo
</span><a href="#local-6989586621679177161"><span class="hs-identifier hs-var">tinfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Word32
-&gt; Either Context Word32 -&gt; Maybe Millisecond -&gt; IO TLS13TicketInfo
</span><a href="Network.TLS.Handshake.Common13.html#createTLS13TicketInfo"><span class="hs-identifier hs-var">createTLS13TicketInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679177166"><span class="hs-identifier hs-var">life</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Millisecond
</span><a href="#local-6989586621679177163"><span class="hs-identifier hs-var">rtt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-963"></span><span>            </span><span id="local-6989586621679177159"><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679177159"><span class="hs-identifier hs-var">sdata</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; Cipher -&gt; TLS13TicketInfo -&gt; Int -&gt; ByteString -&gt; IO SessionData
</span><a href="Network.TLS.Handshake.Common13.html#getSessionData13"><span class="hs-identifier hs-var">getSessionData13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177593"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="annot"><span class="annottext">TLS13TicketInfo
</span><a href="#local-6989586621679177161"><span class="hs-identifier hs-var">tinfo</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679177164"><span class="hs-identifier hs-var">maxSize</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177165"><span class="hs-identifier hs-var">psk</span></a></span><span>
</span><span id="line-964"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177157"><span class="annot"><span class="annottext">mgr :: SessionManager
</span><a href="#local-6989586621679177157"><span class="hs-identifier hs-var hs-var">mgr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Shared -&gt; SessionManager
</span><a href="Network.TLS.Parameters.html#sharedSessionManager"><span class="hs-identifier hs-var">sharedSessionManager</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerParams -&gt; Shared
</span><a href="Network.TLS.Parameters.html#serverShared"><span class="hs-identifier hs-var">serverShared</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177596"><span class="hs-identifier hs-var">sparams</span></a></span><span>
</span><span id="line-965"></span><span>            </span><span class="annot"><span class="annottext">SessionManager -&gt; ByteString -&gt; SessionData -&gt; IO ()
</span><a href="Network.TLS.Session.html#sessionEstablish"><span class="hs-identifier hs-var">sessionEstablish</span></a></span><span> </span><span class="annot"><span class="annottext">SessionManager
</span><a href="#local-6989586621679177157"><span class="hs-identifier hs-var">mgr</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177162"><span class="hs-identifier hs-var">sessionId</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679177159"><span class="hs-identifier hs-var">sdata</span></a></span><span>
</span><span id="line-966"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177162"><span class="hs-identifier hs-var">sessionId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TLS13TicketInfo -&gt; Word32
</span><a href="Network.TLS.Types.html#ageAdd"><span class="hs-identifier hs-var">ageAdd</span></a></span><span> </span><span class="annot"><span class="annottext">TLS13TicketInfo
</span><a href="#local-6989586621679177161"><span class="hs-identifier hs-var">tinfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-967"></span><span>        </span><span id="local-6989586621679177177"><span class="annot"><span class="annottext">createNewSessionTicket :: Word32 -&gt; Word32 -&gt; ByteString -&gt; ByteString -&gt; p -&gt; Handshake13
</span><a href="#local-6989586621679177177"><span class="hs-identifier hs-var hs-var">createNewSessionTicket</span></a></span></span><span> </span><span id="local-6989586621679177153"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679177153"><span class="hs-identifier hs-var">life</span></a></span></span><span> </span><span id="local-6989586621679177152"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679177152"><span class="hs-identifier hs-var">add</span></a></span></span><span> </span><span id="local-6989586621679177151"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177151"><span class="hs-identifier hs-var">nonce</span></a></span></span><span> </span><span id="local-6989586621679177150"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177150"><span class="hs-keyword hs-var">label</span></a></span></span><span> </span><span id="local-6989586621679177149"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679177149"><span class="hs-identifier hs-var">maxSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-968"></span><span>            </span><span class="annot"><span class="annottext">Word32
-&gt; Word32
-&gt; ByteString
-&gt; ByteString
-&gt; [ExtensionRaw]
-&gt; Handshake13
</span><a href="Network.TLS.Struct13.html#NewSessionTicket13"><span class="hs-identifier hs-var">NewSessionTicket13</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679177153"><span class="hs-identifier hs-var">life</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679177152"><span class="hs-identifier hs-var">add</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177151"><span class="hs-identifier hs-var">nonce</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177150"><span class="hs-keyword hs-var">label</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177147"><span class="hs-identifier hs-var">extensions</span></a></span><span>
</span><span id="line-969"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-970"></span><span>            </span><span id="local-6989586621679177143"><span class="annot"><span class="annottext">tedi :: ByteString
</span><a href="#local-6989586621679177143"><span class="hs-identifier hs-var hs-var">tedi</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; a -&gt; ByteString
</span><a href="Network.TLS.Extension.html#extensionEncode"><span class="hs-identifier hs-var">extensionEncode</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe Word32 -&gt; EarlyDataIndication
</span><a href="Network.TLS.Extension.html#EarlyDataIndication"><span class="hs-identifier hs-var">EarlyDataIndication</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679177149"><span class="hs-identifier hs-var">maxSize</span></a></span><span>
</span><span id="line-971"></span><span>            </span><span id="local-6989586621679177147"><span class="annot"><span class="annottext">extensions :: [ExtensionRaw]
</span><a href="#local-6989586621679177147"><span class="hs-identifier hs-var hs-var">extensions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ExtensionID -&gt; ByteString -&gt; ExtensionRaw
</span><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-var">ExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_EarlyData"><span class="hs-identifier hs-var">extensionID_EarlyData</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177143"><span class="hs-identifier hs-var">tedi</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-972"></span><span>        </span><span id="local-6989586621679177186"><span class="annot"><span class="annottext">toSeconds :: a -&gt; a
</span><a href="#local-6989586621679177186"><span class="hs-identifier hs-var hs-var">toSeconds</span></a></span></span><span> </span><span id="local-6989586621679177126"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679177126"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679177126"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">0</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">0</span></span><span>
</span><span id="line-973"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679177126"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">604800</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">604800</span></span><span>
</span><span id="line-974"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679177126"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-975"></span><span>
</span><span id="line-976"></span><span>    </span><span id="local-6989586621679177391"><span class="annot"><span class="annottext">dhModes :: [PskKexMode]
</span><a href="#local-6989586621679177391"><span class="hs-identifier hs-var hs-var">dhModes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; [ExtensionRaw] -&gt; Maybe ByteString
</span><a href="Network.TLS.Handshake.Common.html#extensionLookup"><span class="hs-identifier hs-var">extensionLookup</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_PskKeyExchangeModes"><span class="hs-identifier hs-var">extensionID_PskKeyExchangeModes</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177592"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTClientHello"><span class="hs-identifier hs-var">MsgTClientHello</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-977"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#PskKeyExchangeModes"><span class="hs-identifier hs-type">PskKeyExchangeModes</span></a></span><span> </span><span id="local-6989586621679177120"><span class="annot"><span class="annottext">[PskKexMode]
</span><a href="#local-6989586621679177120"><span class="hs-identifier hs-var">ms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[PskKexMode]
</span><a href="#local-6989586621679177120"><span class="hs-identifier hs-var">ms</span></a></span><span>
</span><span id="line-978"></span><span>      </span><span class="annot"><span class="annottext">Maybe PskKeyExchangeModes
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-979"></span><span>
</span><span id="line-980"></span><span>    </span><span class="annot"><a href="#local-6989586621679177436"><span class="hs-identifier hs-type">expectCertificate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Struct13.html#Handshake13"><span class="hs-identifier hs-type">Handshake13</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Common13.html#RecvHandshake13M"><span class="hs-identifier hs-type">RecvHandshake13M</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-981"></span><span>    </span><span id="local-6989586621679177436"><span class="annot"><span class="annottext">expectCertificate :: Handshake13 -&gt; RecvHandshake13M IO Bool
</span><a href="#local-6989586621679177436"><span class="hs-identifier hs-var hs-var">expectCertificate</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct13.html#Certificate13"><span class="hs-identifier hs-type">Certificate13</span></a></span><span> </span><span id="local-6989586621679177119"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177119"><span class="hs-identifier hs-var">certCtx</span></a></span></span><span> </span><span id="local-6989586621679177118"><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679177118"><span class="hs-identifier hs-var">certs</span></a></span></span><span> </span><span id="local-6989586621679177117"><span class="annot"><span class="annottext">[[ExtensionRaw]]
</span><a href="#local-6989586621679177117"><span class="hs-identifier hs-var">_ext</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-982"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177119"><span class="hs-identifier hs-var">certCtx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;certificate request context MUST be empty&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#IllegalParameter"><span class="hs-identifier hs-var">IllegalParameter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-983"></span><span>        </span><span class="hs-comment">-- fixme checking _ext</span><span>
</span><span id="line-984"></span><span>        </span><span class="annot"><span class="annottext">ServerParams -&gt; Context -&gt; CertificateChain -&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#clientCertificate"><span class="hs-identifier hs-var">clientCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177596"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177595"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679177118"><span class="hs-identifier hs-var">certs</span></a></span><span>
</span><span id="line-985"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CertificateChain -&gt; Bool
</span><a href="Network.TLS.X509.html#isNullCertificateChain"><span class="hs-identifier hs-var">isNullCertificateChain</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679177118"><span class="hs-identifier hs-var">certs</span></a></span><span>
</span><span id="line-986"></span><span>    </span><span class="annot"><a href="#local-6989586621679177436"><span class="hs-identifier hs-var">expectCertificate</span></a></span><span> </span><span id="local-6989586621679177116"><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679177116"><span class="hs-identifier hs-var">hs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; Maybe String -&gt; m a
</span><a href="Network.TLS.Handshake.Common.html#unexpected"><span class="hs-identifier hs-var">unexpected</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679177116"><span class="hs-identifier hs-var">hs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;certificate 13&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-987"></span><span>
</span><span id="line-988"></span><span>    </span><span id="local-6989586621679177115"><span class="annot"><span class="annottext">hashSize :: Int
</span><a href="#local-6989586621679177115"><span class="hs-identifier hs-var hs-var">hashSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Int
</span><a href="Network.TLS.Crypto.html#hashDigestSize"><span class="hs-identifier hs-var">hashDigestSize</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679177591"><span class="hs-identifier hs-var">usedHash</span></a></span><span>
</span><span id="line-989"></span><span>    </span><span id="local-6989586621679177364"><span class="annot"><span class="annottext">zero :: ByteString
</span><a href="#local-6989586621679177364"><span class="hs-identifier hs-var hs-var">zero</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CompressionID -&gt; ByteString
</span><span class="hs-identifier hs-var">B.replicate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679177115"><span class="hs-identifier hs-var">hashSize</span></a></span><span> </span><span class="annot"><span class="annottext">CompressionID
</span><span class="hs-number">0</span></span><span>
</span><span id="line-990"></span><span>
</span><span id="line-991"></span><span id="local-6989586621679178713"><span class="annot"><a href="Network.TLS.Handshake.Server.html#expectCertVerify"><span class="hs-identifier hs-type">expectCertVerify</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679178713"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ServerParams"><span class="hs-identifier hs-type">ServerParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct13.html#Handshake13"><span class="hs-identifier hs-type">Handshake13</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679178713"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-992"></span><span id="expectCertVerify"><span class="annot"><span class="annottext">expectCertVerify :: forall (m :: * -&gt; *).
MonadIO m =&gt;
ServerParams -&gt; Context -&gt; ByteString -&gt; Handshake13 -&gt; m ()
</span><a href="Network.TLS.Handshake.Server.html#expectCertVerify"><span class="hs-identifier hs-var hs-var">expectCertVerify</span></a></span></span><span> </span><span id="local-6989586621679177093"><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177093"><span class="hs-identifier hs-var">sparams</span></a></span></span><span> </span><span id="local-6989586621679177092"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177092"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679177091"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177091"><span class="hs-identifier hs-var">hChCc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct13.html#CertVerify13"><span class="hs-identifier hs-type">CertVerify13</span></a></span><span> </span><span id="local-6989586621679177089"><span class="annot"><span class="annottext">HashAndSignatureAlgorithm
</span><a href="#local-6989586621679177089"><span class="hs-identifier hs-var">sigAlg</span></a></span></span><span> </span><span id="local-6989586621679177088"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177088"><span class="hs-identifier hs-var">sig</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-993"></span><span>    </span><span id="local-6989586621679177087"><span class="annot"><span class="annottext">certs :: CertificateChain
</span><a href="#local-6989586621679177087"><span class="hs-identifier hs-var">certs</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CertificateChain</span></span><span> </span><span id="local-6989586621679177086"><span class="annot"><span class="annottext">[SignedExact Certificate]
</span><a href="#local-6989586621679177086"><span class="hs-identifier hs-var">cc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
Context -&gt; String -&gt; m CertificateChain
</span><a href="Network.TLS.Handshake.Server.html#checkValidClientCertChain"><span class="hs-identifier hs-var">checkValidClientCertChain</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177092"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;finished 13 message expected&quot;</span></span><span>
</span><span id="line-994"></span><span>    </span><span id="local-6989586621679177085"><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177085"><span class="hs-identifier hs-var">pubkey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[SignedExact Certificate]
</span><a href="#local-6989586621679177086"><span class="hs-identifier hs-var">cc</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-995"></span><span>                </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;client certificate missing&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-996"></span><span>                </span><span id="local-6989586621679177084"><span class="annot"><span class="annottext">SignedExact Certificate
</span><a href="#local-6989586621679177084"><span class="hs-identifier hs-var">c</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[SignedExact Certificate]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Certificate -&gt; PubKey
</span><span class="hs-identifier hs-var">certPubKey</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SignedExact Certificate -&gt; Certificate
</span><span class="hs-identifier hs-var">getCertificate</span></span><span> </span><span class="annot"><span class="annottext">SignedExact Certificate
</span><a href="#local-6989586621679177084"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-997"></span><span>    </span><span id="local-6989586621679177081"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177081"><span class="hs-identifier hs-var">ver</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177092"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Version
</span><a href="Network.TLS.State.html#getVersion"><span class="hs-identifier hs-var">getVersion</span></a></span><span>
</span><span id="line-998"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadIO m =&gt; Version -&gt; PubKey -&gt; m ()
</span><a href="Network.TLS.Handshake.Key.html#checkDigitalSignatureKey"><span class="hs-identifier hs-var">checkDigitalSignatureKey</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177081"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177085"><span class="hs-identifier hs-var">pubkey</span></a></span><span>
</span><span id="line-999"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177092"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PubKey -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setPublicKey"><span class="hs-identifier hs-var">setPublicKey</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177085"><span class="hs-identifier hs-var">pubkey</span></a></span><span>
</span><span id="line-1000"></span><span>    </span><span id="local-6989586621679177079"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177079"><span class="hs-identifier hs-var">verif</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
Context
-&gt; PubKey
-&gt; HashAndSignatureAlgorithm
-&gt; ByteString
-&gt; ByteString
-&gt; m Bool
</span><a href="Network.TLS.Handshake.Common13.html#checkCertVerify"><span class="hs-identifier hs-var">checkCertVerify</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177092"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679177085"><span class="hs-identifier hs-var">pubkey</span></a></span><span> </span><span class="annot"><span class="annottext">HashAndSignatureAlgorithm
</span><a href="#local-6989586621679177089"><span class="hs-identifier hs-var">sigAlg</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177088"><span class="hs-identifier hs-var">sig</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177091"><span class="hs-identifier hs-var">hChCc</span></a></span><span>
</span><span id="line-1001"></span><span>    </span><span class="annot"><span class="annottext">ServerParams -&gt; Context -&gt; CertificateChain -&gt; Bool -&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#clientCertVerify"><span class="hs-identifier hs-var">clientCertVerify</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177093"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177092"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679177087"><span class="hs-identifier hs-var">certs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177079"><span class="hs-identifier hs-var">verif</span></a></span><span>
</span><span id="line-1002"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#expectCertVerify"><span class="hs-identifier hs-var">expectCertVerify</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679177077"><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679177077"><span class="hs-identifier hs-var">hs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; Maybe String -&gt; m a
</span><a href="Network.TLS.Handshake.Common.html#unexpected"><span class="hs-identifier hs-var">unexpected</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679177077"><span class="hs-identifier hs-var">hs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;certificate verify 13&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-1003"></span><span>
</span><span id="line-1004"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#helloRetryRequest"><span class="hs-identifier hs-type">helloRetryRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ServerParams"><span class="hs-identifier hs-type">ServerParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Types.html#Version"><span class="hs-identifier hs-type">Version</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Cipher.html#Cipher"><span class="hs-identifier hs-type">Cipher</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-type">ExtensionRaw</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Crypto.Types.html#Group"><span class="hs-identifier hs-type">Group</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#Session"><span class="hs-identifier hs-type">Session</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1005"></span><span id="helloRetryRequest"><span class="annot"><span class="annottext">helloRetryRequest :: ServerParams
-&gt; Context
-&gt; Version
-&gt; Cipher
-&gt; [ExtensionRaw]
-&gt; [Group]
-&gt; Session
-&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#helloRetryRequest"><span class="hs-identifier hs-var hs-var">helloRetryRequest</span></a></span></span><span> </span><span id="local-6989586621679177076"><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177076"><span class="hs-identifier hs-var">sparams</span></a></span></span><span> </span><span id="local-6989586621679177075"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177075"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679177074"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177074"><span class="hs-identifier hs-var">chosenVersion</span></a></span></span><span> </span><span id="local-6989586621679177073"><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177073"><span class="hs-identifier hs-var">usedCipher</span></a></span></span><span> </span><span id="local-6989586621679177072"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177072"><span class="hs-identifier hs-var">exts</span></a></span></span><span> </span><span id="local-6989586621679177071"><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679177071"><span class="hs-identifier hs-var">serverGroups</span></a></span></span><span> </span><span id="local-6989586621679177070"><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679177070"><span class="hs-identifier hs-var">clientSession</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1006"></span><span>    </span><span id="local-6989586621679177069"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177069"><span class="hs-identifier hs-var">twice</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177075"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Bool
</span><a href="Network.TLS.State.html#getTLS13HRR"><span class="hs-identifier hs-var">getTLS13HRR</span></a></span><span>
</span><span id="line-1007"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177069"><span class="hs-identifier hs-var">twice</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1008"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Hello retry not allowed again&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1009"></span><span>    </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177075"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setTLS13HRR"><span class="hs-identifier hs-var">setTLS13HRR</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1010"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; m (Either TLSError a) -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#failOnEitherError"><span class="hs-identifier hs-var">failOnEitherError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177075"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; HandshakeM (Either TLSError ())
</span><a href="Network.TLS.Handshake.State13.html#setHelloParameters13"><span class="hs-identifier hs-var">setHelloParameters13</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177073"><span class="hs-identifier hs-var">usedCipher</span></a></span><span>
</span><span id="line-1011"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177065"><span class="annot"><span class="annottext">clientGroups :: [Group]
</span><a href="#local-6989586621679177065"><span class="hs-identifier hs-var hs-var">clientGroups</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; [ExtensionRaw] -&gt; Maybe ByteString
</span><a href="Network.TLS.Handshake.Common.html#extensionLookup"><span class="hs-identifier hs-var">extensionLookup</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_NegotiatedGroups"><span class="hs-identifier hs-var">extensionID_NegotiatedGroups</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177072"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTClientHello"><span class="hs-identifier hs-var">MsgTClientHello</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1012"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#NegotiatedGroups"><span class="hs-identifier hs-type">NegotiatedGroups</span></a></span><span> </span><span id="local-6989586621679177064"><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679177064"><span class="hs-identifier hs-var">gs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679177064"><span class="hs-identifier hs-var">gs</span></a></span><span>
</span><span id="line-1013"></span><span>          </span><span class="annot"><span class="annottext">Maybe NegotiatedGroups
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1014"></span><span>        </span><span id="local-6989586621679177062"><span class="annot"><span class="annottext">possibleGroups :: [Group]
</span><a href="#local-6989586621679177062"><span class="hs-identifier hs-var hs-var">possibleGroups</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679177071"><span class="hs-identifier hs-var">serverGroups</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">`intersect`</span></span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679177065"><span class="hs-identifier hs-var">clientGroups</span></a></span><span>
</span><span id="line-1015"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679177062"><span class="hs-identifier hs-var">possibleGroups</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1016"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;no group in common with the client for HRR&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1017"></span><span>      </span><span id="local-6989586621679177061"><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679177061"><span class="hs-identifier hs-var">g</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[Group]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1018"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177059"><span class="annot"><span class="annottext">serverKeyShare :: ByteString
</span><a href="#local-6989586621679177059"><span class="hs-identifier hs-var hs-var">serverKeyShare</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; a -&gt; ByteString
</span><a href="Network.TLS.Extension.html#extensionEncode"><span class="hs-identifier hs-var">extensionEncode</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Group -&gt; KeyShare
</span><a href="Network.TLS.Extension.html#KeyShareHRR"><span class="hs-identifier hs-var">KeyShareHRR</span></a></span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679177061"><span class="hs-identifier hs-var">g</span></a></span><span>
</span><span id="line-1019"></span><span>              </span><span id="local-6989586621679177056"><span class="annot"><span class="annottext">selectedVersion :: ByteString
</span><a href="#local-6989586621679177056"><span class="hs-identifier hs-var hs-var">selectedVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; a -&gt; ByteString
</span><a href="Network.TLS.Extension.html#extensionEncode"><span class="hs-identifier hs-var">extensionEncode</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Version -&gt; SupportedVersions
</span><a href="Network.TLS.Extension.html#SupportedVersionsServerHello"><span class="hs-identifier hs-var">SupportedVersionsServerHello</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177074"><span class="hs-identifier hs-var">chosenVersion</span></a></span><span>
</span><span id="line-1020"></span><span>              </span><span id="local-6989586621679177055"><span class="annot"><span class="annottext">extensions :: [ExtensionRaw]
</span><a href="#local-6989586621679177055"><span class="hs-identifier hs-var hs-var">extensions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ExtensionID -&gt; ByteString -&gt; ExtensionRaw
</span><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-var">ExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_KeyShare"><span class="hs-identifier hs-var">extensionID_KeyShare</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177059"><span class="hs-identifier hs-var">serverKeyShare</span></a></span><span>
</span><span id="line-1021"></span><span>                           </span><span class="hs-special">,</span><span class="annot"><span class="annottext">ExtensionID -&gt; ByteString -&gt; ExtensionRaw
</span><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-var">ExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_SupportedVersions"><span class="hs-identifier hs-var">extensionID_SupportedVersions</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177056"><span class="hs-identifier hs-var">selectedVersion</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1022"></span><span>              </span><span id="local-6989586621679177054"><span class="annot"><span class="annottext">hrr :: Handshake13
</span><a href="#local-6989586621679177054"><span class="hs-identifier hs-var hs-var">hrr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerRandom
-&gt; Session -&gt; ExtensionID -&gt; [ExtensionRaw] -&gt; Handshake13
</span><a href="Network.TLS.Struct13.html#ServerHello13"><span class="hs-identifier hs-var">ServerHello13</span></a></span><span> </span><span class="annot"><span class="annottext">ServerRandom
</span><a href="Network.TLS.Handshake.Random.html#hrrRandom"><span class="hs-identifier hs-var">hrrRandom</span></a></span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679177070"><span class="hs-identifier hs-var">clientSession</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cipher -&gt; ExtensionID
</span><a href="Network.TLS.Cipher.html#cipherID"><span class="hs-identifier hs-var">cipherID</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177073"><span class="hs-identifier hs-var">usedCipher</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177055"><span class="hs-identifier hs-var">extensions</span></a></span><span>
</span><span id="line-1023"></span><span>          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177075"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HandshakeMode13 -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setTLS13HandshakeMode"><span class="hs-identifier hs-var">setTLS13HandshakeMode</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeMode13
</span><a href="Network.TLS.Handshake.State.html#HelloRetryRequest"><span class="hs-identifier hs-var">HelloRetryRequest</span></a></span><span>
</span><span id="line-1024"></span><span>          </span><span class="annot"><span class="annottext">forall a.
Context -&gt; (forall b. Monoid b =&gt; PacketFlightM b a) -&gt; IO a
</span><a href="Network.TLS.IO.html#runPacketFlight"><span class="hs-identifier hs-var">runPacketFlight</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177075"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1025"></span><span>                </span><span class="annot"><span class="annottext">forall b. Monoid b =&gt; Context -&gt; Packet13 -&gt; PacketFlightM b ()
</span><a href="Network.TLS.IO.html#loadPacket13"><span class="hs-identifier hs-var">loadPacket13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177075"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Handshake13] -&gt; Packet13
</span><a href="Network.TLS.Struct13.html#Handshake13"><span class="hs-identifier hs-var">Handshake13</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679177054"><span class="hs-identifier hs-var">hrr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1026"></span><span>                </span><span class="annot"><span class="annottext">forall b. Monoid b =&gt; Context -&gt; PacketFlightM b ()
</span><a href="Network.TLS.Handshake.Common13.html#sendChangeCipherSpec13"><span class="hs-identifier hs-var">sendChangeCipherSpec13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177075"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-1027"></span><span>          </span><span class="annot"><span class="annottext">ServerParams -&gt; Context -&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#handshakeServer"><span class="hs-identifier hs-var">handshakeServer</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177076"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177075"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-1028"></span><span>
</span><span id="line-1029"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#findHighestVersionFrom"><span class="hs-identifier hs-type">findHighestVersionFrom</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Types.html#Version"><span class="hs-identifier hs-type">Version</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Types.html#Version"><span class="hs-identifier hs-type">Version</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Network.TLS.Types.html#Version"><span class="hs-identifier hs-type">Version</span></a></span><span>
</span><span id="line-1030"></span><span id="findHighestVersionFrom"><span class="annot"><span class="annottext">findHighestVersionFrom :: Version -&gt; [Version] -&gt; Maybe Version
</span><a href="Network.TLS.Handshake.Server.html#findHighestVersionFrom"><span class="hs-identifier hs-var hs-var">findHighestVersionFrom</span></a></span></span><span> </span><span id="local-6989586621679177047"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177047"><span class="hs-identifier hs-var">clientVersion</span></a></span></span><span> </span><span id="local-6989586621679177046"><span class="annot"><span class="annottext">[Version]
</span><a href="#local-6989586621679177046"><span class="hs-identifier hs-var">allowedVersions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1031"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177047"><span class="hs-identifier hs-var">clientVersion</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortOn</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Down a
</span><span class="hs-identifier hs-var">Down</span></span><span> </span><span class="annot"><span class="annottext">[Version]
</span><a href="#local-6989586621679177046"><span class="hs-identifier hs-var">allowedVersions</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1032"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1033"></span><span>        </span><span id="local-6989586621679177044"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177044"><span class="hs-identifier hs-var">v</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[Version]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177044"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1034"></span><span>
</span><span id="line-1035"></span><span class="hs-comment">-- We filter our allowed ciphers here according to dynamic credential lists.</span><span>
</span><span id="line-1036"></span><span class="hs-comment">-- Credentials 'creds' come from server parameters but also SNI callback.</span><span>
</span><span id="line-1037"></span><span class="hs-comment">-- When the key exchange requires a signature, we use a</span><span>
</span><span id="line-1038"></span><span class="hs-comment">-- subset of this list named 'sigCreds'.  This list has been filtered in order</span><span>
</span><span id="line-1039"></span><span class="hs-comment">-- to remove certificates that are not compatible with hash/signature</span><span>
</span><span id="line-1040"></span><span class="hs-comment">-- restrictions (TLS 1.2).</span><span>
</span><span id="line-1041"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#getCiphers"><span class="hs-identifier hs-type">getCiphers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ServerParams"><span class="hs-identifier hs-type">ServerParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Credentials.html#Credentials"><span class="hs-identifier hs-type">Credentials</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Credentials.html#Credentials"><span class="hs-identifier hs-type">Credentials</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Cipher.html#Cipher"><span class="hs-identifier hs-type">Cipher</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1042"></span><span id="getCiphers"><span class="annot"><span class="annottext">getCiphers :: ServerParams -&gt; Credentials -&gt; Credentials -&gt; [Cipher]
</span><a href="Network.TLS.Handshake.Server.html#getCiphers"><span class="hs-identifier hs-var hs-var">getCiphers</span></a></span></span><span> </span><span id="local-6989586621679177043"><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177043"><span class="hs-identifier hs-var">sparams</span></a></span></span><span> </span><span id="local-6989586621679177042"><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679177042"><span class="hs-identifier hs-var">creds</span></a></span></span><span> </span><span id="local-6989586621679177041"><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679177041"><span class="hs-identifier hs-var">sigCreds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; Bool
</span><a href="#local-6989586621679177040"><span class="hs-identifier hs-var">authorizedCKE</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Supported -&gt; [Cipher]
</span><a href="Network.TLS.Parameters.html#supportedCiphers"><span class="hs-identifier hs-var">supportedCiphers</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerParams -&gt; Supported
</span><a href="Network.TLS.Parameters.html#serverSupported"><span class="hs-identifier hs-var">serverSupported</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177043"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1043"></span><span>      </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679177040"><span class="annot"><span class="annottext">authorizedCKE :: Cipher -&gt; Bool
</span><a href="#local-6989586621679177040"><span class="hs-identifier hs-var hs-var">authorizedCKE</span></a></span></span><span> </span><span id="local-6989586621679177039"><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177039"><span class="hs-identifier hs-var">cipher</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1044"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#cipherKeyExchange"><span class="hs-identifier hs-var">cipherKeyExchange</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679177039"><span class="hs-identifier hs-var">cipher</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1045"></span><span>                    </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_RSA</span></a></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177038"><span class="hs-identifier hs-var">canEncryptRSA</span></a></span><span>
</span><span id="line-1046"></span><span>                    </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DH_Anon"><span class="hs-identifier hs-var">CipherKeyExchange_DH_Anon</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1047"></span><span>                    </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DHE_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_DHE_RSA</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177037"><span class="hs-identifier hs-var">canSignRSA</span></a></span><span>
</span><span id="line-1048"></span><span>                    </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DHE_DSS"><span class="hs-identifier hs-var">CipherKeyExchange_DHE_DSS</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177036"><span class="hs-identifier hs-var">canSignDSS</span></a></span><span>
</span><span id="line-1049"></span><span>                    </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_ECDHE_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_ECDHE_RSA</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177037"><span class="hs-identifier hs-var">canSignRSA</span></a></span><span>
</span><span id="line-1050"></span><span>                    </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_ECDHE_ECDSA"><span class="hs-identifier hs-var">CipherKeyExchange_ECDHE_ECDSA</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679177035"><span class="hs-identifier hs-var">canSignECDSA</span></a></span><span>
</span><span id="line-1051"></span><span>                    </span><span class="hs-comment">-- unimplemented: non ephemeral DH &amp; ECDH.</span><span>
</span><span id="line-1052"></span><span>                    </span><span class="hs-comment">-- Note, these *should not* be implemented, and have</span><span>
</span><span id="line-1053"></span><span>                    </span><span class="hs-comment">-- (for example) been removed in OpenSSL 1.1.0</span><span>
</span><span id="line-1054"></span><span>                    </span><span class="hs-comment">--</span><span>
</span><span id="line-1055"></span><span>                    </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DH_DSS"><span class="hs-identifier hs-var">CipherKeyExchange_DH_DSS</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1056"></span><span>                    </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DH_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_DH_RSA</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1057"></span><span>                    </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_ECDH_ECDSA"><span class="hs-identifier hs-var">CipherKeyExchange_ECDH_ECDSA</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1058"></span><span>                    </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_ECDH_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_ECDH_RSA</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1059"></span><span>                    </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_TLS13"><span class="hs-identifier hs-var">CipherKeyExchange_TLS13</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- not reached</span><span>
</span><span id="line-1060"></span><span>
</span><span id="line-1061"></span><span>            </span><span id="local-6989586621679177036"><span class="annot"><span class="annottext">canSignDSS :: Bool
</span><a href="#local-6989586621679177036"><span class="hs-identifier hs-var hs-var">canSignDSS</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="Network.TLS.Crypto.Types.html#KX_DSS"><span class="hs-identifier hs-var">KX_DSS</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[KeyExchangeSignatureAlg]
</span><a href="#local-6989586621679177027"><span class="hs-identifier hs-var">signingAlgs</span></a></span><span>
</span><span id="line-1062"></span><span>            </span><span id="local-6989586621679177037"><span class="annot"><span class="annottext">canSignRSA :: Bool
</span><a href="#local-6989586621679177037"><span class="hs-identifier hs-var hs-var">canSignRSA</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="Network.TLS.Crypto.Types.html#KX_RSA"><span class="hs-identifier hs-var">KX_RSA</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[KeyExchangeSignatureAlg]
</span><a href="#local-6989586621679177027"><span class="hs-identifier hs-var">signingAlgs</span></a></span><span>
</span><span id="line-1063"></span><span>            </span><span id="local-6989586621679177035"><span class="annot"><span class="annottext">canSignECDSA :: Bool
</span><a href="#local-6989586621679177035"><span class="hs-identifier hs-var hs-var">canSignECDSA</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="Network.TLS.Crypto.Types.html#KX_ECDSA"><span class="hs-identifier hs-var">KX_ECDSA</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[KeyExchangeSignatureAlg]
</span><a href="#local-6989586621679177027"><span class="hs-identifier hs-var">signingAlgs</span></a></span><span>
</span><span id="line-1064"></span><span>            </span><span id="local-6989586621679177038"><span class="annot"><span class="annottext">canEncryptRSA :: Bool
</span><a href="#local-6989586621679177038"><span class="hs-identifier hs-var hs-var">canEncryptRSA</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Credentials -&gt; Maybe Credential
</span><a href="Network.TLS.Credentials.html#credentialsFindForDecrypting"><span class="hs-identifier hs-var">credentialsFindForDecrypting</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679177042"><span class="hs-identifier hs-var">creds</span></a></span><span>
</span><span id="line-1065"></span><span>            </span><span id="local-6989586621679177027"><span class="annot"><span class="annottext">signingAlgs :: [KeyExchangeSignatureAlg]
</span><a href="#local-6989586621679177027"><span class="hs-identifier hs-var hs-var">signingAlgs</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Credentials -&gt; [KeyExchangeSignatureAlg]
</span><a href="Network.TLS.Credentials.html#credentialsListSigningAlgorithms"><span class="hs-identifier hs-var">credentialsListSigningAlgorithms</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679177041"><span class="hs-identifier hs-var">sigCreds</span></a></span><span>
</span><span id="line-1066"></span><span>
</span><span id="line-1067"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#findHighestVersionFrom13"><span class="hs-identifier hs-type">findHighestVersionFrom13</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Types.html#Version"><span class="hs-identifier hs-type">Version</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Types.html#Version"><span class="hs-identifier hs-type">Version</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Network.TLS.Types.html#Version"><span class="hs-identifier hs-type">Version</span></a></span><span>
</span><span id="line-1068"></span><span id="findHighestVersionFrom13"><span class="annot"><span class="annottext">findHighestVersionFrom13 :: [Version] -&gt; [Version] -&gt; Maybe Version
</span><a href="Network.TLS.Handshake.Server.html#findHighestVersionFrom13"><span class="hs-identifier hs-var hs-var">findHighestVersionFrom13</span></a></span></span><span> </span><span id="local-6989586621679177021"><span class="annot"><span class="annottext">[Version]
</span><a href="#local-6989586621679177021"><span class="hs-identifier hs-var">clientVersions</span></a></span></span><span> </span><span id="local-6989586621679177020"><span class="annot"><span class="annottext">[Version]
</span><a href="#local-6989586621679177020"><span class="hs-identifier hs-var">serverVersions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Version]
</span><a href="#local-6989586621679177019"><span class="hs-identifier hs-var">svs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">`intersect`</span></span><span> </span><span class="annot"><span class="annottext">[Version]
</span><a href="#local-6989586621679177018"><span class="hs-identifier hs-var">cvs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1069"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1070"></span><span>        </span><span id="local-6989586621679177017"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177017"><span class="hs-identifier hs-var">v</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[Version]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679177017"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1071"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1072"></span><span>    </span><span id="local-6989586621679177019"><span class="annot"><span class="annottext">svs :: [Version]
</span><a href="#local-6989586621679177019"><span class="hs-identifier hs-var hs-var">svs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortOn</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Down a
</span><span class="hs-identifier hs-var">Down</span></span><span> </span><span class="annot"><span class="annottext">[Version]
</span><a href="#local-6989586621679177020"><span class="hs-identifier hs-var">serverVersions</span></a></span><span>
</span><span id="line-1073"></span><span>    </span><span id="local-6989586621679177018"><span class="annot"><span class="annottext">cvs :: [Version]
</span><a href="#local-6989586621679177018"><span class="hs-identifier hs-var hs-var">cvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortOn</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Down a
</span><span class="hs-identifier hs-var">Down</span></span><span> </span><span class="annot"><span class="annottext">[Version]
</span><a href="#local-6989586621679177021"><span class="hs-identifier hs-var">clientVersions</span></a></span><span>
</span><span id="line-1074"></span><span>
</span><span id="line-1075"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#applicationProtocol"><span class="hs-identifier hs-type">applicationProtocol</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-type">ExtensionRaw</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ServerParams"><span class="hs-identifier hs-type">ServerParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-type">ExtensionRaw</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1076"></span><span id="applicationProtocol"><span class="annot"><span class="annottext">applicationProtocol :: Context -&gt; [ExtensionRaw] -&gt; ServerParams -&gt; IO [ExtensionRaw]
</span><a href="Network.TLS.Handshake.Server.html#applicationProtocol"><span class="hs-identifier hs-var hs-var">applicationProtocol</span></a></span></span><span> </span><span id="local-6989586621679177012"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177012"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679177011"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177011"><span class="hs-identifier hs-var">exts</span></a></span></span><span> </span><span id="local-6989586621679177010"><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177010"><span class="hs-identifier hs-var">sparams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1077"></span><span>    </span><span class="hs-comment">-- ALPN (Application Layer Protocol Negotiation)</span><span>
</span><span id="line-1078"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; [ExtensionRaw] -&gt; Maybe ByteString
</span><a href="Network.TLS.Handshake.Common.html#extensionLookup"><span class="hs-identifier hs-var">extensionLookup</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_ApplicationLayerProtocolNegotiation"><span class="hs-identifier hs-var">extensionID_ApplicationLayerProtocolNegotiation</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679177011"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTClientHello"><span class="hs-identifier hs-var">MsgTClientHello</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1079"></span><span>        </span><span class="annot"><span class="annottext">Maybe ApplicationLayerProtocolNegotiation
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1080"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#ApplicationLayerProtocolNegotiation"><span class="hs-identifier hs-type">ApplicationLayerProtocolNegotiation</span></a></span><span> </span><span id="local-6989586621679177007"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679177007"><span class="hs-identifier hs-var">protos</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1081"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ServerHooks -&gt; Maybe ([ByteString] -&gt; IO ByteString)
</span><a href="Network.TLS.Parameters.html#onALPNClientSuggest"><span class="hs-identifier hs-var">onALPNClientSuggest</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerParams -&gt; ServerHooks
</span><a href="Network.TLS.Parameters.html#serverHooks"><span class="hs-identifier hs-var">serverHooks</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679177010"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1082"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679177005"><span class="annot"><span class="annottext">[ByteString] -&gt; IO ByteString
</span><a href="#local-6989586621679177005"><span class="hs-identifier hs-var">io</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1083"></span><span>                    </span><span id="local-6989586621679177004"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177004"><span class="hs-identifier hs-var">proto</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; IO ByteString
</span><a href="#local-6989586621679177005"><span class="hs-identifier hs-var">io</span></a></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679177007"><span class="hs-identifier hs-var">protos</span></a></span><span>
</span><span id="line-1084"></span><span>                    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177004"><span class="hs-identifier hs-var">proto</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1085"></span><span>                        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;no supported application protocols&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#NoApplicationProtocol"><span class="hs-identifier hs-var">NoApplicationProtocol</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1086"></span><span>                    </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679177012"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1087"></span><span>                        </span><span class="annot"><span class="annottext">Bool -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setExtensionALPN"><span class="hs-identifier hs-var">setExtensionALPN</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1088"></span><span>                        </span><span class="annot"><span class="annottext">ByteString -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setNegotiatedProtocol"><span class="hs-identifier hs-var">setNegotiatedProtocol</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177004"><span class="hs-identifier hs-var">proto</span></a></span><span>
</span><span id="line-1089"></span><span>                    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; ByteString -&gt; ExtensionRaw
</span><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-var">ExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_ApplicationLayerProtocolNegotiation"><span class="hs-identifier hs-var">extensionID_ApplicationLayerProtocolNegotiation</span></a></span><span>
</span><span id="line-1090"></span><span>                                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Extension a =&gt; a -&gt; ByteString
</span><a href="Network.TLS.Extension.html#extensionEncode"><span class="hs-identifier hs-var">extensionEncode</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; ApplicationLayerProtocolNegotiation
</span><a href="Network.TLS.Extension.html#ApplicationLayerProtocolNegotiation"><span class="hs-identifier hs-var">ApplicationLayerProtocolNegotiation</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679177004"><span class="hs-identifier hs-var">proto</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1091"></span><span>                </span><span class="annot"><span class="annottext">Maybe ([ByteString] -&gt; IO ByteString)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1092"></span><span>
</span><span id="line-1093"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#credentialsFindForSigning13"><span class="hs-identifier hs-type">credentialsFindForSigning13</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#HashAndSignatureAlgorithm"><span class="hs-identifier hs-type">HashAndSignatureAlgorithm</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Credentials.html#Credentials"><span class="hs-identifier hs-type">Credentials</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Credentials.html#Credential"><span class="hs-identifier hs-type">Credential</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#HashAndSignatureAlgorithm"><span class="hs-identifier hs-type">HashAndSignatureAlgorithm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1094"></span><span id="credentialsFindForSigning13"><span class="annot"><span class="annottext">credentialsFindForSigning13 :: [HashAndSignatureAlgorithm]
-&gt; Credentials -&gt; Maybe (Credential, HashAndSignatureAlgorithm)
</span><a href="Network.TLS.Handshake.Server.html#credentialsFindForSigning13"><span class="hs-identifier hs-var hs-var">credentialsFindForSigning13</span></a></span></span><span> </span><span id="local-6989586621679177000"><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177000"><span class="hs-identifier hs-var">hss0</span></a></span></span><span> </span><span id="local-6989586621679176999"><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679176999"><span class="hs-identifier hs-var">creds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
-&gt; Maybe (Credential, HashAndSignatureAlgorithm)
</span><a href="#local-6989586621679176998"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679177000"><span class="hs-identifier hs-var">hss0</span></a></span><span>
</span><span id="line-1095"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1096"></span><span>    </span><span id="local-6989586621679176998"><span class="annot"><span class="annottext">loop :: [HashAndSignatureAlgorithm]
-&gt; Maybe (Credential, HashAndSignatureAlgorithm)
</span><a href="#local-6989586621679176998"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span>  </span><span class="hs-special">[</span><span class="hs-special">]</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1097"></span><span>    </span><span class="annot"><a href="#local-6989586621679176998"><span class="hs-identifier hs-var">loop</span></a></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679176997"><span class="annot"><span class="annottext">HashAndSignatureAlgorithm
</span><a href="#local-6989586621679176997"><span class="hs-identifier hs-var">hs</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679176996"><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679176996"><span class="hs-identifier hs-var">hss</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HashAndSignatureAlgorithm -&gt; Credentials -&gt; Maybe Credential
</span><a href="Network.TLS.Handshake.Server.html#credentialsFindForSigning13%27"><span class="hs-identifier hs-var">credentialsFindForSigning13'</span></a></span><span> </span><span class="annot"><span class="annottext">HashAndSignatureAlgorithm
</span><a href="#local-6989586621679176997"><span class="hs-identifier hs-var">hs</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679176999"><span class="hs-identifier hs-var">creds</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1098"></span><span>        </span><span class="annot"><span class="annottext">Maybe Credential
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
-&gt; Credentials -&gt; Maybe (Credential, HashAndSignatureAlgorithm)
</span><a href="Network.TLS.Handshake.Server.html#credentialsFindForSigning13"><span class="hs-identifier hs-var">credentialsFindForSigning13</span></a></span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679176996"><span class="hs-identifier hs-var">hss</span></a></span><span> </span><span class="annot"><span class="annottext">Credentials
</span><a href="#local-6989586621679176999"><span class="hs-identifier hs-var">creds</span></a></span><span>
</span><span id="line-1099"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679176994"><span class="annot"><span class="annottext">Credential
</span><a href="#local-6989586621679176994"><span class="hs-identifier hs-var">cred</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Credential
</span><a href="#local-6989586621679176994"><span class="hs-identifier hs-var">cred</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashAndSignatureAlgorithm
</span><a href="#local-6989586621679176997"><span class="hs-identifier hs-var">hs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1100"></span><span>
</span><span id="line-1101"></span><span class="hs-comment">-- See credentialsFindForSigning.</span><span>
</span><span id="line-1102"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#credentialsFindForSigning13%27"><span class="hs-identifier hs-type">credentialsFindForSigning13'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#HashAndSignatureAlgorithm"><span class="hs-identifier hs-type">HashAndSignatureAlgorithm</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Credentials.html#Credentials"><span class="hs-identifier hs-type">Credentials</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Network.TLS.Credentials.html#Credential"><span class="hs-identifier hs-type">Credential</span></a></span><span>
</span><span id="line-1103"></span><span id="credentialsFindForSigning13%27"><span class="annot"><span class="annottext">credentialsFindForSigning13' :: HashAndSignatureAlgorithm -&gt; Credentials -&gt; Maybe Credential
</span><a href="Network.TLS.Handshake.Server.html#credentialsFindForSigning13%27"><span class="hs-identifier hs-var hs-var">credentialsFindForSigning13'</span></a></span></span><span> </span><span id="local-6989586621679176993"><span class="annot"><span class="annottext">HashAndSignatureAlgorithm
</span><a href="#local-6989586621679176993"><span class="hs-identifier hs-var">sigAlg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Credentials.html#Credentials"><span class="hs-identifier hs-type">Credentials</span></a></span><span> </span><span id="local-6989586621679176992"><span class="annot"><span class="annottext">[Credential]
</span><a href="#local-6989586621679176992"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="annot"><span class="annottext">Credential -&gt; Bool
</span><a href="#local-6989586621679176991"><span class="hs-identifier hs-var">forSigning</span></a></span><span> </span><span class="annot"><span class="annottext">[Credential]
</span><a href="#local-6989586621679176992"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-1104"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1105"></span><span>    </span><span id="local-6989586621679176991"><span class="annot"><span class="annottext">forSigning :: Credential -&gt; Bool
</span><a href="#local-6989586621679176991"><span class="hs-identifier hs-var hs-var">forSigning</span></a></span></span><span> </span><span id="local-6989586621679176990"><span class="annot"><span class="annottext">Credential
</span><a href="#local-6989586621679176990"><span class="hs-identifier hs-var">cred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Credential -&gt; Maybe PubKey
</span><a href="Network.TLS.Handshake.Server.html#credentialDigitalSignatureKey"><span class="hs-identifier hs-var">credentialDigitalSignatureKey</span></a></span><span> </span><span class="annot"><span class="annottext">Credential
</span><a href="#local-6989586621679176990"><span class="hs-identifier hs-var">cred</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1106"></span><span>        </span><span class="annot"><span class="annottext">Maybe PubKey
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1107"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679176989"><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679176989"><span class="hs-identifier hs-var">pub</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679176989"><span class="hs-identifier hs-var">pub</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey -&gt; HashAndSignatureAlgorithm -&gt; Bool
</span><a href="Network.TLS.Handshake.Signature.html#signatureCompatible13"><span class="hs-operator hs-var">`signatureCompatible13`</span></a></span><span> </span><span class="annot"><span class="annottext">HashAndSignatureAlgorithm
</span><a href="#local-6989586621679176993"><span class="hs-identifier hs-var">sigAlg</span></a></span><span>
</span><span id="line-1108"></span><span>
</span><span id="line-1109"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#clientCertificate"><span class="hs-identifier hs-type">clientCertificate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ServerParams"><span class="hs-identifier hs-type">ServerParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CertificateChain</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1110"></span><span id="clientCertificate"><span class="annot"><span class="annottext">clientCertificate :: ServerParams -&gt; Context -&gt; CertificateChain -&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#clientCertificate"><span class="hs-identifier hs-var hs-var">clientCertificate</span></a></span></span><span> </span><span id="local-6989586621679176987"><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679176987"><span class="hs-identifier hs-var">sparams</span></a></span></span><span> </span><span id="local-6989586621679176986"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176986"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679176985"><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679176985"><span class="hs-identifier hs-var">certs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1111"></span><span>    </span><span class="hs-comment">-- run certificate recv hook</span><span>
</span><span id="line-1112"></span><span>    </span><span class="annot"><span class="annottext">forall a. Context -&gt; (Hooks -&gt; IO a) -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#ctxWithHooks"><span class="hs-identifier hs-var">ctxWithHooks</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176986"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hooks -&gt; CertificateChain -&gt; IO ()
</span><a href="Network.TLS.Hooks.html#hookRecvCertificates"><span class="hs-operator hs-var">`hookRecvCertificates`</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679176985"><span class="hs-identifier hs-var">certs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1113"></span><span>    </span><span class="hs-comment">-- Call application callback to see whether the</span><span>
</span><span id="line-1114"></span><span>    </span><span class="hs-comment">-- certificate chain is acceptable.</span><span>
</span><span id="line-1115"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1116"></span><span>    </span><span id="local-6989586621679176982"><span class="annot"><span class="annottext">CertificateUsage
</span><a href="#local-6989586621679176982"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. IO a -&gt; (SomeException -&gt; IO a) -&gt; IO a
</span><a href="Network.TLS.Util.html#catchException"><span class="hs-identifier hs-var">catchException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerHooks -&gt; CertificateChain -&gt; IO CertificateUsage
</span><a href="Network.TLS.Parameters.html#onClientCertificate"><span class="hs-identifier hs-var">onClientCertificate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerParams -&gt; ServerHooks
</span><a href="Network.TLS.Parameters.html#serverHooks"><span class="hs-identifier hs-var">serverHooks</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679176987"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679176985"><span class="hs-identifier hs-var">certs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; IO CertificateUsage
</span><a href="Network.TLS.Handshake.Certificate.html#rejectOnException"><span class="hs-identifier hs-var">rejectOnException</span></a></span><span>
</span><span id="line-1117"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CertificateUsage
</span><a href="#local-6989586621679176982"><span class="hs-identifier hs-var">usage</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1118"></span><span>        </span><span class="annot"><span class="annottext">CertificateUsage
</span><a href="Network.TLS.X509.html#CertificateUsageAccept"><span class="hs-identifier hs-var">CertificateUsageAccept</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
[ExtKeyUsageFlag] -&gt; CertificateChain -&gt; m ()
</span><a href="Network.TLS.Handshake.Certificate.html#verifyLeafKeyUsage"><span class="hs-identifier hs-var">verifyLeafKeyUsage</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ExtKeyUsageFlag
</span><span class="hs-identifier hs-var">KeyUsage_digitalSignature</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679176985"><span class="hs-identifier hs-var">certs</span></a></span><span>
</span><span id="line-1119"></span><span>        </span><span class="annot"><a href="Network.TLS.X509.html#CertificateUsageReject"><span class="hs-identifier hs-type">CertificateUsageReject</span></a></span><span> </span><span id="local-6989586621679176975"><span class="annot"><span class="annottext">CertificateRejectReason
</span><a href="#local-6989586621679176975"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; CertificateRejectReason -&gt; m a
</span><a href="Network.TLS.Handshake.Certificate.html#certificateRejected"><span class="hs-identifier hs-var">certificateRejected</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateRejectReason
</span><a href="#local-6989586621679176975"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-1120"></span><span>
</span><span id="line-1121"></span><span>    </span><span class="hs-comment">-- Remember cert chain for later use.</span><span>
</span><span id="line-1122"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1123"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176986"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CertificateChain -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setClientCertChain"><span class="hs-identifier hs-var">setClientCertChain</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679176985"><span class="hs-identifier hs-var">certs</span></a></span><span>
</span><span id="line-1124"></span><span>
</span><span id="line-1125"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#clientCertVerify"><span class="hs-identifier hs-type">clientCertVerify</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ServerParams"><span class="hs-identifier hs-type">ServerParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CertificateChain</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1126"></span><span id="clientCertVerify"><span class="annot"><span class="annottext">clientCertVerify :: ServerParams -&gt; Context -&gt; CertificateChain -&gt; Bool -&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#clientCertVerify"><span class="hs-identifier hs-var hs-var">clientCertVerify</span></a></span></span><span> </span><span id="local-6989586621679176972"><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679176972"><span class="hs-identifier hs-var">sparams</span></a></span></span><span> </span><span id="local-6989586621679176971"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176971"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679176970"><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679176970"><span class="hs-identifier hs-var">certs</span></a></span></span><span> </span><span id="local-6989586621679176969"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679176969"><span class="hs-identifier hs-var">verif</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1127"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679176969"><span class="hs-identifier hs-var">verif</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1128"></span><span>        </span><span class="hs-comment">-- When verification succeeds, commit the</span><span>
</span><span id="line-1129"></span><span>        </span><span class="hs-comment">-- client certificate chain to the context.</span><span>
</span><span id="line-1130"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-1131"></span><span>        </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176971"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CertificateChain -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setClientCertificateChain"><span class="hs-identifier hs-var">setClientCertificateChain</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679176970"><span class="hs-identifier hs-var">certs</span></a></span><span>
</span><span id="line-1132"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1133"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1134"></span><span>        </span><span class="hs-comment">-- Either verification failed because of an</span><span>
</span><span id="line-1135"></span><span>        </span><span class="hs-comment">-- invalid format (with an error message), or</span><span>
</span><span id="line-1136"></span><span>        </span><span class="hs-comment">-- the signature is wrong.  In either case,</span><span>
</span><span id="line-1137"></span><span>        </span><span class="hs-comment">-- ask the application if it wants to</span><span>
</span><span id="line-1138"></span><span>        </span><span class="hs-comment">-- proceed, we will do that.</span><span>
</span><span id="line-1139"></span><span>        </span><span id="local-6989586621679176967"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679176967"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerHooks -&gt; IO Bool
</span><a href="Network.TLS.Parameters.html#onUnverifiedClientCert"><span class="hs-identifier hs-var">onUnverifiedClientCert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerParams -&gt; ServerHooks
</span><a href="Network.TLS.Parameters.html#serverHooks"><span class="hs-identifier hs-var">serverHooks</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679176972"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1140"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679176967"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1141"></span><span>                </span><span class="hs-comment">-- When verification fails, but the</span><span>
</span><span id="line-1142"></span><span>                </span><span class="hs-comment">-- application callbacks accepts, we</span><span>
</span><span id="line-1143"></span><span>                </span><span class="hs-comment">-- also commit the client certificate</span><span>
</span><span id="line-1144"></span><span>                </span><span class="hs-comment">-- chain to the context.</span><span>
</span><span id="line-1145"></span><span>                </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176971"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CertificateChain -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setClientCertificateChain"><span class="hs-identifier hs-var">setClientCertificateChain</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679176970"><span class="hs-identifier hs-var">certs</span></a></span><span>
</span><span id="line-1146"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; m a
</span><a href="Network.TLS.Handshake.Signature.html#decryptError"><span class="hs-identifier hs-var">decryptError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;verification failed&quot;</span></span><span>
</span><span id="line-1147"></span><span>
</span><span id="line-1148"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#newCertReqContext"><span class="hs-identifier hs-type">newCertReqContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Network.TLS.Types.html#CertReqContext"><span class="hs-identifier hs-type">CertReqContext</span></a></span><span>
</span><span id="line-1149"></span><span id="newCertReqContext"><span class="annot"><span class="annottext">newCertReqContext :: Context -&gt; IO ByteString
</span><a href="Network.TLS.Handshake.Server.html#newCertReqContext"><span class="hs-identifier hs-var hs-var">newCertReqContext</span></a></span></span><span> </span><span id="local-6989586621679176963"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176963"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Int -&gt; IO ByteString
</span><a href="Network.TLS.Context.Internal.html#getStateRNG"><span class="hs-identifier hs-var">getStateRNG</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176963"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span>
</span><span id="line-1150"></span><span>
</span><span id="line-1151"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#requestCertificateServer"><span class="hs-identifier hs-type">requestCertificateServer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ServerParams"><span class="hs-identifier hs-type">ServerParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1152"></span><span id="requestCertificateServer"><span class="annot"><span class="annottext">requestCertificateServer :: ServerParams -&gt; Context -&gt; IO Bool
</span><a href="Network.TLS.Handshake.Server.html#requestCertificateServer"><span class="hs-identifier hs-var hs-var">requestCertificateServer</span></a></span></span><span> </span><span id="local-6989586621679176962"><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679176962"><span class="hs-identifier hs-var">sparams</span></a></span></span><span> </span><span id="local-6989586621679176961"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176961"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1153"></span><span>    </span><span id="local-6989586621679176960"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679176960"><span class="hs-identifier hs-var">tls13</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m Bool
</span><a href="Network.TLS.Context.Internal.html#tls13orLater"><span class="hs-identifier hs-var">tls13orLater</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176961"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-1154"></span><span>    </span><span id="local-6989586621679176958"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679176958"><span class="hs-identifier hs-var">supportsPHA</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176961"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Bool
</span><a href="Network.TLS.State.html#getClientSupportsPHA"><span class="hs-identifier hs-var">getClientSupportsPHA</span></a></span><span>
</span><span id="line-1155"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679176956"><span class="annot"><span class="annottext">ok :: Bool
</span><a href="#local-6989586621679176956"><span class="hs-identifier hs-var hs-var">ok</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679176960"><span class="hs-identifier hs-var">tls13</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679176958"><span class="hs-identifier hs-var">supportsPHA</span></a></span><span>
</span><span id="line-1156"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679176956"><span class="hs-identifier hs-var">ok</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1157"></span><span>        </span><span id="local-6989586621679176955"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679176955"><span class="hs-identifier hs-var">certReqCtx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO ByteString
</span><a href="Network.TLS.Handshake.Server.html#newCertReqContext"><span class="hs-identifier hs-var">newCertReqContext</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176961"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-1158"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679176954"><span class="annot"><span class="annottext">certReq :: Handshake13
</span><a href="#local-6989586621679176954"><span class="hs-identifier hs-var hs-var">certReq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerParams -&gt; Context -&gt; ByteString -&gt; Handshake13
</span><a href="Network.TLS.Handshake.Common13.html#makeCertRequest"><span class="hs-identifier hs-var">makeCertRequest</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679176962"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176961"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679176955"><span class="hs-identifier hs-var">certReqCtx</span></a></span><span>
</span><span id="line-1159"></span><span>        </span><span class="annot"><span class="annottext">forall a b c. IO a -&gt; (a -&gt; IO b) -&gt; (a -&gt; IO c) -&gt; IO c
</span><span class="hs-identifier hs-var">bracket</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; IO (Saved (Maybe HandshakeState))
</span><a href="Network.TLS.Context.Internal.html#saveHState"><span class="hs-identifier hs-var">saveHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176961"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context
-&gt; Saved (Maybe HandshakeState)
-&gt; IO (Saved (Maybe HandshakeState))
</span><a href="Network.TLS.Context.Internal.html#restoreHState"><span class="hs-identifier hs-var">restoreHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176961"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Saved (Maybe HandshakeState)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1160"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; Handshake13 -&gt; IO ()
</span><a href="Network.TLS.Context.Internal.html#addCertRequest13"><span class="hs-identifier hs-var">addCertRequest13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176961"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679176954"><span class="hs-identifier hs-var">certReq</span></a></span><span>
</span><span id="line-1161"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; Packet13 -&gt; IO ()
</span><a href="Network.TLS.IO.html#sendPacket13"><span class="hs-identifier hs-var">sendPacket13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176961"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Handshake13] -&gt; Packet13
</span><a href="Network.TLS.Struct13.html#Handshake13"><span class="hs-identifier hs-var">Handshake13</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679176954"><span class="hs-identifier hs-var">certReq</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1162"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679176956"><span class="hs-identifier hs-var">ok</span></a></span><span>
</span><span id="line-1163"></span><span>
</span><span id="line-1164"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#postHandshakeAuthServerWith"><span class="hs-identifier hs-type">postHandshakeAuthServerWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ServerParams"><span class="hs-identifier hs-type">ServerParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct13.html#Handshake13"><span class="hs-identifier hs-type">Handshake13</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1165"></span><span id="postHandshakeAuthServerWith"><span class="annot"><span class="annottext">postHandshakeAuthServerWith :: ServerParams -&gt; Context -&gt; Handshake13 -&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#postHandshakeAuthServerWith"><span class="hs-identifier hs-var hs-var">postHandshakeAuthServerWith</span></a></span></span><span> </span><span id="local-6989586621679176950"><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679176950"><span class="hs-identifier hs-var">sparams</span></a></span></span><span> </span><span id="local-6989586621679176949"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176949"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679176948"><span class="annot"><span class="annottext">h :: Handshake13
</span><a href="#local-6989586621679176948"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct13.html#Certificate13"><span class="hs-identifier hs-type">Certificate13</span></a></span><span> </span><span id="local-6989586621679176947"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679176947"><span class="hs-identifier hs-var">certCtx</span></a></span></span><span> </span><span id="local-6989586621679176946"><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679176946"><span class="hs-identifier hs-var">certs</span></a></span></span><span> </span><span id="local-6989586621679176945"><span class="annot"><span class="annottext">[[ExtensionRaw]]
</span><a href="#local-6989586621679176945"><span class="hs-identifier hs-var">_ext</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1166"></span><span>    </span><span id="local-6989586621679176944"><span class="annot"><span class="annottext">Maybe Handshake13
</span><a href="#local-6989586621679176944"><span class="hs-identifier hs-var">mCertReq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; ByteString -&gt; IO (Maybe Handshake13)
</span><a href="Network.TLS.Context.Internal.html#getCertRequest13"><span class="hs-identifier hs-var">getCertRequest13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176949"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679176947"><span class="hs-identifier hs-var">certCtx</span></a></span><span>
</span><span id="line-1167"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isNothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe Handshake13
</span><a href="#local-6989586621679176944"><span class="hs-identifier hs-var">mCertReq</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unknown certificate request context&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#DecodeError"><span class="hs-identifier hs-var">DecodeError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1168"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679176940"><span class="annot"><span class="annottext">certReq :: Handshake13
</span><a href="#local-6989586621679176940"><span class="hs-identifier hs-var hs-var">certReq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. String -&gt; Maybe a -&gt; a
</span><a href="Network.TLS.Util.html#fromJust"><span class="hs-identifier hs-var">fromJust</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;certReq&quot;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Handshake13
</span><a href="#local-6989586621679176944"><span class="hs-identifier hs-var">mCertReq</span></a></span><span>
</span><span id="line-1169"></span><span>
</span><span id="line-1170"></span><span>    </span><span class="hs-comment">-- fixme checking _ext</span><span>
</span><span id="line-1171"></span><span>    </span><span class="annot"><span class="annottext">ServerParams -&gt; Context -&gt; CertificateChain -&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#clientCertificate"><span class="hs-identifier hs-var">clientCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679176950"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176949"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679176946"><span class="hs-identifier hs-var">certs</span></a></span><span>
</span><span id="line-1172"></span><span>
</span><span id="line-1173"></span><span>    </span><span id="local-6989586621679176939"><span class="annot"><span class="annottext">Saved (Maybe HandshakeState)
</span><a href="#local-6989586621679176939"><span class="hs-identifier hs-var">baseHState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO (Saved (Maybe HandshakeState))
</span><a href="Network.TLS.Context.Internal.html#saveHState"><span class="hs-identifier hs-var">saveHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176949"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-1174"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; Handshake13 -&gt; IO ()
</span><a href="Network.TLS.Handshake.Process.html#processHandshake13"><span class="hs-identifier hs-var">processHandshake13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176949"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679176940"><span class="hs-identifier hs-var">certReq</span></a></span><span>
</span><span id="line-1175"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; Handshake13 -&gt; IO ()
</span><a href="Network.TLS.Handshake.Process.html#processHandshake13"><span class="hs-identifier hs-var">processHandshake13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176949"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679176948"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-1176"></span><span>
</span><span id="line-1177"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679176937"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679176937"><span class="hs-identifier hs-var">usedHash</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Cipher
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679176936"><span class="annot"><span class="annottext">CryptLevel
</span><a href="#local-6989586621679176936"><span class="hs-identifier hs-var">level</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679176935"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679176935"><span class="hs-identifier hs-var">applicationSecretN</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO (Hash, Cipher, CryptLevel, ByteString)
</span><a href="Network.TLS.Handshake.State13.html#getRxState"><span class="hs-identifier hs-var">getRxState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176949"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-1178"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CryptLevel
</span><a href="#local-6989586621679176936"><span class="hs-identifier hs-var">level</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">CryptLevel
</span><a href="Network.TLS.Record.State.html#CryptApplicationSecret"><span class="hs-identifier hs-var">CryptApplicationSecret</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1179"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tried post-handshake authentication without application traffic secret&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#InternalError"><span class="hs-identifier hs-var">InternalError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1180"></span><span>
</span><span id="line-1181"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679176924"><span class="annot"><span class="annottext">expectFinished :: ByteString -&gt; Handshake13 -&gt; IO ()
</span><a href="#local-6989586621679176924"><span class="hs-identifier hs-var hs-var">expectFinished</span></a></span></span><span> </span><span id="local-6989586621679176923"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679176923"><span class="hs-identifier hs-var">hChBeforeCf</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct13.html#Finished13"><span class="hs-identifier hs-type">Finished13</span></a></span><span> </span><span id="local-6989586621679176922"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679176922"><span class="hs-identifier hs-var">verifyData</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1182"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
Context -&gt; Hash -&gt; ByteString -&gt; ByteString -&gt; ByteString -&gt; m ()
</span><a href="Network.TLS.Handshake.Common13.html#checkFinished"><span class="hs-identifier hs-var">checkFinished</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176949"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679176937"><span class="hs-identifier hs-var">usedHash</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679176935"><span class="hs-identifier hs-var">applicationSecretN</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679176923"><span class="hs-identifier hs-var">hChBeforeCf</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679176922"><span class="hs-identifier hs-var">verifyData</span></a></span><span>
</span><span id="line-1183"></span><span>            </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context
-&gt; Saved (Maybe HandshakeState)
-&gt; IO (Saved (Maybe HandshakeState))
</span><a href="Network.TLS.Context.Internal.html#restoreHState"><span class="hs-identifier hs-var">restoreHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176949"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Saved (Maybe HandshakeState)
</span><a href="#local-6989586621679176939"><span class="hs-identifier hs-var">baseHState</span></a></span><span>
</span><span id="line-1184"></span><span>        </span><span class="annot"><a href="#local-6989586621679176924"><span class="hs-identifier hs-var">expectFinished</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679176921"><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679176921"><span class="hs-identifier hs-var">hs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; Maybe String -&gt; m a
</span><a href="Network.TLS.Handshake.Common.html#unexpected"><span class="hs-identifier hs-var">unexpected</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679176921"><span class="hs-identifier hs-var">hs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;finished 13&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-1185"></span><span>
</span><span id="line-1186"></span><span>    </span><span class="hs-comment">-- Note: here the server could send updated NST too, however the library</span><span>
</span><span id="line-1187"></span><span>    </span><span class="hs-comment">-- currently has no API to handle resumption and client authentication</span><span>
</span><span id="line-1188"></span><span>    </span><span class="hs-comment">-- together, see discussion in #133</span><span>
</span><span id="line-1189"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">CertificateChain -&gt; Bool
</span><a href="Network.TLS.X509.html#isNullCertificateChain"><span class="hs-identifier hs-var">isNullCertificateChain</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679176946"><span class="hs-identifier hs-var">certs</span></a></span><span>
</span><span id="line-1190"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Context -&gt; [PendingAction] -&gt; IO ()
</span><a href="Network.TLS.Handshake.State13.html#setPendingActions"><span class="hs-identifier hs-var">setPendingActions</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176949"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; (ByteString -&gt; Handshake13 -&gt; IO ()) -&gt; PendingAction
</span><a href="Network.TLS.Context.Internal.html#PendingActionHash"><span class="hs-identifier hs-var">PendingActionHash</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Handshake13 -&gt; IO ()
</span><a href="#local-6989586621679176924"><span class="hs-identifier hs-var">expectFinished</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1191"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Context -&gt; [PendingAction] -&gt; IO ()
</span><a href="Network.TLS.Handshake.State13.html#setPendingActions"><span class="hs-identifier hs-var">setPendingActions</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176949"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; (ByteString -&gt; Handshake13 -&gt; IO ()) -&gt; PendingAction
</span><a href="Network.TLS.Context.Internal.html#PendingActionHash"><span class="hs-identifier hs-var">PendingActionHash</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
MonadIO m =&gt;
ServerParams -&gt; Context -&gt; ByteString -&gt; Handshake13 -&gt; m ()
</span><a href="Network.TLS.Handshake.Server.html#expectCertVerify"><span class="hs-identifier hs-var">expectCertVerify</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><a href="#local-6989586621679176950"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176949"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1192"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; (ByteString -&gt; Handshake13 -&gt; IO ()) -&gt; PendingAction
</span><a href="Network.TLS.Context.Internal.html#PendingActionHash"><span class="hs-identifier hs-var">PendingActionHash</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Handshake13 -&gt; IO ()
</span><a href="#local-6989586621679176924"><span class="hs-identifier hs-var">expectFinished</span></a></span><span>
</span><span id="line-1193"></span><span>                                   </span><span class="hs-special">]</span><span>
</span><span id="line-1194"></span><span>
</span><span id="line-1195"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#postHandshakeAuthServerWith"><span class="hs-identifier hs-var">postHandshakeAuthServerWith</span></a></span><span> </span><span class="annot"><span class="annottext">ServerParams
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1196"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unexpected handshake message received in postHandshakeAuthServerWith&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#UnexpectedMessage"><span class="hs-identifier hs-var">UnexpectedMessage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1197"></span><span>
</span><span id="line-1198"></span><span class="annot"><a href="Network.TLS.Handshake.Server.html#contextSync"><span class="hs-identifier hs-type">contextSync</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Control.html#ServerState"><span class="hs-identifier hs-type">ServerState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1199"></span><span id="contextSync"><span class="annot"><span class="annottext">contextSync :: Context -&gt; ServerState -&gt; IO ()
</span><a href="Network.TLS.Handshake.Server.html#contextSync"><span class="hs-identifier hs-var hs-var">contextSync</span></a></span></span><span> </span><span id="local-6989586621679176920"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176920"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679176919"><span class="annot"><span class="annottext">ServerState
</span><a href="#local-6989586621679176919"><span class="hs-identifier hs-var">ctl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Context -&gt; HandshakeSync
</span><a href="Network.TLS.Context.Internal.html#ctxHandshakeSync"><span class="hs-identifier hs-var">ctxHandshakeSync</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176920"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1200"></span><span>    </span><span class="annot"><a href="Network.TLS.Context.Internal.html#HandshakeSync"><span class="hs-identifier hs-type">HandshakeSync</span></a></span><span> </span><span class="annot"><span class="annottext">Context -&gt; ClientState -&gt; IO ()
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679176916"><span class="annot"><span class="annottext">Context -&gt; ServerState -&gt; IO ()
</span><a href="#local-6989586621679176916"><span class="hs-identifier hs-var">sync</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Context -&gt; ServerState -&gt; IO ()
</span><a href="#local-6989586621679176916"><span class="hs-identifier hs-var">sync</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679176920"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState
</span><a href="#local-6989586621679176919"><span class="hs-identifier hs-var">ctl</span></a></span><span>
</span><span id="line-1201"></span></pre></body></html>